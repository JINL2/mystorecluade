# ============================================
# DCM (Dart Code Metrics) ëª…ë ¹ì–´
# ============================================
# ì‚¬ìš©ë²•: make [ëª…ë ¹ì–´]
# ì˜ˆì‹œ: make unused-files
# ============================================

.PHONY: unused-files unused-code check-all dcm-install help

# DCM ì„¤ì¹˜ (ì²˜ìŒ í•œ ë²ˆë§Œ)
dcm-install:
	@echo "DCM ì„¤ì¹˜ ì¤‘..."
	dart pub global activate dart_code_metrics
	@echo "ì„¤ì¹˜ ì™„ë£Œ!"

# ì•ˆ ì“°ëŠ” íŒŒì¼ ì°¾ê¸°
unused-files:
	@echo "ğŸ” ì•ˆ ì“°ëŠ” íŒŒì¼ ê²€ì‚¬ ì¤‘..."
	@~/.pub-cache/bin/metrics check-unused-files lib --disable-sunset-warning

# ì•ˆ ì“°ëŠ” ì½”ë“œ ì°¾ê¸°
unused-code:
	@echo "ğŸ” ì•ˆ ì“°ëŠ” ì½”ë“œ ê²€ì‚¬ ì¤‘..."
	@~/.pub-cache/bin/metrics check-unused-code lib --disable-sunset-warning

# ë‘˜ ë‹¤ ì‹¤í–‰
check-all:
	@echo "=========================================="
	@echo "ğŸ“ ì•ˆ ì“°ëŠ” íŒŒì¼ ê²€ì‚¬"
	@echo "=========================================="
	@~/.pub-cache/bin/metrics check-unused-files lib --disable-sunset-warning
	@echo ""
	@echo "=========================================="
	@echo "ğŸ“ ì•ˆ ì“°ëŠ” ì½”ë“œ ê²€ì‚¬"
	@echo "=========================================="
	@~/.pub-cache/bin/metrics check-unused-code lib --disable-sunset-warning

# ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥
save-report:
	@echo "ë¦¬í¬íŠ¸ ì €ì¥ ì¤‘..."
	@~/.pub-cache/bin/metrics check-unused-files lib --disable-sunset-warning > docs/unused_files_latest.txt 2>&1
	@~/.pub-cache/bin/metrics check-unused-code lib --disable-sunset-warning > docs/unused_code_latest.txt 2>&1
	@echo "ì €ì¥ ì™„ë£Œ! docs/ í´ë” í™•ì¸í•˜ì„¸ìš”."

# ë„ì›€ë§
help:
	@echo "============================================"
	@echo "  DCM ëª…ë ¹ì–´ ë„ì›€ë§"
	@echo "============================================"
	@echo ""
	@echo "  make dcm-install   : DCM ì„¤ì¹˜ (ì²˜ìŒ í•œ ë²ˆë§Œ)"
	@echo "  make unused-files  : ì•ˆ ì“°ëŠ” íŒŒì¼ ì°¾ê¸°"
	@echo "  make unused-code   : ì•ˆ ì“°ëŠ” ì½”ë“œ ì°¾ê¸°"
	@echo "  make check-all     : ë‘˜ ë‹¤ ì‹¤í–‰"
	@echo "  make save-report   : ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥"
	@echo "  make help          : ì´ ë„ì›€ë§ ë³´ê¸°"
	@echo ""
	@echo "============================================"

# ============================================
# ê¸°íƒ€ ìœ ìš©í•œ ëª…ë ¹ì–´
# ============================================

# Flutter ê´€ë ¨
run:
	flutter run

build:
	flutter build apk --release

clean:
	flutter clean && flutter pub get

codegen:
	dart run build_runner build --delete-conflicting-outputs

# ============================================
# Design System ì±„íƒë¥  ê²€ì‚¬
# ============================================

# ìœ„ì ¯ ì±„íƒë¥  ë¦¬í¬íŠ¸
widget-report:
	@echo "ğŸ“Š Widget Adoption Report"
	@echo "========================="
	@echo ""
	@TF_TOSS=$$(grep -r "TossTextField" lib/features --include="*.dart" 2>/dev/null | wc -l | tr -d ' '); \
	TF_DIRECT=$$(grep -r "TextField(" lib/features --include="*.dart" 2>/dev/null | wc -l | tr -d ' '); \
	TF_TOTAL=$$((TF_TOSS + TF_DIRECT)); \
	if [ $$TF_TOTAL -gt 0 ]; then TF_RATE=$$((TF_TOSS * 100 / TF_TOTAL)); else TF_RATE=0; fi; \
	echo "TextField:  $$TF_TOSS Toss / $$TF_DIRECT Direct = $$TF_RATE%"
	@BTN_TOSS=$$(grep -rE "TossButton|TossPrimaryButton|TossSecondaryButton" lib/features --include="*.dart" 2>/dev/null | wc -l | tr -d ' '); \
	BTN_DIRECT=$$(grep -rE "ElevatedButton|TextButton\(|OutlinedButton" lib/features --include="*.dart" 2>/dev/null | wc -l | tr -d ' '); \
	BTN_TOTAL=$$((BTN_TOSS + BTN_DIRECT)); \
	if [ $$BTN_TOTAL -gt 0 ]; then BTN_RATE=$$((BTN_TOSS * 100 / BTN_TOTAL)); else BTN_RATE=0; fi; \
	echo "Button:     $$BTN_TOSS Toss / $$BTN_DIRECT Direct = $$BTN_RATE%"
	@CARD_TOSS=$$(grep -rE "TossCard|TossExpandableCard" lib/features --include="*.dart" 2>/dev/null | wc -l | tr -d ' '); \
	CARD_DIRECT=$$(grep -r "Card(" lib/features --include="*.dart" 2>/dev/null | wc -l | tr -d ' '); \
	CARD_TOTAL=$$((CARD_TOSS + CARD_DIRECT)); \
	if [ $$CARD_TOTAL -gt 0 ]; then CARD_RATE=$$((CARD_TOSS * 100 / CARD_TOTAL)); else CARD_RATE=0; fi; \
	echo "Card:       $$CARD_TOSS Toss / $$CARD_DIRECT Direct = $$CARD_RATE%"
	@echo ""
	@echo "ğŸ¯ Target: 70%"

# custom_lint ì‹¤í–‰
lint-custom:
	dart run custom_lint

# Flutter analyze + custom lint
lint-all:
	@echo "ğŸ” Running Flutter analyze..."
	flutter analyze --no-fatal-infos
	@echo ""
	@echo "ğŸ” Running custom_lint..."
	dart run custom_lint || true

# ============================================
# âš ï¸ DCM íŒŒì¼ ì‚­ì œ ì•ˆì „ ê°€ì´ë“œ
# ============================================
# DCMì€ data class, enumë§Œ ìˆëŠ” íŒŒì¼ì„ "unused"ë¡œ ì˜ëª» íŒë‹¨í•  ìˆ˜ ìˆìŒ
# íŒŒì¼ ì‚­ì œ ì „ ë°˜ë“œì‹œ ì•„ë˜ ì ˆì°¨ ë”°ë¥´ê¸°:
#
# 1. make unused-files-safe  (ë¹Œë“œ í…ŒìŠ¤íŠ¸ í¬í•¨)
# 2. ê²°ê³¼ ê²€í†  í›„ ìˆ˜ë™ìœ¼ë¡œ ì‚­ì œ
# 3. ì‚­ì œ í›„ make build-check ì‹¤í–‰
#
# âŒ ì ˆëŒ€ í•˜ë©´ ì•ˆë˜ëŠ” ê²ƒ:
#    - DCM ê²°ê³¼ë§Œ ë³´ê³  ë°”ë¡œ íŒŒì¼ ì‚­ì œ
#    - ë¹Œë“œ í™•ì¸ ì—†ì´ ì»¤ë°‹
# ============================================

# ì•ˆì „í•œ DCM ê²€ì‚¬ (ë¹Œë“œ í…ŒìŠ¤íŠ¸ í¬í•¨)
unused-files-safe:
	@echo "ğŸ” [1/3] ì•ˆ ì“°ëŠ” íŒŒì¼ ê²€ì‚¬ ì¤‘..."
	@~/.pub-cache/bin/metrics check-unused-files lib --disable-sunset-warning || true
	@echo ""
	@echo "âš ï¸  [2/3] ìœ„ íŒŒì¼ë“¤ ì‚­ì œ ì „ ì£¼ì˜ì‚¬í•­:"
	@echo "    - data class, enumë§Œ ìˆëŠ” íŒŒì¼ì€ false positiveì¼ ìˆ˜ ìˆìŒ"
	@echo "    - íŒŒì¼ ì‚­ì œ í›„ ë°˜ë“œì‹œ ë¹Œë“œ í…ŒìŠ¤íŠ¸ í•„ìš”"
	@echo ""
	@echo "âœ… [3/3] ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
	@flutter build ios --simulator --no-pub 2>&1 | tail -5

# ë¹Œë“œ í™•ì¸ (íŒŒì¼ ì‚­ì œ í›„ ì‹¤í–‰)
build-check:
	@echo "ğŸ”¨ ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì¤‘..."
	@flutter build ios --simulator --no-pub 2>&1 | tail -10
	@if [ $$? -eq 0 ]; then \
		echo "âœ… ë¹Œë“œ ì„±ê³µ!"; \
	else \
		echo "âŒ ë¹Œë“œ ì‹¤íŒ¨! git restoreë¡œ ì‚­ì œëœ íŒŒì¼ ë³µì›í•˜ì„¸ìš”."; \
	fi

# ì‚­ì œëœ íŒŒì¼ ë³µì›
restore-deleted:
	@echo "ğŸ”„ ì‚­ì œëœ íŒŒì¼ ë³µì› ì¤‘..."
	git checkout HEAD -- lib/
	@echo "âœ… ë³µì› ì™„ë£Œ!"
