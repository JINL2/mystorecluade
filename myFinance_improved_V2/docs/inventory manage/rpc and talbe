# ğŸ“Š ì¸ë²¤í† ë¦¬ ë¶„ì„ ì‹œìŠ¤í…œ - ì™„ì„±ëœ RPC & í…Œì´ë¸” ëª©ë¡

## âœ… ì™„ì„±ëœ RPC Functions (7ê°œ)

### ì‹œìŠ¤í…œ 1: Sales Analysis (3ê°œ)

#### 1. `get_sales_dashboard`
```sql
Parameters:
  - p_company_id UUID (required)
  - p_store_id UUID (optional)

Returns: JSON
{
  "this_month": {
    "revenue": number,
    "cost": number,
    "margin": number,
    "margin_rate": number,
    "quantity": number
  },
  "last_month": { ... },
  "growth": {
    "revenue_pct": number,
    "margin_pct": number,
    "quantity_pct": number
  }
}

Usage:
SELECT get_sales_dashboard(
  '7a2545e0-e112-4b0c-9c59-221a530c4602'::UUID,
  NULL  -- all stores
);
```

#### 2. `get_bcg_matrix`
```sql
Parameters:
  - p_company_id UUID (required)
  - p_month DATE (default: CURRENT_DATE)
  - p_store_id UUID (optional)

Returns: JSON
{
  "star": [{category_id, category_name, total_revenue, margin_rate_pct, ...}],
  "cash_cow": [...],
  "problem_child": [...],
  "dog": [...]
}

Usage:
SELECT get_bcg_matrix(
  '7a2545e0-e112-4b0c-9c59-221a530c4602'::UUID,
  CURRENT_DATE,
  NULL
);
```

#### 3. `get_category_detail`
```sql
Parameters:
  - p_company_id UUID (required)
  - p_category_id UUID (required)
  - p_month DATE (default: CURRENT_DATE)

Returns: JSON
{
  "category": {
    "category_name": string,
    "total_revenue": number,
    "total_margin": number,
    "avg_margin_rate": number,
    "total_quantity": number
  },
  "top_brands": [
    {
      "brand_name": string,
      "revenue": number,
      "avg_margin_rate": number,
      "quantity": number
    }
  ],
  "problem_products": [
    {
      "product_name": string,
      "current_stock": number,
      "reorder_point_95": number,
      "days_of_inventory": number,
      "issue_type": string
    }
  ]
}

Usage:
SELECT get_category_detail(
  '7a2545e0-e112-4b0c-9c59-221a530c4602'::UUID,
  '3a566126-eadc-4a7c-b990-029403b4ae4d'::UUID,  -- wallet
  CURRENT_DATE
);
```

---

### ì‹œìŠ¤í…œ 2: Supply Chain (1ê°œ)

#### 4. `get_supply_chain_status`
```sql
Parameters:
  - p_company_id UUID (required)

Returns: JSON
{
  "urgent_products": [
    {
      "product_name": string,
      "delay_days": number,
      "avg_shortage": number,
      "total_shortage": number,
      "error_integral": number,
      "risk_level": "Critical" | "Warning"
    }
  ]
}

Usage:
SELECT get_supply_chain_status(
  '7a2545e0-e112-4b0c-9c59-221a530c4602'::UUID
);
```

---

### ì‹œìŠ¤í…œ 3: Stock Accuracy (1ê°œ)

#### 5. `get_discrepancy_overview`
```sql
Parameters:
  - p_company_id UUID (required)
  - p_period TEXT (default: 'all')  -- 'all', '30d', '7d'

Returns: JSON
{
  "status": "success" | "insufficient_data",
  "message": string (if insufficient),
  "min_required": string (if insufficient),
  "period": string,
  "cumulative": {
    "increase_value": number,
    "decrease_value": number,
    "net_value": number,
    "net_pct": number
  },
  "stores": [
    {
      "store_name": string,
      "net_value": number,
      "increase_value": number,
      "decrease_value": number,
      "increase_count": number,
      "decrease_count": number
    }
  ]
}

Usage:
SELECT get_discrepancy_overview(
  '7a2545e0-e112-4b0c-9c59-221a530c4602'::UUID,
  'all'
);
```

---

### ì‹œìŠ¤í…œ 4: Order Management (2ê°œ)

#### 6. `get_inventory_optimization_dashboard`
```sql
Parameters:
  - p_company_id UUID (required)

Returns: JSON
{
  "overall_score": number (0-100),
  "metrics": {
    "stockout_rate": number,
    "overstock_rate": number,
    "avg_turnover": number,
    "reorder_needed": number
  },
  "urgent_orders": [
    {
      "product_name": string,
      "current_stock": number,
      "reorder_point": number,
      "order_qty": number,
      "avg_daily_demand": number,
      "days_left": number
    }
  ]
}

Usage:
SELECT get_inventory_optimization_dashboard(
  '7a2545e0-e112-4b0c-9c59-221a530c4602'::UUID
);
```

#### 7. `get_inventory_reorder_list`
```sql
Parameters:
  - p_company_id UUID (required)
  - p_priority TEXT (default: 'all')  -- 'critical', 'warning', 'all'
  - p_limit INT (default: 100)

Returns: JSON
[
  {
    "product_id": uuid,
    "product_name": string,
    "category_name": string,
    "current_stock": number,
    "reorder_point": number,
    "suggested_order_qty": number,
    "avg_daily_demand": number,
    "days_of_inventory": number,
    "priority": "Critical" | "Warning" | "Normal"
  }
]

Usage:
SELECT get_inventory_reorder_list(
  '7a2545e0-e112-4b0c-9c59-221a530c4602'::UUID,
  'critical',
  10
);
```

---

## ğŸ“Š Materialized Views (4ê°œ)

### 1. `inventory_statistic_sales_by_category_monthly`
**í¬ê¸°:** 80 KB  
**ëª©ì :** ì¹´í…Œê³ ë¦¬ë³„ ì›”ë³„ ë§¤ì¶œ ë¶„ì„

**ì£¼ìš” ì»¬ëŸ¼:**
- company_id (UUID)
- month (TIMESTAMP)
- store_id (UUID)
- store_name (VARCHAR)
- category_id (UUID)
- category_name (VARCHAR)
- parent_category_id (UUID)
- parent_category_name (VARCHAR)
- total_revenue (NUMERIC)
- total_cost (NUMERIC)
- total_margin (NUMERIC)
- margin_rate_pct (NUMERIC)
- total_quantity (NUMERIC)
- invoice_count (INTEGER)

**ì¸ë±ìŠ¤:**
- idx_inv_stat_sales_category_company_month (company_id, month)
- idx_inv_stat_sales_category_store (store_id, month)
- idx_inv_stat_sales_category_category (category_id, month)

**ë°ì´í„°:**
- í˜„ì¬ 62 rows
- ì¹´í…Œê³ ë¦¬ Ã— ë§¤ì¥ Ã— ì›”ë³„ ì§‘ê³„

---

### 2. `inventory_statistic_inventory_optimization`
**í¬ê¸°:** 3.6 MB  
**ëª©ì :** ì¬ê³  ìµœì í™” ë° ì£¼ë¬¸ ì¶”ì²œ

**ì£¼ìš” ì»¬ëŸ¼:**
- company_id (UUID)
- product_id (UUID)
- product_name (VARCHAR)
- category_id (UUID)
- category_name (VARCHAR)
- current_stock (NUMERIC)
- total_sold_90d (NUMERIC)
- days_with_sales_90d (INTEGER)
- avg_daily_demand (NUMERIC)
- demand_stddev (NUMERIC)
- demand_cv (NUMERIC) -- ë³€ë™ê³„ìˆ˜
- safety_stock_95 (NUMERIC)
- reorder_point_95 (NUMERIC)
- inventory_turnover (NUMERIC)
- days_of_inventory (NUMERIC)

**ì¸ë±ìŠ¤:**
- idx_inv_stat_inventory_opt_company (company_id)
- idx_inv_stat_inventory_opt_reorder (company_id, days_of_inventory) WHERE current_stock < reorder_point_95

**ë°ì´í„°:**
- í˜„ì¬ 1,245 ì œí’ˆ
- 34ê°œ ì œí’ˆ ì£¼ë¬¸ í•„ìš”

---

### 3. `inventory_statistic_discrepancy_monthly`
**í¬ê¸°:** 48 KB  
**ëª©ì :** ì¬ê³  ë¶ˆì¼ì¹˜ í†µê³„ ë¶„ì„

**ì£¼ìš” ì»¬ëŸ¼:**
- company_id (UUID)
- month (TIMESTAMP)
- store_id (UUID)
- store_name (VARCHAR)
- total_adjustments (INTEGER)
- increase_count (INTEGER)
- decrease_count (INTEGER)
- increase_qty (NUMERIC)
- decrease_qty (NUMERIC)
- net_qty (NUMERIC)
- increase_value (NUMERIC)
- decrease_value (NUMERIC)
- net_value (NUMERIC)

**ì¸ë±ìŠ¤:**
- idx_inv_stat_discrepancy_monthly_company_month (company_id, month)
- idx_inv_stat_discrepancy_monthly_store (store_id, month)

**ë°ì´í„°:**
- í˜„ì¬ 1 row (test1 ë§¤ì¥, 12ê±´)
- í†µê³„ ë¶„ì„ ë¶ˆê°€ (ìµœì†Œ 30ê±´, 3ê°œ ë§¤ì¥ í•„ìš”)

---

### 4. `inventory_statistic_supply_chain_product_errors`
**í¬ê¸°:** 72 KB  
**ëª©ì :** ê³µê¸‰ë§ ë³‘ëª© ë¶„ì„ (ì ë¶„ê°’ ê¸°ë°˜)

**ì£¼ìš” ì»¬ëŸ¼:**
- product_id (UUID)
- product_name (VARCHAR)
- company_id (UUID)
- shortage_days (INTEGER) -- ë¶€ì¡± ì¼ìˆ˜
- avg_shortage_per_day (NUMERIC) -- ì¼í‰ê·  ë¶€ì¡±ëŸ‰
- total_shortage (NUMERIC) -- ì´ ë¶€ì¡±ëŸ‰
- error_integral (NUMERIC) -- ì ë¶„ê°’ (ë¶€ì¡±ëŸ‰ Ã— ì¼ìˆ˜)
- risk_level (TEXT) -- 'Critical', 'Warning', 'Normal'

**ì¸ë±ìŠ¤:**
- idx_inv_stat_supply_errors_company (company_id, error_integral DESC)

**ë°ì´í„°:**
- í˜„ì¬ 225ê°œ ë¬¸ì œ ì œí’ˆ
- Top 3: ë¸Œëœë“œ ëª¨ì (160), ìŠ¤ì¹´í”„ (125), ì•…ì„¸ì‚¬ë¦¬ (112)

---

## ğŸ“‹ ì›ë³¸ í…Œì´ë¸” (ì‚¬ìš© ì¤‘ì¸ ì£¼ìš” í…Œì´ë¸”)

### 1. `inventory_logs`
**ëª©ì :** ëª¨ë“  ì¬ê³  ì´ë™ ê¸°ë¡
**ì£¼ìš” ì»¬ëŸ¼:**
- log_id (UUID)
- company_id (UUID)
- store_id (UUID)
- product_id (UUID)
- event_type (VARCHAR) -- 'stock_sale', 'receiving', 'counting', etc.
- quantity_before (NUMERIC)
- quantity_after (NUMERIC)
- quantity_change (NUMERIC)
- cost_after (NUMERIC)
- created_at_utc (TIMESTAMP)
- invoice_id (UUID)

**ì‚¬ìš©ì²˜:** ëª¨ë“  Viewì˜ ê¸°ë³¸ ë°ì´í„° ì†ŒìŠ¤

---

### 2. `inventory_products`
**ëª©ì :** ì œí’ˆ ë§ˆìŠ¤í„°
**ì£¼ìš” ì»¬ëŸ¼:**
- product_id (UUID)
- company_id (UUID)
- product_name (VARCHAR)
- category_id (UUID)
- brand_id (UUID)
- cost_price (NUMERIC)
- selling_price (NUMERIC)
- is_active (BOOLEAN)
- is_deleted (BOOLEAN)

---

### 3. `inventory_product_categories`
**ëª©ì :** ì¹´í…Œê³ ë¦¬ ê³„ì¸µ êµ¬ì¡°
**ì£¼ìš” ì»¬ëŸ¼:**
- category_id (UUID)
- category_name (VARCHAR)
- parent_category_id (UUID)

---

### 4. `inventory_current_stock`
**ëª©ì :** í˜„ì¬ ì¬ê³  ìŠ¤ëƒ…ìƒ·
**ì£¼ìš” ì»¬ëŸ¼:**
- product_id (UUID)
- store_id (UUID)
- quantity_on_hand (NUMERIC)

---

### 5. `inventory_brands`
**ëª©ì :** ë¸Œëœë“œ ì •ë³´
**ì£¼ìš” ì»¬ëŸ¼:**
- brand_id (UUID)
- brand_name (VARCHAR)

---

### 6. `stores`
**ëª©ì :** ë§¤ì¥ ì •ë³´
**ì£¼ìš” ì»¬ëŸ¼:**
- store_id (UUID)
- store_name (VARCHAR)
- company_id (UUID)
- is_deleted (BOOLEAN)

---

## ğŸ”„ ë°ì´í„° íë¦„

```
ì›ë³¸ ë°ì´í„° (Tables)
  â”‚
  â”œâ”€ inventory_logs
  â”œâ”€ inventory_products
  â”œâ”€ inventory_current_stock
  â”œâ”€ inventory_product_categories
  â”œâ”€ inventory_brands
  â””â”€ stores
  â”‚
  â†“ (ì§‘ê³„ & ê³„ì‚°)
  â”‚
Materialized Views (4ê°œ)
  â”‚
  â”œâ”€ inventory_statistic_sales_by_category_monthly
  â”œâ”€ inventory_statistic_inventory_optimization
  â”œâ”€ inventory_statistic_discrepancy_monthly
  â””â”€ inventory_statistic_supply_chain_product_errors
  â”‚
  â†“ (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ & í•„í„°ë§)
  â”‚
RPC Functions (7ê°œ)
  â”‚
  â”œâ”€ get_sales_dashboard
  â”œâ”€ get_bcg_matrix
  â”œâ”€ get_category_detail
  â”œâ”€ get_supply_chain_status
  â”œâ”€ get_discrepancy_overview
  â”œâ”€ get_inventory_optimization_dashboard
  â””â”€ get_inventory_reorder_list
  â”‚
  â†“ (JSON ì‘ë‹µ)
  â”‚
Frontend (React)
```

---

## ğŸ“Š ì´ ë°ì´í„° í¬ê¸°

| View | í¬ê¸° | í–‰ ìˆ˜ | ìƒíƒœ |
|------|------|-------|------|
| sales_by_category_monthly | 80 KB | ~62 | âœ… |
| inventory_optimization | 3.6 MB | 1,245 | âœ… |
| discrepancy_monthly | 48 KB | 1 | âš ï¸ |
| supply_chain_errors | 72 KB | 225 | âœ… |
| **TOTAL** | **~3.8 MB** | **1,533** | |

---

## ğŸ¯ API ì—”ë“œí¬ì¸íŠ¸ ë§¤í•‘

### Frontend Routes â†’ RPC Mapping

```typescript
// Dashboard Overview
/inventory/dashboard
  â†’ get_sales_dashboard()
  â†’ get_inventory_optimization_dashboard()
  â†’ get_supply_chain_status()
  â†’ get_discrepancy_overview()

// Sales Analysis
/inventory/sales-analysis
  â†’ get_bcg_matrix()
  â†’ get_category_detail()

// Order Management
/inventory/order-management
  â†’ get_inventory_optimization_dashboard()
  â†’ get_inventory_reorder_list()

// Supply Chain
/inventory/supply-chain
  â†’ get_supply_chain_status()

// Stock Accuracy
/inventory/stock-accuracy
  â†’ get_discrepancy_overview()
```

---

## âœ… ì™„ì„±ë„

- **RPC Functions:** 7/7 âœ…
- **Materialized Views:** 4/4 âœ…
- **Indexes:** 10/10 âœ…
- **Test Data:** âœ…
- **Documentation:** âœ…

**ì¤€ë¹„ ì™„ë£Œ! Frontend ê°œë°œ ì‹œì‘ ê°€ëŠ¥** ğŸš€