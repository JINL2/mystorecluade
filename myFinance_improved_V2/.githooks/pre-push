#!/bin/bash
# ===========================================
# Pre-Push Hook - Push 전 코드 품질 검사
# ===========================================
# 이 스크립트는 git push 전에 자동 실행됩니다.
# 검사 실패시 push가 차단됩니다.
# ===========================================

set -e

echo ""
echo "🔍 Pre-Push 코드 품질 검사 시작..."
echo "==========================================="

# 프로젝트 디렉토리로 이동
cd "$(git rev-parse --show-toplevel)/myFinance_improved_V2" 2>/dev/null || cd "$(git rev-parse --show-toplevel)"

# 1. Flutter Analyze (에러만 체크)
echo ""
echo "📋 Step 1/3: Flutter Analyze..."
if ! flutter analyze lib --no-fatal-infos --no-fatal-warnings 2>&1 | grep -q "No issues found"; then
    # 에러가 있는지 확인
    ERRORS=$(flutter analyze lib 2>&1 | grep -c "error •" || true)
    if [ "$ERRORS" -gt 0 ]; then
        echo "❌ Flutter Analyze 실패: $ERRORS개의 에러 발견"
        echo ""
        echo "에러를 수정한 후 다시 push 해주세요."
        exit 1
    fi
fi
echo "✅ Flutter Analyze 통과"

# 2. DCM 미사용 코드 검사
echo ""
echo "📋 Step 2/3: DCM 미사용 코드 검사..."
UNUSED_CODE=$(~/.pub-cache/bin/metrics check-unused-code lib --no-fatal-unused 2>&1 | grep -c "⚠ unused" || true)
if [ "$UNUSED_CODE" -gt 0 ]; then
    echo "❌ DCM 실패: $UNUSED_CODE개의 미사용 코드 발견"
    echo ""
    echo "미사용 코드를 제거한 후 다시 push 해주세요."
    echo "검사 명령: ~/.pub-cache/bin/metrics check-unused-code lib"
    exit 1
fi
echo "✅ DCM 미사용 코드 없음"

# 3. DCM 미사용 파일 검사
echo ""
echo "📋 Step 3/3: DCM 미사용 파일 검사..."
UNUSED_FILES=$(~/.pub-cache/bin/metrics check-unused-files lib --no-fatal-unused 2>&1 | grep -c "⚠ unused" || true)
if [ "$UNUSED_FILES" -gt 0 ]; then
    echo "❌ DCM 실패: $UNUSED_FILES개의 미사용 파일 발견"
    echo ""
    echo "미사용 파일을 제거한 후 다시 push 해주세요."
    echo "검사 명령: ~/.pub-cache/bin/metrics check-unused-files lib"
    exit 1
fi
echo "✅ DCM 미사용 파일 없음"

echo ""
echo "==========================================="
echo "🎉 모든 검사 통과! Push를 진행합니다..."
echo "==========================================="
echo ""

exit 0
