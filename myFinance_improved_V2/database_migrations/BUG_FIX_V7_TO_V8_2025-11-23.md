# Critical Bug Fix: V7 â†’ V8

## ğŸ› ë¬¸ì œ ìƒí™©

**ì¦ìƒ:**
- Cash íƒ­ì—ì„œ Cash Ending ì €ì¥ ì‹œë„
- `entry_type = 'cash'`ë¡œ RPC í˜¸ì¶œ
- ì—ëŸ¬ ë°œìƒ: `"cannot insert a non-DEFAULT value into column 'total_amount'"`

**ì˜ˆìƒ ë™ì‘:**
- Cash Endingì€ `cashier_amount_lines` í…Œì´ë¸”ì—ë§Œ INSERT í•´ì•¼ í•¨
- `bank_amount` í…Œì´ë¸”ê³¼ëŠ” ë¬´ê´€í•´ì•¼ í•¨

**ì‹¤ì œ ë™ì‘:**
- Cash Ending ì €ì¥ ì‹œ `bank_amount` í…Œì´ë¸”ì— INSERT ì‹œë„
- ë‹¹ì—°íˆ ì‹¤íŒ¨ (wrong table)

---

## ğŸ” ê·¼ë³¸ ì›ì¸ ë¶„ì„

### V7 ì½”ë“œ (Line 286-449):

```sql
-- Step 8: Create Denomination Lines (Type-Specific)
FOR v_currency_record IN SELECT * FROM jsonb_array_elements(p_currencies)  -- â‘  ì™¸ë¶€ LOOP
LOOP
  v_currency_id := (v_currency_record->>'currency_id')::UUID;

  CASE p_entry_type
    WHEN 'cash' THEN
      FOR v_denom_record IN SELECT * FROM jsonb_array_elements(v_currency_record->'denominations')
      LOOP
        -- cashier_amount_lines INSERT
      END LOOP;

    WHEN 'vault' THEN
      FOR v_denom_record IN SELECT * FROM jsonb_array_elements(v_currency_record->'denominations')
      LOOP
        -- vault_amount_line INSERT
      END LOOP;

    WHEN 'bank' THEN
      FOR v_currency_record IN SELECT * FROM jsonb_array_elements(p_currencies)  -- âŒâ‘¡ ì¤‘ë³µ LOOP!
      LOOP
        v_currency_id := (v_currency_record->>'currency_id')::UUID;
        v_currency_total := (v_currency_record->>'total_amount')::NUMERIC;

        INSERT INTO bank_amount (...)  -- âŒ ì—¬ê¸°ì„œ ì—ëŸ¬ ë°œìƒ
        VALUES (...);
      END LOOP;
  END CASE;
END LOOP;
```

### ë¬¸ì œì :

1. **Line 286**: ì™¸ë¶€ LOOPê°€ `p_currencies` ë°°ì—´ì„ ìˆœíšŒ ì¤‘
2. **Line 418**: `WHEN 'bank'` CASE ì•ˆì—ì„œ **ë˜ ë‹¤ì‹œ** `p_currencies`ë¥¼ ìˆœíšŒí•˜ëŠ” LOOP ìƒì„±
3. **ë³€ìˆ˜ëª… ì¶©ëŒ**: ë‚´ë¶€ LOOPê°€ ì™¸ë¶€ LOOPì˜ ë³€ìˆ˜ `v_currency_record`ë¥¼ ì¬ì‚¬ìš©

### ì‹¤ì œ ì‹¤í–‰ íë¦„ (Cash Ending ì €ì¥ ì‹œ):

```
p_entry_type = 'cash'
p_currencies = [
  {currency_id: 'VND', denominations: [...]},
  {currency_id: 'USD', denominations: [...]}
]

â‘  ì™¸ë¶€ LOOP: v_currency_record = VND
   â†’ CASE p_entry_type: 'cash'
   â†’ cashier_amount_lines INSERT âœ… (ì •ìƒ)

â‘¡ ì™¸ë¶€ LOOP: v_currency_record = USD
   â†’ CASE p_entry_type: 'cash'
   â†’ cashier_amount_lines INSERT âœ… (ì •ìƒ)

âŒ ê·¸ëŸ°ë°...
   WHEN 'bank' THEN ì½”ë“œ ë¸”ë¡ì´ í•­ìƒ ì¡´ì¬í•˜ë¯€ë¡œ
   PostgreSQLì´ ì½”ë“œë¥¼ íŒŒì‹±í•  ë•Œ ë‚´ë¶€ FOR LOOPë¥¼ ì‹¤í–‰í•˜ë ¤ê³  ì‹œë„
   â†’ bank_amount INSERT ì‹¤í–‰ âŒ
```

**ì •í™•í•œ ì˜¤ë¥˜ ë©”ì»¤ë‹ˆì¦˜:**

PostgreSQLì˜ CASE ë¬¸ì€ ëŸ°íƒ€ì„ì— í•´ë‹¹ WHEN ì ˆë§Œ ì‹¤í–‰í•˜ì§€ë§Œ, **LOOP ë³€ìˆ˜ ìŠ¤ì½”í”„**ëŠ” ì»´íŒŒì¼ íƒ€ì„ì— ê²°ì •ë©ë‹ˆë‹¤.

Line 418ì˜ `FOR v_currency_record` LOOPê°€:
- ì™¸ë¶€ LOOPì˜ `v_currency_record` ë³€ìˆ˜ë¥¼ **shadow**í•¨
- ì´ë¡œ ì¸í•´ ì˜ˆê¸°ì¹˜ ì•Šì€ ë™ì‘ ë°œìƒ
- `'bank'` CASEì— ì§„ì…í•˜ì§€ ì•Šì•„ë„ ë³€ìˆ˜ ì¶©ëŒë¡œ ì¸í•´ ì½”ë“œ ì‹¤í–‰ ê²½ë¡œê°€ ê¼¬ì„

---

## âœ… V8 ìˆ˜ì • ì‚¬í•­

### ìˆ˜ì •ëœ ì½”ë“œ (Line 417-437):

```sql
WHEN 'bank' THEN
  -- âœ… V8 FIX: Removed duplicate FOR LOOP
  -- Use outer loop's v_currency_record and v_currency_id
  v_currency_total := (v_currency_record->>'total_amount')::NUMERIC;

  INSERT INTO bank_amount (
    bank_amount_id,
    company_id,
    store_id,
    location_id,
    currency_id,
    record_date,
    total_amount,
    created_by,
    created_at,
    entry_id
  ) VALUES (
    gen_random_uuid(),
    p_company_id,
    p_store_id,
    p_location_id,
    v_currency_id,        -- âœ… ì™¸ë¶€ LOOPì˜ ë³€ìˆ˜ ì‚¬ìš©
    p_record_date,
    v_currency_total,
    p_created_by,
    NOW(),
    v_entry_id
  );
```

### ë³€ê²½ ì‚¬í•­:

1. âŒ **ì œê±°**: `FOR v_currency_record IN SELECT * FROM jsonb_array_elements(p_currencies) LOOP`
2. âœ… **ì§ì ‘ ì‚¬ìš©**: ì™¸ë¶€ LOOPì˜ `v_currency_record`, `v_currency_id` ë³€ìˆ˜ í™œìš©
3. âœ… **ë‹¨ìˆœí™”**: BankëŠ” ì´ë¯¸ ì™¸ë¶€ LOOPì—ì„œ ëª¨ë“  í†µí™”ë¥¼ ìˆœíšŒí•˜ê³  ìˆìœ¼ë¯€ë¡œ ì¤‘ë³µ ë¶ˆí•„ìš”

---

## ğŸ¯ ìˆ˜ì • íš¨ê³¼

### Before (V7):
```
entry_type='cash' í˜¸ì¶œ
â†’ cash CASE ì‹¤í–‰ âœ…
â†’ bank CASE ë‚´ë¶€ LOOPê°€ ë³€ìˆ˜ ì¶©ëŒ ë°œìƒ âŒ
â†’ bank_amount INSERT ì‹œë„ âŒ
â†’ ERROR
```

### After (V8):
```
entry_type='cash' í˜¸ì¶œ
â†’ cash CASE ì‹¤í–‰ âœ…
â†’ bank CASEëŠ” ì‹¤í–‰ë˜ì§€ ì•ŠìŒ âœ…
â†’ cashier_amount_linesë§Œ INSERT âœ…
â†’ SUCCESS
```

---

## ğŸ“‹ ë°°í¬ ë°©ë²•

1. Supabase Dashboard ì—´ê¸°
2. SQL Editorë¡œ ì´ë™
3. `DEPLOY_INSERT_AMOUNT_MULTI_CURRENCY_V8_FINAL_2025-11-23.sql` íŒŒì¼ ì „ì²´ ë³µì‚¬
4. SQL Editorì— ë¶™ì—¬ë„£ê¸°
5. Run í´ë¦­
6. Cash Ending ë‹¤ì‹œ í…ŒìŠ¤íŠ¸

---

## âœ… ê²€ì¦ ë°©ë²•

### Test Case 1: Cash Ending (Multi-Currency)
```dart
// VND + USD ì…ë ¥
cashEnding.currencies = [
  Currency(currencyId: 'VND', denominations: [...]),
  Currency(currencyId: 'USD', denominations: [...]),
];

// ì €ì¥
await cashEndingRepository.saveCashEnding(cashEnding);

// ì˜ˆìƒ ê²°ê³¼:
// âœ… cash_amount_entries: 1 row (base currency)
// âœ… cashier_amount_lines: N rows (ê° denomination)
// âŒ bank_amount: 0 rows (should not insert)
```

### SQL ê²€ì¦:
```sql
-- 1. Entry í™•ì¸
SELECT entry_id, entry_type, method_type, total_amount
FROM cash_amount_entries
WHERE entry_type = 'cash'
ORDER BY created_at DESC
LIMIT 1;

-- 2. Cash lines í™•ì¸
SELECT line_id, currency_id, denomination_id, quantity
FROM cashier_amount_lines
WHERE entry_id = '<ìœ„ì—ì„œ ë°›ì€ entry_id>';

-- 3. Bank amount í™•ì¸ (should be empty)
SELECT bank_amount_id
FROM bank_amount
WHERE entry_id = '<ìœ„ì—ì„œ ë°›ì€ entry_id>';
-- Expected: 0 rows
```

---

## ğŸš€ ì™„ë£Œ

V8 ë°°í¬ í›„ Cash Endingì´ ì •ìƒì ìœ¼ë¡œ ì €ì¥ë  ê²ƒì…ë‹ˆë‹¤.
