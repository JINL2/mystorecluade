# ===========================================
# DCM ìë™ ê²€ì‚¬ ì›Œí¬í”Œë¡œìš°
# ===========================================
# ì´ê²Œ ë­ëƒë©´:
# - ëˆ„êµ°ê°€ ì½”ë“œë¥¼ ì˜¬ë¦¬ë©´ (Push/PR)
# - GitHub ì„œë²„ê°€ ìë™ìœ¼ë¡œ DCM ê²€ì‚¬ë¥¼ ëŒë¦¼
# - ë¬¸ì œ ìˆìœ¼ë©´ âŒ, ì—†ìœ¼ë©´ âœ…
#
# ì¹œêµ¬ë“¤ì€ ì•„ë¬´ê²ƒë„ ì„¤ì¹˜ ì•ˆ í•´ë„ ë¨!
# ===========================================

name: Code Quality Check

# ì–¸ì œ ì‹¤í–‰ë˜ëƒë©´:
on:
  # ì´ ë¸Œëœì¹˜ë“¤ì— PR ì˜¬ë¦´ ë•Œ
  pull_request:
    branches: [main, develop, Jinrefector, nghiasb, jeong11]

  # ì´ ë¸Œëœì¹˜ë“¤ì— ì§ì ‘ pushí•  ë•Œ
  push:
    branches: [main, develop, Jinrefector, nghiasb, jeong11]

jobs:
  # ===========================================
  # DCM ê²€ì‚¬ (ë¬´ë£Œ ë²„ì „)
  # ===========================================
  dcm-check:
    name: DCM Analysis
    runs-on: ubuntu-latest

    steps:
      # 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Flutter ì„¤ì¹˜
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      # 3. íŒ¨í‚¤ì§€ ì„¤ì¹˜
      - name: Install dependencies
        run: flutter pub get

      # 4. DCM ì„¤ì¹˜
      - name: Install DCM
        run: dart pub global activate dart_code_metrics

      # 5. ë¯¸ì‚¬ìš© íŒŒì¼ ê²€ì‚¬
      - name: Check unused files
        run: |
          echo "ğŸ” ë¯¸ì‚¬ìš© íŒŒì¼ ê²€ì‚¬ ì¤‘..."
          ~/.pub-cache/bin/metrics check-unused-files lib --disable-sunset-warning || true

      # 6. ë¯¸ì‚¬ìš© ì½”ë“œ ê²€ì‚¬
      - name: Check unused code
        run: |
          echo "ğŸ” ë¯¸ì‚¬ìš© ì½”ë“œ ê²€ì‚¬ ì¤‘..."
          ~/.pub-cache/bin/metrics check-unused-code lib --disable-sunset-warning || true

  # ===========================================
  # Flutter ê¸°ë³¸ ë¶„ì„ (ë¬´ë£Œ, í•­ìƒ ê°€ëŠ¥)
  # ===========================================
  flutter-analyze:
    name: Flutter Analyze
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run Flutter analyze
        run: flutter analyze --no-fatal-infos

  # ===========================================
  # ë¹Œë“œ í…ŒìŠ¤íŠ¸ (ì•±ì´ ë¹Œë“œë˜ëŠ”ì§€ í™•ì¸)
  # ===========================================
  build-test:
    name: Build Test
    runs-on: ubuntu-latest
    needs: [flutter-analyze]  # analyze í†µê³¼í•´ì•¼ ë¹Œë“œ

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Build APK (release)
        run: flutter build apk --release --no-tree-shake-icons
