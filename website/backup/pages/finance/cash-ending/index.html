<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance - Cash Ending</title>
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="../../../core/themes/toss-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-component-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-base.css">
    <link rel="stylesheet" href="../../../core/themes/toss-typography.css">
    
    <!-- Component CSS -->
    <link rel="stylesheet" href="../../../components/base/toss-button.css">
    <link rel="stylesheet" href="../../../components/form/toss-input.css">
    <link rel="stylesheet" href="../../../components/form/toss-select.css">
    <link rel="stylesheet" href="../../../components/form/toss-filter.css">
    <link rel="stylesheet" href="../../../components/feedback/toss-alert.css">
    <link rel="stylesheet" href="../../../components/navigation/navbar.css">
    <link rel="stylesheet" href="../../../components/layout/toss-modal.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Page Specific Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background: var(--toss-gray-50);
            min-height: 100vh;
        }
        
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .page-content {
            flex: 1;
            padding: var(--space-6);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .page-header {
            margin-bottom: var(--space-8);
        }
        
        .page-title {
            font-size: var(--font-h1);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .page-subtitle {
            font-size: var(--font-large);
            color: var(--text-secondary);
            margin: 0;
        }

        /* Store Filter Controls - Exact match with employee setting */
        .controls-card {
            background: transparent;
            padding: 0;
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .control-section {
            flex: 0 1 auto;
            min-width: 200px;
            max-width: 280px;
            width: 280px;
            display: flex;
            align-items: center;
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            gap: 10px;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: white;
            height: 44px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        }
        
        .control-section:hover {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.12);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        
        .control-section.dropdown-open {
            background: white;
            border-color: #0064FF;
            box-shadow: 0 0 0 4px rgba(0, 100, 255, 0.08);
        }
        
        .control-section.dropdown-open .control-dropdown {
            transform: rotate(180deg);
            color: #0064FF;
        }
        
        .control-section.dropdown-open .control-label {
            color: #0064FF;
            font-weight: 500;
        }
        
        .control-icon {
            width: 18px;
            height: 18px;
            color: rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
        }
        
        .control-icon.active {
            color: var(--toss-primary);
        }
        
        .control-label {
            font-size: 14px;
            font-weight: 500;
            color: #1a1a1a;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }
        
        .control-dropdown {
            width: 16px;
            height: 16px;
            color: rgba(0, 0, 0, 0.3);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            margin-left: auto;
        }
        
        .filter-indicator {
            position: relative;
        }
        
        .filter-indicator::after {
            content: '';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 8px;
            height: 8px;
            background: var(--toss-primary);
            border-radius: 50%;
            display: none;
        }
        
        .filter-indicator.active::after {
            display: block;
        }

        /* Store Filter Dropdown - Exact match with employee setting */
        .store-filter-dropdown {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            min-width: 100%;
            width: max-content;
            max-width: 380px;
            background: white;
            border-radius: 14px;
            
            /* Modern shadow elevation */
            box-shadow: 
                0 0 0 1px rgba(0, 0, 0, 0.04),
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            z-index: 1000;
            
            /* Animation states */
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px) scale(0.96);
            transition: all 200ms cubic-bezier(0.16, 1, 0.3, 1);
            
            max-height: 380px;
            overflow-y: auto;
            overflow-x: hidden;
            
            /* Content padding */
            padding: 6px 0;
        }
        
        .store-filter-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .store-filter-dropdown-option {
            position: relative;
            padding: 10px 16px;
            margin: 0 6px;
            border-radius: 8px;
            
            display: flex;
            align-items: center;
            gap: 12px;
            
            cursor: pointer;
            transition: all 120ms ease-out;
            
            font-size: 14px;
            line-height: 1.42857;
            color: #1a1a1a;
            
            /* Hover interactions */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .store-filter-dropdown-option:hover {
            background: rgba(0, 0, 0, 0.04);
        }
        
        .store-filter-dropdown-option:active {
            background: rgba(0, 0, 0, 0.08);
            transform: scale(0.98);
            transition: all 80ms ease-out;
        }
        
        .store-filter-dropdown-option.selected {
            background: rgba(0, 100, 255, 0.08);
            color: #0064FF;
            font-weight: 500;
        }
        
        .store-filter-dropdown-option.selected:hover {
            background: rgba(0, 100, 255, 0.12);
        }
        
        .store-filter-dropdown-option.focused {
            background: rgba(0, 0, 0, 0.04);
            outline: none;
        }
        
        .store-filter-dropdown-option-icon {
            width: 16px;
            height: 16px;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }
        
        .store-filter-dropdown-option.selected .store-filter-dropdown-option-icon {
            color: var(--toss-primary);
        }
        
        .store-filter-dropdown-option-text {
            font-size: var(--font-medium);
            color: var(--text-primary);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .store-filter-dropdown-option.selected .store-filter-dropdown-option-text {
            color: var(--toss-primary);
            font-weight: 500;
        }
        
        .store-filter-dropdown-option-check {
            width: 16px;
            height: 16px;
            color: var(--toss-primary);
            flex-shrink: 0;
        }
        
        .store-filter-search {
            width: 100%;
            padding: 10px 16px;
            border: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            font-size: 14px;
            outline: none;
            background: rgba(0, 0, 0, 0.02);
            color: #1a1a1a;
            font-family: inherit;
            margin: 0 6px 6px;
            border-radius: 8px 8px 0 0;
        }
        
        .store-filter-search:focus {
            border-bottom-color: #0064FF;
            background: white;
            box-shadow: 0 0 0 1px rgba(0, 100, 255, 0.2);
        }
        
        .store-filter-search::placeholder {
            color: rgba(0, 0, 0, 0.4);
        }
        
        .store-filter-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.06);
            margin: 6px 12px;
        }

        /* Modern Cash Ending Interface - Unified Row Layout */
        .cash-ending-container {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 
                0 0 0 1px rgba(0, 0, 0, 0.02),
                0 2px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: var(--space-6);
        }

        /* Modern Typography - Inter/SF Pro System */
        * {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', 'SF Pro Display', system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Cash Ending Button Container */
        .cash-ending-button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 24px 0;
            margin-top: -12px;
            margin-bottom: 12px;
        }

        .cash-ending-btn {
            background: var(--toss-primary);
            color: var(--toss-white);
            border: none;
            border-radius: 12px;
            padding: 14px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 200ms ease;
            box-shadow: 0 4px 12px rgba(0, 100, 255, 0.2);
        }

        .cash-ending-btn:hover {
            background: var(--toss-primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 100, 255, 0.3);
        }

        .cash-ending-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 100, 255, 0.2);
        }

        /* Unified Table Layout */
        .cash-comparison-unified {
            margin-bottom: 24px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid var(--toss-border-light);
            background: var(--toss-white);
        }

        /* Balance Section (Left) */
        .balance-section {
            background: var(--toss-white);
            position: relative;
        }

        .section-header {
            background: var(--toss-primary);
            color: var(--toss-text-inverse);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .balance-section .section-header {
            background: #4E7EFF; /* Toss-style soft blue */
        }

        .section-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            letter-spacing: -0.01em;
        }

        .section-subtitle {
            font-size: 13px;
            opacity: 0.9;
            margin: 2px 0 0 0;
            font-weight: 400;
        }

        /* Actual Section (Right) */
        .actual-section {
            background: var(--toss-white);
            position: relative;
            border-left: 1px solid var(--toss-border-light);
        }

        .actual-section .section-header {
            background: #6B94FF; /* Lighter Toss-style blue */
        }

        /* Two Column Header Styles */
        .comparison-headers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--toss-border-light);
        }
        .header-balance,
        .header-actual {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 600;
            color: var(--toss-text-inverse);
            position: relative;
        }
        .header-balance {
            background: #4E7EFF; /* Toss-style soft blue for balance */
            justify-content: flex-start;
        }
        .header-actual {
            background: #6B94FF; /* Lighter Toss-style blue for actual */
            justify-content: flex-start;
        }
        .header-icon {
            width: 20px;
            height: 20px;
            color: var(--toss-text-inverse);
            flex-shrink: 0;
        }
        
        /* SVG icon adjustments for section headers */
        .header-icon svg,
        .section-icon svg {
            width: 100%;
            height: 100%;
            display: block;
        }
        
        /* Ensure proper text color for difference section with light background */
        .difference-header .section-icon {
            color: #4E7EFF; /* Match Toss blue for consistency */
        }
        
        .difference-header .difference-title {
            color: #333D4B;
            font-weight: 600;
        }
        
        .difference-header .difference-subtitle {
            color: #8B95A1;
        }
        
        /* Add subtle hover effects for interactive elements */
        .header-balance:hover,
        .header-actual:hover {
            opacity: 0.95;
            transition: opacity 0.3s ease;
        }
        
        /* Ensure row sections have proper hover states */
        .row-balance:hover,
        .row-actual:hover {
            background: #F8F9FB; /* Very light gray for hover */
            transition: background 0.3s ease;
        }
        .header-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: var(--toss-text-inverse);
            line-height: 1.2;
        }
        .header-subtitle {
            font-size: 12px;
            margin: 2px 0 0 0;
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.2;
            font-weight: 400;
        }

        /* Row-based Content Styles */
        .comparison-rows {
            background: var(--toss-white);
        }
        
        /* Location Row - spans both balance and actual */
        .location-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--toss-border-light);
            border-bottom: 1px solid var(--toss-border-light);
        }
        .location-row:last-child {
            border-bottom: none;
        }
        
        /* Balance and Actual sides of each row */
        .row-balance,
        .row-actual {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--toss-white);
            min-height: 72px;
        }
        .row-actual {
            cursor: pointer;
            transition: background 150ms ease;
        }
        /* Hover state now defined above with new colors */
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px; /* More rounded corners for Toss style */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
            transition: all 0.3s ease; /* Smooth transitions */
            position: relative;
            overflow: hidden;
        }
        
        /* SVG icon styling within card-icon */
        .card-icon svg {
            width: 24px;
            height: 24px;
            display: block;
            flex-shrink: 0;
        }
        .card-details {
            flex: 1;
            min-width: 0;
        }
        .card-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--toss-text-primary);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .card-subtitle {
            font-size: 11px;
            color: var(--toss-text-tertiary);
            margin: 2px 0 0 0;
        }
        .card-amount-wrapper {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .card-amount {
            font-size: 16px;
            font-weight: 600;
            color: var(--toss-text-primary);
            text-align: right;
        }
        .card-status {
            font-size: 11px;
            color: var(--toss-text-secondary);
            text-align: right;
            margin-top: 2px;
        }
        .amount-placeholder {
            color: var(--toss-text-tertiary);
            font-style: italic;
        }
        .status-tag {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            background: var(--toss-gray-200);
            color: var(--toss-text-secondary);
            text-transform: uppercase;
            font-weight: 500;
            margin-top: 4px;
            display: inline-block;
        }
        .status-tag.actual {
            background: rgba(0, 200, 150, 0.1);
            color: var(--toss-success);
        }
        .status-tag.not-set {
            background: var(--toss-gray-100);
            color: var(--toss-text-tertiary);
        }
        .location-info .location-type {
            font-size: 12px;
            margin: 0;
            color: var(--toss-text-secondary);
        }
        .balance-amount .amount-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--toss-text-primary);
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
        }
        .actual-amount .amount-value {
            font-size: 16px;
            font-weight: 600;
            color: var(--toss-text-primary);
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
        }
        .actual-amount .not-set {
            font-size: 14px;
            font-weight: 500;
            color: var(--toss-text-tertiary);
        }
        .actual-amount .last-updated {
            font-size: 10px;
            color: var(--toss-text-secondary);
            margin-top: 2px;
        }

        /* Location Cards */
        .location-cards {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .location-card {
            background: var(--toss-white);
            padding: 16px 20px;
            border-bottom: 1px solid var(--toss-border-light);
            transition: background-color 150ms ease;
        }

        .location-card:last-child {
            border-bottom: none;
        }

        .location-card:hover {
            background: var(--toss-gray-50);
        }

        .card-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        /* Secondary card-icon definition - merged with primary */
        
        /* Removed hardcoded backgrounds - now using dynamic colors from getIconBackground() */

        .card-details {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .card-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--toss-text-primary);
            margin: 0;
            line-height: 1.3;
        }

        .card-type {
            font-size: 13px;
            color: var(--toss-text-secondary);
            margin: 0;
            font-weight: 400;
        }

        .card-amount {
            font-size: 16px;
            font-weight: 600;
            color: var(--toss-primary);
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
        }

        /* Actual Amount Input Styling */
        .actual-card {
            background: var(--toss-white);
            padding: 16px 20px;
            border-bottom: 1px solid var(--toss-border-light);
            transition: background-color 150ms ease;
        }

        .actual-card:last-child {
            border-bottom: none;
        }

        .actual-card.not-set {
            background: var(--toss-gray-50);
        }

        .actual-card:hover {
            background: var(--toss-gray-50);
        }

        .actual-amount-input-field {
            background: transparent;
            border: none;
            color: var(--toss-text-primary);
            font-size: 16px;
            font-weight: 600;
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
            text-align: right;
            outline: none;
            width: 120px;
            -moz-appearance: textfield; /* Firefox */
        }

        /* Hide spinner arrows in Chrome, Safari, Edge */
        .actual-amount-input-field::-webkit-outer-spin-button,
        .actual-amount-input-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .actual-amount-input-field::placeholder {
            color: var(--toss-text-tertiary);
            font-style: italic;
            font-weight: 400;
        }

        .not-set-label {
            font-size: 12px;
            color: var(--toss-text-tertiary);
            font-style: normal;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 500;
        }

        /* Location Info */
        .location-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .location-icon {
            width: 36px;
            height: 36px;
            background: var(--toss-gray-50); /* Flat color, no gradient for Toss style */
            border-radius: 12px; /* More rounded for Toss style */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .location-icon svg {
            width: 20px;
            height: 20px;
            display: block;
        }

        .location-details {
            flex: 1;
        }

        .location-name {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin: 0 0 2px 0;
            line-height: 1.3;
        }

        .location-type {
            font-size: 13px;
            color: #6b7280;
            margin: 0;
            font-weight: 400;
        }

        /* Balance Amount */
        .balance-amount {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
            text-align: right;
        }

        /* Actual Amount Display & Entry Button */
        .actual-amount-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .actual-amount-display {
            font-size: 18px;
            font-weight: 700;
            color: #059669;
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
            text-align: right;
        }

        .actual-amount-display.pending {
            color: #9ca3af;
            font-style: italic;
        }

        .enter-amount-btn {
            background: rgba(5, 150, 105, 0.08);
            color: #059669;
            border: 1px solid rgba(5, 150, 105, 0.2);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 150ms ease;
        }

        .enter-amount-btn:hover {
            background: rgba(5, 150, 105, 0.12);
            border-color: rgba(5, 150, 105, 0.3);
            transform: translateY(-1px);
        }

        .enter-amount-btn.pending {
            background: rgba(245, 158, 11, 0.08);
            color: #d97706;
            border-color: rgba(245, 158, 11, 0.2);
        }

        .enter-amount-btn.pending:hover {
            background: rgba(245, 158, 11, 0.12);
            border-color: rgba(245, 158, 11, 0.3);
        }

        /* Action Buttons for Unified Rows */
        .action-buttons {
            display: flex;
            gap: 6px;
            margin-top: 6px;
            justify-content: center;
        }

        .action-btn {
            background: rgba(0, 100, 255, 0.08);
            color: var(--toss-primary);
            border: 1px solid rgba(0, 100, 255, 0.2);
            border-radius: 4px;
            padding: 3px 6px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 150ms ease;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .action-btn:hover {
            background: rgba(0, 100, 255, 0.12);
            border-color: rgba(0, 100, 255, 0.3);
            transform: translateY(-1px);
        }

        .action-btn-danger {
            background: rgba(255, 88, 71, 0.08);
            color: var(--toss-error);
            border-color: rgba(255, 88, 71, 0.2);
        }

        .action-btn-danger:hover {
            background: rgba(255, 88, 71, 0.12);
            border-color: rgba(255, 88, 71, 0.3);
        }

        /* Difference Display */
        .difference-display {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 6px;
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
            text-align: center;
            min-width: 80px;
        }

        .difference-positive {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .difference-negative {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        .difference-zero {
            background: rgba(107, 114, 128, 0.08);
            color: #6b7280;
        }

        /* Difference Section */
        .difference-section {
            background: var(--toss-white);
            border-radius: 12px;
            margin-bottom: 24px;
            border: 1px solid var(--toss-border-light);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .difference-header {
            background: #F5F7FA; /* Toss-style light gray background */
            color: #333D4B; /* Dark text for contrast */
            color: var(--toss-text-primary);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .difference-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--toss-text-primary);
            margin: 0;
        }

        .difference-subtitle {
            font-size: 13px;
            color: var(--toss-text-secondary);
            margin: 2px 0 0 0;
            font-weight: 400;
        }

        .difference-items {
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        .difference-item {
            background: var(--toss-white);
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--toss-border-light);
        }

        .difference-item:last-child {
            border-bottom: none;
        }

        .difference-location-name {
            font-size: 15px;
            font-weight: 600;
            color: var(--toss-text-primary);
        }

        .difference-amount-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .difference-amount {
            font-size: 16px;
            font-weight: 700;
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
            min-width: 80px;
            text-align: right;
        }

        .difference-amount.positive {
            color: var(--toss-profit);
        }

        .difference-amount.negative {
            color: var(--toss-loss);
        }

        .difference-amount.zero {
            color: var(--toss-neutral);
        }

        /* Action Buttons - Simplified */
        .action-buttons-simple {
            display: flex;
            gap: 8px;
        }

        .action-btn-simple {
            background: var(--toss-white);
            border: 1px solid var(--toss-border);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 150ms ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn-simple:hover:not(:disabled) {
            background: var(--toss-surface-hover);
            border-color: var(--toss-border-dark);
            transform: translateY(-1px);
        }

        .action-btn-simple:disabled,
        .action-btn-simple.disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
            background: var(--toss-gray-100);
            color: var(--toss-text-disabled);
            border-color: var(--toss-border-light);
        }

        .error-btn-simple {
            color: var(--toss-error);
            border-color: var(--toss-error);
            background: var(--toss-white);
        }
        
        .error-btn-simple:disabled,
        .error-btn-simple.disabled {
            color: var(--toss-text-disabled);
            border-color: var(--toss-border-light);
        }

        .error-btn-simple:hover:not(:disabled) {
            background: var(--toss-error-light);
        }

        .exchange-btn-simple {
            color: var(--toss-info);
            border-color: var(--toss-info);
            background: var(--toss-white);
        }
        
        .exchange-btn-simple:disabled,
        .exchange-btn-simple.disabled {
            color: var(--toss-text-disabled);
            border-color: var(--toss-border-light);
        }

        .exchange-btn-simple:hover:not(:disabled) {
            background: var(--toss-info-light);
        }

        /* Cash Locations List in Modal */
        .cash-locations-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 8px 0;
        }
        
        /* Modal Overlay Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .location-input-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--toss-gray-50);
            border-radius: 12px;
            border: 1px solid var(--toss-border-light);
        }

        .location-info-modal {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .location-icon-modal {
            width: 40px;
            height: 40px;
            border-radius: 12px; /* More rounded for Toss style */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            transition: all 0.3s ease;
        }
        
        .location-icon-modal svg {
            width: 22px;
            height: 22px;
            display: block;
        }

        .location-name-modal {
            font-size: 15px;
            font-weight: 600;
            color: var(--toss-text-primary);
        }

        .location-type-modal {
            font-size: 13px;
            color: var(--toss-text-secondary);
            margin-top: 2px;
        }

        .location-input-group {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .location-input-group label {
            font-size: 12px;
            color: var(--toss-text-secondary);
            font-weight: 500;
        }

        .modal-input-field {
            width: 200px;
            padding: 10px 12px;
            border: 1px solid var(--toss-border);
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            text-align: right;
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
        }

        .modal-input-field:focus {
            outline: none;
            border-color: var(--toss-primary);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }

        /* Remove spinner arrows from modal-input-field number inputs */
        .modal-input-field::-webkit-outer-spin-button,
        .modal-input-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        .modal-input-field[type="number"] {
            -moz-appearance: textfield;
        }

        /* Modal Select Styles */
        .modal-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--toss-border);
            border-radius: var(--radius-input);
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-select:hover {
            border-color: var(--toss-primary);
        }

        .modal-select:focus {
            outline: none;
            border-color: var(--toss-primary);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }

        /* Compact Toss-style Dropdown for Web */
        .toss-dropdown {
            position: relative;
            width: 100%;
        }

        .toss-dropdown-trigger {
            width: 100%;
            padding: 12px 40px 12px 14px;
            border: 1px solid #E5E8EB;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 48px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            font-size: 15px;
        }

        .toss-dropdown-trigger:hover {
            border-color: #4E7EFF;
            background: #FAFBFC;
        }

        .toss-dropdown-trigger.active {
            border-color: #4E7EFF;
            box-shadow: 0 0 0 3px rgba(78, 126, 255, 0.1);
        }

        .toss-dropdown-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 16px;
        }

        .toss-dropdown-text {
            flex: 1;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toss-dropdown-value {
            font-size: 15px;
            font-weight: 500;
            color: #333D4B;
        }

        .toss-dropdown-label {
            font-size: 10px;
            color: #8B95A1;
            padding: 2px 6px;
            background: #F5F7FA;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .toss-dropdown-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.2s ease;
            color: #8B95A1;
        }

        .toss-dropdown-trigger.active .toss-dropdown-arrow {
            transform: translateY(-50%) rotate(180deg);
            color: #4E7EFF;
        }

        /* Dropdown Menu */
        .toss-dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #E5E8EB;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            z-index: 1000;
            max-height: 260px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s ease;
        }

        .toss-dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .toss-dropdown-item {
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.15s ease;
            border-bottom: 1px solid #F5F7FA;
            position: relative;
        }

        .toss-dropdown-item:last-child {
            border-bottom: none;
        }

        .toss-dropdown-item:hover {
            background: #F8F9FB;
        }

        .toss-dropdown-item.selected {
            background: #EFF4FF;
        }

        .toss-dropdown-item.selected::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #4E7EFF;
        }

        .toss-dropdown-item-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .toss-dropdown-item-text {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toss-dropdown-item-name {
            font-size: 14px;
            font-weight: 500;
            color: #333D4B;
        }

        .toss-dropdown-item-type {
            font-size: 10px;
            color: #8B95A1;
            padding: 2px 6px;
            background: #F5F7FA;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .toss-dropdown-check {
            width: 16px;
            height: 16px;
            color: #4E7EFF;
            display: none;
            flex-shrink: 0;
        }

        .toss-dropdown-item.selected .toss-dropdown-check {
            display: block;
        }

        /* Simple backdrop for dropdown */
        .toss-dropdown-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 999;
            display: none;
        }

        .toss-dropdown-backdrop.show {
            display: block;
        }

        /* Scrollbar styling for dropdown menu */
        .toss-dropdown-menu::-webkit-scrollbar {
            width: 6px;
        }
        
        .toss-dropdown-menu::-webkit-scrollbar-track {
            background: #F5F7FA;
            border-radius: 3px;
        }
        
        .toss-dropdown-menu::-webkit-scrollbar-thumb {
            background: #D1D6DB;
            border-radius: 3px;
        }
        
        .toss-dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: #8B95A1;
        }

        /* Currency Section Styles */
        .currency-section {
            margin-bottom: 24px;
            padding: 16px;
            background: var(--toss-gray-50);
            border-radius: var(--radius-card);
        }

        .currency-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--toss-border);
        }

        .currency-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--toss-primary);
            color: white;
            border-radius: 8px;
            font-size: 18px;
        }

        .currency-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--toss-text-primary);
        }

        .denomination-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 8px;
            background: white;
            border-radius: 8px;
        }

        .denomination-label {
            flex: 1;
            font-size: 16px;
            font-weight: 500;
            color: var(--toss-text-primary);
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
        }

        .denomination-input {
            width: 120px;
            padding: 8px 12px;
            border: 1px solid var(--toss-border);
            border-radius: 6px;
            font-size: 14px;
            text-align: right;
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
            -moz-appearance: textfield; /* Firefox */
        }
        
        /* Remove spinner arrows from number inputs */
        .denomination-input::-webkit-outer-spin-button,
        .denomination-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .denomination-input:focus {
            outline: none;
            border-color: var(--toss-primary);
        }

        .denomination-unit {
            min-width: 60px;
            font-size: 14px;
            color: var(--toss-text-secondary);
        }

        .denomination-subtotal {
            min-width: 120px;
            text-align: right;
            font-size: 14px;
            font-weight: 600;
            color: var(--toss-text-primary);
            font-feature-settings: 'tnum';
            font-variant-numeric: tabular-nums;
        }

        /* Modal System for Cash Entry */
        .cash-entry-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 250ms cubic-bezier(0.16, 1, 0.3, 1);
        }

        .cash-entry-modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            width: 95%;
            max-width: 900px;
            height: 85vh;
            max-height: 750px;
            min-height: 600px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transform: scale(0.95) translateY(20px);
            transition: all 250ms cubic-bezier(0.16, 1, 0.3, 1);
        }

        .cash-entry-modal.active .modal-content {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            padding: 28px 32px 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 150ms ease;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #374151;
        }

        .modal-body {
            padding: 32px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        /* Custom scrollbar for modal body */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-body::-webkit-scrollbar-track {
            background: #F5F7FA;
            border-radius: 4px;
        }
        
        .modal-body::-webkit-scrollbar-thumb {
            background: #D1D6DB;
            border-radius: 4px;
        }
        
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #8B95A1;
        }

        /* Cash Register Denomination Interface */
        .denomination-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }

        .denomination-section {
            background: #f9fafb;
            border-radius: 12px;
            padding: 16px;
        }

        .denomination-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            text-align: center;
        }

        .denomination-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .denomination-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .denomination-input {
            width: 60px;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }

        .denomination-value {
            font-size: 12px;
            color: #6b7280;
            min-width: 60px;
            text-align: right;
        }

        /* Vault Bulk Counting Interface */
        .bulk-counting-grid {
            display: grid;
            gap: 16px;
            margin-bottom: 24px;
        }

        .bulk-item {
            background: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .bulk-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .bulk-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
        }

        .bulk-subtitle {
            font-size: 12px;
            color: #6b7280;
        }

        .bulk-input {
            width: 100px;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            text-align: right;
            font-size: 16px;
            font-weight: 600;
        }

        /* Bank Entry Interface */
        .bank-entry-form {
            display: grid;
            gap: 16px;
            margin-bottom: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: all 150ms ease;
        }

        .form-input:focus {
            border-color: #059669;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.08);
            outline: none;
        }

        /* Modal Footer */
        .modal-footer {
            padding: 24px 32px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 1px solid var(--toss-border-light);
            background: var(--toss-background);
            flex-shrink: 0;
        }

        .modal-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 150ms ease;
            border: none;
        }

        /* Toss Style Buttons */
        .modal-btn-primary {
            padding: 0 24px;
            height: 48px;
            background: var(--toss-primary);
            color: white;
            border: none;
            border-radius: var(--radius-button);
            font-size: 15px;
            font-weight: var(--font-semibold);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 88px;
        }

        .modal-btn-primary:hover {
            background: var(--toss-primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 100, 255, 0.2);
        }

        .modal-btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(0, 100, 255, 0.15);
        }

        .modal-btn-primary:disabled {
            background: var(--toss-gray-400);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .modal-btn-secondary {
            padding: 0 24px;
            height: 48px;
            background: var(--toss-white);
            color: var(--toss-text-primary);
            border: 1px solid var(--toss-border);
            border-radius: var(--radius-button);
            font-size: 15px;
            font-weight: var(--font-medium);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-width: 88px;
        }

        .modal-btn-secondary:hover {
            background: var(--toss-gray-50);
            border-color: var(--toss-border-dark);
        }

        .modal-btn-secondary:active {
            background: var(--toss-gray-100);
        }

        .total-display {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 20px;
        }

        .total-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .total-amount {
            font-size: 24px;
            font-weight: 700;
            font-feature-settings: 'tnum';
        }



        /* Mobile Responsive - Split Screen */
        @media (max-width: 768px) {
            .page-content {
                padding: var(--space-3);
            }
            
            .controls-card {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .control-section {
                max-width: none;
                width: 100%;
                min-width: unset;
            }
            
            .store-filter-dropdown {
                left: 0;
                right: 0;
                width: 100%;
                max-width: none;
                border-radius: 12px;
            }
            
            .store-filter-dropdown-option {
                padding: 14px 16px;
                font-size: 16px;
            }

            /* Split Screen Mobile */
            .cash-comparison-split {
                grid-template-columns: 1fr;
                gap: 1px;
            }

            .balance-section,
            .actual-section {
                padding: 20px 16px;
            }

            .section-title {
                font-size: 18px;
            }

            .location-cards {
                gap: 10px;
            }

            .location-card,
            .actual-card {
                padding: 14px;
            }

            .card-icon {
                width: 28px;
                height: 28px;
                font-size: 14px;
            }
            
            .card-icon svg {
                width: 16px;
                height: 16px;
            }

            .card-name {
                font-size: 13px;
            }

            .card-amount,
            .actual-amount-input-field {
                font-size: 16px;
            }

            .difference-section {
                padding: 20px 16px;
            }

            .difference-item {
                padding: 14px;
                flex-direction: column;
                gap: 8px;
                align-items: flex-start;
            }

            .difference-amount-actions {
                width: 100%;
                justify-content: space-between;
            }

            .action-buttons-simple {
                gap: 6px;
            }

            .action-btn-simple {
                font-size: 11px;
                padding: 6px 8px;
            }
        }

        @media (max-width: 480px) {
            .cash-ending-title {
                font-size: 20px;
            }

            .cash-location-row {
                padding: 12px;
            }

            .location-icon {
                width: 32px;
                height: 32px;
            }
            
            .location-icon svg {
                width: 18px;
                height: 18px;
            }

            .location-name {
                font-size: 15px;
            }

            .balance-amount,
            .actual-amount-display {
                font-size: 16px;
            }
            
            .enter-amount-btn {
                font-size: 10px;
                padding: 6px 10px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 4px;
            }
            
            .action-btn {
                font-size: 11px;
                min-width: 60px;
                padding: 6px 8px;
            }
        }
    </style>
</head>

<body>
    <div class="page-container">
        <!-- Navigation Bar -->
        <div id="navbar-container"></div>
        
        <!-- Main Content -->
        <main class="page-content">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Cash Ending</h1>
                <p class="page-subtitle">Manage daily cash ending processes and records</p>
            </div>
            
            <!-- Store Filter Controls -->
            <div class="controls-card">
                <div class="control-section" id="storeFilterControl">
                    <div class="filter-indicator" id="storeFilterIndicator">
                        <svg class="control-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75Z"/>
                        </svg>
                    </div>
                    <span class="control-label" id="storeFilterLabel">All Stores</span>
                    <svg class="control-dropdown" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                    </svg>
                    
                    <!-- Store Filter Dropdown -->
                    <div class="store-filter-dropdown" id="storeFilterDropdown">
                        <div id="storeFilterOptions">
                            <!-- Store filter options will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Cash Ending Main Interface -->
            <div class="cash-ending-container">
                <!-- Two Column Layout -->
                <div class="cash-comparison-split">
                    <!-- Headers -->
                    <div class="comparison-headers">
                        <div class="header-balance">
                            <!-- Toss-style bar chart icon -->
                            <svg class="header-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="12" width="4" height="9" rx="1" fill="white"/>
                                <rect x="10" y="8" width="4" height="13" rx="1" fill="white"/>
                                <rect x="17" y="4" width="4" height="17" rx="1" fill="white"/>
                            </svg>
                            <div>
                                <div class="header-title">Balance</div>
                                <div class="header-subtitle">Based on Balance Sheet</div>
                            </div>
                        </div>
                        <div class="header-actual">
                            <!-- Toss-style plus icon -->
                            <svg class="header-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="11" y="5" width="2" height="14" rx="1" fill="white"/>
                                <rect x="5" y="11" width="14" height="2" rx="1" fill="white"/>
                            </svg>
                            <div>
                                <div class="header-title">Actual Cash</div>
                                <div class="header-subtitle">Cash ending input for today</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Content Rows -->
                    <div class="comparison-rows">
                        <!-- Location rows will be loaded here -->
                    </div>
                </div>
                
                <!-- Cash Ending Button -->
                <div class="cash-ending-button-container">
                    <button class="cash-ending-btn" onclick="openCashEndingModal()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,7V11H7V13H11V17H13V13H17V11H13V7H11Z"/>
                        </svg>
                        Cash Ending
                    </button>
                    <button class="cash-ending-btn" onclick="openAddCashLocationModal()" style="background: var(--toss-success);">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75M17,18H7V17C7,15.34 11,14.5 12,14.5C13,14.5 17,15.34 17,17V18Z"/>
                        </svg>
                        Add Cash Location
                    </button>
                </div>
                
                <!-- Difference Section -->
                <div class="difference-section">
                    <div class="difference-header">
                        <!-- Toss-style comparison/difference icon -->
                        <svg class="section-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="4" y="6" width="7" height="2" rx="1" fill="currentColor"/>
                            <rect x="4" y="11" width="7" height="2" rx="1" fill="currentColor"/>
                            <rect x="4" y="16" width="7" height="2" rx="1" fill="currentColor"/>
                            <rect x="13" y="6" width="7" height="2" rx="1" fill="currentColor"/>
                            <rect x="13" y="11" width="5" height="2" rx="1" fill="currentColor"/>
                            <rect x="13" y="16" width="6" height="2" rx="1" fill="currentColor"/>
                        </svg>
                        <div>
                            <h3 class="difference-title">Difference</h3>
                            <p class="difference-subtitle">Difference Between Balance & Actual</p>
                        </div>
                    </div>
                    
                    <div class="difference-items">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>

            </div>
            
            <!-- Cash Entry Modals -->
            
            <!-- Main Cash Ending Modal -->
            <div class="cash-entry-modal" id="mainCashEndingModal">
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <div class="modal-title">
                            <span></span>
                            <span>Cash Ending Input</span>
                        </div>
                        <button class="modal-close" onclick="closeCashEndingModal()"></button>
                    </div>
                    <div class="modal-body">
                        <!-- Step 1: Store Selection -->
                        <div class="modal-store-selector">
                            <label style="display: block; margin-bottom: 10px; font-weight: 500; font-size: 15px;">Select Store</label>
                            
                            <!-- Toss-style Store Dropdown -->
                            <div class="toss-dropdown" id="storeDropdown">
                                <div class="toss-dropdown-trigger" onclick="toggleStoreDropdown()">
                                    <div class="toss-dropdown-icon" id="selectedStoreIcon" style="background: linear-gradient(135deg, #F5F7FA 0%, #E5E8EB 100%);">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                            <rect x="3" y="7" width="18" height="14" rx="2" stroke="#8B95A1" stroke-width="2"/>
                                            <path d="M3 10H21" stroke="#8B95A1" stroke-width="2"/>
                                            <path d="M8 3L12 7L16 3" stroke="#8B95A1" stroke-width="2" stroke-linecap="round"/>
                                        </svg>
                                    </div>
                                    <div class="toss-dropdown-text">
                                        <div class="toss-dropdown-value" id="selectedStoreName" style="color: #8B95A1;">All Stores</div>
                                        <div class="toss-dropdown-label" id="selectedStoreType">STORE</div>
                                    </div>
                                    <svg class="toss-dropdown-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                        <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="toss-dropdown-backdrop" onclick="closeStoreDropdown()"></div>
                                <div class="toss-dropdown-menu" id="storeDropdownMenu">
                                    <!-- Options will be loaded dynamically -->
                                </div>
                            </div>
                            
                            <!-- Hidden select for form submission -->
                            <select id="modalStoreSelect" style="display: none;" onchange="onModalStoreChange()">
                                <option value="">All Stores</option>
                                <!-- Stores will be loaded dynamically -->
                            </select>
                        </div>

                        <!-- Step 2: Location Selection -->
                        <div class="modal-location-selector" style="display: none; margin-top: 24px;">
                            <label style="display: block; margin-bottom: 10px; font-weight: 500; font-size: 15px;">Select Cash Location</label>
                            
                            <!-- Toss-style Location Dropdown -->
                            <div class="toss-dropdown" id="locationDropdown">
                                <div class="toss-dropdown-trigger" onclick="toggleLocationDropdown()">
                                    <div class="toss-dropdown-icon" id="selectedLocationIcon" style="background: linear-gradient(135deg, #F5F7FA 0%, #E5E8EB 100%);">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                            <rect x="4" y="4" width="16" height="16" rx="3" stroke="#8B95A1" stroke-width="2"/>
                                            <path d="M9 12L11 14L15 10" stroke="#8B95A1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                    <div class="toss-dropdown-text">
                                        <div class="toss-dropdown-value" id="selectedLocationName" style="color: #8B95A1;">Select a location</div>
                                        <div class="toss-dropdown-label" id="selectedLocationType">LOCATION</div>
                                    </div>
                                    <svg class="toss-dropdown-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none">
                                        <path d="M6 9L12 15L18 9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="toss-dropdown-backdrop" onclick="closeLocationDropdown()"></div>
                                <div class="toss-dropdown-menu" id="locationDropdownMenu">
                                    <!-- Options will be loaded dynamically -->
                                </div>
                            </div>
                            
                            <!-- Hidden select for form submission -->
                            <select id="modalLocationSelect" style="display: none;" onchange="onModalLocationChange()">
                                <option value="">Select a location</option>
                                <!-- Locations will be loaded dynamically -->
                            </select>
                        </div>

                        <!-- Step 3A: Cash Count Entry (for cash type) -->
                        <div id="cashCountEntry" class="cash-count-section" style="display: none; margin-top: 20px;">
                            <h3 style="margin-bottom: 16px;"> Cash Count Entry</h3>
                            <div id="currencySections">
                                <!-- Currency denominations will be loaded dynamically -->
                            </div>
                            <div class="total-section" style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--toss-border);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 18px; font-weight: 600;">Total Amount:</span>
                                    <span id="modalTotalAmount" style="font-size: 24px; font-weight: 700; color: var(--toss-primary);">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Step 3B: Simple Input (for non-cash types) -->
                        <div id="simpleAmountEntry" class="simple-amount-section" style="display: none; margin-top: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">Enter Amount</label>
                            <input type="number" id="simpleAmountInput" class="modal-input-field" placeholder="Enter amount" style="width: 100%; padding: 12px; font-size: 16px;">
                        </div>
                        
                        <!-- Step 3C: Bank Currency + Amount Input -->
                        <div id="bankAmountEntry" class="bank-amount-section" style="display: none; margin-top: 20px;">
                            <div class="currency-amount-form">
                                <div class="form-group" style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--toss-text-primary);">Select Currency:</label>
                                    <select id="bankCurrencySelect" class="modal-select-field" style="width: 100%; padding: 12px; border: 1px solid var(--toss-border); border-radius: 8px; font-size: 16px; background: white;" onchange="onBankCurrencyChange()">
                                        <option value="">Select Currency...</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 16px;">
                                    <label style="display: block; margin-bottom: 8px; font-weight: 500; color: var(--toss-text-primary);">Enter Amount:</label>
                                    <div class="amount-input-wrapper" style="position: relative; display: flex; align-items: center;">
                                        <span id="bankCurrencySymbol" class="currency-symbol" style="position: absolute; left: 12px; font-weight: 600; color: var(--toss-text-secondary); z-index: 1;"></span>
                                        <input type="number" id="bankAmountInput" class="modal-input-field" placeholder="" 
                                               style="width: 100%; padding: 12px 12px 12px 40px; font-size: 16px; text-align: right; border: 1px solid var(--toss-border); border-radius: 8px;"
                                               oninput="updateBankTotal()">
                                    </div>
                                </div>
                                <div class="form-helper-text" style="font-size: 14px; color: var(--toss-text-secondary);">
                                    Enter the total amount for this location
                                </div>
                            </div>
                        </div>

                        <!-- Original List View (hidden by default) -->
                        <div class="cash-locations-list" style="display: none;">
                            <!-- Dynamic content will be loaded here -->
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn-secondary" onclick="closeCashEndingModal()">
                            Cancel
                        </button>
                        <button class="modal-btn-primary" id="modalSaveBtn" onclick="saveModalCashAmount()">
                            Save
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Cash Register Modal (Denomination Counting) -->
            <div class="cash-entry-modal" id="cashModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">
                            <span id="cashModalIcon"></span>
                            <span id="cashModalTitle">Count Cash Register</span>
                        </div>
                        <button class="modal-close" onclick="closeCashModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="denomination-grid">
                            <div class="denomination-section">
                                <div class="denomination-title">Bills</div>
                                <div class="denomination-item">
                                    <div class="denomination-label">$100</div>
                                    <input type="number" class="denomination-input" data-value="100" value="0">
                                    <div class="denomination-value">$0.00</div>
                                </div>
                                <div class="denomination-item">
                                    <div class="denomination-label">$50</div>
                                    <input type="number" class="denomination-input" data-value="50" value="0">
                                    <div class="denomination-value">$0.00</div>
                                </div>
                                <div class="denomination-item">
                                    <div class="denomination-label">$20</div>
                                    <input type="number" class="denomination-input" data-value="20" value="0">
                                    <div class="denomination-value">$0.00</div>
                                </div>
                                <div class="denomination-item">
                                    <div class="denomination-label">$10</div>
                                    <input type="number" class="denomination-input" data-value="10" value="0">
                                    <div class="denomination-value">$0.00</div>
                                </div>
                                <div class="denomination-item">
                                    <div class="denomination-label">$5</div>
                                    <input type="number" class="denomination-input" data-value="5" value="0">
                                    <div class="denomination-value">$0.00</div>
                                </div>
                                <div class="denomination-item">
                                    <div class="denomination-label">$1</div>
                                    <input type="number" class="denomination-input" data-value="1" value="0">
                                    <div class="denomination-value">$0.00</div>
                                </div>
                            </div>
                            
                            <div class="denomination-section">
                                <div class="denomination-title">Coins</div>
                                <div class="denomination-item">
                                    <div class="denomination-label">$1 Coin</div>
                                    <input type="number" class="denomination-input" data-value="1" value="0">
                                    <div class="denomination-value">$0.00</div>
                                </div>
                                <div class="denomination-item">
                                    <div class="denomination-label">50</div>
                                    <input type="number" class="denomination-input" data-value="0.50" value="0">
                                    <div class="denomination-value">$0.00</div>
                                </div>
                                <div class="denomination-item">
                                    <div class="denomination-label">25</div>
                                    <input type="number" class="denomination-input" data-value="0.25" value="0">
                                    <div class="denomination-value">$0.00</div>
                                </div>
                                <div class="denomination-item">
                                    <div class="denomination-label">10</div>
                                    <input type="number" class="denomination-input" data-value="0.10" value="0">
                                    <div class="denomination-value">$0.00</div>
                                </div>
                                <div class="denomination-item">
                                    <div class="denomination-label">5</div>
                                    <input type="number" class="denomination-input" data-value="0.05" value="0">
                                    <div class="denomination-value">$0.00</div>
                                </div>
                                <div class="denomination-item">
                                    <div class="denomination-label">1</div>
                                    <input type="number" class="denomination-input" data-value="0.01" value="0">
                                    <div class="denomination-value">$0.00</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="total-display">
                            <div class="total-label">Total Count</div>
                            <div class="total-amount" id="cashTotal">$0.00</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn modal-btn-secondary" onclick="closeCashModal()">Cancel</button>
                        <button class="modal-btn modal-btn-primary" onclick="saveCashCount()">Save Count</button>
                    </div>
                </div>
            </div>

            <!-- Vault Modal (Bulk Counting) -->
            <div class="cash-entry-modal" id="vaultModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">
                            <span id="vaultModalIcon"></span>
                            <span id="vaultModalTitle">Count Vault Storage</span>
                        </div>
                        <button class="modal-close" onclick="closeVaultModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="bulk-counting-grid">
                            <div class="bulk-item">
                                <div class="bulk-info">
                                    <div class="bulk-title">Large Bills Bundle</div>
                                    <div class="bulk-subtitle">$50, $100 bills in bundles</div>
                                </div>
                                <input type="number" class="bulk-input" data-type="large" placeholder="0.00">
                            </div>
                            
                            <div class="bulk-item">
                                <div class="bulk-info">
                                    <div class="bulk-title">Small Bills Bundle</div>
                                    <div class="bulk-subtitle">$1, $5, $10, $20 bills</div>
                                </div>
                                <input type="number" class="bulk-input" data-type="small" placeholder="0.00">
                            </div>
                            
                            <div class="bulk-item">
                                <div class="bulk-info">
                                    <div class="bulk-title">Coin Rolls</div>
                                    <div class="bulk-subtitle">Rolled coins total value</div>
                                </div>
                                <input type="number" class="bulk-input" data-type="coins" placeholder="0.00">
                            </div>
                            
                            <div class="bulk-item">
                                <div class="bulk-info">
                                    <div class="bulk-title">Loose Cash</div>
                                    <div class="bulk-subtitle">Individual bills and coins</div>
                                </div>
                                <input type="number" class="bulk-input" data-type="loose" placeholder="0.00">
                            </div>
                        </div>
                        
                        <div class="total-display">
                            <div class="total-label">Total Vault Count</div>
                            <div class="total-amount" id="vaultTotal">$0.00</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn modal-btn-secondary" onclick="closeVaultModal()">Cancel</button>
                        <button class="modal-btn modal-btn-primary" onclick="saveVaultCount()">Save Count</button>
                    </div>
                </div>
            </div>

            <!-- Bank Modal (Deposit/Transfer Entry) -->
            <div class="cash-entry-modal" id="bankModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <div class="modal-title">
                            <span id="bankModalIcon"></span>
                            <span id="bankModalTitle">Bank Transaction Entry</span>
                        </div>
                        <button class="modal-close" onclick="closeBankModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="bank-entry-form">
                            <div class="form-group">
                                <label class="form-label">Transaction Type</label>
                                <select class="form-input" id="bankTransactionType">
                                    <option value="deposit">Bank Deposit</option>
                                    <option value="withdrawal">Bank Withdrawal</option>
                                    <option value="transfer">Internal Transfer</option>
                                    <option value="adjustment">Balance Adjustment</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Amount</label>
                                <input type="number" step="0.01" class="form-input" id="bankAmount" placeholder="0.00">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Reference Number</label>
                                <input type="text" class="form-input" id="bankReference" placeholder="Check number, transaction ID, etc.">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Notes</label>
                                <input type="text" class="form-input" id="bankNotes" placeholder="Optional notes">
                            </div>
                        </div>
                        
                        <div class="total-display">
                            <div class="total-label">Transaction Amount</div>
                            <div class="total-amount" id="bankTotal">$0.00</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-btn modal-btn-secondary" onclick="closeBankModal()">Cancel</button>
                        <button class="modal-btn modal-btn-primary" onclick="saveBankTransaction()">Save Transaction</button>
                    </div>
                </div>
            </div>
            
            <!-- Make Error Confirmation Modal -->
            <div class="modal-overlay" id="makeErrorModal" style="display: none;">
                <div class="modal-container" style="max-width: 500px;">
                    <div class="modal-header" style="background: #4169E1; color: white; padding: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                    <path d="M1,21L12,2L23,21H1M12,6L19.53,19H4.47M11,10V14H13V10M11,16V18H13V16"/>
                                </svg>
                                <h2 style="margin: 0; font-size: 20px; font-weight: 600;">Make Error</h2>
                            </div>
                            <button onclick="closeMakeErrorModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;"></button>
                        </div>
                    </div>
                    <div class="modal-body" style="padding: 40px 30px; background: white; text-align: center;">
                        <div style="margin-bottom: 30px;">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="#FFA500" style="margin-bottom: 20px;">
                                <path d="M1,21L12,2L23,21H1M12,6L19.53,19H4.47M11,10V14H13V10M11,16V18H13V16"/>
                            </svg>
                            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #333;">
                                Are you sure you want to make an error entry for:
                            </h3>
                        </div>
                        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                            <div id="errorLocationName" style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px;"></div>
                            <div style="font-size: 14px; color: #666;">
                                Variance: <span id="errorVarianceAmount" style="font-size: 18px; font-weight: 600; color: #333;"></span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="padding: 20px 30px; background: #f8f9fa; display: flex; gap: 12px; justify-content: center;">
                        <button onclick="closeMakeErrorModal()" style="padding: 12px 32px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                            </svg>
                            Cancel
                        </button>
                        <button onclick="confirmMakeError()" style="padding: 12px 32px; background: #dc3545; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/>
                            </svg>
                            OK
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Foreign Currency Translation Confirmation Modal -->
            <div class="modal-overlay" id="exchangeRateModal" style="display: none;">
                <div class="modal-container" style="max-width: 500px;">
                    <div class="modal-header" style="background: #4169E1; color: white; padding: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                    <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4M11,17V16H9V14H13V13H10A1,1 0 0,1 9,12V9A1,1 0 0,1 10,8H11V7H13V8H15V10H11V11H14A1,1 0 0,1 15,12V15A1,1 0 0,1 14,16H13V17H11Z"/>
                                </svg>
                                <h2 style="margin: 0; font-size: 20px; font-weight: 600;">Foreign Currency Translation</h2>
                            </div>
                            <button onclick="closeExchangeRateModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;"></button>
                        </div>
                    </div>
                    <div class="modal-body" style="padding: 40px 30px; background: white; text-align: center;">
                        <div style="margin-bottom: 30px;">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="#FFA500" style="margin-bottom: 20px;">
                                <path d="M1,21L12,2L23,21H1M12,6L19.53,19H4.47M11,10V14H13V10M11,16V18H13V16"/>
                            </svg>
                            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #333;">
                                Are you sure you want to create an exchange rate difference entry for:
                            </h3>
                        </div>
                        <div style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                            <div id="exchangeLocationName" style="font-size: 16px; font-weight: 600; color: #333; margin-bottom: 8px;"></div>
                            <div style="font-size: 14px; color: #666;">
                                Variance: <span id="exchangeVarianceAmount" style="font-size: 18px; font-weight: 600; color: #333;"></span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer" style="padding: 20px 30px; background: #f8f9fa; display: flex; gap: 12px; justify-content: center;">
                        <button onclick="closeExchangeRateModal()" style="padding: 12px 32px; background: #6c757d; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                            </svg>
                            Cancel
                        </button>
                        <button onclick="confirmExchangeRate()" style="padding: 12px 32px; background: #dc3545; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="white">
                                <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/>
                            </svg>
                            OK
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Add Cash Location Modal -->
            <div class="toss-modal-overlay" id="addCashLocationModal">
                <div class="toss-modal toss-modal-sm">
                    <!-- Modal Header -->
                    <div class="toss-modal-header">
                        <div class="toss-modal-header-content">
                            <div class="toss-modal-icon primary">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75M17,18H7V17C7,15.34 11,14.5 12,14.5C13,14.5 17,15.34 17,17V18Z"/>
                                </svg>
                            </div>
                            <div>
                                <h2 class="toss-modal-title">Add Cash Location</h2>
                                <p class="toss-modal-subtitle">Create a new cash location for your store</p>
                            </div>
                        </div>
                        <button class="toss-modal-close" onclick="closeAddCashLocationModal()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Modal Body -->
                    <div class="toss-modal-body" style="padding: var(--space-8);">
                        <form id="addCashLocationForm">
                            <!-- Cash Location Name -->
                            <div class="toss-input-group" style="margin-bottom: var(--space-6);">
                                <label class="toss-input-label" style="margin-bottom: var(--space-2); display: block; font-weight: 600; color: var(--text-primary);">
                                    Cash Location Name <span style="color: var(--toss-error);">*</span>
                                </label>
                                <input 
                                    type="text" 
                                    id="cashLocationName" 
                                    class="toss-input toss-input-lg" 
                                    placeholder="Enter cash location name"
                                    style="width: 100%;"
                                    required
                                />
                            </div>
                            
                            <!-- Cash Location Type -->
                            <div class="toss-select-group" style="margin-bottom: var(--space-6);">
                                <label class="toss-select-label" style="margin-bottom: var(--space-2); display: block; font-weight: 600; color: var(--text-primary);">
                                    Location Type <span style="color: var(--toss-error);">*</span>
                                </label>
                                <select 
                                    id="cashLocationType" 
                                    class="toss-select toss-select-lg" 
                                    style="width: 100%; padding: 12px 16px; font-size: 16px; border: 1px solid var(--toss-border); border-radius: var(--radius-input); background: white;"
                                    required
                                >
                                    <option value="" disabled selected>Select location type</option>
                                    <option value="cash"> Cash</option>
                                    <option value="bank"> Bank</option>
                                    <option value="vault"> Vault</option>
                                </select>
                            </div>
                            
                            <!-- Location Type Cards (Alternative UI) -->
                            <div style="display: none; margin-bottom: var(--space-6);">
                                <label style="margin-bottom: var(--space-3); display: block; font-weight: 600; color: var(--text-primary);">
                                    Location Type <span style="color: var(--toss-error);">*</span>
                                </label>
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-3);">
                                    <div class="type-card" data-type="cash" style="padding: var(--space-4); border: 2px solid var(--toss-border); border-radius: var(--radius-lg); cursor: pointer; text-align: center; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: var(--space-2);"></div>
                                        <div style="font-weight: 600; color: var(--text-primary);">Cash</div>
                                    </div>
                                    <div class="type-card" data-type="bank" style="padding: var(--space-4); border: 2px solid var(--toss-border); border-radius: var(--radius-lg); cursor: pointer; text-align: center; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: var(--space-2);"></div>
                                        <div style="font-weight: 600; color: var(--text-primary);">Bank</div>
                                    </div>
                                    <div class="type-card" data-type="vault" style="padding: var(--space-4); border: 2px solid var(--toss-border); border-radius: var(--radius-lg); cursor: pointer; text-align: center; transition: all 0.2s;">
                                        <div style="font-size: 32px; margin-bottom: var(--space-2);"></div>
                                        <div style="font-weight: 600; color: var(--text-primary);">Vault</div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Modal Footer -->
                    <div class="toss-modal-footer">
                        <button class="toss-button toss-button-secondary toss-button-lg" onclick="closeAddCashLocationModal()">
                            Cancel
                        </button>
                        <button class="toss-button toss-button-primary toss-button-lg" onclick="addCashLocation()">
                            Add Location
                        </button>
                    </div>
                </div>
            </div>
            
        </main>
    </div>

    <!-- Component JavaScript -->
    <script src="../../../components/base/toss-button.js"></script>
    <script src="../../../components/form/toss-input.js"></script>
    <script src="../../../components/form/toss-select.js"></script>
    
    <!-- Set flag BEFORE loading navbar to prevent auto-init with wrong activeItem -->
    <script>
        // Prevent navbar auto-initialization - we'll initialize it with correct activeItem
        window.skipNavbarAutoInit = true;
    </script>
    
    <script src="../../../components/navigation/navbar.js"></script>
    <script src="../../../components/feedback/toss-alert.js"></script>
    
    <!-- Core Scripts -->
    <script src="../../../core/constants/app-icons.js"></script>
    <script src="../../../core/config/supabase.js"></script>
    <script src="../../../core/utils/app-state.js"></script>
    <script src="../../../core/config/route-mapping.js"></script>
    <script src="../../../core/utils/page-init.js"></script>

    <!-- Page Script -->
    <script>
        // Modal data storage
        let modalSelectedStore = null;
        let modalSelectedLocation = null;
        let companyCurrencies = [];
        let currencyTypes = [];
        let currencyDenominations = [];

        // Add Cash Location Modal Functions
        function openAddCashLocationModal() {
            const modal = document.getElementById('addCashLocationModal');
            if (modal) {
                modal.classList.add('show');
                document.body.style.overflow = 'hidden';
                
                // Reset form
                const form = document.getElementById('addCashLocationForm');
                if (form) {
                    form.reset();
                }
            }
        }
        
        function closeAddCashLocationModal() {
            const modal = document.getElementById('addCashLocationModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = '';
            }
        }
        
        function addCashLocation() {
            // This function will handle the actual adding of cash location
            // For now, just get the values and log them
            const name = document.getElementById('cashLocationName').value;
            const type = document.getElementById('cashLocationType').value;
            
            if (!name || !type) {
                alert('Please fill in all required fields');
                return;
            }
            
            console.log('Adding cash location:', {
                name: name,
                type: type
            });
            
            // TODO: Add the actual implementation to save to database
            
            // Close modal after adding
            closeAddCashLocationModal();
        }
        
        // Main Cash Ending Modal Functions
        async function openCashEndingModal() {
            // Ensure appState is properly initialized before opening modal
            if (!await ensureAppStateReady()) {
                console.error('Cannot open modal: appState not ready');
                if (typeof TossAlertUtils !== 'undefined') {
                    TossAlertUtils.showError('Please wait for the page to fully load and try again.');
                }
                return;
            }
            
            const modal = document.getElementById('mainCashEndingModal');
            if (modal) {
                modal.classList.add('active');
                
                // Reset modal state
                modalSelectedStore = null;
                modalSelectedLocation = null;
                
                // Reset any existing input values to empty (not 0)
                const simpleInput = document.getElementById('simpleAmountInput');
                if (simpleInput) {
                    simpleInput.value = '';
                }
                
                // Clear any existing denomination inputs
                const denomInputs = document.querySelectorAll('#currencySections .denomination-input');
                denomInputs.forEach(input => {
                    input.value = '';
                });
                
                // Clear bank inputs
                const bankCurrencySelect = document.getElementById('bankCurrencySelect');
                const bankAmountInput = document.getElementById('bankAmountInput');
                const bankCurrencySymbol = document.getElementById('bankCurrencySymbol');
                if (bankCurrencySelect) {
                    bankCurrencySelect.selectedIndex = 0; // Reset to "Select Currency..."
                }
                if (bankAmountInput) {
                    bankAmountInput.value = '';
                }
                if (bankCurrencySymbol) {
                    bankCurrencySymbol.textContent = ''; // Reset to default
                }
                
                // Reset total display
                const totalElement = document.getElementById('modalTotalAmount');
                if (totalElement) {
                    totalElement.textContent = '0';
                }
                
                // Remove any existing vault transaction direction UI
                const existingDirection = document.getElementById('vaultTransactionDirection');
                if (existingDirection) {
                    existingDirection.remove();
                }
                
                // Reset vault direction to default
                vaultTransactionDirection = 'add';
                
                // Load stores into the modal dropdown
                await loadModalStores();
                
                // Hide location selector and entry sections initially
                document.querySelector('.modal-location-selector').style.display = 'none';
                document.getElementById('cashCountEntry').style.display = 'none';
                document.getElementById('simpleAmountEntry').style.display = 'none';
                document.getElementById('bankAmountEntry').style.display = 'none';
            }
        }

        // Load stores into modal dropdown with retry logic
        async function loadModalStores() {
            const storeSelect = document.getElementById('modalStoreSelect');
            const storeDropdownMenu = document.getElementById('storeDropdownMenu');
            if (!storeSelect) return;
            
            // Clear existing options except the first one
            storeSelect.innerHTML = '<option value="">All Stores</option>';
            if (storeDropdownMenu) {
                storeDropdownMenu.innerHTML = '';
            }
            
            // Ensure appState is ready first
            if (!await ensureAppStateReady()) {
                console.error('Cannot load stores: appState not ready');
                return;
            }
            
            // Get stores from appState with fallback methods
            let stores = [];
            const maxRetries = 3;
            let retryCount = 0;
            
            while (retryCount < maxRetries && (!stores || stores.length === 0)) {
                try {
                    // Method 1: Try getCompanyStores
                    if (typeof appState !== 'undefined' && typeof appState.getCompanyStores === 'function') {
                        stores = appState.getCompanyStores();
                    }
                    
                    // Method 2: If no stores, try getting from user data directly
                    if ((!stores || stores.length === 0) && typeof appState !== 'undefined' && appState.getUserData) {
                        const userData = appState.getUserData();
                        if (userData && userData.companies) {
                            const selectedCompanyId = appState.getSelectedCompanyId();
                            const selectedCompany = userData.companies.find(c => c.company_id === selectedCompanyId);
                            if (selectedCompany && selectedCompany.stores) {
                                stores = selectedCompany.stores;
                            }
                        }
                    }
                    
                    // Method 3: If still no stores, try loading from localStorage directly
                    if (!stores || stores.length === 0) {
                        const userData = localStorage.getItem('user');
                        const companyId = localStorage.getItem('companyChoosen');
                        if (userData && companyId) {
                            const parsed = JSON.parse(userData);
                            const company = parsed.companies?.find(c => c.company_id === companyId);
                            if (company && company.stores) {
                                stores = company.stores;
                            }
                        }
                    }
                    
                    // If still no stores and not last retry, wait a bit
                    if ((!stores || stores.length === 0) && retryCount < maxRetries - 1) {
                        console.log(`No stores found, retrying... (attempt ${retryCount + 1})`);
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                } catch (error) {
                    console.error('Error loading stores:', error);
                }
                
                retryCount++;
            }
            
            console.log(`Loaded ${stores?.length || 0} stores after ${retryCount} attempts`);
            
            if (stores && stores.length > 0) {
                // Add "All Stores" option to custom dropdown
                if (storeDropdownMenu) {
                    const allStoresItem = document.createElement('div');
                    allStoresItem.className = 'toss-dropdown-item selected';
                    allStoresItem.dataset.value = '';
                    allStoresItem.dataset.name = 'All Stores';
                    allStoresItem.onclick = function() { selectStore(this); };
                    allStoresItem.innerHTML = `
                        <div class="toss-dropdown-item-icon" style="background: #F5F7FA; color: #8B95A1;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                <rect x="3" y="7" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M3 10H21" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="toss-dropdown-item-text">
                            <div class="toss-dropdown-item-name">All Stores</div>
                        </div>
                        <svg class="toss-dropdown-check" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                        </svg>
                    `;
                    storeDropdownMenu.appendChild(allStoresItem);
                }
                
                stores.forEach(store => {
                    // Add to hidden select
                    const option = document.createElement('option');
                    option.value = store.store_id;
                    option.textContent = store.store_name;
                    storeSelect.appendChild(option);
                    
                    // Add to custom dropdown
                    if (storeDropdownMenu) {
                        const dropdownItem = document.createElement('div');
                        dropdownItem.className = 'toss-dropdown-item';
                        dropdownItem.dataset.value = store.store_id;
                        dropdownItem.dataset.name = store.store_name;
                        dropdownItem.onclick = function() { selectStore(this); };
                        dropdownItem.innerHTML = `
                            <div class="toss-dropdown-item-icon" style="background: #EFF4FF; color: #4E7EFF;">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                                    <rect x="3" y="7" width="18" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                                    <path d="M8 3L12 7L16 3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="toss-dropdown-item-text">
                                <div class="toss-dropdown-item-name">${store.store_name}</div>
                            </div>
                            <svg class="toss-dropdown-check" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                            </svg>
                        `;
                        storeDropdownMenu.appendChild(dropdownItem);
                    }
                });
            } else {
                console.warn('No stores found for modal dropdown');
            }
        }

        // Handle store selection in modal
        async function onModalStoreChange() {
            const storeSelect = document.getElementById('modalStoreSelect');
            modalSelectedStore = storeSelect.value || null;
            
            if (modalSelectedStore) {
                // Show location selector
                document.querySelector('.modal-location-selector').style.display = 'block';
                
                // Load locations for selected store
                await loadModalLocations(modalSelectedStore);
            } else {
                // Hide location selector if no store selected
                document.querySelector('.modal-location-selector').style.display = 'none';
                document.getElementById('cashCountEntry').style.display = 'none';
                document.getElementById('simpleAmountEntry').style.display = 'none';
                document.getElementById('bankAmountEntry').style.display = 'none';
            }
        }

        // Load locations for selected store
        async function loadModalLocations(storeId) {
            const locationSelect = document.getElementById('modalLocationSelect');
            const dropdownMenu = document.getElementById('locationDropdownMenu');
            
            if (!locationSelect) return;
            
            // Clear existing options
            locationSelect.innerHTML = '<option value="">Select a location</option>';
            if (dropdownMenu) {
                dropdownMenu.innerHTML = '';
            }
            
            // Filter cash locations for this store and sort by type
            const storeLocations = cashLocationsData
                .filter(loc => storeId ? loc.store_id === storeId : !loc.store_id)
                .sort((a, b) => {
                    const typeOrder = { 'cash': 1, 'bank': 2, 'vault': 3 };
                    const aOrder = typeOrder[a.location_type] || 999;
                    const bOrder = typeOrder[b.location_type] || 999;
                    if (aOrder !== bOrder) return aOrder - bOrder;
                    return a.location_name.localeCompare(b.location_name);
                });
            
            if (storeLocations.length > 0) {
                storeLocations.forEach(location => {
                    // Add to hidden select
                    const option = document.createElement('option');
                    option.value = location.cash_location_id;
                    option.textContent = location.location_name;
                    option.dataset.locationType = location.location_type;
                    locationSelect.appendChild(option);
                    
                    // Add to custom dropdown
                    if (dropdownMenu) {
                        const dropdownItem = document.createElement('div');
                        dropdownItem.className = 'toss-dropdown-item';
                        dropdownItem.dataset.value = location.cash_location_id;
                        dropdownItem.dataset.type = location.location_type;
                        dropdownItem.dataset.name = location.location_name;
                        dropdownItem.onclick = function() { selectLocation(this); };
                        
                        const iconBg = getIconBackground(location.location_type);
                        const iconColor = getIconTextColor(location.location_type);
                        
                        dropdownItem.innerHTML = `
                            <div class="toss-dropdown-item-icon" style="background: ${iconBg}; color: ${iconColor};">
                                ${getLocationIcon(location.location_type)}
                            </div>
                            <div class="toss-dropdown-item-text">
                                <span class="toss-dropdown-item-name">${location.location_name}</span>
                                <span class="toss-dropdown-item-type">${location.location_type}</span>
                            </div>
                            <svg class="toss-dropdown-check" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/>
                            </svg>
                        `;
                        
                        dropdownMenu.appendChild(dropdownItem);
                    }
                });
                
                // Reset dropdown display
                resetLocationDropdown();
            }
        }
        
        // Toggle location dropdown
        function toggleLocationDropdown() {
            const dropdown = document.getElementById('locationDropdown');
            const menu = document.getElementById('locationDropdownMenu');
            const backdrop = dropdown.querySelector('.toss-dropdown-backdrop');
            const trigger = dropdown.querySelector('.toss-dropdown-trigger');
            
            if (menu.classList.contains('show')) {
                closeLocationDropdown();
            } else {
                menu.classList.add('show');
                backdrop.classList.add('show');
                trigger.classList.add('active');
            }
        }
        
        // Close location dropdown
        function closeLocationDropdown() {
            const dropdown = document.getElementById('locationDropdown');
            const menu = document.getElementById('locationDropdownMenu');
            const backdrop = dropdown.querySelector('.toss-dropdown-backdrop');
            const trigger = dropdown.querySelector('.toss-dropdown-trigger');
            
            menu.classList.remove('show');
            backdrop.classList.remove('show');
            trigger.classList.remove('active');
        }
        
        // Select a location from dropdown
        function selectLocation(item) {
            const locationId = item.dataset.value;
            const locationType = item.dataset.type;
            const locationName = item.dataset.name;
            
            // Update hidden select
            const select = document.getElementById('modalLocationSelect');
            select.value = locationId;
            
            // Update dropdown display
            const nameEl = document.getElementById('selectedLocationName');
            const typeEl = document.getElementById('selectedLocationType');
            const iconEl = document.getElementById('selectedLocationIcon');
            
            nameEl.textContent = locationName;
            nameEl.style.color = '#333D4B'; // Change from gray to proper text color
            typeEl.textContent = locationType.toUpperCase();
            
            // Update icon
            const iconBg = getIconBackground(locationType);
            const iconColor = getIconTextColor(locationType);
            iconEl.style.background = iconBg;
            iconEl.style.color = iconColor;
            iconEl.innerHTML = getLocationIcon(locationType);
            
            // Update selected state
            const allItems = document.querySelectorAll('.toss-dropdown-item');
            allItems.forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            
            // Close dropdown
            closeLocationDropdown();
            
            // Trigger change event
            onModalLocationChange();
        }
        
        // Reset location dropdown to default
        function resetLocationDropdown() {
            const nameEl = document.getElementById('selectedLocationName');
            const typeEl = document.getElementById('selectedLocationType');
            const iconEl = document.getElementById('selectedLocationIcon');
            
            nameEl.textContent = 'Select a location';
            nameEl.style.color = '#8B95A1'; // Reset to gray placeholder color
            typeEl.textContent = 'LOCATION';
            iconEl.style.background = 'linear-gradient(135deg, #F5F7FA 0%, #E5E8EB 100%)';
            iconEl.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                    <rect x="4" y="4" width="16" height="16" rx="3" stroke="#8B95A1" stroke-width="2"/>
                    <path d="M9 12L11 14L15 10" stroke="#8B95A1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            `;
        }
        
        // Store Dropdown Functions
        function toggleStoreDropdown() {
            const dropdown = document.getElementById('storeDropdown');
            const menu = document.getElementById('storeDropdownMenu');
            const backdrop = dropdown.querySelector('.toss-dropdown-backdrop');
            const trigger = dropdown.querySelector('.toss-dropdown-trigger');
            
            if (menu.classList.contains('show')) {
                closeStoreDropdown();
            } else {
                menu.classList.add('show');
                backdrop.classList.add('show');
                trigger.classList.add('active');
            }
        }
        
        function closeStoreDropdown() {
            const dropdown = document.getElementById('storeDropdown');
            const menu = document.getElementById('storeDropdownMenu');
            const backdrop = dropdown.querySelector('.toss-dropdown-backdrop');
            const trigger = dropdown.querySelector('.toss-dropdown-trigger');
            
            menu.classList.remove('show');
            backdrop.classList.remove('show');
            trigger.classList.remove('active');
        }
        
        function selectStore(item) {
            const storeId = item.dataset.value;
            const storeName = item.dataset.name;
            
            // Update hidden select
            const select = document.getElementById('modalStoreSelect');
            select.value = storeId;
            
            // Update dropdown display
            const nameEl = document.getElementById('selectedStoreName');
            const iconEl = document.getElementById('selectedStoreIcon');
            
            nameEl.textContent = storeName;
            nameEl.style.color = '#333D4B';
            
            // Update icon color
            if (storeId) {
                iconEl.style.background = '#EFF4FF';
                iconEl.style.color = '#4E7EFF';
            } else {
                iconEl.style.background = '#F5F7FA';
                iconEl.style.color = '#8B95A1';
            }
            
            // Update selected state
            const allItems = document.querySelectorAll('#storeDropdownMenu .toss-dropdown-item');
            allItems.forEach(i => i.classList.remove('selected'));
            item.classList.add('selected');
            
            // Close dropdown
            closeStoreDropdown();
            
            // Trigger change event
            onModalStoreChange();
        }

        // Handle location selection in modal
        async function onModalLocationChange() {
            const locationSelect = document.getElementById('modalLocationSelect');
            const selectedOption = locationSelect.options[locationSelect.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                document.getElementById('cashCountEntry').style.display = 'none';
                document.getElementById('simpleAmountEntry').style.display = 'none';
                document.getElementById('bankAmountEntry').style.display = 'none';
                return;
            }
            
            modalSelectedLocation = selectedOption.value;
            const locationType = selectedOption.dataset.locationType;
            
            if (locationType === 'cash') {
                // For cash type, show denomination counting
                document.getElementById('cashCountEntry').style.display = 'block';
                document.getElementById('simpleAmountEntry').style.display = 'none';
                document.getElementById('bankAmountEntry').style.display = 'none';
                
                // Update instruction text
                const instructionEl = document.querySelector('#mainCashEndingModal .modal-subtitle');
                if (instructionEl) {
                    instructionEl.textContent = 'Count cash by denomination';
                }
                
                // Load currency denominations
                await loadCurrencyDenominations();
            } else if (locationType === 'bank') {
                // For bank type, show currency selection and amount input
                document.getElementById('cashCountEntry').style.display = 'none';
                document.getElementById('simpleAmountEntry').style.display = 'none';
                document.getElementById('bankAmountEntry').style.display = 'block';
                
                // Update instruction text
                const instructionEl = document.querySelector('#mainCashEndingModal .modal-subtitle');
                if (instructionEl) {
                    instructionEl.textContent = 'Select currency and enter account balance';
                }
                
                // Load currency data and populate bank currency dropdown
                await loadCurrencyDenominations();
                populateBankCurrencies();
            } else if (locationType === 'vault') {
                // For vault type, show denomination counting with transaction direction
                document.getElementById('cashCountEntry').style.display = 'block';
                document.getElementById('simpleAmountEntry').style.display = 'none';
                document.getElementById('bankAmountEntry').style.display = 'none';
                
                // Update instruction text
                const instructionEl = document.querySelector('#mainCashEndingModal .modal-subtitle');
                if (instructionEl) {
                    instructionEl.textContent = 'Count cash by denomination';
                }
                
                // Load currency denominations for vault
                await loadCurrencyDenominations();
                
                // Add transaction direction UI for vault
                addVaultTransactionDirection();
            } else {
                // Default for unknown types
                document.getElementById('cashCountEntry').style.display = 'none';
                document.getElementById('simpleAmountEntry').style.display = 'block';
                document.getElementById('bankAmountEntry').style.display = 'none';
                
                const instructionEl = document.querySelector('#mainCashEndingModal .modal-subtitle');
                if (instructionEl) {
                    instructionEl.textContent = 'Enter actual amount';
                }
            }
        }

        // Load currency denominations for cash counting
        async function loadCurrencyDenominations() {
            try {
                console.log('=== Loading Currency Denominations ===');
                const selectedCompanyId = appState.getSelectedCompanyId();
                console.log('Company ID:', selectedCompanyId);
                
                if (!selectedCompanyId) {
                    console.error('No company selected');
                    // Use default currency without company
                    useFallbackCurrencyData();
                    return;
                }
                
                // Step 1: Get company currencies from company_currency table
                console.log('Step 1: Loading company currencies...');
                const { data: companyCurrencyData, error: ccError } = await supabase
                    .from('company_currency')
                    .select('currency_id')
                    .eq('company_id', selectedCompanyId);
                
                if (ccError) {
                    console.error('Error loading company currencies:', ccError);
                    // Fall back to default VND if error
                    console.log('Using fallback VND currency due to error');
                    useFallbackCurrencyData();
                    return;
                }
                
                console.log('Company currencies loaded:', companyCurrencyData);
                
                if (!companyCurrencyData || companyCurrencyData.length === 0) {
                    console.warn('No currencies found for company, using default VND');
                    useFallbackCurrencyData();
                    return;
                }
                
                const currencyIds = companyCurrencyData.map(cc => cc.currency_id);
                console.log('Currency IDs:', currencyIds);
                
                // Step 2: Get currency details from currency_types table
                console.log('Step 2: Loading currency types...');
                const { data: currencyData, error: ctError } = await supabase
                    .from('currency_types')
                    .select('currency_id, currency_code, currency_name, symbol')
                    .in('currency_id', currencyIds);
                
                if (ctError) {
                    console.error('Error loading currency types:', ctError);
                    // Use fallback currency data
                    console.log('Using fallback VND currency due to error');
                    useFallbackCurrencyData();
                    return;
                }
                
                if (!currencyData || currencyData.length === 0) {
                    console.warn('No currency types found, using fallback');
                    useFallbackCurrencyData();
                    return;
                }
                
                // Map the 'symbol' field to 'currency_symbol' for consistency
                currencyTypes = currencyData.map(curr => ({
                    currency_id: curr.currency_id,
                    currency_code: curr.currency_code,
                    currency_name: curr.currency_name,
                    currency_symbol: curr.symbol || ''
                }));
                
                console.log('Currency types loaded:', currencyTypes);
                
                // Step 3: Get denominations for the company
                console.log('Step 3: Loading currency denominations...');
                
                // Query denominations for all company currencies
                const denominationPromises = currencyIds.map(currencyId => 
                    supabase
                        .from('currency_denominations')
                        .select('denomination_id, currency_id, value')
                        .eq('company_id', selectedCompanyId)
                        .eq('currency_id', currencyId)
                        .order('value', { ascending: false })
                );
                
                const denominationResults = await Promise.all(denominationPromises);
                
                // Combine all denomination results
                currencyDenominations = [];
                let hasErrors = false;
                
                denominationResults.forEach((result, index) => {
                    if (result.error) {
                        console.error(`Error loading denominations for currency ${currencyIds[index]}:`, result.error);
                        hasErrors = true;
                    } else if (result.data && result.data.length > 0) {
                        currencyDenominations.push(...result.data);
                    }
                });
                
                console.log('Denominations loaded:', currencyDenominations);
                
                // If no denominations found or errors occurred, use fallback
                if (currencyDenominations.length === 0 || hasErrors) {
                    console.log('No denominations found or errors occurred, using fallback');
                    
                    // Check if we have VND in our currencies
                    const hasVND = currencyTypes.some(ct => ct.currency_code === 'VND');
                    
                    if (hasVND) {
                        // Use the actual VND currency_id from the database
                        const vndCurrency = currencyTypes.find(ct => ct.currency_code === 'VND');
                        currencyDenominations = getDefaultVNDDenominations().map(d => ({
                            ...d,
                            currency_id: vndCurrency.currency_id
                        }));
                    } else {
                        // Complete fallback
                        useFallbackCurrencyData();
                        return;
                    }
                }
                
                // Build the denomination UI
                buildDenominationUI();
                
            } catch (error) {
                console.error('Error in loadCurrencyDenominations:', error);
                // Use complete fallback
                useFallbackCurrencyData();
            }
        }
        
        // Helper function for default VND denominations
        function getDefaultVNDDenominations() {
            return [
                { denomination_id: 'd1', currency_id: 'vnd-default', value: 500000 },
                { denomination_id: 'd2', currency_id: 'vnd-default', value: 200000 },
                { denomination_id: 'd3', currency_id: 'vnd-default', value: 100000 },
                { denomination_id: 'd4', currency_id: 'vnd-default', value: 50000 },
                { denomination_id: 'd5', currency_id: 'vnd-default', value: 20000 },
                { denomination_id: 'd6', currency_id: 'vnd-default', value: 10000 },
                { denomination_id: 'd7', currency_id: 'vnd-default', value: 5000 },
                { denomination_id: 'd8', currency_id: 'vnd-default', value: 2000 },
                { denomination_id: 'd9', currency_id: 'vnd-default', value: 1000 },
                { denomination_id: 'd10', currency_id: 'vnd-default', value: 500 }
            ];
        }
        
        // Complete fallback function
        function useFallbackCurrencyData() {
            console.log('Using complete fallback currency data');
            currencyTypes = [{
                currency_id: 'vnd-default',
                currency_code: 'VND',
                currency_name: 'Vietnamese Dong',
                currency_symbol: ''
            }];
            currencyDenominations = getDefaultVNDDenominations();
            buildDenominationUI();
        }

        // Build denomination counting UI
        function buildDenominationUI() {
            console.log('Building denomination UI...');
            const currencySections = document.getElementById('currencySections');
            if (!currencySections) {
                console.error('Currency sections element not found');
                return;
            }
            
            currencySections.innerHTML = '';
            
            console.log('Currency types:', currencyTypes);
            console.log('Currency denominations:', currencyDenominations);
            
            if (!currencyTypes || currencyTypes.length === 0) {
                console.warn('No currency types available');
                currencySections.innerHTML = '<p style="padding: 20px; text-align: center; color: var(--toss-text-secondary);">No currencies configured for this company</p>';
                return;
            }
            
            // Group denominations by currency
            const denominationsByCurrency = {};
            currencyDenominations.forEach(denom => {
                if (!denominationsByCurrency[denom.currency_id]) {
                    denominationsByCurrency[denom.currency_id] = [];
                }
                denominationsByCurrency[denom.currency_id].push(denom);
            });
            
            console.log('Denominations by currency:', denominationsByCurrency);
            
            // Sort denominations by value (descending)
            Object.keys(denominationsByCurrency).forEach(currencyId => {
                denominationsByCurrency[currencyId].sort((a, b) => b.value - a.value);
            });
            
            // Create section for each currency
            currencyTypes.forEach(currency => {
                const denoms = denominationsByCurrency[currency.currency_id] || [];
                
                // Show currency even if no denominations (with message)
                const section = document.createElement('div');
                section.className = 'currency-section';
                
                // Currency header
                const header = document.createElement('div');
                header.className = 'currency-header';
                header.innerHTML = `
                    <div class="currency-icon">${currency.currency_symbol || ''}</div>
                    <div class="currency-name">${currency.currency_name} (${currency.currency_code})</div>
                `;
                section.appendChild(header);
                
                if (denoms.length === 0) {
                    // No denominations for this currency
                    const noDataDiv = document.createElement('div');
                    noDataDiv.style.cssText = 'padding: 12px; text-align: center; color: var(--toss-text-secondary); font-size: 14px;';
                    noDataDiv.textContent = 'No denominations configured for this currency';
                    section.appendChild(noDataDiv);
                } else {
                    // Denomination rows
                    denoms.forEach(denom => {
                        const row = document.createElement('div');
                        row.className = 'denomination-row';
                        
                        const formattedValue = formatAmount(denom.value);
                        
                        row.innerHTML = `
                            <div class="denomination-label">${currency.currency_symbol || ''}${formattedValue}</div>
                            <input type="number" 
                                   class="denomination-input" 
                                   placeholder="" 
                                   min="0"
                                   data-denomination-id="${denom.denomination_id}"
                                   data-value="${denom.value}"
                                   data-currency="${currency.currency_code}"
                                   data-symbol="${currency.currency_symbol || ''}"
                                   oninput="calculateDenominationTotal()">
                            <div class="denomination-unit">pieces</div>
                            <div class="denomination-subtotal" data-subtotal="${denom.denomination_id}">${currency.currency_symbol || ''}0</div>
                        `;
                        
                        section.appendChild(row);
                    });
                }
                
                currencySections.appendChild(section);
            });
            
            console.log('Denomination UI built successfully');
        }

        // Add transaction direction UI for vault
        function addVaultTransactionDirection() {
            console.log('Adding vault transaction direction UI...');
            const currencySections = document.getElementById('currencySections');
            if (!currencySections) {
                console.error('Currency sections element not found');
                return;
            }
            
            // Check if transaction direction already exists
            const existingDirection = document.getElementById('vaultTransactionDirection');
            if (existingDirection) {
                console.log('Transaction direction UI already exists');
                return;
            }
            
            // Create transaction direction UI
            const directionHTML = `
                <div id="vaultTransactionDirection" class="vault-transaction-direction" style="margin-bottom: 24px;">
                    <div style="background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 12px; padding: 16px;">
                        <h4 style="margin: 0 0 12px 0; color: #92400E; font-size: 14px; font-weight: 600;">
                            Transaction Direction:
                        </h4>
                        <div style="display: flex; gap: 8px;">
                            <button type="button" id="vaultAddBtn" class="vault-direction-btn vault-direction-active" 
                                    onclick="setVaultDirection('add')"
                                    style="flex: 1; padding: 12px 16px; border: 2px solid #10B981; background: #10B981; color: white; 
                                           border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; 
                                           transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span style="font-size: 16px;">+</span>
                                <span>Add (+)</span>
                            </button>
                            <button type="button" id="vaultRemoveBtn" class="vault-direction-btn" 
                                    onclick="setVaultDirection('remove')"
                                    style="flex: 1; padding: 12px 16px; border: 2px solid #EF4444; background: transparent; color: #EF4444; 
                                           border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; 
                                           transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                <span style="font-size: 16px;">-</span>
                                <span>Remove (-)</span>
                            </button>
                        </div>
                        <p style="margin: 12px 0 0 0; font-size: 13px; color: #92400E; line-height: 1.4;">
                            Choose whether you are adding to or removing from the vault
                        </p>
                    </div>
                </div>
            `;
            
            // Add to the beginning of currency sections
            currencySections.insertAdjacentHTML('afterbegin', directionHTML);
            console.log('Vault transaction direction UI added');
        }

        // Set vault transaction direction
        let vaultTransactionDirection = 'add'; // Default to 'add'
        
        function setVaultDirection(direction) {
            console.log('Setting vault direction to:', direction);
            vaultTransactionDirection = direction;
            
            const addBtn = document.getElementById('vaultAddBtn');
            const removeBtn = document.getElementById('vaultRemoveBtn');
            
            if (direction === 'add') {
                // Active: Add button
                addBtn.style.background = '#10B981';
                addBtn.style.color = 'white';
                addBtn.className = 'vault-direction-btn vault-direction-active';
                
                // Inactive: Remove button
                removeBtn.style.background = 'transparent';
                removeBtn.style.color = '#EF4444';
                removeBtn.className = 'vault-direction-btn';
            } else {
                // Active: Remove button
                removeBtn.style.background = '#EF4444';
                removeBtn.style.color = 'white';
                removeBtn.className = 'vault-direction-btn vault-direction-active';
                
                // Inactive: Add button
                addBtn.style.background = 'transparent';
                addBtn.style.color = '#10B981';
                addBtn.className = 'vault-direction-btn';
            }
        }

        // Calculate total from denomination inputs
        function calculateDenominationTotal() {
            let total = 0;
            let currencySymbol = ''; // Default to VND
            
            const inputs = document.querySelectorAll('.denomination-input');
            inputs.forEach(input => {
                // Only count if there's a value entered (not empty)
                const count = input.value === '' ? 0 : (parseFloat(input.value) || 0);
                const value = parseFloat(input.dataset.value) || 0;
                const subtotal = count * value;
                
                // Get currency symbol from the first input
                if (input.dataset.symbol) {
                    currencySymbol = input.dataset.symbol;
                }
                
                // Update subtotal display
                const subtotalElement = document.querySelector(`[data-subtotal="${input.dataset.denominationId}"]`);
                if (subtotalElement) {
                    // Show subtotal only if count > 0
                    if (count > 0) {
                        subtotalElement.textContent = currencySymbol + formatAmount(subtotal);
                    } else {
                        subtotalElement.textContent = currencySymbol + '0';
                    }
                }
                
                total += subtotal;
            });
            
            // Update total display
            const totalElement = document.getElementById('modalTotalAmount');
            if (totalElement) {
                totalElement.textContent = currencySymbol + formatAmount(total);
            }
            
            return total;
        }

        // Save cash amount from modal
        async function saveModalCashAmount() {
            if (!modalSelectedLocation) {
                if (typeof TossAlertUtils !== 'undefined') {
                    TossAlertUtils.showWarning('Please select a location');
                } else {
                    alert('Please select a location');
                }
                return;
            }
            
            const locationSelect = document.getElementById('modalLocationSelect');
            const selectedOption = locationSelect.options[locationSelect.selectedIndex];
            const locationType = selectedOption.dataset.locationType;
            
            // Disable save button to prevent double-clicking
            const saveBtn = document.getElementById('modalSaveBtn');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';
            }
            
            try {
                if (locationType === 'cash') {
                    // For cash type, use the RPC to save denomination details
                    await saveCashDenominations();
                } else if (locationType === 'vault') {
                    // For vault type, use the same denomination RPC but with direction
                    await saveVaultDenominations();
                } else if (locationType === 'bank') {
                    // For bank type, use bank-specific save with currency and amount
                    await saveBankAmount();
                } else {
                    // For other types, save simple amount (for now just update local data)
                    await saveSimpleAmount(locationType);
                }
                
                // Reload data to refresh the display
                // Check current store filter to reload accordingly
                let currentStoreId = null;
                if (window.cashEndingPage && window.cashEndingPage.currentStoreFilter) {
                    currentStoreId = window.cashEndingPage.currentStoreFilter;
                } // else leave as null for "All Stores"
                
                await loadBalanceAndActualAmounts(currentStoreId);
                
                // Refresh store filter dropdown after successful save with proper timing
                if (window.cashEndingPage) {
                    console.log('Refreshing store filter dropdown after save with delay...');
                    
                    // Debug appState BEFORE calling dropdown
                    console.log('=== APPSTATE CHECK BEFORE DROPDOWN ===');
                    if (typeof appState !== 'undefined') {
                        const userData = appState.getUserData();
                        console.log('Before dropdown - userData:', userData);
                        console.log('Before dropdown - getUserData exists:', !!userData);
                        console.log('Before dropdown - userData.companies:', userData ? userData.companies : 'no userData');
                        console.log('Before dropdown - getSelectedCompanyId():', appState.getSelectedCompanyId());
                        console.log('Before dropdown - getCompanyStores():', appState.getCompanyStores());
                    }
                    
                    // Give a small delay to ensure appState is properly loaded
                    setTimeout(async () => {
                        console.log('=== CALLING DROPDOWN AFTER TIMEOUT ===');
                        await window.cashEndingPage.showStoreFilterDropdown(0);
                    }, 200);
                }
                
                // Show success message BEFORE closing modal
                console.log('=== SHOWING SUCCESS MESSAGE ===');
                if (typeof TossAlertUtils !== 'undefined') {
                    TossAlertUtils.showSuccess('Cash amount saved successfully!');
                    console.log('Success message shown via TossAlertUtils');
                } else {
                    alert('Cash amount saved successfully!');
                    console.log('Success message shown via alert');
                }
                
                // Close modal with a small delay to ensure success message is visible
                console.log('=== CLOSING MODAL WITH DELAY ===');
                setTimeout(() => {
                    closeCashEndingModal();
                    console.log('Modal close function called after delay');
                }, 500); // 500ms delay to show success message
            } catch (error) {
                console.error('Error saving cash amount:', error);
                if (typeof TossAlertUtils !== 'undefined') {
                    TossAlertUtils.showError('Failed to save cash amount. Please try again.');
                }
            } finally {
                // Re-enable save button
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save';
                }
            }
        }
        
        // Helper function - Get today's date in YYYY-MM-DD format (LOCAL TIME)
        function getTodayDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Helper function - Get current datetime in YYYY-MM-DDTHH:MM:SS format (DEVICE'S LOCAL TIME)
        function getLocalDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
        }

        // Helper function - Get current datetime in YYYY-MM-DD HH:MM:SS format for vault RPC
        function getLocalDateTimeForVault() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        }

        // Helper function - Collect denomination data from inputs
        function collectDenominationData() {
            console.log('=== COLLECTING DENOMINATION DATA ===');
            const currencyGroups = {};
            
            // Find all denomination input fields
            const inputs = document.querySelectorAll('#currencySections .denomination-input');
            console.log('Found denomination inputs:', inputs.length);
            
            inputs.forEach((input, index) => {
                const quantity = parseInt(input.value) || 0;
                console.log(`Input ${index}: value="${input.value}", quantity=${quantity}`);
                
                if (quantity <= 0) {
                    console.log(`  -> Skipping (quantity <= 0)`);
                    return;  // Skip empty or zero values
                }
                
                const denominationId = input.dataset.denominationId;
                const currencyId = getCurrencyIdForDenomination(denominationId);
                
                console.log(`  -> denominationId=${denominationId}, currencyId=${currencyId}`);
                
                if (!currencyId) {
                    console.warn(`  -> No currency ID found for denomination ${denominationId}`);
                    return;
                }
                
                // Group by currency
                if (!currencyGroups[currencyId]) {
                    currencyGroups[currencyId] = {
                        currency_id: currencyId,
                        denominations: []
                    };
                    console.log(`  -> Created new currency group: ${currencyId}`);
                }
                
                currencyGroups[currencyId].denominations.push({
                    denomination_id: denominationId,
                    quantity: quantity
                });
                
                console.log(`  -> Added to currency ${currencyId}:`, {
                    denomination_id: denominationId,
                    quantity: quantity
                });
            });
            
            // Convert to array
            const currenciesArray = Object.values(currencyGroups);
            console.log('Final currencies data:', currenciesArray);
            return currenciesArray;
        }

        // Helper function - Collect denomination data for vault (flat array format)
        function collectVaultDenominationData() {
            console.log('=== COLLECTING VAULT DENOMINATION DATA ===');
            const vaultAmountLines = [];
            let currencyId = null;
            
            // Find all denomination input fields
            const inputs = document.querySelectorAll('#currencySections .denomination-input');
            console.log('Found denomination inputs:', inputs.length);
            
            inputs.forEach((input, index) => {
                const quantity = parseInt(input.value) || 0;
                console.log(`Input ${index}: value="${input.value}", quantity=${quantity}`);
                
                if (quantity <= 0) {
                    console.log(`  -> Skipping (quantity <= 0)`);
                    return;  // Skip empty or zero values
                }
                
                const denominationId = input.dataset.denominationId;
                
                // Get currency ID for this denomination (for single currency requirement)
                if (!currencyId) {
                    currencyId = getCurrencyIdForDenomination(denominationId);
                    console.log(`  -> First currency ID found: ${currencyId}`);
                }
                
                // Add to flat array (vault format)
                vaultAmountLines.push({
                    denomination_id: denominationId,
                    quantity: quantity
                });
                
                console.log(`  -> Added to vault lines:`, {
                    denomination_id: denominationId,
                    quantity: quantity
                });
            });
            
            console.log('Final vault amount lines:', vaultAmountLines);
            console.log('Currency ID:', currencyId);
            return { vaultAmountLines, currencyId };
        }

        // Save vault denominations using vault_amount_insert RPC
        async function saveVaultDenominations() {
            console.log('=== VAULT ENDING SAVE - START ===');
            
            try {
                // 1. Get company ID (  )
                const companyId = appState.getSelectedCompanyId();
                console.log('1. Company ID:', companyId);
                if (!companyId) {
                    throw new Error('Company ID not found');
                }
                
                // 2. Get user ID (  )
                const userData = appState.getUserData();
                let userId = userData?.user_id || sessionStorage.getItem('userId');
                
                if (!userId) {
                    const { data: { session }, error } = await supabase.auth.getSession();
                    if (session && session.user) {
                        userId = session.user.id;
                    } else {
                        throw new Error('User ID not found');
                    }
                }
                console.log('2. User ID:', userId);
                
                // 3. Get selected location ID ( Vault Location)
                if (!modalSelectedLocation) {
                    throw new Error('Vault location not selected');
                }
                console.log('3. Location ID:', modalSelectedLocation);
                
                // 4. Get selected store ID ( Store - null )
                console.log('4. Store ID:', modalSelectedStore || 'null (HeadQuarter)');
                
                // 5. Get transaction direction and convert to debit/credit
                console.log('5. Transaction Direction:', vaultTransactionDirection);
                if (!vaultTransactionDirection) {
                    throw new Error('Transaction direction (Add/Remove) not selected');
                }
                
                // Convert transaction direction to debit/credit boolean values
                const isDebit = vaultTransactionDirection === 'add';    // Add = debit = true
                const isCredit = vaultTransactionDirection === 'remove'; // Remove = credit = true
                
                console.log('5. Debit/Credit mapping:');
                console.log('   p_debit:', isDebit);
                console.log('   p_credit:', isCredit);
                
                // 6. Collect vault denomination data (flat array format)
                const { vaultAmountLines, currencyId } = collectVaultDenominationData();
                if (vaultAmountLines.length === 0) {
                    throw new Error(' 1    .');
                }
                if (!currencyId) {
                    throw new Error('Currency ID not found');
                }
                
                console.log('6. Vault denomination data:');
                console.log('   Currency ID:', currencyId);
                console.log('   Amount lines count:', vaultAmountLines.length);
                console.log('   Amount lines:', vaultAmountLines);
                
                // 7. Prepare datetime values (DEVICE'S LOCAL TIME with space format)
                const recordDate = getTodayDate();              // "YYYY-MM-DD"
                const createdAt = getLocalDateTimeForVault();   // "YYYY-MM-DD HH:MM:SS" (space format)
                
                console.log('7. Date/Time (LOCAL DEVICE TIME):');
                console.log('   Record Date:', recordDate);
                console.log('   Created At:', createdAt);
                
                // 8. Build RPC parameters for vault_amount_insert
                const rpcParams = {
                    p_location_id: modalSelectedLocation,      // Vault location ID
                    p_company_id: companyId,                   // Company ID  
                    p_created_at: createdAt,                   // Created timestamp (space format)
                    p_created_by: userId,                      // User ID
                    p_credit: isCredit,                        // Remove = credit = true
                    p_debit: isDebit,                         // Add = debit = true
                    p_record_date: recordDate,                 // Record date (YYYY-MM-DD)
                    p_store_id: modalSelectedStore || null,    // Store ID (null for HeadQuarter)
                    p_currency_id: currencyId,                 // Single currency ID
                    p_vault_amount_line_json: vaultAmountLines // Flat denomination array
                };
                
                console.log('8. Final vault_amount_insert RPC Parameters:');
                console.log(JSON.stringify(rpcParams, null, 2));
                
                // 9. Call vault_amount_insert RPC
                console.log('9. Calling vault_amount_insert RPC...');
                const { data, error } = await supabase.rpc('vault_amount_insert', rpcParams);
                
                if (error) {
                    console.error('Vault RPC Error:', error);
                    throw error;
                }
                
                console.log('9. vault_amount_insert RPC Success:', data);
                console.log('=== VAULT ENDING SAVE - COMPLETED ===');
                
                return data;
                
            } catch (error) {
                console.error('=== VAULT ENDING SAVE - ERROR ===');
                console.error(error);
                throw error;
            }
        }

        // Save bank amount with currency selection
        async function saveBankAmount() {
            console.log('=== BANK ENDING SAVE - START ===');
            
            try {
                // 1. Validate bank currency selection
                const currencySelect = document.getElementById('bankCurrencySelect');
                const amountInput = document.getElementById('bankAmountInput');
                
                if (!currencySelect || !currencySelect.value) {
                    throw new Error('Please select a currency for the bank account');
                }
                
                if (!amountInput || !amountInput.value) {
                    throw new Error('Please enter the bank account amount');
                }
                
                const selectedCurrencyId = currencySelect.value;
                const amount = parseFloat(amountInput.value);
                const selectedOption = currencySelect.options[currencySelect.selectedIndex];
                const currencyCode = selectedOption.dataset.code || 'Unknown';
                const currencySymbol = selectedOption.dataset.symbol || '';
                
                console.log('1. Bank Currency/Amount Validation:');
                console.log('   Currency ID:', selectedCurrencyId);
                console.log('   Currency Code:', currencyCode);
                console.log('   Currency Symbol:', currencySymbol);
                console.log('   Amount:', amount);
                
                if (amount <= 0) {
                    throw new Error('Bank account amount must be greater than 0');
                }
                
                // 2. Get company, user, location, store IDs (same as cash/vault)
                const companyId = appState.getSelectedCompanyId();
                console.log('2. Company ID:', companyId);
                if (!companyId) {
                    throw new Error('Company ID not found');
                }
                
                const userData = appState.getUserData();
                let userId = userData?.user_id || sessionStorage.getItem('userId');
                
                if (!userId) {
                    const { data: { session }, error } = await supabase.auth.getSession();
                    if (session && session.user) {
                        userId = session.user.id;
                    } else {
                        throw new Error('User ID not found');
                    }
                }
                console.log('3. User ID:', userId);
                
                if (!modalSelectedLocation) {
                    throw new Error('Bank location not selected');
                }
                console.log('4. Location ID:', modalSelectedLocation);
                console.log('5. Store ID:', modalSelectedStore || 'null (HeadQuarter)');
                
                // 3. Prepare datetime values (DEVICE'S LOCAL TIME with space format)
                const recordDate = getTodayDate();                // "YYYY-MM-DD"
                const createdAt = getLocalDateTimeForVault();     // "YYYY-MM-DD HH:MM:SS" (space format)
                
                console.log('6. Date/Time (LOCAL DEVICE TIME):');
                console.log('   Record Date:', recordDate);
                console.log('   Created At:', createdAt);
                
                // 4. Build RPC parameters for bank_amount_insert_v2
                const rpcParams = {
                    p_company_id: companyId,                    // Company ID
                    p_location_id: modalSelectedLocation,       // Bank location ID
                    p_store_id: modalSelectedStore || null,     // Store ID (null for HeadQuarter)
                    p_total_amount: amount,                    // Bank amount (correct parameter name)
                    p_currency_id: selectedCurrencyId,         // Currency ID
                    p_record_date: recordDate,                 // Record date (YYYY-MM-DD)
                    p_created_by: userId,                      // User ID
                    p_created_at: createdAt                    // Created timestamp (space format)
                };
                
                console.log('7. Final bank_amount_insert_v2 RPC Parameters:');
                console.log(JSON.stringify(rpcParams, null, 2));
                
                // 5. Call bank_amount_insert_v2 RPC
                console.log('8. Calling bank_amount_insert_v2 RPC...');
                const { data, error } = await supabase.rpc('bank_amount_insert_v2', rpcParams);
                
                if (error) {
                    console.error('Bank RPC Error:', error);
                    throw error;
                }
                
                console.log('8. bank_amount_insert_v2 RPC Success:', data);
                console.log('=== BANK ENDING SAVE - COMPLETED ===');
                
                return data;
                
            } catch (error) {
                console.error('=== BANK ENDING SAVE - ERROR ===');
                console.error(error);
                throw error;
            }
        }

        // Save cash denominations using RPC (Following implementation guide)
        async function saveCashDenominations() {
            console.log('=== CASH ENDING SAVE - START ===');
            
            try {
                // 1. Get company ID (  )
                const companyId = appState.getSelectedCompanyId();
                console.log('1. Company ID:', companyId);
                if (!companyId) {
                    throw new Error('Company ID not found');
                }
                
                // 2. Get user ID (  )
                const userData = appState.getUserData();
                let userId = userData?.user_id || sessionStorage.getItem('userId');
                
                if (!userId) {
                    const { data: { session }, error } = await supabase.auth.getSession();
                    if (session && session.user) {
                        userId = session.user.id;
                    } else {
                        throw new Error('User ID not found');
                    }
                }
                console.log('2. User ID:', userId);
                
                // 3. Get selected location ID ( Cash Location)
                if (!modalSelectedLocation) {
                    throw new Error('Cash location not selected');
                }
                console.log('3. Location ID:', modalSelectedLocation);
                
                // 4. Get selected store ID ( Store - null )
                console.log('4. Store ID:', modalSelectedStore || 'null (HeadQuarter)');
                
                // 5. Collect denomination data (   )
                const currenciesData = collectDenominationData();
                if (currenciesData.length === 0) {
                    throw new Error(' 1    .');
                }
                
                // 6. Prepare datetime values (DEVICE'S LOCAL TIME)
                const recordDate = getTodayDate();        // "YYYY-MM-DD"
                const createdAt = getLocalDateTime();     // "YYYY-MM-DDTHH:MM:SS"
                
                console.log('6. Date/Time (LOCAL DEVICE TIME):');
                console.log('   Record Date:', recordDate);
                console.log('   Created At:', createdAt);
                
                // 7. Build RPC parameters (  )
                const rpcParams = {
                    p_company_id: companyId,           // ID
                    p_location_id: modalSelectedLocation, // ID  
                    p_store_id: modalSelectedStore || null, // ID (null )
                    p_record_date: recordDate,         //   (YYYY-MM-DD)
                    p_created_by: userId,              // ID
                    p_created_at: createdAt,           //   (LOCAL TIME)
                    p_currencies: currenciesData       //    
                };
                
                console.log('7. Final RPC Parameters:');
                console.log(JSON.stringify(rpcParams, null, 2));
                
                // 8. Call RPC
                console.log('8. Calling insert_cashier_amount_lines...');
                const { data, error } = await supabase.rpc('insert_cashier_amount_lines', rpcParams);
                
                if (error) {
                    console.error('RPC Error:', error);
                    throw error;
                }
                
                console.log('8. RPC Success:', data);
                console.log('=== CASH ENDING SAVE - COMPLETED ===');
                
                return data;
                
            } catch (error) {
                console.error('=== CASH ENDING SAVE - ERROR ===');
                console.error(error);
                throw error;
            }
        }
        
        // Helper function to get currency ID for a denomination
        function getCurrencyIdForDenomination(denominationId) {
            const denomination = currencyDenominations.find(d => d.denomination_id === denominationId);
            return denomination ? denomination.currency_id : null;
        }
        
        // Save simple amount for non-cash locations
        async function saveSimpleAmount(locationType) {
            let amount = 0;
            const selectedOption = document.querySelector('#modalLocationSelect option:checked');
            
            if (locationType === 'vault') {
                // For vault: combine safe amount + denomination total
                const simpleInput = document.getElementById('simpleAmountInput');
                const safeAmount = parseFloat(simpleInput.value) || 0;
                const cashAmount = calculateDenominationTotal();
                amount = safeAmount + cashAmount;
            } else {
                // For bank and other types: get amount from simple input
                const simpleInput = document.getElementById('simpleAmountInput');
                amount = parseFloat(simpleInput.value) || 0;
            }
            
            // TODO: Implement RPC for saving non-cash amounts
            // For now, just update local data
            const actualItem = actualData.find(item => item.cash_location_id === modalSelectedLocation);
            if (actualItem) {
                actualItem.actual_amount = amount;
                actualItem.last_updated = new Date().toISOString();
            } else {
                // Add new actual data
                actualData.push({
                    cash_location_id: modalSelectedLocation,
                    location_name: selectedOption.text,
                    store_id: modalSelectedStore,
                    actual_amount: amount,
                    last_updated: new Date().toISOString()
                });
            }
        }

        function closeCashEndingModal() {
            console.log('=== CLOSE CASH ENDING MODAL FUNCTION ===');
            const modal = document.getElementById('mainCashEndingModal');
            console.log('Modal element found:', !!modal);
            
            if (modal) {
                console.log('Modal has active class:', modal.classList.contains('active'));
                modal.classList.remove('active');
                console.log('Modal active class removed');
                
                // Also reset modal state
                modalSelectedStore = null;
                modalSelectedLocation = null;
                console.log('Modal state reset');
            } else {
                console.error('Modal element not found!');
            }
        }
        
        // Make Error Modal Functions
        let currentMakeErrorLocation = null;
        
        function openMakeErrorModal(locationId) {
            // Find the location data
            const processedLocations = processLocationData();
            const location = processedLocations.find(loc => loc.cash_location_id === locationId);
            
            if (!location) {
                console.error('Location not found:', locationId);
                return;
            }
            
            // Calculate difference
            const balanceAmount = location.balance || 0;
            const actualAmount = location.actual_amount || 0;
            const difference = actualAmount - balanceAmount;
            
            console.log('Make Error calculation:', {
                location: location.location_name,
                balance: balanceAmount,
                actual: actualAmount,
                difference: difference
            });
            
            if (Math.abs(difference) < 0.01) {
                console.log('No significant difference to make error for');
                return;
            }
            
            // Store current location for later use
            currentMakeErrorLocation = {
                ...location,
                difference: difference
            };
            
            // Update modal content
            document.getElementById('errorLocationName').textContent = location.location_name;
            document.getElementById('errorVarianceAmount').textContent = formatCurrency(Math.abs(difference), location.currency_symbol || 'VND');
            
            // Show modal
            document.getElementById('makeErrorModal').style.display = 'flex';
        }
        
        function closeMakeErrorModal() {
            document.getElementById('makeErrorModal').style.display = 'none';
            currentMakeErrorLocation = null;
        }
        
        async function confirmMakeError() {
            if (!currentMakeErrorLocation) {
                console.error('No location selected for make error');
                return;
            }
            
            try {
                // Check if supabase client is available
                if (!supabase) {
                    console.error('Supabase client not available');
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showError('Database connection not available');
                    }
                    return;
                }
                
                // Get necessary IDs from session storage
                const companyId = appState.getSelectedCompanyId();
                const userData = appState.getUserData();
                
                // Try to get user ID from multiple sources
                let userId = userData?.user_id || userData?.id;
                
                // If not found in userData, get from session
                if (!userId) {
                    const { data: { session } } = await supabase.auth.getSession();
                    userId = session?.user?.id;
                }
                
                if (!companyId || !userId) {
                    console.error('Missing company ID or user ID');
                    console.log('Company ID:', companyId);
                    console.log('User Data:', userData);
                    console.log('User ID:', userId);
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showError('Missing required session data. Please refresh the page.');
                    }
                    return;
                }
                
                // Get current date
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0]; // yyyy-MM-dd
                const description = `Make Error ${dateStr}`;
                
                // Prepare journal lines based on difference
                const absDifference = Math.abs(currentMakeErrorLocation.difference);
                const lines = [];
                
                // Account IDs (these are fixed per requirement from user)
                const cashAccountId = 'd4a7a16e-45a1-47fe-992b-ff807c8673f0';
                const errorAccountId = 'a45fac5d-010c-4b1b-92e9-ddcf8f3222bf';  // Make Error account from user's example
                
                if (currentMakeErrorLocation.difference > 0) {
                    // Positive difference: debit cash, credit error account
                    lines.push({
                        account_id: cashAccountId,
                        description: description,
                        debit: absDifference,
                        credit: 0,
                        cash: {
                            cash_location_id: currentMakeErrorLocation.cash_location_id
                        }
                    });
                    lines.push({
                        account_id: errorAccountId,
                        description: description,
                        debit: 0,
                        credit: absDifference
                    });
                } else {
                    // Negative difference: credit cash, debit error account
                    lines.push({
                        account_id: cashAccountId,
                        description: description,
                        debit: 0,
                        credit: absDifference,
                        cash: {
                            cash_location_id: currentMakeErrorLocation.cash_location_id
                        }
                    });
                    lines.push({
                        account_id: errorAccountId,
                        description: description,
                        debit: absDifference,
                        credit: 0
                    });
                }
                
                // Prepare RPC parameters
                const rpcParams = {
                    p_base_amount: absDifference,
                    p_company_id: companyId,
                    p_created_by: userId,
                    p_description: description,
                    p_entry_date: dateStr,
                    p_lines: lines,
                    p_store_id: currentMakeErrorLocation.store_id || null
                };
                
                console.log('Calling insert_journal_with_everything with params:', rpcParams);
                console.log('Lines structure:', JSON.stringify(lines, null, 2));
                
                // Call RPC
                const { data, error } = await supabase
                    .rpc('insert_journal_with_everything', rpcParams);
                
                if (error) {
                    console.error('RPC Error:', error);
                    console.error('Error details:', error.message, error.details, error.hint);
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showError('Failed to create error entry: ' + error.message);
                    }
                    return;
                }
                
                console.log('Make error entry created successfully:', data);
                
                // Close modal
                closeMakeErrorModal();
                
                // Show success message
                if (typeof TossAlertUtils !== 'undefined') {
                    TossAlertUtils.showSuccess('Error entry created successfully');
                }
                
                // Reload data to reflect changes
                await loadBalanceAndActualAmounts();
                
            } catch (error) {
                console.error('Error in confirmMakeError:', error);
                if (typeof TossAlertUtils !== 'undefined') {
                    TossAlertUtils.showError('Failed to create error entry');
                }
            }
        }

        // Foreign Currency Translation Modal Functions
        let currentExchangeRateLocation = null;
        
        function openExchangeRateModal(locationId) {
            // Find the location data
            const processedLocations = processLocationData();
            const location = processedLocations.find(loc => loc.cash_location_id === locationId);
            
            if (!location) {
                console.error('Location not found:', locationId);
                return;
            }
            
            // Calculate difference
            const balanceAmount = location.balance || 0;
            const actualAmount = location.actual_amount || 0;
            const difference = actualAmount - balanceAmount;
            
            // Store location data for later use
            currentExchangeRateLocation = {
                ...location,
                difference: difference
            };
            
            // Update modal content with location details
            const modalAmount = document.getElementById('exchangeVarianceAmount');
            const modalLocation = document.getElementById('exchangeLocationName');
            
            if (modalAmount) {
                const absDifference = Math.abs(difference);
                const formattedAmount = formatCurrency(absDifference, 'VND');
                modalAmount.textContent = formattedAmount;
            }
            
            if (modalLocation) {
                modalLocation.textContent = location.location_name || 'Unknown Location';
            }
            
            // Show modal
            document.getElementById('exchangeRateModal').style.display = 'flex';
        }
        
        function closeExchangeRateModal() {
            document.getElementById('exchangeRateModal').style.display = 'none';
            currentExchangeRateLocation = null;
        }
        
        async function confirmExchangeRate() {
            try {
                // Check if supabase client is available
                if (!supabase) {
                    console.error('Supabase client not available');
                    return;
                }
                
                // Get company ID and user ID from session/state
                const companyId = appState.getSelectedCompanyId();
                const userData = appState.getUserData();
                
                // Try to get user ID from multiple sources
                let userId = userData?.user_id || userData?.id;
                
                // If not found in userData, get from session
                if (!userId) {
                    const { data: { session } } = await supabase.auth.getSession();
                    userId = session?.user?.id;
                }
                
                if (!companyId || !userId) {
                    console.error('Company ID or User ID not available');
                    console.log('Company ID:', companyId);
                    console.log('User Data:', userData);
                    console.log('User ID:', userId);
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showError('User session not found. Please refresh the page.');
                    }
                    return;
                }
                
                // Get current date in YYYY-MM-DD format
                const today = new Date();
                const dateStr = today.toISOString().split('T')[0];
                
                // Create description
                const description = `Exchange Rate Difference ${dateStr}`;
                
                // Get the difference amount
                const difference = currentExchangeRateLocation.difference || 0;
                const absDifference = Math.abs(difference);
                
                // Exchange Rate account ID (different from Error account)
                const exchangeRateAccountId = "80b311db-f548-46e3-9854-67c5ff6766e8";
                
                // Create journal lines based on difference
                const lines = [];
                
                // Line 1: Cash or Bank account - use hardcoded account ID as per requirement
                const cashAccountId = 'd4a7a16e-45a1-47fe-992b-ff807c8673f0';  // Same as Make Error
                
                if (difference > 0) {
                    // Positive difference: Actual > Balance
                    // Debit the cash/bank account (increase it)
                    lines.push({
                        account_id: cashAccountId,
                        description: description,
                        debit: absDifference,
                        credit: 0,
                        cash: {
                            cash_location_id: currentExchangeRateLocation.cash_location_id
                        }
                    });
                    
                    // Credit the exchange rate account
                    lines.push({
                        account_id: exchangeRateAccountId,
                        description: description,
                        debit: 0,
                        credit: absDifference
                    });
                } else if (difference < 0) {
                    // Negative difference: Actual < Balance
                    // Credit the cash/bank account (reduce it)
                    lines.push({
                        account_id: cashAccountId,
                        description: description,
                        debit: 0,
                        credit: absDifference,
                        cash: {
                            cash_location_id: currentExchangeRateLocation.cash_location_id
                        }
                    });
                    
                    // Debit the exchange rate account
                    lines.push({
                        account_id: exchangeRateAccountId,
                        description: description,
                        debit: absDifference,
                        credit: 0
                    });
                } else {
                    // Difference is 0, this shouldn't happen as button should be disabled
                    console.warn('Exchange Rate called with zero difference');
                    closeExchangeRateModal();
                    return;
                }
                
                // Prepare RPC parameters
                const rpcParams = {
                    p_base_amount: absDifference,
                    p_company_id: companyId,
                    p_created_by: userId,
                    p_description: description,
                    p_entry_date: dateStr,
                    p_lines: lines,
                    p_store_id: currentExchangeRateLocation.store_id || null
                };
                
                console.log('Calling insert_journal_with_everything with params:', rpcParams);
                console.log('Lines structure:', JSON.stringify(lines, null, 2));
                
                // Call RPC
                const { data, error } = await supabase
                    .rpc('insert_journal_with_everything', rpcParams);
                
                if (error) {
                    console.error('RPC Error:', error);
                    console.error('Error details:', error.message, error.details, error.hint);
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showError('Failed to create exchange rate entry: ' + error.message);
                    }
                    return;
                }
                
                console.log('Exchange rate entry created successfully:', data);
                
                // Close modal
                closeExchangeRateModal();
                
                // Show success message
                if (typeof TossAlertUtils !== 'undefined') {
                    TossAlertUtils.showSuccess('Exchange rate entry created successfully');
                }
                
                // Reload data to reflect changes
                await loadBalanceAndActualAmounts();
                
            } catch (error) {
                console.error('Error in confirmExchangeRate:', error);
                if (typeof TossAlertUtils !== 'undefined') {
                    TossAlertUtils.showError('Failed to create exchange rate entry');
                }
            }
        }

        async function saveCashEndingAmounts() {
            // Get all input values from the modal
            const inputs = document.querySelectorAll('#mainCashEndingModal .modal-input-field');
            const amountsToSave = [];
            
            inputs.forEach(input => {
                const locationId = input.dataset.location;
                const value = input.value;
                
                if (value) {
                    amountsToSave.push({
                        cash_location_id: locationId,
                        actual_amount: parseFloat(value)
                    });
                    
                    // Update the corresponding actual amount display in the main interface
                    const actualInput = document.querySelector(`.actual-amount-input-field[data-location-id="${locationId}"]`);
                    if (actualInput) {
                        actualInput.value = formatAmount(parseFloat(value));
                        // Update label to show ACTUAL
                        const parent = actualInput.closest('.actual-card');
                        if (parent) {
                            parent.classList.remove('not-set');
                            const notSetLabel = actualInput.parentElement.querySelector('.not-set-label');
                            if (notSetLabel) {
                                notSetLabel.innerHTML = 'ACTUAL';
                                notSetLabel.style.color = 'var(--toss-success)';
                            }
                        }
                    }
                }
            });
            
            // Here you would normally save to database via Supabase RPC
            // For now, just update the local data
            amountsToSave.forEach(amount => {
                const actualItem = actualData.find(item => item.cash_location_id === amount.cash_location_id);
                if (actualItem) {
                    actualItem.actual_amount = amount.actual_amount;
                    actualItem.last_updated = new Date().toISOString();
                }
            });
            
            // Update the display with new data
            updateCashEndingDisplay();
            
            // Show success message
            if (typeof TossAlertUtils !== 'undefined') {
                TossAlertUtils.showSuccess('Cash ending amounts saved successfully');
            }
            
            // Close the modal
            closeCashEndingModal();
        }

        function updateDifferenceCalculations() {
            // This function would update the difference section
            // Based on balance vs actual values
            console.log('Updating difference calculations...');
        }

        // Cash Ending Data Management
        let currentLocationData = null;
        let cashLocationsData = [];
        let balanceData = [];
        let actualData = [];
        let allStoresData = null; // Store combined data for all stores

        // Load cash locations from Supabase
        async function loadCashLocations() {
            try {
                console.log('=== Loading Cash Locations ===');
                
                // Check if supabase client is available
                if (!supabase) {
                    console.error('Supabase client not available');
                    return;
                }
                
                const selectedCompanyId = appState.getSelectedCompanyId();
                console.log('Selected Company ID:', selectedCompanyId);
                
                if (!selectedCompanyId) {
                    console.error('No company selected - cannot load cash locations');
                    // Show empty state
                    updateCashEndingDisplay();
                    return;
                }

                // Query cash_locations table
                // IMPORTANT: Filter out deleted locations using is_deleted = false
                // This ensures deleted cash locations don't appear in the UI
                console.log('Querying cash_locations table for company:', selectedCompanyId);
                const { data: locations, error: locError } = await supabase
                    .from('cash_locations')
                    .select('cash_location_id, store_id, location_name, location_type')
                    .eq('company_id', selectedCompanyId)
                    .eq('is_deleted', false); // Filter out deleted locations

                if (locError) {
                    console.error('Error loading cash locations:', locError);
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showError('Failed to load cash locations');
                    }
                    return;
                }

                cashLocationsData = locations || [];
                console.log(`Loaded ${cashLocationsData.length} cash locations:`, cashLocationsData);

                // Load balance and actual amounts
                await loadBalanceAndActualAmounts();
            } catch (error) {
                console.error('Error in loadCashLocations:', error);
                if (typeof TossAlertUtils !== 'undefined') {
                    TossAlertUtils.showError('Failed to load cash data');
                }
            }
        }

        // Load balance and actual amounts using RPC
        async function loadBalanceAndActualAmounts(storeId = null) {
            try {
                console.log('=== Loading Balance and Actual Amounts ===');
                
                // Check if supabase client is available
                if (!supabase) {
                    console.error('Supabase client not available');
                    return;
                }
                
                const selectedCompanyId = appState.getSelectedCompanyId();
                console.log('Selected Company ID:', selectedCompanyId);
                console.log('Store ID:', storeId || 'All Stores');
                
                if (!selectedCompanyId) {
                    console.error('No company selected - cannot load balance amounts');
                    return;
                }

                // Prepare RPC parameters
                const params = {
                    p_company_id: selectedCompanyId
                };

                // Only add store_id if specific store is selected
                if (storeId) {
                    params.p_store_id = storeId;
                }

                console.log('Calling RPC get_cash_balance_amounts with params:', params);
                
                // Call RPC to get balance amounts
                const { data: response, error: rpcError } = await supabase
                    .rpc('get_cash_balance_amounts', params);

                if (rpcError) {
                    console.error('RPC Error:', rpcError);
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showError('Failed to load balance amounts');
                    }
                    // Initialize with empty data to prevent errors
                    balanceData = [];
                    actualData = [];
                    updateCashEndingDisplay();
                    return;
                }

                console.log('RPC Response:', response);

                // The RPC returns data directly as {balance: Array, actual: Array}
                // OR it might return {success: true, data: {balance: Array, actual: Array}}
                // Handle both formats
                
                let dataSource = response;
                
                // Check if it's wrapped in success/data structure
                if (response && response.success && response.data) {
                    dataSource = response.data;
                }
                
                // Now extract balance and actual arrays
                if (dataSource && (dataSource.balance || dataSource.actual)) {
                    balanceData = dataSource.balance || [];
                    actualData = dataSource.actual || [];
                    
                    console.log(`Loaded ${balanceData.length} balance records:`, balanceData);
                    console.log(`Loaded ${actualData.length} actual records:`, actualData);

                    // Update UI with loaded data
                    updateCashEndingDisplay();
                } else {
                    console.warn('Unexpected response format from RPC:', response);
                    // Still try to update display with empty data
                    balanceData = [];
                    actualData = [];
                    updateCashEndingDisplay();
                }
            } catch (error) {
                console.error('Error in loadBalanceAndActualAmounts:', error);
                if (typeof TossAlertUtils !== 'undefined') {
                    TossAlertUtils.showError('Failed to load balance data');
                }
                // Initialize with empty data to prevent errors
                balanceData = [];
                actualData = [];
                updateCashEndingDisplay();
            }
        }

        // Update the cash ending display with loaded data
        function updateCashEndingDisplay() {
            // Clear existing content for row-based layout
            const comparisonRows = document.querySelector('.comparison-rows');
            const differenceItems = document.querySelector('.difference-items');
            const differenceSection = document.querySelector('.difference-section');
            const modalLocationsList = document.querySelector('#mainCashEndingModal .cash-locations-list');
            
            if (comparisonRows) comparisonRows.innerHTML = '';
            if (differenceItems) differenceItems.innerHTML = '';
            if (modalLocationsList) modalLocationsList.innerHTML = '';

            // Group and process data
            const processedLocations = processLocationData();

            // Check if there are any locations
            if (processedLocations.length === 0) {
                // Show "No cash locations" message
                const noDataMessage = '<div style="text-align: center; padding: 40px; color: var(--toss-text-tertiary); font-size: 14px;">No cash locations for this store</div>';
                
                if (comparisonRows) {
                    comparisonRows.innerHTML = noDataMessage;
                }
                
                // Hide difference section when no locations
                if (differenceSection) {
                    differenceSection.style.display = 'none';
                }
                
                return;
            }

            // Count differences to determine if we should show the section
            let differenceCount = 0;

            // Populate rows, difference section and modal
            console.log('=== ROW-BASED CREATION DEBUG ===');
            console.log(`Creating rows for ${processedLocations.length} locations`);
            
            processedLocations.forEach((location, index) => {
                console.log(`${index + 1}. Creating row for: ${location.location_name}`);
                
                // Create and add combined row
                if (comparisonRows) {
                    const locationRow = createLocationRow(location);
                    comparisonRows.appendChild(locationRow);
                    console.log(`    Row created for: ${location.location_name}`);
                }

                // Check if there's a difference
                const hasActual = location.actual_amount !== null && location.actual_amount !== undefined && location.actual_amount !== 0;
                const difference = location.actual_amount - location.balance;
                
                // Count differences
                if (!hasActual || difference !== 0) {
                    differenceCount++;
                    
                    // Add to Difference section
                    if (differenceItems) {
                        differenceItems.appendChild(createDifferenceItem(location));
                    }
                }

                // Add to Modal
                if (modalLocationsList) {
                    modalLocationsList.appendChild(createModalLocationRow(location));
                }
            });

            // Show or hide difference section based on whether there are differences
            if (differenceSection) {
                differenceSection.style.display = differenceCount > 0 ? 'block' : 'none';
            }
        }

        // Process and combine location data
        function processLocationData() {
            const locations = [];
            
            // Create a map of all unique locations
            const locationMap = new Map();

            // Process balance data
            balanceData.forEach(item => {
                const key = item.cash_location_id;
                if (!locationMap.has(key)) {
                    locationMap.set(key, {
                        cash_location_id: item.cash_location_id,
                        location_name: item.location_name,
                        store_id: item.store_id,
                        location_type: getLocationTypeFromData(item),
                        balance: item.balance || 0,
                        actual_amount: 0,
                        original_amount: 0,
                        currency_id: null,
                        last_updated: null,
                        updated_by: null
                    });
                } else {
                    locationMap.get(key).balance = item.balance || 0;
                }
            });

            // Process actual data
            actualData.forEach(item => {
                const key = item.cash_location_id;
                if (locationMap.has(key)) {
                    const location = locationMap.get(key);
                    location.actual_amount = item.actual_amount || 0;
                    location.original_amount = item.original_amount || 0;
                    location.currency_id = item.currency_id;
                    location.last_updated = item.last_updated;
                    location.updated_by = item.updated_by;
                } else {
                    // If actual exists but not in balance
                    locationMap.set(key, {
                        cash_location_id: item.cash_location_id,
                        location_name: item.location_name,
                        store_id: item.store_id,
                        location_type: getLocationTypeFromData(item),
                        balance: 0,
                        actual_amount: item.actual_amount || 0,
                        original_amount: item.original_amount || 0,
                        currency_id: item.currency_id,
                        last_updated: item.last_updated,
                        updated_by: item.updated_by
                    });
                }
            });

            // Convert map to array and add location type info
            locationMap.forEach(location => {
                // Find location type from cashLocationsData
                const locInfo = cashLocationsData.find(loc => 
                    loc.cash_location_id === location.cash_location_id
                );
                if (locInfo) {
                    location.location_type = locInfo.location_type;
                }
                locations.push(location);
            });

            // Sort locations first by type (cash  bank  vault) then alphabetically by name
            // This ensures a logical grouping and consistent order
            const sortedLocations = locations.sort((a, b) => {
                // Define priority order: cash=1, bank=2, vault=3, others=999
                const typeOrder = {
                    'cash': 1,
                    'bank': 2,
                    'vault': 3,
                    'transfer': 4  // Add transfer as lower priority if it exists
                };
                
                // Get priority for each location type
                const aTypePriority = typeOrder[a.location_type] || 999;
                const bTypePriority = typeOrder[b.location_type] || 999;
                
                // First sort by location type priority
                if (aTypePriority !== bTypePriority) {
                    return aTypePriority - bTypePriority;
                }
                
                // If same type, sort alphabetically by name
                return a.location_name.localeCompare(b.location_name);
            });
            
            // Debug: Log processed locations to help identify alignment issues
            console.log('=== PROCESSED LOCATIONS DEBUG (SORTED BY TYPE) ===');
            console.log(`Total processed locations: ${sortedLocations.length}`);
            
            // Group by type for clearer debug output
            const groupedByType = {};
            sortedLocations.forEach(loc => {
                if (!groupedByType[loc.location_type]) {
                    groupedByType[loc.location_type] = [];
                }
                groupedByType[loc.location_type].push(loc);
            });
            
            // Log grouped locations
            ['cash', 'bank', 'vault', 'transfer'].forEach(type => {
                if (groupedByType[type] && groupedByType[type].length > 0) {
                    console.log(`\n--- ${type.toUpperCase()} LOCATIONS ---`);
                    groupedByType[type].forEach((loc, index) => {
                        console.log(`  ${index + 1}. ${loc.location_name} | Balance: ${loc.balance} | Actual: ${loc.actual_amount}`);
                    });
                }
            });
            
            // Log any other types that might exist
            Object.keys(groupedByType).forEach(type => {
                if (!['cash', 'bank', 'vault', 'transfer'].includes(type)) {
                    console.log(`\n--- ${type.toUpperCase()} LOCATIONS (OTHER) ---`);
                    groupedByType[type].forEach((loc, index) => {
                        console.log(`  ${index + 1}. ${loc.location_name} | Balance: ${loc.balance} | Actual: ${loc.actual_amount}`);
                    });
                }
            });
            console.log('=== END PROCESSED LOCATIONS DEBUG ===');
            
            return sortedLocations;
        }

        // Get location type and icon
        function getLocationTypeFromData(item) {
            const locInfo = cashLocationsData.find(loc => 
                loc.cash_location_id === item.cash_location_id
            );
            return locInfo ? locInfo.location_type : 'cash';
        }

        function getLocationIcon(locationType) {
            // Compact Toss-style minimalist SVG icons
            switch(locationType) {
                case 'bank': 
                    // Simple bank building
                    return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M12 4L4 8V9H20V8L12 4Z" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <rect x="6" y="10" width="2" height="6" stroke="currentColor" stroke-width="2"/>
                        <rect x="11" y="10" width="2" height="6" stroke="currentColor" stroke-width="2"/>
                        <rect x="16" y="10" width="2" height="6" stroke="currentColor" stroke-width="2"/>
                        <rect x="4" y="17" width="16" height="2" fill="currentColor"/>
                    </svg>`;
                    
                case 'vault': 
                    // Simple safe/vault
                    return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <rect x="5" y="5" width="16" height="16" rx="2" stroke="currentColor" stroke-width="2.5"/>
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                        <circle cx="12" cy="12" r="1" fill="currentColor"/>
                    </svg>`;
                    
                case 'cash': 
                    // Simple coin stack
                    return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <ellipse cx="12" cy="8" rx="6" ry="2.5" stroke="currentColor" stroke-width="2.5"/>
                        <path d="M6 8V12C6 13.1 8.686 14 12 14C15.314 14 18 13.1 18 12V8" stroke="currentColor" stroke-width="2.5"/>
                        <path d="M6 12V16C6 17.1 8.686 18 12 18C15.314 18 18 17.1 18 16V12" stroke="currentColor" stroke-width="2.5"/>
                    </svg>`;
                    
                case 'transfer': 
                    // Simple transfer arrows
                    return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M7 10L3 6L7 2" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3 6H17" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                        <path d="M17 14L21 18L17 22" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M21 18H7" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
                    </svg>`;
                    
                default: 
                    // Default to cash icon
                    return `<svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <ellipse cx="12" cy="8" rx="6" ry="2.5" stroke="currentColor" stroke-width="2.5"/>
                        <path d="M6 8V12C6 13.1 8.686 14 12 14C15.314 14 18 13.1 18 12V8" stroke="currentColor" stroke-width="2.5"/>
                        <path d="M6 12V16C6 17.1 8.686 18 12 18C15.314 18 18 17.1 18 16V12" stroke="currentColor" stroke-width="2.5"/>
                    </svg>`;
            }
        }

        function getIconBackground(locationType) {
            // Toss-style soft, pastel colors with high contrast
            switch(locationType) {
                case 'bank': return '#E3F2FD';  // Soft light blue (similar to Toss lock example)
                case 'vault': return '#FFF3E0';  // Soft light amber/orange
                case 'cash': return '#E8F5E9';   // Soft light green
                case 'transfer': return '#F3E5F5'; // Soft light purple
                default: return '#F5F5F5';       // Soft light gray
            }
        }
        
        // Get text color for icons based on background (for better contrast)
        function getIconTextColor(locationType) {
            // Darker versions of the background colors for high contrast
            switch(locationType) {
                case 'bank': return '#1976D2';    // Medium blue
                case 'vault': return '#F57C00';    // Medium orange
                case 'cash': return '#2E7D32';     // Medium green
                case 'transfer': return '#7B1FA2'; // Medium purple
                default: return '#616161';         // Medium gray
            }
        }

        // Format currency based on currency type
        function formatCurrency(amount, currencySymbol = 'VND') {
            if (amount === null || amount === undefined) {
                return '0';
            }
            
            // For VND, format without decimal places
            if (currencySymbol === 'VND' || currencySymbol === '') {
                return amount.toLocaleString('vi-VN', {
                    style: 'currency',
                    currency: 'VND',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
            }
            
            // For USD or other currencies, use 2 decimal places
            if (currencySymbol === 'USD' || currencySymbol === '$') {
                return amount.toLocaleString('en-US', {
                    style: 'currency',
                    currency: 'USD'
                });
            }
            
            // Default formatting for other currencies
            return amount.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }) + ' ' + currencySymbol;
        }

        // Clear actual amount for a location
        async function clearActualAmount(locationId) {
            try {
                // Find the location in our actual data
                const index = actualData.findIndex(item => item.location_id === locationId);
                if (index !== -1) {
                    // Remove from actual data
                    actualData.splice(index, 1);
                    
                    // Update display
                    updateCashEndingDisplay();
                    
                    // Show success message
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showSuccess('Actual amount cleared');
                    }
                }
            } catch (error) {
                console.error('Error clearing actual amount:', error);
                if (typeof TossAlertUtils !== 'undefined') {
                    TossAlertUtils.showError('Failed to clear actual amount');
                }
            }
        }

        // Create a single row containing both balance and actual information
        function createLocationRow(location) {
            const row = document.createElement('div');
            row.className = 'location-row';
            
            const locationId = location.cash_location_id || location.location_id;
            const hasActual = location.actual_amount !== null && location.actual_amount !== undefined && location.actual_amount !== 0;
            
            // Format amounts
            const balanceFormatted = formatCurrency(location.balance, location.currency_symbol || 'VND');
            let actualFormatted;
            let statusDisplay;
            let statusTag = '';
            
            if (hasActual) {
                actualFormatted = formatCurrency(location.actual_amount, location.currency_symbol || 'VND');
                
                // Format timestamp
                if (location.last_updated) {
                    const lastUpdated = new Date(location.last_updated);
                    const formattedDate = lastUpdated.toLocaleDateString('en-US', { 
                        month: 'short', 
                        day: 'numeric', 
                        year: 'numeric' 
                    });
                    const formattedTime = lastUpdated.toLocaleTimeString('en-US', { 
                        hour: 'numeric', 
                        minute: '2-digit',
                        hour12: true 
                    });
                    statusDisplay = `Last updated: ${formattedDate}, ${formattedTime}`;
                } else {
                    statusDisplay = 'Updated today';
                }
                statusTag = '<span class="status-tag actual">ACTUAL</span>';
            } else {
                actualFormatted = '<span class="amount-placeholder">0</span>';
                statusDisplay = 'Not updated today';
                statusTag = '<span class="status-tag not-set">NOT SET</span>';
            }
            
            // Create balance side
            const balanceSide = document.createElement('div');
            balanceSide.className = 'row-balance';
            balanceSide.innerHTML = `
                <div class="card-icon" style="background: ${getIconBackground(location.location_type)}; color: ${getIconTextColor(location.location_type)}">
                    ${getLocationIcon(location.location_type)}
                </div>
                <div class="card-details">
                    <h4 class="card-name">${location.location_name}</h4>
                    <p class="card-subtitle">From Balance Sheet</p>
                </div>
                <div class="card-amount-wrapper">
                    <div class="card-amount">${balanceFormatted}</div>
                </div>
            `;
            
            // Create actual side
            const actualSide = document.createElement('div');
            actualSide.className = 'row-actual';
            actualSide.innerHTML = `
                <div class="card-icon" style="background: ${getIconBackground(location.location_type)}; color: ${getIconTextColor(location.location_type)}">
                    ${getLocationIcon(location.location_type)}
                </div>
                <div class="card-details">
                    <h4 class="card-name">${location.location_name}</h4>
                    <p class="card-subtitle">${statusDisplay}</p>
                </div>
                <div class="card-amount-wrapper">
                    <div class="card-amount">${actualFormatted}</div>
                    ${statusTag}
                </div>
            `;
            
            // Add click handler to actual side
            actualSide.addEventListener('click', () => {
                openCashInputModal(locationId, location.location_type, location.location_name, location.currency_id);
            });
            
            // Append both sides to row
            row.appendChild(balanceSide);
            row.appendChild(actualSide);
            
            return row;
        }

        // Create unified location row element (combines balance and actual in one row)
        function createUnifiedLocationRow(location) {
            const row = document.createElement('div');
            row.className = 'unified-location-row';
            row.dataset.locationId = location.cash_location_id || location.location_id;
            
            // Get actual amount from our stored data
            const hasActual = location.actual_amount !== null && location.actual_amount !== undefined && location.actual_amount !== 0;
            const actualAmount = hasActual ? location.actual_amount : 0;
            const difference = actualAmount - location.balance;
            
            // Format balance amount
            const balanceFormatted = formatCurrency(location.balance, location.currency_symbol || 'VND');
            
            // Format last updated timestamp
            let lastUpdatedText = '';
            if (location.last_updated && hasActual) {
                const lastUpdated = new Date(location.last_updated);
                const formattedDate = lastUpdated.toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                });
                const formattedTime = lastUpdated.toLocaleTimeString('en-US', { 
                    hour: 'numeric', 
                    minute: '2-digit',
                    hour12: true 
                });
                lastUpdatedText = `Last updated: ${formattedDate}, ${formattedTime}`;
            } else if (!hasActual) {
                lastUpdatedText = 'Not updated today';
            }
            
            // Format actual amount or show input button
            let actualContent;
            if (hasActual) {
                const actualFormatted = formatCurrency(actualAmount, location.currency_symbol || 'VND');
                actualContent = `
                    <div class="actual-amount-display" style="color: var(--toss-text-primary); font-weight: 500;">
                        ${actualFormatted}
                    </div>
                    ${lastUpdatedText ? `<div class="last-updated-text" style="font-size: 11px; color: var(--toss-text-secondary); margin-top: 4px;">${lastUpdatedText}</div>` : ''}
                `;
            } else {
                const locationId = location.cash_location_id || location.location_id;
                actualContent = `
                    <button class="enter-amount-btn" onclick="openCashInputModal('${locationId}', '${location.location_type}', '${location.location_name}', '${location.currency_id}')">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,7V11H7V13H11V17H13V13H17V11H13V7H11Z"/>
                        </svg>
                        Enter Amount
                    </button>
                    ${lastUpdatedText ? `<div class="last-updated-text" style="font-size: 11px; color: var(--toss-text-tertiary); margin-top: 4px;">${lastUpdatedText}</div>` : ''}
                `;
            }
            
            row.innerHTML = `
                <div class="location-info">
                    <div class="card-icon" style="background: ${getIconBackground(location.location_type)}; color: ${getIconTextColor(location.location_type)}">
                        ${getLocationIcon(location.location_type)}
                    </div>
                    <div class="card-details">
                        <h4 class="card-name">${location.location_name}</h4>
                        <p class="card-type">${location.location_type?.toUpperCase() || 'CASH'}</p>
                    </div>
                </div>
                <div class="balance-amount">
                    <div style="color: var(--toss-text-primary); font-weight: 500;">
                        ${balanceFormatted}
                    </div>
                </div>
                <div class="actual-amount">
                    ${actualContent}
                </div>
            `;
            
            return row;
        }

        // Create Balance card element
        function createBalanceCard(location) {
            const card = document.createElement('div');
            card.className = 'location-card';
            card.innerHTML = `
                <div class="card-content">
                    <div class="card-info">
                        <div class="card-icon" style="background: ${getIconBackground(location.location_type)}; color: ${getIconTextColor(location.location_type)}">
                            ${getLocationIcon(location.location_type)}
                        </div>
                        <div class="card-details">
                            <h4 class="card-name">${location.location_name}</h4>
                            <p class="card-type">From Balance Sheet</p>
                        </div>
                    </div>
                    <div class="card-amount">${formatAmount(location.balance)}</div>
                </div>
            `;
            return card;
        }

        // Create Actual card element
        function createActualCard(location) {
            const card = document.createElement('div');
            // Check if actual amount has been set (not null/undefined)
            // 0 is a valid actual amount
            const hasActual = location.actual_amount !== null && location.actual_amount !== undefined;
            card.className = hasActual ? 'actual-card' : 'actual-card not-set';
            const lastUpdatedText = location.last_updated ? 
                `Last updated: ${formatDateTime(location.last_updated)}` : 
                'Not updated today';

            card.innerHTML = `
                <div class="card-content">
                    <div class="card-info">
                        <div class="card-icon" style="background: ${getIconBackground(location.location_type)}; color: ${getIconTextColor(location.location_type)}">
                            ${getLocationIcon(location.location_type)}
                        </div>
                        <div class="card-details">
                            <h4 class="card-name">${location.location_name}</h4>
                            <p class="card-type">${lastUpdatedText}</p>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <div class="actual-amount-display" style="font-size: 20px; font-weight: 600; color: var(--toss-text-primary); margin-bottom: 4px;">
                            ${hasActual ? '' + formatAmount(location.actual_amount) : '0'}
                        </div>
                        ${!hasActual ? '<div class="not-set-label">NOT SET</div>' : '<div class="not-set-label" style="color: var(--toss-success);">ACTUAL</div>'}
                    </div>
                </div>
            `;
            return card;
        }

        // Create Difference item element
        function createDifferenceItem(location) {
            const difference = location.actual_amount - location.balance;
            // Check if actual amount has been set (not null/undefined)
            // 0 is a valid actual amount
            const hasActual = location.actual_amount !== null && location.actual_amount !== undefined;
            
            const item = document.createElement('div');
            item.className = 'difference-item';
            
            let differenceClass = '';
            let differenceText = '';
            let buttonsDisabled = false;
            
            if (!hasActual) {
                differenceText = 'Pending Entry';
                differenceClass = 'style="color: var(--toss-warning);"';
            } else if (difference > 0) {
                differenceClass = 'class="difference-amount positive"';
                differenceText = `+${formatCurrency(Math.abs(difference), location.currency_symbol || 'VND')}`;
            } else if (difference < 0) {
                differenceClass = 'class="difference-amount negative"';
                differenceText = `-${formatCurrency(Math.abs(difference), location.currency_symbol || 'VND')}`;
            } else {
                // difference is 0 - disable buttons
                differenceClass = 'class="difference-amount zero"';
                differenceText = formatCurrency(0, location.currency_symbol || 'VND');
                buttonsDisabled = true;
            }

            const disabledAttr = buttonsDisabled ? 'disabled' : '';
            const disabledClass = buttonsDisabled ? ' disabled' : '';

            item.innerHTML = `
                <div class="difference-location-name">${location.location_name}</div>
                <div class="difference-amount-actions">
                    <div ${differenceClass}>${differenceText}</div>
                    <div class="action-buttons-simple">
                        <button class="action-btn-simple error-btn-simple${disabledClass}" 
                                data-location-id="${location.cash_location_id}" 
                                ${disabledAttr}>
                             Make Error
                        </button>
                        <button class="action-btn-simple exchange-btn-simple${disabledClass}" 
                                data-location-id="${location.cash_location_id}"
                                ${disabledAttr}>
                             Foreign Currency Translation
                        </button>
                    </div>
                </div>
            `;
            return item;
        }

        // Create Modal location row
        function createModalLocationRow(location) {
            const row = document.createElement('div');
            row.className = 'location-input-row';
            
            // Check if actual amount has been set (not null/undefined)
            // 0 is a valid actual amount
            const hasActual = location.actual_amount !== null && location.actual_amount !== undefined;
            const inputValue = hasActual ? location.actual_amount : '';

            row.innerHTML = `
                <div class="location-info-modal">
                    <div class="location-icon-modal" style="background: ${getIconBackground(location.location_type)}; color: ${getIconTextColor(location.location_type)}">
                        ${getLocationIcon(location.location_type)}
                    </div>
                    <div>
                        <div class="location-name-modal">${location.location_name}</div>
                        <div class="location-type-modal">${location.location_type}</div>
                    </div>
                </div>
                <div class="location-input-group">
                    <label>Actual Amount</label>
                    <input type="number" step="0.01" 
                           class="modal-input-field" 
                           placeholder="Enter amount" 
                           value="${inputValue}"
                           data-location="${location.cash_location_id}">
                </div>
            `;
            return row;
        }

        // Format amount with thousands separator
        function formatAmount(amount) {
            if (amount === null || amount === undefined) return '0';
            return Math.abs(amount).toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }

        // Format date time
        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Bank location currency functions
        function populateBankCurrencies() {
            console.log('=== Populating Bank Currencies ===');
            const currencySelect = document.getElementById('bankCurrencySelect');
            if (!currencySelect) {
                console.error('Bank currency select element not found');
                return;
            }
            
            // Clear existing options except the first one
            currencySelect.innerHTML = '<option value="">Select Currency...</option>';
            
            console.log('Available currency types:', currencyTypes);
            
            if (!currencyTypes || currencyTypes.length === 0) {
                console.warn('No currency types available for bank');
                const noDataOption = document.createElement('option');
                noDataOption.value = '';
                noDataOption.textContent = 'No currencies available';
                noDataOption.disabled = true;
                currencySelect.appendChild(noDataOption);
                return;
            }
            
            // Add options for each company currency
            currencyTypes.forEach(currency => {
                const option = document.createElement('option');
                option.value = currency.currency_id;
                option.textContent = `${currency.currency_code} - ${currency.currency_name}`;
                option.dataset.symbol = currency.currency_symbol || '';
                option.dataset.code = currency.currency_code;
                currencySelect.appendChild(option);
                
                console.log(`Added currency option: ${currency.currency_code} (${currency.currency_id})`);
            });
            
            console.log('Bank currencies populated successfully');
        }
        
        // Handle bank currency selection change
        function onBankCurrencyChange() {
            console.log('=== Bank Currency Changed ===');
            const currencySelect = document.getElementById('bankCurrencySelect');
            const selectedOption = currencySelect.options[currencySelect.selectedIndex];
            const currencySymbol = document.getElementById('bankCurrencySymbol');
            const amountInput = document.getElementById('bankAmountInput');
            
            if (!selectedOption || !selectedOption.value) {
                // No currency selected
                if (currencySymbol) {
                    currencySymbol.textContent = ''; // Default symbol
                }
                if (amountInput) {
                    amountInput.placeholder = '0';
                }
                console.log('No currency selected, using defaults');
                return;
            }
            
            const symbol = selectedOption.dataset.symbol || '';
            const code = selectedOption.dataset.code || '';
            
            // Update currency symbol
            if (currencySymbol) {
                currencySymbol.textContent = symbol;
            }
            
            // Update placeholder
            if (amountInput) {
                amountInput.placeholder = `0`;
            }
            
            console.log(`Currency selected: ${selectedOption.textContent}`);
            console.log(`Symbol: ${symbol}, Code: ${code}`);
            
            // Update total display if amount is already entered
            updateBankTotal();
        }
        
        // Update bank total display (similar to denomination total but simpler)
        function updateBankTotal() {
            const amountInput = document.getElementById('bankAmountInput');
            const totalElement = document.getElementById('modalTotalAmount');
            const currencySelect = document.getElementById('bankCurrencySelect');
            
            if (!amountInput || !totalElement) {
                return;
            }
            
            const amount = parseFloat(amountInput.value) || 0;
            let symbol = ''; // default
            
            // Get selected currency symbol
            if (currencySelect && currencySelect.selectedIndex > 0) {
                const selectedOption = currencySelect.options[currencySelect.selectedIndex];
                symbol = selectedOption.dataset.symbol || '';
            }
            
            // Update total display
            if (amount > 0) {
                totalElement.textContent = `${symbol}${formatAmount(amount)}`;
            } else {
                totalElement.textContent = `${symbol}0`;
            }
            
            console.log(`Bank total updated: ${symbol}${formatAmount(amount)}`);
        }

        function initializeCashEndingInteractions() {
            // This will be called after data is loaded

            // Add event listeners to enter amount buttons
            const enterAmountBtns = document.querySelectorAll('.enter-amount-btn');
            enterAmountBtns.forEach((btn) => {
                btn.addEventListener('click', (e) => {
                    const locationType = e.target.dataset.locationType;
                    const locationId = e.target.dataset.locationId;
                    // Find location from processed data
                    const processedLocations = processLocationData();
                    const locationData = processedLocations.find(loc => loc.cash_location_id === locationId);
                    
                    openEntryModal(locationType, locationData);
                });
            });

            // Add event listeners to error and exchange rate buttons
            const errorBtns = document.querySelectorAll('.error-btn');
            const exchangeBtns = document.querySelectorAll('.exchange-btn');
            
            errorBtns.forEach((btn, index) => {
                btn.addEventListener('click', () => handleErrorAction(cashLocations[index]));
            });
            
            exchangeBtns.forEach((btn, index) => {
                btn.addEventListener('click', () => handleExchangeRateAction(cashLocations[index]));
            });

            // Add modal input event listeners
            setupModalEventListeners();
            
            // Add event listener for main cash ending modal
            const mainModal = document.getElementById('mainCashEndingModal');
            if (mainModal) {
                mainModal.addEventListener('click', (e) => {
                    if (e.target === mainModal) {
                        closeCashEndingModal();
                    }
                });
            }
            
            // Add event listener for Make Error buttons
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('error-btn-simple') && !e.target.disabled) {
                    const locationId = e.target.dataset.locationId;
                    openMakeErrorModal(locationId);
                }
            });
            
            // Add event listener for Make Error modal overlay
            const makeErrorModal = document.getElementById('makeErrorModal');
            if (makeErrorModal) {
                makeErrorModal.addEventListener('click', (e) => {
                    if (e.target === makeErrorModal) {
                        closeMakeErrorModal();
                    }
                });
            }
            
            // Add event listener for Foreign Currency Translation buttons
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('exchange-btn-simple') && !e.target.disabled) {
                    const locationId = e.target.dataset.locationId;
                    openExchangeRateModal(locationId);
                }
            });
            
            // Add event listener for Exchange Rate modal overlay
            const exchangeRateModal = document.getElementById('exchangeRateModal');
            if (exchangeRateModal) {
                exchangeRateModal.addEventListener('click', (e) => {
                    if (e.target === exchangeRateModal) {
                        closeExchangeRateModal();
                    }
                });
            }
            
            // ESC key handler for main modal
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && mainModal && mainModal.classList.contains('active')) {
                    closeCashEndingModal();
                }
            });
            
            console.log('Cash ending modal system initialized');
        }

        function openEntryModal(locationType, locationData) {
            currentLocationData = locationData;
            
            switch (locationType) {
                case 'cash':
                    openCashModal(locationData);
                    break;
                case 'vault':
                    openVaultModal(locationData);
                    break;
                case 'bank':
                    openBankModal(locationData);
                    break;
                default:
                    console.error('Unknown location type:', locationType);
            }
        }

        // Cash Register Modal Functions
        function openCashModal(locationData) {
            document.getElementById('cashModalIcon').textContent = locationData.icon;
            document.getElementById('cashModalTitle').textContent = `Count ${locationData.name}`;
            
            // Reset all inputs
            const inputs = document.querySelectorAll('#cashModal .denomination-input');
            inputs.forEach(input => {
                input.value = 0;
                updateDenominationValue(input);
            });
            
            document.getElementById('cashModal').classList.add('active');
            updateCashTotal();
        }

        function closeCashModal() {
            document.getElementById('cashModal').classList.remove('active');
        }

        function updateDenominationValue(input) {
            const count = parseInt(input.value) || 0;
            const value = parseFloat(input.dataset.value);
            const total = count * value;
            
            const valueDisplay = input.parentElement.querySelector('.denomination-value');
            valueDisplay.textContent = `$${total.toFixed(2)}`;
            
            updateCashTotal();
        }

        function updateCashTotal() {
            const inputs = document.querySelectorAll('#cashModal .denomination-input');
            let total = 0;
            
            inputs.forEach(input => {
                const count = parseInt(input.value) || 0;
                const value = parseFloat(input.dataset.value);
                total += count * value;
            });
            
            document.getElementById('cashTotal').textContent = `$${total.toFixed(2)}`;
        }

        function saveCashCount() {
            const total = parseFloat(document.getElementById('cashTotal').textContent.replace('$', ''));
            updateLocationActual(currentLocationData.id, total);
            closeCashModal();
        }

        // Vault Modal Functions
        function openVaultModal(locationData) {
            document.getElementById('vaultModalIcon').textContent = locationData.icon;
            document.getElementById('vaultModalTitle').textContent = `Count ${locationData.name}`;
            
            // Reset all inputs
            const inputs = document.querySelectorAll('#vaultModal .bulk-input');
            inputs.forEach(input => input.value = '');
            
            document.getElementById('vaultModal').classList.add('active');
            updateVaultTotal();
        }

        function closeVaultModal() {
            document.getElementById('vaultModal').classList.remove('active');
        }

        function updateVaultTotal() {
            const inputs = document.querySelectorAll('#vaultModal .bulk-input');
            let total = 0;
            
            inputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                total += value;
            });
            
            document.getElementById('vaultTotal').textContent = `$${total.toFixed(2)}`;
        }

        function saveVaultCount() {
            const total = parseFloat(document.getElementById('vaultTotal').textContent.replace('$', ''));
            updateLocationActual(currentLocationData.id, total);
            closeVaultModal();
        }

        // Bank Modal Functions
        function openBankModal(locationData) {
            document.getElementById('bankModalIcon').textContent = locationData.icon;
            document.getElementById('bankModalTitle').textContent = `Bank Entry - ${locationData.name}`;
            
            // Reset form
            document.getElementById('bankTransactionType').value = 'deposit';
            document.getElementById('bankAmount').value = '';
            document.getElementById('bankReference').value = '';
            document.getElementById('bankNotes').value = '';
            
            document.getElementById('bankModal').classList.add('active');
            updateBankTotal();
        }

        function closeBankModal() {
            document.getElementById('bankModal').classList.remove('active');
        }

        function updateBankTotal() {
            const amount = parseFloat(document.getElementById('bankAmount').value) || 0;
            document.getElementById('bankTotal').textContent = `$${amount.toFixed(2)}`;
        }

        function saveBankTransaction() {
            const amount = parseFloat(document.getElementById('bankAmount').value) || 0;
            updateLocationActual(currentLocationData.id, amount);
            closeBankModal();
        }

        // Universal update function
        function updateLocationActual(locationId, actualAmount) {
            const rows = document.querySelectorAll('.cash-location-row');
            
            rows.forEach(row => {
                const btn = row.querySelector('.enter-amount-btn');
                if (btn && btn.dataset.locationId === locationId) {
                    const actualDisplay = row.querySelector('.actual-amount-display');
                    const differenceDisplay = row.querySelector('.difference-display');
                    const balanceAmount = parseFloat(row.querySelector('.balance-amount').textContent.replace('$', ''));
                    
                    // Update actual amount display
                    actualDisplay.textContent = `$${actualAmount.toFixed(2)}`;
                    actualDisplay.classList.remove('pending');
                    
                    // Update button
                    btn.textContent = 'Update Count';
                    btn.classList.remove('pending');
                    
                    // Calculate and update difference
                    const difference = actualAmount - balanceAmount;
                    
                    if (Math.abs(difference) < 0.01) {
                        differenceDisplay.className = 'difference-display difference-zero';
                        differenceDisplay.textContent = '$0.00';
                    } else if (difference > 0) {
                        differenceDisplay.className = 'difference-display difference-positive';
                        differenceDisplay.textContent = `+$${Math.abs(difference).toFixed(2)}`;
                    } else {
                        differenceDisplay.className = 'difference-display difference-negative';
                        differenceDisplay.textContent = `-$${Math.abs(difference).toFixed(2)}`;
                    }
                }
            });
        }

        function setupModalEventListeners() {
            // Cash modal denomination inputs
            document.querySelectorAll('#cashModal .denomination-input').forEach(input => {
                input.addEventListener('input', () => updateDenominationValue(input));
            });
            
            // Vault modal bulk inputs
            document.querySelectorAll('#vaultModal .bulk-input').forEach(input => {
                input.addEventListener('input', updateVaultTotal);
            });
            
            // Bank modal amount input
            document.getElementById('bankAmount').addEventListener('input', updateBankTotal);
            
            // Close modals when clicking outside
            document.querySelectorAll('.cash-entry-modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('active');
                    }
                });
            });
        }

        function handleErrorAction(locationData) {
            console.log(`Error button clicked for ${locationData.name}`);
            alert(`Report error for ${locationData.name}?\n\nThis would open an error reporting form for discrepancy investigation.`);
        }

        function handleExchangeRateAction(locationData) {
            console.log(`Exchange Rate button clicked for ${locationData.name}`);
            alert(`Apply exchange rate for ${locationData.name}?\n\nThis would open exchange rate calculator for foreign currency adjustments.`);
        }

        class CashEndingPage {
            constructor() {
                this.supabase = supabase; // The global supabase client instance from supabase.js
                this.appState = window.appState;
                this.currentStoreFilter = null; // null means "All Stores"
                // Don't call init in constructor - let it be called explicitly
            }

            async init() {
                // Wait for app state to be ready with custom waiting logic
                console.log('Cash Ending page init started');
                await this.waitForAppState();
                
                // Log initialization state
                console.log('Cash Ending page init - appState available:', !!this.appState);
                if (this.appState && typeof this.appState.getCompanyStores === 'function') {
                    const stores = this.appState.getCompanyStores();
                    console.log('Stores available during init:', stores);
                } else {
                    console.warn('appState.getCompanyStores not available during init');
                }
                
                this.setupEventListeners();
                this.updateStoreFilter();
                
                // Load cash locations and balance data
                await loadCashLocations();
                
                // Initialize cash ending interactions after data is loaded
                initializeCashEndingInteractions();
                
                console.log('Cash Ending page initialized successfully');
            }

            async waitForAppState() {
                let retries = 0;
                const maxRetries = 20; // 10 seconds total (500ms * 20)
                
                while (retries < maxRetries) {
                    // Check if appState is available and has the necessary methods and data
                    if (typeof appState !== 'undefined' && 
                        appState.getUserData && 
                        appState.getCompanyStores &&
                        appState.getSelectedCompanyId) {
                        
                        const userData = appState.getUserData();
                        if (userData && userData.companies && userData.companies.length > 0) {
                            console.log('AppState ready with user data');
                            return;
                        }
                    }
                    
                    console.log('Waiting for appState to be ready, retry:', retries);
                    await new Promise(resolve => setTimeout(resolve, 500));
                    retries++;
                }
                
                console.warn('AppState did not become ready after', maxRetries, 'retries');
            }

            setupEventListeners() {
                // Store filter control
                const storeFilterControl = document.getElementById('storeFilterControl');
                if (storeFilterControl) {
                    console.log('Store filter control found, adding click listener');
                    storeFilterControl.addEventListener('click', async (e) => {
                        console.log('Store filter control clicked');
                        e.stopPropagation();
                        await this.toggleStoreFilterDropdown();
                    });
                } else {
                    console.error('Store filter control element not found');
                }

                if (storeFilterControl) {
                    storeFilterControl.addEventListener('keydown', async (e) => {
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            await this.toggleStoreFilterDropdown();
                        } else if (e.key === 'Escape') {
                            this.hideStoreFilterDropdown();
                        }
                    });
                }

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.control-section') && !e.target.closest('.store-filter-dropdown')) {
                        this.hideStoreFilterDropdown();
                    }
                });

                // Close dropdown on escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.hideStoreFilterDropdown();
                    }
                });

                // Listen for app state changes using event listeners
                window.addEventListener('companyChanged', (event) => {
                    console.log('Company changed event received:', event.detail);
                    this.updateStoreFilter();
                    // Reload cash locations when company changes
                    loadCashLocations();
                });

                window.addEventListener('storeChanged', (event) => {
                    console.log('Store changed event received:', event.detail);
                    this.updateStoreFilter();
                    // Reload balance amounts when store changes
                    const storeId = event.detail?.storeId || null;
                    loadBalanceAndActualAmounts(storeId);
                });
            }

            updateStoreFilter() {
                console.log('updateStoreFilter called');
                console.log('App state available:', !!this.appState);
                
                const storeFilterLabel = document.getElementById('storeFilterLabel');
                const storeFilterIndicator = document.getElementById('storeFilterIndicator');

                if (!storeFilterLabel || !storeFilterIndicator) {
                    console.error('Store filter elements not found');
                    return;
                }

                // Update store filter label using app state stores
                if (this.currentStoreFilter) {
                    let stores = [];
                    
                    // Try to get stores from appState - multiple approaches
                    if (typeof appState !== 'undefined' && typeof appState.getCompanyStores === 'function') {
                        stores = appState.getCompanyStores();
                        console.log('Stores from appState.getCompanyStores():', stores);
                    } else if (typeof appState !== 'undefined' && appState.getUserData) {
                        // Try getting from user data
                        const userData = appState.getUserData();
                        if (userData && userData.companies) {
                            const selectedCompanyId = appState.getSelectedCompanyId();
                            const selectedCompany = userData.companies.find(c => c.company_id === selectedCompanyId);
                            if (selectedCompany && selectedCompany.stores) {
                                stores = selectedCompany.stores;
                                console.log('Stores from userData.companies.stores:', stores);
                            }
                        }
                    }
                    
                    if (!stores || stores.length === 0) {
                        console.warn('appState stores not available');
                    }
                    
                    const store = stores.find(s => s.store_id === this.currentStoreFilter);
                    storeFilterLabel.textContent = store ? store.store_name : 'Unknown Store';
                    storeFilterIndicator.classList.add('active');
                } else {
                    storeFilterLabel.textContent = 'All Stores';
                    storeFilterIndicator.classList.remove('active');
                }
                
                console.log('Store filter updated:', storeFilterLabel.textContent);
            }

            async toggleStoreFilterDropdown() {
                console.log('toggleStoreFilterDropdown called');
                const dropdown = document.getElementById('storeFilterDropdown');
                
                if (!dropdown) {
                    console.error('Dropdown element not found');
                    return;
                }
                
                if (dropdown.classList.contains('active')) {
                    console.log('Hiding dropdown');
                    this.hideStoreFilterDropdown();
                } else {
                    console.log('Showing dropdown');
                    await this.showStoreFilterDropdown();
                }
            }

            async showStoreFilterDropdown(retryCount = 0) {
                console.log('showStoreFilterDropdown called, retry count:', retryCount);
                const storeFilterDropdown = document.getElementById('storeFilterDropdown');
                const storeFilterControl = document.getElementById('storeFilterControl');
                const storeFilterOptions = document.getElementById('storeFilterOptions');

                if (!storeFilterDropdown || !storeFilterControl || !storeFilterOptions) {
                    console.error('Store filter dropdown elements not found');
                    return;
                }

                // Get stores from app state with retry mechanism
                let stores = [];
                
                // Try multiple ways to get stores data with detailed logging
                console.log('=== Store Loading Debug (retry:', retryCount, ') ===');
                console.log('appState available:', typeof appState !== 'undefined');
                console.log('appState.getCompanyStores available:', typeof appState !== 'undefined' && typeof appState.getCompanyStores === 'function');
                console.log('appState.getUserData available:', typeof appState !== 'undefined' && typeof appState.getUserData === 'function');
                
                // Debug appState chain step by step
                if (typeof appState !== 'undefined') {
                    console.log('=== DEBUGGING APPSTATE CHAIN ===');
                    
                    // Step 1: Check getUserData()
                    const userData = appState.getUserData();
                    console.log('1. getUserData():', userData);
                    
                    // Step 2: Check getSelectedCompanyId()
                    const selectedCompanyId = appState.getSelectedCompanyId();
                    console.log('2. getSelectedCompanyId():', selectedCompanyId);
                    
                    // Step 3: Check if userData has companies
                    if (userData) {
                        console.log('3. userData.companies:', userData.companies);
                        console.log('3. userData.companies length:', userData.companies ? userData.companies.length : 'null/undefined');
                    }
                    
                    // Step 4: Find selected company
                    if (userData && userData.companies && selectedCompanyId) {
                        const selectedCompany = userData.companies.find(c => c.company_id === selectedCompanyId);
                        console.log('4. selectedCompany:', selectedCompany);
                        if (selectedCompany) {
                            console.log('4. selectedCompany.stores:', selectedCompany.stores);
                            console.log('4. selectedCompany.stores length:', selectedCompany.stores ? selectedCompany.stores.length : 'null/undefined');
                        }
                    }
                    
                    // Step 5: Try getCompanyStores()
                    stores = appState.getCompanyStores();
                    console.log('5. Final getCompanyStores():', stores);
                    
                    // Step 6: If still empty, try direct localStorage access
                    if (!stores || stores.length === 0) {
                        console.log('6. Trying direct localStorage access...');
                        const localStorageUser = localStorage.getItem('user');
                        console.log('6. localStorage user raw:', localStorageUser);
                        
                        if (localStorageUser) {
                            try {
                                const parsedUser = JSON.parse(localStorageUser);
                                console.log('6. Parsed user data:', parsedUser);
                                
                                const companyId = localStorage.getItem('companyChoosen');
                                console.log('6. Company chosen from localStorage:', companyId);
                                
                                if (parsedUser.companies && companyId) {
                                    const company = parsedUser.companies.find(c => c.company_id === companyId);
                                    if (company && company.stores) {
                                        stores = company.stores;
                                        console.log('6. Found stores via direct localStorage:', stores);
                                    }
                                }
                            } catch (e) {
                                console.error('6. Error parsing localStorage user:', e);
                            }
                        }
                    }
                } else if (typeof appState !== 'undefined' && appState.getUserData) {
                    // Try getting from user data
                    const userData = appState.getUserData();
                    console.log('UserData:', userData);
                    if (userData && userData.companies) {
                        const selectedCompanyId = appState.getSelectedCompanyId();
                        console.log('Selected company ID:', selectedCompanyId);
                        const selectedCompany = userData.companies.find(c => c.company_id === selectedCompanyId);
                        console.log('Selected company:', selectedCompany);
                        if (selectedCompany && selectedCompany.stores) {
                            stores = selectedCompany.stores;
                            console.log('Stores from userData.companies.stores:', stores);
                        } else {
                            console.warn('No stores in selected company');
                        }
                    } else {
                        console.warn('No companies in userData');
                    }
                } else {
                    console.warn('appState not available or missing methods');
                }
                
                // If no stores found and we haven't retried enough times, try again with delay
                if ((!stores || stores.length === 0) && retryCount < 3) {
                    console.warn('=== No stores found in app state, retrying in', (retryCount + 1) * 500, 'ms ===');
                    setTimeout(() => {
                        this.showStoreFilterDropdown(retryCount + 1);
                    }, (retryCount + 1) * 500); // Increasing delay: 500ms, 1000ms, 1500ms
                    return;
                }
                
                if (!stores || stores.length === 0) {
                    console.warn('=== No stores found in app state after', retryCount, 'retries ===');
                    console.log('Final stores array:', stores);
                    
                    // Try to load from page initialization if still no stores
                    if (typeof window.initializePage === 'function' && retryCount >= 2) {
                        console.log('Attempting to reinitialize page data...');
                        try {
                            // Wait a bit and try to get fresh data
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            if (typeof appState !== 'undefined' && appState.getUserData) {
                                const userData = appState.getUserData();
                                if (userData && userData.companies) {
                                    const selectedCompanyId = appState.getSelectedCompanyId();
                                    const selectedCompany = userData.companies.find(c => c.company_id === selectedCompanyId);
                                    if (selectedCompany && selectedCompany.stores) {
                                        stores = selectedCompany.stores;
                                        console.log('Stores found after reinitialization:', stores);
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn('Failed to reinitialize page data:', error);
                        }
                    }
                }
                
                // Build options HTML
                let optionsHTML = `
                    <input 
                        type="text" 
                        placeholder="Search stores..." 
                        class="store-filter-search" 
                        id="storeFilterSearch" 
                        autocomplete="off"
                    >
                    <div class="store-filter-divider"></div>
                `;

                // Add "All Stores" option
                optionsHTML += `
                    <div class="store-filter-dropdown-option${!this.currentStoreFilter ? ' selected' : ''}" data-store-filter="">
                        <svg class="store-filter-dropdown-option-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19Z"/>
                        </svg>
                        <span class="store-filter-dropdown-option-text">All Stores</span>
                        ${!this.currentStoreFilter ? '<svg class="store-filter-dropdown-option-check" fill="currentColor" viewBox="0 0 24 24"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg>' : ''}
                    </div>
                `;

                // Add store options
                if (stores && stores.length > 0) {
                    stores.forEach(store => {
                        const isSelected = store.store_id === this.currentStoreFilter;
                        optionsHTML += `
                            <div class="store-filter-dropdown-option${isSelected ? ' selected' : ''}" data-store-filter="${store.store_id}">
                                <svg class="store-filter-dropdown-option-icon" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75Z"/>
                                </svg>
                                <span class="store-filter-dropdown-option-text">${store.store_name}</span>
                                ${isSelected ? '<svg class="store-filter-dropdown-option-check" fill="currentColor" viewBox="0 0 24 24"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg>' : ''}
                            </div>
                        `;
                    });
                } else {
                    console.warn('No stores found in app state');
                }

                storeFilterOptions.innerHTML = optionsHTML;
                console.log('Store filter options HTML updated');

                // Setup search functionality
                const searchInput = document.getElementById('storeFilterSearch');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const options = storeFilterOptions.querySelectorAll('.store-filter-dropdown-option');
                        
                        options.forEach(option => {
                            const text = option.querySelector('.store-filter-dropdown-option-text').textContent.toLowerCase();
                            if (text.includes(searchTerm)) {
                                option.style.display = 'flex';
                            } else {
                                option.style.display = 'none';
                            }
                        });
                    });
                }

                // Setup option click handlers
                storeFilterOptions.querySelectorAll('.store-filter-dropdown-option').forEach((option, index) => {
                    option.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const storeFilter = option.dataset.storeFilter;
                        this.currentStoreFilter = storeFilter || null;

                        this.updateStoreFilter();
                        this.hideStoreFilterDropdown();

                        console.log('Store filter changed to:', this.currentStoreFilter);
                        
                        // Reload balance and actual data for the selected store
                        await loadBalanceAndActualAmounts(this.currentStoreFilter);
                    });
                });

                storeFilterDropdown.classList.add('active');
                storeFilterControl.classList.add('dropdown-open');
                console.log('Store filter dropdown activated');

                // Focus search input
                setTimeout(() => {
                    if (searchInput) {
                        searchInput.focus();
                    }
                }, 100);
            }

            hideStoreFilterDropdown() {
                const storeFilterDropdown = document.getElementById('storeFilterDropdown');
                const storeFilterControl = document.getElementById('storeFilterControl');
                storeFilterDropdown.classList.remove('active');
                storeFilterControl.classList.remove('dropdown-open');
            }
        }

        // Initialize page
        let cashEndingPage;
        
        // Helper function to ensure appState is ready with data
        async function ensureAppStateReady() {
            try {
                console.log('=== Ensuring appState is ready ===');
                
                // Check if appState exists
                if (typeof appState === 'undefined') {
                    console.error('appState is not defined');
                    return false;
                }
                
                // Check if appState has the required methods
                if (!appState.getUserData || !appState.getCompanyStores || !appState.getSelectedCompanyId) {
                    console.error('appState is missing required methods');
                    return false;
                }
                
                // Check if user data exists
                let userData = appState.getUserData();
                if (!userData) {
                    console.log('No user data in appState, trying to load from localStorage...');
                    
                    // Try to load from localStorage directly
                    const storedData = localStorage.getItem('user');
                    if (storedData) {
                        try {
                            userData = JSON.parse(storedData);
                            console.log('Loaded user data from localStorage');
                        } catch (e) {
                            console.error('Failed to parse stored user data:', e);
                        }
                    }
                    
                    // If still no data, try to fetch it
                    if (!userData) {
                        console.log('No user data found, attempting to fetch...');
                        await ensureUserData();
                        userData = appState.getUserData();
                    }
                }
                
                // Check if we have companies and stores
                if (!userData || !userData.companies || userData.companies.length === 0) {
                    console.error('No companies found in user data');
                    return false;
                }
                
                // Check if a company is selected
                const selectedCompanyId = appState.getSelectedCompanyId();
                if (!selectedCompanyId) {
                    console.log('No company selected, selecting first company...');
                    if (userData.companies.length > 0) {
                        appState.setSelectedCompanyId(userData.companies[0].company_id);
                    }
                }
                
                // Verify stores are available
                const stores = appState.getCompanyStores();
                console.log(`appState ready with ${stores?.length || 0} stores`);
                
                return true;
                
            } catch (error) {
                console.error('Error ensuring appState ready:', error);
                return false;
            }
        }
        
        // Helper function to ensure user data exists
        async function ensureUserData() {
            try {
                console.log('=== Ensuring User Data ===');
                
                // Check if user data exists
                let userData = appState.getUserData();
                console.log('Current user data:', userData);
                
                // If no companies, try to fetch them
                if (!userData || !userData.companies || userData.companies.length === 0) {
                    console.log('No companies found, fetching from Supabase...');
                    
                    // Get current session
                    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
                    
                    if (sessionError || !session) {
                        console.error('No session found:', sessionError);
                        return;
                    }
                    
                    console.log('Session user ID:', session.user.id);
                    
                    // Call RPC to get user companies - try without parameter first
                    console.log('Calling RPC get_user_companies_and_stores...');
                    const { data: rpcData, error: rpcError } = await supabase.rpc('get_user_companies_and_stores');
                    
                    if (rpcError) {
                        console.error('RPC Error (no param):', rpcError);
                        
                        // Try with user_id parameter
                        console.log('Trying RPC with user_id parameter...');
                        const { data: rpcData2, error: rpcError2 } = await supabase.rpc('get_user_companies_and_stores', {
                            p_user_id: session.user.id
                        });
                        
                        if (rpcError2) {
                            console.error('RPC Error (with param):', rpcError2);
                        } else if (rpcData2) {
                            console.log('RPC Success (with param):', rpcData2);
                            handleUserData(rpcData2);
                        }
                    } else if (rpcData) {
                        console.log('RPC Success (no param):', rpcData);
                        handleUserData(rpcData);
                    }
                } else {
                    console.log('User data with companies already exists:', userData.companies.length);
                }
            } catch (error) {
                console.error('Error ensuring user data:', error);
            }
        }
        
        function handleUserData(rpcData) {
            // Store the data
            appState.setUserData(rpcData);
            localStorage.setItem('user', JSON.stringify(rpcData));
            
            // Set first company if available
            if (rpcData.companies && rpcData.companies.length > 0) {
                const firstCompany = rpcData.companies[0];
                appState.setSelectedCompanyId(firstCompany.company_id);
                
                // Force navbar reload
                if (window.NavBar && window.NavBar.loadUserCompanies) {
                    window.NavBar.loadUserCompanies();
                }
            }
        }

        // Initialize page using standardized pattern
        window.initializePage('finance', async (companyId, company) => {
            console.log('Company changed in cash ending:', companyId, company?.name);
            if (cashEndingPage) {
                // Reset store filter to "All Stores" when company changes
                cashEndingPage.currentStoreFilter = null;
                cashEndingPage.updateStoreFilter();
                // Reload cash ending data for the new company
                console.log('Cash ending data should be reloaded for new company');
                loadCashLocations();
            }
        });
        
        // Initialize page after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Add a small delay to ensure all scripts are loaded
            setTimeout(async () => {
                console.log('Initializing CashEndingPage');
                
                // Wait for Supabase client to be initialized
                if (typeof supabase === 'undefined' || !supabase) {
                    // Try to initialize Supabase if function is available
                    if (typeof initializeSupabase === 'function') {
                        console.log('Initializing Supabase...');
                        initializeSupabase();
                    }
                    
                    // If still not available, wait a bit more
                    if (typeof supabase === 'undefined' || !supabase) {
                        console.error('Supabase client not initialized, waiting...');
                        setTimeout(async () => {
                            if (typeof supabase !== 'undefined' && supabase) {
                                console.log('Supabase client now available, continuing initialization');
                                // Ensure user data exists before proceeding
                                await ensureUserData();
                                cashEndingPage = new CashEndingPage();
                                window.cashEndingPage = cashEndingPage;
                                await cashEndingPage.init();
                            } else {
                                console.error('Supabase client still not available after waiting');
                            }
                        }, 500);
                        return;
                    }
                }
                
                console.log('Supabase client available:', typeof supabase !== 'undefined' && !!supabase);
                console.log('appState available:', typeof appState !== 'undefined');
                if (typeof appState !== 'undefined') {
                    console.log('appState methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(appState)));
                }
                
                // Ensure user data exists before proceeding
                await ensureUserData();
                
                cashEndingPage = new CashEndingPage();
                window.cashEndingPage = cashEndingPage;
                // Now explicitly call init after the instance is created
                await cashEndingPage.init();
            }, 300);
        });
    </script>
</body>
</html>