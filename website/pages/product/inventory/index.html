<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance - Inventory</title>
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="../../../core/themes/toss-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-component-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-base.css">
    <link rel="stylesheet" href="../../../core/themes/toss-typography.css">
    
    <!-- Component CSS -->
    <link rel="stylesheet" href="../../../components/base/toss-button.css">
    <link rel="stylesheet" href="../../../components/form/toss-input.css">
    <link rel="stylesheet" href="../../../components/form/toss-select.css">
    <link rel="stylesheet" href="../../../components/feedback/toss-alert.css">
    <link rel="stylesheet" href="../../../components/navigation/navbar.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- ExcelJS will be lazy-loaded when needed for Export/Import -->
    
    <!-- Page Specific Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background: var(--toss-gray-50);
            min-height: 100vh;
        }
        
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .page-content {
            flex: 1;
            padding: var(--space-6);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .page-header {
            margin-bottom: var(--space-8);
        }
        
        .page-title {
            font-size: var(--font-h1);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .page-subtitle {
            font-size: var(--font-large);
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Store Filter Control Styles - Exact match to employee settings */
        .controls-card {
            background: transparent;
            padding: 0;
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .control-section {
            flex: 0 1 auto;
            min-width: 200px;
            max-width: 280px;
            width: 280px;
            display: flex;
            align-items: center;
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            gap: 10px;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: white;
            height: 44px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        }
        
        .control-section:hover {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.12);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        
        .control-section.dropdown-open {
            background: white;
            border-color: #0064FF;
            box-shadow: 0 0 0 4px rgba(0, 100, 255, 0.08);
        }
        
        .control-section.dropdown-open .control-dropdown {
            transform: rotate(180deg);
            color: #0064FF;
        }
        
        .control-section.dropdown-open .control-label {
            color: #0064FF;
            font-weight: 500;
        }
        
        .control-section.dropdown-open .control-icon {
            color: #0064FF;
        }
        
        .control-icon {
            width: 18px;
            height: 18px;
            color: rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
        }
        
        .control-label {
            font-size: 14px;
            font-weight: 500;
            color: #1a1a1a;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }
        
        .control-dropdown {
            width: 16px;
            height: 16px;
            color: rgba(0, 0, 0, 0.3);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            margin-left: auto;
        }
        
        /* Store Filter Dropdown Styles */
        .store-filter-dropdown {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            min-width: 100%;
            width: max-content;
            max-width: 380px;
            background: white;
            border-radius: 14px;
            box-shadow: 
                0 0 0 1px rgba(0, 0, 0, 0.04),
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px) scale(0.96);
            transition: all 200ms cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 380px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 6px 0;
        }
        
        .store-filter-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        /* Search input for filterable dropdown - exact match to employee settings */
        .store-filter-search {
            padding: 8px 16px;
            margin: 0 6px 6px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.02);
            transition: all 150ms ease;
            width: calc(100% - 12px);
            box-sizing: border-box;
        }
        
        .store-filter-search:focus {
            outline: none;
            border-color: #0064FF;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .store-filter-search::placeholder {
            color: rgba(0, 0, 0, 0.4);
        }
        
        /* Divider for grouping */
        .store-filter-divider {
            height: 1px;
            margin: 6px 12px;
            background: rgba(0, 0, 0, 0.06);
        }
        
        .store-filter-dropdown-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 150ms ease;
            position: relative;
            font-size: 15px;
            line-height: 1.5;
        }
        
        .store-filter-dropdown-option:hover {
            background: var(--toss-gray-50);
        }
        
        .store-filter-dropdown-option.focused {
            background: var(--toss-gray-100);
            transform: scale(0.98);
        }
        
        .store-filter-dropdown-option.selected {
            background: rgba(0, 100, 255, 0.08);
            color: #0064FF;
        }
        
        .store-filter-dropdown-option.selected:hover {
            background: rgba(0, 100, 255, 0.12);
        }
        
        .store-filter-dropdown-option-icon {
            width: 20px;
            height: 20px;
            color: var(--text-tertiary);
            flex-shrink: 0;
            transition: color 150ms ease;
        }
        
        .store-filter-dropdown-option.selected .store-filter-dropdown-option-icon {
            color: #0064FF;
        }
        
        .store-filter-dropdown-option-text {
            flex: 1;
            font-weight: 400;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .store-filter-dropdown-option.selected .store-filter-dropdown-option-text {
            font-weight: 500;
        }
        
        .store-filter-dropdown-option-check {
            width: 18px;
            height: 18px;
            color: #0064FF;
            margin-left: auto;
            flex-shrink: 0;
        }
        
        .content-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: 0;
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
            overflow: hidden;
        }
        
        /* Inventory Header Styles */
        .inventory-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-6);
            border-bottom: 1px solid var(--toss-border);
            gap: var(--space-4);
        }
        
        .inventory-title-section {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            flex: 1;
        }
        
        .inventory-title {
            font-size: var(--font-h3);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        
        .inventory-actions {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .action-buttons {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .delete-btn {
            background: var(--toss-white);
            color: var(--toss-error);
            border: 1px solid var(--toss-error-light);
        }
        
        .delete-btn:hover {
            background: var(--toss-error-light);
            border-color: var(--toss-error);
            color: var(--toss-error);
        }
        
        .delete-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background: var(--toss-white);
            border-color: var(--toss-border);
            color: var(--text-tertiary);
        }
        
        .delete-btn:disabled:hover {
            background: var(--toss-white);
            border-color: var(--toss-border);
            color: var(--text-tertiary);
        }
        
        /* Search Bar Styles */
        .inventory-search-wrapper {
            position: relative;
            min-width: 280px;
        }
        
        .inventory-search {
            width: 100%;
            padding: var(--space-3) var(--space-4) var(--space-3) var(--space-12);
            border: 1px solid var(--toss-border);
            border-radius: var(--radius-lg);
            font-size: var(--font-body);
            background: var(--toss-gray-50);
            transition: all 0.2s ease;
        }
        
        .inventory-search:focus {
            outline: none;
            border-color: var(--toss-primary);
            background: var(--toss-white);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.08);
        }
        
        .inventory-search::placeholder {
            color: var(--text-tertiary);
        }
        
        .search-icon {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            color: var(--text-tertiary);
            pointer-events: none;
        }
        
        .search-clear {
            position: absolute;
            right: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border: none;
            background: none;
            color: var(--text-tertiary);
            cursor: pointer;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
            padding: var(--space-1);
        }
        
        .search-clear:hover {
            color: var(--text-primary);
            background: var(--toss-gray-100);
        }
        
        /* Table Styles */
        .inventory-table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .inventory-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-body);
        }
        
        .inventory-table th {
            background: var(--toss-gray-50);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: var(--font-small);
            text-align: left;
            padding: var(--space-4) var(--space-3);
            border-bottom: 1px solid var(--toss-border);
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Center-align Quantity, Price and Cost column headers to match data */
        .inventory-table th.quantity-cell,
        .inventory-table th.price-cell,
        .inventory-table th.cost-cell {
            text-align: center;
        }
        
        .inventory-table td {
            padding: var(--space-4) var(--space-3);
            border-bottom: 1px solid var(--toss-border-light);
            vertical-align: middle;
        }
        
        .inventory-table tbody tr:hover {
            background: var(--toss-gray-50);
        }
        
        .inventory-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        /* Checkbox Column Styles */
        .checkbox-cell {
            width: 48px;
            padding-left: var(--space-3) !important;
            padding-right: var(--space-2) !important;
        }
        
        .product-checkbox {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--toss-border);
            border-radius: var(--radius-sm);
            background: var(--toss-white);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }
        
        .product-checkbox:hover {
            border-color: var(--toss-primary);
            background: var(--toss-primary-surface);
        }
        
        .product-checkbox:checked {
            background: var(--toss-primary);
            border-color: var(--toss-primary);
            color: var(--toss-white);
        }
        
        .product-checkbox:checked::after {
            content: "";
            position: absolute;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: translate(-50%, -60%) rotate(45deg);
            top: 50%;
            left: 50%;
        }
        
        .select-all-checkbox {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid var(--toss-border);
            border-radius: var(--radius-sm);
            background: var(--toss-white);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
        }
        
        .select-all-checkbox:hover {
            border-color: var(--toss-primary);
            background: var(--toss-primary-surface);
        }
        
        .select-all-checkbox:checked {
            background: var(--toss-primary);
            border-color: var(--toss-primary);
            color: var(--toss-white);
        }
        
        .select-all-checkbox:checked::after {
            content: "";
            position: absolute;
            width: 4px;
            height: 8px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: translate(-50%, -60%) rotate(45deg);
            top: 50%;
            left: 50%;
        }
        
        /* Indeterminate state for select-all checkbox */
        .select-all-checkbox.indeterminate {
            background: var(--toss-primary);
            border-color: var(--toss-primary);
            color: var(--toss-white);
        }
        
        .select-all-checkbox.indeterminate::after {
            content: "";
            position: absolute;
            width: 10px;
            height: 2px;
            background: white;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* Product Image Styles */
        .product-image-cell {
            width: 64px;
        }
        
        .product-image {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            object-fit: cover;
            background: var(--toss-gray-100);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
            border: 1px solid var(--toss-border-light);
        }
        
        /* Product Name Column Styles */
        .product-name-cell {
            min-width: 180px;
            width: 25%;
            max-width: 300px;
            padding-right: var(--space-2) !important;
        }
        
        .product-name {
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1.4;
            word-break: break-word;
        }
        
        /* Product Code Column Styles */
        .product-code-cell {
            min-width: 100px;
            width: 13%;
            max-width: 160px;
        }
        
        .product-code {
            font-size: var(--font-small);
            color: var(--text-secondary);
            font-family: var(--font-family-mono);
            font-weight: 500;
            letter-spacing: 0.02em;
            background: var(--toss-gray-100);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            display: inline-block;
        }
        
        /* Barcode Column Styles */
        .barcode-cell {
            min-width: 110px;
            width: 13%;
            max-width: 160px;
        }
        
        .barcode {
            font-size: var(--font-small);
            color: var(--text-secondary);
            font-family: var(--font-family-mono);
            font-weight: 500;
        }
        
        /* Quantity Styles */
        .quantity-cell {
            min-width: 80px;
            width: 10%;
            text-align: center;
        }
        
        .quantity-value {
            font-weight: 600;
            color: var(--text-primary);
            display: inline-block;
            text-align: center;
        }
        
        .quantity-low {
            color: var(--toss-warning);
        }
        
        .quantity-out {
            color: var(--toss-error);
        }
        
        .quantity-unit {
            font-size: var(--font-small);
            color: var(--text-secondary);
            margin-left: var(--space-1);
        }
        
        /* Price Styles */
        .price-cell {
            min-width: 90px;
            width: 11%;
            text-align: center;
        }
        
        .price-value {
            font-weight: 600;
            color: var(--toss-primary);
            text-align: center;
            display: inline-block;
        }
        
        /* Cost Styles */
        .cost-cell {
            min-width: 90px;
            width: 11%;
            text-align: center;
        }
        
        .cost-value {
            font-weight: 600;
            color: var(--text-secondary);
            text-align: center;
            display: inline-block;
        }
        
        /* Status Column */
        .status-cell {
            min-width: 120px;
            width: 15%;
        }
        
        /* Actions Column */
        .actions-cell {
            min-width: 100px;
            width: 100px;
            text-align: center;
        }
        
        .edit-product-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 500;
            color: var(--toss-primary);
            background: var(--toss-white);
            border: 1px solid var(--toss-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        
        .edit-product-btn:hover {
            background: var(--toss-primary);
            color: var(--toss-white);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 100, 255, 0.15);
        }
        
        .edit-product-btn svg {
            width: 14px;
            height: 14px;
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-small);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }
        
        .status-in-stock {
            background: var(--toss-success-light);
            color: var(--toss-success);
        }
        
        .status-low-stock {
            background: var(--toss-warning-light);
            color: var(--toss-warning);
        }
        
        .status-out-of-stock {
            background: var(--toss-error-light);
            color: var(--toss-error);
        }
        
        /* Pagination Styles */
        .inventory-pagination {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-6);
            border-top: 1px solid var(--toss-border);
            gap: var(--space-4);
        }
        
        .pagination-info {
            color: var(--text-secondary);
            font-size: var(--font-small);
            flex: 1;
        }
        
        .pagination-controls {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .pagination-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border: 1px solid var(--toss-border);
            background: var(--toss-white);
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: var(--font-small);
            font-weight: 500;
        }
        
        .pagination-btn:hover:not(:disabled) {
            border-color: var(--toss-primary);
            color: var(--toss-primary);
            background: var(--toss-primary-surface);
        }
        
        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .pagination-btn.active {
            background: var(--toss-primary);
            color: var(--toss-white);
            border-color: var(--toss-primary);
        }
        
        .pagination-nav {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        /* Pagination Numbers Container */
        #paginationNumbers {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }
        
        .pagination-ellipsis {
            padding: 0 var(--space-2);
            color: var(--text-tertiary);
            font-size: var(--font-small);
            font-weight: 500;
        }
        
        .pagination-nav-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border: 1px solid var(--toss-border);
            background: var(--toss-white);
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .pagination-nav-btn:hover:not(:disabled) {
            border-color: var(--toss-primary);
            color: var(--toss-primary);
            background: var(--toss-primary-surface);
        }
        
        .pagination-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* Inventory Placeholder for empty states */
        .inventory-placeholder {
            text-align: center;
            padding: var(--space-12) var(--space-6);
        }
        
        .inventory-placeholder-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto var(--space-4);
            background: var(--toss-gray-100);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
        }
        
        .inventory-placeholder-title {
            font-size: var(--font-h3);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .inventory-placeholder-text {
            font-size: var(--font-base);
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Loading spinner animation */
        .toss-spinner {
            display: inline-block;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .controls-card {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .control-section {
                max-width: none;
                width: 100%;
                min-width: unset;
            }
            
            .store-filter-dropdown {
                left: 0;
                right: 0;
                width: 100%;
                max-width: none;
                border-radius: 12px;
            }
            
            .store-filter-dropdown-option {
                padding: 14px 16px;
                font-size: 16px;
            }
            
            .inventory-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-4);
            }
            
            .inventory-title-section {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-3);
            }
            
            .inventory-actions {
                flex-direction: column;
                gap: var(--space-3);
            }
            
            .action-buttons {
                flex-direction: column;
                width: 100%;
                gap: var(--space-2);
            }
            
            .action-buttons button {
                width: 100%;
            }
            
            .inventory-search-wrapper {
                min-width: unset;
                width: 100%;
            }
            
            .inventory-table th,
            .inventory-table td {
                padding: var(--space-3) var(--space-4);
            }
            
            .inventory-table th {
                font-size: var(--font-small);
            }
            
            .inventory-table td {
                font-size: var(--font-small);
            }
            
            .product-name-cell {
                min-width: 120px;
            }
            
            .product-code-cell {
                min-width: 100px;
            }
            
            .barcode-cell {
                min-width: 90px;
            }
            
            .product-name {
                font-size: var(--font-small);
            }
            
            .product-code {
                font-size: var(--font-small);
                padding: 2px var(--space-1);
            }
            
            .inventory-pagination {
                flex-direction: column;
                gap: var(--space-4);
            }
            
            .pagination-info {
                text-align: center;
                order: 2;
            }
            
            .pagination-controls {
                justify-content: center;
                order: 1;
            }
        }
        
        @media (max-width: 640px) {
            .page-content {
                padding: var(--space-4);
            }
            
            .store-filter-dropdown {
                left: -12px;
                right: -12px;
                max-height: 250px;
            }
            
            /* Stack table on very small screens */
            .inventory-table-wrapper {
                display: block;
            }
            
            .inventory-table,
            .inventory-table thead,
            .inventory-table tbody,
            .inventory-table th,
            .inventory-table td,
            .inventory-table tr {
                display: block;
            }
            
            .inventory-table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .inventory-table tr {
                background: var(--toss-white);
                border: 1px solid var(--toss-border);
                border-radius: var(--radius-md);
                margin-bottom: var(--space-4);
                padding: var(--space-4);
            }
            
            .inventory-table td {
                border: none;
                position: relative;
                padding: var(--space-2) 0;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }
            
            .inventory-table td:before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--text-secondary);
                font-size: var(--font-small);
                text-transform: uppercase;
                letter-spacing: 0.02em;
            }
            
            .checkbox-cell:before {
                display: none;
            }
            
            .checkbox-cell {
                justify-content: flex-start;
                margin-bottom: var(--space-2);
                padding-left: 0 !important;
            }
            
            .product-image-cell:before {
                display: none;
            }
            
            .product-image-cell {
                justify-content: flex-start;
                margin-bottom: var(--space-3);
            }
            
            .product-name-cell:before {
                display: none;
            }
            
            .product-code-cell:before,
            .barcode-cell:before {
                display: none;
            }
            
            .product-name-cell,
            .product-code-cell,
            .barcode-cell {
                min-width: unset;
                margin-bottom: var(--space-2);
            }
            
            .product-name-cell {
                justify-content: flex-start;
            }
            
            .product-code-cell,
            .barcode-cell {
                justify-content: flex-start;
                margin-bottom: var(--space-3);
            }
            
            /* Actions cell in mobile view */
            .actions-cell {
                justify-content: center !important;
                padding-top: var(--space-3) !important;
                border-top: 1px solid var(--toss-border-light);
                margin-top: var(--space-2);
            }
            
            .actions-cell:before {
                display: none !important;
            }
            
            .edit-product-btn {
                width: 100%;
                max-width: 200px;
            }
        }
        
        /* Add Product Modal Styles */
        #addProductModalOverlay .modal-container {
            max-width: 1200px !important;
            width: 90% !important;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 9999;
            animation: fadeIn 0.2s ease;
        }
        
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }
        
        .modal-container {
            background: var(--toss-white);
            border-radius: var(--radius-xl);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.12);
            animation: slideUp 0.3s ease;
        }
        
        .modal-container.modal-lg {
            max-width: 1200px;
            width: 90%;
        }
        
        .modal-container.modal-sm {
            max-width: 500px;
            width: 90%;
        }
        
        .modal-header {
            padding: var(--space-6);
            border-bottom: 1px solid var(--toss-border-light);
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }
        
        .modal-title-section {
            flex: 1;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.3;
        }
        
        .modal-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 8px 0 0 0;
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            color: var(--text-tertiary);
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
            margin-left: var(--space-4);
        }
        
        .modal-close-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: var(--space-6) var(--space-8);
            overflow-y: auto;
            flex: 1;
        }
        
        #addProductModalOverlay .modal-body {
            padding: var(--space-6) var(--space-10);
        }
        
        .modal-footer {
            padding: var(--space-4) var(--space-6);
            border-top: 1px solid var(--toss-border-light);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
        }
        
        /* Form Styles */
        .add-product-form .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-5) var(--space-6);
            padding: 0 var(--space-4);
        }
        
        .add-product-form .form-full-width {
            grid-column: 1 / -1;
        }
        
        .toss-input-group {
            margin-bottom: 0;
        }
        
        .toss-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .toss-label.required::after {
            content: ' *';
            color: var(--toss-error);
        }
        
        .toss-input-wrapper {
            position: relative;
        }
        
        .toss-input,
        .toss-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dee2e6;
            border-radius: var(--radius-input);
            font-size: 14px;
            color: var(--text-primary);
            background: var(--toss-white);
            transition: all 0.2s ease;
            outline: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .toss-input:focus,
        .toss-textarea:focus {
            border-color: var(--toss-primary);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .toss-input::placeholder,
        .toss-textarea::placeholder {
            color: var(--text-placeholder);
        }
        
        .toss-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        select.toss-input {
            appearance: none;
            padding-right: 40px;
            cursor: pointer;
        }
        
        .select-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-tertiary);
        }
        
        .input-prefix {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            pointer-events: none;
            user-select: none;
            z-index: 2;
        }
        
        .toss-input.with-prefix,
        .detail-input.with-prefix {
            padding-left: 36px;
        }
        
        .detail-value-wrapper .input-prefix {
            left: 16px;
            z-index: 2;
            background: transparent;
            cursor: text;
        }
        
        /* When clicking on prefix area, focus should go to input */
        .detail-value-wrapper .input-prefix:hover {
            cursor: text;
        }
        
        /* Detail Modal Select Containers */
        .detail-select-container {
            width: 100%;
        }
        
        .detail-select-container .toss-select-container {
            width: 100%;
            max-width: none;
        }
        
        /* Detail Modal Textarea */
        .detail-textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            line-height: 1.4;
        }
        
        /* Make sure the prefix can't be selected or interacted with */
        .input-prefix {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .toss-input-message {
            display: block;
            font-size: 12px;
            margin-top: 4px;
            color: var(--text-tertiary);
            min-height: 16px;
        }
        
        .toss-input-message.error {
            color: var(--toss-error);
        }
        
        /* Remove spinner arrows from number inputs */
        .toss-input[type="number"]::-webkit-outer-spin-button,
        .toss-input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .toss-input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
        }
        
        /* Image Upload Area Styles */
        .image-upload-area {
            position: relative;
            width: 100%;
            min-height: 200px;
            border: 2px dashed #dee2e6;
            border-radius: var(--radius-lg);
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        
        .image-upload-area:hover {
            border-color: var(--toss-primary);
            background: #f0f8ff;
        }
        
        .image-upload-area.has-image {
            border-style: solid;
            background: var(--toss-white);
        }
        
        .upload-placeholder {
            text-align: center;
            padding: var(--space-4);
        }
        
        .upload-text {
            margin-top: var(--space-3);
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .upload-hint {
            margin-top: var(--space-2);
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .remove-image-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #dee2e6;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .remove-image-btn:hover {
            background: var(--toss-white);
            border-color: var(--toss-error);
            color: var(--toss-error);
        }
        
        #imagePreview {
            max-height: 300px;
            object-fit: contain;
        }
        
        /* Add Brand Modal Styles */
        .add-brand-modal {
            max-width: 480px;
            width: 100%;
        }
        
        .add-brand-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-5);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .form-label {
            font-size: var(--font-small);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .form-label.required::after {
            content: "*";
            color: var(--toss-error);
            margin-left: var(--space-1);
        }
        
        .form-input {
            padding: var(--space-3) var(--space-4);
            border: 1px solid var(--toss-border);
            border-radius: var(--radius-input);
            font-size: var(--font-body);
            color: var(--text-primary);
            background: var(--toss-white);
            transition: all var(--transition-fast);
            outline: none;
        }
        
        .form-input:focus {
            border-color: var(--toss-primary);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.08);
        }
        
        .form-input:disabled {
            background: var(--toss-gray-100);
            color: var(--text-disabled);
            cursor: not-allowed;
        }
        
        .form-helper {
            font-size: var(--font-small);
            color: var(--text-tertiary);
        }
        
        .form-message {
            font-size: var(--font-small);
            color: var(--toss-error);
            min-height: 16px;
            display: block;
        }
        
        .form-message.success {
            color: var(--toss-success);
        }
        
        /* Add Category Modal Styles */
        .add-category-modal {
            max-width: 480px;
            width: 100%;
            min-height: 500px; /* Ensure enough height for dropdown */
            overflow: visible !important; /* Override modal container overflow */
        }
        
        .add-category-modal .modal-body {
            min-height: 350px; /* Increased minimum height for form and dropdown */
            overflow: visible; /* Allow dropdown to be visible */
            position: relative; /* For dropdown positioning */
            padding-bottom: 40px; /* Extra padding for dropdown space */
        }
        
        .add-category-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .add-category-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .add-category-form .form-label {
            font-size: 14px;
            font-weight: 500;
            color: #212529;
        }
        
        .add-category-form .form-label.required::after {
            content: ' *';
            color: #dc3545;
        }
        
        .add-category-form .form-input {
            padding: 10px 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .add-category-form .form-input:focus {
            outline: none;
            border-color: #0064ff;
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.08);
        }
        
        .add-category-form .form-helper {
            font-size: 12px;
            color: #6c757d;
        }
        
        .add-category-form .form-message {
            font-size: 12px;
            color: #6c757d;
            min-height: 16px;
        }
        
        .add-category-form .form-message.error {
            color: #dc3545;
        }
        
        .add-category-form .detail-select-container {
            width: 100%;
            position: relative;
        }
        
        /* Ensure dropdown is visible in modal */
        .add-category-modal .toss-select-dropdown {
            z-index: 10001; /* Higher than modal */
            max-height: 250px; /* Increased dropdown height */
            overflow-y: auto; /* Scroll if too many items */
        }
        
        .add-category-modal .toss-select-dropdown-list {
            max-height: 220px; /* List container height */
            overflow-y: auto;
        }
        
        /* Clear button styles */
        .toss-select-clear {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            margin-left: auto;
            margin-right: 8px;
            cursor: pointer;
            color: #6c757d;
            font-size: 18px;
            font-weight: bold;
            transition: color 0.2s;
        }
        
        .toss-select-clear:hover {
            color: #dc3545;
        }
        
        /* Animation Keyframes */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        /* Responsive Modal */
        @media (max-width: 768px) {
            .modal-container {
                max-width: 100%;
                max-height: 100vh;
                border-radius: var(--radius-xl) var(--radius-xl) 0 0;
                margin-top: auto;
            }
            
            .add-category-modal {
                min-height: 60vh; /* More height on mobile for better usability */
            }
            
            .modal-overlay.active {
                align-items: flex-end;
                padding: 0;
            }
            
            .add-product-form .form-grid {
                grid-template-columns: 1fr;
                gap: var(--space-4);
                padding: 0;
            }
            
            #addProductModalOverlay .modal-container {
                max-width: 95% !important;
                width: 95% !important;
            }
            
            #addProductModalOverlay .modal-body {
                padding: var(--space-5);
            }
            
            .modal-header {
                padding: var(--space-5);
            }
            
            .modal-body {
                padding: var(--space-5);
            }
            
            .modal-footer {
                padding: var(--space-4) var(--space-5);
            }
        }
        
        /* Product Detail Modal Styles */
        .product-detail-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
        }
        
        .detail-section {
            background: var(--bg-secondary, #f8f9fa);
            border-radius: var(--radius-lg, 12px);
            padding: var(--space-5, 20px);
            border: 1px solid var(--toss-border-light, #e9ecef);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--space-4) 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 20px;
            background: var(--toss-primary);
            border-radius: 2px;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4) var(--space-5);
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .detail-item.detail-full-width {
            grid-column: 1 / -1;
        }
        
        .detail-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            padding: 12px 16px;
            background: var(--toss-white);
            border: 1px solid var(--toss-border-light);
            border-radius: var(--radius-input);
            display: flex;
            align-items: center;
        }
        
        .detail-value.detail-id {
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            color: var(--text-tertiary);
        }
        
        .detail-value-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .detail-input {
            flex: 1;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            padding: 12px 16px;
            background: var(--toss-white);
            border: 1px solid var(--toss-border-light);
            border-radius: var(--radius-input);
            outline: none;
            transition: all 0.2s ease;
        }
        
        .detail-input:focus {
            border-color: var(--toss-primary);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .detail-input:disabled {
            background: var(--bg-secondary);
            color: var(--text-tertiary);
            cursor: not-allowed;
        }
        
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button,
        .detail-input[type="number"]::-webkit-outer-spin-button,
        .detail-input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .quantity-input,
        .detail-input[type="number"] {
            -moz-appearance: textfield;
        }
        
        .edit-toggle-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--toss-border-light);
            border-radius: var(--radius-md);
            padding: 8px;
            margin-left: 8px;
            cursor: pointer;
            color: var(--text-tertiary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .edit-toggle-btn:hover {
            background: var(--toss-primary);
            color: var(--toss-white);
            border-color: var(--toss-primary);
        }
        
        .detail-price {
            justify-content: space-between;
        }
        
        .price-currency {
            color: var(--text-secondary);
            margin-right: 4px;
        }
        
        .price-amount {
            font-weight: 600;
        }
        
        .detail-profit {
            background: var(--bg-success-light, #e8f5e8);
            border-color: var(--toss-success, #00C896);
            color: var(--toss-success, #00C896);
            justify-content: space-between;
        }
        
        .profit-amount {
            font-weight: 600;
            font-size: 18px;
        }
        
        .profit-percentage {
            font-size: 14px;
            opacity: 0.8;
        }
        
        /* Status Badge Styles */
        .status-badge {
            padding: 6px 12px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge.status-in-stock {
            background: var(--bg-success-light, #e8f5e8);
            color: var(--toss-success, #00C896);
        }
        
        .status-badge.status-low-stock {
            background: var(--bg-warning-light, #fff3cd);
            color: var(--toss-warning, #f39c12);
        }
        
        .status-badge.status-out-of-stock {
            background: var(--bg-error-light, #f8d7da);
            color: var(--toss-error, #FF5847);
        }
        
        /* Clickable Row Styles */
        .inventory-table tbody .product-row {
            transition: background-color 0.2s ease;
        }
        
        .inventory-table tbody .product-row:hover {
            background-color: var(--bg-hover);
        }
        
        .inventory-table tbody .product-row:hover .product-checkbox {
            opacity: 1;
        }
        
        .product-checkbox {
            opacity: 0.6;
            transition: opacity 0.2s ease;
            cursor: pointer;
        }
        
        .checkbox-cell {
            cursor: default !important;
        }
        
        /* Save Button Disabled State */
        .toss-btn.toss-btn-disabled,
        .toss-btn:disabled {
            background-color: var(--bg-secondary, #f8f9fa) !important;
            color: var(--text-tertiary, #6c757d) !important;
            border-color: var(--toss-border-light, #e9ecef) !important;
            cursor: not-allowed !important;
            opacity: 0.6;
        }
        
        .toss-btn.toss-btn-primary:disabled {
            background-color: #cce5ff !important;
            color: #fff !important;
            border-color: #cce5ff !important;
            cursor: not-allowed !important;
            opacity: 0.7;
        }
        
        .toss-btn.toss-btn-disabled:hover,
        .toss-btn:disabled:hover {
            background-color: var(--bg-secondary, #f8f9fa) !important;
            color: var(--text-tertiary, #6c757d) !important;
            border-color: var(--toss-border-light, #e9ecef) !important;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .toss-btn.toss-btn-primary:disabled:hover {
            background-color: #cce5ff !important;
            color: #fff !important;
            border-color: #cce5ff !important;
        }
        
        /* Danger button style for delete confirmation */
        .toss-btn-danger {
            background: var(--toss-error, #DC2626) !important;
            color: var(--toss-white, #FFFFFF) !important;
            border: 1px solid var(--toss-error, #DC2626) !important;
        }
        
        .toss-btn-danger:hover {
            background: var(--toss-error-dark, #B91C1C) !important;
            border-color: var(--toss-error-dark, #B91C1C) !important;
            transform: translateY(-1px);
        }
        
        .toss-btn-danger:active {
            transform: translateY(0);
        }
        
        .toss-btn-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }
        
        /* Delete confirmation modal styles */
        .delete-warning {
            padding: var(--space-4);
            background: var(--toss-error-surface, #FEF2F2);
            border: 1px solid var(--toss-error-light, #FECACA);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
        }
        
        .delete-warning-title {
            font-weight: 600;
            color: var(--toss-error-dark, #DC2626);
            margin-bottom: var(--space-2);
        }
        
        .delete-product-list {
            margin: var(--space-4) 0;
        }
        
        .delete-product-item {
            padding: var(--space-3);
            background: var(--toss-white);
            border: 1px solid var(--toss-border-light);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-2);
        }
        
        .delete-product-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .delete-product-info {
            font-size: var(--font-small);
            color: var(--text-secondary);
            margin-top: var(--space-1);
        }
        
        .stock-warning {
            color: var(--toss-error);
            font-weight: 600;
        }
        
        /* Responsive Detail Modal */
        @media (max-width: 768px) {
            .detail-grid {
                grid-template-columns: 1fr;
                gap: var(--space-4);
            }
            
            .detail-section {
                padding: var(--space-4);
            }
            
            .section-title {
                font-size: 16px;
            }
            
            .detail-input,
            .detail-value {
                font-size: 14px;
            }
        }
        
        /* Loading animation for export button */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Navigation Bar -->
        <div id="navbar-container"></div>
        
        <!-- Page Content -->
        <main class="page-content">
            <div class="page-header">
                <h1 class="page-title">Inventory</h1>
                <p class="page-subtitle">Manage product inventory across stores</p>
            </div>
            
            <!-- Store Filter Control -->
            <div class="controls-card">
                <div class="control-section" id="storeFilterControl">
                    <svg class="control-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75Z"/>
                    </svg>
                    <span class="control-label" id="storeFilterLabel">Loading...</span>
                    <svg class="control-dropdown" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                    </svg>
                    
                    <!-- Store Filter Dropdown -->
                    <div class="store-filter-dropdown" id="storeFilterDropdown">
                        <div id="storeFilterOptions">
                            <!-- Store filter options will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Inventory Content -->
            <div class="content-card" id="inventoryContent">
                <div class="inventory-placeholder">
                    <div class="inventory-placeholder-icon">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M5,5H19A2,2 0 0,1 21,7V17A2,2 0 0,1 19,19H5A2,2 0 0,1 3,17V7A2,2 0 0,1 5,5M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"/>
                        </svg>
                    </div>
                    <h3 class="inventory-placeholder-title">Select a Store</h3>
                    <p class="inventory-placeholder-text">Choose a store from the dropdown above to view its inventory</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Add Product Modal -->
    <div class="modal-overlay" id="addProductModalOverlay">
        <div class="modal-container modal-lg" id="addProductModal">
            <!-- Modal Header -->
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title">Add New Product</h2>
                    <p class="modal-subtitle">Enter product details to add to your inventory</p>
                </div>
                <button class="modal-close-btn" id="closeModalBtn">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body">
                <form class="add-product-form" id="addProductForm">
                    <div class="form-grid">
                        <!-- Product Image Upload (Optional) -->
                        <div class="toss-input-group form-full-width">
                            <label class="toss-label">Product Image</label>
                            <div class="image-upload-area" id="imageUploadArea">
                                <input type="file" id="imageFileInput" accept="image/*" style="display: none;">
                                <div class="upload-placeholder" id="uploadPlaceholder">
                                    <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #6c757d;">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <p class="upload-text">Click to upload or drag and drop</p>
                                    <p class="upload-hint">PNG, JPG, GIF up to 10MB</p>
                                </div>
                                <img id="imagePreview" style="display: none; max-width: 100%; height: auto;">
                                <button type="button" id="removeImageBtn" class="remove-image-btn" style="display: none;">
                                    <svg width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                    </svg>
                                </button>
                            </div>
                            <input type="hidden" id="imageUrlInput" name="imageUrl">
                            <input type="hidden" id="thumbnailUrlInput" name="thumbnailUrl">
                            <span class="toss-input-message"></span>
                        </div>
                        
                        <!-- Product Name (Required) -->
                        <div class="toss-input-group form-full-width">
                            <label class="toss-label required">Product Name</label>
                            <div class="toss-input-wrapper">
                                <input 
                                    type="text" 
                                    class="toss-input" 
                                    name="productName" 
                                    id="productNameInput"
                                    placeholder="Enter product name"
                                    required
                                >
                            </div>
                            <span class="toss-input-message"></span>
                        </div>
                        
                        <!-- SKU (Auto-generated if empty) -->
                        <div class="toss-input-group">
                            <label class="toss-label">SKU</label>
                            <div class="toss-input-wrapper">
                                <input 
                                    type="text" 
                                    class="toss-input" 
                                    name="sku"
                                    id="skuInput" 
                                    placeholder="Leave empty to auto-generate"
                                >
                            </div>
                            <span class="toss-input-message" style="color: var(--text-tertiary); font-size: 12px;">Will be auto-generated if left empty</span>
                        </div>
                        
                        <!-- Barcode (Optional) -->
                        <div class="toss-input-group">
                            <label class="toss-label">Barcode</label>
                            <div class="toss-input-wrapper">
                                <input 
                                    type="text" 
                                    class="toss-input" 
                                    name="barcode"
                                    id="barcodeInput" 
                                    placeholder="Leave empty to auto-generate"
                                >
                            </div>
                            <span class="toss-input-message" style="color: var(--text-tertiary); font-size: 12px;">Will be auto-generated if left empty</span>
                        </div>
                        
                        <!-- Category Selection (Optional) -->
                        <div class="toss-input-group">
                            <label class="toss-label">Category</label>
                            <div id="addProductCategoryContainer"></div>
                            <span class="toss-input-message"></span>
                        </div>
                        
                        <!-- Brand Selection (Optional) -->
                        <div class="toss-input-group">
                            <label class="toss-label">Brand</label>
                            <div id="addProductBrandContainer"></div>
                            <span class="toss-input-message"></span>
                        </div>
                        
                        <!-- Cost Price (Optional) -->
                        <div class="toss-input-group">
                            <label class="toss-label">Cost Price</label>
                            <div class="toss-input-wrapper">
                                <span class="input-prefix" id="costPricePrefix">$</span>
                                <input 
                                    type="number" 
                                    class="toss-input with-prefix" 
                                    name="costPrice"
                                    id="costPriceInput" 
                                    placeholder="0"
                                    min="0"
                                    step="0.01"
                                    max="999999999"
                                >
                            </div>
                            <span class="toss-input-message"></span>
                        </div>
                        
                        <!-- Selling Price (Optional) -->
                        <div class="toss-input-group">
                            <label class="toss-label">Selling Price</label>
                            <div class="toss-input-wrapper">
                                <span class="input-prefix" id="sellingPricePrefix">$</span>
                                <input 
                                    type="number" 
                                    class="toss-input with-prefix" 
                                    name="sellingPrice"
                                    id="sellingPriceInput" 
                                    placeholder="0"
                                    min="0"
                                    step="0.01"
                                    max="999999999"
                                >
                            </div>
                            <span class="toss-input-message"></span>
                        </div>
                        
                        <!-- Unit (Optional) -->
                        <div class="toss-input-group">
                            <label class="toss-label">Unit</label>
                            <div id="addProductUnitContainer"></div>
                            <span class="toss-input-message"></span>
                        </div>
                        
                        <!-- Initial Quantity (Optional) -->
                        <div class="toss-input-group">
                            <label class="toss-label">Initial Quantity</label>
                            <div class="toss-input-wrapper">
                                <input 
                                    type="number" 
                                    class="toss-input" 
                                    name="initialQuantity"
                                    id="initialQuantityInput" 
                                    placeholder="0"
                                    min="0"
                                    value="0"
                                    max="999999999"
                                >
                            </div>
                            <span class="toss-input-message"></span>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="toss-btn toss-btn-secondary" id="cancelModalBtn">
                    Cancel
                </button>
                <button type="button" class="toss-btn toss-btn-primary" id="saveProductBtn" disabled>
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                        <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                    </svg>
                    Create
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteConfirmModalOverlay">
        <div class="modal-container modal-sm" id="deleteConfirmModal">
            <!-- Modal Header -->
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title">Confirm Delete</h2>
                </div>
                <button type="button" class="modal-close-btn" id="closeDeleteModalBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body" id="deleteConfirmBody">
                <!-- Content will be dynamically generated -->
            </div>
            
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="toss-btn toss-btn-secondary" id="cancelDeleteBtn">
                    Cancel
                </button>
                <button type="button" class="toss-btn toss-btn-danger" id="confirmDeleteBtn">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                        <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                    </svg>
                    Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- Product Detail Modal -->
    <div class="modal-overlay" id="productDetailModalOverlay">
        <div class="modal-container modal-lg" id="productDetailModal">
            <!-- Modal Header -->
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title">Product Details</h2>
                    <p class="modal-subtitle">View and edit product information</p>
                </div>
                <button class="modal-close-btn" id="closeProductDetailBtn">
                    <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            
            <!-- Modal Body -->
            <div class="modal-body">
                <form class="product-detail-form" id="productDetailForm">
                    <!-- Product Overview Section -->
                    <div class="detail-section">
                        <h3 class="section-title">Product Information</h3>
                        <div class="detail-grid">
                            <!-- Editable Product Name -->
                            <div class="detail-item detail-full-width">
                                <label class="detail-label">Product Name</label>
                                <div class="detail-value-wrapper">
                                    <input 
                                        type="text" 
                                        class="detail-input" 
                                        id="detailProductName"
                                        placeholder="Product name"
                                    >
                                </div>
                            </div>
                            
                            <!-- Category Dropdown -->
                            <div class="detail-item">
                                <label class="detail-label">Category</label>
                                <div class="detail-select-container" id="detailCategoryContainer">
                                    <!-- TossSelect will be inserted here -->
                                </div>
                            </div>
                            
                            <!-- Brand Dropdown -->
                            <div class="detail-item">
                                <label class="detail-label">Brand</label>
                                <div class="detail-select-container" id="detailBrandContainer">
                                    <!-- TossSelect will be inserted here -->
                                </div>
                            </div>
                            
                            <!-- Product Type Dropdown -->
                            <div class="detail-item">
                                <label class="detail-label">Product Type</label>
                                <div class="detail-select-container" id="detailProductTypeContainer">
                                    <!-- TossSelect will be inserted here -->
                                </div>
                            </div>
                            
                            <!-- Barcode Field -->
                            <div class="detail-item">
                                <label class="detail-label">Barcode</label>
                                <div class="detail-value-wrapper">
                                    <input 
                                        type="text" 
                                        class="detail-input" 
                                        id="detailBarcode"
                                        placeholder="Barcode"
                                        readonly
                                    >
                                </div>
                            </div>
                            
                            <!-- SKU Field -->
                            <div class="detail-item">
                                <label class="detail-label">SKU</label>
                                <div class="detail-value-wrapper">
                                    <input 
                                        type="text" 
                                        class="detail-input" 
                                        id="detailSKU"
                                        placeholder="SKU"
                                        readonly
                                    >
                                </div>
                            </div>
                            
                        </div>
                    </div>
                    
                    <!-- Stock Information Section -->
                    <div class="detail-section">
                        <h3 class="section-title">Stock Information</h3>
                        <div class="detail-grid">
                            <!-- Editable Quantity -->
                            <div class="detail-item">
                                <label class="detail-label">Current Quantity</label>
                                <div class="detail-value-wrapper">
                                    <input 
                                        type="number" 
                                        class="detail-input quantity-input" 
                                        id="detailQuantity"
                                        min="0"
                                        placeholder="0"
                                    >
                                </div>
                            </div>
                            
                            
                            <!-- Unit Dropdown -->
                            <div class="detail-item">
                                <label class="detail-label">Unit</label>
                                <div class="detail-select-container" id="detailUnitContainer">
                                    <!-- TossSelect will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Price Information Section -->
                    <div class="detail-section">
                        <h3 class="section-title">Price Information</h3>
                        <div class="detail-grid">
                            <!-- Editable Selling Price -->
                            <div class="detail-item">
                                <label class="detail-label">Selling Price</label>
                                <div class="detail-value-wrapper">
                                    <span class="input-prefix" id="sellingPricePrefixDetail">$</span>
                                    <input 
                                        type="number" 
                                        class="detail-input with-prefix" 
                                        id="detailSellingPrice"
                                        placeholder="0"
                                        min="0"
                                        step="1000"
                                    >
                                </div>
                            </div>
                            
                            <!-- Editable Cost Price -->
                            <div class="detail-item">
                                <label class="detail-label">Cost Price</label>
                                <div class="detail-value-wrapper">
                                    <span class="input-prefix" id="costPricePrefixDetail">$</span>
                                    <input 
                                        type="number" 
                                        class="detail-input with-prefix" 
                                        id="detailCostPrice"
                                        placeholder="0"
                                        min="0"
                                        step="1000"
                                    >
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Modal Footer -->
            <div class="modal-footer">
                <button class="toss-btn toss-btn-secondary" id="cancelDetailBtn">
                    Cancel
                </button>
                <button class="toss-btn toss-btn-primary" id="saveDetailBtn">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                        <path d="M15,9H5V5H15M12,19A3,3 0 0,1 9,16A3,3 0 0,1 12,13A3,3 0 0,1 15,16A3,3 0 0,1 12,19M17,3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7L17,3Z"/>
                    </svg>
                    Save Changes
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Brand Modal -->
    <div id="addBrandModal" class="modal-overlay">
        <div class="modal-container add-brand-modal">
            <div class="modal-header">
                <h2 class="modal-title">Add New Brand</h2>
                <button type="button" class="modal-close-btn" id="closeAddBrandBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="addBrandForm" class="add-brand-form">
                    <!-- Brand Name (Required) -->
                    <div class="form-group">
                        <label class="form-label required">Brand Name</label>
                        <input 
                            type="text" 
                            id="brandNameInput" 
                            class="form-input" 
                            placeholder="Enter brand name"
                            required
                        >
                        <span class="form-message" id="brandNameMessage"></span>
                    </div>
                    
                    <!-- Brand Code (Optional) -->
                    <div class="form-group">
                        <label class="form-label">Brand Code</label>
                        <input 
                            type="text" 
                            id="brandCodeInput" 
                            class="form-input" 
                            placeholder="Enter brand code (optional)"
                        >
                        <span class="form-helper">Leave empty to auto-generate</span>
                        <span class="form-message" id="brandCodeMessage"></span>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="toss-btn toss-btn-secondary" id="cancelAddBrandBtn">
                    Cancel
                </button>
                <button type="button" class="toss-btn toss-btn-primary" id="submitAddBrandBtn" disabled>
                    Add Brand
                </button>
            </div>
        </div>
    </div>
    
    <!-- Add Category Modal -->
    <div id="addCategoryModal" class="modal-overlay">
        <div class="modal-container add-category-modal">
            <div class="modal-header">
                <h2 class="modal-title">Add New Category</h2>
                <button type="button" class="modal-close-btn" id="closeAddCategoryBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-body">
                <form id="addCategoryForm" class="add-category-form">
                    <!-- Category Name (Required) -->
                    <div class="form-group">
                        <label class="form-label required">Category Name</label>
                        <input 
                            type="text" 
                            id="categoryNameInput" 
                            class="form-input" 
                            placeholder="Enter category name"
                            required
                        >
                        <span class="form-message" id="categoryNameMessage"></span>
                    </div>
                    
                    <!-- Parent Category (Optional) -->
                    <div class="form-group">
                        <label class="form-label">Parent Category</label>
                        <div class="detail-select-container" id="parentCategoryContainer">
                            <!-- TossSelect will be inserted here -->
                        </div>
                        <span class="form-helper">Leave empty for top-level category</span>
                        <span class="form-message" id="parentCategoryMessage"></span>
                    </div>
                </form>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="toss-btn toss-btn-secondary" id="cancelAddCategoryBtn">
                    Cancel
                </button>
                <button type="button" class="toss-btn toss-btn-primary" id="submitAddCategoryBtn" disabled>
                    Add Category
                </button>
            </div>
        </div>
    </div>
    
    <!-- Component JavaScript -->
    <script src="../../../components/base/toss-button.js"></script>
    <script src="../../../components/form/toss-input.js"></script>
    <script src="../../../components/form/toss-select.js"></script>
    <script src="../../../components/navigation/navbar.js"></script>
    <script src="../../../components/feedback/toss-alert.js"></script>
    
    <!-- Core Scripts -->
    <script src="../../../core/constants/app-icons.js"></script>
    <script src="../../../core/config/supabase.js"></script>
    
    <!-- App State Management -->
    <script src="../../../core/utils/app-state.js"></script>
    
    <!-- Route Mapping -->
    <script src="../../../core/config/route-mapping.js"></script>
    
    <!-- Page Initialization Utility -->
    <script src="../../../core/utils/page-init.js"></script>
    
    <script>
        // Set flag immediately to prevent navbar auto-init
        window.skipNavbarAutoInit = true;
        
        // Store filter management
        class InventoryManager {
            constructor() {
                this.currentStoreFilter = null;
                this.dropdownOpen = false;
                this.currentFocusIndex = -1;
                this.stores = [];
                this.currentProducts = [];
                this.totalProducts = 0;
                this.currentPage = 1;
                this.itemsPerPage = 20;
                this.currentStoreId = null;
                this.currentCompanyId = null;
                this.currencySymbol = '$'; // Default currency symbol
                this.currencyCode = 'USD'; // Default currency code
                this.totalPages = 0; // Total pages from response
                this.hasNext = false; // Has next page from response
                this.currentSearchTerm = ''; // Current search term
                this.searchDebounceTimer = null; // Debounce timer for search
                // Product detail modal change tracking
                this.originalProductData = null;
                this.hasUnsavedChanges = false;
                this.isSaving = false; // Flag to prevent duplicate save submissions
                // Modal initialization flags to prevent duplicate event listeners
                this.brandModalInitialized = false;
                this.categoryModalInitialized = false;
                this.imageUploadInitialized = false;
                this.productNameValidationInitialized = false;
                this.isSubmittingProduct = false; // Flag to prevent duplicate product creation
                this.isExporting = false; // Flag to prevent duplicate exports
                
                // English labels for product types
                this.productTypeLabels = {
                    'commodity': 'Physical Product',
                    'bundle': 'Bundle/Set',
                    'service': 'Service',
                    'digital': 'Digital Product',
                    'subscription': 'Subscription',
                    'virtual': 'Virtual Product'
                };
                
                this.productTypeDescriptions = {
                    'commodity': 'Physical goods',
                    'bundle': 'Product bundle or set',
                    'service': 'Service product',
                    'digital': 'Digital download',
                    'subscription': 'Recurring subscription',
                    'virtual': 'Virtual product'
                };
                
                // Inventory metadata storage
                this.metadata = {
                    categories: [],
                    brands: [],
                    product_types: [],
                    units: [],
                    stock_status_levels: [],
                    currency: null,
                    validation_rules: null,
                    loaded: false
                };
                
                // TossSelect instances for dropdowns
                this.metadataSelects = {};
                
                // ExcelJS lazy loading state
                this.excelJSLoaded = false;
                this.excelJSLoading = null; // Promise to track loading state
            }
            
            init() {
                // Set up store filter control
                const storeFilterControl = document.getElementById('storeFilterControl');
                storeFilterControl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleStoreFilterDropdown();
                });
                
                // Keyboard navigation for dropdown
                storeFilterControl.addEventListener('keydown', (e) => {
                    this.handleDropdownKeyboard(e);
                });
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.control-section') && !e.target.closest('.store-filter-dropdown')) {
                        this.hideStoreFilterDropdown();
                    }
                });
                
                // Close dropdown on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && this.dropdownOpen) {
                        this.hideStoreFilterDropdown();
                    }
                });
            }
            
            // Lazy load ExcelJS library only when needed
            async loadExcelJS() {
                // If already loaded, return immediately
                if (this.excelJSLoaded) {
                    return true;
                }
                
                // If currently loading, wait for the existing promise
                if (this.excelJSLoading) {
                    return this.excelJSLoading;
                }
                
                // Start loading
                this.excelJSLoading = new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js';
                    script.async = true;
                    
                    script.onload = () => {
                        this.excelJSLoaded = true;
                        this.excelJSLoading = null;
                        console.log('ExcelJS loaded successfully');
                        resolve(true);
                    };
                    
                    script.onerror = () => {
                        this.excelJSLoading = null;
                        console.error('Failed to load ExcelJS');
                        reject(new Error('Failed to load ExcelJS library'));
                    };
                    
                    document.head.appendChild(script);
                });
                
                return this.excelJSLoading;
            }
            
            toggleStoreFilterDropdown() {
                const dropdown = document.getElementById('storeFilterDropdown');
                const isActive = dropdown.classList.contains('active');
                
                if (isActive) {
                    this.hideStoreFilterDropdown();
                } else {
                    this.showStoreFilterDropdown();
                }
            }
            
            handleDropdownKeyboard(e) {
                if (!this.dropdownOpen && (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown')) {
                    e.preventDefault();
                    this.showStoreFilterDropdown();
                    return;
                }
                
                if (!this.dropdownOpen) return;
                
                const options = document.querySelectorAll('.store-filter-dropdown-option');
                const maxIndex = options.length - 1;
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.currentFocusIndex = Math.min(this.currentFocusIndex + 1, maxIndex);
                        this.updateFocusedOption();
                        break;
                        
                    case 'ArrowUp':
                        e.preventDefault();
                        this.currentFocusIndex = Math.max(this.currentFocusIndex - 1, 0);
                        this.updateFocusedOption();
                        break;
                        
                    case 'Enter':
                        e.preventDefault();
                        if (this.currentFocusIndex >= 0) {
                            const focusedOption = options[this.currentFocusIndex];
                            if (focusedOption) {
                                focusedOption.click();
                            }
                        }
                        break;
                        
                    case 'Tab':
                        // Allow tab to close dropdown and move to next element
                        this.hideStoreFilterDropdown();
                        break;
                }
            }
            
            updateFocusedOption() {
                const options = document.querySelectorAll('.store-filter-dropdown-option');
                options.forEach((option, index) => {
                    if (index === this.currentFocusIndex) {
                        option.classList.add('focused');
                        option.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    } else {
                        option.classList.remove('focused');
                    }
                });
            }
            
            showStoreFilterDropdown() {
                const storeFilterDropdown = document.getElementById('storeFilterDropdown');
                const storeFilterControl = document.getElementById('storeFilterControl');
                const storeFilterOptions = document.getElementById('storeFilterOptions');
                
                // Get stores from appState
                if (typeof appState !== 'undefined' && typeof appState.getCompanyStores === 'function') {
                    this.stores = appState.getCompanyStores();
                } else {
                    // Fallback to empty array if appState not available
                    this.stores = [];
                }
                
                // Build dropdown HTML
                let optionsHTML = '';
                
                // Add search field if there are many stores
                if (this.stores.length > 5) {
                    optionsHTML += `
                        <input type="text" 
                            class="store-filter-search" 
                            id="storeFilterSearch" 
                            placeholder="Search stores..."
                            autocomplete="off">
                    `;
                }
                
                // Removed "All Stores" option - first store will be default
                
                // Add individual store options
                this.stores.forEach((store, index) => {
                    // If no store is selected yet, select the first one
                    const isSelected = this.currentStoreFilter ? 
                        store.store_id === this.currentStoreFilter : 
                        index === 0;
                    optionsHTML += `
                        <div class="store-filter-dropdown-option${isSelected ? ' selected' : ''}" data-store-filter="${store.store_id}">
                            <svg class="store-filter-dropdown-option-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75Z"/>
                            </svg>
                            <span class="store-filter-dropdown-option-text">${store.store_name}</span>
                            ${isSelected ? '<svg class="store-filter-dropdown-option-check" fill="currentColor" viewBox="0 0 24 24"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg>' : ''}
                        </div>
                    `;
                });
                
                storeFilterOptions.innerHTML = optionsHTML;
                
                // Add search functionality if search input exists
                const searchInput = document.getElementById('storeFilterSearch');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const options = storeFilterOptions.querySelectorAll('.store-filter-dropdown-option');
                        
                        options.forEach(option => {
                            const textElement = option.querySelector('.store-filter-dropdown-option-text');
                            if (textElement) {
                                const text = textElement.textContent.toLowerCase();
                                if (text.includes(searchTerm) || searchTerm === '') {
                                    option.style.display = 'flex';
                                } else {
                                    option.style.display = 'none';
                                }
                            }
                        });
                    });
                    
                    // Focus search input when dropdown opens
                    setTimeout(() => searchInput.focus(), 100);
                }
                
                // Add click listeners
                storeFilterOptions.querySelectorAll('.store-filter-dropdown-option').forEach((option, index) => {
                    option.addEventListener('click', async () => {
                        const storeFilter = option.dataset.storeFilter;
                        const previousStoreFilter = this.currentStoreFilter;
                        
                        // Only reload if store actually changed
                        if (storeFilter !== previousStoreFilter) {
                            this.currentStoreFilter = storeFilter;
                            
                            // Update label
                            const labelElement = document.getElementById('storeFilterLabel');
                            const store = this.stores.find(s => s.store_id === storeFilter);
                            labelElement.textContent = store ? store.store_name : 'Unknown Store';
                            
                            // Update visual selection in dropdown
                            storeFilterOptions.querySelectorAll('.store-filter-dropdown-option').forEach(opt => {
                                opt.classList.remove('selected');
                                const checkIcon = opt.querySelector('.store-filter-dropdown-option-check');
                                if (checkIcon) checkIcon.remove();
                            });
                            
                            option.classList.add('selected');
                            option.innerHTML += '<svg class="store-filter-dropdown-option-check" fill="currentColor" viewBox="0 0 24 24"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg>';
                            
                            // Clear search if active
                            const searchInput = document.getElementById('inventorySearchInput');
                            const clearBtn = document.getElementById('searchClearBtn');
                            if (searchInput && searchInput.value) {
                                searchInput.value = '';
                                if (clearBtn) clearBtn.style.display = 'none';
                            }
                            
                            // Clear search term state and any pending debounce timer
                            this.currentSearchTerm = '';
                            if (this.searchDebounceTimer) {
                                clearTimeout(this.searchDebounceTimer);
                            }
                            
                            // Load inventory for the newly selected store
                            await this.loadInventoryForStore(this.currentStoreFilter);
                        }
                        
                        this.hideStoreFilterDropdown();
                    });
                    
                    // Add hover effect for keyboard navigation
                    option.addEventListener('mouseenter', () => {
                        this.currentFocusIndex = index;
                        this.updateFocusedOption();
                    });
                });
                
                storeFilterDropdown.classList.add('active');
                storeFilterControl.classList.add('dropdown-open');
                this.dropdownOpen = true;
                this.currentFocusIndex = -1;
                
                // Set initial focus based on current selection
                const options = storeFilterOptions.querySelectorAll('.store-filter-dropdown-option');
                options.forEach((option, index) => {
                    if (option.classList.contains('selected')) {
                        this.currentFocusIndex = index;
                        this.updateFocusedOption();
                    }
                });
            }
            
            hideStoreFilterDropdown() {
                const storeFilterDropdown = document.getElementById('storeFilterDropdown');
                const storeFilterControl = document.getElementById('storeFilterControl');
                storeFilterDropdown.classList.remove('active');
                storeFilterControl.classList.remove('dropdown-open');
                this.dropdownOpen = false;
                this.currentFocusIndex = -1;
                
                // Clear all focused states
                const options = document.querySelectorAll('.store-filter-dropdown-option');
                options.forEach(option => option.classList.remove('focused'));
            }
            
            async loadInventoryForStore(storeId) {
                // Get company ID safely
                let companyId = null;
                if (typeof appState !== 'undefined' && typeof appState.getSelectedCompanyId === 'function') {
                    companyId = appState.getSelectedCompanyId();
                }
                // Use fallback if appState not available
                if (!companyId) {
                    companyId = this.currentCompanyId;
                }
                
                const inventoryContent = document.getElementById('inventoryContent');
                
                if (storeId) {
                    // Store the current store ID
                    this.currentStoreId = storeId;
                    this.currentCompanyId = companyId;
                    
                    // Reset page to 1 when changing stores
                    this.currentPage = 1;
                    
                    // Show loading state
                    this.showInventoryInterface();
                    this.showLoadingState();
                    
                    // Load metadata and inventory data in parallel for faster page load
                    const [metadataResult, inventoryResult] = await Promise.all([
                        this.loadInventoryMetadata().catch(err => {
                            console.error('Error loading metadata:', err);
                            return null;
                        }),
                        this.loadInventoryData(1).catch(err => {
                            console.error('Error loading inventory:', err);
                            return null;
                        })
                    ]);
                    
                    // Setup functionality after data loads
                    this.setupSearchFunctionality();
                    this.setupCheckboxFunctionality();
                    this.setupAddProductModal();
                    this.setupProductDetailModal();
                    this.initAddBrandModal();
                    this.initAddCategoryModal();
                } else {
                    // No store selected - show placeholder
                    inventoryContent.innerHTML = `
                        <div class="inventory-placeholder">
                            <div class="inventory-placeholder-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75Z"/>
                                </svg>
                            </div>
                            <h3 class="inventory-placeholder-title">No Store Selected</h3>
                            <p class="inventory-placeholder-text">Please select a store from the dropdown above.</p>
                        </div>
                    `;
                }
                
            }
            
            async loadInventoryData(page = 1, searchTerm = null) {
                try {
                    // Use provided search term or maintain current search term
                    if (searchTerm !== null) {
                        this.currentSearchTerm = searchTerm;
                    }
                    
                    // Build RPC parameters
                    const rpcParams = {
                        p_company_id: this.currentCompanyId,
                        p_store_id: this.currentStoreId,
                        p_page: page,
                        p_limit: this.itemsPerPage
                    };
                    
                    // Add search parameter if search term exists
                    if (this.currentSearchTerm && this.currentSearchTerm.trim() !== '') {
                        rpcParams.p_search = this.currentSearchTerm.trim();
                    }
                    
                    // Check if Supabase client is available
                    if (!window.supabaseClient) {
                        console.error('Supabase client not initialized');
                        this.showErrorState('Database connection not available. Please refresh the page.');
                        return;
                    }
                    
                    // Call the Supabase RPC function with parameters
                    const { data, error } = await window.supabaseClient
                        .rpc('get_inventory_page', rpcParams);
                    
                    if (error) {
                        console.error('Error loading inventory:', error);
                        this.showErrorState(error.message);
                        return;
                    }
                    
                    
                    if (data && data.success && data.data) {
                        // Extract currency information if available
                        if (data.data.currency) {
                            this.currencySymbol = data.data.currency.symbol || '$';
                            this.currencyCode = data.data.currency.code || 'USD';
                            
                            // Update table headers with currency code
                            this.updateCurrencyHeaders();
                        }
                        
                        // Extract pagination information if available
                        if (data.data.pagination) {
                            const pagination = data.data.pagination;
                            this.totalProducts = pagination.total || 0;
                            this.currentPage = pagination.page || page;
                            this.itemsPerPage = pagination.limit || 20;
                            this.totalPages = pagination.total_pages || 0;
                            this.hasNext = pagination.has_next || false;
                        }
                        
                        // Extract products data
                        if (data.data.products && data.data.products.length > 0) {
                            this.currentProducts = data.data.products;
                            
                            // Render the table with real data
                            this.renderTableWithData(this.currentProducts);
                            this.updatePaginationInfo();
                            this.setupPagination();
                        } else {
                            // No products found
                            this.currentProducts = [];
                            this.showEmptyState();
                            this.updatePaginationInfo();
                        }
                    } else {
                        // Invalid response format
                        this.currentProducts = [];
                        this.totalProducts = 0;
                        this.showErrorState('Invalid response format');
                        this.updatePaginationInfo();
                    }
                } catch (err) {
                    console.error('Error calling RPC:', err);
                    this.showErrorState('Failed to load inventory data');
                }
            }
            
            async loadInventoryMetadata() {
                if (this.metadata.loaded) {
                    return; // Already loaded
                }
                
                try {
                    
                    // Prepare RPC parameters
                    const rpcParams = {
                        p_company_id: this.currentCompanyId,
                        p_store_id: this.currentStoreId
                    };
                    
                    
                    // Call the Supabase RPC function with parameters
                    const { data, error } = await window.supabaseClient
                        .rpc('get_inventory_metadata', rpcParams);
                    
                    if (error) {
                        console.error('Error loading inventory metadata:', error);
                        return;
                    }
                    
                    
                    if (data && data.success && data.data) {
                        // Store metadata
                        this.metadata.categories = data.data.categories || [];
                        this.metadata.brands = data.data.brands || [];
                        this.metadata.product_types = data.data.product_types || [];
                        this.metadata.units = data.data.units || [];
                        this.metadata.stock_status_levels = data.data.stock_status_levels || [];
                        this.metadata.currency = data.data.currency || null;
                        this.metadata.validation_rules = data.data.validation_rules || null;
                        this.metadata.loaded = true;
                        
                        
                        // Update currency if available
                        if (this.metadata.currency) {
                            this.currencySymbol = this.metadata.currency.symbol || '$';
                            this.currencyCode = this.metadata.currency.code || 'USD';
                        }
                    } else {
                        console.error('Invalid metadata response format');
                    }
                } catch (err) {
                    console.error('Error calling get_inventory_metadata RPC:', err);
                }
            }
            
            createMetadataSelects() {
                if (!this.metadata.loaded) {
                    console.warn('Metadata not loaded yet, skipping TossSelect creation');
                    return;
                }
                
                // Destroy existing selects if they exist
                if (this.metadataSelects.category) {
                    this.metadataSelects.category.destroy();
                    this.metadataSelects.category = null;
                }
                if (this.metadataSelects.brand) {
                    this.metadataSelects.brand.destroy();
                    this.metadataSelects.brand = null;
                }
                if (this.metadataSelects.productType) {
                    this.metadataSelects.productType.destroy();
                    this.metadataSelects.productType = null;
                }
                if (this.metadataSelects.unit) {
                    this.metadataSelects.unit.destroy();
                    this.metadataSelects.unit = null;
                }
                
                try {
                    // Create Category Select
                    this.metadataSelects.category = new TossSelect({
                        containerId: 'detailCategoryContainer',
                        name: 'detailCategory',
                        placeholder: 'Select category',
                        options: this.metadata.categories.map(cat => ({
                            value: cat.category_id,
                            label: cat.category_name,
                            description: cat.description
                        })),
                        onChange: (value, option) => {
                            this.detectChanges();
                        },
                        // Enable category dropdown features with "+ Add category" option
                        isCategoryDropdown: true,
                        companyId: this.currentCompanyId,
                        onCategoryAdded: (categoryData) => {
                            // Refresh metadata and update dropdown
                            this.refreshMetadataAfterCategoryAdd(categoryData);
                        }
                    });
                    this.metadataSelects.category.init();
                    
                    // Create Brand Select
                    this.metadataSelects.brand = new TossSelect({
                        containerId: 'detailBrandContainer',
                        name: 'detailBrand',
                        placeholder: 'Select brand',
                        options: this.metadata.brands.map(brand => ({
                            value: brand.brand_id,
                            label: brand.brand_name,
                            description: brand.description
                        })),
                        onChange: (value, option) => {
                            this.detectChanges();
                        },
                        // Enable brand dropdown features with "+ Add brand" option
                        isBrandDropdown: true,
                        companyId: this.currentCompanyId,
                        onBrandAdded: (brandData) => {
                            // Refresh metadata and update dropdown
                            this.refreshMetadataAfterBrandAdd(brandData);
                        }
                    });
                    this.metadataSelects.brand.init();
                    
                    // Create Product Type Select with English labels
                    if (this.metadata.product_types.length > 0) {
                        this.metadataSelects.productType = new TossSelect({
                            containerId: 'detailProductTypeContainer',
                            name: 'detailProductType',
                            placeholder: 'Select product type',
                            options: this.metadata.product_types.map(type => ({
                                value: type.value,
                                label: this.productTypeLabels[type.value] || type.value,
                                description: this.productTypeDescriptions[type.value] || ''
                            })),
                            onChange: (value, option) => {
                                this.detectChanges();
                            }
                        });
                        this.metadataSelects.productType.init();
                    }
                    
                    // Create Unit Select
                    if (this.metadata.units.length > 0) {
                        this.metadataSelects.unit = new TossSelect({
                            containerId: 'detailUnitContainer',
                            name: 'detailUnit',
                            placeholder: 'Select unit',
                            options: this.metadata.units.map(unit => ({
                                value: unit.value,
                                label: `${unit.label} (${unit.symbol})`,
                                description: unit.symbol
                            })),
                            onChange: (value, option) => {
                                this.detectChanges();
                            }
                        });
                        this.metadataSelects.unit.init();
                    }
                    
                } catch (err) {
                    console.error('Error creating metadata selects:', err);
                }
            }
            
            populateMetadataFields(product) {
                try {
                    
                    // Set TossSelect values if product data is available
                    if (this.metadataSelects.category) {
                        if (product.category_id) {
                            this.metadataSelects.category.setValue(product.category_id);
                        } else {
                            this.metadataSelects.category.setValue('');
                        }
                    }
                    
                    if (this.metadataSelects.brand) {
                        if (product.brand_id) {
                            this.metadataSelects.brand.setValue(product.brand_id);
                        } else {
                            this.metadataSelects.brand.setValue('');
                        }
                    }
                    
                    if (this.metadataSelects.productType) {
                        if (product.product_type) {
                            this.metadataSelects.productType.setValue(product.product_type);
                        } else {
                            this.metadataSelects.productType.setValue('');
                        }
                    }
                    
                    if (this.metadataSelects.unit) {
                        if (product.unit) {
                            this.metadataSelects.unit.setValue(product.unit);
                        } else {
                            this.metadataSelects.unit.setValue('');
                        }
                    }
                    
                } catch (err) {
                    console.error('Error populating metadata fields:', err);
                }
            }
            
            showLoadingState() {
                const tableBody = document.getElementById('inventoryTableBody');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div style="color: var(--text-secondary);">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor" style="animation: spin 1s linear infinite;">
                                        <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>
                                    </svg>
                                    <p style="margin-top: 12px;">Loading inventory...</p>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
            
            showErrorState(message) {
                const tableBody = document.getElementById('inventoryTableBody');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div style="color: var(--toss-error);">
                                    <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                                    </svg>
                                    <p style="margin-top: 12px;">${message || 'Failed to load inventory'}</p>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
            
            showEmptyState() {
                const tableBody = document.getElementById('inventoryTableBody');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px;">
                                <div style="color: var(--text-secondary);">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,5V19H5V5H19Z"/>
                                    </svg>
                                    <p style="margin-top: 12px; font-weight: 600;">No products found</p>
                                    <p style="margin-top: 4px; font-size: var(--font-small);">Add products to start managing inventory</p>
                                </div>
                            </td>
                        </tr>
                    `;
                }
            }
            
            renderTableWithData(products) {
                const tableBody = document.getElementById('inventoryTableBody');
                
                if (!products || products.length === 0) {
                    this.showEmptyState();
                    return;
                }
                
                tableBody.innerHTML = products.map(product => {
                    // Extract data from the response structure
                    const productName = product.product_name || 'Unknown Product';
                    const sku = product.sku || 'N/A';
                    const barcode = product.barcode || 'N/A';
                    const quantity = product.stock?.quantity_on_hand || 0;
                    const price = product.price?.selling || 0;
                    const cost = product.price?.cost || 0;
                    const stockLevel = product.status?.stock_level || 'unknown';
                    const isActive = product.status?.is_active || false;
                    
                    // Determine status class and text
                    let statusClass = 'status-in-stock';
                    let statusText = 'In Stock';
                    
                    if (stockLevel === 'out' || quantity === 0) {
                        statusClass = 'status-out-of-stock';
                        statusText = 'Out of Stock';
                    } else if (stockLevel === 'low' || quantity <= 5) {
                        statusClass = 'status-low-stock';
                        statusText = 'Low Stock';
                    }
                    
                    // Determine quantity color class
                    let quantityClass = '';
                    if (quantity === 0) {
                        quantityClass = 'quantity-out';
                    } else if (quantity <= 5) {
                        quantityClass = 'quantity-low';
                    }
                    
                    return `
                        <tr class="product-row" data-product-id="${product.product_id}">
                            <td class="checkbox-cell" data-label="">
                                <input type="checkbox" class="product-checkbox" data-product-id="${product.product_id}">
                            </td>
                            <td class="product-name-cell" data-label="Product Name">
                                <span class="product-name">${this.escapeHtml(productName)}</span>
                            </td>
                            <td class="product-code-cell" data-label="Product Code">
                                <span class="product-code">${this.escapeHtml(sku)}</span>
                            </td>
                            <td class="barcode-cell" data-label="Barcode">
                                <span class="barcode">${this.escapeHtml(barcode)}</span>
                            </td>
                            <td class="quantity-cell" data-label="Quantity">
                                <span class="quantity-value ${quantityClass}">${quantity}</span>
                            </td>
                            <td class="price-cell" data-label="Price">
                                <div class="price-value">${this.formatPrice(price)}</div>
                            </td>
                            <td class="cost-cell" data-label="Cost">
                                <div class="cost-value">${this.formatPrice(cost)}</div>
                            </td>
                            <td class="status-cell" data-label="Status">
                                <span class="status-badge ${statusClass}">
                                    ${statusText.toUpperCase()}
                                </span>
                            </td>
                            <td class="actions-cell" data-label="Actions">
                                <button class="edit-product-btn" data-product-id="${product.product_id}">
                                    <svg fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                                    </svg>
                                    Edit
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                // Set up click handlers for product rows
                this.setupProductRowClickHandlers();
            }
            
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            updateCurrencyHeaders() {
                // Update the price and cost column headers with currency code
                const priceHeader = document.getElementById('priceHeader');
                const costHeader = document.getElementById('costHeader');
                
                if (priceHeader) {
                    priceHeader.textContent = `Price (${this.currencyCode})`;
                }
                
                if (costHeader) {
                    costHeader.textContent = `Cost (${this.currencyCode})`;
                }
            }
            
            showInventoryInterface() {
                const inventoryContent = document.getElementById('inventoryContent');
                inventoryContent.innerHTML = `
                    <!-- Inventory Header with Search -->
                    <div class="inventory-header">
                        <div class="inventory-title-section">
                            <h2 class="inventory-title">Products</h2>
                            <div class="inventory-search-wrapper">
                                <svg class="search-icon" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                                <input 
                                    type="text" 
                                    class="inventory-search" 
                                    placeholder="Search products..." 
                                    id="inventorySearchInput"
                                />
                                <button class="search-clear" id="searchClearBtn" style="display: none;">
                                    <svg fill="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="inventory-actions">
                            <div class="action-buttons">
                                <button class="toss-btn delete-btn" id="deleteProductBtn" disabled>
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                    </svg>
                                    Delete Product
                                </button>
                                <button class="toss-btn toss-btn-secondary" id="exportExcelBtn">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12.5,10A3.5,3.5 0 0,1 16,13.5A3.5,3.5 0 0,1 12.5,17A3.5,3.5 0 0,1 9,13.5A3.5,3.5 0 0,1 12.5,10M12.5,11.5A2,2 0 0,0 10.5,13.5A2,2 0 0,0 12.5,15.5A2,2 0 0,0 14.5,13.5A2,2 0 0,0 12.5,11.5Z"/>
                                    </svg>
                                    Export Excel
                                </button>
                                <button class="toss-btn toss-btn-secondary" id="importExcelBtn">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,19L8,15H10.5V12H13.5V15H16L12,19Z"/>
                                    </svg>
                                    Import Excel
                                </button>
                                <button class="toss-btn toss-btn-primary" id="addProductBtn">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                                    </svg>
                                    Add Product
                                </button>
                            </div>
                            <!-- Hidden file input for Excel import -->
                            <input type="file" id="importExcelFile" accept=".xlsx,.xls" style="display: none;">
                        </div>
                    </div>
                    
                    <!-- Inventory Table -->
                    <div class="inventory-table-wrapper">
                        <table class="inventory-table">
                            <thead>
                                <tr>
                                    <th class="checkbox-cell">
                                        <input type="checkbox" class="select-all-checkbox" id="selectAllCheckbox">
                                    </th>
                                    <th class="product-name-cell">Product Name</th>
                                    <th class="product-code-cell">Product Code</th>
                                    <th class="barcode-cell">Barcode</th>
                                    <th class="quantity-cell">Quantity</th>
                                    <th class="price-cell" id="priceHeader">Price</th>
                                    <th class="cost-cell" id="costHeader">Cost</th>
                                    <th class="status-cell">Status</th>
                                    <th class="actions-cell">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventoryTableBody">
                                <!-- Dummy data rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div class="inventory-pagination">
                        <div class="pagination-info" id="paginationInfo">
                            Showing 1-20 of 50 products
                        </div>
                        <div class="pagination-controls">
                            <div class="pagination-nav">
                                <button class="pagination-nav-btn" id="prevPageBtn" disabled>
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z"/>
                                    </svg>
                                </button>
                                <div id="paginationNumbers">
                                    <button class="pagination-btn active">1</button>
                                    <button class="pagination-btn">2</button>
                                    <button class="pagination-btn">3</button>
                                    <span class="pagination-ellipsis">...</span>
                                    <button class="pagination-btn">6</button>
                                </div>
                                <button class="pagination-nav-btn" id="nextPageBtn">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            updatePaginationInfo() {
                const startIndex = this.totalProducts > 0 ? (this.currentPage - 1) * this.itemsPerPage + 1 : 0;
                const endIndex = Math.min(this.currentPage * this.itemsPerPage, this.totalProducts);
                
                const paginationInfo = document.getElementById('paginationInfo');
                if (paginationInfo) {
                    paginationInfo.textContent = 
                        `Showing ${startIndex}-${endIndex} of ${this.totalProducts} products`;
                }
                
                this.renderPaginationButtons();
            }
            
            renderPaginationButtons() {
                // Use totalPages from response if available, otherwise calculate
                const totalPages = this.totalPages || Math.ceil(this.totalProducts / this.itemsPerPage);
                const paginationNumbers = document.getElementById('paginationNumbers');
                const prevBtn = document.getElementById('prevPageBtn');
                const nextBtn = document.getElementById('nextPageBtn');
                
                if (!paginationNumbers || !prevBtn || !nextBtn) return;
                
                // Update navigation buttons using hasNext from response if available
                prevBtn.disabled = this.currentPage === 1;
                nextBtn.disabled = this.hasNext !== undefined ? !this.hasNext : (this.currentPage === totalPages || totalPages === 0);
                
                // Generate page numbers
                let pagesHTML = '';
                const maxPagesToShow = 5;
                let startPage = Math.max(1, this.currentPage - Math.floor(maxPagesToShow / 2));
                let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);
                
                // Adjust start page if we're near the end
                if (endPage - startPage + 1 < maxPagesToShow) {
                    startPage = Math.max(1, endPage - maxPagesToShow + 1);
                }
                
                // Add first page if not in range
                if (startPage > 1) {
                    pagesHTML += `<button class="pagination-btn" data-page="1">1</button>`;
                    if (startPage > 2) {
                        pagesHTML += `<span class="pagination-ellipsis">...</span>`;
                    }
                }
                
                // Add page numbers in range
                for (let i = startPage; i <= endPage; i++) {
                    pagesHTML += `<button class="pagination-btn ${i === this.currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
                }
                
                // Add last page if not in range
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        pagesHTML += `<span class="pagination-ellipsis">...</span>`;
                    }
                    pagesHTML += `<button class="pagination-btn" data-page="${totalPages}">${totalPages}</button>`;
                }
                
                paginationNumbers.innerHTML = pagesHTML;
                
                // Add click listeners to page buttons
                paginationNumbers.querySelectorAll('.pagination-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const page = parseInt(btn.dataset.page);
                        if (page !== this.currentPage) {
                            // Maintain search term during pagination
                            await this.loadInventoryData(page, this.currentSearchTerm);
                        }
                    });
                });
            }
            
            setupPagination() {
                const prevBtn = document.getElementById('prevPageBtn');
                const nextBtn = document.getElementById('nextPageBtn');
                
                if (prevBtn) {
                    // Remove existing listeners to prevent duplicates
                    const newPrevBtn = prevBtn.cloneNode(true);
                    prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
                    
                    newPrevBtn.addEventListener('click', async () => {
                        if (this.currentPage > 1) {
                            // Maintain search term during pagination
                            await this.loadInventoryData(this.currentPage - 1, this.currentSearchTerm);
                        }
                    });
                }
                
                if (nextBtn) {
                    // Remove existing listeners to prevent duplicates
                    const newNextBtn = nextBtn.cloneNode(true);
                    nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);
                    
                    newNextBtn.addEventListener('click', async () => {
                        const totalPages = this.totalPages || Math.ceil(this.totalProducts / this.itemsPerPage);
                        // Use hasNext if available, otherwise check against totalPages
                        const canGoNext = this.hasNext !== undefined ? this.hasNext : (this.currentPage < totalPages);
                        if (canGoNext) {
                            // Maintain search term during pagination
                            await this.loadInventoryData(this.currentPage + 1, this.currentSearchTerm);
                        }
                    });
                }
            }
            
            formatPrice(price, includeCurrency = false) {
                // Convert price to number and handle zero values
                const numericPrice = parseFloat(price) || 0;
                
                // For zero values, return just "0"
                if (numericPrice === 0) {
                    return '0';
                }
                
                // For non-zero values, remove decimal places and add comma separators
                const formattedNumber = Math.floor(numericPrice).toLocaleString();
                
                // Add currency symbol if requested (legacy support)
                if (includeCurrency) {
                    return `${this.currencySymbol}${formattedNumber}`;
                }
                
                return formattedNumber;
            }
            
            setupSearchFunctionality() {
                const searchInput = document.getElementById('inventorySearchInput');
                const clearBtn = document.getElementById('searchClearBtn');
                
                if (searchInput) {
                    // Set initial value if there's a current search term
                    if (this.currentSearchTerm) {
                        searchInput.value = this.currentSearchTerm;
                        if (clearBtn) clearBtn.style.display = 'block';
                    }
                    
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.trim();
                        
                        // Clear any existing debounce timer
                        if (this.searchDebounceTimer) {
                            clearTimeout(this.searchDebounceTimer);
                        }
                        
                        if (searchTerm) {
                            if (clearBtn) clearBtn.style.display = 'block';
                        } else {
                            if (clearBtn) clearBtn.style.display = 'none';
                        }
                        
                        // Set up debounce timer for server-side search
                        this.searchDebounceTimer = setTimeout(async () => {
                            // Show loading state immediately for better UX
                            this.showLoadingState();
                            // Reset to page 1 when searching
                            await this.loadInventoryData(1, searchTerm);
                        }, 500); // 500ms debounce delay
                    });
                }
                
                if (clearBtn) {
                    clearBtn.addEventListener('click', async () => {
                        if (searchInput) {
                            searchInput.value = '';
                            clearBtn.style.display = 'none';
                            
                            // Clear search term and reload data without search
                            this.currentSearchTerm = '';
                            
                            // Clear any pending debounce timer
                            if (this.searchDebounceTimer) {
                                clearTimeout(this.searchDebounceTimer);
                            }
                            
                            // Reload data without search term
                            await this.loadInventoryData(1, '');
                            searchInput.focus();
                        }
                    });
                }
            }
            
            filterCurrentPageData(searchTerm) {
                const filteredProducts = this.currentProducts.filter(product => {
                    const productName = (product.product_name || '').toLowerCase();
                    const sku = (product.sku || '').toLowerCase();
                    return productName.includes(searchTerm) || sku.includes(searchTerm);
                });
                this.renderTableWithData(filteredProducts);
            }
            
            setupCheckboxFunctionality() {
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                const deleteBtn = document.getElementById('deleteProductBtn');
                
                // Select all checkbox functionality
                selectAllCheckbox.addEventListener('change', () => {
                    const productCheckboxes = document.querySelectorAll('.product-checkbox');
                    productCheckboxes.forEach(checkbox => {
                        checkbox.checked = selectAllCheckbox.checked;
                    });
                    this.updateDeleteButtonState();
                });
                
                // Update delete button state when individual checkboxes change
                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('product-checkbox')) {
                        this.updateSelectAllState();
                        this.updateDeleteButtonState();
                    }
                });
                
                // Delete button click handler
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', () => {
                        this.showDeleteConfirmation();
                    });
                }
                
                // Setup delete confirmation modal handlers
                this.setupDeleteConfirmModal();
            }
            
            updateSelectAllState() {
                const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                const productCheckboxes = document.querySelectorAll('.product-checkbox');
                const checkedCount = document.querySelectorAll('.product-checkbox:checked').length;
                
                if (checkedCount === 0) {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.classList.remove('indeterminate');
                } else if (checkedCount === productCheckboxes.length) {
                    selectAllCheckbox.checked = true;
                    selectAllCheckbox.classList.remove('indeterminate');
                } else {
                    selectAllCheckbox.checked = false;
                    selectAllCheckbox.classList.add('indeterminate');
                }
            }
            
            updateDeleteButtonState() {
                const deleteBtn = document.getElementById('deleteProductBtn');
                const checkedCount = document.querySelectorAll('.product-checkbox:checked').length;
                
                deleteBtn.disabled = checkedCount === 0;
                
                if (checkedCount === 0) {
                    deleteBtn.textContent = 'Delete Product';
                } else if (checkedCount === 1) {
                    deleteBtn.innerHTML = `
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                        </svg>
                        Delete 1 Product
                    `;
                } else {
                    deleteBtn.innerHTML = `
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                        </svg>
                        Delete ${checkedCount} Products
                    `;
                }
            }
            
            setupAddProductModal() {
                const addProductBtn = document.getElementById('addProductBtn');
                const modalOverlay = document.getElementById('addProductModalOverlay');
                const closeModalBtn = document.getElementById('closeModalBtn');
                const cancelModalBtn = document.getElementById('cancelModalBtn');
                const saveProductBtn = document.getElementById('saveProductBtn');
                const addProductForm = document.getElementById('addProductForm');
                
                // Open modal when Add Product button is clicked
                if (addProductBtn) {
                    addProductBtn.addEventListener('click', () => {
                        this.openAddProductModal();
                    });
                }
                
                // Export Excel button event
                const exportExcelBtn = document.getElementById('exportExcelBtn');
                if (exportExcelBtn) {
                    exportExcelBtn.addEventListener('click', () => {
                        this.exportToExcel();
                    });
                }
                
                // Import Excel button event
                const importExcelBtn = document.getElementById('importExcelBtn');
                const importExcelFile = document.getElementById('importExcelFile');
                
                if (importExcelBtn && importExcelFile) {
                    // Open file picker when Import button is clicked
                    importExcelBtn.addEventListener('click', () => {
                        importExcelFile.click();
                    });
                    
                    // Handle file selection
                    importExcelFile.addEventListener('change', async (e) => {
                        if (e.target.files && e.target.files.length > 0) {
                            await this.handleExcelImport();
                        }
                    });
                }
                
                // Close modal when X button is clicked
                if (closeModalBtn) {
                    closeModalBtn.addEventListener('click', () => {
                        this.closeAddProductModal();
                    });
                }
                
                // Close modal when Cancel button is clicked
                if (cancelModalBtn) {
                    cancelModalBtn.addEventListener('click', () => {
                        this.closeAddProductModal();
                    });
                }
                
                // Close modal when clicking outside
                if (modalOverlay) {
                    modalOverlay.addEventListener('click', (e) => {
                        if (e.target === modalOverlay) {
                            this.closeAddProductModal();
                        }
                    });
                }
                
                // Handle Save Product button
                if (saveProductBtn) {
                    saveProductBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        await this.saveNewProduct();
                    });
                }
                
                // Prevent form submission (button handles saving)
                if (addProductForm) {
                    addProductForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        // Don't call saveNewProduct here - button click handles it
                    });
                }
                
                // Close modal on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modalOverlay && modalOverlay.classList.contains('active')) {
                        this.closeAddProductModal();
                    }
                });
            }
            
            setupImageUpload() {
                const imageUploadArea = document.getElementById('imageUploadArea');
                const imageFileInput = document.getElementById('imageFileInput');
                const uploadPlaceholder = document.getElementById('uploadPlaceholder');
                const imagePreview = document.getElementById('imagePreview');
                const removeImageBtn = document.getElementById('removeImageBtn');
                const imageUrlInput = document.getElementById('imageUrlInput');
                const thumbnailUrlInput = document.getElementById('thumbnailUrlInput');
                
                // Flag to prevent multiple file dialogs
                let isFileDialogOpen = false;
                
                // Click on upload area to trigger file input
                if (imageUploadArea) {
                    imageUploadArea.addEventListener('click', (e) => {
                        // Prevent triggering if clicking on remove button or if dialog is already open
                        if (e.target !== removeImageBtn && !removeImageBtn.contains(e.target) && !isFileDialogOpen) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Set flag to prevent multiple dialogs
                            isFileDialogOpen = true;
                            
                            // Reset flag after a delay to allow for dialog close
                            setTimeout(() => {
                                isFileDialogOpen = false;
                            }, 500);
                            
                            // Trigger file input click
                            imageFileInput.click();
                        }
                    });
                    
                    // Drag and drop functionality
                    imageUploadArea.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        imageUploadArea.style.borderColor = 'var(--toss-primary)';
                        imageUploadArea.style.background = '#f0f8ff';
                    });
                    
                    imageUploadArea.addEventListener('dragleave', (e) => {
                        e.preventDefault();
                        imageUploadArea.style.borderColor = '#dee2e6';
                        imageUploadArea.style.background = '#f8f9fa';
                    });
                    
                    imageUploadArea.addEventListener('drop', (e) => {
                        e.preventDefault();
                        imageUploadArea.style.borderColor = '#dee2e6';
                        imageUploadArea.style.background = '#f8f9fa';
                        
                        const files = e.dataTransfer.files;
                        if (files.length > 0 && files[0].type.startsWith('image/')) {
                            this.handleImageFile(files[0]);
                        }
                    });
                }
                
                // Handle file selection
                if (imageFileInput) {
                    // Prevent default behavior and bubbling
                    imageFileInput.addEventListener('click', (e) => {
                        e.stopPropagation();
                    });
                    
                    imageFileInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file && file.type.startsWith('image/')) {
                            this.handleImageFile(file);
                        }
                        // Reset the flag when file is selected or cancelled
                        isFileDialogOpen = false;
                    });
                    
                    // Handle cancel event (focus returns to the input)
                    imageFileInput.addEventListener('cancel', (e) => {
                        isFileDialogOpen = false;
                    });
                }
                
                // Remove image button
                if (removeImageBtn) {
                    removeImageBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        e.preventDefault();
                        this.removeUploadedImage();
                    });
                }
            }
            
            async handleImageFile(file) {
                // Validate file size (max 10MB)
                if (file.size > 10 * 1024 * 1024) {
                    this.showToast('Image size must be less than 10MB', 'error');
                    return;
                }
                
                // Convert to base64 URL for preview
                const reader = new FileReader();
                reader.onload = (e) => {
                    const imageUrl = e.target.result;
                    this.displayUploadedImage(imageUrl);
                    
                    // In a real implementation, you would upload to a server here
                    // For now, we'll use the base64 URL or a placeholder URL
                    this.setImageUrls(imageUrl);
                };
                reader.readAsDataURL(file);
            }
            
            displayUploadedImage(imageUrl) {
                const imageUploadArea = document.getElementById('imageUploadArea');
                const uploadPlaceholder = document.getElementById('uploadPlaceholder');
                const imagePreview = document.getElementById('imagePreview');
                const removeImageBtn = document.getElementById('removeImageBtn');
                
                if (imageUploadArea && uploadPlaceholder && imagePreview && removeImageBtn) {
                    imageUploadArea.classList.add('has-image');
                    uploadPlaceholder.style.display = 'none';
                    imagePreview.src = imageUrl;
                    imagePreview.style.display = 'block';
                    removeImageBtn.style.display = 'flex';
                }
            }
            
            removeUploadedImage() {
                const imageUploadArea = document.getElementById('imageUploadArea');
                const uploadPlaceholder = document.getElementById('uploadPlaceholder');
                const imagePreview = document.getElementById('imagePreview');
                const removeImageBtn = document.getElementById('removeImageBtn');
                const imageFileInput = document.getElementById('imageFileInput');
                const imageUrlInput = document.getElementById('imageUrlInput');
                const thumbnailUrlInput = document.getElementById('thumbnailUrlInput');
                
                if (imageUploadArea && uploadPlaceholder && imagePreview && removeImageBtn) {
                    imageUploadArea.classList.remove('has-image');
                    uploadPlaceholder.style.display = 'block';
                    imagePreview.style.display = 'none';
                    imagePreview.src = '';
                    removeImageBtn.style.display = 'none';
                    
                    if (imageFileInput) {
                        imageFileInput.value = '';
                    }
                    
                    if (imageUrlInput) {
                        imageUrlInput.value = '';
                    }
                    
                    if (thumbnailUrlInput) {
                        thumbnailUrlInput.value = '';
                    }
                }
            }
            
            setImageUrls(imageUrl) {
                const imageUrlInput = document.getElementById('imageUrlInput');
                const thumbnailUrlInput = document.getElementById('thumbnailUrlInput');
                
                // In a real implementation, you would upload to a CDN and get proper URLs
                // For demonstration, we'll use a placeholder URL format
                if (imageUrlInput && thumbnailUrlInput) {
                    // If it's a base64 image, you would normally upload it to a server
                    // For now, we'll use placeholder URLs
                    const timestamp = Date.now();
                    imageUrlInput.value = `https://storage.example.com/products/img_${timestamp}.jpg`;
                    thumbnailUrlInput.value = `https://storage.example.com/products/thumb_${timestamp}.jpg`;
                    
                }
            }
            
            openAddProductModal() {
                const modalOverlay = document.getElementById('addProductModalOverlay');
                const addProductForm = document.getElementById('addProductForm');
                const saveBtn = document.getElementById('saveProductBtn');
                
                if (modalOverlay) {
                    modalOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden'; // Prevent body scroll
                    
                    // Reset form
                    if (addProductForm) {
                        addProductForm.reset();
                    }
                    
                    // Disable save button initially
                    if (saveBtn) {
                        saveBtn.disabled = true;
                    }
                    
                    // Clear image upload area
                    this.removeUploadedImage();
                    
                    // Initialize the dropdown selects with metadata
                    this.initializeAddProductDropdowns();
                    
                    // Setup image upload if not already initialized
                    if (!this.imageUploadInitialized) {
                        this.setupImageUpload();
                        this.imageUploadInitialized = true;
                    }
                    
                    // Setup product name validation if not already initialized
                    if (!this.productNameValidationInitialized) {
                        this.setupProductNameValidation();
                        this.productNameValidationInitialized = true;
                    }
                    
                    // Update currency symbols with current currency from RPC
                    this.updateModalCurrencySymbols();
                    
                    // Focus on first input
                    setTimeout(() => {
                        const firstInput = document.getElementById('productNameInput');
                        if (firstInput) {
                            firstInput.focus();
                        }
                    }, 100);
                }
            }
            
            setupProductNameValidation() {
                const productNameInput = document.getElementById('productNameInput');
                const saveBtn = document.getElementById('saveProductBtn');
                
                if (productNameInput && saveBtn) {
                    // Validate on input
                    productNameInput.addEventListener('input', () => {
                        const hasValue = productNameInput.value.trim().length > 0;
                        saveBtn.disabled = !hasValue;
                    });
                    
                    // Validate on blur
                    productNameInput.addEventListener('blur', () => {
                        const hasValue = productNameInput.value.trim().length > 0;
                        saveBtn.disabled = !hasValue;
                    });
                }
            }
            
            initializeAddProductDropdowns() {
                // Initialize Category dropdown
                const categoryContainer = document.getElementById('addProductCategoryContainer');
                if (categoryContainer) {
                    categoryContainer.innerHTML = ''; // Clear existing
                    
                    new TossSelect({
                        containerId: 'addProductCategoryContainer',
                        name: 'addProductCategory',
                        placeholder: 'Select category',
                        options: this.metadata.categories.map(cat => ({
                            value: cat.category_id,
                            label: cat.category_name,
                            description: cat.parent_category_name || null
                        })),
                        isCategoryDropdown: true,
                        companyId: this.currentCompanyId,
                        onCategoryAdded: (categoryData) => {
                            // Refresh metadata and reinitialize dropdown
                            this.refreshMetadataAfterCategoryAdd(categoryData);
                            this.initializeAddProductDropdowns();
                        }
                    }).init();
                }
                
                // Initialize Brand dropdown
                const brandContainer = document.getElementById('addProductBrandContainer');
                if (brandContainer) {
                    brandContainer.innerHTML = ''; // Clear existing
                    
                    new TossSelect({
                        containerId: 'addProductBrandContainer',
                        name: 'addProductBrand',
                        placeholder: 'Select brand',
                        options: this.metadata.brands.map(brand => ({
                            value: brand.brand_id,
                            label: brand.brand_name,
                            description: brand.description
                        })),
                        isBrandDropdown: true,
                        companyId: this.currentCompanyId,
                        onBrandAdded: (brandData) => {
                            // Refresh metadata and reinitialize dropdown
                            this.refreshMetadataAfterBrandAdd(brandData);
                            this.initializeAddProductDropdowns();
                        }
                    }).init();
                }
                
                // Initialize Unit dropdown
                const unitContainer = document.getElementById('addProductUnitContainer');
                if (unitContainer) {
                    unitContainer.innerHTML = ''; // Clear existing
                    
                    new TossSelect({
                        containerId: 'addProductUnitContainer',
                        name: 'addProductUnit',
                        placeholder: 'Select unit',
                        options: [
                            { value: 'piece', label: 'Piece' },
                            { value: 'kg', label: 'Kilogram (kg)' },
                            { value: 'g', label: 'Gram (g)' },
                            { value: 'l', label: 'Liter (l)' },
                            { value: 'ml', label: 'Milliliter (ml)' },
                            { value: 'box', label: 'Box' },
                            { value: 'pack', label: 'Pack' },
                            { value: 'dozen', label: 'Dozen' },
                            { value: 'meter', label: 'Meter' },
                            { value: 'cm', label: 'Centimeter' }
                        ]
                    }).init();
                }
            }
            
            updateModalCurrencySymbols() {
                const costPricePrefix = document.getElementById('costPricePrefix');
                const sellingPricePrefix = document.getElementById('sellingPricePrefix');
                
                if (costPricePrefix) {
                    costPricePrefix.textContent = this.currencySymbol;
                }
                
                if (sellingPricePrefix) {
                    sellingPricePrefix.textContent = this.currencySymbol;
                }
            }
            
            closeAddProductModal() {
                const modalOverlay = document.getElementById('addProductModalOverlay');
                
                if (modalOverlay) {
                    modalOverlay.classList.remove('active');
                    document.body.style.overflow = ''; // Restore body scroll
                    // Reset submission flag when modal closes
                    this.isSubmittingProduct = false;
                }
            }
            
            // Delete Confirmation Modal Functions
            setupDeleteConfirmModal() {
                const modalOverlay = document.getElementById('deleteConfirmModalOverlay');
                const closeBtn = document.getElementById('closeDeleteModalBtn');
                const cancelBtn = document.getElementById('cancelDeleteBtn');
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                
                // Close modal handlers
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        this.closeDeleteConfirmModal();
                    });
                }
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        this.closeDeleteConfirmModal();
                    });
                }
                
                if (modalOverlay) {
                    modalOverlay.addEventListener('click', (e) => {
                        if (e.target === modalOverlay) {
                            this.closeDeleteConfirmModal();
                        }
                    });
                }
                
                // Confirm delete handler
                if (confirmBtn) {
                    confirmBtn.addEventListener('click', async () => {
                        await this.deleteSelectedProducts();
                    });
                }
                
                // Close on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modalOverlay && modalOverlay.classList.contains('active')) {
                        this.closeDeleteConfirmModal();
                    }
                });
            }
            
            showDeleteConfirmation() {
                const checkedBoxes = document.querySelectorAll('.product-checkbox:checked');
                if (checkedBoxes.length === 0) return;
                
                // Collect selected product data
                const selectedProducts = [];
                checkedBoxes.forEach(checkbox => {
                    const productId = checkbox.dataset.productId;
                    const product = this.currentProducts.find(p => p.product_id === productId);
                    if (product) {
                        selectedProducts.push(product);
                    }
                });
                
                // Store selected products for deletion
                this.productsToDelete = selectedProducts;
                
                // Build modal content
                const modalBody = document.getElementById('deleteConfirmBody');
                let hasStock = selectedProducts.some(p => (p.stock?.quantity_on_hand || 0) > 0);
                
                let content = '';
                
                // Warning if products have stock
                if (hasStock) {
                    content += `
                        <div class="delete-warning">
                            <div class="delete-warning-title"> Warning: Some products have stock</div>
                            <div>Deleting products with stock will remove them from inventory. This action cannot be undone.</div>
                        </div>
                    `;
                }
                
                // Message
                const productCount = selectedProducts.length;
                content += `
                    <p style="margin-bottom: var(--space-4);">
                        Are you sure you want to delete ${productCount} product${productCount > 1 ? 's' : ''}?
                    </p>
                `;
                
                // Product list
                content += '<div class="delete-product-list">';
                selectedProducts.forEach(product => {
                    const quantity = product.stock?.quantity_on_hand || 0;
                    const stockStatus = quantity > 0 
                        ? `<span class="stock-warning">In Stock: ${quantity} units</span>`
                        : '<span>Out of Stock</span>';
                    
                    content += `
                        <div class="delete-product-item">
                            <div class="delete-product-name">${this.escapeHtml(product.product_name)}</div>
                            <div class="delete-product-info">
                                SKU: ${this.escapeHtml(product.sku)}  ${stockStatus}
                            </div>
                        </div>
                    `;
                });
                content += '</div>';
                
                modalBody.innerHTML = content;
                
                // Update button text
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = `
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                            <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                        </svg>
                        Delete ${productCount} Product${productCount > 1 ? 's' : ''}
                    `;
                }
                
                // Show modal
                const modalOverlay = document.getElementById('deleteConfirmModalOverlay');
                if (modalOverlay) {
                    modalOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            closeDeleteConfirmModal() {
                const modalOverlay = document.getElementById('deleteConfirmModalOverlay');
                if (modalOverlay) {
                    modalOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
            
            async deleteSelectedProducts() {
                if (!this.productsToDelete || this.productsToDelete.length === 0) return;
                
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const originalBtnContent = confirmBtn.innerHTML;
                
                // Disable button and show loading
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<svg width="16" height="16" style="margin-right: 8px;"><use href="#spinner-icon"></use></svg> Deleting...';
                
                try {
                    // Prepare product IDs array
                    const productIds = this.productsToDelete.map(p => p.product_id);
                    
                    // Call the delete RPC
                    const { data, error } = await window.supabaseClient.rpc('inventory_delete_product', {
                        p_product_ids: productIds,
                        p_company_id: this.currentCompanyId
                    });
                    
                    if (error) {
                        console.error('Error deleting products:', error);
                        this.showToast('Failed to delete products. Please try again.', 'error');
                        
                        // Re-enable button
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = originalBtnContent;
                        return;
                    }
                    
                    
                    // Handle response
                    if (data && data.success) {
                        const successCount = data.data?.successfully_deleted || 0;
                        const totalRequested = data.data?.total_requested || productIds.length;
                        
                        if (successCount === totalRequested) {
                            this.showToast(`Successfully deleted ${successCount} product${successCount > 1 ? 's' : ''}`, 'success');
                        } else if (successCount > 0) {
                            this.showToast(`Deleted ${successCount} of ${totalRequested} products`, 'warning');
                        } else {
                            this.showToast('No products were deleted', 'warning');
                        }
                        
                        // Close modal
                        this.closeDeleteConfirmModal();
                        
                        // Refresh inventory data
                        await this.loadInventoryData();
                        
                        // Reset selection
                        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
                        if (selectAllCheckbox) {
                            selectAllCheckbox.checked = false;
                            selectAllCheckbox.classList.remove('indeterminate');
                        }
                        
                    } else {
                        this.showToast(data?.message || 'Failed to delete products', 'error');
                        
                        // Re-enable button
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = originalBtnContent;
                    }
                    
                } catch (err) {
                    console.error('Error deleting products:', err);
                    this.showToast('An unexpected error occurred', 'error');
                    
                    // Re-enable button
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = originalBtnContent;
                }
            }
            
            async saveNewProduct() {
                
                // Prevent duplicate submissions
                if (this.isSubmittingProduct) {
                    return;
                }
                
                this.isSubmittingProduct = true;
                
                // Get form elements
                const productNameInput = document.getElementById('productNameInput');
                const skuInput = document.getElementById('skuInput');
                const barcodeInput = document.getElementById('barcodeInput');
                const costPriceInput = document.getElementById('costPriceInput');
                const sellingPriceInput = document.getElementById('sellingPriceInput');
                const initialQuantityInput = document.getElementById('initialQuantityInput');
                const imageUrlInput = document.getElementById('imageUrlInput');
                const thumbnailUrlInput = document.getElementById('thumbnailUrlInput');
                const saveBtn = document.getElementById('saveProductBtn');
                
                // Get dropdown values
                const categorySelect = document.querySelector('#addProductCategoryContainer .toss-select-hidden');
                const brandSelect = document.querySelector('#addProductBrandContainer .toss-select-hidden');
                const unitSelect = document.querySelector('#addProductUnitContainer .toss-select-hidden');
                
                console.log('Form values:', {
                    productName: productNameInput?.value,
                    sku: skuInput?.value,
                    barcode: barcodeInput?.value,
                    category: categorySelect?.value,
                    brand: brandSelect?.value,
                    unit: unitSelect?.value,
                    costPrice: costPriceInput?.value,
                    sellingPrice: sellingPriceInput?.value,
                    initialQuantity: initialQuantityInput?.value,
                    imageUrl: imageUrlInput?.value,
                    thumbnailUrl: thumbnailUrlInput?.value
                });
                
                // Validate required context
                if (!this.currentCompanyId) {
                    console.error('No company ID available');
                    this.showToast('Company ID is missing. Please refresh the page.', 'error');
                    this.isSubmittingProduct = false;
                    return;
                }
                
                // Validate required fields
                if (!productNameInput.value.trim()) {
                    this.showToast('Product name is required', 'error');
                    productNameInput.focus();
                    this.isSubmittingProduct = false;
                    return;
                }
                
                // Disable save button and show loading state
                const originalBtnText = saveBtn.innerHTML;
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<svg width="16" height="16" style="margin-right: 8px;"><use href="#spinner-icon"></use></svg> Creating...';
                
                try {
                    // Build RPC parameters according to the specification
                    const rpcParams = {
                        // Required parameters
                        p_company_id: this.currentCompanyId,
                        p_product_name: productNameInput.value.trim()
                    };
                    
                    // Optional parameters - only add if they have values
                    
                    // SKU - null for auto-generation
                    const skuValue = skuInput.value.trim();
                    if (skuValue) {
                        rpcParams.p_sku = skuValue;
                    } else {
                        rpcParams.p_sku = null;  // Auto-generate
                    }
                    
                    // Barcode - null for auto-generation
                    const barcodeValue = barcodeInput.value.trim();
                    if (barcodeValue) {
                        rpcParams.p_barcode = barcodeValue;
                    } else {
                        rpcParams.p_barcode = null;  // Auto-generate
                    }
                    
                    // Category ID
                    if (categorySelect && categorySelect.value) {
                        rpcParams.p_category_id = categorySelect.value;  // Already a UUID string
                    }
                    
                    // Brand ID
                    if (brandSelect && brandSelect.value) {
                        rpcParams.p_brand_id = brandSelect.value;  // Already a UUID string
                    }
                    
                    // Unit
                    if (unitSelect && unitSelect.value) {
                        rpcParams.p_unit = unitSelect.value;
                    }
                    
                    // Cost Price
                    if (costPriceInput.value && parseFloat(costPriceInput.value) > 0) {
                        rpcParams.p_cost_price = parseFloat(costPriceInput.value);
                    }
                    
                    // Selling Price
                    if (sellingPriceInput.value && parseFloat(sellingPriceInput.value) > 0) {
                        rpcParams.p_selling_price = parseFloat(sellingPriceInput.value);
                    }
                    
                    // Image URLs
                    if (imageUrlInput.value.trim()) {
                        rpcParams.p_image_url = imageUrlInput.value.trim();
                    }
                    
                    if (thumbnailUrlInput.value.trim()) {
                        rpcParams.p_thumbnail_url = thumbnailUrlInput.value.trim();
                    }
                    
                    // Initial Quantity
                    if (initialQuantityInput.value && parseFloat(initialQuantityInput.value) > 0) {
                        rpcParams.p_initial_quantity = parseFloat(initialQuantityInput.value);
                    }
                    
                    // Store ID for initial stock
                    if (this.currentStoreId) {
                        rpcParams.p_store_id = this.currentStoreId;
                    }
                    
                    
                    // Call the inventory_create_product RPC
                    const { data, error } = await window.supabaseClient.rpc('inventory_create_product', rpcParams);
                    
                    if (error) {
                        console.error('Error creating product:', error);
                        
                        // Handle specific error codes
                        let errorMessage = 'Failed to create product';
                        if (error.code === 'DUPLICATE_SKU') {
                            errorMessage = 'This SKU already exists. Please use a different SKU.';
                        } else if (error.code === 'DUPLICATE_BARCODE') {
                            errorMessage = 'This barcode already exists. Please use a different barcode.';
                        } else if (error.code === 'FOREIGN_KEY_ERROR') {
                            errorMessage = 'Invalid category or brand selected.';
                        } else if (error.message) {
                            errorMessage = error.message;
                        }
                        
                        this.showToast(errorMessage, 'error');
                        
                        // Re-enable save button on error
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalBtnText;
                        this.isSubmittingProduct = false;
                        return;
                    }
                    
                    
                    // Show success message with auto-generated info if applicable
                    let successMessage = 'Product created successfully';
                    
                    // Handle different response structures
                    // The RPC might return the data directly or wrapped
                    const productData = data?.data || data;
                    
                    if (productData) {
                        
                        // Check for auto-generated values
                        const autoGenerated = [];
                        
                        // If SKU was auto-generated (we sent null and got a value back)
                        if (!rpcParams.p_sku && productData.sku) {
                            autoGenerated.push(`SKU: ${productData.sku}`);
                        }
                        
                        // If barcode was auto-generated (we sent null and got a value back)
                        if (!rpcParams.p_barcode && productData.barcode) {
                            autoGenerated.push(`Barcode: ${productData.barcode}`);
                        }
                        
                        if (autoGenerated.length > 0) {
                            successMessage += ` (Auto-generated: ${autoGenerated.join(', ')})`;
                        }
                    }
                    
                    // Close the modal first
                    this.closeAddProductModal();
                    
                    // Show success message
                    this.showToast(successMessage, 'success');
                    
                    // Refresh the inventory page data
                    await this.loadInventoryData();
                    
                    // Reset submission flag after successful creation
                    this.isSubmittingProduct = false;
                    
                } catch (err) {
                    console.error('Error saving product:', err);
                    this.showToast('An unexpected error occurred while creating the product', 'error');
                    
                    // Re-enable save button on error
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalBtnText;
                    this.isSubmittingProduct = false;
                }
            }
            
            // Product Detail Modal Functions
            setupProductRowClickHandlers() {
                // Set up click handlers for edit buttons only
                const editButtons = document.querySelectorAll('.edit-product-btn');
                
                editButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent event bubbling
                        const productId = button.dataset.productId;
                        this.showProductDetailModal(productId);
                    });
                });
            }
            
            setupProductDetailModal() {
                const closeDetailBtn = document.getElementById('closeProductDetailBtn');
                const cancelDetailBtn = document.getElementById('cancelDetailBtn');
                const saveDetailBtn = document.getElementById('saveDetailBtn');
                const modalOverlay = document.getElementById('productDetailModalOverlay');
                
                // Close modal handlers
                if (closeDetailBtn) {
                    closeDetailBtn.addEventListener('click', () => {
                        this.closeProductDetailModal();
                    });
                }
                
                if (cancelDetailBtn) {
                    cancelDetailBtn.addEventListener('click', () => {
                        this.closeProductDetailModal();
                    });
                }
                
                // Close modal when clicking outside
                if (modalOverlay) {
                    modalOverlay.addEventListener('click', (e) => {
                        if (e.target === modalOverlay) {
                            this.closeProductDetailModal();
                        }
                    });
                }
                
                // Save changes handler
                if (saveDetailBtn) {
                    saveDetailBtn.addEventListener('click', () => {
                        this.saveProductDetailChanges();
                    });
                }
                
                // Close on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && modalOverlay && modalOverlay.classList.contains('active')) {
                        this.closeProductDetailModal();
                    }
                });
            }
            
            async showProductDetailModal(productId) {
                const product = this.getProductById(productId);
                if (!product) {
                    console.error('Product not found:', productId);
                    return;
                }
                
                // Ensure metadata is loaded first
                if (!this.metadata.loaded) {
                    await this.loadInventoryMetadata();
                }
                
                const modalOverlay = document.getElementById('productDetailModalOverlay');
                
                // Populate modal with product data
                this.populateProductDetailModal(product);
                
                // Show modal
                if (modalOverlay) {
                    modalOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }
            
            populateProductDetailModal(product) {
                // Store original product data for change tracking
                this.originalProductData = JSON.parse(JSON.stringify(product));
                this.hasUnsavedChanges = false;
                
                // Basic product info
                const productNameInput = document.getElementById('detailProductName');
                if (productNameInput) productNameInput.value = product.product_name || '';
                
                // Barcode and SKU fields
                const barcodeInput = document.getElementById('detailBarcode');
                if (barcodeInput) barcodeInput.value = product.barcode || '';
                
                const skuInput = document.getElementById('detailSKU');
                if (skuInput) skuInput.value = product.sku || '';
                
                // Stock info
                const quantityInput = document.getElementById('detailQuantity');
                const quantity = product.stock?.quantity_on_hand || 0;
                
                if (quantityInput) quantityInput.value = quantity;
                
                // Price info - now using editable inputs
                const sellingPrice = product.price?.selling || 0;
                const costPrice = product.price?.cost || 0;
                
                const sellingPriceInput = document.getElementById('detailSellingPrice');
                const costPriceInput = document.getElementById('detailCostPrice');
                const sellingPricePrefix = document.getElementById('sellingPricePrefixDetail');
                const costPricePrefix = document.getElementById('costPricePrefixDetail');
                
                // Update currency prefixes
                if (sellingPricePrefix) sellingPricePrefix.textContent = this.currencySymbol;
                if (costPricePrefix) costPricePrefix.textContent = this.currencySymbol;
                
                // Set price values
                if (sellingPriceInput) sellingPriceInput.value = sellingPrice;
                if (costPriceInput) costPriceInput.value = costPrice;
                
                // Create metadata selects if not already created
                this.createMetadataSelects();
                
                // Populate new metadata fields
                this.populateMetadataFields(product);
                
                // Initialize Save button as disabled
                this.updateSaveButtonState();
                
                // Set up change tracking after a short delay to avoid immediate triggers
                setTimeout(() => {
                    this.setupDetailModalChangeTracking();
                    this.setupPrefixClickHandlers();
                }, 100);
            }
            
            setupPrefixClickHandlers() {
                // Make clicking on currency prefix focus the corresponding input
                const sellingPricePrefix = document.getElementById('sellingPricePrefixDetail');
                const costPricePrefix = document.getElementById('costPricePrefixDetail');
                const sellingPriceInput = document.getElementById('detailSellingPrice');
                const costPriceInput = document.getElementById('detailCostPrice');
                
                if (sellingPricePrefix && sellingPriceInput) {
                    sellingPricePrefix.addEventListener('click', () => {
                        sellingPriceInput.focus();
                    });
                }
                
                if (costPricePrefix && costPriceInput) {
                    costPricePrefix.addEventListener('click', () => {
                        costPriceInput.focus();
                    });
                }
            }
            
            getProductById(productId) {
                return this.currentProducts.find(product => product.product_id === productId);
            }
            
            closeProductDetailModal() {
                const modalOverlay = document.getElementById('productDetailModalOverlay');
                
                if (modalOverlay) {
                    modalOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                }
                
                // Reset change tracking state
                this.hasUnsavedChanges = false;
                this.originalProductData = null;
            }
            
            // Export inventory data to Excel with enhanced save dialog
            async exportToExcel() {
                // Prevent multiple simultaneous exports
                if (this.isExporting) {
                    return;
                }
                
                try {
                    // Set export flag
                    this.isExporting = true;
                    
                    // Initialize products array if not already
                    if (!this.currentProducts) {
                        this.currentProducts = [];
                    }
                    
                    // Show loading state on button
                    const exportBtn = document.getElementById('exportExcelBtn');
                    const originalBtnContent = exportBtn ? exportBtn.innerHTML : '';
                    if (exportBtn) {
                        exportBtn.disabled = true;
                        exportBtn.innerHTML = `
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="animation: spin 1s linear infinite;">
                                <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>
                            </svg>
                            Preparing Export...
                        `;
                    }
                    
                    // Load ExcelJS library if not already loaded
                    await this.loadExcelJS();
                    
                    // Create a new workbook using ExcelJS
                    const workbook = new ExcelJS.Workbook();
                    const worksheet = workbook.addWorksheet('Inventory');
                    
                    // Define columns with headers and widths
                    worksheet.columns = [
                        { header: 'Product Code (SKU)', key: 'sku', width: 18 },
                        { header: 'Barcode', key: 'barcode', width: 15 },
                        { header: 'Product Name', key: 'product_name', width: 30 },
                        { header: 'Category', key: 'category', width: 20 },
                        { header: 'Brand', key: 'brand', width: 20 },
                        { header: 'Unit', key: 'unit', width: 10 },
                        { header: 'Cost Price', key: 'cost_price', width: 12 },
                        { header: 'Selling Price', key: 'selling_price', width: 12 },
                        { header: 'Current Stock', key: 'current_stock', width: 15 },
                        { header: 'Min Stock', key: 'min_stock', width: 12 },
                        { header: 'Max Stock', key: 'max_stock', width: 12 },
                        { header: 'Reorder Point', key: 'reorder_point', width: 14 },
                        { header: 'Status', key: 'status', width: 10 }
                    ];
                    
                    // Add product data (if any products exist)
                    // If no products, the Excel will only contain headers for template reference
                    this.currentProducts.forEach(product => {
                        worksheet.addRow({
                            sku: product.sku || '',
                            barcode: product.barcode || '',
                            product_name: product.product_name || '',
                            category: product.category_name || '',
                            brand: product.brand_name || '',
                            unit: product.unit || 'piece',
                            cost_price: product.price?.cost || 0,
                            selling_price: product.price?.selling || 0,
                            current_stock: product.stock?.quantity_on_hand || 0,
                            min_stock: product.stock?.min_stock || 0,
                            max_stock: product.stock?.max_stock || '',
                            reorder_point: product.stock?.reorder_point || '',
                            status: product.status?.is_active ? 'Active' : 'Inactive'
                        });
                    });
                    
                    // Style the header row
                    const headerRow = worksheet.getRow(1);
                    headerRow.font = {
                        name: 'Arial',
                        size: 11,
                        bold: true,
                        color: { argb: 'FFFFFFFF' } // White text
                    };
                    headerRow.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FF4472C4' } // Blue background
                    };
                    headerRow.alignment = {
                        vertical: 'middle',
                        horizontal: 'center',
                        wrapText: false
                    };
                    headerRow.height = 25;
                    
                    // Add borders to header cells
                    headerRow.eachCell({ includeEmpty: false }, (cell) => {
                        cell.border = {
                            top: { style: 'thin', color: { argb: 'FF000000' } },
                            left: { style: 'thin', color: { argb: 'FF000000' } },
                            bottom: { style: 'thin', color: { argb: 'FF000000' } },
                            right: { style: 'thin', color: { argb: 'FF000000' } }
                        };
                    });
                    
                    // Add light borders to data cells
                    worksheet.eachRow((row, rowNumber) => {
                        if (rowNumber > 1) {
                            row.eachCell({ includeEmpty: false }, (cell) => {
                                cell.border = {
                                    top: { style: 'thin', color: { argb: 'FFD3D3D3' } },
                                    left: { style: 'thin', color: { argb: 'FFD3D3D3' } },
                                    bottom: { style: 'thin', color: { argb: 'FFD3D3D3' } },
                                    right: { style: 'thin', color: { argb: 'FFD3D3D3' } }
                                };
                                // Center align numeric columns
                                const columnKey = worksheet.getColumn(cell.col).key;
                                if (['cost_price', 'selling_price', 'current_stock', 'min_stock', 'max_stock', 'reorder_point'].includes(columnKey)) {
                                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                                }
                            });
                        }
                    });
                    
                    // Freeze the header row
                    worksheet.views = [
                        { state: 'frozen', ySplit: 1 }
                    ];
                    
                    // Generate filename with current date
                    const today = new Date();
                    const dateStr = today.getFullYear() + 
                                   String(today.getMonth() + 1).padStart(2, '0') + 
                                   String(today.getDate()).padStart(2, '0');
                    const storeName = this.stores.find(s => s.store_id === this.currentStoreFilter)?.store_name || 'AllStores';
                    const filename = `Inventory_${storeName}_${dateStr}.xlsx`;
                    
                    // Generate Excel file buffer
                    const buffer = await workbook.xlsx.writeBuffer();
                    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    
                    // Flag to track if download was successful
                    let downloadHandled = false;
                    
                    // Check if File System Access API is truly supported and working
                    const isFileSystemAPISupported = 'showSaveFilePicker' in window && 
                                                    window.isSecureContext && 
                                                    !window.location.protocol.includes('file:');
                    
                    if (isFileSystemAPISupported) {
                        try {
                            // Modern browsers with File System Access API support
                            const handle = await window.showSaveFilePicker({
                                suggestedName: filename,
                                types: [
                                    {
                                        description: 'Excel Files',
                                        accept: {
                                            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']
                                        }
                                    }
                                ],
                                excludeAcceptAllOption: true
                            });
                            
                            // Write the file
                            const writable = await handle.createWritable();
                            await writable.write(blob);
                            await writable.close();
                            
                            downloadHandled = true;
                            
                            // Show success message
                            const productCount = this.currentProducts.length;
                            const successMessage = productCount > 0 
                                ? ` Export Successful! ${productCount} products exported to: ${filename}`
                                : ` Export Successful! Template with headers exported to: ${filename}`;
                            
                            // Show custom success alert
                            if (typeof TossAlertUtils !== 'undefined' && TossAlertUtils.showSuccess) {
                                TossAlertUtils.showSuccess(successMessage, {
                                    duration: 5000
                                });
                            } else {
                                const alertMessage = productCount > 0
                                    ? `Successfully exported ${productCount} products to ${filename}`
                                    : `Successfully exported template with headers to ${filename}`;
                                alert(alertMessage);
                            }
                            
                        } catch (err) {
                            
                            if (err.name === 'AbortError') {
                                // User cancelled - no need to fallback
                                downloadHandled = true;
                            } else if (err.name === 'SecurityError' || err.name === 'NotAllowedError') {
                                // Permission or security issue - use fallback
                                downloadHandled = false;
                            } else {
                                // Other error - use fallback
                                downloadHandled = false;
                            }
                        }
                    }
                    
                    // Use fallback only if download wasn't handled by File System API
                    if (!downloadHandled) {
                        this.fallbackExcelDownload(blob, filename);
                    }
                    
                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    if (typeof TossAlertUtils !== 'undefined' && TossAlertUtils.showError) {
                        TossAlertUtils.showError('Failed to export inventory data. Please try again.', {
                            duration: 5000
                        });
                    } else {
                        alert('Failed to export inventory data. Please try again.');
                    }
                } finally {
                    // Reset export flag
                    this.isExporting = false;
                    
                    // Restore button state
                    const exportBtn = document.getElementById('exportExcelBtn');
                    if (exportBtn) {
                        setTimeout(() => {
                            exportBtn.disabled = false;
                            exportBtn.innerHTML = `
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12.5,10A3.5,3.5 0 0,1 16,13.5A3.5,3.5 0 0,1 12.5,17A3.5,3.5 0 0,1 9,13.5A3.5,3.5 0 0,1 12.5,10M12.5,11.5A2,2 0 0,0 10.5,13.5A2,2 0 0,0 12.5,15.5A2,2 0 0,0 14.5,13.5A2,2 0 0,0 12.5,11.5Z"/>
                                </svg>
                                Export Excel
                            `;
                        }, 100);
                    }
                }
            }
            
            // Fallback download method for browsers without File System Access API
            fallbackExcelDownload(blob, filename) {
                try {
                    // Create download link and trigger save dialog
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    // Append to body and trigger download
                    document.body.appendChild(link);
                    link.click();
                    
                    // Clean up immediately
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(url);
                    
                    // Show helpful message after a short delay
                    setTimeout(() => {
                        const helpMessage = ` File "${filename}" is being saved to your browser's default download folder. To change download location, check your browser settings.`;
                        
                        if (typeof TossAlertUtils !== 'undefined' && TossAlertUtils.showInfo) {
                            TossAlertUtils.showInfo(helpMessage, {
                                duration: 8000
                            });
                        } else {
                            alert(`File "${filename}" is being downloaded to your default downloads folder.\n\nTo change the download location, update your browser settings.`);
                        }
                    }, 200);
                    
                } catch (error) {
                    console.error('Fallback download error:', error);
                    throw error; // Re-throw to be caught by the main error handler
                }
            }
            
            // Excel Import Methods
            async handleExcelImport() {
                const fileInput = document.getElementById('importExcelFile');
                const file = fileInput.files[0];
                
                if (!file) {
                    if (typeof TossAlertUtils !== 'undefined' && TossAlertUtils.showWarning) {
                        TossAlertUtils.showWarning('Please select an Excel file', { duration: 3000 });
                    } else {
                        alert('Please select an Excel file');
                    }
                    return;
                }
                
                try {
                    // Show loading overlay
                    this.showImportLoading('Loading Excel processor...');
                    
                    // Load ExcelJS library if not already loaded
                    await this.loadExcelJS();
                    
                    // Update loading message
                    this.showImportLoading('Processing Excel file...');
                    
                    // Parse Excel file using ExcelJS
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(await file.arrayBuffer());
                    
                    const worksheet = workbook.getWorksheet(1); // First worksheet
                    const products = [];
                    
                    // Extract data (skip header row)
                    worksheet.eachRow((row, rowNumber) => {
                        if (rowNumber === 1) return; // Skip header row
                        
                        // Get cell values by column number (product_id removed from Excel columns)
                        const productData = {
                            product_id: null,                                    // Not read from Excel, set to null
                            sku: row.getCell(1).value || null,                  // Column A - SKU
                            barcode: row.getCell(2).value || null,              // Column B - Barcode
                            product_name: row.getCell(3).value || '',           // Column C - Product Name
                            category: row.getCell(4).value || null,             // Column D - Category
                            brand: row.getCell(5).value || null,                // Column E - Brand
                            unit: row.getCell(6).value || 'piece',              // Column F - Unit
                            cost_price: parseFloat(row.getCell(7).value) || 0,         // Column G - Cost Price
                            selling_price: parseFloat(row.getCell(8).value) || 0,      // Column H - Selling Price
                            current_stock: parseFloat(row.getCell(9).value) || 0,      // Column I - Current Stock
                            min_stock: parseFloat(row.getCell(10).value) || 0,         // Column J - Min Stock
                            max_stock: parseFloat(row.getCell(11).value) || 0,         // Column K - Max Stock
                            reorder_point: parseFloat(row.getCell(12).value) || 0,     // Column L - Reorder Point
                            status: row.getCell(13).value || 'Active'           // Column M - Status
                        };
                        
                        // Data validation and cleaning
                        if (productData.product_name) {
                            // product_id is always null from Excel import (not read from file)
                            
                            // Convert all string fields to proper strings
                            if (productData.sku !== null) productData.sku = String(productData.sku).trim();
                            if (productData.barcode !== null) productData.barcode = String(productData.barcode).trim();
                            if (productData.product_name) productData.product_name = String(productData.product_name).trim();
                            if (productData.category !== null) productData.category = String(productData.category).trim();
                            if (productData.brand !== null) productData.brand = String(productData.brand).trim();
                            if (productData.unit) productData.unit = String(productData.unit).toLowerCase().trim();
                            if (productData.status) productData.status = String(productData.status).trim();
                            
                            // Convert empty strings to null
                            if (productData.sku === '') productData.sku = null;
                            if (productData.barcode === '') productData.barcode = null;
                            if (productData.category === '') productData.category = null;
                            if (productData.brand === '') productData.brand = null;
                            
                            // Ensure numeric values are numbers
                            productData.cost_price = isNaN(productData.cost_price) ? 0 : productData.cost_price;
                            productData.selling_price = isNaN(productData.selling_price) ? 0 : productData.selling_price;
                            productData.current_stock = isNaN(productData.current_stock) ? 0 : productData.current_stock;
                            productData.min_stock = isNaN(productData.min_stock) ? 0 : productData.min_stock;
                            productData.max_stock = isNaN(productData.max_stock) ? 0 : productData.max_stock;
                            productData.reorder_point = isNaN(productData.reorder_point) ? 0 : productData.reorder_point;
                            
                            products.push(productData);
                        }
                    });
                    
                    // Check if we have valid data
                    if (products.length === 0) {
                        if (typeof TossAlertUtils !== 'undefined' && TossAlertUtils.showError) {
                            TossAlertUtils.showError('No valid data found in Excel file', { duration: 5000 });
                        } else {
                            alert('No valid data found in Excel file');
                        }
                        this.hideImportLoading();
                        return;
                    }
                    
                    // Get current company, store, and user information
                    const currentCompanyId = this.currentCompanyId;
                    const currentStoreId = this.currentStoreId;
                    
                    // Get user ID from Supabase auth
                    let currentUserId = null;
                    try {
                        const { data: { user } } = await window.supabaseClient.auth.getUser();
                        currentUserId = user?.id;
                    } catch (err) {
                        console.error('Error getting current user:', err);
                    }
                    
                    if (!currentCompanyId || !currentStoreId || !currentUserId) {
                        if (typeof TossAlertUtils !== 'undefined' && TossAlertUtils.showError) {
                            TossAlertUtils.showError('Missing required information. Please refresh and try again.', { duration: 5000 });
                        } else {
                            alert('Missing required information. Please refresh and try again.');
                        }
                        this.hideImportLoading();
                        return;
                    }
                    
                    
                    // Call RPC function
                    const { data: result, error } = await window.supabaseClient.rpc('inventory_import_excel', {
                        p_company_id: currentCompanyId,
                        p_store_id: currentStoreId,
                        p_user_id: currentUserId,
                        p_products: products
                    });
                    
                    // Handle errors
                    if (error) {
                        console.error('Import error:', error);
                        if (typeof TossAlertUtils !== 'undefined' && TossAlertUtils.showError) {
                            TossAlertUtils.showError(`Import failed: ${error.message}`, { duration: 5000 });
                        } else {
                            alert(`Import failed: ${error.message}`);
                        }
                        this.hideImportLoading();
                        return;
                    }
                    
                    // Handle success
                    if (result && result.success) {
                        // Create result message
                        let message = 'Import completed successfully!\n\n';
                        if (result.summary) {
                            message += ` Created: ${result.summary.created || 0} products\n`;
                            message += ` Updated: ${result.summary.updated || 0} products\n`;
                            message += ` Skipped: ${result.summary.skipped || 0} products (no changes)\n`;
                            
                            // Show errors if any
                            if (result.summary.errors && result.summary.errors > 0) {
                                message += `\n Errors: ${result.summary.errors} rows\n`;
                                console.error('Import errors:', result.errors);
                                
                                // Log detailed errors
                                if (result.errors && Array.isArray(result.errors)) {
                                    result.errors.forEach(err => {
                                        console.error(`Row ${err.row}: ${err.error}`, err);
                                    });
                                }
                            }
                        }
                        
                        // Show success message with simple format
                        const created = result.summary?.created || 0;
                        const updated = result.summary?.updated || 0;
                        const skipped = result.summary?.skipped || 0;
                        const errors = result.summary?.errors || 0;
                        
                        const simpleMessage = `Import completed! Created: ${created}, Updated: ${updated}, Skipped: ${skipped}${errors > 0 ? `, Errors: ${errors}` : ''}`;
                        
                        const alertType = (errors > 0) ? 'warning' : 'success';
                        if (typeof TossAlertUtils !== 'undefined') {
                            if (alertType === 'success' && TossAlertUtils.showSuccess) {
                                TossAlertUtils.showSuccess(simpleMessage, { duration: 6000 });
                            } else if (TossAlertUtils.showWarning) {
                                TossAlertUtils.showWarning(simpleMessage, { duration: 6000 });
                            }
                        } else {
                            alert(message);
                        }
                        
                        // Refresh inventory table
                        await this.loadInventoryForStore(currentStoreId);
                        
                        // Reset file input
                        fileInput.value = '';
                    } else {
                        if (typeof TossAlertUtils !== 'undefined' && TossAlertUtils.showError) {
                            TossAlertUtils.showError('Import failed: Unknown error', { duration: 5000 });
                        } else {
                            alert('Import failed: Unknown error');
                        }
                    }
                    
                } catch (error) {
                    console.error('Import failed:', error);
                    if (typeof TossAlertUtils !== 'undefined' && TossAlertUtils.showError) {
                        TossAlertUtils.showError(`Import failed: ${error.message}`, { duration: 5000 });
                    } else {
                        alert(`Import failed: ${error.message}`);
                    }
                } finally {
                    this.hideImportLoading();
                    // Reset file input
                    document.getElementById('importExcelFile').value = '';
                }
            }
            
            // Show loading overlay for import
            showImportLoading(message = 'Loading...') {
                // Remove any existing loading overlay
                this.hideImportLoading();
                
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'importLoadingOverlay';
                loadingDiv.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 9999;
                `;
                loadingDiv.innerHTML = `
                    <div style="background: white; padding: 24px 32px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                        <div style="display: flex; align-items: center; gap: 16px;">
                            <div style="width: 24px; height: 24px; border: 3px solid #f3f3f3; border-top: 3px solid #4472C4; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <span style="font-size: 16px; color: #333; font-weight: 500;">${message}</span>
                        </div>
                    </div>
                `;
                
                // Add spinning animation style if not already present
                if (!document.getElementById('importLoadingSpinnerStyle')) {
                    const style = document.createElement('style');
                    style.id = 'importLoadingSpinnerStyle';
                    style.textContent = `
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(loadingDiv);
            }
            
            // Hide loading overlay
            hideImportLoading() {
                const loadingDiv = document.getElementById('importLoadingOverlay');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }
            
            // Change Detection Methods
            setupDetailModalChangeTracking() {
                const nameInput = document.getElementById('detailProductName');
                const quantityInput = document.getElementById('detailQuantity');
                const sellingPriceInput = document.getElementById('detailSellingPrice');
                const costPriceInput = document.getElementById('detailCostPrice');
                const inputElements = [nameInput, quantityInput, sellingPriceInput, costPriceInput];
                
                inputElements.forEach(input => {
                    if (input) {
                        input.addEventListener('input', () => {
                            this.detectChanges();
                        });
                    }
                });
            }
            
            detectChanges() {
                if (!this.originalProductData) return;
                
                // Get current values for existing fields
                const currentName = document.getElementById('detailProductName')?.value?.trim() || '';
                const currentQuantity = parseInt(document.getElementById('detailQuantity')?.value) || 0;
                const currentSellingPrice = parseFloat(document.getElementById('detailSellingPrice')?.value) || 0;
                const currentCostPrice = parseFloat(document.getElementById('detailCostPrice')?.value) || 0;
                
                // Get current values for new metadata fields
                const currentCategory = this.metadataSelects.category?.getValue() || '';
                const currentBrand = this.metadataSelects.brand?.getValue() || '';
                const currentProductType = this.metadataSelects.productType?.getValue() || '';
                const currentUnit = this.metadataSelects.unit?.getValue() || '';
                
                // Get original values for existing fields
                const originalName = this.originalProductData.product_name || '';
                const originalQuantity = this.originalProductData.stock?.quantity_on_hand || 0;
                const originalSellingPrice = this.originalProductData.price?.selling || 0;
                const originalCostPrice = this.originalProductData.price?.cost || 0;
                
                // Get original values for new metadata fields
                const originalCategory = this.originalProductData.category_id || '';
                const originalBrand = this.originalProductData.brand_id || '';
                const originalProductType = this.originalProductData.product_type || '';
                const originalUnit = this.originalProductData.unit || '';
                
                const hasChanges = (
                    currentName !== originalName ||
                    currentQuantity !== originalQuantity ||
                    currentSellingPrice !== originalSellingPrice ||
                    currentCostPrice !== originalCostPrice ||
                    currentCategory !== originalCategory ||
                    currentBrand !== originalBrand ||
                    currentProductType !== originalProductType ||
                    currentUnit !== originalUnit
                );
                
                this.hasUnsavedChanges = hasChanges;
                this.updateSaveButtonState();
            }
            
            updateSaveButtonState() {
                const saveBtn = document.getElementById('saveDetailBtn');
                if (saveBtn) {
                    saveBtn.disabled = !this.hasUnsavedChanges;
                    if (this.hasUnsavedChanges) {
                        saveBtn.classList.remove('toss-btn-disabled');
                    } else {
                        saveBtn.classList.add('toss-btn-disabled');
                    }
                }
            }
            
            
            async saveProductDetailChanges() {
                if (!this.hasUnsavedChanges || !this.originalProductData) return;
                
                // Prevent duplicate submissions
                if (this.isSaving) {
                    return;
                }
                this.isSaving = true;
                
                // Get current values
                const currentName = document.getElementById('detailProductName')?.value?.trim() || '';
                const currentQuantity = parseInt(document.getElementById('detailQuantity')?.value) || 0;
                const currentSellingPrice = parseFloat(document.getElementById('detailSellingPrice')?.value) || 0;
                const currentCostPrice = parseFloat(document.getElementById('detailCostPrice')?.value) || 0;
                
                // Get current values for metadata fields
                const currentCategory = this.metadataSelects.category?.getValue() || null;
                const currentBrand = this.metadataSelects.brand?.getValue() || null;
                const currentProductType = this.metadataSelects.productType?.getValue() || null;
                const currentUnit = this.metadataSelects.unit?.getValue() || null;
                
                // Get original values
                const originalName = this.originalProductData.product_name || '';
                const originalQuantity = this.originalProductData.stock?.quantity_on_hand || 0;
                const originalSellingPrice = this.originalProductData.price?.selling || 0;
                const originalCostPrice = this.originalProductData.price?.cost || 0;
                const originalCategory = this.originalProductData.category_id || null;
                const originalBrand = this.originalProductData.brand_id || null;
                const originalProductType = this.originalProductData.product_type || null;
                const originalUnit = this.originalProductData.unit || null;
                
                // Build RPC parameters - only include changed fields
                const rpcParams = {
                    p_company_id: this.currentCompanyId,
                    p_store_id: this.currentStoreId,
                    p_product_id: this.originalProductData.product_id
                };
                
                // Add only changed fields to RPC params
                if (currentName !== originalName) {
                    rpcParams.p_product_name = currentName;
                }
                if (currentCategory !== originalCategory) {
                    rpcParams.p_category_id = currentCategory || null;
                }
                if (currentBrand !== originalBrand) {
                    rpcParams.p_brand_id = currentBrand || null;
                }
                if (currentProductType !== originalProductType) {
                    rpcParams.p_product_type = currentProductType || null;
                }
                if (currentUnit !== originalUnit) {
                    rpcParams.p_unit = currentUnit || null;
                }
                if (currentSellingPrice !== originalSellingPrice) {
                    rpcParams.p_selling_price = currentSellingPrice;
                }
                if (currentCostPrice !== originalCostPrice) {
                    rpcParams.p_cost_price = currentCostPrice;
                }
                if (currentQuantity !== originalQuantity) {
                    rpcParams.p_new_quantity = currentQuantity;
                }
                
                // Disable save button and show loading state
                const saveBtn = document.getElementById('saveDetailBtn');
                const originalBtnText = saveBtn ? saveBtn.innerHTML : '';
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = `
                        <svg width="16" height="16" class="toss-spinner" viewBox="0 0 24 24">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" stroke-dasharray="31.416" stroke-dashoffset="10.472">
                                <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="0.8s" repeatCount="indefinite"/>
                            </circle>
                        </svg>
                        Saving...
                    `;
                }
                
                try {
                    
                    // Call the inventory_edit_product RPC
                    const { data, error } = await window.supabaseClient.rpc('inventory_edit_product', rpcParams);
                    
                    if (error) {
                        console.error('Error updating product:', error);
                        this.showToast('Failed to update product. Please try again.', 'error');
                        
                        // Re-enable save button on error
                        if (saveBtn) {
                            saveBtn.disabled = false;
                            saveBtn.innerHTML = originalBtnText;
                        }
                        return;
                    }
                    
                    
                    // Show success message
                    this.showToast('Product updated successfully', 'success');
                    
                    // Close modal first to show the user that the action is complete
                    this.hasUnsavedChanges = false;
                    this.originalProductData = null;
                    this.closeProductDetailModal();
                    
                    // Reload inventory data to reflect changes
                    
                    // If category or brand was changed, refresh metadata to ensure consistency
                    if (rpcParams.p_category_id !== undefined || rpcParams.p_brand_id !== undefined) {
                        this.metadata.loaded = false;
                        await this.loadInventoryMetadata();
                    }
                    
                    // Call get_inventory_page RPC to fetch updated data
                    // Include current search term to maintain search state
                    await this.loadInventoryData(this.currentPage, this.currentSearchTerm);
                    
                } catch (err) {
                    console.error('Error calling inventory_edit_product RPC:', err);
                    this.showToast('An error occurred. Please try again.', 'error');
                    
                    // Re-enable save button on error
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalBtnText;
                    }
                } finally {
                    // Reset saving flag
                    this.isSaving = false;
                }
            }
            
            // Add Brand Modal Methods
            initAddBrandModal() {
                // Check if already initialized to prevent duplicate event listeners
                if (this.brandModalInitialized) {
                    return;
                }
                
                const modal = document.getElementById('addBrandModal');
                const closeBtn = document.getElementById('closeAddBrandBtn');
                const cancelBtn = document.getElementById('cancelAddBrandBtn');
                const submitBtn = document.getElementById('submitAddBrandBtn');
                const brandNameInput = document.getElementById('brandNameInput');
                const brandCodeInput = document.getElementById('brandCodeInput');
                const brandNameMessage = document.getElementById('brandNameMessage');
                
                if (!modal || !submitBtn || !brandNameInput) return;
                
                // Store bound functions for potential cleanup
                this.brandSubmitHandler = this.submitNewBrand.bind(this);
                
                // Close modal handlers
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        this.closeAddBrandModal();
                    });
                }
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        this.closeAddBrandModal();
                    });
                }
                
                // Click outside to close
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeAddBrandModal();
                    }
                });
                
                // Brand name input validation
                brandNameInput.addEventListener('input', () => {
                    const value = brandNameInput.value.trim();
                    if (value.length > 0) {
                        submitBtn.disabled = false;
                        brandNameMessage.textContent = '';
                        brandNameMessage.classList.remove('error');
                    } else {
                        submitBtn.disabled = true;
                    }
                });
                
                // Submit handler - bind the correct context
                submitBtn.addEventListener('click', this.brandSubmitHandler);
                
                // Enter key submission
                brandNameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !submitBtn.disabled) {
                        this.submitNewBrand();
                    }
                });
                
                if (brandCodeInput) {
                    brandCodeInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !submitBtn.disabled) {
                            this.submitNewBrand();
                        }
                    });
                }
                
                // Mark as initialized
                this.brandModalInitialized = true;
            }
            
            openAddBrandModal() {
                const modal = document.getElementById('addBrandModal');
                const brandNameInput = document.getElementById('brandNameInput');
                const brandCodeInput = document.getElementById('brandCodeInput');
                const submitBtn = document.getElementById('submitAddBrandBtn');
                const brandNameMessage = document.getElementById('brandNameMessage');
                
                if (!modal) return;
                
                // Reset form
                if (brandNameInput) {
                    brandNameInput.value = '';
                }
                if (brandCodeInput) {
                    brandCodeInput.value = '';
                }
                if (submitBtn) {
                    submitBtn.disabled = true;
                }
                if (brandNameMessage) {
                    brandNameMessage.textContent = '';
                    brandNameMessage.classList.remove('error');
                }
                
                // Show modal
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Focus on brand name input
                setTimeout(() => {
                    if (brandNameInput) {
                        brandNameInput.focus();
                    }
                }, 100);
            }
            
            closeAddBrandModal() {
                const modal = document.getElementById('addBrandModal');
                
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
            }
            
            async submitNewBrand() {
                const brandNameInput = document.getElementById('brandNameInput');
                const brandCodeInput = document.getElementById('brandCodeInput');
                const submitBtn = document.getElementById('submitAddBrandBtn');
                const brandNameMessage = document.getElementById('brandNameMessage');
                
                if (!brandNameInput || !submitBtn) return;
                
                const brandName = brandNameInput.value.trim();
                const brandCode = brandCodeInput ? brandCodeInput.value.trim() : null;
                
                if (!brandName) {
                    if (brandNameMessage) {
                        brandNameMessage.textContent = 'Brand name is required';
                        brandNameMessage.classList.add('error');
                    }
                    return;
                }
                
                // Disable submit button and show loading state
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Adding...';
                
                try {
                    // Call the inventory_create_brand RPC
                    const { data, error } = await window.supabaseClient.rpc('inventory_create_brand', {
                        p_company_id: this.currentCompanyId,
                        p_brand_name: brandName,
                        p_brand_code: brandCode || null
                    });
                    
                    if (error) {
                        console.error('Error creating brand:', error);
                        
                        // Check for duplicate brand error
                        if (error.message && error.message.includes('DUPLICATE_BRAND')) {
                            if (brandNameMessage) {
                                brandNameMessage.textContent = 'A brand with this name already exists';
                                brandNameMessage.classList.add('error');
                            }
                        } else {
                            if (brandNameMessage) {
                                brandNameMessage.textContent = 'Failed to create brand. Please try again.';
                                brandNameMessage.classList.add('error');
                            }
                        }
                        
                        // Re-enable submit button
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }
                    
                    // Success - close modal and refresh metadata
                    this.closeAddBrandModal();
                    
                    // Refresh metadata from server - force reload by resetting the loaded flag
                    this.metadata.loaded = false;
                    await this.loadInventoryMetadata();
                    
                    // Recreate the brand dropdown with updated options
                    if (this.metadataSelects.brand) {
                        // Destroy the existing TossSelect instance
                        if (this.metadataSelects.brand.destroy) {
                            this.metadataSelects.brand.destroy();
                        }
                        
                        // Recreate the brand select with updated options
                        const brandContainer = document.getElementById('detailBrandContainer');
                        if (brandContainer) {
                            // Clear the container
                            brandContainer.innerHTML = '';
                            
                            // Recreate the TossSelect with new options
                            this.metadataSelects.brand = new TossSelect({
                                containerId: 'detailBrandContainer',
                                name: 'detailBrand',
                                placeholder: 'Select brand',
                                options: this.metadata.brands.map(brand => ({
                                    value: brand.brand_id,
                                    label: brand.brand_name,
                                    description: brand.description
                                })),
                                onChange: (value, option) => {
                                    this.detectChanges();
                                },
                                // Enable brand dropdown features with "+ Add brand" option
                                isBrandDropdown: true,
                                companyId: this.currentCompanyId,
                                onBrandAdded: (brandData) => {
                                    // Refresh metadata and update dropdown
                                    this.refreshMetadataAfterBrandAdd(brandData);
                                }
                            });
                            this.metadataSelects.brand.init();
                            
                            // If there's a new brand created, select it
                            if (data && data.brand_id) {
                                this.metadataSelects.brand.setValue(data.brand_id);
                                this.detectChanges();
                            }
                        }
                    }
                    
                    // Show success message
                    this.showToast('Brand created successfully', 'success');
                    
                } catch (err) {
                    console.error('Error calling inventory_create_brand RPC:', err);
                    
                    if (brandNameMessage) {
                        brandNameMessage.textContent = 'An error occurred. Please try again.';
                        brandNameMessage.classList.add('error');
                    }
                    
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
            
            async refreshMetadataAfterBrandAdd(brandData) {
                // Refresh metadata from server - force reload by resetting the loaded flag
                this.metadata.loaded = false;
                await this.loadInventoryMetadata();
                
                // Recreate the brand dropdown with updated options
                if (this.metadataSelects.brand) {
                    // Destroy the existing TossSelect instance
                    if (this.metadataSelects.brand.destroy) {
                        this.metadataSelects.brand.destroy();
                    }
                    
                    // Recreate the brand select with updated options
                    const brandContainer = document.getElementById('detailBrandContainer');
                    if (brandContainer) {
                        // Clear the container
                        brandContainer.innerHTML = '';
                        
                        // Recreate the TossSelect with new options
                        this.metadataSelects.brand = new TossSelect({
                            containerId: 'detailBrandContainer',
                            name: 'detailBrand',
                            placeholder: 'Select brand',
                            options: this.metadata.brands.map(brand => ({
                                value: brand.brand_id,
                                label: brand.brand_name,
                                description: brand.description
                            })),
                            onChange: (value, option) => {
                                this.detectChanges();
                            },
                            // Enable brand dropdown features with "+ Add brand" option
                            isBrandDropdown: true,
                            companyId: this.currentCompanyId,
                            onBrandAdded: (newBrandData) => {
                                // Recursive call for continuous brand adding
                                this.refreshMetadataAfterBrandAdd(newBrandData);
                            }
                        });
                        this.metadataSelects.brand.init();
                        
                        // Select the newly created brand
                        if (brandData && brandData.brand_id) {
                            this.metadataSelects.brand.setValue(brandData.brand_id);
                            this.detectChanges();
                        }
                    }
                }
            }
            
            showToast(message, type = 'info') {
                // Simple toast notification
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                
                // Set background color based on type
                let backgroundColor = '#3b82f6'; // default info
                if (type === 'success') {
                    backgroundColor = '#10b981';
                } else if (type === 'error') {
                    backgroundColor = '#ef4444';
                } else if (type === 'warning') {
                    backgroundColor = '#f59e0b';
                }
                
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: ${backgroundColor};
                    color: white;
                    padding: 12px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10000;
                    animation: slideIn 0.3s ease-out;
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => {
                        document.body.removeChild(toast);
                    }, 300);
                }, 3000);
            }
            
            // Add Category Modal Methods
            initAddCategoryModal() {
                // Check if already initialized to prevent duplicate event listeners
                if (this.categoryModalInitialized) {
                    return;
                }
                
                const modal = document.getElementById('addCategoryModal');
                const closeBtn = document.getElementById('closeAddCategoryBtn');
                const cancelBtn = document.getElementById('cancelAddCategoryBtn');
                const submitBtn = document.getElementById('submitAddCategoryBtn');
                const categoryNameInput = document.getElementById('categoryNameInput');
                const categoryNameMessage = document.getElementById('categoryNameMessage');
                
                if (!modal || !submitBtn || !categoryNameInput) return;
                
                // Initialize parent category dropdown
                this.parentCategorySelect = null;
                
                // Store bound functions for potential cleanup
                this.categorySubmitHandler = this.submitNewCategory.bind(this);
                
                // Close modal handlers
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        this.closeAddCategoryModal();
                    });
                }
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        this.closeAddCategoryModal();
                    });
                }
                
                // Click outside to close
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        this.closeAddCategoryModal();
                    }
                });
                
                // Category name input validation
                categoryNameInput.addEventListener('input', () => {
                    const value = categoryNameInput.value.trim();
                    if (value.length > 0) {
                        submitBtn.disabled = false;
                        categoryNameMessage.textContent = '';
                        categoryNameMessage.classList.remove('error');
                    } else {
                        submitBtn.disabled = true;
                    }
                });
                
                // Submit handler - bind the correct context
                submitBtn.addEventListener('click', this.categorySubmitHandler);
                
                // Enter key submission
                categoryNameInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !submitBtn.disabled) {
                        this.submitNewCategory();
                    }
                });
                
                // Mark as initialized
                this.categoryModalInitialized = true;
            }
            
            openAddCategoryModal() {
                const modal = document.getElementById('addCategoryModal');
                const categoryNameInput = document.getElementById('categoryNameInput');
                const submitBtn = document.getElementById('submitAddCategoryBtn');
                const categoryNameMessage = document.getElementById('categoryNameMessage');
                
                if (!modal) return;
                
                // Reset form
                if (categoryNameInput) {
                    categoryNameInput.value = '';
                }
                if (submitBtn) {
                    submitBtn.disabled = true;
                }
                if (categoryNameMessage) {
                    categoryNameMessage.textContent = '';
                    categoryNameMessage.classList.remove('error');
                }
                
                // Create parent category dropdown
                const parentCategoryContainer = document.getElementById('parentCategoryContainer');
                if (parentCategoryContainer) {
                    // Clear existing content
                    parentCategoryContainer.innerHTML = '';
                    
                    // Filter categories that can have subcategories
                    const parentCategories = this.metadata.categories
                        .filter(cat => cat.can_have_subcategory === true)
                        .map(cat => ({
                            value: cat.category_id,
                            label: cat.category_name,
                            description: cat.description
                        }));
                    
                    // Add "None" option at the beginning for top-level categories
                    const optionsWithNone = [
                        { value: 'none', label: 'None', description: '' },
                        ...parentCategories
                    ];
                    
                    // Create TossSelect for parent category
                    this.parentCategorySelect = new TossSelect({
                        containerId: 'parentCategoryContainer',
                        name: 'parentCategory',
                        placeholder: 'Select parent category (optional)',
                        options: optionsWithNone,
                        allowClear: true, // Allow clearing selection for top-level category
                        onChange: (value, option) => {
                            if (value === 'none') {
                            } else {
                            }
                        }
                    });
                    this.parentCategorySelect.init();
                }
                
                // Show modal
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Focus on category name input
                setTimeout(() => {
                    if (categoryNameInput) {
                        categoryNameInput.focus();
                    }
                }, 100);
            }
            
            closeAddCategoryModal() {
                const modal = document.getElementById('addCategoryModal');
                
                if (modal) {
                    modal.classList.remove('active');
                    document.body.style.overflow = '';
                }
                
                // Clean up parent category select
                if (this.parentCategorySelect && this.parentCategorySelect.destroy) {
                    this.parentCategorySelect.destroy();
                    this.parentCategorySelect = null;
                }
            }
            
            async submitNewCategory() {
                const categoryNameInput = document.getElementById('categoryNameInput');
                const submitBtn = document.getElementById('submitAddCategoryBtn');
                const categoryNameMessage = document.getElementById('categoryNameMessage');
                
                if (!categoryNameInput || !submitBtn) return;
                
                const categoryName = categoryNameInput.value.trim();
                let parentCategoryId = this.parentCategorySelect ? this.parentCategorySelect.getValue() : null;
                
                // If the value is 'none' (None option), set to null
                if (parentCategoryId === 'none' || parentCategoryId === '') {
                    parentCategoryId = null;
                }
                
                if (!categoryName) {
                    if (categoryNameMessage) {
                        categoryNameMessage.textContent = 'Category name is required';
                        categoryNameMessage.classList.add('error');
                    }
                    return;
                }
                
                // Disable submit button and show loading state
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Adding...';
                
                try {
                    // Call the inventory_create_category RPC
                    const { data, error } = await window.supabaseClient.rpc('inventory_create_category', {
                        p_company_id: this.currentCompanyId,
                        p_category_name: categoryName,
                        p_parent_category_id: parentCategoryId || null
                    });
                    
                    if (error) {
                        console.error('Error creating category:', error);
                        
                        // Check for duplicate category error
                        if (error.message && error.message.includes('DUPLICATE_CATEGORY')) {
                            if (categoryNameMessage) {
                                categoryNameMessage.textContent = 'A category with this name already exists at this level';
                                categoryNameMessage.classList.add('error');
                            }
                        } else {
                            if (categoryNameMessage) {
                                categoryNameMessage.textContent = 'Failed to create category. Please try again.';
                                categoryNameMessage.classList.add('error');
                            }
                        }
                        
                        // Re-enable submit button
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                        return;
                    }
                    
                    // Success - close modal and refresh metadata
                    this.closeAddCategoryModal();
                    
                    // Refresh metadata - force reload by resetting the loaded flag
                    this.metadata.loaded = false;
                    await this.loadInventoryMetadata();
                    
                    // Recreate the category dropdown with updated options
                    if (this.metadataSelects.category) {
                        // Destroy the existing TossSelect instance
                        if (this.metadataSelects.category.destroy) {
                            this.metadataSelects.category.destroy();
                        }
                        
                        // Recreate the category select with updated options
                        const categoryContainer = document.getElementById('detailCategoryContainer');
                        if (categoryContainer) {
                            // Clear the container
                            categoryContainer.innerHTML = '';
                            
                            // Recreate the TossSelect with new options
                            this.metadataSelects.category = new TossSelect({
                                containerId: 'detailCategoryContainer',
                                name: 'detailCategory',
                                placeholder: 'Select category',
                                options: this.metadata.categories.map(category => ({
                                    value: category.category_id,
                                    label: category.category_name,
                                    description: category.description
                                })),
                                onChange: (value, option) => {
                                    this.detectChanges();
                                },
                                // Enable category dropdown features with "+ Add category" option
                                isCategoryDropdown: true,
                                companyId: this.currentCompanyId,
                                onCategoryAdded: (categoryData) => {
                                    // Refresh metadata and update dropdown
                                    this.refreshMetadataAfterCategoryAdd(categoryData);
                                }
                            });
                            this.metadataSelects.category.init();
                            
                            // If there's a new category created, select it
                            if (data && data.category_id) {
                                this.metadataSelects.category.setValue(data.category_id);
                                this.detectChanges();
                            }
                        }
                    }
                    
                    // Show success message
                    this.showToast('Category created successfully', 'success');
                    
                } catch (err) {
                    console.error('Error calling inventory_create_category RPC:', err);
                    
                    if (categoryNameMessage) {
                        categoryNameMessage.textContent = 'An error occurred. Please try again.';
                        categoryNameMessage.classList.add('error');
                    }
                    
                    // Re-enable submit button
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }
            
            async refreshMetadataAfterCategoryAdd(categoryData) {
                // Refresh metadata from server - force reload by resetting the loaded flag
                this.metadata.loaded = false;
                await this.loadInventoryMetadata();
                
                // Recreate the category dropdown with updated options
                if (this.metadataSelects.category) {
                    // Destroy the existing TossSelect instance
                    if (this.metadataSelects.category.destroy) {
                        this.metadataSelects.category.destroy();
                    }
                    
                    // Recreate the category select with updated options
                    const categoryContainer = document.getElementById('detailCategoryContainer');
                    if (categoryContainer) {
                        // Clear the container
                        categoryContainer.innerHTML = '';
                        
                        // Recreate the TossSelect with new options
                        this.metadataSelects.category = new TossSelect({
                            containerId: 'detailCategoryContainer',
                            name: 'detailCategory',
                            placeholder: 'Select category',
                            options: this.metadata.categories.map(category => ({
                                value: category.category_id,
                                label: category.category_name,
                                description: category.description
                            })),
                            onChange: (value, option) => {
                                this.detectChanges();
                            },
                            // Enable category dropdown features with "+ Add category" option
                            isCategoryDropdown: true,
                            companyId: this.currentCompanyId,
                            onCategoryAdded: (newCategoryData) => {
                                // Recursive call for continuous category adding
                                this.refreshMetadataAfterCategoryAdd(newCategoryData);
                            }
                        });
                        this.metadataSelects.category.init();
                        
                        // Select the newly created category
                        if (categoryData && categoryData.category_id) {
                            this.metadataSelects.category.setValue(categoryData.category_id);
                            this.detectChanges();
                        }
                    }
                }
            }
        }
        
        // Initialize inventory manager
        const inventoryManager = new InventoryManager();
        
        // Create AddBrandModal wrapper for TossSelect compatibility
        window.AddBrandModal = class {
            constructor(options) {
                this.options = options;
                // Delegate to inventory manager's modal
                inventoryManager.openAddBrandModal();
                
                // Store the callback for when brand is added
                this._onBrandAdded = options.onBrandAdded;
            }
            
            open() {
                inventoryManager.openAddBrandModal();
            }
        };
        
        // Create AddCategoryModal wrapper for TossSelect compatibility
        window.AddCategoryModal = class {
            constructor(options) {
                this.options = options;
                // Delegate to inventory manager's modal
                inventoryManager.openAddCategoryModal();
                
                // Store the callback for when category is added
                this._onCategoryAdded = options.onCategoryAdded;
            }
            
            open() {
                inventoryManager.openAddCategoryModal();
            }
        };
        
        // Initialize page using standardized pattern
        window.initializePage('product', (companyId, company) => {
            // Store the company ID from initialization
            if (companyId) {
                inventoryManager.currentCompanyId = companyId;
            }
            
            // Set store filter to first store when company changes
            let stores = [];
            if (typeof appState !== 'undefined' && typeof appState.getCompanyStores === 'function') {
                stores = appState.getCompanyStores();
            }
            if (stores && stores.length > 0) {
                inventoryManager.currentStoreFilter = stores[0].store_id;
                document.getElementById('storeFilterLabel').textContent = stores[0].store_name;
                inventoryManager.loadInventoryForStore(stores[0].store_id);
            } else {
                inventoryManager.currentStoreFilter = null;
                document.getElementById('storeFilterLabel').textContent = 'No Stores';
                inventoryManager.loadInventoryForStore(null);
            }
        });
        
        // Additional page initialization after navbar is ready
        document.addEventListener('DOMContentLoaded', () => {
            inventoryManager.init();
            
            // Initialize page-specific content immediately (removed unnecessary setTimeout)
            let companyId = null;
            if (typeof appState !== 'undefined' && typeof appState.getSelectedCompanyId === 'function') {
                companyId = appState.getSelectedCompanyId();
            }
            
            // Store the company ID if available
            if (companyId && !inventoryManager.currentCompanyId) {
                inventoryManager.currentCompanyId = companyId;
            }
            
            if (companyId) {
                let stores = [];
                if (typeof appState !== 'undefined' && typeof appState.getCompanyStores === 'function') {
                    stores = appState.getCompanyStores();
                }
                if (stores && stores.length > 0) {
                    inventoryManager.currentStoreFilter = stores[0].store_id;
                    document.getElementById('storeFilterLabel').textContent = stores[0].store_name;
                    inventoryManager.loadInventoryForStore(stores[0].store_id);
                } else {
                    inventoryManager.loadInventoryForStore(null);
                }
            }
        });
    </script>
</body>
</html>