<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance - Purchase Orders</title>
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="../../../core/themes/toss-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-component-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-base.css">
    <link rel="stylesheet" href="../../../core/themes/toss-typography.css">
    
    <!-- Component CSS -->
    <link rel="stylesheet" href="../../../components/base/toss-button.css">
    <link rel="stylesheet" href="../../../components/form/toss-input.css">
    <link rel="stylesheet" href="../../../components/form/toss-select.css">
    <link rel="stylesheet" href="../../../components/feedback/toss-alert.css">
    <link rel="stylesheet" href="../../../components/navigation/navbar.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- ExcelJS for Excel Export (same as inventory page) -->
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    
    <!-- Page Specific Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background: var(--toss-gray-50);
            min-height: 100vh;
        }
        
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .page-content {
            flex: 1;
            padding: var(--space-6);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .page-header {
            margin-bottom: var(--space-6);
        }
        
        .page-title {
            font-size: var(--font-h1);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .page-subtitle {
            font-size: var(--font-large);
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Tab Navigation */
        .tabs-container {
            background: white;
            border-radius: var(--radius-large);
            padding: var(--space-4);
            margin-bottom: var(--space-6);
            box-shadow: var(--shadow-card);
        }
        
        .tabs-nav {
            display: flex;
            gap: var(--space-2);
            border-bottom: 1px solid var(--toss-gray-200);
            padding-bottom: var(--space-3);
        }
        
        .tab-item {
            padding: var(--space-3) var(--space-4);
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: var(--font-medium);
            font-weight: 500;
            cursor: pointer;
            position: relative;
            transition: all 0.2s ease;
            border-radius: var(--radius-medium);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .tab-icon {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            stroke: var(--toss-blue-500);
        }
        
        .tab-item:hover {
            background: var(--toss-gray-100);
            color: var(--text-primary);
        }
        
        .tab-item.active {
            color: var(--toss-blue-500);
            background: var(--toss-blue-50);
        }
        
        .tab-item.active::after {
            content: '';
            position: absolute;
            bottom: -13px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--toss-blue-500);
        }
        
        .tab-badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--toss-gray-200);
            color: var(--text-primary);
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-left: var(--space-2);
        }
        
        .tab-item.active .tab-badge {
            background: var(--toss-blue-500);
            color: white;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
            padding-top: var(--space-6);
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* New Order Form */
        .order-form-container {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: var(--space-6);
        }
        
        .order-form-main {
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
        }
        
        .form-section {
            background: white;
            border-radius: var(--radius-large);
            padding: var(--space-6);
            box-shadow: var(--shadow-card);
        }
        
        .section-title {
            font-size: var(--font-h3);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--space-4) 0;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }
        
        .section-header .section-title {
            margin: 0;
        }
        
        .section-actions {
            display: flex;
            gap: var(--space-2);
            align-items: center;
        }
        
        .btn-excel {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            font-size: var(--font-small);
            font-weight: 500;
        }
        
        .btn-excel svg {
            width: 16px;
            height: 16px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .form-label {
            font-size: var(--font-small);
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .form-input {
            padding: var(--space-3);
            border: 1px solid var(--toss-gray-300);
            border-radius: var(--radius-medium);
            font-size: var(--font-base);
            font-family: inherit;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--toss-blue-500);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .form-input[readonly] {
            background: var(--toss-gray-100);
            color: var(--text-secondary);
        }
        
        /* Ensure consistent font for date inputs and textareas */
        input[type="date"],
        textarea {
            font-family: inherit;
            font-size: var(--font-base);
        }
        
        /* Fix date input appearance in different browsers */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
        
        /* Products Table */
        .products-table-container {
            overflow-x: auto;
        }
        
        .products-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .products-table th {
            text-align: left;
            padding: var(--space-3);
            font-size: var(--font-small);
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--toss-gray-200);
        }
        
        .products-table td {
            padding: var(--space-3);
            border-bottom: 1px solid var(--toss-gray-100);
        }
        
        .product-search {
            position: relative;
            width: 250px;
            margin-right: var(--space-2);
        }
        
        .product-search input {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            padding-left: 32px;
            border: 1px solid var(--toss-gray-300);
            border-radius: var(--radius-medium);
            font-size: var(--font-small);
            background: white;
            transition: border-color 0.15s ease;
        }
        
        .product-search input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(68, 114, 196, 0.1);
        }
        
        .product-search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-tertiary);
            width: 16px;
            height: 16px;
        }
        
        .product-search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--toss-gray-200);
            border-radius: var(--radius-medium);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
            margin-top: 4px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
        
        .product-search-suggestions.show {
            display: block;
        }
        
        .search-suggestion-item {
            padding: var(--space-3);
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.15s ease;
            border-bottom: 1px solid var(--toss-gray-100);
        }
        
        .search-suggestion-item:last-child {
            border-bottom: none;
        }
        
        .search-suggestion-item:hover,
        .search-suggestion-item.active {
            background-color: var(--toss-gray-50);
        }
        
        .search-suggestion-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .search-suggestion-name {
            font-size: var(--font-small);
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .search-suggestion-details {
            display: flex;
            gap: var(--space-3);
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .search-suggestion-sku {
            font-weight: 500;
        }
        
        .search-suggestion-price {
            margin-left: auto;
            font-weight: 500;
            color: var(--toss-blue-600);
        }
        
        .search-no-results {
            padding: var(--space-4);
            text-align: center;
            color: var(--text-secondary);
            font-size: var(--font-small);
        }
        
        .search-suggestion-highlight {
            background-color: var(--toss-yellow-100);
            font-weight: 600;
        }
        
        .product-select {
            width: 100%;
            padding: var(--space-2);
            border: 1px solid var(--toss-gray-300);
            border-radius: var(--radius-medium);
            font-size: var(--font-small);
            background: white;
            cursor: pointer;
            transition: border-color 0.15s ease;
        }
        
        .product-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(68, 114, 196, 0.1);
        }
        
        .quantity-input {
            width: 80px;
            padding: var(--space-2);
            border: 1px solid var(--toss-gray-300);
            border-radius: var(--radius-small);
            text-align: center;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .price-input {
            width: 120px;
            padding: var(--space-2);
            border: 1px solid var(--toss-gray-300);
            border-radius: var(--radius-small);
            text-align: right;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        
        .price-input::-webkit-outer-spin-button,
        .price-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .sku-cell,
        .unit-cell {
            font-size: var(--font-small);
            color: var(--text-secondary);
        }
        
        .subtotal-cell {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .btn-delete {
            padding: var(--space-2);
            background: var(--toss-red-50);
            color: var(--toss-red-500);
            border: none;
            border-radius: var(--radius-small);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-delete:hover {
            background: var(--toss-red-100);
        }
        
        .btn-delete svg {
            width: 16px;
            height: 16px;
        }
        
        .btn-add-product {
            margin-top: var(--space-4);
            padding: var(--space-3) var(--space-4);
            background: transparent;
            color: var(--toss-blue-500);
            border: 1px dashed var(--toss-blue-500);
            border-radius: var(--radius-medium);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn-add-product:hover {
            background: var(--toss-blue-50);
        }
        
        /* Order Summary Sidebar */
        .order-summary {
            position: sticky;
            top: 20px;
            background: white;
            border-radius: var(--radius-large);
            padding: var(--space-5);
            box-shadow: var(--shadow-card);
            height: fit-content;
        }
        
        .summary-title {
            font-size: var(--font-h4);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--space-4) 0;
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--toss-gray-200);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: var(--space-3) 0;
            font-size: var(--font-base);
        }
        
        .summary-label {
            color: var(--text-secondary);
        }
        
        .summary-value {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .summary-divider {
            border-top: 1px solid var(--toss-gray-200);
            margin: var(--space-3) 0;
        }
        
        .summary-total {
            display: flex;
            justify-content: space-between;
            padding: var(--space-4) 0 0;
        }
        
        .summary-total-label {
            font-size: var(--font-large);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .summary-total-value {
            font-size: var(--font-h3);
            font-weight: 700;
            color: var(--toss-blue-500);
        }
        
        /* Action Buttons */
        .form-actions {
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
            padding: var(--space-4) 0;
            margin-top: var(--space-4);
            border-top: 1px solid var(--toss-gray-200);
        }
        
        .btn {
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-medium);
            font-size: var(--font-base);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .btn-secondary {
            background: var(--toss-gray-200);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover {
            background: var(--toss-gray-300);
        }
        
        .btn-primary {
            background: var(--toss-blue-500);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--toss-blue-600);
        }
        
        /* Order List View */
        
        /* Orders Table */
        .orders-table-container {
            background: white;
            border-radius: var(--radius-large);
            padding: var(--space-4);
            box-shadow: var(--shadow-card);
            overflow-x: auto;
        }
        
        .orders-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .orders-table th {
            text-align: left;
            padding: var(--space-3);
            font-size: var(--font-small);
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--toss-gray-200);
        }
        
        .orders-table td {
            padding: var(--space-3);
            border-bottom: 1px solid var(--toss-gray-100);
            font-size: var(--font-base);
        }
        
        .order-number {
            font-weight: 600;
            color: var(--toss-blue-500);
            cursor: pointer;
        }
        
        .order-number:hover {
            text-decoration: underline;
        }
        
        .status-badge {
            display: inline-block;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-small);
            font-size: var(--font-small);
            font-weight: 500;
        }
        
        .status-pending {
            background: var(--toss-gray-100);
            color: var(--text-secondary);
        }
        
        .status-processing {
            background: var(--toss-blue-100);
            color: var(--toss-blue-600);
        }
        
        .status-partial {
            background: var(--toss-yellow-100);
            color: var(--toss-yellow-700);
        }
        
        .status-completed {
            background: var(--toss-green-100);
            color: var(--toss-green-600);
        }
        
        .status-cancelled {
            background: var(--toss-red-100);
            color: var(--toss-red-600);
        }
        
        .receiving-progress {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .progress-bar {
            width: 60px;
            height: 4px;
            background: var(--toss-gray-200);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--toss-blue-500);
            transition: width 0.3s ease;
        }
        
        .action-btn {
            padding: var(--space-2) var(--space-3);
            background: var(--toss-blue-50);
            color: var(--toss-blue-500);
            border: none;
            border-radius: var(--radius-small);
            font-size: var(--font-small);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .action-btn:hover {
            background: var(--toss-blue-100);
        }
        
        /* Bulk Actions */
        .bulk-actions {
            background: var(--toss-blue-50);
            border-radius: var(--radius-medium);
            padding: var(--space-3) var(--space-4);
            margin-bottom: var(--space-4);
            display: none;
            align-items: center;
            gap: var(--space-4);
        }
        
        .bulk-actions.show {
            display: flex;
        }
        
        .bulk-info {
            color: var(--toss-blue-600);
            font-weight: 500;
        }
        
        .bulk-buttons {
            display: flex;
            gap: var(--space-2);
            margin-left: auto;
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .page-content {
                padding: var(--space-4);
            }
            
            .order-form-container {
                grid-template-columns: 1fr;
            }
            
            .order-summary {
                position: relative;
                top: 0;
            }
            
            
            .tabs-nav {
                overflow-x: auto;
                padding-bottom: var(--space-2);
            }
            
            .orders-table-container {
                padding: var(--space-2);
            }
            
            .orders-table {
                font-size: var(--font-small);
            }
            
            .orders-table th,
            .orders-table td {
                padding: var(--space-2);
            }
            
            .section-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-3);
            }
            
            .section-actions {
                justify-content: flex-end;
                flex-wrap: wrap;
            }
            
            .product-search {
                width: 100%;
                margin-right: 0;
                margin-bottom: var(--space-2);
            }
            
            .btn-excel {
                padding: var(--space-2);
                font-size: var(--font-small);
            }
            
            .form-actions {
                flex-direction: column-reverse;
                gap: var(--space-2);
            }
            
            .form-actions .btn {
                width: 100%;
            }
        }
        
        /* Loading State */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-8);
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--toss-gray-200);
            border-top-color: var(--toss-blue-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-8);
        }
        
        .empty-icon {
            margin-bottom: var(--space-4);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-tertiary);
        }
        
        .empty-title {
            font-size: var(--font-h3);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .empty-description {
            font-size: var(--font-base);
            color: var(--text-secondary);
            margin: 0 0 var(--space-4) 0;
        }
        
        /* Supplier Tabs */
        .supplier-tabs {
            display: flex;
            gap: var(--space-1);
            margin-bottom: var(--space-4);
            border-bottom: 1px solid var(--toss-gray-200);
        }
        
        .supplier-tab {
            padding: var(--space-2) var(--space-4);
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-secondary);
            font-size: var(--font-base);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            bottom: -1px;
        }
        
        .supplier-tab:hover {
            color: var(--text-primary);
        }
        
        .supplier-tab.active {
            color: var(--toss-blue-500);
            border-bottom-color: var(--toss-blue-500);
        }
        
        .supplier-tab-content {
            display: none;
        }
        
        .supplier-tab-content.active {
            display: block;
        }
        
        /* Custom Dropdown - Toss Style */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }
        
        .dropdown-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--toss-gray-50);
            border: 1px solid var(--toss-gray-200);
            border-radius: var(--radius-medium);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .dropdown-header:hover {
            border-color: var(--toss-gray-300);
            background: white;
        }
        
        .dropdown-header.active {
            border-color: var(--toss-blue-500);
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 102, 255, 0.1);
        }
        
        .dropdown-selected {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            color: var(--text-primary);
            font-size: var(--font-base);
        }
        
        .dropdown-selected svg {
            color: var(--text-tertiary);
        }
        
        .dropdown-arrow {
            color: var(--text-tertiary);
            transition: transform 0.2s ease;
        }
        
        .dropdown-header.active .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .dropdown-list {
            position: absolute;
            top: calc(100% + var(--space-1));
            left: 0;
            right: 0;
            background: white;
            border: 1px solid var(--toss-gray-200);
            border-radius: var(--radius-medium);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }
        
        .dropdown-list.show {
            display: block;
        }
        
        .dropdown-option {
            padding: var(--space-3) var(--space-4);
            cursor: pointer;
            transition: background 0.15s ease;
            border-bottom: 1px solid var(--toss-gray-100);
        }
        
        .dropdown-option:last-child {
            border-bottom: none;
        }
        
        .dropdown-option:hover {
            background: var(--toss-gray-50);
        }
        
        .dropdown-option.selected {
            background: var(--toss-blue-50);
            color: var(--toss-blue-500);
        }
        
        .dropdown-option.placeholder {
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .supplier-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }
        
        .supplier-name {
            font-size: var(--font-base);
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .supplier-detail {
            font-size: var(--font-small);
            color: var(--text-secondary);
        }
        
        .dropdown-option.selected .supplier-name {
            color: var(--toss-blue-500);
        }
        
        /* Dropdown scrollbar styling */
        .dropdown-list::-webkit-scrollbar {
            width: 6px;
        }
        
        .dropdown-list::-webkit-scrollbar-track {
            background: var(--toss-gray-100);
            border-radius: 3px;
        }
        
        .dropdown-list::-webkit-scrollbar-thumb {
            background: var(--toss-gray-300);
            border-radius: 3px;
        }
        
        .dropdown-list::-webkit-scrollbar-thumb:hover {
            background: var(--toss-gray-400);
        }

        /* Order Detail Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 9999;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-container {
            background: white;
            border-radius: var(--radius-large);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            animation: modalFadeIn 0.3s ease-out;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6) var(--space-6) var(--space-4);
            border-bottom: 1px solid var(--toss-gray-200);
            background: var(--toss-gray-50);
        }

        .modal-title-section {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .modal-title {
            font-size: var(--font-x-large);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .modal-status-badge {
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--font-small);
            font-weight: 500;
            background: var(--toss-orange-100);
            color: var(--toss-orange-600);
        }

        .modal-status-badge.completed {
            background: var(--toss-green-100);
            color: var(--toss-green-600);
        }

        .modal-status-badge.in-progress {
            background: var(--toss-blue-100);
            color: var(--toss-blue-600);
        }

        .modal-close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--space-2);
            border-radius: var(--radius-medium);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close-btn:hover {
            background: var(--toss-gray-200);
            color: var(--text-primary);
        }

        .modal-content {
            padding: var(--space-6);
            overflow-y: auto;
            flex: 1;
        }

        .modal-section {
            margin-bottom: var(--space-6);
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section h3 {
            font-size: var(--font-large);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--space-4) 0;
            border-bottom: 2px solid var(--toss-gray-200);
            padding-bottom: var(--space-2);
        }

        .modal-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .modal-info-item {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .modal-info-label {
            font-size: var(--font-small);
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .modal-info-value {
            font-size: var(--font-base);
            color: var(--text-primary);
            font-weight: 500;
        }

        .modal-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .modal-stat-card {
            background: var(--toss-gray-50);
            border-radius: var(--radius-medium);
            padding: var(--space-4);
            text-align: center;
            border: 1px solid var(--toss-gray-200);
        }

        .modal-stat-value {
            font-size: var(--font-xx-large);
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--space-1);
        }

        .modal-stat-label {
            font-size: var(--font-small);
            color: var(--text-secondary);
            font-weight: 500;
        }

        .modal-progress-container {
            margin-top: var(--space-4);
        }

        .modal-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
        }

        .modal-progress-label {
            font-size: var(--font-base);
            color: var(--text-primary);
            font-weight: 500;
        }

        .modal-progress-percentage {
            font-size: var(--font-base);
            color: var(--primary-color);
            font-weight: 600;
        }

        .modal-progress-bar {
            width: 100%;
            height: 8px;
            background: var(--toss-gray-200);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .modal-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--toss-blue-400));
            border-radius: var(--radius-full);
            transition: width 0.6s ease;
        }

        .modal-table-container {
            border: 1px solid var(--toss-gray-200);
            border-radius: var(--radius-medium);
            overflow: hidden;
            margin-top: var(--space-2);
        }

        .modal-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-small);
        }

        .modal-table th {
            background: var(--toss-gray-50);
            color: var(--text-secondary);
            font-weight: 600;
            padding: var(--space-3);
            text-align: left;
            border-bottom: 1px solid var(--toss-gray-200);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: var(--font-x-small);
        }

        .modal-table td {
            padding: var(--space-3);
            border-bottom: 1px solid var(--toss-gray-100);
            color: var(--text-primary);
        }

        .modal-table tr:last-child td {
            border-bottom: none;
        }

        .modal-table tr:hover {
            background: var(--toss-gray-25);
        }

        .modal-table .quantity-cell {
            text-align: center;
            font-weight: 500;
        }

        .modal-table .price-cell,
        .modal-table .subtotal-cell {
            text-align: center;
            font-weight: 500;
        }

        /* Center align numeric column headers for consistency */
        .modal-table th:nth-child(3),  /* Ordered column */
        .modal-table th:nth-child(4),  /* Received column */
        .modal-table th:nth-child(5),  /* Remaining column */
        .modal-table th:nth-child(6),  /* Unit Price column */
        .modal-table th:nth-child(7),  /* Total column */
        .modal-table th:nth-child(8) { /* Progress column */
            text-align: center;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
            padding: var(--space-4) var(--space-6);
            border-top: 1px solid var(--toss-gray-200);
            background: var(--toss-gray-50);
        }

        .modal-btn {
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-medium);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-size: var(--font-base);
        }

        .modal-btn-secondary {
            background: white;
            color: var(--text-secondary);
            border: 1px solid var(--toss-gray-300);
        }

        .modal-btn-secondary:hover {
            background: var(--toss-gray-50);
            border-color: var(--toss-gray-400);
        }

        .modal-btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .modal-btn-primary:hover {
            background: var(--toss-blue-600);
        }

        /* Store receipts specific styling */
        .store-receipt-item {
            background: var(--toss-gray-25);
            border: 1px solid var(--toss-gray-200);
            border-radius: var(--radius-medium);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
        }

        .store-receipt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-2);
        }

        .store-receipt-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .store-receipt-status {
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-small);
            font-size: var(--font-x-small);
            font-weight: 500;
            background: var(--toss-green-100);
            color: var(--toss-green-600);
        }

        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .modal-container {
                width: 95%;
                max-height: 90vh;
            }

            .modal-header {
                padding: var(--space-4);
            }

            .modal-content {
                padding: var(--space-4);
            }

            .modal-title {
                font-size: var(--font-large);
            }

            .modal-info-grid {
                grid-template-columns: 1fr;
            }

            .modal-stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .modal-table {
                font-size: var(--font-x-small);
            }

            .modal-table th,
            .modal-table td {
                padding: var(--space-2);
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Navigation Bar -->
        <div id="navbar-container"></div>
        
        <!-- Page Content -->
        <main class="page-content">
            <div class="page-header">
                <h1 class="page-title">Purchase Orders</h1>
                <p class="page-subtitle">Manage supplier orders and track deliveries</p>
            </div>
            
            <!-- Tabs Container -->
            <div class="tabs-container">
                <div class="tabs-nav">
                    <button class="tab-item active" data-tab="new-order">
                        <svg class="tab-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        <span>New Order</span>
                    </button>
                    <button class="tab-item" data-tab="order-list">
                        <svg class="tab-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="7" y1="8" x2="17" y2="8"></line>
                            <line x1="7" y1="12" x2="17" y2="12"></line>
                            <line x1="7" y1="16" x2="12" y2="16"></line>
                        </svg>
                        <span>Order List</span>
                        <span class="tab-badge">0</span>
                    </button>
                </div>
                
                <!-- New Order Tab Content -->
                <div class="tab-content active" id="new-order">
                    <div class="order-form-container">
                        <div class="order-form-main">
                            <!-- Order Header Section -->
                            <div class="form-section">
                                <h2 class="section-title">Order Information</h2>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label">Order Date</label>
                                        <input type="date" class="form-input" id="order-date">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Notes</label>
                                        <textarea class="form-input" id="order-notes" rows="1" placeholder="Optional notes..."></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Supplier Selection Section -->
                            <div class="form-section">
                                <h2 class="section-title">Supplier Details</h2>
                                
                                <!-- Supplier Tabs -->
                                <div class="supplier-tabs">
                                    <button class="supplier-tab active" data-supplier-tab="counter-party">Counter Party</button>
                                    <button class="supplier-tab" data-supplier-tab="others">Others</button>
                                </div>
                                
                                <!-- Counter Party Tab Content -->
                                <div class="supplier-tab-content active" id="counter-party-tab">
                                    <div class="form-row">
                                        <div class="form-group" style="grid-column: 1 / -1;">
                                            <label class="form-label">Select Supplier</label>
                                            <div class="custom-dropdown">
                                                <div class="dropdown-header" id="supplier-dropdown-header">
                                                    <div class="dropdown-selected">
                                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <circle cx="11" cy="11" r="8"></circle>
                                                            <path d="m21 21-4.35-4.35"></path>
                                                        </svg>
                                                        <span>Choose a supplier...</span>
                                                    </div>
                                                    <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                        <polyline points="6 9 12 15 18 9"></polyline>
                                                    </svg>
                                                </div>
                                                <div class="dropdown-list" id="supplier-dropdown">
                                                    <!-- Options will be populated dynamically -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Others Tab Content -->
                                <div class="supplier-tab-content" id="others-tab">
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Supplier Name</label>
                                            <input type="text" class="form-input" id="other-supplier-name" placeholder="Enter supplier name">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Contact Person</label>
                                            <input type="text" class="form-input" id="other-contact-person" placeholder="Enter contact name">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Phone</label>
                                            <input type="tel" class="form-input" id="other-phone" placeholder="Enter phone number">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Email</label>
                                            <input type="email" class="form-input" id="other-email" placeholder="Enter email address">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group" style="grid-column: 1 / -1;">
                                            <label class="form-label">Address</label>
                                            <input type="text" class="form-input" id="other-address" placeholder="Enter supplier address">
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label class="form-label">Bank Account</label>
                                            <input type="text" class="form-input" id="other-bank-account" placeholder="Enter bank account information">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Memo</label>
                                            <textarea class="form-input" id="other-memo" rows="2" placeholder="Enter any additional notes..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Products Section -->
                            <div class="form-section">
                                <div class="section-header">
                                    <h2 class="section-title">Order Items</h2>
                                    <div class="section-actions">
                                        <div class="product-search">
                                            <svg class="product-search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="11" cy="11" r="8"></circle>
                                                <path d="m21 21-4.35-4.35"></path>
                                            </svg>
                                            <input type="text" id="product-search-input" placeholder="Search products...">
                                            <div class="product-search-suggestions" id="product-search-suggestions">
                                                <!-- Suggestions will be added here dynamically -->
                                            </div>
                                        </div>
                                        <button class="btn btn-secondary btn-excel">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <polyline points="14 2 14 8 20 8"></polyline>
                                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                                <polyline points="10 9 9 9 8 9"></polyline>
                                            </svg>
                                            Import Excel
                                        </button>
                                        <button class="btn btn-secondary btn-excel">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                <polyline points="7 10 12 15 17 10"></polyline>
                                                <line x1="12" y1="15" x2="12" y2="3"></line>
                                            </svg>
                                            Export Template & Product List
                                        </button>
                                    </div>
                                </div>
                                <div class="products-table-container">
                                    <table class="products-table" id="order-items-table">
                                        <thead>
                                            <tr>
                                                <th>Product Name</th>
                                                <th>SKU</th>
                                                <th>Unit</th>
                                                <th>Quantity</th>
                                                <th>Unit Price</th>
                                                <th>Subtotal</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="order-items-tbody">
                                            <!-- Product rows will be added dynamically here -->
                                        </tbody>
                                    </table>
                                    <button class="btn-add-product" id="add-product-btn">+ Add Product</button>
                                </div>
                            </div>
                            
                        </div>
                        
                        <!-- Order Summary Sidebar -->
                        <div class="order-summary">
                            <h3 class="summary-title">Order Summary</h3>
                            <div class="summary-item">
                                <span class="summary-label">Items</span>
                                <span class="summary-value" id="summary-items">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Total Quantity</span>
                                <span class="summary-value" id="summary-quantity">0</span>
                            </div>
                            <div class="summary-item">
                                <span class="summary-label">Subtotal</span>
                                <span class="summary-value currency-amount" id="summary-subtotal">0</span>
                            </div>
                            <div class="summary-divider"></div>
                            <div class="summary-total">
                                <span class="summary-total-label">Total Amount</span>
                                <span class="summary-total-value currency-amount" id="summary-total">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="form-actions">
                        <button class="btn btn-secondary" id="cancel-order-btn">Cancel</button>
                        <button class="btn btn-secondary" id="create-order-btn">Create Order</button>
                    </div>
                </div>
                
                <!-- Order List Tab Content -->
                <div class="tab-content" id="order-list">
                    <!-- Bulk Actions -->
                    <div class="bulk-actions">
                        <span class="bulk-info">3 orders selected</span>
                        <div class="bulk-buttons">
                            <button class="btn btn-secondary">Print</button>
                            <button class="btn btn-secondary">Export Excel</button>
                            <button class="btn btn-secondary">Bulk Cancel</button>
                        </div>
                    </div>
                    
                    <!-- Orders Table -->
                    <div class="orders-table-container">
                        <table class="orders-table">
                            <thead>
                                <tr>
                                    <th><input type="checkbox"></th>
                                    <th>Order Number</th>
                                    <th>Date</th>
                                    <th>Supplier</th>
                                    <th>Items</th>
                                    <th>Total Amount</th>
                                    <th>Receiving Status</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Order data will be populated dynamically by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal-overlay" id="orderDetailModal">
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title-section">
                    <h2 class="modal-title" id="modalOrderNumber">Order Details</h2>
                    <span class="modal-status-badge" id="modalStatusBadge">Pending</span>
                </div>
                <button class="modal-close-btn" id="closeModalBtn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="modal-content">
                <!-- Order Summary Section -->
                <div class="modal-section">
                    <h3 class="section-title">Order Summary</h3>
                    <div class="order-summary-grid">
                        <div class="summary-item">
                            <span class="summary-label">Order Date</span>
                            <span class="summary-value" id="modalOrderDate">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Expected Date</span>
                            <span class="summary-value" id="modalExpectedDate">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Supplier</span>
                            <span class="summary-value" id="modalSupplierName">-</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">Total Amount</span>
                            <span class="summary-value currency-amount" id="modalTotalAmount">-</span>
                        </div>
                    </div>
                </div>

                <!-- Progress Overview Section -->
                <div class="modal-section">
                    <h3 class="section-title">Progress Overview</h3>
                    <div class="progress-overview">
                        <div class="progress-stats">
                            <div class="progress-stat">
                                <span class="stat-label">Products</span>
                                <span class="stat-value" id="modalTotalProducts">0</span>
                            </div>
                            <div class="progress-stat">
                                <span class="stat-label">Ordered</span>
                                <span class="stat-value" id="modalTotalOrdered">0</span>
                            </div>
                            <div class="progress-stat">
                                <span class="stat-label">Received</span>
                                <span class="stat-value" id="modalTotalReceived">0</span>
                            </div>
                            <div class="progress-stat">
                                <span class="stat-label">Completion</span>
                                <span class="stat-value" id="modalCompletionRate">0%</span>
                            </div>
                        </div>
                        <div class="overall-progress">
                            <div class="progress-bar-large">
                                <div class="progress-fill-large" id="modalProgressFill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items Section -->
                <div class="modal-section">
                    <h3 class="section-title">Order Items</h3>
                    <div class="modal-table-container">
                        <table class="modal-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th>SKU</th>
                                    <th>Ordered</th>
                                    <th>Received</th>
                                    <th>Remaining</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Progress</th>
                                </tr>
                            </thead>
                            <tbody id="modalItemsTableBody">
                                <!-- Items will be populated dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Store Receipts Section (shown only if there are receipts) -->
                <div class="modal-section" id="storeReceiptsSection" style="display: none;">
                    <h3 class="section-title">Store Receipts</h3>
                    <div id="storeReceiptsContainer">
                        <!-- Store receipts will be populated dynamically -->
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeModalFooterBtn">Close</button>
                <button class="btn btn-primary" id="printOrderBtn">Print Order</button>
            </div>
        </div>
    </div>
    
    <!-- Component Scripts -->
    <script src="../../../components/base/toss-button.js"></script>
    <script src="../../../components/form/toss-input.js"></script>
    <script src="../../../components/form/toss-select.js"></script>
    <script src="../../../components/navigation/navbar.js"></script>
    <script src="../../../components/feedback/toss-alert.js"></script>
    
    <!-- Core Scripts -->
    <script src="../../../core/constants/app-icons.js"></script>
    <script src="../../../core/config/supabase.js"></script>
    
    <!-- App State Management -->
    <script src="../../../core/utils/app-state.js"></script>
    
    <!-- Route Mapping -->
    <script src="../../../core/config/route-mapping.js"></script>
    
    <!-- Page Initialization Utility -->
    <script src="../../../core/utils/page-init.js"></script>
    
    <!-- Page Specific Scripts -->
    <script>
        // Set flag immediately to prevent navbar auto-init
        window.skipNavbarAutoInit = true;
        
        // Function to fetch inventory order list for the selected company
        async function fetchInventoryOrderList(companyId) {
            if (!companyId) {
                console.log('No company ID provided for fetching order list');
                return null;
            }

            try {
                console.log(' Fetching inventory order list for company:', companyId);
                console.log(' RPC Parameters:', { p_company_id: companyId });
                
                // Call the RPC to get inventory order list
                // The error message suggests the correct function name is 'get_inventory_order_list'
                let { data, error } = await supabase.rpc('get_inventory_order_list', {
                    p_company_id: companyId
                });

                console.log(' RPC Response (with p_company_id):', { data, error });

                // If function not found with p_company_id, try with company_id (without p_ prefix)
                if (error && error.code === 'PGRST202') {
                    console.log(' Trying alternative parameter name: company_id');
                    const result2 = await supabase.rpc('get_inventory_order_list', {
                        company_id: companyId
                    });
                    data = result2.data;
                    error = result2.error;
                    console.log(' RPC Response (with company_id):', { data, error });
                }
                
                // If still function not found, try without any parameters (uses session context)
                if (error && error.code === 'PGRST202') {
                    console.log(' Trying without parameters (session-based)');
                    const result3 = await supabase.rpc('get_inventory_order_list');
                    data = result3.data;
                    error = result3.error;
                    console.log(' RPC Response (no params):', { data, error });
                }

                if (error) {
                    console.error(' Error fetching order list:', error);
                    console.error(' Full error details:', {
                        code: error.code,
                        message: error.message,
                        details: error.details,
                        hint: error.hint
                    });
                    
                    // Check specific error types
                    if (error.code === 'PGRST202') {
                        console.error(' Function not found - RPC function does not exist in database');
                        return {
                            orders: [],
                            message: 'RPC function "get_inventory_order_list" not found in database'
                        };
                    } else if (error.code === '42703') {
                        console.error(' SQL Column Error - Backend SQL query has incorrect column reference');
                        console.error(' Backend Fix Needed:', error.hint || 'Check column names in SQL query');
                        return {
                            orders: [],
                            message: `SQL Error in RPC function: ${error.message}`,
                            backendError: true,
                            hint: error.hint
                        };
                    }
                    
                    // Return empty result to show empty state with error info
                    return {
                        orders: [],
                        message: 'Error loading orders - ' + (error.message || 'Unknown error')
                    };
                }

                console.log(' Order list fetched successfully:', data);
                
                // Log data structure for debugging
                if (data && data.orders && data.orders.length > 0) {
                    console.log(' First order structure:', data.orders[0]);
                    console.log(' Data structure check:', {
                        hasOrders: !!data.orders,
                        orderCount: data.orders.length,
                        firstOrderHasSummary: !!(data.orders[0]?.summary),
                        firstOrderHasItems: !!(data.orders[0]?.items),
                        expectedFields: {
                            order_id: data.orders[0]?.order_id,
                            order_number: data.orders[0]?.order_number,
                            supplier_name: data.orders[0]?.supplier_name,
                            total_amount: data.orders[0]?.total_amount,
                            status: data.orders[0]?.status
                        }
                    });
                }
                
                return data;
            } catch (err) {
                console.error('Error in fetchInventoryOrderList:', err);
                return null;
            }
        }

        // Function to format date for display
        function formatOrderDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            const options = { month: 'short', day: 'numeric', year: 'numeric' };
            return date.toLocaleDateString('en-US', options);
        }

        // Function to get status badge class
        function getStatusBadgeClass(status) {
            const statusMap = {
                'pending': 'status-pending',
                'partial': 'status-partial',
                'processing': 'status-processing',
                'completed': 'status-completed',
                'cancelled': 'status-cancelled'
            };
            return statusMap[status] || 'status-pending';
        }

        // Function to get status display name
        function getStatusDisplayName(status) {
            const statusNames = {
                'pending': 'Pending',
                'partial': 'Partial',
                'processing': 'Processing',
                'completed': 'Completed',
                'cancelled': 'Cancelled'
            };
            return statusNames[status] || status;
        }

        // Function to calculate receiving progress
        function calculateReceivingProgress(order) {
            // If order has summary data (new format), use it
            if (order.summary) {
                return {
                    received: order.summary.total_received || 0,
                    total: order.summary.total_ordered || 0,
                    percentage: Math.round(order.summary.completion_rate || 0)
                };
            }
            
            // Fallback to old format - calculate from items array
            const items = order.items || order;
            if (!items || items.length === 0) return { received: 0, total: 0, percentage: 0 };
            
            let totalOrdered = 0;
            let totalReceived = 0;
            
            items.forEach(item => {
                totalOrdered += item.quantity_ordered || 0;
                totalReceived += item.quantity_received_total || 0;
            });
            
            const percentage = totalOrdered > 0 ? Math.round((totalReceived / totalOrdered) * 100) : 0;
            
            return {
                received: totalReceived,
                total: totalOrdered,
                percentage: percentage
            };
        }

        // Function to find order by ID from the current order data
        function findOrderById(orderId) {
            if (!window.currentOrderData || !window.currentOrderData.orders) {
                console.error('No order data available');
                return null;
            }
            
            const order = window.currentOrderData.orders.find(order => 
                order.order_id === orderId || order.order_id === parseInt(orderId)
            );
            
            if (!order) {
                console.error('Order not found with ID:', orderId);
                return null;
            }
            
            return order;
        }

        // Function to open and populate the order detail modal
        function openOrderDetailModal(orderData) {
            const modal = document.getElementById('orderDetailModal');
            if (!modal) {
                console.error('Order detail modal not found');
                return;
            }

            // Populate modal header
            const modalTitle = document.getElementById('modalOrderNumber');
            const modalStatusBadge = document.getElementById('modalStatusBadge');
            
            if (modalTitle) {
                modalTitle.textContent = `Order #${orderData.order_number || orderData.order_id}`;
            }
            
            if (modalStatusBadge) {
                modalStatusBadge.textContent = getStatusDisplayName(orderData.status);
                modalStatusBadge.className = `modal-status-badge ${getStatusBadgeClass(orderData.status)}`;
            }

            // Populate order summary
            populateOrderSummary(orderData);
            
            // Populate progress overview
            populateProgressOverview(orderData);
            
            // Populate order items table
            populateOrderItemsTable(orderData);
            
            // Handle store receipts section
            populateStoreReceipts(orderData);

            // Show the modal
            modal.classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }

        // Function to populate order summary section
        function populateOrderSummary(orderData) {
            const currencySymbol = companyCurrency?.currency_symbol || '$';
            
            // Order Date
            const orderDateElement = document.getElementById('modalOrderDate');
            if (orderDateElement) {
                orderDateElement.textContent = formatOrderDate(orderData.order_date);
            }
            
            // Supplier Name
            const supplierNameElement = document.getElementById('modalSupplierName');
            if (supplierNameElement) {
                supplierNameElement.textContent = orderData.supplier_name || '-';
            }
            
            // Total Amount
            const totalAmountElement = document.getElementById('modalTotalAmount');
            if (totalAmountElement) {
                totalAmountElement.textContent = `${currencySymbol}${formatNumberWithCommas(orderData.total_amount || 0)}`;
            }
        }

        // Function to populate progress overview section
        function populateProgressOverview(orderData) {
            const progress = calculateReceivingProgress(orderData);
            
            // Total Items
            const totalItemsElement = document.getElementById('modalTotalItems');
            if (totalItemsElement) {
                const itemCount = orderData.summary ? 
                    (orderData.summary.total_products || 0) : 
                    (orderData.items ? orderData.items.length : 0);
                totalItemsElement.textContent = itemCount;
            }
            
            // Items Received
            const itemsReceivedElement = document.getElementById('modalItemsReceived');
            if (itemsReceivedElement) {
                itemsReceivedElement.textContent = formatNumberWithCommas(progress.received);
            }
            
            // Items Pending
            const itemsPendingElement = document.getElementById('modalItemsPending');
            if (itemsPendingElement) {
                itemsPendingElement.textContent = formatNumberWithCommas(progress.total - progress.received);
            }
            
            // Completion Rate
            const completionRateElement = document.getElementById('modalCompletionRate');
            if (completionRateElement) {
                completionRateElement.textContent = `${progress.percentage}%`;
            }
            
            // Progress Bar
            const progressFillElement = document.getElementById('modalProgressFill');
            const progressPercentageElement = document.getElementById('modalProgressPercentage');
            
            if (progressFillElement) {
                progressFillElement.style.width = `${progress.percentage}%`;
            }
            
            if (progressPercentageElement) {
                progressPercentageElement.textContent = `${progress.percentage}%`;
            }
        }

        // Function to populate order items table
        function populateOrderItemsTable(orderData) {
            const tableBody = document.getElementById('modalItemsTableBody');
            if (!tableBody) {
                console.error('Modal order items table body not found');
                return;
            }
            
            tableBody.innerHTML = '';
            const currencySymbol = companyCurrency?.currency_symbol || '$';
            
            const items = orderData.items || [];
            
            if (items.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="8" style="text-align: center; color: var(--text-secondary); padding: var(--space-6);">
                        No items found for this order.
                    </td>
                `;
                tableBody.appendChild(emptyRow);
                return;
            }
            
            items.forEach(item => {
                const row = document.createElement('tr');
                
                // Use correct field names from RPC response
                const ordered = item.quantity_ordered || 0;
                const received = item.quantity_received_total || 0;
                const remaining = item.quantity_remaining || 0;
                const unitPrice = item.unit_price || 0;
                const subtotal = item.total_amount || (ordered * unitPrice);
                
                // Calculate progress percentage for this item
                const progressPercentage = ordered > 0 ? Math.round((received / ordered) * 100) : 0;
                
                row.innerHTML = `
                    <td>${item.product_name || '-'}</td>
                    <td style="font-size: var(--font-x-small); color: var(--text-secondary);">${item.sku || '-'}</td>
                    <td class="quantity-cell">${formatNumberWithCommas(ordered)}</td>
                    <td class="quantity-cell">${formatNumberWithCommas(received)}</td>
                    <td class="quantity-cell">${formatNumberWithCommas(remaining)}</td>
                    <td class="price-cell">${currencySymbol}${formatNumberWithCommas(unitPrice)}</td>
                    <td class="subtotal-cell">${currencySymbol}${formatNumberWithCommas(subtotal)}</td>
                    <td class="quantity-cell">${progressPercentage}%</td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        // Function to populate store receipts section
        function populateStoreReceipts(orderData) {
            const storeReceiptsSection = document.getElementById('storeReceiptsSection');
            const storeReceiptsContent = document.getElementById('storeReceiptsContent');
            
            if (!storeReceiptsSection || !storeReceiptsContent) {
                return;
            }
            
            // Check if order has store-specific receipts data
            if (orderData.receipts_by_store && Object.keys(orderData.receipts_by_store).length > 0) {
                storeReceiptsSection.style.display = 'block';
                storeReceiptsContent.innerHTML = '';
                
                Object.entries(orderData.receipts_by_store).forEach(([storeName, receiptData]) => {
                    const receiptItem = document.createElement('div');
                    receiptItem.className = 'store-receipt-item';
                    
                    receiptItem.innerHTML = `
                        <div class="store-receipt-header">
                            <span class="store-receipt-name">${storeName}</span>
                            <span class="store-receipt-status">Received</span>
                        </div>
                        <div style="font-size: var(--font-small); color: var(--text-secondary);">
                            Items: ${formatNumberWithCommas(receiptData.items_count || 0)} | 
                            Date: ${formatOrderDate(receiptData.receipt_date) || '-'}
                        </div>
                    `;
                    
                    storeReceiptsContent.appendChild(receiptItem);
                });
            } else {
                storeReceiptsSection.style.display = 'none';
            }
        }

        // Function to close the order detail modal
        function closeOrderDetailModal() {
            const modal = document.getElementById('orderDetailModal');
            if (modal) {
                modal.classList.remove('show');
                document.body.style.overflow = ''; // Restore background scrolling
            }
        }

        // Function to render order list table
        function renderOrderListTable(orderData) {
            const tbody = document.querySelector('#order-list .orders-table tbody');
            if (!tbody) {
                console.error('Order list table body not found');
                return;
            }

            // Store order data globally for modal access
            window.currentOrderData = orderData;

            // Clear existing rows
            tbody.innerHTML = '';

            if (!orderData || !orderData.orders || orderData.orders.length === 0) {
                let message = 'No orders found. Create your first order to get started.';
                
                // Check if this is an error loading orders
                if (orderData && orderData.message) {
                    if (orderData.message.includes('not found in database')) {
                        message = `
                            <strong> Database Configuration Issue</strong><br>
                            The order list RPC function is not configured in the database.<br>
                            <small style="color: var(--text-tertiary); margin-top: 8px; display: block;">
                                Please contact your system administrator to set up the "get_inventory_order_list" RPC function.
                            </small>
                        `;
                    } else if (orderData.backendError && orderData.message.includes('SQL Error')) {
                        message = `
                            <strong> Backend SQL Error</strong><br>
                            ${orderData.message}<br>
                            ${orderData.hint ? `<strong>Fix Needed:</strong> ${orderData.hint}<br>` : ''}
                            <small style="color: var(--text-tertiary); margin-top: 8px; display: block;">
                                This is a backend database issue. Please contact the backend developer to fix the SQL query in the RPC function.
                            </small>
                        `;
                    } else if (orderData.message.includes('Error loading orders')) {
                        message = `
                            <strong> Error Loading Orders</strong><br>
                            ${orderData.message}<br>
                            <small style="color: var(--text-tertiary); margin-top: 8px; display: block;">
                                Please check the console for more details or contact your system administrator.
                            </small>
                        `;
                    }
                }
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            ${message}
                        </td>
                    </tr>
                `;
                return;
            }

            // Render each order
            orderData.orders.forEach(order => {
                // Calculate progress using the new data structure
                const progress = calculateReceivingProgress(order);
                
                // Get item count from summary or fallback to items array length
                const itemCount = order.summary ? 
                    (order.summary.total_products || 0) : 
                    (order.items ? order.items.length : 0);
                
                const currencySymbol = companyCurrency?.currency_symbol || '$';
                
                // Format receiving status display
                let receivingDisplay = '-';
                if (order.status !== 'cancelled') {
                    if (progress.total > 0) {
                        receivingDisplay = `${formatNumberWithCommas(progress.received)}/${formatNumberWithCommas(progress.total)}`;
                    } else {
                        receivingDisplay = '0/0';
                    }
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="checkbox" data-order-id="${order.order_id}"></td>
                    <td><span class="order-number">${order.order_number || '-'}</span></td>
                    <td>${formatOrderDate(order.order_date)}</td>
                    <td>${order.supplier_name || '-'}</td>
                    <td>${itemCount} item${itemCount !== 1 ? 's' : ''}</td>
                    <td class="currency-amount">${currencySymbol}${formatNumberWithCommas(order.total_amount || 0)}</td>
                    <td>
                        <div class="receiving-progress">
                            <span>${receivingDisplay}</span>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progress.percentage}%"></div>
                            </div>
                            ${progress.percentage > 0 ? `<small style="color: var(--text-tertiary); font-size: 11px; margin-left: 4px;">(${progress.percentage}%)</small>` : ''}
                        </div>
                    </td>
                    <td><span class="status-badge ${getStatusBadgeClass(order.status)}">${getStatusDisplayName(order.status)}</span></td>
                    <td><button class="action-btn" data-order-id="${order.order_id}">View</button></td>
                `;
                
                tbody.appendChild(row);
            });

            // Add click event handlers for View buttons
            document.querySelectorAll('.action-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const orderId = this.getAttribute('data-order-id');
                    const orderData = findOrderById(orderId);
                    if (orderData) {
                        openOrderDetailModal(orderData);
                    }
                });
            });

            // Update tab badge counts (only if we have valid order data)
            if (orderData && orderData.orders && Array.isArray(orderData.orders)) {
                const orderListTab = document.querySelector('.tab-item[data-tab="order-list"]');
                if (orderListTab) {
                    const badge = orderListTab.querySelector('.tab-badge');
                    if (badge) {
                        badge.textContent = orderData.orders.length;
                    }
                }

            } else {
                // Reset all badges to 0 if no valid data
                const badges = document.querySelectorAll('.tab-item .tab-badge');
                badges.forEach(badge => {
                    badge.textContent = '0';
                });
            }
        }

        // Function to test rendering with mock data (for development/testing)
        function testRenderingWithMockData() {
            console.log(' Testing rendering with mock data...');
            
            const mockData = {
                orders: [
                    {
                        order_id: "123e4567-e89b-12d3-a456-426614174001",
                        order_number: "PO-2025-001",
                        order_date: "2025-01-15",
                        expected_date: "2025-01-20",
                        status: "partial",
                        supplier_name: "ABC Trading Co.",
                        total_amount: 1500000,
                        items: [
                            {
                                product_id: "123e4567-e89b-12d3-a456-426614174002",
                                product_name: " ",
                                sku: "SKU-001",
                                barcode: "880000000001",
                                quantity_ordered: 100,
                                quantity_received_total: 65,
                                quantity_remaining: 35,
                                unit_price: 15000,
                                total_amount: 1500000,
                                receipts_by_store: {
                                    "": {
                                        store_id: "123e4567-e89b-12d3-a456-426614174003",
                                        quantity_received: 40,
                                        last_receipt_date: "2025-01-17T14:30:00"
                                    },
                                    "": {
                                        store_id: "123e4567-e89b-12d3-a456-426614174004",
                                        quantity_received: 25,
                                        last_receipt_date: "2025-01-16T10:20:00"
                                    }
                                }
                            }
                        ],
                        summary: {
                            total_products: 5,
                            total_ordered: 500,
                            total_received: 165,
                            completion_rate: 33.0
                        }
                    },
                    {
                        order_id: "123e4567-e89b-12d3-a456-426614174005",
                        order_number: "PO-2025-002",
                        order_date: "2025-01-10",
                        expected_date: "2025-01-15",
                        status: "completed",
                        supplier_name: "XYZ Supplies Ltd.",
                        total_amount: 856000,
                        items: [],
                        summary: {
                            total_products: 3,
                            total_ordered: 300,
                            total_received: 300,
                            completion_rate: 100.0
                        }
                    }
                ]
            };
            
            renderOrderListTable(mockData);
            console.log(' Mock data rendering complete');
        }

        // Expose test function to window for manual testing
        window.testOrderListRendering = testRenderingWithMockData;

        // Function to fetch counterparties (suppliers) for the selected company
        async function fetchCounterparties(companyId) {
            if (!companyId) {
                return [];
            }

            try {
                const { data, error } = await supabase
                    .from('counterparties')
                    .select('counterparty_id, name, email, phone, address, notes')
                    .eq('company_id', companyId)
                    .eq('type', 'Suppliers')
                    .eq('is_deleted', false)
                    .order('name');

                if (error) {
                    return [];
                }

                return data || [];
            } catch (err) {
                return [];
            }
        }

        // Function to update the supplier dropdown
        function updateSupplierDropdown(suppliers) {
            const dropdown = document.getElementById('supplier-dropdown');
            if (!dropdown) return;

            // Clear existing options except the placeholder
            dropdown.innerHTML = '';
            
            // Add placeholder option
            const placeholderOption = document.createElement('div');
            placeholderOption.className = 'dropdown-option placeholder';
            placeholderOption.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"></circle>
                    <path d="m21 21-4.35-4.35"></path>
                </svg>
                <span>Choose a supplier...</span>
            `;
            dropdown.appendChild(placeholderOption);

            // Add supplier options
            suppliers.forEach(supplier => {
                const option = document.createElement('div');
                option.className = 'dropdown-option';
                option.dataset.supplierId = supplier.counterparty_id;
                option.dataset.supplierData = JSON.stringify(supplier);
                
                option.innerHTML = `
                    <div class="supplier-info">
                        <div class="supplier-name">${supplier.name || 'Unnamed Supplier'}</div>
                        ${supplier.phone ? `<div class="supplier-detail">${supplier.phone}</div>` : ''}
                    </div>
                `;
                
                dropdown.appendChild(option);
            });
        }

        // Global variable to store currency information
        let companyCurrency = {
            currency_id: null,
            currency_code: 'USD',
            currency_symbol: '$'
        };

        // Global variable to store product inventory data
        let companyProductData = {
            company: null,
            products: [],
            summary: null
        };

        // Function to fetch company's base currency
        async function fetchCompanyCurrency(companyId) {
            if (!companyId) {
                return null;
            }

            try {
                // Step 1: Fetch company's base_currency_id
                const { data: companyData, error: companyError } = await supabase
                    .from('companies')
                    .select('base_currency_id')
                    .eq('company_id', companyId)
                    .single();

                if (companyError) {
                    return null;
                }

                if (!companyData || !companyData.base_currency_id) {
                    return null;
                }


                // Step 2: Fetch currency details from currency_types
                const { data: currencyData, error: currencyError } = await supabase
                    .from('currency_types')
                    .select('currency_id, currency_code')
                    .eq('currency_id', companyData.base_currency_id)
                    .single();

                if (currencyError) {
                    return null;
                }


                // Store currency information
                companyCurrency = {
                    currency_id: currencyData.currency_id,
                    currency_code: currencyData.currency_code,
                    currency_symbol: getCurrencySymbol(currencyData.currency_code)
                };

                return companyCurrency;
            } catch (err) {
                return null;
            }
        }

        // Function to get currency symbol from currency code
        function getCurrencySymbol(currencyCode) {
            const symbols = {
                'USD': '$',
                'EUR': '',
                'GBP': '',
                'JPY': '',
                'KRW': '',
                'CNY': '',
                'INR': '',
                'AUD': 'A$',
                'CAD': 'C$',
                'CHF': 'Fr',
                'HKD': 'HK$',
                'SGD': 'S$',
                'SEK': 'kr',
                'NOK': 'kr',
                'NZD': 'NZ$',
                'MXN': '$',
                'ZAR': 'R',
                'BRL': 'R$',
                'RUB': '',
                'TRY': ''
            };
            return symbols[currencyCode] || currencyCode + ' ';
        }

        // Function to fetch inventory product list
        async function fetchInventoryProductList(companyId) {
            if (!companyId) {
                return null;
            }

            try {
                
                // Call the RPC to get inventory product list
                const { data, error } = await supabase.rpc('get_inventory_product_list_company', {
                    p_company_id: companyId
                });

                if (error) {
                    return null;
                }

                if (!data || !data.success) {
                    return null;
                }


                // Store the product data globally
                companyProductData = {
                    company: data.data.company || null,
                    products: data.data.products || [],
                    summary: data.data.summary || null
                };

                // If currency information is included in the response, update it
                if (data.data.company && data.data.company.currency) {
                    const currencyFromRPC = data.data.company.currency;
                    companyCurrency = {
                        currency_id: null, // Not provided in RPC response
                        currency_code: currencyFromRPC.code,
                        currency_symbol: currencyFromRPC.symbol
                    };
                }


                return companyProductData;
            } catch (err) {
                return null;
            }
        }

        // Function to get product by ID from stored data
        function getProductById(productId) {
            if (!companyProductData.products || companyProductData.products.length === 0) {
                return null;
            }
            return companyProductData.products.find(p => p.product_id === productId);
        }

        // Function to get product by SKU from stored data
        function getProductBySKU(sku) {
            if (!companyProductData.products || companyProductData.products.length === 0) {
                return null;
            }
            return companyProductData.products.find(p => p.sku === sku);
        }

        // Function to get product by barcode from stored data
        function getProductByBarcode(barcode) {
            if (!companyProductData.products || companyProductData.products.length === 0) {
                return null;
            }
            return companyProductData.products.find(p => p.barcode === barcode);
        }

        // Function to search products by name
        function searchProductsByName(searchTerm) {
            if (!companyProductData.products || companyProductData.products.length === 0) {
                return [];
            }
            const lowerSearchTerm = searchTerm.toLowerCase();
            return companyProductData.products.filter(p => 
                p.product_name && p.product_name.toLowerCase().includes(lowerSearchTerm)
            );
        }

        // Function to get all active products
        function getActiveProducts() {
            if (!companyProductData.products || companyProductData.products.length === 0) {
                return [];
            }
            return companyProductData.products.filter(p => 
                p.status && p.status.is_active && !p.status.is_deleted
            );
        }

        // Function to export product list to Excel
        async function exportProductListToExcel() {
            try {
                // Check if we have products loaded
                if (!companyProductData.products || companyProductData.products.length === 0) {
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showWarning('No products available to export. Please wait for products to load.');
                    } else {
                        alert('No products available to export. Please wait for products to load.');
                    }
                    return;
                }



                // Get only active products and sort by SKU
                const activeProducts = getActiveProducts().sort((a, b) => {
                    const skuA = a.sku || '';
                    const skuB = b.sku || '';
                    return skuA.localeCompare(skuB);
                });
                
                if (activeProducts.length === 0) {
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showWarning('No active products found to export.');
                    } else {
                        alert('No active products found to export.');
                    }
                    return;
                }

                // Create workbook and worksheet using ExcelJS (same as inventory page)
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('Product Order Template');
                
                // Define columns with headers and widths (matching order requirement)
                worksheet.columns = [
                    { header: 'Product Code (SKU)', key: 'sku', width: 20 },
                    { header: 'Quantity', key: 'quantity', width: 15 },
                    { header: 'Unit Price', key: 'unitPrice', width: 15 }
                ];
                
                // Add product data with empty quantity and price columns
                activeProducts.forEach(product => {
                    worksheet.addRow({
                        sku: product.sku || '',  // Product Code (SKU)
                        quantity: '',            // Quantity (empty for user to fill)
                        unitPrice: ''            // Unit Price (empty for user to fill)
                    });
                });
                
                // Style the header row (exactly like inventory page)
                const headerRow = worksheet.getRow(1);
                headerRow.font = {
                    name: 'Arial',
                    size: 11,
                    bold: true,
                    color: { argb: 'FFFFFFFF' } // White text
                };
                headerRow.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FF4472C4' } // Blue background (same as inventory)
                };
                headerRow.alignment = {
                    vertical: 'middle',
                    horizontal: 'center',
                    wrapText: false
                };
                headerRow.height = 25;
                
                // Add borders to header cells
                headerRow.eachCell({ includeEmpty: false }, (cell) => {
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FF000000' } },
                        left: { style: 'thin', color: { argb: 'FF000000' } },
                        bottom: { style: 'thin', color: { argb: 'FF000000' } },
                        right: { style: 'thin', color: { argb: 'FF000000' } }
                    };
                });
                
                // Add light borders to data cells
                worksheet.eachRow((row, rowNumber) => {
                    if (rowNumber > 1) {
                        row.eachCell({ includeEmpty: false }, (cell) => {
                            cell.border = {
                                top: { style: 'thin', color: { argb: 'FFD3D3D3' } },
                                left: { style: 'thin', color: { argb: 'FFD3D3D3' } },
                                bottom: { style: 'thin', color: { argb: 'FFD3D3D3' } },
                                right: { style: 'thin', color: { argb: 'FFD3D3D3' } }
                            };
                        });
                    }
                });
                
                // Freeze the header row (like inventory page)
                worksheet.views = [
                    { state: 'frozen', ySplit: 1 }
                ];

                // Generate filename with company name and date
                const companyName = companyProductData.company?.company_name || 'Company';
                const date = new Date().toISOString().split('T')[0];
                const filename = `Order_Template_${companyName.replace(/[^a-zA-Z0-9]/g, '_')}_${date}.xlsx`;

                // Generate Excel file buffer (using ExcelJS)
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                
                // Flag to track if download was handled
                let downloadHandled = false;
                
                // Check if File System Access API is supported
                const isFileSystemAPISupported = 'showSaveFilePicker' in window && 
                                                window.isSecureContext && 
                                                !window.location.protocol.includes('file:');
                
                if (isFileSystemAPISupported) {
                    try {
                        // Modern browsers with File System Access API - allows choosing save location
                        const handle = await window.showSaveFilePicker({
                            suggestedName: filename,
                            types: [
                                {
                                    description: 'Excel Files',
                                    accept: {
                                        'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': ['.xlsx']
                                    }
                                }
                            ],
                            excludeAcceptAllOption: true
                        });
                        
                        // Write the file to the chosen location
                        const writable = await handle.createWritable();
                        await writable.write(blob);
                        await writable.close();
                        
                        downloadHandled = true;
                        
                        // Show success message for File System API save
                        if (typeof TossAlertUtils !== 'undefined') {
                            TossAlertUtils.showSuccess(`Excel template saved successfully with ${activeProducts.length} products`);
                        }
                        
                    } catch (err) {
                        if (err.name === 'AbortError') {
                            // User cancelled the save dialog
                            downloadHandled = true;
                            return; // Exit without showing any message
                        } else {
                            // Other error - use fallback method
                            downloadHandled = false;
                        }
                    }
                }
                
                // Fallback for browsers that don't support File System Access API
                if (!downloadHandled) {
                    // Create download link and trigger download to default folder
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    
                    // Clean up
                    setTimeout(() => {
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);
                    }, 100);
                    
                    
                    // Show success message for fallback download
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showSuccess(`Excel template downloaded with ${activeProducts.length} products`);
                    }
                }

            } catch (error) {
                if (typeof TossAlertUtils !== 'undefined') {
                    TossAlertUtils.showError('Failed to export Excel file. Please try again.');
                } else {
                    alert('Failed to export Excel file. Please try again.');
                }
            }
        }



        // Function to format number with commas (defined early for use in other functions)
        function formatNumberWithCommas(number) {
            return Math.round(number).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // Function to update all currency displays in the page
        function updateCurrencyDisplays(currency) {
            // Update all elements with currency-amount class
            const currencyAmounts = document.querySelectorAll('.currency-amount');
            currencyAmounts.forEach(element => {
                const text = element.textContent.trim();
                // Extract numeric value (remove any existing currency symbols, decimals and commas)
                const numericValue = parseFloat(text.replace(/[^0-9.]/g, '')) || 0;
                // Display as integer with commas
                element.textContent = (currency.currency_symbol || '$') + formatNumberWithCommas(numericValue);
            });

            // Update price input placeholders
            const priceInputs = document.querySelectorAll('.price-input');
            priceInputs.forEach(input => {
                // Update placeholder
                input.placeholder = `Enter price in ${currency.currency_code}`;
                
                // If there's a value, update it to show without decimals
                if (input.value) {
                    const numericValue = input.value.replace(/[^0-9]/g, '');
                    if (numericValue) {
                        input.value = numericValue;
                    }
                }
            });

        }

        // Initialize page using standardized pattern (same as inventory page)
        window.initializePage('product', async (companyId, company) => {
            
            if (companyId) {
                
                // Fetch inventory product list first (includes currency info)
                const productData = await fetchInventoryProductList(companyId);
                
                if (productData) {
                    // Update currency displays if currency was included in product data
                    if (companyCurrency && companyCurrency.currency_symbol) {
                        updateCurrencyDisplays(companyCurrency);
                    }
                } else {
                    // Fallback: fetch currency separately if product fetch failed
                    const currency = await fetchCompanyCurrency(companyId);
                    if (currency) {
                        updateCurrencyDisplays(currency);
                    }
                }
                
                // Fetch and update counterparties when company changes
                const suppliers = await fetchCounterparties(companyId);
                updateSupplierDropdown(suppliers);
                
                // Fetch inventory order list on page load
                console.log('Loading inventory order list for company:', companyId);
                const orderData = await fetchInventoryOrderList(companyId);
                if (orderData) {
                    renderOrderListTable(orderData);
                }
            }
        });
        
        // Tab Navigation
        document.addEventListener('DOMContentLoaded', () => {
            
            // Set Order Date to today's date by default
            const orderDateInput = document.getElementById('order-date');
            if (orderDateInput) {
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                orderDateInput.value = `${year}-${month}-${day}`;
            }
            
            // Tab switching functionality
            const tabItems = document.querySelectorAll('.tab-item');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabItems.forEach(tab => {
                tab.addEventListener('click', async () => {
                    const targetTab = tab.getAttribute('data-tab');
                    
                    // Remove active class from all tabs and contents
                    tabItems.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    document.getElementById(targetTab).classList.add('active');
                    
                    // If switching to Order List tab, fetch latest data
                    if (targetTab === 'order-list') {
                        const currentCompanyId = appState.getSelectedCompanyId();
                        if (currentCompanyId) {
                            console.log('Loading order list for tab switch');
                            const orderData = await fetchInventoryOrderList(currentCompanyId);
                            if (orderData) {
                                renderOrderListTable(orderData);
                            }
                        }
                    }
                });
            });
            
            // Supplier tab switching functionality
            const supplierTabs = document.querySelectorAll('.supplier-tab');
            const supplierTabContents = document.querySelectorAll('.supplier-tab-content');
            
            supplierTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-supplier-tab');
                    
                    // Clear previous selections based on which tab is being activated
                    if (targetTab === 'counter-party') {
                        // Switching to Counter Party - clear Others tab inputs
                        document.getElementById('other-supplier-name').value = '';
                        document.getElementById('other-contact-person').value = '';
                        document.getElementById('other-phone').value = '';
                        document.getElementById('other-email').value = '';
                        document.getElementById('other-address').value = '';
                        document.getElementById('other-bank-account').value = '';
                        document.getElementById('other-memo').value = '';
                    } else if (targetTab === 'others') {
                        // Switching to Others - clear Counter Party selection
                        selectedSupplier = null;
                        const dropdownSelected = dropdownHeader?.querySelector('.dropdown-selected');
                        if (dropdownSelected) {
                            dropdownSelected.innerHTML = `
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.35-4.35"></path>
                                </svg>
                                <span>Choose a supplier...</span>
                            `;
                        }
                        // Remove selected class from all dropdown options
                        document.querySelectorAll('.dropdown-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                    }
                    
                    // Remove active class from all supplier tabs and contents
                    supplierTabs.forEach(t => t.classList.remove('active'));
                    supplierTabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    document.getElementById(targetTab + '-tab').classList.add('active');
                    
                    // Re-validate form after tab switch
                    validateOrderForm();
                });
            });
            
            // Custom dropdown functionality
            const dropdownHeader = document.getElementById('supplier-dropdown-header');
            const dropdownList = document.getElementById('supplier-dropdown');
            let selectedSupplier = null;
            
            // Toggle dropdown
            if (dropdownHeader) {
                dropdownHeader.addEventListener('click', (e) => {
                    e.stopPropagation();
                    dropdownHeader.classList.toggle('active');
                    dropdownList.classList.toggle('show');
                });
            }
            
            // Handle option selection
            document.addEventListener('click', (e) => {
                if (e.target.closest('.dropdown-option') && !e.target.closest('.placeholder')) {
                    const option = e.target.closest('.dropdown-option');
                    const supplierData = JSON.parse(option.dataset.supplierData);
                    
                    // Update selected supplier
                    selectedSupplier = supplierData;
                    
                    // Update dropdown header
                    const dropdownSelected = dropdownHeader.querySelector('.dropdown-selected');
                    dropdownSelected.innerHTML = `
                        <div class="supplier-info">
                            <div class="supplier-name">${supplierData.name}</div>
                            ${supplierData.phone ? `<div class="supplier-detail">${supplierData.phone}</div>` : ''}
                        </div>
                    `;
                    
                    // Update option styles
                    document.querySelectorAll('.dropdown-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    option.classList.add('selected');
                    
                    // Close dropdown
                    dropdownHeader.classList.remove('active');
                    dropdownList.classList.remove('show');
                    
                    // Re-validate form after supplier selection
                    validateOrderForm();
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.custom-dropdown')) {
                    dropdownHeader?.classList.remove('active');
                    dropdownList?.classList.remove('show');
                }
            });
            
            // Initial fetch of products, suppliers and currency if company is already selected
            const currentCompanyId = appState.getSelectedCompanyId();
            if (currentCompanyId) {
                // Fetch inventory product list (includes currency)
                fetchInventoryProductList(currentCompanyId).then(productData => {
                    if (productData) {
                        // Update currency displays if currency was included
                        if (companyCurrency && companyCurrency.currency_symbol) {
                            updateCurrencyDisplays(companyCurrency);
                        }
                    } else {
                        // Fallback: fetch currency separately if product fetch failed
                        fetchCompanyCurrency(currentCompanyId).then(currency => {
                            if (currency) {
                                updateCurrencyDisplays(currency);
                            }
                        });
                    }
                });
                
                // Fetch suppliers
                fetchCounterparties(currentCompanyId).then(suppliers => {
                    updateSupplierDropdown(suppliers);
                });
                
                // Initialize Order Summary with zeros
                updateOrderSummary();
            }
            
            // Function to handle Import Excel
            async function importExcelFile(file) {
                try {
                    // Use ExcelJS to read the file
                    const arrayBuffer = await file.arrayBuffer();
                    const workbook = new ExcelJS.Workbook();
                    await workbook.xlsx.load(arrayBuffer);
                    
                    // Get the first worksheet
                    const worksheet = workbook.worksheets[0];
                    
                    if (!worksheet) {
                        if (typeof TossAlertUtils !== 'undefined') {
                            TossAlertUtils.showError('No worksheet found in the Excel file.');
                        }
                        return;
                    }
                    
                    // Convert to array format for processing
                    const jsonData = [];
                    worksheet.eachRow((row, rowNumber) => {
                        const rowData = [];
                        row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                            rowData[colNumber - 1] = cell.value;
                        });
                        jsonData.push(rowData);
                    });
                    
                    // Process the imported data
                    processImportedExcelData(jsonData);
                    
                } catch (error) {
                    console.error('Excel import error:', error);
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showError('Failed to read Excel file. Please check the file format.');
                    }
                }
            }
            
            // Excel Export/Import functionality
            const excelButtons = document.querySelectorAll('.btn-excel');
            excelButtons.forEach((button, index) => {
                if (button.textContent.includes('Export')) {
                    // Export Excel button
                    button.addEventListener('click', async () => {
                        await exportProductListToExcel();
                    });
                } else if (button.textContent.includes('Import')) {
                    // Import Excel button
                    button.addEventListener('click', () => {
                        
                        // Create a hidden file input
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = '.xlsx,.xls';
                        fileInput.style.display = 'none';
                        
                        fileInput.addEventListener('change', async (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                await importExcelFile(file);
                            }
                        });
                        
                        // Trigger file selection dialog
                        document.body.appendChild(fileInput);
                        fileInput.click();
                        
                        // Clean up after file selection
                        setTimeout(() => {
                            document.body.removeChild(fileInput);
                        }, 1000);
                    });
                }
            });
            
            // Product Search and Add Product Functionality
            let orderItems = [];
            let searchTimeout;
            
            // Function to create a product row
            function createProductRow(product = null, quantity = 1, unitPrice = null) {
                const tbody = document.getElementById('order-items-tbody');
                const row = document.createElement('tr');
                const rowId = 'order-row-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                row.id = rowId;
                
                // Use provided unitPrice, or fall back to product pricing, or default to 0
                const price = unitPrice !== null ? unitPrice : (product ? (product.pricing?.selling_price || 0) : 0);
                
                row.innerHTML = `
                    <td>
                        <select class="product-select" data-row-id="${rowId}">
                            <option value="">Select a product...</option>
                            ${product ? `<option value="${product.product_id}" selected>${product.product_name}</option>` : ''}
                        </select>
                    </td>
                    <td class="sku-cell">${product ? product.sku : '-'}</td>
                    <td class="unit-cell">${product ? (product.unit_of_measure || 'Unit') : '-'}</td>
                    <td><input type="text" class="quantity-input" value="${quantity}" data-row-id="${rowId}"></td>
                    <td><input type="text" class="price-input" value="${price}" data-row-id="${rowId}"></td>
                    <td class="subtotal-cell currency-amount">${companyCurrency.currency_symbol || '$'}0</td>
                    <td>
                        <button class="btn-delete" data-row-id="${rowId}">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
                
                // Add event listeners
                const productSelect = row.querySelector('.product-select');
                const quantityInput = row.querySelector('.quantity-input');
                const priceInput = row.querySelector('.price-input');
                const deleteBtn = row.querySelector('.btn-delete');
                
                // Product select change
                productSelect.addEventListener('change', (e) => {
                    const productId = e.target.value;
                    if (productId) {
                        const selectedProduct = companyProductData.products.find(p => p.product_id === productId);
                        if (selectedProduct) {
                            row.querySelector('.sku-cell').textContent = selectedProduct.sku || '-';
                            row.querySelector('.unit-cell').textContent = selectedProduct.unit_of_measure || 'Unit';
                            priceInput.value = selectedProduct.pricing?.selling_price || 0;
                            updateRowSubtotal(rowId);
                            updateOrderSummary();
                        }
                    } else {
                        row.querySelector('.sku-cell').textContent = '-';
                        row.querySelector('.unit-cell').textContent = '-';
                        priceInput.value = 0;
                        updateRowSubtotal(rowId);
                        updateOrderSummary();
                    }
                });
                
                // Quantity/Price change with numeric validation
                quantityInput.addEventListener('input', (e) => {
                    // Allow only numbers
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    updateRowSubtotal(rowId);
                    updateOrderSummary();
                });
                
                priceInput.addEventListener('input', (e) => {
                    // Allow only numbers and one decimal point
                    let value = e.target.value.replace(/[^0-9.]/g, '');
                    // Ensure only one decimal point
                    const parts = value.split('.');
                    if (parts.length > 2) {
                        value = parts[0] + '.' + parts.slice(1).join('');
                    }
                    e.target.value = value;
                    updateRowSubtotal(rowId);
                    updateOrderSummary();
                });
                
                // Delete button
                deleteBtn.addEventListener('click', () => {
                    row.remove();
                    updateOrderSummary();
                });
                
                // Initialize product dropdown with all products
                populateProductDropdown(productSelect, product ? product.product_id : null);
                
                // Calculate initial subtotal if product provided
                if (product) {
                    updateRowSubtotal(rowId);
                }
            }
            
            // Function to populate product dropdown
            function populateProductDropdown(selectElement, selectedProductId = null) {
                const activeProducts = getActiveProducts();
                selectElement.innerHTML = '<option value="">Select a product...</option>';
                
                activeProducts.forEach(product => {
                    const option = document.createElement('option');
                    option.value = product.product_id;
                    option.textContent = `${product.product_name} ${product.sku ? `(${product.sku})` : ''}`;
                    if (selectedProductId && product.product_id === selectedProductId) {
                        option.selected = true;
                    }
                    selectElement.appendChild(option);
                });
            }
            
            // Function to update row subtotal
            function updateRowSubtotal(rowId) {
                const row = document.getElementById(rowId);
                if (!row) return;
                
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                const subtotal = quantity * price;
                
                row.querySelector('.subtotal-cell').textContent = `${companyCurrency.currency_symbol || '$'}${formatNumberWithCommas(subtotal)}`;
            }
            
            // Function to update order summary
            function updateOrderSummary() {
                const rows = document.querySelectorAll('#order-items-tbody tr');
                let itemCount = 0;
                let totalQuantity = 0;
                let totalAmount = 0;
                
                rows.forEach(row => {
                    const productSelect = row.querySelector('.product-select');
                    if (productSelect && productSelect.value) {
                        itemCount++;
                        const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                        const price = parseFloat(row.querySelector('.price-input').value) || 0;
                        totalQuantity += quantity;
                        totalAmount += quantity * price;
                    }
                });
                
                // Update summary display - use currency symbol with comma-formatted numbers
                const currencySymbol = companyCurrency.currency_symbol || '$';
                document.getElementById('summary-items').textContent = itemCount;
                document.getElementById('summary-quantity').textContent = formatNumberWithCommas(totalQuantity);
                document.getElementById('summary-subtotal').textContent = currencySymbol + formatNumberWithCommas(totalAmount);
                document.getElementById('summary-total').textContent = currencySymbol + formatNumberWithCommas(totalAmount);
            }
            
            // Product search functionality with suggestions
            const productSearchInput = document.getElementById('product-search-input');
            const searchSuggestionsContainer = document.getElementById('product-search-suggestions');
            let selectedSuggestionIndex = -1;
            
            // Function to escape HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // Function to highlight matching text
            function highlightText(text, searchTerm) {
                if (!searchTerm) return escapeHtml(text);
                const escapedText = escapeHtml(text);
                const escapedSearchTerm = escapeHtml(searchTerm).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
                return escapedText.replace(regex, '<span class="search-suggestion-highlight">$1</span>');
            }
            
            // Function to show search suggestions
            function showSearchSuggestions(searchTerm) {
                if (!searchTerm || searchTerm.length < 1) {
                    hideSearchSuggestions();
                    return;
                }
                
                const activeProducts = getActiveProducts();
                const filteredProducts = activeProducts.filter(product => {
                    const productName = (product.product_name || '').toLowerCase();
                    const sku = (product.sku || '').toLowerCase();
                    const barcode = (product.barcode || '').toLowerCase();
                    
                    return productName.includes(searchTerm.toLowerCase()) || 
                           sku.includes(searchTerm.toLowerCase()) || 
                           barcode.includes(searchTerm.toLowerCase());
                }).slice(0, 10); // Limit to 10 suggestions
                
                if (filteredProducts.length === 0) {
                    searchSuggestionsContainer.innerHTML = `
                        <div class="search-no-results">
                            No products found matching "${escapeHtml(searchTerm)}"
                        </div>
                    `;
                    searchSuggestionsContainer.classList.add('show');
                } else {
                    searchSuggestionsContainer.innerHTML = filteredProducts.map((product, index) => {
                        const price = product.pricing?.selling_price || 0;
                        const stock = product.total_stock_summary?.total_quantity_on_hand || 0;
                        
                        return `
                            <div class="search-suggestion-item" data-index="${index}" data-product-id="${product.product_id}">
                                <div class="search-suggestion-content">
                                    <div class="search-suggestion-name">
                                        ${highlightText(product.product_name || '', searchTerm)}
                                    </div>
                                    <div class="search-suggestion-details">
                                        <span class="search-suggestion-sku">SKU: ${highlightText(product.sku || 'N/A', searchTerm)}</span>
                                        <span>Stock: ${stock}</span>
                                        <span class="search-suggestion-price">${companyCurrency.currency_symbol || '$'}${formatNumberWithCommas(price)}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    searchSuggestionsContainer.classList.add('show');
                    
                    // Add click event listeners to suggestions
                    const suggestionItems = searchSuggestionsContainer.querySelectorAll('.search-suggestion-item');
                    suggestionItems.forEach(item => {
                        item.addEventListener('click', () => {
                            const productId = item.getAttribute('data-product-id');
                            const selectedProduct = filteredProducts.find(p => p.product_id === productId);
                            if (selectedProduct) {
                                createProductRow(selectedProduct);
                                updateOrderSummary();
                                productSearchInput.value = '';
                                hideSearchSuggestions();
                                
                                if (typeof TossAlertUtils !== 'undefined') {
                                    TossAlertUtils.showSuccess(`Added: ${selectedProduct.product_name}`);
                                }
                            }
                        });
                    });
                }
                
                selectedSuggestionIndex = -1;
            }
            
            // Function to hide search suggestions
            function hideSearchSuggestions() {
                searchSuggestionsContainer.classList.remove('show');
                searchSuggestionsContainer.innerHTML = '';
                selectedSuggestionIndex = -1;
            }
            
            // Function to handle keyboard navigation
            function handleKeyboardNavigation(e) {
                const suggestionItems = searchSuggestionsContainer.querySelectorAll('.search-suggestion-item');
                
                if (suggestionItems.length === 0) return;
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, suggestionItems.length - 1);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (selectedSuggestionIndex >= 0 && selectedSuggestionIndex < suggestionItems.length) {
                        suggestionItems[selectedSuggestionIndex].click();
                    }
                    return;
                } else if (e.key === 'Escape') {
                    hideSearchSuggestions();
                    return;
                }
                
                // Update active suggestion styling
                suggestionItems.forEach((item, index) => {
                    if (index === selectedSuggestionIndex) {
                        item.classList.add('active');
                        item.scrollIntoView({ block: 'nearest' });
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            if (productSearchInput) {
                // Input event for search suggestions
                productSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.trim();
                    
                    // Clear previous timeout
                    clearTimeout(searchTimeout);
                    
                    // Set new timeout for debounced search
                    searchTimeout = setTimeout(() => {
                        showSearchSuggestions(searchTerm);
                    }, 200); // Reduced delay for faster response
                });
                
                // Keyboard navigation
                productSearchInput.addEventListener('keydown', handleKeyboardNavigation);
                
                // Focus event
                productSearchInput.addEventListener('focus', (e) => {
                    const searchTerm = e.target.value.trim();
                    if (searchTerm) {
                        showSearchSuggestions(searchTerm);
                    }
                });
                
                // Click outside to close suggestions
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.product-search')) {
                        hideSearchSuggestions();
                    }
                });
            }
            
            // Add Product button functionality
            const addProductBtn = document.getElementById('add-product-btn');
            if (addProductBtn) {
                addProductBtn.addEventListener('click', () => {
                    createProductRow();
                    updateOrderSummary();
                });
            }
            
            // Cancel button functionality
            const cancelBtn = document.getElementById('cancel-order-btn');
            if (cancelBtn) {
                cancelBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
                        // Clear the form or navigate back
                        window.location.reload();
                    }
                });
            }
            
            // Function to process imported Excel data
            function processImportedExcelData(data) {
                // Skip header row
                if (data.length <= 1) {
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showWarning('Excel file is empty or contains only headers.');
                    }
                    return;
                }

                // Clear existing rows before importing
                const tbody = document.getElementById('order-items-tbody');
                tbody.innerHTML = '';

                const importedItems = [];
                let skippedRows = 0;
                let invalidSKUs = [];
                
                // Process each row (skip header at index 0)
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    
                    // Handle 3-column format: SKU, Quantity, Unit Price
                    if (row && row.length >= 3) {
                        const sku = row[0];
                        const quantity = row[1];
                        const unitPrice = row[2];
                        
                        if (sku && quantity && unitPrice) {
                            // Find product by SKU
                            const product = getProductBySKU(String(sku).trim());
                            if (product) {
                                const parsedQuantity = parseFloat(quantity) || 0;
                                const parsedPrice = parseFloat(unitPrice) || 0;
                                
                                if (parsedQuantity > 0 && parsedPrice > 0) {
                                    // Create product row with imported data
                                    createProductRow(product, parsedQuantity, parsedPrice);
                                    importedItems.push({
                                        product: product,
                                        quantity: parsedQuantity,
                                        unitPrice: parsedPrice
                                    });
                                }
                            } else {
                                skippedRows++;
                                invalidSKUs.push(String(sku).trim());
                            }
                        } else if (sku) {
                            // Row has SKU but missing quantity or price
                            skippedRows++;
                        }
                    }
                }

                // Update order summary after all rows are added
                updateOrderSummary();
                
                // Re-validate form after import
                validateOrderForm();

                // Show appropriate messages
                if (importedItems.length > 0) {
                    let message = `Successfully imported ${importedItems.length} items from Excel`;
                    if (skippedRows > 0) {
                        message += ` (${skippedRows} rows skipped)`;
                    }
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showSuccess(message);
                    }
                    
                    // If there were invalid SKUs, show them
                    if (invalidSKUs.length > 0 && invalidSKUs.length <= 5) {
                        setTimeout(() => {
                            if (typeof TossAlertUtils !== 'undefined') {
                                TossAlertUtils.showWarning(`SKUs not found: ${invalidSKUs.join(', ')}`);
                            }
                        }, 1500);
                    }
                } else {
                    if (typeof TossAlertUtils !== 'undefined') {
                        TossAlertUtils.showWarning('No valid items found in the Excel file. Please check that SKUs match your product list.');
                    }
                }
            }
            
            // Function to validate order form
            function validateOrderForm() {
                // Check supplier selection
                const activeTab = document.querySelector('.supplier-tab.active');
                const isCounterPartyTab = activeTab && activeTab.dataset.supplierTab === 'counter-party';
                
                let hasSupplier = false;
                if (isCounterPartyTab) {
                    hasSupplier = selectedSupplier !== null;
                } else {
                    // Check if Others tab has required supplier name
                    const supplierName = document.getElementById('other-supplier-name');
                    hasSupplier = supplierName && supplierName.value.trim() !== '';
                }
                
                // Check order items
                const orderRows = document.querySelectorAll('#order-items-tbody tr');
                let hasValidItems = false;
                
                if (orderRows.length > 0) {
                    orderRows.forEach(row => {
                        const productSelect = row.querySelector('.product-select');
                        const quantityInput = row.querySelector('.quantity-input');
                        const priceInput = row.querySelector('.price-input');
                        
                        if (productSelect && productSelect.value &&
                            quantityInput && parseFloat(quantityInput.value) > 0 &&
                            priceInput && parseFloat(priceInput.value) > 0) {
                            hasValidItems = true;
                        }
                    });
                }
                
                // Enable/disable Create Order button
                const createOrderBtn = document.getElementById('create-order-btn');
                if (createOrderBtn) {
                    createOrderBtn.disabled = !hasSupplier || !hasValidItems;
                    if (createOrderBtn.disabled) {
                        createOrderBtn.style.opacity = '0.5';
                        createOrderBtn.style.cursor = 'not-allowed';
                    } else {
                        createOrderBtn.style.opacity = '1';
                        createOrderBtn.style.cursor = 'pointer';
                    }
                }
                
                return hasSupplier && hasValidItems;
            }
            
            // Function to reset the entire order form to default state
            function resetOrderForm() {
                // Reset Order Date to today's date
                const orderDateInput = document.getElementById('order-date');
                if (orderDateInput) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    orderDateInput.value = `${year}-${month}-${day}`;
                }
                
                // Clear Notes
                const notesInput = document.getElementById('order-notes');
                if (notesInput) {
                    notesInput.value = '';
                }
                
                // Reset Counter Party supplier selection
                selectedSupplier = null;
                const dropdownSelected = dropdownHeader?.querySelector('.dropdown-selected');
                if (dropdownSelected) {
                    dropdownSelected.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <span>Choose a supplier...</span>
                    `;
                }
                // Remove selected class from all dropdown options
                document.querySelectorAll('.dropdown-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                
                // Clear Others tab inputs
                document.getElementById('other-supplier-name').value = '';
                document.getElementById('other-contact-person').value = '';
                document.getElementById('other-phone').value = '';
                document.getElementById('other-email').value = '';
                document.getElementById('other-address').value = '';
                document.getElementById('other-bank-account').value = '';
                document.getElementById('other-memo').value = '';
                
                // Clear all order item rows
                const tbody = document.getElementById('order-items-tbody');
                if (tbody) {
                    tbody.innerHTML = '';
                }
                
                // Update order summary (will show zeros)
                updateOrderSummary();
                
                // Re-validate form (will disable Create Order button)
                validateOrderForm();
            }
            
            // Create Order button functionality
            const createOrderBtn = document.getElementById('create-order-btn');
            if (createOrderBtn) {
                // Initial validation
                validateOrderForm();
                
                createOrderBtn.addEventListener('click', async () => {
                    if (!validateOrderForm()) {
                        if (typeof TossAlertUtils !== 'undefined') {
                            TossAlertUtils.showWarning('Please select a supplier and add at least one valid product item.');
                        }
                        return;
                    }
                    
                    // Prepare order items
                    const orderRows = document.querySelectorAll('#order-items-tbody tr');
                    const items = [];
                    
                    orderRows.forEach(row => {
                        const productSelect = row.querySelector('.product-select');
                        const quantityInput = row.querySelector('.quantity-input');
                        const priceInput = row.querySelector('.price-input');
                        
                        if (productSelect && productSelect.value) {
                            const selectedProduct = companyProductData.products.find(p => p.product_id === productSelect.value);
                            if (selectedProduct) {
                                const quantity = parseFloat(quantityInput.value) || 0;
                                const unitPrice = parseFloat(priceInput.value) || 0;
                                
                                if (quantity > 0 && unitPrice > 0) {
                                    items.push({
                                        sku: selectedProduct.sku,
                                        quantity: quantity,
                                        unit_price: unitPrice
                                    });
                                }
                            }
                        }
                    });
                    
                    if (items.length === 0) {
                        if (typeof TossAlertUtils !== 'undefined') {
                            TossAlertUtils.showWarning('Please add valid product items with quantity and price.');
                        }
                        return;
                    }
                    
                    // Get form data
                    const orderDate = document.getElementById('order-date').value || null;
                    const notes = document.getElementById('order-notes').value || null;
                    
                    // Prepare RPC parameters
                    const activeTab = document.querySelector('.supplier-tab.active');
                    const isCounterPartyTab = activeTab && activeTab.dataset.supplierTab === 'counter-party';
                    
                    let rpcParams = {
                        p_company_id: appState.getSelectedCompanyId(),
                        p_user_id: (await supabase.auth.getUser()).data.user?.id,
                        p_items: items,
                        p_order_date: orderDate,
                        p_notes: notes
                    };
                    
                    // Add supplier info based on active tab
                    if (isCounterPartyTab) {
                        if (!selectedSupplier) {
                            if (typeof TossAlertUtils !== 'undefined') {
                                TossAlertUtils.showWarning('Please select a supplier.');
                            }
                            return;
                        }
                        rpcParams.p_counterparty_id = selectedSupplier.counterparty_id;
                    } else {
                        // Others tab - collect supplier info
                        const supplierInfo = {
                            name: document.getElementById('other-supplier-name').value || null,
                            contact: document.getElementById('other-contact-person').value || null,  // Changed from contact_person to contact
                            phone: document.getElementById('other-phone').value || null,
                            email: document.getElementById('other-email').value || null,
                            address: document.getElementById('other-address').value || null,
                            bank_account: document.getElementById('other-bank-account').value || null,
                            memo: document.getElementById('other-memo').value || null
                        };
                        
                        if (!supplierInfo.name) {
                            if (typeof TossAlertUtils !== 'undefined') {
                                TossAlertUtils.showWarning('Please enter supplier name.');
                            }
                            return;
                        }
                        
                        rpcParams.p_supplier_info = supplierInfo;
                    }
                    
                    // Log RPC parameters for debugging
                    console.log('Creating order with params:', rpcParams);
                    
                    // Show loading state
                    createOrderBtn.disabled = true;
                    createOrderBtn.textContent = 'Creating Order...';
                    
                    try {
                        // Call the RPC
                        console.log('Calling inventory_create_order RPC...');
                        const { data, error } = await supabase.rpc('inventory_create_order', rpcParams);
                        
                        console.log('RPC Response:', { data, error });
                        
                        if (error) {
                            console.error('RPC Error:', error);
                            throw error;
                        }
                        
                        if (data && data.success) {
                            console.log('Order created successfully:', data);
                            if (typeof TossAlertUtils !== 'undefined') {
                                TossAlertUtils.showSuccess(data.message || 'Order created successfully!');
                            }
                            
                            // Reset the form to default state
                            resetOrderForm();
                            
                            // Refresh order list data and switch to Order List tab after a delay
                            setTimeout(async () => {
                                const currentCompanyId = appState.getSelectedCompanyId();
                                if (currentCompanyId) {
                                    // Refresh order list data first
                                    console.log('Refreshing order list after successful order creation');
                                    const orderData = await fetchInventoryOrderList(currentCompanyId);
                                    if (orderData) {
                                        renderOrderListTable(orderData);
                                    }
                                }
                                
                                // Then switch to the Order List tab
                                const orderListTab = document.querySelector('.tab-item[data-tab="order-list"]');
                                if (orderListTab) {
                                    orderListTab.click();
                                }
                            }, 1500);
                        } else {
                            console.error('Order creation failed:', data);
                            throw new Error(data?.message || 'Failed to create order');
                        }
                    } catch (error) {
                        console.error('Order creation error:', error);
                        if (typeof TossAlertUtils !== 'undefined') {
                            TossAlertUtils.showError(error.message || 'Failed to create order. Please try again.');
                        }
                    } finally {
                        // Reset button state
                        createOrderBtn.disabled = false;
                        createOrderBtn.textContent = 'Create Order';
                        validateOrderForm();
                    }
                });
            }
            
            // Checkbox functionality for bulk actions
            const checkboxes = document.querySelectorAll('.orders-table input[type="checkbox"]');
            const bulkActions = document.querySelector('.bulk-actions');
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const checkedCount = document.querySelectorAll('.orders-table tbody input[type="checkbox"]:checked').length;
                    if (checkedCount > 0) {
                        bulkActions.classList.add('show');
                        bulkActions.querySelector('.bulk-info').textContent = `${checkedCount} order${checkedCount > 1 ? 's' : ''} selected`;
                    } else {
                        bulkActions.classList.remove('show');
                    }
                });
            });
            
            // Select all checkbox
            const selectAllCheckbox = document.querySelector('.orders-table thead input[type="checkbox"]');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', (e) => {
                    const bodyCheckboxes = document.querySelectorAll('.orders-table tbody input[type="checkbox"]');
                    bodyCheckboxes.forEach(cb => {
                        cb.checked = e.target.checked;
                        cb.dispatchEvent(new Event('change'));
                    });
                });
            }

            // Modal close functionality
            const closeModalBtn = document.getElementById('closeModalBtn');
            const modal = document.getElementById('orderDetailModal');

            // Close modal when close button is clicked
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', closeOrderDetailModal);
            }

            // Close modal when clicking outside the modal container
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeOrderDetailModal();
                    }
                });
            }

            // Close modal when pressing Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const modal = document.getElementById('orderDetailModal');
                    if (modal && modal.classList.contains('show')) {
                        closeOrderDetailModal();
                    }
                }
            });
        });
    </script>
</body>
</html>