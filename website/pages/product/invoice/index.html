<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance - Invoice</title>
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="../../../core/themes/toss-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-component-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-base.css">
    <link rel="stylesheet" href="../../../core/themes/toss-typography.css">
    
    <!-- Component CSS -->
    <link rel="stylesheet" href="../../../components/base/toss-button.css">
    <link rel="stylesheet" href="../../../components/form/toss-input.css">
    <link rel="stylesheet" href="../../../components/form/toss-select.css">
    <link rel="stylesheet" href="../../../components/feedback/toss-alert.css">
    <link rel="stylesheet" href="../../../components/navigation/navbar.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Page Specific Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background: var(--toss-gray-50);
            min-height: 100vh;
        }
        
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .page-content {
            flex: 1;
            padding: var(--space-6);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .page-header {
            margin-bottom: var(--space-6);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--space-4);
        }
        
        .page-header-left {
            flex: 1;
            min-width: 200px;
        }
        
        .page-header-right {
            display: flex;
            gap: var(--space-3);
        }
        
        .page-title {
            font-size: var(--font-h1);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .page-subtitle {
            font-size: var(--font-large);
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Date Filter Tabs */
        .date-filter-container {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: var(--space-5);
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        .date-filter-tabs {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .date-filter-tab {
            padding: 10px 18px;
            border-radius: 8px;
            background: var(--toss-gray-50);
            border: 1px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            white-space: nowrap;
            user-select: none;
        }
        
        .date-filter-tab:hover {
            background: var(--toss-gray-100);
            color: var(--text-primary);
        }
        
        .date-filter-tab.active {
            background: #0064FF;
            color: white;
            border-color: #0064FF;
        }
        
        .date-filter-tab.custom {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Calendar Dropdown */
        .date-filter-container {
            position: relative;
        }
        
        .calendar-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(0, 0, 0, 0.08);
            padding: 16px;
            z-index: 1000;
            display: none;
            width: 320px;
            max-width: calc(100vw - 32px);
        }
        
        .calendar-dropdown.active {
            display: block;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .calendar-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .calendar-close {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--text-tertiary);
            transition: all 0.2s ease;
        }
        
        .calendar-close:hover {
            color: var(--text-primary);
        }
        
        .calendar-close svg {
            width: 20px;
            height: 20px;
        }
        
        .calendar-content {
            display: block;
        }
        
        .calendar-side {
            width: 100%;
        }
        
        .calendar-month-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .calendar-month-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .calendar-nav {
            display: flex;
            gap: 4px;
        }
        
        .calendar-nav-btn {
            background: none;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }
        
        .calendar-nav-btn:hover {
            background: var(--toss-gray-50);
            color: var(--text-primary);
        }
        
        .calendar-nav-btn svg {
            width: 14px;
            height: 14px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
        }
        
        .calendar-weekday {
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            padding: 6px 0;
            text-transform: uppercase;
        }
        
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-primary);
            transition: all 0.15s ease;
            border: 2px solid transparent;
            min-height: 28px;
        }
        
        .calendar-day:hover:not(.disabled):not(.selected) {
            background: var(--toss-gray-100);
        }
        
        .calendar-day.other-month {
            color: var(--text-tertiary);
            opacity: 0.4;
        }
        
        .calendar-day.disabled {
            color: var(--text-tertiary);
            cursor: not-allowed;
            opacity: 0.3;
        }
        
        .calendar-day.today {
            background: var(--toss-gray-100);
            font-weight: 600;
        }
        
        .calendar-day.selected {
            background: #0064FF;
            color: white;
            font-weight: 600;
        }
        
        .calendar-day.in-range {
            background: rgba(0, 100, 255, 0.1);
            color: #0064FF;
        }
        
        .calendar-day.range-start {
            background: #0064FF;
            color: white;
            border-top-right-radius: 0;
            border-bottom-right-radius: 0;
        }
        
        .calendar-day.range-end {
            background: #0064FF;
            color: white;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
        }
        
        .calendar-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .calendar-range-display {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: var(--text-secondary);
        }
        
        .calendar-range-dates {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .calendar-actions {
            display: flex;
            gap: 8px;
        }
        
        .calendar-btn {
            padding: 7px 14px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .calendar-btn.secondary {
            background: var(--toss-gray-100);
            color: var(--text-primary);
        }
        
        .calendar-btn.secondary:hover {
            background: var(--toss-gray-200);
        }
        
        .calendar-btn.primary {
            background: #0064FF;
            color: white;
        }
        
        .calendar-btn.primary:hover {
            background: #0050CC;
        }
        
        .calendar-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Invoice States */
        .invoice-loading-state,
        .invoice-error-state,
        .invoice-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .loading-spinner {
            margin-bottom: 20px;
        }
        
        .error-icon,
        .empty-icon {
            margin-bottom: 20px;
            opacity: 0.7;
        }
        
        .invoice-error-state h3,
        .invoice-empty-state h3 {
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 18px;
            font-weight: 600;
        }
        
        .invoice-error-state p,
        .invoice-empty-state p {
            color: var(--text-secondary);
            margin-bottom: 20px;
            max-width: 400px;
        }
        
        .retry-btn,
        .clear-filters-btn,
        .create-invoice-btn {
            padding: 10px 20px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .retry-btn:hover,
        .clear-filters-btn:hover,
        .create-invoice-btn:hover {
            background: var(--accent-blue-hover);
            transform: translateY(-1px);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-completed {
            background: rgba(34, 197, 94, 0.1);
            color: #059669;
        }
        
        .status-draft {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .status-cancelled {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        
        .status-pending {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }
        
        .status-unknown {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
        }
        
        /* Payment Badges */
        .payment-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .payment-paid {
            background: rgba(34, 197, 94, 0.1);
            color: #059669;
        }
        
        .payment-pending {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        /* Invoice Table Enhancements */
        .invoice-number-main {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .invoice-id {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .customer-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .customer-phone {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .item-count {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .total-qty {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .invoice-total {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        
        /* Search and Filters Bar */
        .search-filter-bar {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            margin-bottom: var(--space-5);
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        .search-filter-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .search-input-wrapper {
            flex: 1;
            min-width: 300px;
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s ease;
            background: var(--toss-gray-50);
        }
        
        .search-input:focus {
            outline: none;
            border-color: #0064FF;
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
            background: white;
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--text-tertiary);
        }
        
        /* Invoice Actions */
        .invoice-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-button {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: none;
        }
        
        .action-button.primary {
            background: #0064FF;
            color: white;
        }
        
        .action-button.primary:hover {
            background: #0050CC;
        }
        
        .action-button.secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .action-button.secondary:hover {
            background: var(--toss-gray-50);
        }
        
        /* Invoice Table */
        .invoice-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .invoice-table thead {
            background: var(--toss-gray-50);
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .invoice-table th {
            padding: 16px 20px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .invoice-table th.center {
            text-align: center;
        }
        
        .invoice-table th.right {
            text-align: right;
        }
        
        .invoice-table tbody tr {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: background 0.15s ease;
        }
        
        .invoice-table tbody tr:hover {
            background: var(--toss-gray-50);
        }
        
        .invoice-table td {
            padding: 18px 20px;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .invoice-table td.center {
            text-align: center;
        }
        
        .invoice-table td.right {
            text-align: right;
        }
        
        /* Invoice Number & Customer */
        .invoice-number {
            font-weight: 600;
            color: #0064FF;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        
        .invoice-number:hover {
            color: #0050CC;
            text-decoration: underline;
        }
        
        .customer-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .customer-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .customer-email {
            font-size: 13px;
            color: var(--text-tertiary);
        }
        
        /* Status Badge */
        .status-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge.paid {
            background: #d4f4dd;
            color: #16a34a;
        }
        
        .status-badge.pending {
            background: #fef3c7;
            color: #d97706;
        }
        
        .status-badge.overdue {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .status-badge.draft {
            background: #e5e7eb;
            color: #6b7280;
        }
        
        .status-badge.cancelled {
            background: #f3f4f6;
            color: #9ca3af;
        }
        
        .status-indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        /* Invoice Actions */
        .invoice-row-actions {
            display: flex;
            gap: 4px;
            align-items: center;
        }
        
        .invoice-action-btn {
            padding: 8px;
            border-radius: 6px;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-tertiary);
        }
        
        .invoice-action-btn:hover {
            background: var(--toss-gray-100);
            color: var(--text-primary);
        }
        
        .invoice-action-btn svg {
            width: 18px;
            height: 18px;
        }
        
        /* Checkbox */
        .checkbox-cell {
            width: 40px;
        }
        
        .invoice-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .invoice-checkbox:checked {
            background: #0064FF;
            border-color: #0064FF;
        }
        
        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: white;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }
        
        .pagination-info {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .pagination-button {
            padding: 8px 12px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-primary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .pagination-button:hover:not(:disabled) {
            background: var(--toss-gray-50);
            border-color: rgba(0, 0, 0, 0.15);
        }
        
        .pagination-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination-button.active {
            background: #0064FF;
            color: white;
            border-color: #0064FF;
        }
        
        .page-numbers {
            display: flex;
            gap: 4px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }
        
        .empty-state-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 24px;
            background: var(--toss-gray-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
        }
        
        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 8px;
        }
        
        .empty-state-text {
            font-size: 15px;
            color: var(--text-secondary);
            margin: 0 0 24px;
        }
        
        /* Loading State */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 4px;
        }
        
        @keyframes loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        /* Store Filter Control Styles - Exact match to inventory */
        .controls-card {
            background: transparent;
            padding: 0;
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .control-section {
            flex: 0 1 auto;
            min-width: 200px;
            max-width: 280px;
            width: 280px;
            display: flex;
            align-items: center;
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            gap: 10px;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: white;
            height: 44px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        }
        
        .control-section:hover {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.12);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        
        .control-section.dropdown-open {
            background: white;
            border-color: #0064FF;
            box-shadow: 0 0 0 4px rgba(0, 100, 255, 0.08);
        }
        
        .control-section.dropdown-open .control-dropdown {
            transform: rotate(180deg);
            color: #0064FF;
        }
        
        .control-section.dropdown-open .control-label {
            color: #0064FF;
            font-weight: 500;
        }
        
        .control-section.dropdown-open .control-icon {
            color: #0064FF;
        }
        
        .control-icon {
            width: 18px;
            height: 18px;
            color: rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
        }
        
        .control-label {
            font-size: 14px;
            font-weight: 500;
            color: #1a1a1a;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }
        
        .control-dropdown {
            width: 16px;
            height: 16px;
            color: rgba(0, 0, 0, 0.3);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            margin-left: auto;
        }
        
        /* Store Filter Dropdown Styles */
        .store-filter-dropdown {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            min-width: 100%;
            width: max-content;
            max-width: 380px;
            background: white;
            border-radius: 14px;
            box-shadow: 
                0 0 0 1px rgba(0, 0, 0, 0.04),
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px) scale(0.96);
            transition: all 200ms cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 380px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 6px 0;
        }
        
        .store-filter-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        /* Search input for filterable dropdown */
        .store-filter-search {
            padding: 8px 16px;
            margin: 0 6px 6px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.02);
            transition: all 150ms ease;
            width: calc(100% - 12px);
            box-sizing: border-box;
        }
        
        .store-filter-search:focus {
            outline: none;
            border-color: #0064FF;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .store-filter-search::placeholder {
            color: rgba(0, 0, 0, 0.4);
        }
        
        .store-filter-dropdown-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 150ms ease;
            position: relative;
            font-size: 15px;
            line-height: 1.5;
        }
        
        .store-filter-dropdown-option:hover {
            background: var(--toss-gray-50);
        }
        
        .store-filter-dropdown-option.focused {
            background: var(--toss-gray-100);
            transform: scale(0.98);
        }
        
        .store-filter-dropdown-option.selected {
            background: rgba(0, 100, 255, 0.08);
            color: #0064FF;
        }
        
        .store-filter-dropdown-option.selected:hover {
            background: rgba(0, 100, 255, 0.12);
        }
        
        .store-filter-dropdown-option-icon {
            width: 20px;
            height: 20px;
            color: var(--text-tertiary);
            flex-shrink: 0;
            transition: color 150ms ease;
        }
        
        .store-filter-dropdown-option.selected .store-filter-dropdown-option-icon {
            color: #0064FF;
        }
        
        .store-filter-dropdown-option-text {
            flex: 1;
            font-weight: 400;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .store-filter-dropdown-option.selected .store-filter-dropdown-option-text {
            font-weight: 500;
        }
        
        .store-filter-dropdown-option-check {
            width: 18px;
            height: 18px;
            color: #0064FF;
            margin-left: auto;
            flex-shrink: 0;
        }
        
        .content-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
        }
        
        .invoice-placeholder {
            text-align: center;
            padding: var(--space-12) var(--space-6);
        }
        
        .invoice-placeholder-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto var(--space-4);
            background: var(--toss-gray-100);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-tertiary);
        }
        
        .invoice-placeholder-title {
            font-size: var(--font-h3);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .invoice-placeholder-text {
            font-size: var(--font-base);
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Responsive Styles */
        @media (max-width: 1024px) {
            .invoice-table-container {
                overflow-x: auto;
            }
            
            .invoice-table {
                min-width: 800px;
            }
        }
        
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .page-header-right {
                width: 100%;
                justify-content: flex-start;
            }
            
            .date-filter-container {
                overflow-x: auto;
            }
            
            .date-filter-tabs {
                min-width: max-content;
                padding-bottom: 8px;
            }
            
            .custom-date-range {
                position: static;
                width: 100%;
                margin-top: 12px;
                flex-wrap: wrap;
            }
            
            .custom-date-range.active {
                display: flex;
            }
            
            .search-filter-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-input-wrapper {
                min-width: 100%;
            }
            
            .controls-card {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .control-section {
                max-width: none;
                width: 100%;
                min-width: unset;
            }
            
            .store-filter-dropdown {
                left: 0;
                right: 0;
                width: 100%;
                max-width: none;
                border-radius: 12px;
            }
            
            .store-filter-dropdown-option {
                padding: 14px 16px;
                font-size: 16px;
            }
            
            .pagination-container {
                flex-direction: column;
                gap: 16px;
                align-items: center;
            }
            
            .pagination-info {
                text-align: center;
            }
            
            .page-numbers {
                display: none;
            }
            
            .invoice-table {
                font-size: 13px;
            }
            
            .invoice-table th,
            .invoice-table td {
                padding: 12px 10px;
            }
            
            .customer-email {
                display: none;
            }
            
            .invoice-row-actions {
                gap: 2px;
            }
            
            .invoice-action-btn {
                padding: 6px;
            }
            
            .invoice-action-btn svg {
                width: 16px;
                height: 16px;
            }
        }
        
        @media (max-width: 480px) {
            .page-content {
                padding: var(--space-4);
            }
            
            .page-title {
                font-size: 24px;
            }
            
            .page-subtitle {
                font-size: 14px;
            }
            
            .date-filter-tab {
                padding: 8px 14px;
                font-size: 13px;
            }
            
            .action-button {
                padding: 10px 16px;
                font-size: 13px;
            }
            
            .action-button svg {
                width: 16px;
                height: 16px;
            }
            
            .search-input {
                font-size: 14px;
                padding: 10px 14px 10px 40px;
            }
            
            .store-filter-dropdown {
                left: -12px;
                right: -12px;
                max-height: 250px;
            }
            
            /* Mobile Card View for Invoice Table */
            .invoice-table-container {
                background: transparent;
                box-shadow: none;
                border: none;
            }
            
            .invoice-table thead {
                display: none;
            }
            
            .invoice-table tbody {
                display: block;
            }
            
            .invoice-table tr {
                display: block;
                background: white;
                border-radius: 12px;
                margin-bottom: 12px;
                padding: 16px;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
                border: 1px solid rgba(0, 0, 0, 0.06);
            }
            
            .invoice-table td {
                display: block;
                padding: 4px 0;
                text-align: left !important;
                border: none;
            }
            
            .invoice-table td.checkbox-cell {
                display: none;
            }
            
            .invoice-table td.center,
            .invoice-table td.right {
                text-align: left !important;
            }
            
            .invoice-table td:before {
                content: attr(data-label);
                font-weight: 600;
                font-size: 12px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                color: var(--text-tertiary);
                display: block;
                margin-bottom: 4px;
            }
            
            .invoice-number {
                font-size: 16px;
            }
            
            .customer-info {
                margin-top: 8px;
                padding-top: 8px;
                border-top: 1px solid rgba(0, 0, 0, 0.05);
            }
            
            .status-badge {
                display: inline-flex;
                margin-top: 4px;
            }
            
            .invoice-row-actions {
                margin-top: 12px;
                padding-top: 12px;
                border-top: 1px solid rgba(0, 0, 0, 0.05);
                justify-content: flex-start;
                gap: 8px;
            }
            
            .invoice-action-btn {
                padding: 8px 12px;
                background: var(--toss-gray-50);
                border-radius: 8px;
            }
            
            .pagination-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .pagination-button {
                flex: 1;
                justify-content: center;
            }
            
            /* Mobile Calendar Styles */
            .calendar-dropdown {
                left: 50%;
                transform: translateX(-50%);
                width: calc(100vw - 32px);
                max-width: 480px;
                padding: 12px;
            }
            
            .calendar-content {
                flex-direction: column;
                gap: 12px;
            }
            
            
            .calendar-grid {
                gap: 1px;
            }
            
            .calendar-day {
                font-size: 12px;
                border-radius: 4px;
                min-height: 24px;
            }
            
            .calendar-weekday {
                padding: 4px 0;
                font-size: 10px;
            }
            
            .calendar-footer {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .calendar-actions {
                width: 100%;
                gap: 8px;
            }
            
            .calendar-btn {
                flex: 1;
                text-align: center;
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .calendar-range-display {
                text-align: center;
                font-size: 12px;
            }
        }
        
        /* ==============================================
           NEW INVOICE MODAL STYLES
           ============================================== */
        
        /* Step Indicator Styles */
        .step-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 30px;
            background: var(--toss-gray-50);
            border-bottom: 1px solid var(--toss-gray-200);
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--toss-gray-300);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--toss-gray-500);
            transition: all 0.3s ease;
        }
        
        .step.active .step-number {
            background: var(--toss-blue-500);
            border-color: var(--toss-blue-500);
            color: white;
        }
        
        .step.completed .step-number {
            background: var(--toss-success);
            border-color: var(--toss-success);
            color: white;
        }
        
        .step-label {
            font-size: 12px;
            color: var(--toss-gray-600);
            font-weight: 500;
        }
        
        .step.active .step-label {
            color: var(--toss-blue-500);
            font-weight: 600;
        }
        
        .step-line {
            width: 80px;
            height: 2px;
            background: var(--toss-gray-300);
            margin: 0 8px;
            margin-bottom: 20px;
        }
        
        .step-line.completed {
            background: var(--toss-success);
        }
        
        /* Step Content */
        .step-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .step-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Step Navigation */
        .step-navigation {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            padding: 20px;
            border-top: 1px solid var(--toss-gray-200);
            background: var(--toss-gray-50);
        }
        
        .step-navigation .btn-group {
            display: flex;
            gap: 12px;
        }
        
        /* All Products List Styles */
        .all-products-section {
            margin-top: 20px;
            border-top: 1px solid var(--toss-gray-200);
            padding-top: 16px;
        }
        
        .products-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 4px;
        }
        
        .products-list-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--toss-gray-700);
        }
        
        .products-list-count {
            font-size: 12px;
            color: var(--toss-gray-500);
            background: var(--toss-gray-100);
            padding: 2px 8px;
            border-radius: 10px;
        }
        
        .all-products-list {
            /* Removed max-height and overflow to prevent double scrollbar */
            margin: 0 -20px;
            padding: 0 20px 0 30px;
        }
        
        .product-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--toss-gray-50);
            border: 1px solid var(--toss-gray-200);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .product-list-item:hover {
            background: white;
            border-color: var(--toss-blue-500);
            box-shadow: 0 2px 8px rgba(0, 100, 255, 0.1);
        }
        
        .product-list-item.selected {
            background: #f0fdf4;
            border-color: #22c55e;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .product-list-item.out-of-stock {
            opacity: 0.5;
            pointer-events: none;
        }
        
        .product-list-item.out-of-stock .product-list-name {
            text-decoration: line-through;
        }
        
        .product-out-of-stock-badge {
            display: inline-block;
            padding: 2px 6px;
            background: var(--toss-error);
            color: white;
            font-size: 10px;
            font-weight: 600;
            border-radius: 4px;
            margin-left: 8px;
            text-transform: uppercase;
        }
        
        .product-list-info {
            flex: 1;
            min-width: 0;
        }
        
        .product-list-sku {
            font-size: 12px;
            font-weight: 600;
            color: var(--toss-gray-600);
            margin-bottom: 4px;
        }
        
        .product-list-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--toss-gray-900);
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .product-list-price {
            font-size: 13px;
            color: var(--toss-gray-600);
        }
        
        .product-list-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quantity-control-group {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid var(--toss-gray-300);
            border-radius: 6px;
            overflow: hidden;
            height: 28px;
        }
        
        .selected-summary-controls .quantity-control-group {
            background: var(--toss-gray-50);
            border-color: var(--toss-gray-200);
        }
        
        .quantity-control-btn {
            width: 28px;
            height: 28px;
            padding: 0;
            border: none;
            background: transparent;
            color: var(--toss-gray-700);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .quantity-control-btn:hover:not(:disabled) {
            background: var(--toss-gray-100);
        }
        
        .quantity-control-btn:active:not(:disabled) {
            background: var(--toss-gray-200);
        }
        
        .quantity-control-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .quantity-control-btn.minus {
            border-right: 1px solid var(--toss-gray-200);
        }
        
        .quantity-control-btn.plus {
            border-left: 1px solid var(--toss-gray-200);
        }
        
        .quantity-control-input {
            width: 40px;
            padding: 0;
            border: none;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            background: transparent;
            -moz-appearance: textfield;
            height: 28px;
        }
        
        .quantity-control-input::-webkit-outer-spin-button,
        .quantity-control-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .quantity-control-input:focus {
            outline: none;
        }
        
        .product-add-btn {
            padding: 8px 16px;
            background: var(--toss-blue-500);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .product-add-btn:hover {
            background: var(--toss-blue-600);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 100, 255, 0.2);
        }
        
        .product-add-btn:active {
            transform: translateY(0);
        }
        
        .product-remove-btn {
            padding: 6px;
            background: var(--toss-error);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .product-remove-btn:hover {
            background: #dc2626;
        }
        
        /* Selected Products Summary */
        .selected-products-summary {
            margin-top: 16px;
            margin-bottom: 20px;
            padding: 16px;
            background: linear-gradient(135deg, var(--toss-blue-50) 0%, var(--toss-blue-100) 100%);
            border: 1px solid var(--toss-blue-200);
            border-radius: 12px;
        }
        
        .selected-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .selected-summary-title {
            font-size: 14px;
            font-weight: 600;
            color: #003d99;
        }
        
        .selected-summary-count {
            font-size: 12px;
            color: white;
            background: var(--toss-blue-500);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .selected-summary-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .selected-summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: var(--toss-gray-50);
            border: 1px solid var(--toss-gray-200);
            border-radius: 12px;
            transition: all 0.2s ease;
        }
        
        .selected-summary-item:hover {
            background: white;
            border-color: var(--toss-blue-500);
            box-shadow: 0 2px 8px rgba(0, 100, 255, 0.1);
        }
        
        .selected-summary-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
        }
        
        .selected-summary-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .selected-summary-remove {
            padding: 6px;
            background: var(--toss-error);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .selected-summary-remove:hover {
            background: #dc2626;
        }
        
        .selected-summary-sku {
            font-size: 12px;
            font-weight: 600;
            color: var(--toss-gray-600);
        }
        
        .selected-summary-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--toss-gray-900);
        }
        
        .selected-summary-price {
            font-size: 13px;
            color: var(--toss-gray-700);
        }
        
        /* In-Modal Notification Styles */
        .modal-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 320px;
            max-width: 400px;
            display: none;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .modal-notification.show {
            display: block;
            animation: slideInScale 1s ease-out forwards;
        }
        
        @keyframes slideInScale {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.9);
            }
            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            80% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.95);
            }
        }
        
        .modal-notification-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 16px;
            background: #fef2f2;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ef4444;
        }
        
        .modal-notification-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .modal-notification-message {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .modal-notification-button {
            padding: 10px 24px;
            background: var(--toss-blue-500);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .modal-notification-button:hover {
            background: var(--toss-blue-600);
            transform: translateY(-1px);
        }
        
        .modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 999;
            display: none;
            border-radius: 12px;
            /* Removed animation that was causing blinking */
        }
        
        .modal-overlay.show {
            display: block;
        }
        
        @keyframes fadeInOut {
            0% {
                opacity: 0;
            }
            20% {
                opacity: 1;
            }
            80% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }
        
        /* Order Summary Styles */
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--toss-gray-200);
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .order-item-info {
            flex: 1;
        }
        
        .order-item-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--toss-gray-900);
            margin-bottom: 4px;
        }
        
        .order-item-details {
            font-size: 12px;
            color: var(--toss-gray-600);
        }
        
        .order-item-price {
            font-size: 14px;
            font-weight: 600;
            color: var(--toss-gray-900);
        }
        
        .summary-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--toss-gray-200);
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .summary-row.discount-row {
            cursor: pointer;
            color: var(--toss-blue-500);
            transition: all 0.2s ease;
        }
        
        .summary-row.discount-row:hover {
            background: var(--toss-gray-50);
            margin: 0 -12px;
            padding: 8px 12px;
            border-radius: 8px;
        }
        
        .summary-row.total {
            font-size: 16px;
            font-weight: 600;
            color: var(--toss-gray-900);
            padding-top: 12px;
            border-top: 1px solid var(--toss-gray-200);
            margin-top: 8px;
        }
        
        /* Discount Modal */
        .discount-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: white;
            border-radius: 16px;
            padding: 24px;
            min-width: 360px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 2000;
        }
        
        .discount-modal.active {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .discount-modal-header {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .discount-modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .discount-type-toggle {
            display: flex;
            background: var(--toss-gray-100);
            border-radius: 8px;
            padding: 4px;
            margin-bottom: 20px;
        }
        
        .discount-type-btn {
            flex: 1;
            padding: 8px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--toss-gray-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .discount-type-btn.active {
            background: white;
            color: var(--toss-blue-500);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .discount-input-group {
            margin-bottom: 20px;
        }
        
        .discount-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--toss-gray-300);
            border-radius: 8px;
            font-size: 24px;
            text-align: center;
            transition: all 0.2s ease;
            font-weight: 600;
        }
        
        .discount-input:focus {
            outline: none;
            border-color: var(--toss-blue-500);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .discount-modal-footer {
            display: flex;
            gap: 12px;
        }
        
        .discount-modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }
        
        .discount-modal-btn.primary {
            background: var(--toss-blue-500);
            color: white;
        }
        
        .discount-modal-btn.primary:hover {
            background: var(--toss-blue-600);
        }
        
        /* Summary Section */
        .summary-section {
            background: var(--toss-gray-50);
            border-radius: 12px;
            padding: 16px;
            margin-top: 16px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 14px;
        }
        
        .summary-row.discount-row {
            cursor: pointer;
            padding: 8px;
            margin: 0 -8px;
            border-radius: 6px;
            transition: background 0.2s ease;
            color: var(--toss-blue-500);
        }
        
        .summary-row.discount-row:hover {
            background: var(--toss-gray-100);
        }
        
        .summary-row.total {
            border-top: 1px solid var(--toss-gray-200);
            margin-top: 8px;
            padding-top: 12px;
            font-weight: 600;
            font-size: 16px;
        }
        
        .order-summary {
            margin-bottom: 16px;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border: 1px solid var(--toss-gray-200);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        .order-item-info {
            flex: 1;
        }
        
        .order-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .order-item-details {
            font-size: 12px;
            color: var(--toss-gray-600);
        }
        
        .order-item-price {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            /* Removed transition to prevent blinking */
            padding: 20px;
            box-sizing: border-box;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-overlay.active .modal-container {
            transform: translateY(0);
            opacity: 1;
        }
        
        /* Add Payment Modal Specific Styles */
        #addPaymentModal.active {
            opacity: 1 !important;
            visibility: visible !important;
            display: flex !important;
        }
        
        /* Modal Container */
        .modal-container {
            background: white;
            border-radius: 16px;
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 0.25),
                0 25px 25px -12px rgba(0, 0, 0, 0.1);
            width: 80%;
            max-width: 1200px;
            height: 80vh;
            display: flex;
            flex-direction: column;
            transform: translateY(20px);
            opacity: 0;
            /* Removed transition to prevent blinking */
            overflow: hidden;
        }
        
        /* Modal Header */
        .modal-header {
            padding: 24px 32px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--toss-gray-50);
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            color: var(--text-tertiary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-primary);
        }
        
        /* Modal Content */
        .modal-content {
            padding: 32px;
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }
        
        /* Custom scrollbar for modal content - single scrollbar for entire modal */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .modal-content::-webkit-scrollbar-track {
            background: var(--toss-gray-100, #f3f4f6);
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb {
            background: var(--toss-gray-400, #9ca3af);
            border-radius: 4px;
        }
        
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: var(--toss-gray-500, #6b7280);
        }
        
        /* Form Sections */
        .form-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .form-label {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .form-label-icon {
            color: #0064FF;
            opacity: 0.8;
        }
        
        /* Form Inputs */
        .form-input {
            padding: 14px 16px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 15px;
            color: var(--text-primary);
            background: white;
            transition: all 0.2s ease;
            outline: none;
            width: 100%;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            border-color: #0064FF;
            background: var(--toss-gray-50);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--text-tertiary);
        }
        
        /* Form Select Container */
        .form-select-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .form-select {
            padding: 14px 16px;
            padding-right: 48px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            font-size: 15px;
            color: var(--text-primary);
            background: white;
            transition: all 0.2s ease;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            appearance: none;
            cursor: pointer;
        }
        
        .form-select:focus {
            border-color: #0064FF;
            background: var(--toss-gray-50);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .form-select-arrow {
            position: absolute;
            right: 16px;
            color: var(--text-tertiary);
            pointer-events: none;
            transition: all 0.2s ease;
        }
        
        .form-select:focus + .form-select-arrow {
            color: #0064FF;
            transform: rotate(180deg);
        }
        
        /* Amount Input Container */
        .form-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .amount-input {
            font-weight: 600;
            text-align: left;
        }
        
        .form-help-text {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 4px;
        }
        
        /* Product Search Styles */
        .product-search-container {
            position: relative;
        }
        
        .product-search-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }
        
        .product-search-dropdown.active {
            display: block;
        }
        
        .product-search-loading {
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .product-search-results {
            padding: 8px 0;
        }
        
        .product-search-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .product-search-item:last-child {
            border-bottom: none;
        }
        
        .product-search-item:hover {
            background: var(--toss-gray-50);
        }
        
        .product-item-info {
            flex: 1;
        }
        
        .product-item-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .product-item-details {
            font-size: 13px;
            color: var(--text-tertiary);
        }
        
        .product-item-price {
            font-weight: 700;
            color: #0064FF;
            font-size: 15px;
        }
        
        .product-item-details {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .product-sku {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .product-stock {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .product-stock.in-stock {
            background: rgba(34, 197, 94, 0.1);
            color: #059669;
        }
        
        .product-stock.low-stock {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .product-stock.out-of-stock {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        
        .product-search-empty {
            padding: 40px 20px;
            text-align: center;
            color: var(--text-tertiary);
        }
        
        .product-search-empty p {
            margin: 12px 0 4px 0;
            font-weight: 600;
            color: var(--text-secondary);
        }
        
        .product-search-empty span {
            font-size: 13px;
        }
        
        /* Selected Products */
        .selected-products {
            margin-top: 16px;
        }
        
        .selected-product-item {
            background: var(--toss-gray-50);
            border: 2px solid rgba(0, 100, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .selected-product-info {
            flex: 1;
        }
        
        .selected-product-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .selected-product-details {
            font-size: 13px;
            color: var(--text-tertiary);
        }
        
        .selected-product-controls {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quantity-btn {
            width: 32px;
            height: 32px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }
        
        .quantity-btn:hover {
            background: var(--toss-gray-100);
            border-color: rgba(0, 0, 0, 0.2);
            color: var(--text-primary);
        }
        
        .quantity-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .quantity-input {
            width: 60px;
            padding: 6px 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            background: white;
        }
        
        /* Hide spinner arrows in Chrome, Safari, Edge */
        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Hide spinner arrows for denomination quantity inputs - Chrome, Safari, Edge */
        .denomination-quantity-input::-webkit-outer-spin-button,
        .denomination-quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Hide spinner arrows for denomination quantity inputs - Firefox */
        .denomination-quantity-input[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        /* Hide spinner arrows for amount received input - Chrome, Safari, Edge */
        #amountReceived::-webkit-outer-spin-button,
        #amountReceived::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Hide spinner arrows for amount received input - Firefox */
        #amountReceived[type=number] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        /* Hide spinner arrows in Firefox */
        .quantity-input[type=number] {
            -moz-appearance: textfield;
        }
        
        .remove-product-btn {
            width: 32px;
            height: 32px;
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: #dc3545;
        }
        
        .remove-product-btn:hover {
            background: #dc3545;
            color: white;
        }
        
        /* Invoice Summary */
        .invoice-summary {
            margin-top: 24px;
            padding: 20px;
            background: var(--toss-gray-50);
            border: 2px solid rgba(0, 100, 255, 0.1);
            border-radius: 12px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            font-size: 15px;
            color: var(--text-secondary);
        }
        
        .summary-row.total {
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            margin-top: 8px;
            padding-top: 16px;
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .summary-row.change {
            color: #28a745;
            font-weight: 600;
            background: rgba(40, 167, 69, 0.1);
            margin: 8px -20px -20px -20px;
            padding: 16px 20px;
            border-radius: 0 0 10px 10px;
        }
        
        /* Modal Footer */
        .modal-footer {
            padding: 24px 32px;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            background: var(--toss-gray-50);
        }
        
        .modal-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
            justify-content: center;
        }
        
        .modal-btn.secondary {
            background: white;
            color: var(--text-secondary);
            border-color: rgba(0, 0, 0, 0.1);
        }
        
        .modal-btn.secondary:hover {
            background: var(--toss-gray-50);
            color: var(--text-primary);
            border-color: rgba(0, 0, 0, 0.2);
        }
        
        .modal-btn.primary {
            background: #0064FF;
            color: white;
            border-color: #0064FF;
        }
        
        .modal-btn.primary:hover:not(:disabled) {
            background: #0050CC;
            border-color: #0050CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 100, 255, 0.3);
        }
        
        .modal-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .modal-container {
                width: 95%;
                max-width: calc(100vw - 20px);
                max-height: calc(100vh - 40px);
                margin: 10px;
            }
            
            .modal-header {
                padding: 20px 24px;
            }
            
            .modal-content {
                padding: 24px;
                gap: 20px;
            }
            
            .modal-footer {
                padding: 20px 24px;
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
            }
            
            .selected-product-controls {
                flex-direction: column;
                gap: 12px;
                align-items: flex-end;
            }
            
            .quantity-controls {
                order: 2;
            }
        }
        
        @media (max-width: 480px) {
            .modal-overlay {
                padding: 16px;
            }
            
            .form-section {
                gap: 10px;
            }
            
            .modal-content {
                padding: 20px;
                gap: 16px;
            }
            
            .product-search-dropdown {
                max-height: 200px;
            }
        }
        
        /* Cash Location Search Menu Styles */
        .cash-location-search-menu {
            background: var(--toss-white) !important;
            border: 1px solid var(--toss-gray-300) !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
                        0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
            max-height: 400px;
            overflow-y: auto;
            min-width: 100%;
            border-radius: 12px;
        }
        
        .cash-location-option {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .cash-location-option:hover {
            background-color: var(--toss-gray-50);
        }
        
        .cash-location-option .account-option-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }
        
        .cash-location-option .account-option-name {
            flex: 1;
            font-size: 14px;
            color: var(--toss-gray-900);
            font-weight: 500;
        }
        
        .cash-location-option .account-option-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            margin-left: 12px;
        }
        
        /* TossSelect for Cash Location */
        #cashLocationSelect {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--toss-gray-300);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        #cashLocationSelect:hover {
            border-color: var(--toss-gray-400);
        }
        
        #cashLocationSelect .toss-select-value {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        #cashLocationSelect .toss-select-placeholder {
            color: var(--toss-gray-400);
        }
        
        #cashLocationSelect .toss-select-arrow {
            width: 20px;
            height: 20px;
            color: var(--toss-gray-600);
            margin-left: 8px;
        }
        
        .toss-select-container {
            position: relative;
        }
        
        /* Currency and Denomination Styles */
        .currency-btn {
            padding: 8px 16px;
            border: 1px solid var(--toss-gray-300);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .currency-btn:hover {
            border-color: var(--toss-blue-500);
            background: var(--toss-gray-50);
        }
        
        .currency-btn.active {
            border-color: var(--toss-blue-500);
            background: var(--toss-blue-50);
            color: var(--toss-blue-600);
        }
        
        .currency-flag {
            font-size: 20px;
        }
        
        .currency-code {
            font-weight: 600;
        }
        
        .currency-checkmark {
            margin-left: auto;
            color: #28a745;
            font-size: 16px;
            display: flex;
            align-items: center;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            justify-content: center;
        }
        
        /* Payment Methods Styles */
        .btn-add-payment {
            padding: 8px 16px;
            border: 1px solid var(--toss-blue-500);
            border-radius: 8px;
            background: var(--toss-blue-50);
            color: var(--toss-blue-600);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .btn-add-payment:hover {
            background: var(--toss-blue-100);
            border-color: var(--toss-blue-600);
        }
        
        .payment-type-display {
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .payment-type-display.cash {
            background: #f0fdf4;                     /* green-50 */
            color: #16a34a;                          /* green-600 */
            border: 1px solid #bbf7d0;               /* green-200 */
        }
        
        .payment-type-display.bank {
            background: var(--toss-blue-50);
            color: var(--toss-blue-600);
            border: 1px solid var(--toss-blue-200);
        }
        
        .payment-type-display.transfer {
            background: var(--toss-purple-50);
            color: var(--toss-purple-600);
            border: 1px solid var(--toss-purple-200);
        }
        
        /* Currency buttons with data indication - FIXED: Using actual colors instead of undefined CSS variables */
        #addPaymentCurrencies .currency-btn.has-data,
        .currency-btn.has-data {
            border: 2px solid #22c55e !important;    /* green-500 */
            background: #f0fdf4 !important;          /* green-50 */
            color: #15803d !important;               /* green-700 */
            position: relative;
            box-shadow: 0 0 0 1px #bbf7d0 !important; /* green-200 */
        }
        
        /* When button has both active and has-data classes, has-data should win */
        #addPaymentCurrencies .currency-btn.has-data.active,
        .currency-btn.has-data.active {
            border: 2px solid #22c55e !important;    /* green-500 */
            background: #dcfce7 !important;          /* green-100 */
            color: #166534 !important;               /* green-800 */
            box-shadow: 0 0 0 1px #bbf7d0 !important; /* green-200 */
        }
        
        #addPaymentCurrencies .currency-btn.has-data::after,
        .currency-btn.has-data::after {
            content: '✓';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 14px;
            color: #16a34a;                          /* green-600 */
            font-weight: bold;
            z-index: 1;
        }
        
        /* Override hover states for has-data (higher specificity) */
        #addPaymentCurrencies .currency-btn.has-data:hover,
        .currency-btn.has-data:hover,
        #addPaymentCurrencies .currency-btn.has-data.active:hover,
        .currency-btn.has-data.active:hover {
            border: 2px solid #16a34a !important;    /* green-600 */
            background: #bbf7d0 !important;          /* green-200 */
            color: #14532d !important;               /* green-900 */
        }
        
        /* Currency total display */
        .currency-total-display {
            margin-top: 16px;
            padding: 12px 16px;
            background: var(--toss-blue-50);
            border: 1px solid var(--toss-blue-200);
            border-radius: 8px;
        }
        
        .currency-total-label {
            font-size: 12px;
            color: var(--toss-gray-600);
            margin-bottom: 4px;
        }
        
        .currency-total-amount {
            font-size: 16px;
            font-weight: 600;
            color: var(--toss-blue-700);
        }
        
        .payment-methods-list {
            min-height: 120px;
            border: 1px dashed var(--toss-gray-300);
            border-radius: 8px;
            background: var(--toss-gray-25);
        }
        
        .no-payments-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 16px;
            text-align: center;
            color: var(--toss-gray-500);
        }
        
        .no-payments-message p {
            margin: 8px 0 0 0;
            font-size: 14px;
        }
        
        .payment-method-item {
            background: white;
            border: 1px solid var(--toss-gray-200);
            border-radius: 8px;
            margin: 12px;
            padding: 16px;
            transition: all 0.2s;
        }
        
        .payment-method-item:hover {
            border-color: var(--toss-gray-300);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .payment-method-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        
        .payment-method-title {
            font-weight: 600;
            color: var(--toss-gray-900);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .payment-method-actions {
            display: flex;
            gap: 8px;
        }
        
        /* Payment Delete Button - Red X Style */
        .payment-delete-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: #ef4444;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            line-height: 1;
        }
        
        .payment-delete-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }
        
        .payment-delete-btn:active {
            transform: scale(0.95);
        }
        
        .payment-currencies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .payment-currency-item {
            background: var(--toss-gray-50);
            border: 1px solid var(--toss-gray-200);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .payment-currency-amount {
            font-weight: 600;
            color: var(--toss-gray-900);
        }
        
        /* Add Payment Modal Styles */
        
        .payment-type-btn {
            padding: 16px 12px;
            border: 2px solid var(--toss-gray-200);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            color: var(--toss-gray-700);
        }
        
        .payment-type-btn:hover {
            border-color: var(--toss-blue-300);
            background: var(--toss-blue-25);
        }
        
        .payment-type-btn.active {
            border-color: var(--toss-blue-500);
            background: var(--toss-blue-50);
            color: var(--toss-blue-700);
        }
        
        .add-payment-currencies {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .add-payment-amount-input {
            margin-top: 16px;
        }
        
        .denomination-btn {
            padding: 10px 8px;
            border: 1px solid var(--toss-gray-300);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .denomination-btn:hover {
            border-color: var(--toss-blue-500);
            background: var(--toss-gray-50);
        }
        
        .denomination-btn:active {
            transform: scale(0.98);
            background: var(--toss-gray-100);
        }

        /* Cash Count Denomination Inputs */
        .denomination-input-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--toss-gray-100);
        }

        .denomination-input-row:last-child {
            border-bottom: none;
        }

        .denomination-radio {
            width: 20px;
            height: 20px;
            accent-color: var(--toss-blue-500);
        }

        .denomination-label {
            flex: 1;
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
            min-width: 120px;
        }

        .denomination-quantity-input {
            width: 80px;
            padding: 8px 12px;
            border: 1px solid var(--toss-gray-300);
            border-radius: 8px;
            background: white;
            font-size: 16px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .denomination-quantity-input:focus {
            outline: none;
            border-color: var(--toss-blue-500);
            box-shadow: 0 0 0 2px rgba(0, 100, 255, 0.1);
        }

        .denomination-unit {
            color: var(--toss-gray-500);
            font-size: 14px;
            min-width: 30px;
        }

        .denomination-amount {
            min-width: 120px;
            text-align: right;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .denomination-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding: 16px;
            background: var(--toss-gray-50);
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
        }

        .denomination-total-label {
            color: var(--text-primary);
        }

        .denomination-total-amount {
            color: var(--toss-blue-500);
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }

        .cash-count-header {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .cash-count-currency {
            color: var(--toss-blue-500);
            background: var(--toss-blue-50);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* Discount Type & Form Layout Styles */
        .discount-type-container {
            margin-top: 8px;
        }

        .discount-type-options {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid var(--toss-gray-200);
            background: white;
            min-width: 140px;
        }

        .radio-option:hover {
            background: var(--toss-gray-50);
            border-color: var(--toss-blue-300);
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-button {
            width: 16px;
            height: 16px;
            border: 2px solid var(--toss-gray-300);
            border-radius: 50%;
            position: relative;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .radio-option input[type="radio"]:checked + .radio-button {
            border-color: var(--toss-blue-500);
            background: var(--toss-blue-500);
        }

        .radio-option input[type="radio"]:checked + .radio-button::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: white;
        }

        .radio-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            user-select: none;
        }

        .radio-option input[type="radio"]:checked ~ .radio-label {
            color: var(--toss-blue-500);
            font-weight: 600;
        }

        /* Form Row Layout */
        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            flex: 1;
            min-width: 0;
        }

        .form-row .form-group:last-child {
            margin-bottom: 0;
        }

        /* Product discount input styles (for item-level discounts) */
        .product-discount-input {
            width: 80px;
            padding: 6px 8px;
            border: 1px solid var(--toss-gray-300);
            border-radius: 6px;
            font-size: 14px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .product-discount-input:focus {
            outline: none;
            border-color: var(--toss-blue-500);
            box-shadow: 0 0 0 2px rgba(0, 100, 255, 0.1);
        }

        .product-discount-input::-webkit-outer-spin-button,
        .product-discount-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .product-discount-input[type=number] {
            -moz-appearance: textfield;
        }

        /* Updated summary styles with discount display */
        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--toss-gray-100);
            font-size: 14px;
        }

        .summary-row:last-child {
            border-bottom: none;
        }

        .summary-row.total {
            font-weight: 600;
            font-size: 16px;
            border-top: 2px solid var(--toss-gray-200);
            margin-top: 8px;
            padding-top: 12px;
        }

        .summary-row.discount {
            color: var(--toss-success);
        }

        .summary-row.tax {
            color: var(--text-secondary);
        }

        .summary-row.change {
            font-weight: 600;
            color: var(--toss-success);
        }

        /* Selected Products Display Styles */
        .no-products-selected {
            padding: 24px;
            text-align: center;
            color: var(--text-tertiary);
            font-style: italic;
            border: 2px dashed var(--toss-gray-200);
            border-radius: 12px;
            background: var(--toss-gray-50);
        }

        .selected-product-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border: 1px solid var(--toss-gray-200);
            border-radius: 12px;
            background: white;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .selected-product-item:hover {
            border-color: var(--toss-blue-300);
            box-shadow: 0 2px 8px rgba(0, 100, 255, 0.1);
        }

        .selected-product-item:last-child {
            margin-bottom: 0;
        }

        .product-info {
            flex: 1;
            min-width: 0;
        }

        .product-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 16px;
        }

        .product-price {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .product-controls {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .control-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--toss-gray-600);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .quantity-input {
            width: 70px;
            padding: 8px 12px;
            border: 1px solid var(--toss-gray-300);
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .quantity-input:focus {
            outline: none;
            border-color: var(--toss-blue-500);
            box-shadow: 0 0 0 2px rgba(0, 100, 255, 0.1);
        }

        .quantity-input::-webkit-outer-spin-button,
        .quantity-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .quantity-input[type=number] {
            -moz-appearance: textfield;
        }

        .remove-product-btn {
            padding: 8px;
            border: none;
            background: var(--toss-error);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-product-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .remove-product-btn:active {
            transform: scale(0.95);
        }

        /* Invoice Summary Styles */
        .invoice-summary {
            background: var(--toss-gray-50);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--toss-gray-200);
            margin-top: 20px;
        }

        .invoice-summary .summary-row {
            font-size: 15px;
            font-weight: 500;
        }

        /* Mobile optimizations for multi-step flow */
        @media (max-width: 768px) {
            .step-indicator {
                padding: 12px;
            }
            
            .step {
                flex-direction: column;
                gap: 4px;
                min-width: 60px;
            }
            
            .step-number {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            
            .step-label {
                font-size: 10px;
            }
            
            .step-line {
                width: 20px;
            }
            
            .modal-container {
                margin: 10px;
                max-width: calc(100% - 20px);
                max-height: calc(100vh - 20px);
            }
            
            .discount-modal {
                width: calc(100% - 40px);
                max-width: 320px;
            }
            
            .selected-product-item {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .product-controls {
                justify-content: flex-end;
            }

            .product-discount-input {
                width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Navigation Bar -->
        <div id="navbar-container"></div>
        
        <!-- Page Content -->
        <main class="page-content">
            <!-- Page Header with Actions -->
            <div class="page-header">
                <div class="page-header-left">
                    <h1 class="page-title">Invoices</h1>
                    <p class="page-subtitle">Manage billing and payment records</p>
                </div>
                <div class="page-header-right">
                    <button class="action-button secondary">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,13V17H10V13H7L12,8L17,13M19.35,10.03C18.67,6.59 15.64,4 12,4C9.11,4 6.6,5.64 5.35,8.03C2.34,8.36 0,10.9 0,14A6,6 0 0,0 6,20H19A5,5 0 0,0 24,15C24,12.36 21.95,10.22 19.35,10.03Z"/>
                        </svg>
                        Export
                    </button>
                    <button class="action-button primary" id="newInvoiceBtn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                        </svg>
                        New Invoice
                    </button>
                </div>
            </div>
            
            <!-- New Invoice Modal -->
            <div class="modal-overlay" id="newInvoiceModal">
                <div class="modal-container">
                    <div class="modal-header">
                        <h2 class="modal-title" id="modalTitle">Select Products</h2>
                        <button class="modal-close-btn" id="closeInvoiceModal">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <!-- Step Indicator -->
                    <div class="step-indicator">
                        <div class="step active" data-step="1">
                            <span class="step-number">1</span>
                            <span class="step-label">Products</span>
                        </div>
                        <div class="step-line"></div>
                        <div class="step" data-step="2">
                            <span class="step-number">2</span>
                            <span class="step-label">Review</span>
                        </div>
                        <div class="step-line"></div>
                        <div class="step" data-step="3">
                            <span class="step-number">3</span>
                            <span class="step-label">Payment</span>
                        </div>
                    </div>
                    
                    <form class="modal-content" id="newInvoiceForm">
                        <!-- In-Modal Notification -->
                        <div class="modal-overlay" id="modalOverlay"></div>
                        <div class="modal-notification" id="modalNotification">
                            <div class="modal-notification-icon">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                                </svg>
                            </div>
                            <div class="modal-notification-title">No Products Selected</div>
                            <div class="modal-notification-message">Please select at least one product to continue.</div>
                            <button type="button" class="modal-notification-button" onclick="window.newInvoiceModal.hideNotification()">OK</button>
                        </div>
                        
                        <!-- Step 1: Product Selection -->
                        <div class="step-content active" id="step1Content">
                            <!-- Product Search Section -->
                            <div class="form-section">
                            <label class="form-label" for="productSearch">
                                <svg class="form-label-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                                </svg>
                                Product Search
                            </label>
                            <div class="product-search-container">
                                <input 
                                    type="text" 
                                    class="form-input product-search-input" 
                                    id="productSearch" 
                                    placeholder="Search for products..."
                                    autocomplete="off"
                                    required>
                                <div class="product-search-dropdown" id="productSearchDropdown">
                                    <div class="product-search-loading">
                                        <svg class="loading-spinner" width="20" height="20" viewBox="0 0 50 50">
                                            <circle cx="25" cy="25" r="20" fill="none" stroke="#0064FF" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.416" stroke-dashoffset="31.416">
                                                <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
                                                <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
                                            </circle>
                                        </svg>
                                        <span>Searching products...</span>
                                    </div>
                                    <div class="product-search-results" id="productSearchResults">
                                        <!-- Product results will be populated here -->
                                    </div>
                                    <div class="product-search-empty">
                                        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" opacity="0.5">
                                            <path d="M15.5,14H14.71L14.43,13.73C15.41,12.59 16,11.11 16,9.5A6.5,6.5 0 0,0 9.5,3A6.5,6.5 0 0,0 3,9.5A6.5,6.5 0 0,0 9.5,16C11.11,16 12.59,15.41 13.73,14.43L14,14.71V15.5L20,21.5L21.5,20L15.5,14M9.5,14C7,14 5,12 5,9.5C5,7 7,5 9.5,5C12,5 14,7 14,9.5C14,12 12,14 9.5,14Z"/>
                                        </svg>
                                        <p>No products found</p>
                                        <span>Try adjusting your search terms</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Selected Products Summary -->
                            <div class="selected-products-summary" id="selectedProductsSummary" style="display: none;">
                                <div class="selected-summary-header">
                                    <span class="selected-summary-title">Selected Products</span>
                                    <span class="selected-summary-count" id="selectedCount">0 items</span>
                                </div>
                                <div class="selected-summary-list" id="selectedSummaryList">
                                    <!-- Selected products will be shown here -->
                                </div>
                            </div>
                            
                            <!-- All Products List -->
                            <div class="all-products-section" id="allProductsSection">
                                <div class="products-list-header">
                                    <span class="products-list-title">All Products</span>
                                    <span class="products-list-count" id="productsCount">0 items</span>
                                </div>
                                <div class="all-products-list" id="allProductsList">
                                    <!-- Products will be listed here -->
                                </div>
                            </div>
                        </div>
                        </div>
                        
                        <!-- Step 2: Review & Summary -->
                        <div class="step-content" id="step2Content">
                            <div class="form-section">
                                <h3 class="section-title">Order Summary</h3>
                                <div class="order-summary" id="orderSummaryReview">
                                    <!-- Products will be listed here -->
                                </div>
                                
                                <!-- Summary with Discount -->
                                <div class="summary-section">
                                    <div class="summary-row">
                                        <span>Subtotal:</span>
                                        <span id="reviewSubtotal">0</span>
                                    </div>
                                    <div class="summary-row discount-row" onclick="window.newInvoiceModal.openDiscountModal()">
                                        <span>Discount:</span>
                                        <span id="reviewDiscount">0</span>
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-left: 8px;">
                                            <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                                        </svg>
                                    </div>
                                    <div class="summary-row total">
                                        <span>Total:</span>
                                        <span id="reviewTotal">0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 3: Payment Details -->
                        <div class="step-content" id="step3Content">
                        <!-- Additional Invoice Fields -->
                        <div class="form-section">
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label" for="customerSelect">
                                        <svg class="form-label-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                                        </svg>
                                        Customer
                                    </label>
                                    <select class="form-input" id="customerSelect" name="customer">
                                        <option value="">Select customer (optional)</option>
                                        <!-- Customer options will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="taxRateInput">
                                        <svg class="form-label-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M18.5,1.15C17.97,1.15 17.46,1.34 17.07,1.73L16,2.8L21.2,8L22.27,6.93C23.05,6.15 23.05,4.9 22.27,4.12L19.88,1.73C19.5,1.34 19,1.15 18.5,1.15M15.06,3.74L3,15.8V21H8.2L20.26,8.94L15.06,3.74M5,18.08L16.06,7.02L16.98,7.94L5.92,19H5V18.08Z"/>
                                        </svg>
                                        Tax Rate (%)
                                    </label>
                                    <input 
                                        type="number" 
                                        class="form-input" 
                                        id="taxRateInput" 
                                        name="taxRate"
                                        placeholder="0"
                                        step="0.01"
                                        min="0"
                                        max="100"
                                        value="0"
                                        onchange="window.newInvoiceModal.calculateSummary()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group" id="invoiceDiscountGroup" style="display: none;">
                                    <label class="form-label" for="invoiceDiscountInput">
                                        <svg class="form-label-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12.79,21L3,11.21V2H11.21L21,11.79L12.79,21M7,7A2,2 0 0,0 5,5A2,2 0 0,0 7,7M16.5,10.5L13.5,7.5L10.5,10.5L13.5,13.5L16.5,10.5Z"/>
                                        </svg>
                                        Invoice Discount
                                    </label>
                                    <input 
                                        type="number" 
                                        class="form-input" 
                                        id="invoiceDiscountInput" 
                                        name="invoiceDiscount"
                                        placeholder="0"
                                        step="0.01"
                                        min="0"
                                        onchange="window.newInvoiceModal.calculateSummary()">
                                </div>
                            </div>
                        </div>

                        <!-- Payment Methods Section -->
                        <div class="form-section">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                                <label class="form-label">
                                    <svg class="form-label-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z"/>
                                    </svg>
                                    Payment Methods <span style="color: var(--toss-error);">*</span>
                                </label>
                                <button type="button" class="btn-add-payment" onclick="console.log('=== Add Payment button clicked ===', new Date().toISOString()); event.stopPropagation(); if (window.newInvoiceModal) { console.log('newInvoiceModal exists, calling showAddPaymentModal...'); window.newInvoiceModal.showAddPaymentModal(); } else { console.error('window.newInvoiceModal not found!'); }"
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                                    </svg>
                                    Add Payment
                                </button>
                            </div>
                            
                            <!-- Payment Methods List -->
                            <div id="paymentMethodsList" class="payment-methods-list">
                                <div class="no-payments-message" id="noPaymentsMessage">
                                    <svg width="48" height="48" viewBox="0 0 24 24" fill="var(--toss-gray-400)">
                                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,17A1.5,1.5 0 0,1 10.5,15.5A1.5,1.5 0 0,1 12,14A1.5,1.5 0 0,1 13.5,15.5A1.5,1.5 0 0,1 12,17M12,10.5A1.5,1.5 0 0,1 10.5,9A1.5,1.5 0 0,1 12,7.5A1.5,1.5 0 0,1 13.5,9A1.5,1.5 0 0,1 12,10.5Z"/>
                                    </svg>
                                    <p>No payment methods added yet</p>
                                    <p style="font-size: 12px; color: var(--toss-gray-500);">Click "Add Payment" to add payment methods</p>
                                </div>
                            </div>
                        </div>

                        <!-- Currency and Amount Selection (for cash/vault locations) -->
                        <div class="form-section" id="currencyDenominationSection" style="display: none;">
                            <label class="form-label">
                                <svg class="form-label-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7,15H9C9,16.08 10.37,17 12,17C13.63,17 15,16.08 15,15C15,13.9 13.96,13.5 11.76,12.97C9.64,12.44 7,11.78 7,9C7,7.21 8.47,5.69 10.5,5.18V3H13.5V5.18C15.53,5.69 17,7.21 17,9H15C15,7.92 13.63,7 12,7C10.37,7 9,7.92 9,9C9,10.1 10.04,10.5 12.24,11.03C14.36,11.56 17,12.22 17,15C17,16.79 15.53,18.31 13.5,18.82V21H10.5V18.82C8.47,18.31 7,16.79 7,15Z"/>
                                </svg>
                                Amount Received
                            </label>
                            
                            <!-- Currency Selection -->
                            <div class="currency-selector" id="currencySelector" style="margin-bottom: 12px;">
                                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                    <!-- Currency buttons will be added here dynamically -->
                                </div>
                            </div>
                            
                            <!-- Amount Input for Selected Currency -->
                            <div class="currency-amount-input" id="currencyAmountSection">
                                <label class="form-label" for="currencyAmount">
                                    <span>Amount in </span>
                                    <span class="currency-amount-label" id="currencyAmountLabel">VND</span>
                                </label>
                                <div style="position: relative;">
                                    <input 
                                        type="text" 
                                        class="form-input" 
                                        id="currencyAmount" 
                                        placeholder="Enter amount received"
                                        oninput="window.newInvoiceModal.formatCurrencyInput(this)"
                                        onblur="window.newInvoiceModal.updateCurrencyAmount(this.value)">
                                    <div class="input-hint" style="font-size: 12px; color: var(--toss-gray-600); margin-top: 4px;">
                                        Enter the amount received from the customer
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Amount Received Section -->
                        <div class="form-section" id="amountReceivedSection" style="display: none;">
                            <label class="form-label" for="amountReceived">
                                <svg class="form-label-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7,15H9C9,16.08 10.37,17 12,17C13.63,17 15,16.08 15,15C15,13.9 13.96,13.5 11.76,12.97C9.64,12.44 7,11.78 7,9C7,7.21 8.47,5.69 10.5,5.18V3H13.5V5.18C15.53,5.69 17,7.21 17,9H15C15,7.92 13.63,7 12,7C10.37,7 9,7.92 9,9C9,10.1 10.04,10.5 12.24,11.03C14.36,11.56 17,12.22 17,15C17,16.79 15.53,18.31 13.5,18.82V21H10.5V18.82C8.47,18.31 7,16.79 7,15Z"/>
                                </svg>
                                Amount Received
                            </label>
                            <div class="form-input-container">
                                <input 
                                    type="text" 
                                    class="form-input amount-input" 
                                    id="amountReceived" 
                                    placeholder="0"
                                    oninput="window.newInvoiceModal.formatBankAmountInput(this)"
                                    onblur="window.newInvoiceModal.updateBankAmount(this.value)"
                                    required>
                            </div>
                            <div class="form-help-text">
                                Enter the amount received from the customer
                            </div>
                        </div>

                        <!-- Invoice Summary -->
                        <div class="invoice-summary" id="invoiceSummary" style="display: none;">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="subtotalAmount">0</span>
                            </div>
                            <div class="summary-row discount-row" id="discountRow" style="display: none;" onclick="window.newInvoiceModal.openDiscountModal()">
                                <span>Discount:</span>
                                <span id="discountAmount">0</span>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-left: 8px; opacity: 0.6;">
                                    <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                                </svg>
                            </div>
                            <div class="summary-row" style="display: none;">
                                <span>Tax:</span>
                                <span id="taxAmount">0</span>
                            </div>
                            <div class="summary-row total">
                                <span>Total:</span>
                                <span id="totalAmount">0</span>
                            </div>
                            <div class="summary-row" id="totalReceivedRow" style="display: none;">
                                <span>Total Received:</span>
                                <span id="totalReceivedAmount">0</span>
                            </div>
                            <div class="summary-row change" id="changeRow" style="display: none;">
                                <span>Change:</span>
                                <span id="changeAmount">0</span>
                            </div>
                        </div>
                        </div>
                    </form>
                    
                    <!-- Step Navigation -->
                    <div class="step-navigation" id="stepNavigation">
                        <button type="button" class="modal-btn secondary" id="prevStepBtn" style="display: none;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z"/>
                            </svg>
                            Back
                        </button>
                        <div class="btn-group">
                            <button type="button" class="modal-btn secondary" id="cancelBtn">Cancel</button>
                            <button type="button" class="modal-btn primary" id="nextStepBtn">
                                Next
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="modal-footer" style="display: none;">
                        <button type="button" class="modal-btn secondary" id="cancelInvoiceBtn">
                            Cancel
                        </button>
                        <button type="submit" class="modal-btn primary" id="createInvoiceBtn" form="newInvoiceForm" disabled>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9,10H7V12H9V10M13,10H11V12H13V10M17,10H15V12H17V10M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z"/>
                            </svg>
                            Create Invoice
                        </button>
                    </div>
                </div>
                
                <!-- Discount Modal Popup -->
                <div class="discount-modal" id="discountModal">
                    <div class="discount-modal-header">
                        <h3 class="discount-modal-title">Discount</h3>
                    </div>
                    <div class="discount-type-toggle">
                        <button type="button" class="discount-type-btn active" data-type="amount" onclick="window.newInvoiceModal.toggleDiscountType('amount')">
                            Amount
                        </button>
                        <button type="button" class="discount-type-btn" data-type="percent" onclick="window.newInvoiceModal.toggleDiscountType('percent')">
                            %
                        </button>
                    </div>
                    <div class="discount-input-group">
                        <input type="number" class="discount-input" id="discountValue" placeholder="0" min="0" step="0.01">
                    </div>
                    <div class="discount-modal-footer">
                        <button type="button" class="discount-modal-btn primary" onclick="window.newInvoiceModal.applyDiscount()">
                            Done
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Invoice Detail Modal -->
            <div class="modal-overlay" id="invoiceDetailModal" style="display: none;">
                <div class="modal-container" style="max-width: 800px;">
                    <div class="modal-header">
                        <h2 class="modal-title" id="invoiceDetailTitle">Invoice Details</h2>
                        <button class="modal-close-btn" onclick="invoiceManager.closeInvoiceDetail()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="modal-body" id="invoiceDetailBody" style="padding: 24px;">
                        <!-- Invoice details will be loaded here -->
                    </div>
                    <div class="modal-footer" style="padding: 16px 24px; border-top: 1px solid #e5e5e5;">
                        <button type="button" class="modal-btn secondary" onclick="invoiceManager.closeInvoiceDetail()">Close</button>
                        <button type="button" class="modal-btn primary" onclick="invoiceManager.refundInvoice(invoiceManager.currentInvoiceId)">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M18,11H10L13.5,7.5L12.08,6.08L6.16,12L12.08,17.92L13.5,16.5L10,13H18V11Z"/>
                            </svg>
                            Refund
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Store Filter Control -->
            <div class="controls-card">
                <div class="control-section" id="storeFilterControl">
                    <svg class="control-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75Z"/>
                    </svg>
                    <span class="control-label" id="storeFilterLabel">Loading...</span>
                    <svg class="control-dropdown" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                    </svg>
                    
                    <!-- Store Filter Dropdown -->
                    <div class="store-filter-dropdown" id="storeFilterDropdown">
                        <div id="storeFilterOptions">
                            <!-- Store filter options will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Date Filter Tabs -->
            <div class="date-filter-container">
                <div class="date-filter-tabs">
                    <div class="date-filter-tab active" data-filter="today">Today</div>
                    <div class="date-filter-tab" data-filter="yesterday">Yesterday</div>
                    <div class="date-filter-tab" data-filter="week">This Week</div>
                    <div class="date-filter-tab" data-filter="month">This Month</div>
                    <div class="date-filter-tab" data-filter="last-month">Last Month</div>
                    <div class="date-filter-tab custom" data-filter="custom" id="customRangeTab">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9,10H7V12H9V10M13,10H11V12H13V10M17,10H15V12H17V10M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z"/>
                        </svg>
                        Custom Range
                    </div>
                </div>
                
                <!-- Calendar Dropdown (moved outside of tabs) -->
                <div class="calendar-dropdown" id="calendarDropdown">
                    <div class="calendar-header">
                        <div class="calendar-title">Select Date Range</div>
                        <button class="calendar-close" id="calendarClose">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                            </svg>
                        </button>
                    </div>
                    
                    
                    <div class="calendar-content">
                        <!-- Single Calendar -->
                        <div class="calendar-side">
                            <div class="calendar-month-header">
                                <button class="calendar-nav-btn" id="prevMonth">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z"/>
                                    </svg>
                                </button>
                                <span class="calendar-month-title" id="monthTitle">December 2024</span>
                                <button class="calendar-nav-btn" id="nextMonth">
                                    <svg viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="calendar-grid" id="calendarGrid">
                                <!-- Calendar days will be generated here -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="calendar-footer">
                        <div class="calendar-range-display">
                            <span>Selected:</span>
                            <span class="calendar-range-dates" id="selectedRangeDisplay">No dates selected</span>
                        </div>
                        <div class="calendar-actions">
                            <button class="calendar-btn secondary" id="calendarClear">Clear</button>
                            <button class="calendar-btn primary" id="calendarApply" disabled>Apply</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search and Filter Bar -->
            <div class="search-filter-bar">
                <div class="search-filter-row">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                        </svg>
                        <input type="text" class="search-input" id="invoiceSearch" placeholder="Search by invoice number, customer, or amount...">
                    </div>
                </div>
            </div>
            
            <!-- Add Payment Method Modal -->
            <div class="modal-overlay" id="addPaymentModal" style="display: none; z-index: 10001; position: fixed; opacity: 1; visibility: visible;">
                <div class="modal-container" style="max-width: 600px;">
                    <div class="modal-header">
                        <h2 class="modal-title">Add Payment Method</h2>
                        <button class="modal-close-btn" onclick="window.newInvoiceModal.closeAddPaymentModal()">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="modal-content" style="padding: 24px;">
                        <!-- Payment Type Display (Auto-determined) -->
                        <div class="form-section" id="paymentTypeSection" style="display: none;">
                            <label class="form-label">Payment Type</label>
                            <div id="paymentTypeDisplay" class="payment-type-display">
                                <!-- Payment type will be shown here based on selected cash location -->
                            </div>
                        </div>
                        
                        <!-- Cash Location Selection -->
                        <div class="form-section" id="cashLocationSection">
                            <label class="form-label">Cash Location</label>
                            <div class="toss-select-container">
                                <button type="button" class="toss-select" id="addPaymentCashLocationSelect" onclick="window.newInvoiceModal.openAddPaymentCashLocationSearch()">
                                    <span class="toss-select-value toss-select-placeholder">Select cash location...</span>
                                    <svg class="toss-select-arrow" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M7,10L12,15L17,10H7Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Bank Details -->
                        <div class="form-section" id="bankDetailsSection" style="display: none;">
                            <label class="form-label">Bank Transfer</label>
                            <p style="color: var(--toss-gray-600); font-size: 14px; margin: 0;">
                                Direct bank transfer payment
                            </p>
                        </div>
                        
                        <!-- Currency Amounts -->
                        <div class="form-section" id="currencyAmountsSection" style="display: none;">
                            <label class="form-label">Currency Amounts</label>
                            <div id="addPaymentCurrencies" class="add-payment-currencies">
                                <!-- Currency buttons will be added here -->
                            </div>
                            
                            <!-- Total Display -->
                            <div id="currencyTotalDisplay" class="currency-total-display" style="display: none;">
                                <div class="currency-total-label">Total in Base Currency</div>
                                <div class="currency-total-amount" id="currencyTotalAmount">₫0</div>
                            </div>
                            
                            <div class="add-payment-amount-input" id="addPaymentAmountSection" style="display: none;">
                                <label class="form-label">
                                    Amount in <span id="addPaymentCurrencyLabel">VND</span>
                                </label>
                                <input 
                                    type="text" 
                                    class="form-input" 
                                    id="addPaymentAmount" 
                                    placeholder="Enter amount"
                                    oninput="window.newInvoiceModal.formatAddPaymentAmount(this); window.newInvoiceModal.updateAddPaymentCurrencyTotal()">
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button class="modal-btn secondary" onclick="window.newInvoiceModal.closeAddPaymentModal()">Cancel</button>
                        <button class="modal-btn primary" id="addPaymentBtn" onclick="console.log('=== ADD PAYMENT BUTTON CLICKED ==='); window.newInvoiceModal.savePaymentMethod()" disabled>Add Payment</button>
                    </div>
                </div>
            </div>
            
            <!-- Invoice Content Container -->
            <div id="invoiceContent">
                <!-- Dynamic content will be loaded here -->
            </div>
        </main>
    </div>
    
    <!-- Component JavaScript -->
    <script src="../../../components/form/toss-select.js"></script>
    <script src="../../../components/navigation/navbar.js"></script>
    <script src="../../../components/feedback/toss-alert.js"></script>
    
    <!-- Core Scripts -->
    <script src="../../../core/constants/app-icons.js"></script>
    <script src="../../../core/config/supabase.js"></script>
    
    <!-- App State Management -->
    <script src="../../../core/utils/app-state.js"></script>
    
    <!-- Route Mapping -->
    <script src="../../../core/config/route-mapping.js"></script>
    
    <!-- Page Initialization Utility -->
    <script src="../../../core/utils/page-init.js"></script>
    
    <script>
        // Set flag immediately to prevent navbar auto-init
        window.skipNavbarAutoInit = true;
        
        // Global currency information
        let currentCurrencyInfo = null;
        let companyCurrencies = [];
        
        // Global cash locations data
        let cashLocationsData = [];
        
        // Function to get currency info for selected company
        async function getCurrencyInfo(companyId) {
            try {
                console.log('Getting currency info for company:', companyId);
                
                // Check if Supabase client is initialized
                if (!window.supabaseClient) {
                    console.error('Supabase client not initialized');
                    currentCurrencyInfo = { symbol: '$', currency_code: 'USD' };
                    return null;
                }
                
                const { data, error } = await window.supabaseClient.rpc('get_base_currency', {
                    p_company_id: companyId
                });
                
                if (error) {
                    console.error('Error getting currency info:', error);
                    // Set default currency on error
                    currentCurrencyInfo = { symbol: '$', currency_code: 'USD' };
                    return null;
                }
                
                console.log('Raw currency RPC response:', data);
                
                // Handle new response structure with base_currency and company_currencies
                if (data) {
                    if (data.base_currency) {
                        // New response structure
                        currentCurrencyInfo = data.base_currency;
                        companyCurrencies = data.company_currencies || [];
                        console.log('Processed base currency:', currentCurrencyInfo);
                        console.log('Company currencies:', companyCurrencies);
                        return currentCurrencyInfo;
                    } else if (Array.isArray(data) || data.symbol) {
                        // Old response structure (backward compatibility)
                        const currencyData = Array.isArray(data) ? data[0] : data;
                        
                        if (currencyData && typeof currencyData === 'object') {
                            if (!currencyData.symbol) {
                                console.warn('Currency symbol not found in response, using default');
                                currencyData.symbol = currencyData.currency_code === 'VND' ? '₫' : '$';
                            }
                            
                            currentCurrencyInfo = currencyData;
                            companyCurrencies = [];
                            console.log('Processed currency info (old format):', currentCurrencyInfo);
                            return currentCurrencyInfo;
                        }
                    }
                }
                
                // Fallback to default if data is invalid
                console.warn('Invalid currency data structure, using default');
                currentCurrencyInfo = { symbol: '$', currency_code: 'USD' };
                companyCurrencies = [];
                return currentCurrencyInfo;
            } catch (err) {
                console.error('Exception getting currency info:', err);
                // Set default currency on exception
                currentCurrencyInfo = { symbol: '$', currency_code: 'USD' };
                return null;
            }
        }
        
        // Function to get cash locations for selected company
        async function getCashLocations(companyId) {
            try {
                console.log('Getting cash locations for company:', companyId);
                
                // Check if Supabase client is initialized
                if (!window.supabaseClient) {
                    console.log('Supabase client not yet initialized, will retry later');
                    cashLocationsData = [];
                    return [];
                }
                
                const { data, error } = await window.supabaseClient.rpc('get_cash_locations', {
                    p_company_id: companyId
                });
                
                if (error) {
                    console.error('Error getting cash locations:', error);
                    cashLocationsData = [];
                    return [];
                }
                
                console.log('Cash locations RPC response:', data);
                
                // Store the data globally
                cashLocationsData = data || [];
                return cashLocationsData;
            } catch (err) {
                console.error('Exception getting cash locations:', err);
                cashLocationsData = [];
                return [];
            }
        }
        
        // Store filter management
        class InvoiceManager {
            constructor() {
                this.currentStoreFilter = null;
                this.dropdownOpen = false;
                this.currentFocusIndex = -1;
                this.stores = [];
                this.currentPage = 1;
                this.itemsPerPage = 10;
                this.currentSearch = '';
                this.currentStartDate = null;
                this.currentEndDate = null;
                this.invoiceData = null;
                this.isLoading = false;
            }
            
            init() {
                // Set up store filter control
                const storeFilterControl = document.getElementById('storeFilterControl');
                if (storeFilterControl) {
                    storeFilterControl.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.toggleStoreFilterDropdown();
                    });
                }
                
                // Close dropdown when clicking outside (but not from add payment modal)
                document.addEventListener('click', (e) => {
                    // Don't close if click came from add payment modal
                    const fromAddPaymentModal = e.composedPath().some(el => el.id === 'addPaymentModal');
                    if (!fromAddPaymentModal) {
                        this.closeStoreFilterDropdown();
                    }
                });
                
                // Search functionality
                const searchInput = document.getElementById('searchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        this.handleSearch(e.target.value);
                    });
                }
            }
            
            toggleStoreFilterDropdown() {
                const dropdown = document.getElementById('storeFilterDropdown');
                if (dropdown.classList.contains('active')) {
                    this.closeStoreFilterDropdown();
                } else {
                    dropdown.classList.add('active');
                    this.dropdownOpen = true;
                }
            }
            
            closeStoreFilterDropdown() {
                const dropdown = document.getElementById('storeFilterDropdown');
                dropdown.classList.remove('active');
                this.dropdownOpen = false;
                this.currentFocusIndex = -1;
            }
            
            handleSearch(searchTerm) {
                this.currentSearch = searchTerm;
                this.currentPage = 1;
                this.loadInvoicesForStore(this.currentStoreFilter);
            }
            
            async loadInvoicesForStore(storeId) {
                // Implementation for loading invoices
                console.log('Loading invoices for store:', storeId);
            }
            
            renderPagination(pagination) {
                // Implementation for rendering pagination
                return '';
            }
            
            initSearchHandler() {
                const searchInput = document.getElementById('invoiceSearch');
                if (searchInput) {
                    // Debounce search input
                    let searchTimeout;
                    searchInput.addEventListener('input', (e) => {
                        clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(() => {
                            this.currentSearch = e.target.value.trim();
                            this.currentPage = 1; // Reset to first page
                            this.loadInvoicesForStore(this.currentStoreFilter);
                        }, 500); // 500ms debounce
                    });
                }
            }
            
            initDateFilters() {
                // Set up date filter tabs
                document.querySelectorAll('.date-filter-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        if (tab.dataset.filter === 'custom') {
                            // Custom range handling is done by CalendarManager
                            return;
                        }
                        
                        // Remove active from all tabs
                        document.querySelectorAll('.date-filter-tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        
                        // Add active to clicked tab
                        tab.classList.add('active');
                        
                        // Set date range based on filter
                        this.setDateFilter(tab.dataset.filter);
                        
                        // Reset to first page and load data
                        this.currentPage = 1;
                        this.loadInvoicesForStore(this.currentStoreFilter);
                    });
                });
                
                // Initialize the default active filter (Today)
                const activeTab = document.querySelector('.date-filter-tab.active');
                if (activeTab && activeTab.dataset.filter) {
                    console.log('Initializing default date filter:', activeTab.dataset.filter);
                    this.setDateFilter(activeTab.dataset.filter);
                }
            }
            
            setDateFilter(filter) {
                console.log('=== setDateFilter called with:', filter);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                console.log('Today date object:', today);
                console.log('Today ISO string:', today.toISOString());
                
                switch(filter) {
                    case 'today':
                        this.currentStartDate = today.toISOString().split('T')[0];
                        this.currentEndDate = today.toISOString().split('T')[0];
                        console.log('Set today filter - start:', this.currentStartDate, 'end:', this.currentEndDate);
                        break;
                    case 'yesterday':
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        this.currentStartDate = yesterday.toISOString().split('T')[0];
                        this.currentEndDate = yesterday.toISOString().split('T')[0];
                        break;
                    case 'week':
                        const weekStart = new Date(today);
                        weekStart.setDate(today.getDate() - today.getDay());
                        const weekEnd = new Date(weekStart);
                        weekEnd.setDate(weekStart.getDate() + 6);
                        this.currentStartDate = weekStart.toISOString().split('T')[0];
                        this.currentEndDate = weekEnd.toISOString().split('T')[0];
                        console.log('Set week filter - start:', this.currentStartDate, 'end:', this.currentEndDate);
                        break;
                    case 'month':
                        const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                        const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                        this.currentStartDate = monthStart.toISOString().split('T')[0];
                        this.currentEndDate = monthEnd.toISOString().split('T')[0];
                        console.log('Set month filter - start:', this.currentStartDate, 'end:', this.currentEndDate);
                        break;
                    case 'last-month':
                        const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                        this.currentStartDate = lastMonthStart.toISOString().split('T')[0];
                        this.currentEndDate = lastMonthEnd.toISOString().split('T')[0];
                        console.log('Set last-month filter - start:', this.currentStartDate, 'end:', this.currentEndDate);
                        break;
                    case 'all':
                    case null:
                    case undefined:
                        this.currentStartDate = null;
                        this.currentEndDate = null;
                        console.log('Set all filter - no date restrictions');
                        break;
                    default:
                        console.warn('Unknown date filter:', filter);
                        this.currentStartDate = null;
                        this.currentEndDate = null;
                        break;
                }
            }
            
            toggleStoreFilterDropdown() {
                const dropdown = document.getElementById('storeFilterDropdown');
                const isActive = dropdown.classList.contains('active');
                
                if (isActive) {
                    this.hideStoreFilterDropdown();
                } else {
                    this.showStoreFilterDropdown();
                }
            }
            
            handleDropdownKeyboard(e) {
                if (!this.dropdownOpen && (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown')) {
                    e.preventDefault();
                    this.showStoreFilterDropdown();
                    return;
                }
                
                if (!this.dropdownOpen) return;
                
                const options = document.querySelectorAll('.store-filter-dropdown-option');
                const maxIndex = options.length - 1;
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.currentFocusIndex = Math.min(this.currentFocusIndex + 1, maxIndex);
                        this.updateFocusedOption();
                        break;
                        
                    case 'ArrowUp':
                        e.preventDefault();
                        this.currentFocusIndex = Math.max(this.currentFocusIndex - 1, 0);
                        this.updateFocusedOption();
                        break;
                        
                    case 'Enter':
                        e.preventDefault();
                        if (this.currentFocusIndex >= 0) {
                            const focusedOption = options[this.currentFocusIndex];
                            if (focusedOption) {
                                focusedOption.click();
                            }
                        }
                        break;
                        
                    case 'Tab':
                        // Allow tab to close dropdown and move to next element
                        this.hideStoreFilterDropdown();
                        break;
                }
            }
            
            updateFocusedOption() {
                const options = document.querySelectorAll('.store-filter-dropdown-option');
                options.forEach((option, index) => {
                    if (index === this.currentFocusIndex) {
                        option.classList.add('focused');
                        option.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    } else {
                        option.classList.remove('focused');
                    }
                });
            }
            
            showStoreFilterDropdown() {
                const storeFilterDropdown = document.getElementById('storeFilterDropdown');
                const storeFilterControl = document.getElementById('storeFilterControl');
                const storeFilterOptions = document.getElementById('storeFilterOptions');
                
                // Get stores from appState
                if (typeof appState !== 'undefined' && typeof appState.getCompanyStores === 'function') {
                    this.stores = appState.getCompanyStores();
                } else {
                    // Fallback to empty array if appState not available
                    this.stores = [];
                }
                
                // Build dropdown HTML
                let optionsHTML = '';
                
                // Add search field if there are many stores
                if (this.stores.length > 5) {
                    optionsHTML += `
                        <input type="text" 
                            class="store-filter-search" 
                            id="storeFilterSearch" 
                            placeholder="Search stores..."
                            autocomplete="off">
                    `;
                }
                
                // Removed "All Stores" option - first store will be default
                
                // Add individual store options
                this.stores.forEach((store, index) => {
                    // If no store is selected yet, select the first one
                    const isSelected = this.currentStoreFilter ? 
                        store.store_id === this.currentStoreFilter : 
                        index === 0;
                    optionsHTML += `
                        <div class="store-filter-dropdown-option${isSelected ? ' selected' : ''}" data-store-filter="${store.store_id}">
                            <svg class="store-filter-dropdown-option-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75Z"/>
                            </svg>
                            <span class="store-filter-dropdown-option-text">${store.store_name}</span>
                            ${isSelected ? '<svg class="store-filter-dropdown-option-check" fill="currentColor" viewBox="0 0 24 24"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg>' : ''}
                        </div>
                    `;
                });
                
                storeFilterOptions.innerHTML = optionsHTML;
                
                // Add search functionality if search input exists
                const searchInput = document.getElementById('storeFilterSearch');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const options = storeFilterOptions.querySelectorAll('.store-filter-dropdown-option');
                        
                        options.forEach(option => {
                            const textElement = option.querySelector('.store-filter-dropdown-option-text');
                            if (textElement) {
                                const text = textElement.textContent.toLowerCase();
                                if (text.includes(searchTerm) || searchTerm === '') {
                                    option.style.display = 'flex';
                                } else {
                                    option.style.display = 'none';
                                }
                            }
                        });
                    });
                    
                    // Focus search input when dropdown opens
                    setTimeout(() => searchInput.focus(), 100);
                }
                
                // Add click listeners
                storeFilterOptions.querySelectorAll('.store-filter-dropdown-option').forEach((option, index) => {
                    option.addEventListener('click', async () => {
                        const storeFilter = option.dataset.storeFilter;
                        this.currentStoreFilter = storeFilter;
                        
                        // Update label
                        const labelElement = document.getElementById('storeFilterLabel');
                        const store = this.stores.find(s => s.store_id === storeFilter);
                        labelElement.textContent = store ? store.store_name : 'Unknown Store';
                        
                        // Load invoices for selected store
                        await this.loadInvoicesForStore(this.currentStoreFilter);
                        
                        this.hideStoreFilterDropdown();
                    });
                    
                    // Add hover effect for keyboard navigation
                    option.addEventListener('mouseenter', () => {
                        this.currentFocusIndex = index;
                        this.updateFocusedOption();
                    });
                });
                
                storeFilterDropdown.classList.add('active');
                storeFilterControl.classList.add('dropdown-open');
                this.dropdownOpen = true;
                this.currentFocusIndex = -1;
                
                // Set initial focus based on current selection
                const options = storeFilterOptions.querySelectorAll('.store-filter-dropdown-option');
                options.forEach((option, index) => {
                    if (option.classList.contains('selected')) {
                        this.currentFocusIndex = index;
                        this.updateFocusedOption();
                    }
                });
            }
            
            hideStoreFilterDropdown() {
                const storeFilterDropdown = document.getElementById('storeFilterDropdown');
                const storeFilterControl = document.getElementById('storeFilterControl');
                storeFilterDropdown.classList.remove('active');
                storeFilterControl.classList.remove('dropdown-open');
                this.dropdownOpen = false;
                this.currentFocusIndex = -1;
                
                // Clear all focused states
                const options = document.querySelectorAll('.store-filter-dropdown-option');
                options.forEach(option => option.classList.remove('focused'));
            }
            
            async loadInvoicesForStore(storeId, page = 1) {
                const companyId = appState.getSelectedCompanyId();
                const invoiceContent = document.getElementById('invoiceContent');
                
                if (!companyId) {
                    console.warn('No company selected');
                    return;
                }
                
                this.currentStoreFilter = storeId;
                this.currentPage = page;
                this.isLoading = true;
                
                // Show loading state
                this.showLoadingState();
                
                try {
                    // Check if Supabase client is initialized
                    if (!window.supabaseClient) {
                        throw new Error('Supabase client not initialized. Please refresh the page.');
                    }
                    
                    const params = {
                        p_company_id: companyId,
                        p_store_id: storeId,
                        p_page: this.currentPage,
                        p_limit: this.itemsPerPage,
                        p_search: this.currentSearch || null,
                        p_start_date: this.currentStartDate,
                        p_end_date: this.currentEndDate
                    };
                    
                    console.log('Loading invoices with params:', params);
                    
                    const { data, error } = await window.supabaseClient.rpc('get_invoice_page', params);
                    
                    console.log('=== get_invoice_page RPC Response ===');
                    console.log('Error:', error);
                    console.log('Data:', data);
                    console.log('Data type:', typeof data);
                    console.log('Data success:', data?.success);
                    console.log('Data.data:', data?.data);
                    console.log('Data.data.invoices:', data?.data?.invoices);
                    console.log('=== End RPC Response ===');
                    
                    if (error) {
                        console.error('RPC Error:', error);
                        throw new Error(error.message || 'Failed to load invoices');
                    }
                    
                    // Handle response structure based on RPC documentation
                    if (data && data.success && data.data) {
                        this.invoiceData = data.data;
                        console.log('Using data.data as invoiceData:', this.invoiceData);
                    } else if (data && data.invoices) {
                        // Fallback: direct data structure
                        this.invoiceData = data;
                        console.log('Using data directly as invoiceData:', this.invoiceData);
                    } else {
                        console.error('Unexpected response structure:', data);
                        throw new Error('Invalid response structure from get_invoice_page');
                    }
                    
                    this.renderInvoiceTable();
                } catch (error) {
                    console.error('Error loading invoices:', error);
                    this.showErrorState(error.message);
                } finally {
                    this.isLoading = false;
                }
            }
            
            showLoadingState() {
                const invoiceContent = document.getElementById('invoiceContent');
                invoiceContent.innerHTML = `
                    <div class="invoice-loading-state">
                        <div class="loading-spinner">
                            <svg width="40" height="40" viewBox="0 0 50 50">
                                <circle cx="25" cy="25" r="20" fill="none" stroke="#0064FF" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.416" stroke-dashoffset="31.416">
                                    <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
                                    <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                        </div>
                        <p>Loading invoices...</p>
                    </div>
                `;
            }
            
            showErrorState(message) {
                const invoiceContent = document.getElementById('invoiceContent');
                invoiceContent.innerHTML = `
                    <div class="invoice-error-state">
                        <div class="error-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="color: #dc3545;">
                                <path d="M12,2L13.09,8.26L22,9L13.09,9.74L12,16L10.91,9.74L2,9L10.91,8.26L12,2Z"/>
                            </svg>
                        </div>
                        <h3>Error Loading Invoices</h3>
                        <p>${message}</p>
                        <button class="retry-btn" onclick="invoiceManager.loadInvoicesForStore(invoiceManager.currentStoreFilter)">
                            Retry
                        </button>
                    </div>
                `;
            }
            
            renderInvoiceTable() {
                const invoiceContent = document.getElementById('invoiceContent');
                
                if (!this.invoiceData || !this.invoiceData.invoices || this.invoiceData.invoices.length === 0) {
                    this.showEmptyState();
                    return;
                }
                
                const { invoices, pagination, currency } = this.invoiceData;
                
                let tableHTML = `
                    <div class="invoice-table-container">
                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Items</th>
                                    <th>Payment</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                invoices.forEach(invoice => {
                    const saleDate = new Date(invoice.sale_date).toLocaleDateString('ko-KR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                    
                    const customerDisplay = invoice.customer 
                        ? `<div class="customer-name">${invoice.customer.name}</div>
                           <div class="customer-phone">${invoice.customer.phone}</div>`
                        : `<div class="customer-name">Walk-in</div>`;
                    
                    const statusBadge = this.getStatusBadge(invoice.status);
                    const paymentBadge = this.getPaymentBadge(invoice.payment.method, invoice.payment.status);
                    
                    const totalAmount = this.formatCurrency(invoice.amounts.total_amount, currency);
                    
                    tableHTML += `
                        <tr class="invoice-row" onclick="invoiceManager.viewInvoiceDetail('${invoice.invoice_id}', event)" style="cursor: pointer;">
                            <td class="invoice-number">
                                <div class="invoice-number-main">${invoice.invoice_number}</div>
                            </td>
                            <td class="invoice-date">${saleDate}</td>
                            <td class="invoice-customer">${customerDisplay}</td>
                            <td class="invoice-items">
                                <div class="item-count">${invoice.items_summary.item_count} items</div>
                                <div class="total-qty">Qty: ${invoice.items_summary.total_quantity}</div>
                            </td>
                            <td class="invoice-payment">${paymentBadge}</td>
                            <td class="invoice-total">${totalAmount}</td>
                            <td class="invoice-status">${statusBadge}</td>
                            <td class="invoice-actions">
                                <div class="invoice-row-actions">
                                    <button class="invoice-action-btn" onclick="event.stopPropagation(); invoiceManager.viewInvoice('${invoice.invoice_id}', event)" title="View">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/>
                                        </svg>
                                    </button>
                                    <button class="invoice-action-btn" onclick="event.stopPropagation(); invoiceManager.editInvoice('${invoice.invoice_id}')" title="Edit">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
                                        </svg>
                                    </button>
                                    <button class="invoice-action-btn" onclick="event.stopPropagation(); invoiceManager.printInvoice('${invoice.invoice_id}')" title="Print">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M18,3H6V7H18M19,12A1,1 0 0,1 18,11A1,1 0 0,1 19,10A1,1 0 0,1 20,11A1,1 0 0,1 19,12M16,19H8V14H16M19,8H5A3,3 0 0,0 2,11V17H6V21H18V17H22V11A3,3 0 0,0 19,8Z"/>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // Add pagination
                tableHTML += this.renderPagination(pagination);
                
                invoiceContent.innerHTML = tableHTML;
            }
            
            showEmptyState() {
                const invoiceContent = document.getElementById('invoiceContent');
                const store = this.stores.find(s => s.store_id === this.currentStoreFilter);
                const storeName = store ? store.store_name : 'Selected Store';
                
                invoiceContent.innerHTML = `
                    <div class="invoice-empty-state">
                        <div class="empty-icon">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor" style="color: #9ca3af;">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                        </div>
                        <h3>No Invoices Found</h3>
                        <p>No invoices found for ${storeName}${this.currentSearch ? ` matching "${this.currentSearch}"` : ''}.</p>
                        ${this.currentSearch || this.currentStartDate || this.currentEndDate ? 
                            `<button class="clear-filters-btn" onclick="invoiceManager.clearFilters()">Clear Filters</button>` : 
                            `<button class="create-invoice-btn" onclick="invoiceManager.createNewInvoice()">Create First Invoice</button>`
                        }
                    </div>
                `;
            }
            
            getStatusBadge(status) {
                const statusConfig = {
                    'completed': { class: 'status-completed', text: 'Completed' },
                    'draft': { class: 'status-draft', text: 'Draft' },
                    'cancelled': { class: 'status-cancelled', text: 'Cancelled' },
                    'pending': { class: 'status-pending', text: 'Pending' }
                };
                
                const config = statusConfig[status] || { class: 'status-unknown', text: status };
                return `<span class="status-badge ${config.class}">${config.text}</span>`;
            }
            
            getPaymentBadge(method, status) {
                const methodText = {
                    'cash': 'Cash',
                    'card': 'Card', 
                    'transfer': 'Bank',
                    'bank': 'Bank'
                }[method] || method;
                
                const statusClass = status === 'paid' ? 'payment-paid' : 'payment-pending';
                return `<span class="payment-badge ${statusClass}">${methodText}</span>`;
            }
            
            formatCurrency(amount, currency) {
                // For zero values, return with currency symbol if available
                if (amount === 0) {
                    const symbol = currentCurrencyInfo?.symbol || '';
                    return symbol ? `${symbol}0` : '0';
                }
                
                // For non-zero values, format with currency symbol
                const formatted = new Intl.NumberFormat('ko-KR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: amount % 1 === 0 ? 0 : 2
                }).format(amount);
                
                const symbol = currentCurrencyInfo?.symbol || '';
                return symbol ? `${symbol}${formatted}` : formatted;
            }
            
            renderPagination(pagination) {
                if (!pagination || pagination.total_pages <= 1) {
                    return '';
                }
                
                let paginationHTML = `
                    <div class="pagination-container">
                        <div class="pagination-info">
                            Showing ${((pagination.page - 1) * pagination.limit) + 1}-${Math.min(pagination.page * pagination.limit, pagination.total)} of ${pagination.total} invoices
                        </div>
                        <div class="pagination-controls">
                `;
                
                // Previous button
                if (pagination.has_prev) {
                    paginationHTML += `
                        <button class="pagination-btn" onclick="invoiceManager.loadInvoicesForStore(invoiceManager.currentStoreFilter, ${pagination.page - 1})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z"/>
                            </svg>
                        </button>
                    `;
                } else {
                    paginationHTML += `<button class="pagination-btn" disabled><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z"/></svg></button>`;
                }
                
                // Page numbers
                const startPage = Math.max(1, pagination.page - 2);
                const endPage = Math.min(pagination.total_pages, pagination.page + 2);
                
                if (startPage > 1) {
                    paginationHTML += `<button class="pagination-btn" onclick="invoiceManager.loadInvoicesForStore(invoiceManager.currentStoreFilter, 1)">1</button>`;
                    if (startPage > 2) {
                        paginationHTML += `<span class="pagination-ellipsis">...</span>`;
                    }
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const activeClass = i === pagination.page ? 'active' : '';
                    paginationHTML += `<button class="pagination-btn ${activeClass}" onclick="invoiceManager.loadInvoicesForStore(invoiceManager.currentStoreFilter, ${i})">${i}</button>`;
                }
                
                if (endPage < pagination.total_pages) {
                    if (endPage < pagination.total_pages - 1) {
                        paginationHTML += `<span class="pagination-ellipsis">...</span>`;
                    }
                    paginationHTML += `<button class="pagination-btn" onclick="invoiceManager.loadInvoicesForStore(invoiceManager.currentStoreFilter, ${pagination.total_pages})">${pagination.total_pages}</button>`;
                }
                
                // Next button
                if (pagination.has_next) {
                    paginationHTML += `
                        <button class="pagination-btn" onclick="invoiceManager.loadInvoicesForStore(invoiceManager.currentStoreFilter, ${pagination.page + 1})">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                            </svg>
                        </button>
                    `;
                } else {
                    paginationHTML += `<button class="pagination-btn" disabled><svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/></svg></button>`;
                }
                
                paginationHTML += `
                        </div>
                    </div>
                `;
                
                return paginationHTML;
            }
            
            // Invoice detail methods
            async viewInvoiceDetail(invoiceId, event) {
                // Prevent event bubbling if called from click event
                if (event) {
                    event.stopPropagation();
                    event.preventDefault();
                }
                
                // Prevent multiple rapid calls
                if (this.isLoadingInvoice) {
                    console.log('Invoice already loading, skipping duplicate call');
                    return;
                }
                this.isLoadingInvoice = true;
                
                console.log('Viewing invoice detail:', invoiceId);
                this.currentInvoiceId = invoiceId;
                
                // Show the modal
                const modal = document.getElementById('invoiceDetailModal');
                const modalBody = document.getElementById('invoiceDetailBody');
                const modalTitle = document.getElementById('invoiceDetailTitle');
                
                if (!modal || !modalBody) {
                    console.error('Invoice detail modal not found');
                    this.isLoadingInvoice = false;
                    return;
                }
                
                // Remove any existing animation classes
                modal.classList.remove('fade-in', 'fade-out');
                
                // Add active class and force visibility with setAttribute
                modal.classList.add('active');
                modal.setAttribute('style', `
                    display: flex !important;
                    opacity: 1 !important;
                    visibility: visible !important;
                    z-index: 99999 !important;
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100% !important;
                    height: 100% !important;
                    background-color: rgba(0, 0, 0, 0.6) !important;
                    align-items: center !important;
                    justify-content: center !important;
                    animation: none !important;
                    transition: none !important;
                `);
                
                // Also ensure the modal container is visible
                const modalContainer = modal.querySelector('.modal-container');
                if (modalContainer) {
                    modalContainer.setAttribute('style', `
                        opacity: 1 !important;
                        transform: translateY(0) !important;
                        background-color: white !important;
                        border-radius: 8px !important;
                        max-height: 90vh !important;
                        overflow: auto !important;
                        position: relative !important;
                        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
                        animation: none !important;
                        transition: none !important;
                    `);
                }
                
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <div class="loading-spinner">
                            <svg width="40" height="40" viewBox="0 0 50 50">
                                <circle cx="25" cy="25" r="20" fill="none" stroke="#0064FF" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.416" stroke-dashoffset="31.416">
                                    <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
                                    <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                        </div>
                        <p style="margin-top: 16px; color: #666;">Loading invoice details...</p>
                    </div>
                `;
                
                try {
                    // Call RPC to get invoice details
                    const { data, error } = await window.supabaseClient.rpc('get_invoice_detail', {
                        p_invoice_id: invoiceId
                    });
                    
                    console.log('Invoice detail response:', data);
                    
                    if (error) {
                        throw new Error(error.message || 'Failed to load invoice details');
                    }
                    
                    // Make sure modal is still visible before displaying
                    modal.classList.add('active');
                    modal.style.display = 'flex';
                    modal.style.opacity = '1';
                    modal.style.visibility = 'visible';
                    
                    // Display the invoice details
                    this.displayInvoiceDetail(data);
                    
                    // Reset loading flag after successful load
                    this.isLoadingInvoice = false;
                    
                } catch (error) {
                    console.error('Error loading invoice details:', error);
                    modalBody.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="#dc2626">
                                <path d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z"/>
                            </svg>
                            <p style="margin-top: 16px; color: #dc2626; font-weight: 500;">Failed to load invoice details</p>
                            <p style="margin-top: 8px; color: #666;">${error.message}</p>
                        </div>
                    `;
                    
                    // Reset loading flag after error
                    this.isLoadingInvoice = false;
                }
            }
            
            displayInvoiceDetail(response) {
                const modalBody = document.getElementById('invoiceDetailBody');
                const modalTitle = document.getElementById('invoiceDetailTitle');
                
                console.log('displayInvoiceDetail called with:', response);
                
                if (!response || !response.success || !response.data) {
                    console.error('Invalid response structure:', response);
                    modalBody.innerHTML = '<p style="text-align: center; padding: 40px;">No invoice data available</p>';
                    return;
                }
                
                const { invoice, amounts, items, payment, inventory_movements, currency } = response.data;
                
                console.log('Extracted data:', { invoice, amounts, items, payment, inventory_movements, currency });
                
                // Validate required data
                if (!invoice || !amounts || !items) {
                    console.error('Missing required invoice data');
                    modalBody.innerHTML = '<p style="text-align: center; padding: 40px; color: #dc2626;">Invalid invoice data structure</p>';
                    return;
                }
                
                // Get currency symbol from multiple sources in priority order
                let currencySymbol = '$'; // Default fallback
                
                // 1. Try from RPC response
                if (currency && currency.symbol) {
                    currencySymbol = currency.symbol;
                } else if (response.currency && response.currency.symbol) {
                    currencySymbol = response.currency.symbol;
                } 
                // 2. Try from global currentCurrencyInfo (base currency)
                else if (typeof currentCurrencyInfo !== 'undefined' && currentCurrencyInfo && currentCurrencyInfo.symbol) {
                    currencySymbol = currentCurrencyInfo.symbol;
                } 
                // 3. Try from stored company data
                else {
                    const companyData = localStorage.getItem('companyChoosen');
                    if (companyData) {
                        try {
                            const company = JSON.parse(companyData);
                            if (company.currency_symbol) {
                                currencySymbol = company.currency_symbol;
                            }
                        } catch (e) {
                            console.warn('Could not parse company data for currency');
                        }
                    }
                }
                
                console.log('Using currency symbol:', currencySymbol, 'from currentCurrencyInfo:', currentCurrencyInfo);
                
                // Local formatNumber function for this method
                const formatNumber = (num) => {
                    return new Intl.NumberFormat('en-US').format(num || 0);
                };
                
                modalTitle.textContent = `Invoice ${invoice.invoice_number || 'Unknown'}`;
                
                // Format date
                const formatDate = (dateStr) => {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'short', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                };
                
                // Get status badge
                const getStatusBadge = (status) => {
                    const statusMap = {
                        'completed': { label: 'Completed', color: '#22c55e' },
                        'pending': { label: 'Pending', color: '#f59e0b' },
                        'cancelled': { label: 'Cancelled', color: '#ef4444' },
                        'draft': { label: 'Draft', color: '#6b7280' }
                    };
                    const config = statusMap[status] || statusMap['pending'];
                    return `<span style="padding: 4px 12px; background: ${config.color}20; color: ${config.color}; border-radius: 4px; font-weight: 500;">${config.label}</span>`;
                };
                
                // Get payment method badge
                const getPaymentBadge = (method) => {
                    const methodMap = {
                        'cash': { label: 'Cash', color: '#22c55e' },
                        'card': { label: 'Card', color: '#3b82f6' },
                        'bank': { label: 'Bank Transfer', color: '#8b5cf6' },
                        'mixed': { label: 'Mixed', color: '#f59e0b' }
                    };
                    const config = methodMap[method] || { label: method, color: '#6b7280' };
                    return `<span style="padding: 4px 12px; background: ${config.color}20; color: ${config.color}; border-radius: 4px; font-weight: 500;">${config.label}</span>`;
                };
                
                // Format the invoice details HTML
                let detailHTML = `
                    <div class="invoice-detail-container">
                        <!-- Header Information -->
                        <div class="invoice-detail-header" style="margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e5e5e5;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 16px;">
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Invoice Number</label>
                                    <div style="font-size: 18px; font-weight: 600; color: #111;">${invoice.invoice_number}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Date</label>
                                    <div style="font-size: 16px; color: #111;">${formatDate(invoice.sale_date)}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Status</label>
                                    <div>${getStatusBadge(invoice.status)}</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Store</label>
                                    <div style="font-size: 14px; color: #111;">${invoice.store_name}</div>
                                </div>
                                <div>
                                    <label style="font-size: 12px; color: #666; display: block; margin-bottom: 4px;">Customer</label>
                                    <div style="font-size: 14px; color: #111;">${invoice.customer_name || 'Walk-in Customer'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Items List -->
                        <div style="margin-bottom: 24px;">
                            <h3 style="font-size: 14px; font-weight: 600; color: #666; margin-bottom: 12px;">Items</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 2px solid #e5e5e5;">
                                        <th style="text-align: left; padding: 8px; color: #666; font-weight: 500; font-size: 12px;">PRODUCT</th>
                                        <th style="text-align: center; padding: 8px; color: #666; font-weight: 500; font-size: 12px;">SKU</th>
                                        <th style="text-align: center; padding: 8px; color: #666; font-weight: 500; font-size: 12px;">QTY</th>
                                        <th style="text-align: right; padding: 8px; color: #666; font-weight: 500; font-size: 12px;">UNIT PRICE</th>
                                        <th style="text-align: right; padding: 8px; color: #666; font-weight: 500; font-size: 12px;">DISCOUNT</th>
                                        <th style="text-align: right; padding: 8px; color: #666; font-weight: 500; font-size: 12px;">TOTAL</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${items.map(item => `
                                        <tr style="border-bottom: 1px solid #f0f0f0;">
                                            <td style="padding: 12px 8px;">
                                                <div style="font-weight: 500;">${item.product_name}</div>
                                            </td>
                                            <td style="text-align: center; padding: 12px 8px; color: #666; font-size: 14px;">${item.sku}</td>
                                            <td style="text-align: center; padding: 12px 8px;">${item.quantity_sold}</td>
                                            <td style="text-align: right; padding: 12px 8px;">${currencySymbol}${formatNumber(item.unit_price)}</td>
                                            <td style="text-align: right; padding: 12px 8px; color: #dc2626;">${item.discount_amount > 0 ? `-${currencySymbol}${formatNumber(item.discount_amount)}` : '-'}</td>
                                            <td style="text-align: right; padding: 12px 8px; font-weight: 500;">${currencySymbol}${formatNumber(item.total_amount)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Summary and Payment -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                            <!-- Payment Information -->
                            <div>
                                <h3 style="font-size: 14px; font-weight: 600; color: #666; margin-bottom: 12px;">Payment Information</h3>
                                <div style="background: #f9f9f9; padding: 16px; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                                        <span style="color: #666;">Method:</span>
                                        <div>${getPaymentBadge(payment.method)}</div>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span style="color: #666;">Status:</span>
                                        <span style="color: ${payment.status === 'paid' ? '#22c55e' : '#f59e0b'}; font-weight: 500;">
                                            ${payment.status === 'paid' ? 'Paid' : 'Pending'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Amount Summary -->
                            <div>
                                <h3 style="font-size: 14px; font-weight: 600; color: #666; margin-bottom: 12px;">Amount Summary</h3>
                                <div style="background: #f9f9f9; padding: 16px; border-radius: 8px;">
                                    <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                        <span style="color: #666;">Subtotal:</span>
                                        <span>${currencySymbol}${formatNumber(amounts.subtotal)}</span>
                                    </div>
                                    ${amounts.discount_amount > 0 ? `
                                        <div style="display: flex; justify-content: space-between; padding: 4px 0; color: #dc2626;">
                                            <span>Discount:</span>
                                            <span>-${currencySymbol}${formatNumber(amounts.discount_amount)}</span>
                                        </div>
                                    ` : ''}
                                    ${amounts.tax_amount > 0 ? `
                                        <div style="display: flex; justify-content: space-between; padding: 4px 0;">
                                            <span style="color: #666;">Tax:</span>
                                            <span>${currencySymbol}${formatNumber(amounts.tax_amount)}</span>
                                        </div>
                                    ` : ''}
                                    <div style="display: flex; justify-content: space-between; padding: 8px 0; margin-top: 8px; border-top: 2px solid #e5e5e5; font-size: 18px; font-weight: 600;">
                                        <span>Total:</span>
                                        <span style="color: #0064FF;">${currencySymbol}${formatNumber(amounts.total_amount)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Inventory Movements (Optional) -->
                        ${inventory_movements && inventory_movements.length > 0 ? `
                            <div style="margin-bottom: 24px;">
                                <h3 style="font-size: 14px; font-weight: 600; color: #666; margin-bottom: 12px;">Inventory Impact</h3>
                                <div style="background: #fef3c7; padding: 16px; border-radius: 8px; border: 1px solid #fde68a;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid #fde68a;">
                                                <th style="text-align: left; padding: 8px 8px 8px 0; color: #92400e; font-weight: 500; font-size: 12px;">PRODUCT</th>
                                                <th style="text-align: center; padding: 8px; color: #92400e; font-weight: 500; font-size: 12px;">QTY CHANGE</th>
                                                <th style="text-align: center; padding: 8px; color: #92400e; font-weight: 500; font-size: 12px;">STOCK BEFORE</th>
                                                <th style="text-align: center; padding: 8px; color: #92400e; font-weight: 500; font-size: 12px;">STOCK AFTER</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${inventory_movements.map(movement => `
                                                <tr>
                                                    <td style="padding: 8px 8px 8px 0; color: #78350f; font-size: 14px;">${movement.product_name}</td>
                                                    <td style="text-align: center; padding: 8px; color: #dc2626; font-weight: 500;">${movement.quantity_change}</td>
                                                    <td style="text-align: center; padding: 8px; color: #78350f;">${movement.stock_before}</td>
                                                    <td style="text-align: center; padding: 8px; font-weight: 500; color: ${movement.stock_after < 0 ? '#dc2626' : '#78350f'};">
                                                        ${movement.stock_after}
                                                        ${movement.stock_after < 0 ? ' ⚠️' : ''}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                    ${inventory_movements.some(m => m.stock_after < 0) ? `
                                        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #fde68a;">
                                            <span style="color: #dc2626; font-size: 13px;">⚠️ Warning: Some products have negative stock after this transaction</span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                console.log('Setting modal content, length:', detailHTML.length);
                modalBody.innerHTML = detailHTML;
                
                // Ensure modal is still visible after setting content
                const modal = document.getElementById('invoiceDetailModal');
                if (modal) {
                    modal.classList.add('active');
                    modal.style.display = 'flex';
                    modal.style.opacity = '1';
                    modal.style.visibility = 'visible';
                    
                    // Debug check
                    const computedStyle = window.getComputedStyle(modal);
                    console.log('Modal visibility check:', {
                        display: computedStyle.display,
                        opacity: computedStyle.opacity,
                        visibility: computedStyle.visibility,
                        zIndex: computedStyle.zIndex,
                        classList: modal.classList.toString(),
                        inlineDisplay: modal.style.display
                    });
                }
            }
            
            closeInvoiceDetail() {
                const modal = document.getElementById('invoiceDetailModal');
                if (modal) {
                    modal.classList.remove('active');
                    modal.style.display = 'none';
                    modal.style.opacity = '0';
                    modal.style.visibility = 'hidden';
                }
                this.currentInvoiceId = null;
                this.isLoadingInvoice = false;  // Reset loading flag when closing
            }
            
            viewInvoice(invoiceId, event) {
                // Redirect to viewInvoiceDetail for consistency
                this.viewInvoiceDetail(invoiceId, event);
            }
            
            editInvoice(invoiceId) {
                console.log('Edit invoice:', invoiceId);
                // TODO: Implement invoice editing
            }
            
            printInvoice(invoiceId) {
                console.log('Print invoice:', invoiceId);
                // TODO: Implement invoice printing
            }
            
            refundInvoice(invoiceId) {
                console.log('Refund invoice:', invoiceId);
                // TODO: Implement invoice refund functionality
                // This could open a refund modal or redirect to refund page
                alert('Refund functionality will be implemented soon.');
            }
            
            createNewInvoice() {
                console.log('Opening new invoice modal');
                if (window.newInvoiceModal) {
                    window.newInvoiceModal.open().catch(err => {
                        console.error('Error opening modal:', err);
                    });
                } else {
                    console.error('NewInvoiceModal not initialized');
                }
            }
            
            clearFilters() {
                this.currentSearch = '';
                this.currentStartDate = null;
                this.currentEndDate = null;
                document.getElementById('invoiceSearch').value = '';
                
                // Reset date filter tabs
                document.querySelectorAll('.date-filter-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector('.date-filter-tab[data-filter="all"]')?.classList.add('active');
                
                this.loadInvoicesForStore(this.currentStoreFilter);
            }
        }
        
        // New Invoice Modal Manager
        class NewInvoiceModal {
            constructor() {
                this.modal = document.getElementById('newInvoiceModal');
                this.form = document.getElementById('newInvoiceForm');
                
                // Check if required elements exist
                if (!this.modal) {
                    console.error('NewInvoiceModal: Modal element not found');
                    return;
                }
                
                if (!this.form) {
                    console.warn('NewInvoiceModal: Form element not found - some functionality may be limited');
                }
                this.selectedProducts = [];
                this.searchTimeout = null;
                this.isSearching = false;
                this.productsData = []; // Store products data for searching
                this.isProductsLoaded = false;
                this.selectedCurrency = null; // Store selected currency for denominations
                this.selectedCashLocation = null; // Store selected cash location
                this.cashCountTotal = 0; // Store total from cash count denomination inputs
                this.denominationValues = {}; // Store denomination values for calculation
                this.currencyAmountData = {}; // Store amount data per currency
                
                // Multi-payment system properties
                this.paymentMethods = []; // Store multiple payment methods
                this.currentAddPaymentType = 'cash'; // Current payment type being added
                this.currentAddPaymentLocation = null; // Current cash location being added
                this.currentAddPaymentCurrencies = {}; // Current currencies being added
                
                // Multi-step flow properties
                this.currentStep = 1;
                this.totalSteps = 3;
                
                // Discount properties
                this.discountType = 'amount'; // 'amount' or 'percent'
                this.discountAmount = 0;
                this.discountPercent = 0;
                
                // Initialize modal functionality only if modal exists
                if (this.modal) {
                    this.initializeEventListeners();
                    this.loadCashLocations();
                    
                    // Load products data when page loads
                    this.loadProductsData();
                }
            }
            
            initializeEventListeners() {
                // New Invoice button click
                const newInvoiceBtn = document.getElementById('newInvoiceBtn');
                if (newInvoiceBtn) {
                    newInvoiceBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        try {
                            await this.open();
                        } catch (err) {
                            console.error('Error opening modal:', err);
                        }
                    });
                }
                
                // Close modal buttons
                const closeBtn = document.getElementById('closeInvoiceModal');
                const cancelInvoiceBtn = document.getElementById('cancelInvoiceBtn');
                
                [closeBtn, cancelInvoiceBtn].forEach(btn => {
                    if (btn) {
                        btn.addEventListener('click', () => this.close());
                    }
                });
                
                // Step navigation buttons
                const nextBtn = document.getElementById('nextStepBtn');
                const prevBtn = document.getElementById('prevStepBtn');
                const cancelBtn = document.getElementById('cancelBtn');
                
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        this.nextStep();
                    });
                }
                
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        this.previousStep();
                    });
                }
                
                if (cancelBtn) {
                    cancelBtn.addEventListener('click', () => {
                        this.close();
                    });
                }
                
                // Close modal when clicking overlay (but not from add payment modal)
                this.modal.addEventListener('click', (e) => {
                    // Don't close main modal if click came from add payment modal
                    const fromAddPaymentModal = e.composedPath().some(el => el.id === 'addPaymentModal');
                    
                    if (e.target === this.modal && !fromAddPaymentModal) {
                        console.log('Main modal overlay clicked, closing...');
                        this.close();
                    } else if (fromAddPaymentModal) {
                        console.log('Click came from add payment modal, ignoring...');
                    }
                });
                
                // Prevent modal from closing when clicking inside modal content
                const modalContainer = this.modal.querySelector('.modal-container');
                modalContainer.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // Product search functionality
                const productSearchInput = document.getElementById('productSearch');
                if (productSearchInput) {
                    productSearchInput.addEventListener('input', (e) => {
                        this.handleProductSearch(e.target.value);
                    });
                    
                    productSearchInput.addEventListener('focus', () => {
                        this.showSearchDropdown();
                    });
                    
                    // Optional: Hide dropdown when input loses focus
                    // Note: Using setTimeout to allow click events on dropdown items to register first
                    productSearchInput.addEventListener('blur', () => {
                        setTimeout(() => {
                            // Only hide if user didn't click within the dropdown
                            if (!document.querySelector('.product-search-dropdown:hover')) {
                                this.hideSearchDropdown();
                            }
                        }, 150);
                    });
                }
                
                // Amount received input
                const amountInput = document.getElementById('amountReceived');
                if (amountInput) {
                    amountInput.addEventListener('input', () => {
                        this.updateSummary();
                        this.updateFormValidation();
                    });
                }
                
                // Note: Cash location validation is handled in the selectCashLocation method
                
                // Form submission
                this.form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmit();
                });
                
                // Close dropdown when clicking outside (but not from add payment modal)
                document.addEventListener('click', (e) => {
                    // Don't close if click came from add payment modal
                    const fromAddPaymentModal = e.composedPath().some(el => el.id === 'addPaymentModal');
                    
                    if (!e.target.closest('.product-search-container') && !fromAddPaymentModal) {
                        this.hideSearchDropdown();
                    }
                });
                
                // Enhanced keyboard handling for dropdown and modal
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        // Close product search dropdown first if it's open
                        const dropdown = document.getElementById('productSearchDropdown');
                        if (dropdown && dropdown.classList.contains('active')) {
                            this.hideSearchDropdown();
                            // Return focus to search input
                            const searchInput = document.getElementById('productSearch');
                            if (searchInput) {
                                searchInput.focus();
                            }
                        } else if (this.modal.classList.contains('active')) {
                            // Don't close main modal if add payment modal is open
                            const addPaymentModal = document.getElementById('addPaymentModal');
                            const addPaymentModalActive = addPaymentModal && addPaymentModal.classList.contains('active');
                            
                            if (!addPaymentModalActive) {
                                // Close main modal only if add payment modal is not open
                                console.log('ESC pressed, closing main modal...');
                                this.close();
                            } else {
                                console.log('ESC pressed but add payment modal is active, ignoring...');
                            }
                        }
                    }
                });
            }
            
            // Step Navigation Methods
            nextStep() {
                if (this.currentStep < this.totalSteps) {
                    // Validate current step before moving forward
                    if (this.currentStep === 1) {
                        if (this.selectedProducts.length === 0) {
                            this.showNotification('No Products Selected', 'Please select at least one product to continue.');
                            return;
                        }
                        // Update review step summary
                        this.updateReviewSummary();
                    }
                    
                    this.currentStep++;
                    this.updateStepDisplay();
                }
            }
            
            previousStep() {
                if (this.currentStep > 1) {
                    this.currentStep--;
                    this.updateStepDisplay();
                }
            }
            
            updateStepDisplay() {
                // Update step indicators
                document.querySelectorAll('.step').forEach((step, index) => {
                    if (index + 1 === this.currentStep) {
                        step.classList.add('active');
                        step.classList.remove('completed');
                    } else if (index + 1 < this.currentStep) {
                        step.classList.remove('active');
                        step.classList.add('completed');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });
                
                // Update step content
                document.querySelectorAll('.step-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`step${this.currentStep}Content`)?.classList.add('active');
                
                // Update navigation buttons
                const prevBtn = document.getElementById('prevStepBtn');
                const nextBtn = document.getElementById('nextStepBtn');
                const modalTitle = document.getElementById('modalTitle');
                
                // Show/hide back button
                if (prevBtn) {
                    prevBtn.style.display = this.currentStep > 1 ? 'flex' : 'none';
                }
                
                // Update next/create button
                if (nextBtn) {
                    if (this.currentStep === this.totalSteps) {
                        nextBtn.innerHTML = `
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9,10H7V12H9V10M13,10H11V12H13V10M17,10H15V12H17V10M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.9 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z"/>
                            </svg>
                            Create Invoice`;
                        nextBtn.onclick = () => this.handleSubmit();
                    } else {
                        nextBtn.innerHTML = `Next
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z"/>
                            </svg>`;
                        nextBtn.onclick = () => this.nextStep();
                    }
                }
                
                // Update modal title
                if (modalTitle) {
                    const titles = ['Select Products', 'Review Order', 'Payment Details'];
                    modalTitle.textContent = titles[this.currentStep - 1];
                }
            }
            
            showNotification(title, message, duration = 1000) {
                const notification = document.getElementById('modalNotification');
                const overlay = document.getElementById('modalOverlay');
                
                if (notification && overlay) {
                    // Update notification content
                    const titleElement = notification.querySelector('.modal-notification-title');
                    const messageElement = notification.querySelector('.modal-notification-message');
                    
                    if (titleElement) titleElement.textContent = title;
                    if (messageElement) messageElement.textContent = message;
                    
                    // Hide the OK button for auto-close notifications
                    const button = notification.querySelector('.modal-notification-button');
                    if (button) button.style.display = 'none';
                    
                    // Show notification with animation
                    overlay.classList.add('show');
                    notification.classList.add('show');
                    
                    // Auto-hide after specified duration
                    setTimeout(() => {
                        this.hideNotification();
                    }, duration);
                }
            }
            
            hideNotification() {
                const notification = document.getElementById('modalNotification');
                const overlay = document.getElementById('modalOverlay');
                
                if (notification && overlay) {
                    notification.classList.remove('show');
                    overlay.classList.remove('show');
                }
            }
            
            updateReviewSummary() {
                const orderSummary = document.getElementById('orderSummaryReview');
                const reviewSubtotal = document.getElementById('reviewSubtotal');
                const reviewDiscount = document.getElementById('reviewDiscount');
                const reviewTotal = document.getElementById('reviewTotal');
                
                if (orderSummary) {
                    orderSummary.innerHTML = this.selectedProducts.map(product => `
                        <div class="order-item">
                            <div class="order-item-info">
                                <div class="order-item-name">${product.name}</div>
                                <div class="order-item-details">${product.quantity} × ${this.formatAmount(product.price)}</div>
                            </div>
                            <div class="order-item-price">${this.formatAmount(product.price * product.quantity)}</div>
                        </div>
                    `).join('');
                }
                
                const subtotal = this.calculateSubtotal();
                const discount = this.calculateDiscount(subtotal);
                const total = subtotal - discount;
                
                if (reviewSubtotal) reviewSubtotal.textContent = this.formatAmount(subtotal);
                if (reviewDiscount) reviewDiscount.textContent = discount > 0 ? `-${this.formatAmount(discount)}` : this.formatAmount(0);
                if (reviewTotal) reviewTotal.textContent = this.formatAmount(total);
            }
            
            calculateSubtotal() {
                return this.selectedProducts.reduce((sum, product) => sum + (product.price * product.quantity), 0);
            }
            
            calculateDiscount(subtotal) {
                if (this.discountType === 'percent') {
                    return subtotal * (this.discountPercent / 100);
                } else {
                    return this.discountAmount;
                }
            }
            
            // Discount Modal Methods
            openDiscountModal() {
                const modal = document.getElementById('discountModal');
                if (modal) {
                    modal.classList.add('active');
                    document.getElementById('discountValue').focus();
                }
            }
            
            closeDiscountModal() {
                const modal = document.getElementById('discountModal');
                if (modal) {
                    modal.classList.remove('active');
                }
            }
            
            showSuccessDialog(options) {
                console.log('=== showSuccessDialog FUNCTION STARTED ===');
                console.log('Options received:', options);
                
                try {
                    // Create success dialog HTML
                    console.log('Creating dialog HTML...');
                    const dialogHTML = `
                    <div class="success-dialog-overlay" id="successDialogOverlay" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0, 0, 0, 0.5);
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        z-index: 99999;
                    ">
                        <div class="success-dialog" style="
                            background: white;
                            border-radius: 12px;
                            padding: 32px;
                            max-width: 480px;
                            width: 90%;
                            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
                            text-align: center;
                        ">
                            <div style="margin-bottom: 24px;">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="#22c55e" style="margin: 0 auto;">
                                    <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/>
                                </svg>
                            </div>
                            
                            <h2 style="font-size: 24px; font-weight: 600; color: #111827; margin-bottom: 8px;">
                                ${options.title}
                            </h2>
                            
                            <div style="margin-bottom: 24px; color: #6b7280;">
                                <p style="margin: 8px 0;"><strong>Invoice Number:</strong> ${options.invoiceNumber}</p>
                                <p style="margin: 8px 0;"><strong>Total Amount:</strong> ${options.currency}${new Intl.NumberFormat('ko-KR').format(options.totalAmount)}</p>
                                
                                ${options.warnings.length > 0 ? `
                                    <div style="margin-top: 16px; padding: 12px; background: #fef3c7; border-radius: 8px; text-align: left;">
                                        <p style="font-weight: 600; color: #92400e; margin: 0 0 8px 0;">Warnings:</p>
                                        ${options.warnings.map(warning => {
                                            if (warning.type === 'negative_stock') {
                                                return `<p style="margin: 4px 0; color: #92400e;">• ${warning.product}: Stock will be negative (${warning.stock_after})</p>`;
                                            } else if (warning.type === 'price_below_minimum') {
                                                return `<p style="margin: 4px 0; color: #92400e;">• ${warning.product}: Price below minimum (${warning.unit_price} < ${warning.min_price})</p>`;
                                            }
                                            return '';
                                        }).join('')}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <button onclick="document.getElementById('successDialogOverlay').remove()" style="
                                background: #3b82f6;
                                color: white;
                                border: none;
                                padding: 12px 24px;
                                border-radius: 8px;
                                font-weight: 500;
                                cursor: pointer;
                                transition: background-color 0.2s;
                            " onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                                Close
                            </button>
                        </div>
                    </div>
                `;
                
                // Add to body
                console.log('Adding dialog to body...');
                document.body.insertAdjacentHTML('beforeend', dialogHTML);
                
                console.log('Dialog added to body');
                
                // Check if dialog was added successfully
                const addedDialog = document.getElementById('successDialogOverlay');
                console.log('Dialog found after adding:', addedDialog ? 'YES' : 'NO');
                
                // Auto-close after 5 seconds
                setTimeout(() => {
                    console.log('Auto-closing dialog after 5 seconds...');
                    const overlay = document.getElementById('successDialogOverlay');
                    if (overlay) {
                        overlay.remove();
                        console.log('Dialog removed automatically');
                    }
                }, 5000);
                
                console.log('=== showSuccessDialog FUNCTION COMPLETED ===');
                
                } catch (error) {
                    console.error('Error in showSuccessDialog:', error);
                    console.error('Error stack:', error.stack);
                    // Fallback to simple alert
                    alert(`Invoice Created Successfully!\nInvoice Number: ${options.invoiceNumber}\nTotal Amount: ${options.currency}${new Intl.NumberFormat('ko-KR').format(options.totalAmount)}`);
                }
            }
            
            toggleDiscountType(type) {
                this.discountType = type;
                document.querySelectorAll('.discount-type-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.type === type);
                });
                
                // Update input value based on type
                const input = document.getElementById('discountValue');
                if (input) {
                    if (type === 'percent') {
                        input.value = this.discountPercent || '';
                        input.max = '100';
                    } else {
                        input.value = this.discountAmount || '';
                        input.removeAttribute('max');
                    }
                }
            }
            
            applyDiscount() {
                const input = document.getElementById('discountValue');
                const value = parseFloat(input.value) || 0;
                
                if (this.discountType === 'percent') {
                    this.discountPercent = Math.min(100, Math.max(0, value));
                } else {
                    this.discountAmount = Math.max(0, value);
                }
                
                this.updateReviewSummary();
                this.closeDiscountModal();
            }
            
            async loadCashLocations() {
                try {
                    const companyId = appState.getSelectedCompanyId();
                    if (!companyId) return;
                    
                    // Check if Supabase client is initialized first
                    if (!window.supabaseClient) {
                        console.log('Supabase client not yet initialized, scheduling retry for cash locations');
                        // Schedule a retry after a short delay
                        setTimeout(() => {
                            if (window.supabaseClient) {
                                this.loadCashLocations();
                            }
                        }, 1000);
                        return;
                    }
                    
                    // Get cash locations from RPC
                    const cashLocations = await getCashLocations(companyId);
                    
                    // Store for later use in the dropdown
                    this.cashLocationsData = cashLocations || [];
                    
                    // Reset the display
                    const cashLocationSelect = document.getElementById('cashLocationSelect');
                    const cashLocationInput = document.getElementById('cashLocation');
                    if (cashLocationSelect && cashLocationInput) {
                        const valueSpan = cashLocationSelect.querySelector('.toss-select-value');
                        valueSpan.textContent = 'Select cash location...';
                        valueSpan.classList.add('toss-select-placeholder');
                        cashLocationInput.value = '';
                    }
                } catch (error) {
                    console.error('Error loading cash locations:', error);
                    this.cashLocationsData = [];
                }
            }
            
            openCashLocationSearch(isForAddPayment = false) {
                console.log('Opening cash location search...', isForAddPayment ? 'for add payment' : 'for main form');
                
                const cashLocationSelect = isForAddPayment ? 
                    document.getElementById('addPaymentCashLocationSelect') : 
                    document.getElementById('cashLocationSelect');
                if (!cashLocationSelect) {
                    console.error('Cash location select element not found');
                    return;
                }
                
                // Check if dropdown already exists and toggle
                const existingMenu = document.querySelector('.cash-location-search-menu');
                if (existingMenu) {
                    console.log('Closing existing cash location menu');
                    existingMenu.remove();
                    return;
                }
                
                // Use the already loaded cash locations
                const locations = this.cashLocationsData || cashLocationsData || [];
                
                console.log('Creating cash location dropdown menu with locations:', locations);
                
                const menu = document.createElement('div');
                menu.className = 'toss-select-menu toss-select-menu-show cash-location-search-menu';
                menu.style.position = 'absolute';
                menu.style.top = 'calc(100% + 8px)';
                menu.style.left = '0';
                menu.style.right = '0';
                menu.style.zIndex = '1200';
                
                // Add search input at the top
                const searchContainer = document.createElement('div');
                searchContainer.style.padding = '12px';
                searchContainer.style.borderBottom = '1px solid var(--toss-gray-200)';
                searchContainer.style.position = 'sticky';
                searchContainer.style.top = '0';
                searchContainer.style.background = 'var(--toss-white)';
                searchContainer.style.zIndex = '1';
                
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = 'Search cash locations...';
                searchInput.className = 'toss-input';
                searchInput.style.width = '100%';
                searchInput.style.fontSize = '14px';
                searchInput.style.padding = '10px 12px';
                searchContainer.appendChild(searchInput);
                
                // Prevent search container from closing the menu when clicked
                searchContainer.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                menu.appendChild(searchContainer);
                
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'toss-select-options';
                optionsContainer.style.display = 'flex';
                optionsContainer.style.flexDirection = 'column';
                optionsContainer.style.padding = '8px';
                
                if (locations.length === 0) {
                    const emptyOption = document.createElement('div');
                    emptyOption.className = 'toss-select-option';
                    emptyOption.style.padding = '24px';
                    emptyOption.style.textAlign = 'center';
                    emptyOption.innerHTML = `
                        <div class="toss-select-option-content" style="flex-direction: column; align-items: center; gap: 8px;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="color: var(--toss-gray-300); margin-bottom: 8px;">
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,6A1.5,1.5 0 0,1 13.5,7.5A1.5,1.5 0 0,1 12,9A1.5,1.5 0 0,1 10.5,7.5A1.5,1.5 0 0,1 12,6M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,10C13.25,10 15.29,10.54 16.19,12.38C16.66,13.27 16.65,14.35 16.15,15.23C15.5,16.37 14.45,17 13.25,17H10.75C9.55,17 8.5,16.37 7.85,15.23C7.35,14.35 7.34,13.27 7.81,12.38C8.71,10.54 10.75,10 12,10Z"/>
                            </svg>
                            <div class="toss-select-option-label" style="color: var(--toss-gray-600); font-style: normal; font-size: 16px;">No cash locations found</div>
                            <div class="toss-select-option-description" style="color: var(--toss-gray-400); font-size: 14px; margin-top: 4px;">
                                No cash locations exist for this company. Please create cash locations first.
                            </div>
                        </div>
                    `;
                    optionsContainer.appendChild(emptyOption);
                } else {
                    locations.forEach(location => {
                        console.log('Creating option for cash location:', location);
                        const option = document.createElement('div');
                        option.className = 'toss-select-option cash-location-option';
                        option.dataset.locationId = location.id;
                        option.dataset.locationName = (location.name || '').toLowerCase();
                        option.dataset.locationType = (location.type || '').toLowerCase();
                        
                        // Get location type display
                        let typeBackground = 'rgba(0, 0, 0, 0.05)';
                        let typeTextColor = 'var(--toss-gray-700)';
                        let typeText = 'UNKNOWN';
                        
                        switch(location.type?.toLowerCase()) {
                            case 'cash':
                            case 'cash_register':
                            case 'petty_cash':
                            case 'safe':
                                typeBackground = 'rgba(0, 200, 150, 0.15)';
                                typeTextColor = '#00C896';
                                typeText = 'CASH';
                                break;
                            case 'bank':
                            case 'bank_account':
                                typeBackground = 'rgba(0, 100, 255, 0.15)';
                                typeTextColor = '#0064FF';
                                typeText = 'BANK';
                                break;
                            case 'vault':
                                typeBackground = 'rgba(155, 81, 224, 0.15)';
                                typeTextColor = '#9B51E0';
                                typeText = 'VAULT';
                                break;
                            default:
                                typeText = (location.type || 'UNKNOWN').toUpperCase();
                        }
                        
                        option.innerHTML = `
                            <div class="account-option-content" style="width: 100%;">
                                <div class="account-option-name">
                                    ${location.name || 'Unnamed Location'}
                                </div>
                                <div class="account-option-type" style="background: ${typeBackground}; color: ${typeTextColor};">
                                    <span>${typeText}</span>
                                </div>
                            </div>
                        `;
                        
                        option.onclick = () => {
                            this.selectCashLocation(location, isForAddPayment);
                            menu.remove();
                        };
                        
                        optionsContainer.appendChild(option);
                    });
                    
                    // Add search functionality
                    if (searchInput) {
                        searchInput.addEventListener('click', (e) => {
                            e.stopPropagation();
                        });
                        
                        searchInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.toLowerCase().trim();
                            const locationOptions = Array.from(optionsContainer.querySelectorAll('.cash-location-option'));
                            
                            if (searchTerm === '') {
                                locationOptions.forEach(option => {
                                    option.style.display = 'flex';
                                    option.style.order = '0';
                                });
                                return;
                            }
                            
                            locationOptions.forEach(option => {
                                const locationName = option.dataset.locationName || '';
                                const locationType = option.dataset.locationType || '';
                                
                                if (locationName.includes(searchTerm) || locationType.includes(searchTerm)) {
                                    option.style.display = 'flex';
                                } else {
                                    option.style.display = 'none';
                                }
                            });
                        });
                    }
                }
                
                menu.appendChild(optionsContainer);
                
                // Append menu to the select container
                const container = cashLocationSelect.parentElement;
                container.appendChild(menu);
                
                // Focus search input
                setTimeout(() => {
                    if (searchInput) {
                        searchInput.focus();
                    }
                }, 100);
                
                // Close on click outside (but not from add payment modal)
                const closeHandler = (e) => {
                    // Don't close if click came from add payment modal
                    const fromAddPaymentModal = e.composedPath().some(el => el.id === 'addPaymentModal');
                    
                    if (!container.contains(e.target) && !fromAddPaymentModal) {
                        menu.remove();
                        document.removeEventListener('click', closeHandler);
                    }
                };
                
                setTimeout(() => {
                    document.addEventListener('click', closeHandler);
                }, 0);
            }
            
            selectCashLocation(location, isForAddPayment = false) {
                console.log('=== Cash location selected ===', location, isForAddPayment ? 'for add payment' : 'for main form');
                console.log('Location type:', location.type);
                console.log('Location name:', location.name);
                
                if (isForAddPayment) {
                    // Handle add payment modal
                    this.currentAddPaymentLocation = location;
                    
                    // CRITICAL: Clear currency data when location changes
                    console.log('Clearing currency data due to location change');
                    this.currentAddPaymentCurrencies = {};
                    
                    // Clear any current amount input
                    const amountInput = document.getElementById('addPaymentAmount');
                    if (amountInput) {
                        amountInput.value = '';
                        console.log('Cleared amount input');
                    }
                    
                    const cashLocationSelect = document.getElementById('addPaymentCashLocationSelect');
                    if (cashLocationSelect) {
                        const valueSpan = cashLocationSelect.querySelector('.toss-select-value');
                        if (valueSpan) {
                            valueSpan.textContent = location.name;
                            valueSpan.classList.remove('toss-select-placeholder');
                        }
                    }
                    
                    // Auto-determine and display payment type based on location type
                    this.setAddPaymentType(location.type);
                    this.showPaymentTypeDisplay(location.type);
                    
                    // Show currency section for all payment locations (cash, vault, bank)
                    if (location.type === 'cash' || location.type === 'vault' || location.type === 'bank' || location.type === 'bank_account') {
                        const currencySection = document.getElementById('currencyAmountsSection');
                        if (currencySection) {
                            console.log('Showing currency section for location type:', location.type);
                            currencySection.style.display = 'block';
                            this.populateAddPaymentCurrencies();
                            
                            // Update visual indicators and totals after clearing data
                            this.updateCurrencyVisualIndicators();
                            this.updateAddPaymentCurrencyTotal();
                        }
                    } else {
                        console.log('Currency section not shown for location type:', location.type);
                    }
                    
                    this.validateAddPaymentForm();
                    return;
                }
                
                // Handle main form (legacy)
                const cashLocationSelect = document.getElementById('cashLocationSelect');
                const cashLocationInput = document.getElementById('cashLocation');
                const paymentMethodInfo = document.getElementById('paymentMethodInfo');
                const paymentMethodText = document.getElementById('paymentMethodText');
                
                if (cashLocationSelect && cashLocationInput) {
                    const valueSpan = cashLocationSelect.querySelector('.toss-select-value');
                    
                    // Set the display value with type badge
                    const typeText = location.type?.toUpperCase() || 'UNKNOWN';
                    valueSpan.textContent = `${location.name} (${typeText})`;
                    valueSpan.classList.remove('toss-select-placeholder');
                    
                    // Set the hidden input value
                    cashLocationInput.value = location.id;
                    
                    // Store selected location
                    this.selectedCashLocation = location;
                    
                    // Update payment method info display
                    if (paymentMethodInfo && paymentMethodText) {
                        const locationType = location.type?.toLowerCase();
                        let paymentMethod = 'Cash';
                        
                        if (locationType === 'bank' || locationType === 'bank_account') {
                            paymentMethod = 'Bank Transfer';
                        } else if (locationType === 'cash' || locationType === 'vault' || locationType === 'cash_register' || locationType === 'petty_cash' || locationType === 'safe') {
                            paymentMethod = 'Cash';
                        }
                        
                        paymentMethodText.textContent = `Payment Method: ${paymentMethod}`;
                        paymentMethodInfo.style.display = 'block';
                    }
                    
                    // Get section elements
                    const currencySection = document.getElementById('currencyDenominationSection');
                    const amountSection = document.getElementById('amountReceivedSection');
                    
                    // Check location type to show/hide appropriate sections
                    if (location.type === 'bank' || location.type === 'bank_account') {
                        // For bank types: show Amount Received, hide Currency/Denomination
                        if (amountSection) amountSection.style.display = 'block';
                        if (currencySection) currencySection.style.display = 'none';
                        this.selectedCurrency = null;
                    } else if (location.type === 'cash' || location.type === 'vault' || location.type === 'cash_register' || location.type === 'petty_cash' || location.type === 'safe') {
                        // For cash/vault types: hide Amount Received, show Currency/Denomination
                        if (amountSection) amountSection.style.display = 'none';
                        if (currencySection) currencySection.style.display = 'block';
                        this.populateCurrencies();
                        // Update summary to show any existing currency data
                        this.updateSummary();
                    } else {
                        // For other types: hide both sections
                        if (amountSection) amountSection.style.display = 'none';
                        if (currencySection) currencySection.style.display = 'none';
                        this.selectedCurrency = null;
                    }
                    
                    // Update form validation
                    this.updateFormValidation();
                }
            }
            
            setAddPaymentType(locationType) {
                console.log('=== setAddPaymentType() called ===');
                console.log('Location type received:', locationType);
                
                // Auto-determine payment type based on cash location type
                let paymentType;
                switch (locationType?.toLowerCase()) {
                    case 'bank':
                    case 'bank_account':
                        paymentType = 'bank';
                        break;
                    case 'transfer':
                    case 'wire_transfer':
                    case 'bank_transfer':
                        paymentType = 'transfer';
                        break;
                    case 'cash':
                    case 'vault':
                    case 'cash_register':
                    case 'petty_cash':
                    case 'safe':
                    default:
                        paymentType = 'cash';
                        break;
                }
                
                console.log('Payment type determined:', paymentType);
                this.currentAddPaymentType = paymentType;
                console.log('currentAddPaymentType set to:', this.currentAddPaymentType);
            }
            
            showPaymentTypeDisplay(locationType) {
                const paymentTypeSection = document.getElementById('paymentTypeSection');
                const paymentTypeDisplay = document.getElementById('paymentTypeDisplay');
                
                if (!paymentTypeSection || !paymentTypeDisplay) return;
                
                // Determine payment type and display info
                let typeText, typeClass, iconSvg;
                switch (locationType?.toLowerCase()) {
                    case 'bank':
                    case 'bank_account':
                        typeText = 'Bank Account';
                        typeClass = 'bank';
                        iconSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2,17H22V14H2M2,13H22L12,2L2,13M7,9V10H8V9H7M15,9V10H16V9H15M11,9V10H12V9H11M2,20H22V18H2M2,21H22V22H2V21Z"/></svg>';
                        break;
                    case 'transfer':
                    case 'wire_transfer':
                    case 'bank_transfer':
                        typeText = 'Bank Transfer';
                        typeClass = 'transfer';
                        iconSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M2,17H22V14H2M2,13H22L12,2L2,13M7,9V10H8V9H7M15,9V10H16V9H15M11,9V10H12V9H11M2,20H22V18H2M2,21H22V22H2V21Z"/></svg>';
                        break;
                    case 'cash':
                    case 'vault':
                    case 'cash_register':
                    case 'petty_cash':
                    case 'safe':
                    default:
                        typeText = 'Cash Location';
                        typeClass = 'cash';
                        iconSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z"/></svg>';
                        break;
                }
                
                // Update payment type display
                paymentTypeDisplay.innerHTML = `${iconSvg}${typeText}`;
                paymentTypeDisplay.className = `payment-type-display ${typeClass}`;
                
                // Show payment type section
                paymentTypeSection.style.display = 'block';
            }
            
            saveCurrencyAmount() {
                if (!this.selectedCurrency) return;
                
                const currencyCode = this.selectedCurrency.currency_code;
                const amountInput = document.getElementById('currencyAmount');
                
                if (amountInput) {
                    const amount = parseFloat(amountInput.value) || 0;
                    
                    // Store amount for this currency
                    if (amount > 0) {
                        this.currencyAmountData[currencyCode] = amount;
                    } else {
                        // Remove data if amount is 0
                        delete this.currencyAmountData[currencyCode];
                    }
                }
            }
            
            hasCurrencyAmount(currencyCode) {
                return this.currencyAmountData[currencyCode] && 
                       this.currencyAmountData[currencyCode] > 0;
            }
            
            populateCurrencies() {
                const currencySelector = document.querySelector('#currencySelector > div');
                if (!currencySelector) return;
                
                // Save current currency amount before clearing
                this.saveCurrencyAmount();
                
                // Clear existing buttons
                currencySelector.innerHTML = '';
                
                // Add currency buttons from companyCurrencies
                if (companyCurrencies && companyCurrencies.length > 0) {
                    companyCurrencies.forEach((currency, index) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'currency-btn';
                        
                        // Check if this is the first load or if we should keep current selection
                        if (index === 0 && !this.selectedCurrency) {
                            btn.classList.add('active');
                            this.selectedCurrency = currency;
                            this.populateCurrencyAmount(currency);
                            // Update summary on initial load
                            this.updateSummary();
                        } else if (this.selectedCurrency && this.selectedCurrency.currency_code === currency.currency_code) {
                            btn.classList.add('active');
                        }
                        
                        // Check if this currency has data
                        const hasData = this.hasCurrencyAmount(currency.currency_code);
                        
                        btn.innerHTML = `
                            <span class="currency-flag">${currency.flag_emoji || '💵'}</span>
                            <span class="currency-code">${currency.currency_code}</span>
                            <span class="currency-symbol">${currency.symbol}</span>
                            ${hasData ? '<span class="currency-checkmark">✓</span>' : ''}
                        `;
                        
                        btn.onclick = () => {
                            // Save current currency amount before switching
                            this.saveCurrencyAmount();
                            
                            // Remove active class from all buttons
                            document.querySelectorAll('.currency-btn').forEach(b => b.classList.remove('active'));
                            // Add active class to clicked button
                            btn.classList.add('active');
                            // Store selected currency
                            this.selectedCurrency = currency;
                            // Update currency amount
                            this.populateCurrencyAmount(currency);
                            
                            // Update all currency buttons to refresh checkmarks
                            this.updateCurrencyCheckmarks();
                            
                            // Update summary to show grand total from all currencies
                            this.updateSummary();
                        };
                        
                        currencySelector.appendChild(btn);
                    });
                } else {
                    // If no currencies available, show base currency only
                    if (currentCurrencyInfo) {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'currency-btn active';
                        
                        btn.innerHTML = `
                            <span class="currency-flag">${currentCurrencyInfo.flag_emoji || '💵'}</span>
                            <span class="currency-code">${currentCurrencyInfo.currency_code}</span>
                            <span class="currency-symbol">${currentCurrencyInfo.symbol}</span>
                        `;
                        
                        btn.disabled = true;
                        currencySelector.appendChild(btn);
                    }
                }
            }
            
            formatCurrencyInput(input) {
                // Remove all non-digits
                let value = input.value.replace(/[^0-9]/g, '');
                
                // Format with commas
                if (value) {
                    const formattedValue = this.formatNumberWithCommas(parseInt(value));
                    input.value = formattedValue;
                }
                
                // Update in real-time
                this.updateCurrencyAmountRealTime(value);
            }
            
            formatNumberWithCommas(number) {
                return number.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
            
            // Helper method for formatting numbers in invoice detail display
            formatNumber(number) {
                return new Intl.NumberFormat('en-US').format(number);
            }
            
            updateCurrencyAmountRealTime(rawValue) {
                if (!this.selectedCurrency) return;
                
                const amount = parseFloat(rawValue) || 0;
                const currencyCode = this.selectedCurrency.currency_code;
                
                // Store amount for this currency
                if (amount > 0) {
                    this.currencyAmountData[currencyCode] = amount;
                } else {
                    // Remove data if amount is 0
                    delete this.currencyAmountData[currencyCode];
                }
                
                // Update summary to reflect the new amount in real-time
                this.updateSummary();
            }
            
            updateCurrencyAmount(value) {
                if (!this.selectedCurrency) return;
                
                // Remove commas for calculation
                const rawValue = value.replace(/,/g, '');
                const amount = parseFloat(rawValue) || 0;
                const currencyCode = this.selectedCurrency.currency_code;
                
                // Store amount for this currency
                if (amount > 0) {
                    this.currencyAmountData[currencyCode] = amount;
                } else {
                    // Remove data if amount is 0
                    delete this.currencyAmountData[currencyCode];
                }
                
                // Update currency checkmarks to show which currencies have data
                this.updateCurrencyCheckmarks();
                
                // Update summary to reflect the new amount
                this.updateSummary();
            }
            
            formatBankAmountInput(input) {
                // Remove all non-digits
                let value = input.value.replace(/[^0-9]/g, '');
                
                // Format with commas
                if (value) {
                    const formattedValue = this.formatNumberWithCommas(parseInt(value));
                    input.value = formattedValue;
                }
                
                // Update summary in real-time
                this.updateSummary();
            }
            
            updateBankAmount(value) {
                // Final validation and summary update
                this.updateSummary();
            }
            
            updateCurrencyCheckmarks() {
                const currencyButtons = document.querySelectorAll('.currency-btn');
                currencyButtons.forEach(btn => {
                    const currencyCode = btn.querySelector('.currency-code')?.textContent;
                    if (currencyCode) {
                        const hasData = this.hasCurrencyAmount(currencyCode);
                        const existingCheckmark = btn.querySelector('.currency-checkmark');
                        
                        if (hasData && !existingCheckmark) {
                            // Add checkmark if it doesn't exist
                            const checkmark = document.createElement('span');
                            checkmark.className = 'currency-checkmark';
                            checkmark.textContent = '✓';
                            btn.appendChild(checkmark);
                        } else if (!hasData && existingCheckmark) {
                            // Remove checkmark if it exists but there's no data
                            existingCheckmark.remove();
                        }
                    }
                });
            }
            
            populateCurrencyAmount(currency) {
                const currencyAmountLabel = document.getElementById('currencyAmountLabel');
                const currencyAmountInput = document.getElementById('currencyAmount');
                
                if (!currency) return;
                
                // Update currency label
                if (currencyAmountLabel) {
                    currencyAmountLabel.textContent = currency.currency_code;
                }
                
                // Get saved amount for this currency
                const savedAmount = this.currencyAmountData[currency.currency_code] || 0;
                
                // Set the saved amount in the input with comma formatting
                if (currencyAmountInput) {
                    if (savedAmount > 0) {
                        currencyAmountInput.value = this.formatNumberWithCommas(savedAmount);
                    } else {
                        currencyAmountInput.value = '';
                    }
                    currencyAmountInput.placeholder = `Enter amount in ${currency.currency_code}`;
                }
            }
            
            calculateGrandTotalFromAllCurrencies() {
                // Save current currency amount first
                this.saveCurrencyAmount();
                
                let grandTotal = 0;
                
                // Iterate through all currencies that have amount data
                for (const [currencyCode, amount] of Object.entries(this.currencyAmountData)) {
                    // Find the currency info from companyCurrencies
                    const currency = companyCurrencies.find(c => c.currency_code === currencyCode);
                    if (!currency) continue;
                    
                    // Convert to base currency using exchange rate
                    const baseCurrencyAmount = amount * (currency.exchange_rate_to_base || 1);
                    grandTotal += baseCurrencyAmount;
                    
                    console.log(`Currency ${currencyCode}: ${amount} * ${currency.exchange_rate_to_base} = ${baseCurrencyAmount}`);
                }
                
                console.log(`Grand total from all currencies: ${grandTotal}`);
                return grandTotal;
            }
            
            calculateSummary() {
                // Alias for updateSummary for backwards compatibility
                this.updateSummary();
            }
            
            updateSummary() {
                const summarySection = document.getElementById('invoiceSummary');
                if (!summarySection) return;
                
                // Calculate products total
                const productsSubtotal = this.selectedProducts.reduce((total, product) => {
                    return total + (product.price * product.quantity);
                }, 0);
                
                // Calculate discount
                const discount = this.calculateDiscount(productsSubtotal);
                const productsTotal = productsSubtotal - discount;
                
                // Get amount received from payment methods
                let amountReceived = this.calculateTotalFromPaymentMethods();
                
                console.log('Amount received calculated from payment methods:', amountReceived);
                console.log('Payment methods:', this.paymentMethods);
                console.log('Subtotal:', productsSubtotal);
                console.log('Discount:', discount);
                console.log('Total after discount:', productsTotal);
                
                // Calculate difference (change)
                const difference = amountReceived - productsTotal;
                
                // Update display
                const subtotalElement = document.getElementById('subtotalAmount');
                const discountElement = document.getElementById('discountAmount');
                const discountRow = document.getElementById('discountRow');
                const totalElement = document.getElementById('totalAmount');
                const totalReceivedElement = document.getElementById('totalReceivedAmount');
                const totalReceivedRow = document.getElementById('totalReceivedRow');
                const changeElement = document.getElementById('changeAmount');
                const changeRow = document.getElementById('changeRow');
                
                // Update subtotal
                if (subtotalElement) {
                    const formattedSubtotal = new Intl.NumberFormat('ko-KR', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(productsSubtotal);
                    subtotalElement.textContent = `${currentCurrencyInfo.symbol}${formattedSubtotal}`;
                }
                
                // Update discount row
                if (discountElement && discountRow) {
                    if (discount > 0) {
                        const formattedDiscount = new Intl.NumberFormat('ko-KR', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }).format(discount);
                        discountElement.textContent = `-${currentCurrencyInfo.symbol}${formattedDiscount}`;
                        discountRow.style.display = 'flex';
                    } else {
                        discountRow.style.display = 'none';
                    }
                }
                
                // Update total (after discount)
                if (totalElement) {
                    const formattedTotal = new Intl.NumberFormat('ko-KR', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(productsTotal);
                    totalElement.textContent = `${currentCurrencyInfo.symbol}${formattedTotal}`;
                }
                
                // Show total received if we have products (to show comparison)
                if (this.selectedProducts.length > 0 && totalReceivedElement && totalReceivedRow) {
                    const formattedReceived = new Intl.NumberFormat('ko-KR', {
                        minimumFractionDigits: 0,
                        maximumFractionDigits: 0
                    }).format(amountReceived);
                    totalReceivedElement.textContent = `${currentCurrencyInfo.symbol}${formattedReceived}`;
                    totalReceivedRow.style.display = 'flex';
                } else if (totalReceivedRow) {
                    totalReceivedRow.style.display = 'none';
                }
                
                // Show change/difference if there's products and some amount received
                if (this.selectedProducts.length > 0 && amountReceived >= 0) {
                    if (changeElement && changeRow) {
                        const formattedDifference = new Intl.NumberFormat('ko-KR', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }).format(Math.abs(difference));
                        
                        if (difference >= 0) {
                            changeElement.textContent = `${currentCurrencyInfo.symbol}${formattedDifference}`;
                            changeRow.querySelector('span:first-child').textContent = 'Change:';
                            changeRow.style.color = '#28a745';
                            changeRow.style.background = 'rgba(40, 167, 69, 0.1)';
                        } else {
                            changeElement.textContent = `-${currentCurrencyInfo.symbol}${formattedDifference}`;
                            changeRow.querySelector('span:first-child').textContent = 'Short:';
                            changeRow.style.color = '#dc3545';
                            changeRow.style.background = 'rgba(220, 53, 69, 0.1)';
                        }
                        changeRow.style.display = 'flex';
                    }
                } else {
                    if (changeRow) {
                        changeRow.style.display = 'none';
                    }
                }
                
                // Show or hide summary based on whether there are products
                summarySection.style.display = this.selectedProducts.length > 0 ? 'block' : 'none';
            }
            
            async loadProductsData() {
                try {
                    const companyId = appState.getSelectedCompanyId();
                    if (!companyId) {
                        console.warn('No company selected, cannot load products data');
                        return;
                    }
                    
                    // Check if Supabase client is initialized
                    if (!window.supabaseClient) {
                        console.log('Supabase client not yet initialized, will retry when available');
                        this.productsData = [];
                        // Schedule a retry after a short delay
                        setTimeout(() => {
                            if (window.supabaseClient && !this.isProductsLoaded) {
                                this.loadProductsData();
                            }
                        }, 1000);
                        return;
                    }
                    
                    console.log('Loading products data for company:', companyId);
                    console.log('Calling RPC: get_inventory_product_list_company with params:', { p_company_id: companyId });
                    
                    // Call the get_inventory_product_list_company RPC
                    const { data, error } = await window.supabaseClient.rpc('get_inventory_product_list_company', {
                        p_company_id: companyId
                    });
                    
                    if (error) {
                        console.error('Error loading products data:', error);
                        console.error('Error details:', {
                            message: error.message,
                            code: error.code,
                            details: error.details,
                            hint: error.hint
                        });
                        this.productsData = [];
                        this.isProductsLoaded = false;
                        return;
                    }
                    
                    console.log('Products data received:', data);
                    console.log('Response structure debug:', {
                        isObject: typeof data === 'object',
                        hasData: data && data.data !== undefined,
                        dataLength: data ? data.length : 'NO DATA',
                        firstProductSample: data && data.length > 0 ? data[0] : 'NO FIRST PRODUCT',
                        hasProducts: data && data.data && data.data.products !== undefined,
                        productsType: data && data.data && data.data.products ? typeof data.data.products : 'undefined',
                        isArray: data && data.data && data.data.products ? Array.isArray(data.data.products) : false,
                        responseKeys: data ? Object.keys(data) : [],
                        dataKeys: data && data.data ? Object.keys(data.data) : []
                    });
                    
                    // Store the products data - Fix: Access correct structure based on RPC response
                    let products = [];
                    
                    // The RPC response structure is: { success: true, data: { products: [...] } }
                    // So we need to access: data.data.products (from Supabase response perspective)
                    if (data && data.data && data.data.products && Array.isArray(data.data.products)) {
                        products = data.data.products;
                        console.log('✅ Using data.data.products structure');
                    } else if (data && data.products && Array.isArray(data.products)) {
                        // Fallback: Check if products are directly in data
                        products = data.products;
                        console.log('✅ Using fallback data.products structure');
                    } else if (data && Array.isArray(data)) {
                        // Direct array response
                        products = data;
                        console.log('✅ Using direct array structure');
                    } else {
                        console.error('❌ Unrecognized data structure:', data);
                    }
                    
                    console.log('Products extracted:', products?.length || 0);
                    console.log('First product sample:', products?.[0]);
                    
                    if (products.length > 0) {
                        this.productsData = products;
                        this.isProductsLoaded = true;
                        console.log(`✓ Successfully loaded ${this.productsData.length} products for search`);
                        console.log('Sample product data:', this.productsData[0]);
                    } else {
                        console.warn('No products data found in response');
                        console.log('Full response structure:', JSON.stringify(data, null, 2));
                        this.productsData = [];
                        this.isProductsLoaded = false;
                    }
                    
                } catch (error) {
                    console.error('Error in loadProductsData:', error);
                    console.error('Error stack:', error.stack);
                    console.error('Error type:', error.constructor.name);
                    this.productsData = [];
                    this.isProductsLoaded = false;
                }
            }
            
            async handleProductSearch(query) {
                clearTimeout(this.searchTimeout);
                
                if (query.trim().length < 2) {
                    this.hideSearchDropdown();
                    return;
                }
                
                this.searchTimeout = setTimeout(async () => {
                    await this.searchProducts(query.trim());
                }, 300);
            }
            
            async searchProducts(query) {
                try {
                    this.showSearchLoading();
                    this.isSearching = true;
                    
                    const companyId = appState.getSelectedCompanyId();
                    const storeId = invoiceManager.currentStoreFilter;
                    
                    if (!companyId || !storeId) {
                        this.showSearchEmpty();
                        return;
                    }
                    
                    // Check if products data is loaded
                    if (!this.isProductsLoaded) {
                        console.warn('Products data not loaded yet, attempting to reload...');
                        await this.loadProductsData();
                        
                        if (!this.isProductsLoaded) {
                            console.error('Failed to load products data');
                            this.showSearchError('Unable to load products. Please try again.');
                            return;
                        }
                    }
                    
                    // Normalize query for case-insensitive search
                    const normalizedQuery = query.toLowerCase();
                    
                    // Smart search: filter by both SKU and product name
                    // Search in: sku, product_name, barcode
                    const filteredProducts = this.productsData.filter(product => {
                        const sku = (product.sku || '').toLowerCase();
                        const productName = (product.product_name || '').toLowerCase();
                        const barcode = (product.barcode || '').toLowerCase();
                        
                        return sku.includes(normalizedQuery) || 
                               productName.includes(normalizedQuery) || 
                               barcode.includes(normalizedQuery);
                    });
                    
                    // Sort results: SKU matches first, then product name matches
                    filteredProducts.sort((a, b) => {
                        const aSkuMatch = (a.sku || '').toLowerCase().includes(normalizedQuery);
                        const bSkuMatch = (b.sku || '').toLowerCase().includes(normalizedQuery);
                        const aNameMatch = (a.product_name || '').toLowerCase().includes(normalizedQuery);
                        const bNameMatch = (b.product_name || '').toLowerCase().includes(normalizedQuery);
                        
                        // SKU matches get highest priority
                        if (aSkuMatch && !bSkuMatch) return -1;
                        if (!aSkuMatch && bSkuMatch) return 1;
                        
                        // Then product name matches
                        if (aNameMatch && !bNameMatch) return -1;
                        if (!aNameMatch && bNameMatch) return 1;
                        
                        // Then alphabetical by product name
                        return (a.product_name || '').localeCompare(b.product_name || '');
                    });
                    
                    // Limit results to prevent UI overwhelm
                    const maxResults = 10;
                    const limitedResults = filteredProducts.slice(0, maxResults);
                    
                    console.log(`Product search for "${query}": found ${filteredProducts.length} results, showing ${limitedResults.length}`);
                    
                    this.displaySearchResults(limitedResults);
                } catch (error) {
                    console.error('Error searching products:', error);
                    this.showSearchError('Search failed. Please try again.');
                } finally {
                    this.isSearching = false;
                }
            }
            
            showSearchLoading() {
                const dropdown = document.getElementById('productSearchDropdown');
                const loading = dropdown.querySelector('.product-search-loading');
                const results = dropdown.querySelector('.product-search-results');
                const empty = dropdown.querySelector('.product-search-empty');
                
                loading.style.display = 'flex';
                results.style.display = 'none';
                empty.style.display = 'none';
                dropdown.classList.add('active');
            }
            
            showSearchEmpty() {
                const dropdown = document.getElementById('productSearchDropdown');
                const loading = dropdown.querySelector('.product-search-loading');
                const results = dropdown.querySelector('.product-search-results');
                const empty = dropdown.querySelector('.product-search-empty');
                
                loading.style.display = 'none';
                results.style.display = 'none';
                empty.style.display = 'block';
                dropdown.classList.add('active');
            }
            
            showSearchError(message) {
                const dropdown = document.getElementById('productSearchDropdown');
                const loading = dropdown.querySelector('.product-search-loading');
                const results = dropdown.querySelector('.product-search-results');
                const empty = dropdown.querySelector('.product-search-empty');
                
                loading.style.display = 'none';
                results.style.display = 'none';
                
                // Update empty state to show error message
                empty.innerHTML = `
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" opacity="0.5" style="color: #dc2626;">
                        <path d="M12,2C13.1,2 14,2.9 14,4C14,5.1 13.1,6 12,6C10.9,6 10,5.1 10,4C10,2.9 10.9,2 12,2M21,9V7L15,1H5C3.89,1 3,1.89 3,3V21A2,2 0 0,0 5,23H19A2,2 0 0,0 21,21V9M19,9H14V4H5V19H19V9Z"/>
                    </svg>
                    <p style="margin: 12px 0 4px 0; font-weight: 600; color: var(--text-secondary);">Error Loading Products</p>
                    <span style="font-size: 13px;">${message}</span>
                `;
                
                empty.style.display = 'block';
                dropdown.classList.add('active');
            }
            
            displaySearchResults(products) {
                const dropdown = document.getElementById('productSearchDropdown');
                const loading = dropdown.querySelector('.product-search-loading');
                const results = dropdown.querySelector('.product-search-results');
                const empty = dropdown.querySelector('.product-search-empty');
                
                loading.style.display = 'none';
                empty.style.display = 'none';
                
                if (products.length === 0) {
                    this.showSearchEmpty();
                    return;
                }
                
                results.innerHTML = products.map(product => {
                    // Extract pricing information
                    const pricing = product.pricing || {};
                    const sellingPrice = pricing.selling_price || 0;
                    
                    // Extract stock information
                    const totalStock = product.total_stock_summary || 0;
                    
                    // Format stock status
                    let stockStatus = 'Out of Stock';
                    let stockClass = 'out-of-stock';
                    if (totalStock > 10) {
                        stockStatus = `In Stock (${totalStock})`;
                        stockClass = 'in-stock';
                    } else if (totalStock > 0) {
                        stockStatus = `Low Stock (${totalStock})`;
                        stockClass = 'low-stock';
                    }
                    
                    return `
                        <div class="product-search-item" data-product-id="${product.product_id}" data-sku="${product.sku}">
                            <div class="product-item-info">
                                <div class="product-item-name">${product.product_name || 'Unknown Product'}</div>
                                <div class="product-item-details">
                                    <span class="product-sku">SKU: ${product.sku || 'N/A'}</span>
                                    <span class="product-stock ${stockClass}">${stockStatus}</span>
                                </div>
                            </div>
                            <div class="product-item-price">${this.formatAmount(sellingPrice)}</div>
                        </div>
                    `;
                }).join('');
                
                // Add click listeners to search results
                results.querySelectorAll('.product-search-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const productId = item.dataset.productId;
                        const sku = item.dataset.sku;
                        const product = products.find(p => p.product_id === productId || p.sku === sku);
                        if (product) {
                            this.addProduct(product);
                        }
                    });
                });
                
                results.style.display = 'block';
                dropdown.classList.add('active');
            }
            
            showSearchDropdown() {
                const dropdown = document.getElementById('productSearchDropdown');
                if (!this.isSearching && dropdown.querySelector('.product-search-results').children.length === 0) {
                    return;
                }
                dropdown.classList.add('active');
            }
            
            hideSearchDropdown() {
                const dropdown = document.getElementById('productSearchDropdown');
                dropdown.classList.remove('active');
            }
            
            addProduct(product) {
                // Helper function to safely parse numeric values
                const parseNumeric = (value, defaultValue = 0) => {
                    const parsed = parseFloat(value);
                    return (!isNaN(parsed) && isFinite(parsed)) ? parsed : defaultValue;
                };
                
                // Extract price with multiple fallbacks
                console.log('=== addProduct() pricing extraction ===');
                console.log('Raw product data:', product);
                console.log('Product keys:', Object.keys(product));
                console.log('Product.pricing:', product.pricing);
                console.log('Product.price:', product.price);
                
                let price = 0;
                
                // PRIMARY: Extract from pricing object (matches RPC structure exactly)
                if (product.pricing && typeof product.pricing === 'object') {
                    console.log('Found pricing object:', product.pricing);
                    
                    // Try selling_price first, then cost_price as fallback
                    if (product.pricing.selling_price !== null && product.pricing.selling_price !== undefined) {
                        price = parseNumeric(product.pricing.selling_price);
                        console.log('✅ Using pricing.selling_price:', price);
                    } else if (product.pricing.cost_price !== null && product.pricing.cost_price !== undefined) {
                        price = parseNumeric(product.pricing.cost_price);
                        console.log('✅ Using pricing.cost_price as fallback:', price);
                    }
                }
                
                // SECONDARY: Try direct product price fields if pricing object failed
                if (price === 0) {
                    console.log('Pricing object failed, trying direct product fields...');
                    
                    const priceFields = [
                        'selling_price', 'price', 'unit_price', 'default_selling_price', 
                        'base_price', 'list_price', 'retail_price', 'cost_price'
                    ];
                    
                    for (const field of priceFields) {
                        if (product[field] !== undefined && product[field] !== null) {
                            console.log(`Trying direct field ${field}:`, product[field]);
                            const testPrice = parseNumeric(product[field]);
                            if (testPrice > 0) {
                                price = testPrice;
                                console.log(`✅ Using direct field ${field}:`, price);
                                break;
                            }
                        }
                    }
                }
                
                console.log('Final extracted price:', price);
                console.log('=== addProduct() pricing extraction completed ===');
                
                // Normalize product data to expected format
                const normalizedProduct = {
                    id: product.product_id || product.id,
                    sku: product.sku || '',
                    name: product.product_name || product.name || 'Unknown Product',
                    description: product.product_description || product.description || product.sku || 'No description available',
                    price: price,
                    stock: parseNumeric(product.total_stock_summary || product.stock),
                    quantity: 1
                };
                
                // Check if product already exists (by ID or SKU)
                const existingIndex = this.selectedProducts.findIndex(p => 
                    p.id === normalizedProduct.id || p.sku === normalizedProduct.sku
                );
                
                if (existingIndex >= 0) {
                    // Increase quantity
                    this.selectedProducts[existingIndex].quantity += 1;
                } else {
                    // Add new product
                    this.selectedProducts.push(normalizedProduct);
                }
                
                // Update displays based on available methods
                if (typeof this.updateSelectedProductsSummary === 'function') {
                    this.updateSelectedProductsSummary();
                } else if (typeof this.renderSelectedProducts === 'function') {
                    this.renderSelectedProducts();
                }
                // Update the All Products list to show selection state
                if (typeof this.displayAllProducts === 'function') {
                    this.displayAllProducts();
                }
                this.updateSummary();
                this.updateFormValidation();
                
                // Clear search input and hide dropdown
                document.getElementById('productSearch').value = '';
                this.hideSearchDropdown();
            }
            
            removeProduct(productId) {
                this.selectedProducts = this.selectedProducts.filter(p => p.id !== productId);
                
                // Update displays based on available methods
                if (typeof this.updateSelectedProductsSummary === 'function') {
                    this.updateSelectedProductsSummary();
                } else if (typeof this.renderSelectedProducts === 'function') {
                    this.renderSelectedProducts();
                }
                // Update the All Products list to show selection state
                if (typeof this.displayAllProducts === 'function') {
                    this.displayAllProducts();
                }
                this.updateSummary();
                this.updateFormValidation();
            }
            
            updateProductQuantity(productId, quantity) {
                const productIndex = this.selectedProducts.findIndex(p => p.id === productId);
                if (productIndex >= 0) {
                    // Validate and parse quantity
                    const parsedQuantity = parseInt(quantity);
                    if (isNaN(parsedQuantity) || parsedQuantity < 0) {
                        console.warn('Invalid quantity provided:', quantity);
                        return;
                    }
                    
                    if (parsedQuantity <= 0) {
                        this.removeProduct(productId);
                    } else {
                        // Allow any positive quantity (no stock limit)
                        this.selectedProducts[productIndex].quantity = parsedQuantity;
                        
                        // Update displays based on available methods
                        if (typeof this.updateSelectedProductsSummary === 'function') {
                            this.updateSelectedProductsSummary();
                        } else if (typeof this.renderSelectedProducts === 'function') {
                            this.renderSelectedProducts();
                        }
                        this.updateSummary();
                    }
                }
            }
            
            displayAllProducts() {
                const allProductsList = document.getElementById('allProductsList');
                const productsCount = document.getElementById('productsCount');
                
                if (!allProductsList) return;
                
                // Sort products by SKU code
                const sortedProducts = [...this.productsData].sort((a, b) => {
                    const skuA = (a.sku || '').toUpperCase();
                    const skuB = (b.sku || '').toUpperCase();
                    if (skuA < skuB) return -1;
                    if (skuA > skuB) return 1;
                    return 0;
                });
                
                // Update count
                if (productsCount) {
                    productsCount.textContent = `${sortedProducts.length} items`;
                }
                
                // Update selected products summary
                this.updateSelectedProductsSummary();
                
                if (sortedProducts.length === 0) {
                    allProductsList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--toss-gray-500);">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.3; margin-bottom: 12px;">
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
                            </svg>
                            <p style="font-size: 14px; margin: 0;">No products available</p>
                        </div>
                    `;
                    return;
                }
                
                // Render products
                allProductsList.innerHTML = sortedProducts.map(product => {
                    const isSelected = this.selectedProducts.some(p => p.id === product.product_id);
                    const selectedProduct = this.selectedProducts.find(p => p.id === product.product_id);
                    const quantity = selectedProduct ? selectedProduct.quantity : 1;
                    
                    // Get selling price for the current store
                    const storeId = invoiceManager.currentStoreFilter;
                    const sellingPrice = this.getSellingPrice(product, storeId);
                    
                    // Check if product is out of stock
                    const isOutOfStock = product.quantity_on_hand <= 0;
                    
                    return `
                        <div class="product-list-item ${isSelected ? 'selected' : ''} ${isOutOfStock ? 'out-of-stock' : ''}" data-product-id="${product.product_id}">
                            <div class="product-list-info">
                                <div class="product-list-sku">
                                    SKU: ${product.sku || 'N/A'}
                                    ${isOutOfStock ? '<span class="product-out-of-stock-badge">OUT OF STOCK</span>' : ''}
                                </div>
                                <div class="product-list-name">${product.product_name}</div>
                                <div class="product-list-price">${this.formatAmount(sellingPrice)}</div>
                            </div>
                            ${!isOutOfStock ? `
                                <div class="product-list-actions">
                                    ${isSelected ? `
                                        <button class="product-remove-btn" onclick="event.stopPropagation(); window.newInvoiceModal.removeProductFromList('${product.product_id}')">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                                <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                            </svg>
                                        </button>
                                    ` : `
                                        <button class="product-add-btn" onclick="event.stopPropagation(); window.newInvoiceModal.addProductFromList('${product.product_id}')">
                                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 4px;">
                                                <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                                            </svg>
                                            Add
                                        </button>
                                    `}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
                
                // Add click listeners for product items
                allProductsList.querySelectorAll('.product-list-item:not(.out-of-stock)').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.product-list-actions')) return;
                        const productId = item.dataset.productId;
                        if (this.selectedProducts.some(p => p.id === productId)) {
                            this.removeProductFromList(productId);
                        } else {
                            this.addProductFromList(productId);
                        }
                    });
                });
            }
            
            addProductFromList(productId) {
                const product = this.productsData.find(p => p.product_id === productId);
                if (!product) return;
                
                // Check if product is out of stock
                if (product.quantity_on_hand <= 0) {
                    this.showNotification('Out of Stock', 'This product is currently out of stock.');
                    return;
                }
                
                const quantityInput = document.querySelector(`.product-quantity-input[data-product-id="${productId}"]`);
                const quantity = quantityInput ? parseInt(quantityInput.value) || 1 : 1;
                
                const storeId = invoiceManager.currentStoreFilter;
                const sellingPrice = this.getSellingPrice(product, storeId);
                
                // Add to selected products
                this.selectedProducts.push({
                    id: product.product_id,
                    name: product.product_name,
                    sku: product.sku,
                    price: sellingPrice,
                    quantity: quantity,
                    description: product.description || ''
                });
                
                // Update displays
                this.displayAllProducts();
                this.updateSelectedProductsSummary();
                this.calculateSummary();
                
                // Show selected products summary
                const summarySection = document.getElementById('selectedProductsSummary');
                if (summarySection && this.selectedProducts.length > 0) {
                    summarySection.style.display = 'block';
                }
            }
            
            removeProductFromList(productId) {
                this.selectedProducts = this.selectedProducts.filter(p => p.id !== productId);
                
                // Update displays
                this.displayAllProducts();
                this.updateSelectedProductsSummary();
                this.calculateSummary();
                
                // Hide selected products summary if empty
                const summarySection = document.getElementById('selectedProductsSummary');
                if (summarySection && this.selectedProducts.length === 0) {
                    summarySection.style.display = 'none';
                }
            }
            
            incrementQuantity(productId) {
                const product = this.selectedProducts.find(p => p.id === productId);
                if (product) {
                    const productData = this.productsData.find(p => p.product_id === productId);
                    const maxQuantity = productData?.quantity_on_hand || 999;
                    if (product.quantity < maxQuantity) {
                        product.quantity++;
                        this.displayAllProducts();
                        this.updateSelectedProductsSummary();
                        this.calculateSummary();
                    }
                }
            }
            
            decrementQuantity(productId) {
                const product = this.selectedProducts.find(p => p.id === productId);
                if (product && product.quantity > 1) {
                    product.quantity--;
                    this.displayAllProducts();
                    this.updateSelectedProductsSummary();
                    this.calculateSummary();
                }
            }
            
            updateQuantityFromList(productId, newQuantity) {
                const quantity = parseInt(newQuantity) || 1;
                const product = this.selectedProducts.find(p => p.id === productId);
                
                if (product) {
                    product.quantity = quantity;
                    this.updateSelectedProductsSummary();
                    this.calculateSummary();
                }
            }
            
            getSellingPrice(product, storeId) {
                console.log('=== getSellingPrice() called ===');
                console.log('Product:', product);
                console.log('Store ID:', storeId);
                console.log('Product keys:', Object.keys(product));
                console.log('Product.prices:', product.prices);
                console.log('Product.default_selling_price:', product.default_selling_price);
                console.log('Product.selling_price:', product.selling_price);
                console.log('Product.price:', product.price);
                
                // Try to find store-specific price
                if (product.prices && Array.isArray(product.prices)) {
                    console.log('Found prices array:', product.prices);
                    const storePrice = product.prices.find(p => p.store_id === storeId);
                    console.log('Store price found:', storePrice);
                    if (storePrice && storePrice.selling_price) {
                        console.log('Using store-specific price:', storePrice.selling_price);
                        return storePrice.selling_price;
                    }
                }
                
                // Check for various price fields - FIXED to match RPC structure
                let fallbackPrice = 0;
                
                // Primary: Check pricing object (matches RPC structure)
                if (product.pricing && typeof product.pricing === 'object') {
                    console.log('Found pricing object:', product.pricing);
                    fallbackPrice = product.pricing.selling_price || product.pricing.cost_price || 0;
                    console.log('Extracted from pricing object:', fallbackPrice);
                }
                
                // Secondary: Check direct price fields
                if (fallbackPrice === 0) {
                    fallbackPrice = product.default_selling_price || 
                                  product.selling_price || 
                                  product.price || 
                                  product.unit_price || 
                                  product.base_price || 
                                  0;
                    console.log('Extracted from direct fields:', fallbackPrice);
                }
                
                console.log('Final price used:', fallbackPrice);
                console.log('=== getSellingPrice() completed ===');
                
                return fallbackPrice;
            }
            
            updateSelectedProductsSummary() {
                const container = document.getElementById('selectedSummaryList');
                const countElement = document.getElementById('selectedCount');
                const summarySection = document.getElementById('selectedProductsSummary');
                
                if (!container) return;
                
                // Update count
                if (countElement) {
                    const totalQuantity = this.selectedProducts.reduce((sum, p) => sum + p.quantity, 0);
                    countElement.textContent = `${totalQuantity} items`;
                }
                
                // Show/hide summary section
                if (summarySection) {
                    summarySection.style.display = this.selectedProducts.length > 0 ? 'block' : 'none';
                }
                
                if (this.selectedProducts.length === 0) {
                    container.innerHTML = '';
                    return;
                }
                
                // Render selected products summary with quantity controls
                container.innerHTML = this.selectedProducts.map(product => {
                    const currency = currentCurrencyInfo?.symbol || '₫';
                    return `
                        <div class="selected-summary-item">
                            <div class="selected-summary-info">
                                <div class="selected-summary-sku">SKU: ${product.sku || 'N/A'}</div>
                                <div class="selected-summary-name">${product.name}</div>
                                <div class="selected-summary-price">${currency}${new Intl.NumberFormat('ko-KR').format(product.price)}</div>
                            </div>
                            <div class="selected-summary-controls">
                                <div class="quantity-control-group">
                                    <button class="quantity-control-btn minus" 
                                        onclick="window.newInvoiceModal.decrementQuantity('${product.id}')" 
                                        ${product.quantity <= 1 ? 'disabled' : ''}>
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M19,13H5V11H19V13Z"/>
                                        </svg>
                                    </button>
                                    <input type="number" 
                                        class="quantity-control-input" 
                                        value="${product.quantity}" 
                                        min="1" 
                                        data-product-id="${product.id}"
                                        onchange="window.newInvoiceModal.updateQuantityFromList('${product.id}', this.value)"
                                        readonly>
                                    <button class="quantity-control-btn plus" 
                                        onclick="window.newInvoiceModal.incrementQuantity('${product.id}')">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                                        </svg>
                                    </button>
                                </div>
                                <button class="selected-summary-remove" onclick="window.newInvoiceModal.removeProductFromList('${product.id}')" title="Remove product">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            renderSelectedProducts() {
                const container = document.getElementById('selectedProductsList');
                
                if (!container) {
                    // If container doesn't exist, just return
                    return;
                }
                
                if (this.selectedProducts.length === 0) {
                    container.innerHTML = '';
                    return;
                }
                
                container.innerHTML = this.selectedProducts.map(product => `
                    <div class="selected-product-item">
                        <div class="selected-product-info">
                            <div class="selected-product-name">${product.name}</div>
                            <div class="selected-product-details">
                                ${product.description} • ${this.formatAmount(product.price)} each
                            </div>
                        </div>
                        <div class="selected-product-controls">
                            <div class="quantity-controls">
                                <button type="button" class="quantity-btn" onclick="window.newInvoiceModal.updateProductQuantity('${product.id}', ${product.quantity - 1})" ${product.quantity <= 1 ? 'disabled' : ''}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,13H5V11H19V13Z"/>
                                    </svg>
                                </button>
                                <input type="number" class="quantity-input" value="${product.quantity}" min="1" onchange="window.newInvoiceModal.updateProductQuantity('${product.id}', parseInt(this.value))">
                                <button type="button" class="quantity-btn" onclick="window.newInvoiceModal.updateProductQuantity('${product.id}', ${product.quantity + 1})">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                                    </svg>
                                </button>
                            </div>
                            <button type="button" class="remove-product-btn" onclick="window.newInvoiceModal.removeProduct('${product.id}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            formatAmount(amount) {
                // For zero values, return with currency symbol if available
                if (amount === 0) {
                    const symbol = currentCurrencyInfo?.symbol || '';
                    return symbol ? `${symbol}0` : '0';
                }
                
                // For non-zero values, format with commas and currency symbol
                const formatted = new Intl.NumberFormat('ko-KR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: amount % 1 === 0 ? 0 : 2
                }).format(amount);
                
                const symbol = currentCurrencyInfo?.symbol || '';
                return symbol ? `${symbol}${formatted}` : formatted;
            }
            
            formatCurrency(amount, currency) {
                // For zero values, return with currency symbol if available
                if (amount === 0) {
                    const symbol = currentCurrencyInfo?.symbol || '';
                    return symbol ? `${symbol}0` : '0';
                }
                
                // For non-zero values, format with currency symbol
                const formatted = new Intl.NumberFormat('ko-KR', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: amount % 1 === 0 ? 0 : 2
                }).format(amount);
                
                const symbol = currentCurrencyInfo?.symbol || '';
                return symbol ? `${symbol}${formatted}` : formatted;
            }
            
            
            updateFormValidation() {
                const submitBtn = document.getElementById('createInvoiceBtn');
                const productSearch = document.getElementById('productSearch');
                
                // Check for elements before accessing properties
                if (!submitBtn) return; // Exit early if submit button not found
                
                const hasProducts = this.selectedProducts.length > 0;
                
                // For multi-payment system, check if we have any payment methods
                const hasPaymentMethods = this.paymentMethods.length > 0;
                
                // Check if total received covers the invoice total
                const productsTotal = this.selectedProducts.reduce((total, product) => {
                    return total + (product.price * product.quantity);
                }, 0);
                
                const totalReceived = this.calculateTotalFromPaymentMethods();
                const hasValidPayment = totalReceived >= productsTotal;
                
                const isValid = hasProducts && hasPaymentMethods && hasValidPayment;
                
                submitBtn.disabled = !isValid;
                
                // Update product search field requirement
                if (productSearch) {
                    if (hasProducts) {
                        productSearch.removeAttribute('required');
                    } else {
                        productSearch.setAttribute('required', 'required');
                    }
                }
            }
            
            async handleSubmit() {
                const submitBtn = document.getElementById('createInvoiceBtn');
                const originalText = submitBtn ? submitBtn.innerHTML : '';
                
                try {
                    
                    // Show loading state
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = `
                        <svg class="loading-spinner" width="18" height="18" viewBox="0 0 50 50">
                            <circle cx="25" cy="25" r="20" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-dasharray="31.416" stroke-dashoffset="31.416">
                                <animate attributeName="stroke-dasharray" dur="2s" values="0 31.416;15.708 15.708;0 31.416" repeatCount="indefinite"/>
                                <animate attributeName="stroke-dashoffset" dur="2s" values="0;-15.708;-31.416" repeatCount="indefinite"/>
                            </circle>
                        </svg>
                        Creating...
                    `;
                    
                    // Prepare invoice data
                    let amountReceived = 0;
                    
                    // Use appropriate amount based on location type
                    if (this.selectedCashLocation) {
                        if (this.selectedCashLocation.type === 'bank') {
                            // For bank locations, use amount received input
                            amountReceived = parseFloat(document.getElementById('amountReceived').value) || 0;
                        } else {
                            // For all non-bank locations, use grand total from all currencies
                            amountReceived = this.calculateGrandTotalFromAllCurrencies();
                        }
                    } else {
                        // Even without cash location, use currency data if available
                        amountReceived = this.calculateGrandTotalFromAllCurrencies();
                    }
                    
                    // Get required parameters for RPC call
                    const companyId = appState.getSelectedCompanyId();
                    const storeId = invoiceManager.currentStoreFilter;
                    
                    // Get current user ID from AuthManager or supabase session
                    let userId = null;
                    if (typeof AuthManager !== 'undefined' && AuthManager.currentUser) {
                        userId = AuthManager.currentUser.id;
                    } else if (typeof supabase !== 'undefined' && supabase.auth) {
                        const { data: { user } } = await supabase.auth.getUser();
                        userId = user?.id;
                    }
                    
                    console.log('User ID retrieved:', userId);
                    console.log('Company ID:', companyId);
                    console.log('Store ID:', storeId);
                    
                    if (!companyId || !storeId || !userId) {
                        throw new Error('Missing required company, store, or user information');
                    }
                    
                    if (!this.selectedProducts || this.selectedProducts.length === 0) {
                        throw new Error('No products selected');
                    }
                    
                    // Determine primary payment method
                    let primaryPaymentMethod = 'cash'; // default
                    if (this.paymentMethods && this.paymentMethods.length > 0) {
                        // Use the first payment method type as primary
                        primaryPaymentMethod = this.paymentMethods[0].type || 'cash';
                    }
                    
                    // Calculate discount amount for RPC
                    const productsSubtotal = this.selectedProducts.reduce((total, product) => {
                        return total + (product.price * product.quantity);
                    }, 0);
                    
                    let discountAmount = 0;
                    if (this.discountType === 'amount') {
                        discountAmount = this.discountAmount || 0;
                    } else if (this.discountType === 'percent') {
                        discountAmount = productsSubtotal * ((this.discountPercent || 0) / 100);
                    }
                    
                    // Prepare RPC parameters
                    const rpcParams = {
                        p_company_id: companyId,
                        p_store_id: storeId,
                        p_created_by: userId,
                        p_sale_date: new Date().toISOString(),
                        p_items: this.selectedProducts.map(product => ({
                            product_id: product.id,
                            quantity: product.quantity,
                            unit_price: product.price
                        })),
                        p_payment_method: primaryPaymentMethod,
                        p_tax_rate: 0, // Default tax rate
                        p_notes: `Multi-payment invoice. Total received: ${amountReceived}`
                    };
                    
                    // Add discount if applicable (cannot use both total discount and item discounts)
                    if (discountAmount > 0) {
                        rpcParams.p_discount_amount = discountAmount;
                    }
                    
                    console.log('Creating invoice with RPC params:', rpcParams);
                    
                    // Call the inventory_create_invoice RPC function
                    const response = await supabase.rpc('inventory_create_invoice', rpcParams);
                    
                    console.log('RPC Response:', response);
                    console.log('RPC Response Data:', response.data);
                    console.log('RPC Response Error:', response.error);
                    console.log('RPC Response Status:', response.status);
                    
                    // Handle response - check for network/transport errors first
                    if (response.error) {
                        console.error('Network/Transport Error:', response.error);
                        throw new Error(`RPC Error: ${response.error.message}`);
                    }
                    
                    // Check HTTP status
                    if (response.status !== 200) {
                        console.error('HTTP Error Status:', response.status);
                        throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = response.data;
                    console.log('Parsed Result:', result);
                    console.log('Result Type:', typeof result);
                    console.log('Result Success:', result?.success);
                    
                    // Check if result is null or undefined
                    if (!result) {
                        console.error('RPC returned null/undefined data');
                        throw new Error('No data returned from invoice creation');
                    }
                    
                    // Check if RPC function returned success=false
                    if (result.success === false) {
                        console.error('RPC function returned success=false:', result.message);
                        throw new Error(result.message || 'Invoice creation failed');
                    }
                    
                    // Check if result doesn't have success field (unexpected format)
                    if (typeof result.success === 'undefined') {
                        console.error('Unexpected response format - no success field:', result);
                        throw new Error('Unexpected response format from server');
                    }
                    
                    // Show success message with invoice details
                    let successMessage = `Invoice created successfully!\n\nInvoice Number: ${result.invoice_number}\nTotal Amount: ${currentCurrencyInfo?.symbol || '$'}${new Intl.NumberFormat('ko-KR').format(result.total_amount)}`;
                    
                    // Show warnings if any
                    if (result.warnings && result.warnings.length > 0) {
                        successMessage += '\n\nWarnings:';
                        result.warnings.forEach(warning => {
                            if (warning.type === 'negative_stock') {
                                successMessage += `\n• ${warning.product}: Stock will be negative (${warning.stock_after})`;
                            } else if (warning.type === 'price_below_minimum') {
                                successMessage += `\n• ${warning.product}: Price below minimum (${warning.unit_price} < ${warning.min_price})`;
                            }
                        });
                    }
                    
                    // Show centered success dialog
                    console.log('=== CALLING showSuccessDialog ===');
                    console.log('Invoice Number:', result.invoice_number);
                    console.log('Total Amount:', result.total_amount);
                    console.log('Currency:', currentCurrencyInfo?.symbol || '$');
                    console.log('Warnings:', result.warnings || []);
                    
                    this.showSuccessDialog({
                        title: 'Invoice Created Successfully!',
                        invoiceNumber: result.invoice_number,
                        totalAmount: result.total_amount,
                        currency: currentCurrencyInfo?.symbol || '$',
                        warnings: result.warnings || []
                    });
                    
                    console.log('=== showSuccessDialog CALLED ===');
                    
                    // Close modal after a brief delay to let success dialog show first
                    setTimeout(() => {
                        console.log('Closing invoice modal...');
                        this.close();
                    }, 100);
                    
                    // Refresh invoice list after a longer delay to ensure modal is closed
                    setTimeout(() => {
                        console.log('Refreshing invoice list after successful creation...');
                        console.log('invoiceManager:', typeof invoiceManager !== 'undefined' ? 'available' : 'not available');
                        console.log('currentStoreFilter:', invoiceManager?.currentStoreFilter);
                        
                        if (typeof invoiceManager !== 'undefined' && typeof invoiceManager.loadInvoicesForStore === 'function') {
                            const storeId = invoiceManager.currentStoreFilter;
                            if (storeId) {
                                console.log('Loading invoices for store:', storeId);
                                invoiceManager.loadInvoicesForStore(storeId);
                            } else {
                                console.warn('No store filter available, reloading page');
                                window.location.reload();
                            }
                        } else {
                            console.warn('invoiceManager not available for refresh, reloading page');
                            // Trigger a page reload as fallback
                            window.location.reload();
                        }
                    }, 800);
                    
                } catch (error) {
                    console.error('Error creating invoice:', error);
                    
                    // Provide specific error messages based on error type
                    let errorMessage = 'Error creating invoice. Please try again.';
                    
                    if (error.message.includes('Missing required company, store, or user information')) {
                        errorMessage = 'Session error: Please log out and log back in.';
                    } else if (error.message.includes('No products selected')) {
                        errorMessage = 'Please select at least one product to create an invoice.';
                    } else if (error.message.includes('RPC Error')) {
                        errorMessage = `Database error: ${error.message.replace('RPC Error: ', '')}`;
                    } else if (error.message.includes('Invoice creation failed')) {
                        errorMessage = 'Invoice creation failed. Please check the details and try again.';
                    } else if (error.message.includes('Cannot apply both total discount and item discounts')) {
                        errorMessage = 'Discount error: Cannot use both total discount and item-level discounts.';
                    } else if (error.message.includes('Product not found')) {
                        errorMessage = 'One or more selected products are no longer available.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    alert(errorMessage);
                } finally {
                    // Restore button state
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                }
            }
            
            async open() {
                // Ensure currency info is loaded
                if (!currentCurrencyInfo) {
                    const companyId = appState.getSelectedCompanyId();
                    if (companyId) {
                        console.log('Currency info not loaded, fetching...');
                        await getCurrencyInfo(companyId);
                    }
                }
                
                // Ensure cash locations are loaded
                if (!cashLocationsData || cashLocationsData.length === 0) {
                    const companyId = appState.getSelectedCompanyId();
                    if (companyId) {
                        console.log('Cash locations not loaded, fetching...');
                        await getCashLocations(companyId);
                        // Reload the dropdown with new data
                        this.loadCashLocations();
                    }
                }
                
                // Ensure products are loaded
                if (!this.isProductsLoaded) {
                    await this.loadProductsData();
                }
                
                this.reset();
                
                // Ensure modal element exists
                if (!this.modal) {
                    console.error('Modal element not found');
                    return;
                }
                
                this.modal.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // Display all products list
                this.displayAllProducts();
                
                // Focus first input
                setTimeout(() => {
                    const firstInput = this.modal.querySelector('input:not([readonly])');
                    if (firstInput) {
                        firstInput.focus();
                    }
                }, 300);
            }
            
            close() {
                this.modal.classList.remove('active');
                document.body.style.overflow = '';
                this.hideSearchDropdown();
            }
            
            reset() {
                // Reset form safely
                if (this.form) {
                    this.form.reset();
                }
                
                // Clear selected products
                this.selectedProducts = [];
                
                // Update displays safely
                if (typeof this.renderSelectedProducts === 'function') {
                    this.renderSelectedProducts();
                }
                if (typeof this.updateSelectedProductsSummary === 'function') {
                    this.updateSelectedProductsSummary();
                }
                
                // Display all products if loaded
                if (this.isProductsLoaded && typeof this.displayAllProducts === 'function') {
                    this.displayAllProducts();
                }
                
                // Reset multi-step flow
                this.currentStep = 1;
                this.updateStepDisplay();
                
                // Reset discount
                this.discountAmount = 0;
                this.discountPercent = 0;
                this.discountType = 'amount';
                
                // Reset cash count values
                this.cashCountTotal = 0;
                this.denominationValues = {};
                this.currencyAmountData = {}; // Clear all saved amount data
                this.selectedCurrency = null; // Reset selected currency
                
                // Reset payment methods
                this.paymentMethods = [];
                this.currentAddPaymentType = 'cash';
                this.currentAddPaymentLocation = null;
                this.currentAddPaymentCurrencies = {};
                this.renderPaymentMethodsList();
                
                // Reset cash location display
                const cashLocationSelect = document.getElementById('cashLocationSelect');
                const cashLocationInput = document.getElementById('cashLocation');
                const paymentMethodInfo = document.getElementById('paymentMethodInfo');
                
                if (cashLocationSelect && cashLocationInput) {
                    const valueSpan = cashLocationSelect.querySelector('.toss-select-value');
                    valueSpan.textContent = 'Select cash location...';
                    valueSpan.classList.add('toss-select-placeholder');
                    cashLocationInput.value = '';
                    this.selectedCashLocation = null;
                }
                
                // Hide payment method info
                if (paymentMethodInfo) {
                    paymentMethodInfo.style.display = 'none';
                }
                
                // Hide currency and denomination section
                const currencySection = document.getElementById('currencyDenominationSection');
                if (currencySection) {
                    currencySection.style.display = 'none';
                }
                this.selectedCurrency = null;
                
                // Hide amount received section
                const amountSection = document.getElementById('amountReceivedSection');
                if (amountSection) {
                    amountSection.style.display = 'none';
                }
                
                // Hide invoice summary
                const invoiceSummary = document.getElementById('invoiceSummary');
                if (invoiceSummary) {
                    invoiceSummary.style.display = 'none';
                }
                
                // Reset form validation - safely
                try {
                    this.updateFormValidation();
                } catch (error) {
                    console.warn('Form validation error during reset (expected during initialization):', error);
                }
                
                // Clear search dropdown
                this.hideSearchDropdown();
                
                // Reload cash locations
                this.loadCashLocations();
            }
            
            // Discount-related methods
            handleDiscountTypeChange() {
                const discountType = document.querySelector('input[name="discountType"]:checked')?.value || 'none';
                this.currentDiscountType = discountType;

                // Show/hide invoice discount input
                const invoiceDiscountGroup = document.getElementById('invoiceDiscountGroup');
                if (invoiceDiscountGroup) {
                    invoiceDiscountGroup.style.display = discountType === 'invoice' ? 'block' : 'none';
                }

                // Update selected products display to show/hide item discount inputs
                this.updateSelectedProductsDisplay();

                // Recalculate summary
                this.calculateSummary();
            }

            updateProductDiscount(productId, discount) {
                const product = this.selectedProducts.find(p => p.id === productId);
                if (product) {
                    product.discount = Math.max(0, parseFloat(discount) || 0);
                    this.calculateSummary();
                }
            }
            
            updateSelectedProductsDisplay() {
                const container = document.getElementById('selectedProducts');
                if (!container) return;

                if (this.selectedProducts.length === 0) {
                    container.innerHTML = '<div class="no-products-selected">No products selected</div>';
                    return;
                }

                const showItemDiscounts = this.currentDiscountType === 'item';

                container.innerHTML = this.selectedProducts.map(product => `
                    <div class="selected-product-item" data-product-id="${product.id}">
                        <div class="product-info">
                            <div class="product-name">${product.name}</div>
                            <div class="product-price">${product.description} • ${currentCurrencyInfo?.symbol || '$'}${product.price} each</div>
                        </div>
                        <div class="product-controls">
                            <div class="control-group">
                                <label class="control-label">Qty</label>
                                <input 
                                    type="number" 
                                    class="quantity-input" 
                                    value="${product.quantity}" 
                                    min="1" 
                                    onchange="window.newInvoiceModal.updateProductQuantity('${product.id}', this.value)">
                            </div>
                            ${showItemDiscounts ? `
                                <div class="control-group">
                                    <label class="control-label">Discount</label>
                                    <input 
                                        type="number" 
                                        class="product-discount-input" 
                                        value="${product.discount || 0}" 
                                        min="0" 
                                        step="0.01"
                                        placeholder="0"
                                        onchange="window.newInvoiceModal.updateProductDiscount('${product.id}', this.value)">
                                </div>
                            ` : ''}
                            <button 
                                type="button" 
                                class="remove-product-btn" 
                                onclick="window.newInvoiceModal.removeProduct('${product.id}')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            removeProduct(productId) {
                this.selectedProducts = this.selectedProducts.filter(p => p.id !== productId);
                this.updateSelectedProductsDisplay();
                this.calculateSummary();
            }

            calculateSummary() {
                let subtotal = 0;
                let totalItemDiscount = 0;

                // Calculate subtotal and item discounts
                this.selectedProducts.forEach(product => {
                    const productTotal = product.price * product.quantity;
                    subtotal += productTotal;

                    if (this.currentDiscountType === 'item' && product.discount) {
                        totalItemDiscount += product.discount;
                    }
                });

                // Get tax rate and invoice discount
                const taxRate = parseFloat(document.getElementById('taxRateInput')?.value || 0) / 100;
                const invoiceDiscount = this.currentDiscountType === 'invoice' 
                    ? parseFloat(document.getElementById('invoiceDiscountInput')?.value || 0) 
                    : 0;

                // Calculate final amounts
                const subtotalAfterItemDiscount = subtotal - totalItemDiscount;
                const subtotalAfterInvoiceDiscount = subtotalAfterItemDiscount - invoiceDiscount;
                const taxAmount = subtotalAfterInvoiceDiscount * taxRate;
                const total = subtotalAfterInvoiceDiscount + taxAmount;

                // Update summary display
                this.updateSummaryDisplay(subtotal, totalItemDiscount, invoiceDiscount, taxAmount, total);
            }

            updateSummaryDisplay(subtotal, itemDiscount, invoiceDiscount, taxAmount, total) {
                const summaryContainer = document.getElementById('invoiceSummary');
                if (!summaryContainer) return;

                const currency = currentCurrencyInfo?.symbol || '$';
                const formatNumber = (num) => new Intl.NumberFormat('ko-KR').format(num);

                // Show summary if there are products
                if (this.selectedProducts.length > 0) {
                    summaryContainer.style.display = 'block';

                    // Update basic amounts
                    const subtotalEl = document.getElementById('subtotalAmount');
                    if (subtotalEl) subtotalEl.textContent = `${currency}${formatNumber(subtotal)}`;

                    const taxEl = document.getElementById('taxAmount');
                    if (taxEl) {
                        taxEl.textContent = `${currency}${formatNumber(taxAmount)}`;
                        taxEl.parentElement.style.display = taxAmount > 0 ? 'flex' : 'none';
                    }

                    const totalEl = document.getElementById('totalAmount');
                    if (totalEl) totalEl.textContent = `${currency}${formatNumber(total)}`;

                    // Add discount rows dynamically
                    this.updateDiscountRows(itemDiscount, invoiceDiscount, currency, formatNumber);
                } else {
                    summaryContainer.style.display = 'none';
                }
            }

            updateDiscountRows(itemDiscount, invoiceDiscount, currency, formatNumber) {
                const summaryContainer = document.getElementById('invoiceSummary');
                
                // Remove existing discount rows
                summaryContainer.querySelectorAll('.summary-row.discount').forEach(row => row.remove());

                // Add item discount row if applicable
                if (itemDiscount > 0) {
                    const itemDiscountRow = document.createElement('div');
                    itemDiscountRow.className = 'summary-row discount';
                    itemDiscountRow.innerHTML = `
                        <span>Item Discounts:</span>
                        <span>-${currency}${formatNumber(itemDiscount)}</span>
                    `;
                    // Insert before tax row
                    const taxRow = document.querySelector('.summary-row:has(#taxAmount)');
                    if (taxRow) {
                        summaryContainer.insertBefore(itemDiscountRow, taxRow);
                    } else {
                        summaryContainer.insertBefore(itemDiscountRow, summaryContainer.children[1]);
                    }
                }

                // Add invoice discount row if applicable
                if (invoiceDiscount > 0) {
                    const invoiceDiscountRow = document.createElement('div');
                    invoiceDiscountRow.className = 'summary-row discount';
                    invoiceDiscountRow.innerHTML = `
                        <span>Invoice Discount:</span>
                        <span>-${currency}${formatNumber(invoiceDiscount)}</span>
                    `;
                    // Insert before tax row
                    const taxRow = document.querySelector('.summary-row:has(#taxAmount)');
                    if (taxRow) {
                        summaryContainer.insertBefore(invoiceDiscountRow, taxRow);
                    } else {
                        summaryContainer.insertBefore(invoiceDiscountRow, summaryContainer.children[1]);
                    }
                }
            }

            getInvoiceDataForRPC() {
                const companyId = appState.getSelectedCompanyId();
                const stores = appState.getCompanyStores();
                const currentStore = stores && stores.length > 0 ? stores[0] : null;
                
                // Get current user ID from AuthManager or supabase session
                let userId = null;
                if (typeof AuthManager !== 'undefined' && AuthManager.currentUser) {
                    userId = AuthManager.currentUser.id;
                } else if (typeof supabase !== 'undefined' && supabase.auth) {
                    // Note: This is synchronous access, may not have latest user data
                    const session = supabase.auth.session();
                    userId = session?.user?.id;
                }

                if (!companyId || !currentStore || !userId) {
                    throw new Error('Missing required company, store, or user information');
                }

                // Prepare items array according to RPC specification
                const items = this.selectedProducts.map(product => {
                    const itemData = {
                        product_id: product.product_id,
                        quantity: product.quantity,
                        selling_price: product.selling_price
                    };

                    // Add item-level discount if applicable
                    if (this.currentDiscountType === 'item' && product.discount > 0) {
                        itemData.discount_amount = product.discount;
                    }

                    return itemData;
                });

                // Prepare main invoice data
                const invoiceData = {
                    p_company_id: companyId,
                    p_store_id: currentStore.store_id,
                    p_created_by: userId,
                    p_sale_date: new Date().toISOString().split('T')[0], // Today's date in YYYY-MM-DD format
                    p_items: items
                };

                // Add optional parameters
                const customerSelect = document.getElementById('customerSelect');
                if (customerSelect?.value) {
                    invoiceData.p_customer_id = customerSelect.value;
                }

                // Determine payment method based on cash location type
                if (this.selectedCashLocation) {
                    const locationType = this.selectedCashLocation.type?.toLowerCase();
                    if (locationType === 'cash' || locationType === 'vault') {
                        invoiceData.p_payment_method = 'cash';
                    } else if (locationType === 'bank') {
                        invoiceData.p_payment_method = 'bank_transfer';
                    } else {
                        // Default fallback
                        invoiceData.p_payment_method = 'cash';
                    }
                } else {
                    // Default if no cash location selected
                    invoiceData.p_payment_method = 'cash';
                }

                const taxRateInput = document.getElementById('taxRateInput');
                if (taxRateInput?.value && parseFloat(taxRateInput.value) > 0) {
                    invoiceData.p_tax_rate = parseFloat(taxRateInput.value) / 100; // Convert percentage to decimal
                }

                // Add invoice-level discount if applicable
                if (this.currentDiscountType === 'invoice') {
                    const invoiceDiscountInput = document.getElementById('invoiceDiscountInput');
                    if (invoiceDiscountInput?.value && parseFloat(invoiceDiscountInput.value) > 0) {
                        invoiceData.p_discount_amount = parseFloat(invoiceDiscountInput.value);
                    }
                }

                // Add notes if any (could be extended later)
                const notes = [];
                if (this.currentDiscountType === 'item') {
                    const discountedItems = this.selectedProducts.filter(p => p.discount > 0);
                    if (discountedItems.length > 0) {
                        notes.push(`Item discounts applied to ${discountedItems.length} product(s)`);
                    }
                }
                if (notes.length > 0) {
                    invoiceData.p_notes = notes.join('; ');
                }

                return invoiceData;
            }
            
            // === MULTI-PAYMENT METHODS FUNCTIONS ===
            
            showAddPaymentModal() {
                console.log('=== showAddPaymentModal() called ===', new Date().toISOString());
                const modal = document.getElementById('addPaymentModal');
                console.log('Modal element:', modal);
                console.log('Modal display style:', modal?.style.display);
                console.log('Modal active?', modal?.classList.contains('active'));
                
                if (modal) {
                    // Force-clear any stuck state first
                    if (modal.classList.contains('active')) {
                        console.log('Modal was stuck in active state, clearing...');
                        modal.classList.remove('active');
                        modal.style.display = 'none';
                        this.removeAddPaymentModalEventHandlers();
                    }
                    
                    console.log('Opening modal...');
                    modal.style.display = 'flex';
                    modal.classList.add('active');
                    console.log('Modal display after setting to flex:', modal.style.display);
                    console.log('Modal classList after adding active:', modal.classList.toString());
                    
                    // Reset modal state
                    console.log('Resetting modal state...');
                    this.resetAddPaymentModal();
                    
                    // Set up event handlers to prevent interference with main modal
                    console.log('Setting up event handlers...');
                    this.setupAddPaymentModalEventHandlers();
                    
                    console.log('Modal opened successfully');
                    
                    // Verify modal is visible
                    setTimeout(() => {
                        console.log('=== Modal visibility check (100ms later) ===');
                        console.log('Modal display:', modal.style.display);
                        console.log('Modal active class:', modal.classList.contains('active'));
                        console.log('Modal computed style display:', window.getComputedStyle(modal).display);
                        console.log('Modal computed style opacity:', window.getComputedStyle(modal).opacity);
                        console.log('Modal computed style visibility:', window.getComputedStyle(modal).visibility);
                        console.log('Modal computed style z-index:', window.getComputedStyle(modal).zIndex);
                        console.log('Modal getBoundingClientRect:', modal.getBoundingClientRect());
                    }, 100);
                    
                    // Don't auto-focus to prevent triggering dropdown buttons
                    // Let user manually interact with the modal
                } else {
                    console.error('Modal element not found! Looking for addPaymentModal...');
                    console.log('All modals in document:', document.querySelectorAll('[id*="modal"]'));
                }
            }
            
            closeAddPaymentModal() {
                console.log('=== closeAddPaymentModal() called ===', new Date().toISOString());
                console.trace('Call stack for closeAddPaymentModal:');
                
                const modal = document.getElementById('addPaymentModal');
                if (modal) {
                    console.log('Closing modal...');
                    modal.style.display = 'none';
                    modal.classList.remove('active');
                    
                    // Remove event handlers
                    console.log('Removing event handlers...');
                    this.removeAddPaymentModalEventHandlers();
                }
                console.log('Resetting modal...');
                this.resetAddPaymentModal();
                console.log('Modal closed successfully');
            }
            
            setupAddPaymentModalEventHandlers() {
                console.log('=== setupAddPaymentModalEventHandlers() called ===');
                const modal = document.getElementById('addPaymentModal');
                if (!modal) {
                    console.log('Modal not found in setupAddPaymentModalEventHandlers');
                    return;
                }
                
                // Prevent ALL event bubbling from the modal
                this.addPaymentModalIsolationHandler = (e) => {
                    console.log('Modal event isolation - stopping propagation for:', e.type);
                    e.stopPropagation();
                };
                modal.addEventListener('click', this.addPaymentModalIsolationHandler);
                modal.addEventListener('mousedown', this.addPaymentModalIsolationHandler);
                modal.addEventListener('mouseup', this.addPaymentModalIsolationHandler);
                console.log('Added modal isolation handlers');
                
                // Close modal when clicking outside (overlay)
                this.addPaymentModalOverlayHandler = (e) => {
                    console.log('Overlay clicked, target:', e.target, 'modal:', modal);
                    if (e.target === modal) {
                        console.log('Closing modal due to overlay click');
                        this.closeAddPaymentModal();
                    }
                };
                modal.addEventListener('click', this.addPaymentModalOverlayHandler);
                console.log('Added overlay click handler');
                
                // Prevent clicks inside modal content from bubbling up
                const modalContainer = modal.querySelector('.modal-container');
                if (modalContainer) {
                    this.addPaymentModalContentHandler = (e) => {
                        console.log('Modal content clicked, stopping propagation');
                        e.stopPropagation();
                    };
                    modalContainer.addEventListener('click', this.addPaymentModalContentHandler);
                    console.log('Added content click handler');
                }
                
                // Handle ESC key to close modal
                this.addPaymentModalEscHandler = (e) => {
                    if (e.key === 'Escape' && modal.classList.contains('active')) {
                        console.log('ESC key pressed, closing modal');
                        this.closeAddPaymentModal();
                    }
                };
                document.addEventListener('keydown', this.addPaymentModalEscHandler);
                console.log('Added ESC key handler');
                console.log('Event handlers setup complete');
            }
            
            removeAddPaymentModalEventHandlers() {
                const modal = document.getElementById('addPaymentModal');
                
                // Remove isolation handlers
                if (modal && this.addPaymentModalIsolationHandler) {
                    modal.removeEventListener('click', this.addPaymentModalIsolationHandler);
                    modal.removeEventListener('mousedown', this.addPaymentModalIsolationHandler);
                    modal.removeEventListener('mouseup', this.addPaymentModalIsolationHandler);
                    this.addPaymentModalIsolationHandler = null;
                }
                
                if (modal && this.addPaymentModalOverlayHandler) {
                    modal.removeEventListener('click', this.addPaymentModalOverlayHandler);
                    this.addPaymentModalOverlayHandler = null;
                }
                
                const modalContainer = modal?.querySelector('.modal-container');
                if (modalContainer && this.addPaymentModalContentHandler) {
                    modalContainer.removeEventListener('click', this.addPaymentModalContentHandler);
                    this.addPaymentModalContentHandler = null;
                }
                
                if (this.addPaymentModalEscHandler) {
                    document.removeEventListener('keydown', this.addPaymentModalEscHandler);
                    this.addPaymentModalEscHandler = null;
                }
            }
            
            resetAddPaymentModal() {
                console.log('=== resetAddPaymentModal() called ===');
                this.currentAddPaymentType = null;
                this.currentAddPaymentLocation = null;
                this.currentAddPaymentCurrencies = {};
                
                // Close any existing cash location dropdown and clean up its handlers
                const existingMenu = document.querySelector('.cash-location-search-menu');
                if (existingMenu) {
                    console.log('Removing existing dropdown menu');
                    existingMenu.remove();
                    // The removal should trigger cleanup, but ensure no orphaned handlers remain
                }
                
                // Clear currency selection
                const currencySection = document.getElementById('currencyAmountsSection');
                if (currencySection) currencySection.style.display = 'none';
                
                // Clear amount input
                const amountInput = document.getElementById('addPaymentAmount');
                if (amountInput) amountInput.value = '';
                
                // Reset cash location
                const cashLocationSelect = document.getElementById('addPaymentCashLocationSelect');
                if (cashLocationSelect) {
                    const placeholder = cashLocationSelect.querySelector('.toss-select-value');
                    if (placeholder) {
                        placeholder.textContent = 'Select cash location...';
                        placeholder.classList.add('toss-select-placeholder');
                    }
                }
                
                // Hide payment type section initially
                const paymentTypeSection = document.getElementById('paymentTypeSection');
                if (paymentTypeSection) paymentTypeSection.style.display = 'none';
                
                // Hide cash location section initially  
                const cashLocationSection = document.getElementById('cashLocationSection');
                if (cashLocationSection) cashLocationSection.style.display = 'block';
                
                // Disable add button
                const addBtn = document.getElementById('addPaymentBtn');
                if (addBtn) addBtn.disabled = true;
            }
            
            
            openAddPaymentCashLocationSearch() {
                // Reuse existing cash location search functionality
                this.openCashLocationSearch(true); // Pass flag to indicate this is for add payment
            }
            
            populateAddPaymentCurrencies() {
                console.log('=== populateAddPaymentCurrencies() called ===');
                console.log('Current currency data before population:', this.currentAddPaymentCurrencies);
                const currencyContainer = document.getElementById('addPaymentCurrencies');
                console.log('Currency container found:', !!currencyContainer);
                console.log('Company currencies count:', companyCurrencies?.length);
                
                if (!currencyContainer) {
                    console.error('Currency container not found!');
                    return;
                }
                
                currencyContainer.innerHTML = '';
                
                if (companyCurrencies && companyCurrencies.length > 0) {
                    companyCurrencies.forEach((currency, index) => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.className = 'currency-btn';
                        btn.dataset.currencyCode = currency.currency_code;
                        
                        // Check if this currency has data and add visual indicator
                        const currentAmount = this.currentAddPaymentCurrencies[currency.currency_code];
                        const hasData = currentAmount && parseFloat(currentAmount) > 0;
                        
                        console.log(`Processing currency ${currency.currency_code}:`);
                        console.log(`  - Current amount:`, currentAmount);
                        console.log(`  - Has data:`, hasData);
                        
                        if (hasData) {
                            console.log(`  - Adding has-data class to ${currency.currency_code} button`);
                            btn.classList.add('has-data');
                            console.log(`  - Button classes after adding:`, btn.className);
                        } else {
                            console.log(`  - No data for ${currency.currency_code}, ensuring has-data class is removed`);
                            btn.classList.remove('has-data');
                        }
                        
                        // Auto-select first currency
                        if (index === 0) {
                            btn.classList.add('active');
                            this.selectAddPaymentCurrency(currency);
                        }
                        
                        btn.innerHTML = `
                            <span class="currency-flag">${currency.flag_emoji || '💵'}</span>
                            <span class="currency-code">${currency.currency_code}</span>
                            <span class="currency-symbol">${currency.symbol}</span>
                        `;
                        
                        btn.onclick = () => {
                            document.querySelectorAll('#addPaymentCurrencies .currency-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            this.selectAddPaymentCurrency(currency);
                        };
                        
                        currencyContainer.appendChild(btn);
                    });
                    
                    // Update total display
                    this.updateAddPaymentCurrencyTotal();
                }
            }
            
            selectAddPaymentCurrency(currency) {
                this.currentSelectedAddCurrency = currency;
                
                const currencyLabel = document.getElementById('addPaymentCurrencyLabel');
                const amountSection = document.getElementById('addPaymentAmountSection');
                const amountInput = document.getElementById('addPaymentAmount');
                
                if (currencyLabel) {
                    currencyLabel.textContent = currency.currency_code;
                }
                
                if (amountSection) {
                    amountSection.style.display = 'block';
                }
                
                // Set saved amount if any
                const savedAmount = this.currentAddPaymentCurrencies[currency.currency_code] || '';
                if (amountInput) {
                    if (savedAmount) {
                        amountInput.value = this.formatNumberWithCommas(savedAmount);
                    } else {
                        amountInput.value = '';
                    }
                    amountInput.placeholder = `Enter amount in ${currency.currency_code}`;
                }
                
                this.validateAddPaymentForm();
            }
            
            formatAddPaymentAmount(input) {
                console.log('=== formatAddPaymentAmount() called ===');
                console.log('Input value:', input.value);
                console.log('Current selected currency:', this.currentSelectedAddCurrency);
                
                // Remove all non-digits
                let value = input.value.replace(/[^0-9]/g, '');
                console.log('Cleaned value:', value);
                
                // Format with commas
                if (value) {
                    const formattedValue = this.formatNumberWithCommas(parseInt(value));
                    input.value = formattedValue;
                    console.log('Formatted value:', formattedValue);
                    
                    // Save the amount for current currency
                    if (this.currentSelectedAddCurrency) {
                        const rawValue = value;
                        const amount = parseFloat(rawValue) || 0;
                        console.log('Parsed amount:', amount);
                        
                        if (amount > 0) {
                            this.currentAddPaymentCurrencies[this.currentSelectedAddCurrency.currency_code] = amount;
                            console.log('Saved amount for', this.currentSelectedAddCurrency.currency_code, ':', amount);
                        } else {
                            delete this.currentAddPaymentCurrencies[this.currentSelectedAddCurrency.currency_code];
                            console.log('Removed amount for', this.currentSelectedAddCurrency.currency_code);
                        }
                        
                        console.log('Current currencies data:', this.currentAddPaymentCurrencies);
                        
                        // Update visual indicators for currencies with data
                        console.log('Updating visual indicators...');
                        this.updateCurrencyVisualIndicators();
                        this.updateAddPaymentCurrencyTotal();
                    }
                } else {
                    // Clear amount if input is empty
                    if (this.currentSelectedAddCurrency) {
                        delete this.currentAddPaymentCurrencies[this.currentSelectedAddCurrency.currency_code];
                        this.updateCurrencyVisualIndicators();
                        this.updateAddPaymentCurrencyTotal();
                    }
                }
                
                this.validateAddPaymentForm();
            }
            
            validateAddPaymentForm() {
                console.log('=== validateAddPaymentForm() called ===');
                const addBtn = document.getElementById('addPaymentBtn');
                if (!addBtn) {
                    console.error('Add payment button not found!');
                    return false;
                }
                
                let isValid = false;
                
                console.log('Current payment type:', this.currentAddPaymentType);
                console.log('Current location:', this.currentAddPaymentLocation);
                console.log('Current currencies:', this.currentAddPaymentCurrencies);
                console.log('Currency count:', Object.keys(this.currentAddPaymentCurrencies).length);
                
                if (this.currentAddPaymentType === 'cash') {
                    // For cash: need location selected and at least one currency amount
                    isValid = this.currentAddPaymentLocation && 
                             Object.keys(this.currentAddPaymentCurrencies).length > 0;
                    console.log('Cash validation - location valid:', !!this.currentAddPaymentLocation);
                    console.log('Cash validation - has currencies:', Object.keys(this.currentAddPaymentCurrencies).length > 0);
                } else if (this.currentAddPaymentType === 'bank') {
                    // For bank: need location selected and at least one currency amount  
                    isValid = this.currentAddPaymentLocation && 
                             Object.keys(this.currentAddPaymentCurrencies).length > 0;
                    console.log('Bank validation - location valid:', !!this.currentAddPaymentLocation);
                    console.log('Bank validation - has currencies:', Object.keys(this.currentAddPaymentCurrencies).length > 0);
                }
                
                console.log('Form valid:', isValid);
                console.log('Button will be:', isValid ? 'enabled' : 'disabled');
                
                addBtn.disabled = !isValid;
                return isValid;
            }
            
            updateCurrencyVisualIndicators() {
                console.log('=== updateCurrencyVisualIndicators() called ===');
                console.log('Current currency data:', this.currentAddPaymentCurrencies);
                console.log('Number of currency buttons found:', document.querySelectorAll('#addPaymentCurrencies .currency-btn').length);
                
                // Update visual indicators for currencies with data
                document.querySelectorAll('#addPaymentCurrencies .currency-btn').forEach((btn, index) => {
                    const currencyCode = btn.dataset.currencyCode;
                    const currentAmount = this.currentAddPaymentCurrencies[currencyCode];
                    const hasData = currentAmount && parseFloat(currentAmount) > 0;
                    
                    console.log(`Currency ${index + 1}: ${currencyCode}`);
                    console.log(`  - Current amount:`, currentAmount);
                    console.log(`  - Has data:`, hasData);
                    console.log(`  - Button element:`, btn);
                    console.log(`  - Current classes:`, btn.className);
                    
                    if (hasData) {
                        console.log(`  - Adding has-data class to ${currencyCode}`);
                        btn.classList.add('has-data');
                        console.log(`  - Classes after adding:`, btn.className);
                        
                        // Force refresh computed style
                        btn.offsetHeight;
                        
                        // Verify the class was actually added
                        if (btn.classList.contains('has-data')) {
                            console.log(`  - ✅ has-data class successfully added to ${currencyCode}`);
                        } else {
                            console.log(`  - ❌ has-data class FAILED to add to ${currencyCode}`);
                        }
                    } else {
                        console.log(`  - Removing has-data class from ${currencyCode}`);
                        btn.classList.remove('has-data');
                        console.log(`  - Classes after removing:`, btn.className);
                    }
                    
                    // Test CSS application
                    const computedStyle = window.getComputedStyle(btn);
                    console.log(`  - Computed border:`, computedStyle.border);
                    console.log(`  - Computed background:`, computedStyle.backgroundColor);
                    console.log(`  - Computed color:`, computedStyle.color);
                });
                
                console.log('=== updateCurrencyVisualIndicators() completed ===');
            }
            
            // Test function to manually verify CSS and class application
            testCurrencyVisualSystem() {
                console.log('=== TESTING CURRENCY VISUAL SYSTEM ===');
                
                // Get all currency buttons
                const buttons = document.querySelectorAll('#addPaymentCurrencies .currency-btn');
                console.log(`Found ${buttons.length} currency buttons`);
                
                if (buttons.length === 0) {
                    console.log('❌ No currency buttons found! Make sure currencies are populated.');
                    return;
                }
                
                // Test each button
                buttons.forEach((btn, index) => {
                    const currencyCode = btn.dataset.currencyCode;
                    console.log(`\n--- Testing Button ${index + 1}: ${currencyCode} ---`);
                    
                    // Test adding has-data class
                    console.log('Adding has-data class...');
                    btn.classList.add('has-data');
                    
                    // Check if class was added
                    const hasClass = btn.classList.contains('has-data');
                    console.log('Class added successfully:', hasClass);
                    console.log('Current classes:', btn.className);
                    
                    // Check computed styles
                    const computedStyle = window.getComputedStyle(btn);
                    console.log('Computed styles:');
                    console.log('  - Border:', computedStyle.border);
                    console.log('  - Background:', computedStyle.backgroundColor);
                    console.log('  - Color:', computedStyle.color);
                    
                    // Check for green color in border (look for #22c55e or its RGB equivalent)
                    const borderColor = computedStyle.borderColor || computedStyle.border;
                    const isGreenBorder = borderColor.includes('#22c55e') || 
                                         borderColor.includes('rgb(34, 197, 94)') ||
                                         borderColor.includes('34, 197, 94');
                    console.log('Has green border:', isGreenBorder);
                    console.log('Border color value:', borderColor);
                    
                    if (isGreenBorder) {
                        console.log('🎉 SUCCESS: Green border is visible!');
                    } else {
                        console.log('❌ FAILED: Green border is NOT visible');
                        console.log('Expected: #22c55e or rgb(34, 197, 94)');
                        console.log('Actual:', borderColor);
                    }
                    
                    // Keep the class applied for visual verification
                    // btn.classList.remove('has-data'); // Commented out so you can see the effect
                });
                
                console.log('\n=== CURRENCY VISUAL SYSTEM TEST COMPLETED ===');
                console.log('🔍 Check the currency buttons now - they should have GREEN BORDERS!');
            }
            
            // Force green border test - applies has-data class to all buttons
            forceGreenBorderTest() {
                console.log('🧪 FORCING GREEN BORDER TEST - Adding has-data class to ALL currency buttons');
                
                const buttons = document.querySelectorAll('#addPaymentCurrencies .currency-btn');
                console.log(`Found ${buttons.length} buttons to test`);
                
                buttons.forEach((btn, index) => {
                    btn.classList.add('has-data');
                    console.log(`✅ Added has-data class to button ${index + 1}`);
                });
                
                console.log('🔍 CHECK NOW: All currency buttons should have GREEN BORDERS and checkmarks!');
                console.log('If you still see black borders, the CSS fix did not work.');
            }
            
            // TEST FUNCTION - Verify pricing fix works
            testPricingFix() {
                console.log('🧪 === TESTING PRICING FIX ===');
                
                if (!this.productsData || this.productsData.length === 0) {
                    console.log('❌ No products loaded. Run this after opening the invoice modal.');
                    return;
                }
                
                // Test the SKU-009 "test" product specifically
                const testProduct = this.productsData.find(p => p.sku === 'SKU-009');
                
                if (testProduct) {
                    console.log('🎯 Found SKU-009 "test" product:');
                    console.log('   - Product name:', testProduct.product_name);
                    console.log('   - Pricing object:', testProduct.pricing);
                    console.log('   - Expected price: 1500 VND');
                    
                    const storeId = invoiceManager.currentStoreFilter;
                    const extractedPrice = this.getSellingPrice(testProduct, storeId);
                    
                    console.log('   - Extracted price:', extractedPrice);
                    console.log('   - Formatted price:', this.formatAmount(extractedPrice));
                    
                    if (extractedPrice === 1500) {
                        console.log('✅ SUCCESS: Pricing extraction works correctly!');
                    } else {
                        console.log('❌ FAILED: Expected 1500, got', extractedPrice);
                    }
                } else {
                    console.log('❌ SKU-009 "test" product not found in loaded data');
                    console.log('Available products:', this.productsData.map(p => `${p.sku}: ${p.product_name}`));
                }
                
                // Test all products with pricing
                console.log('\n📊 All products pricing summary:');
                this.productsData.forEach(product => {
                    const price = this.getSellingPrice(product, invoiceManager.currentStoreFilter);
                    console.log(`   ${product.sku} (${product.product_name}): ${this.formatAmount(price)}`);
                });
                
                console.log('🧪 === PRICING FIX TEST COMPLETED ===');
            }
            
            // DIAGNOSTIC FUNCTION - Test pricing data flow
            diagnosePricingIssue() {
                console.log('🔍 === PRICING DIAGNOSIS STARTING ===');
                
                // 1. Check if products data is loaded
                console.log('1. Products data status:');
                console.log('   - isProductsLoaded:', this.isProductsLoaded);
                console.log('   - productsData length:', this.productsData?.length || 'UNDEFINED');
                console.log('   - productsData sample:', this.productsData?.slice(0, 2) || 'NO DATA');
                
                if (!this.productsData || this.productsData.length === 0) {
                    console.log('❌ NO PRODUCTS DATA - This is the root cause!');
                    console.log('🔧 SOLUTION: Check the RPC call get_inventory_product_list_company');
                    return;
                }
                
                // 2. Check pricing fields for the first few products
                console.log('2. Checking pricing fields in raw data:');
                this.productsData.slice(0, 3).forEach((product, index) => {
                    console.log(`   Product ${index + 1} (${product.sku}):`);
                    console.log('     - product_id:', product.product_id);
                    console.log('     - All keys:', Object.keys(product));
                    console.log('     - selling_price:', product.selling_price);
                    console.log('     - default_selling_price:', product.default_selling_price);
                    console.log('     - price:', product.price);
                    console.log('     - unit_price:', product.unit_price);
                    console.log('     - prices array:', product.prices);
                });
                
                // 3. Test getSellingPrice function
                console.log('3. Testing getSellingPrice function:');
                const testProduct = this.productsData[0];
                const storeId = invoiceManager.currentStoreFilter;
                console.log('   - Test product:', testProduct);
                console.log('   - Current store ID:', storeId);
                
                const sellingPrice = this.getSellingPrice(testProduct, storeId);
                console.log('   - getSellingPrice result:', sellingPrice);
                
                // 4. Test formatAmount function
                console.log('4. Testing formatAmount function:');
                const formatted = this.formatAmount(sellingPrice);
                console.log('   - formatAmount result:', formatted);
                
                // 5. Check current currency info
                console.log('5. Currency info:');
                console.log('   - currentCurrencyInfo:', currentCurrencyInfo);
                
                // 6. Summary and recommendation
                console.log('6. DIAGNOSIS SUMMARY:');
                if (sellingPrice === 0) {
                    console.log('❌ ISSUE: Product price is 0');
                    console.log('🔧 SOLUTIONS:');
                    console.log('   - Check if the RPC get_inventory_product_list_company returns pricing data');
                    console.log('   - Verify the product has selling_price, default_selling_price, or price fields');
                    console.log('   - Check if store-specific pricing is configured correctly');
                } else {
                    console.log('✅ Pricing extraction works correctly');
                    console.log('⚠️  Issue might be in UI rendering or data binding');
                }
                
                console.log('🔍 === PRICING DIAGNOSIS COMPLETED ===');
                
                return {
                    hasData: this.productsData && this.productsData.length > 0,
                    sampleProduct: this.productsData?.[0],
                    extractedPrice: sellingPrice,
                    formattedPrice: formatted,
                    storeId: storeId
                };
            }
            
            updateAddPaymentCurrencyTotal() {
                const totalDisplay = document.getElementById('currencyTotalDisplay');
                const totalAmount = document.getElementById('currencyTotalAmount');
                
                if (!totalDisplay || !totalAmount) return;
                
                let total = 0;
                let hasAnyAmount = false;
                
                // Calculate total in base currency
                Object.entries(this.currentAddPaymentCurrencies).forEach(([currencyCode, amount]) => {
                    if (amount && parseFloat(amount) > 0) {
                        hasAnyAmount = true;
                        const currency = companyCurrencies.find(c => c.currency_code === currencyCode);
                        if (currency) {
                            const exchangeRate = currency.exchange_rate_to_base || 1;
                            total += parseFloat(amount) * exchangeRate;
                        }
                    }
                });
                
                // Show/hide total display based on whether there are amounts
                if (hasAnyAmount) {
                    totalDisplay.style.display = 'block';
                    
                    // Find base currency symbol
                    const baseCurrency = companyCurrencies.find(c => c.is_base_currency === true);
                    const symbol = baseCurrency ? baseCurrency.symbol : '₫';
                    
                    totalAmount.textContent = `${symbol}${this.formatNumberWithCommas(Math.round(total))}`;
                } else {
                    totalDisplay.style.display = 'none';
                }
            }
            
            savePaymentMethod() {
                console.log('=== savePaymentMethod() called ===');
                
                const isValid = this.validateAddPaymentForm();
                console.log('Validation result:', isValid);
                
                if (!isValid) {
                    console.log('Validation failed, not saving payment method');
                    return;
                }
                
                console.log('Creating payment method...');
                const paymentMethod = {
                    id: Date.now(), // Simple ID for now
                    type: this.currentAddPaymentType,
                    location: this.currentAddPaymentLocation,
                    currencies: { ...this.currentAddPaymentCurrencies }
                };
                
                console.log('Payment method created:', paymentMethod);
                console.log('Adding to payment methods array...');
                
                this.paymentMethods.push(paymentMethod);
                console.log('Payment methods array now:', this.paymentMethods);
                
                console.log('Rendering payment methods list...');
                this.renderPaymentMethodsList();
                
                console.log('Updating summary...');
                this.updateSummary();
                
                console.log('Closing modal...');
                this.closeAddPaymentModal();
                
                console.log('savePaymentMethod completed successfully');
            }
            
            renderPaymentMethodsList() {
                console.log('=== renderPaymentMethodsList() called ===');
                console.log('Payment methods to render:', this.paymentMethods);
                console.log('Number of payment methods:', this.paymentMethods ? this.paymentMethods.length : 'UNDEFINED');
                
                const listContainer = document.getElementById('paymentMethodsList');
                const noPaymentsMessage = document.getElementById('noPaymentsMessage');
                
                if (!listContainer) {
                    console.error('❌ paymentMethodsList container not found!');
                    return;
                }
                
                if (this.paymentMethods.length === 0) {
                    console.log('No payment methods to render, showing no-payments message');
                    if (noPaymentsMessage) noPaymentsMessage.style.display = 'flex';
                    return;
                }
                
                if (noPaymentsMessage) noPaymentsMessage.style.display = 'none';
                
                // Clear existing items except the no payments message
                const existingItems = listContainer.querySelectorAll('.payment-method-item');
                console.log('Clearing existing items count:', existingItems.length);
                existingItems.forEach(item => item.remove());
                
                this.paymentMethods.forEach((method, index) => {
                    console.log(`Rendering payment method ${index + 1}:`, method);
                    console.log(`Method ID: ${method.id} (type: ${typeof method.id})`);
                    
                    const methodItem = document.createElement('div');
                    methodItem.className = 'payment-method-item';
                    
                    // Create title based on type
                    let title = '';
                    let icon = '';
                    if (method.type === 'cash') {
                        title = `Cash at ${method.location?.name || 'Unknown Location'}`;
                        icon = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,11.5A2.5,2.5 0 0,1 9.5,9A2.5,2.5 0 0,1 12,6.5A2.5,2.5 0 0,1 14.5,9A2.5,2.5 0 0,1 12,11.5M12,2A7,7 0 0,0 5,9C5,14.25 12,22 12,22C12,22 19,14.25 19,9A7,7 0 0,0 12,2Z"/>
                               </svg>`;
                    } else if (method.type === 'bank') {
                        title = 'Bank Transfer';
                        icon = `<svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M2,17H22V14H2M2,13H22L12,2L2,13M7,9V10H8V9H7M15,9V10H16V9H15M11,9V10H12V9H11M2,20H22V18H2M2,21H22V22H2V21Z"/>
                               </svg>`;
                    }
                    
                    // Create currencies display
                    const currenciesHtml = Object.entries(method.currencies).map(([code, amount]) => {
                        const currency = companyCurrencies.find(c => c.currency_code === code) || { symbol: code, flag_emoji: '💵' };
                        const formattedAmount = this.formatNumberWithCommas(amount);
                        return `
                            <div class="payment-currency-item">
                                <span>${currency.flag_emoji}</span>
                                <span class="payment-currency-amount">${currency.symbol}${formattedAmount}</span>
                                <span>${code}</span>
                            </div>
                        `;
                    }).join('');
                    
                    methodItem.innerHTML = `
                        <div class="payment-method-header">
                            <div class="payment-method-title">
                                ${icon}
                                ${title}
                            </div>
                            <div class="payment-method-actions">
                                <button class="payment-delete-btn" onclick="console.log('=== Delete button clicked ==='); console.log('Clicked for method:', ${JSON.stringify(method)}); console.log('ID to delete:', ${method.id}, 'Type:', typeof ${method.id}); window.newInvoiceModal.removePaymentMethod(${method.id})">
                                    ✕
                                </button>
                            </div>
                        </div>
                        <div class="payment-currencies">
                            ${currenciesHtml}
                        </div>
                    `;
                    
                    listContainer.appendChild(methodItem);
                });
            }
            
            removePaymentMethod(id) {
                console.log('=== removePaymentMethod() called ===');
                console.log('ID to remove:', id, 'Type:', typeof id);
                console.log('Current this context:', this);
                console.log('Current paymentMethods array before filtering:', this.paymentMethods);
                console.log('Array length before filtering:', this.paymentMethods ? this.paymentMethods.length : 'UNDEFINED');
                
                if (!this.paymentMethods) {
                    console.error('❌ paymentMethods is null/undefined!');
                    return;
                }
                
                if (this.paymentMethods.length === 0) {
                    console.warn('⚠️ paymentMethods array is empty!');
                    return;
                }
                
                // Log all payment method IDs for comparison
                console.log('All payment method IDs:', this.paymentMethods.map(method => ({id: method.id, type: typeof method.id})));
                
                // Check if the ID exists in array
                const methodToRemove = this.paymentMethods.find(method => method.id === id);
                console.log('Method to remove found:', methodToRemove);
                
                // Try both strict and loose comparison
                const filteredByStrict = this.paymentMethods.filter(method => method.id !== id);
                console.log('After filtering with strict comparison:', filteredByStrict);
                
                const filteredByLoose = this.paymentMethods.filter(method => method.id != id);
                console.log('After filtering with loose comparison:', filteredByLoose);
                
                // Use the appropriate filtering
                const originalLength = this.paymentMethods.length;
                this.paymentMethods = this.paymentMethods.filter(method => method.id != id); // Use loose comparison
                const newLength = this.paymentMethods.length;
                
                console.log('Array length changed from', originalLength, 'to', newLength);
                console.log('Updated paymentMethods array:', this.paymentMethods);
                
                if (originalLength === newLength) {
                    console.error('❌ No payment method was removed! ID mismatch detected.');
                    console.log('Trying to remove ID:', id, 'from methods with IDs:', this.paymentMethods.map(m => m.id));
                } else {
                    console.log('✅ Successfully removed payment method');
                }
                
                console.log('Calling renderPaymentMethodsList()...');
                this.renderPaymentMethodsList();
                
                console.log('Calling updateSummary()...');
                this.updateSummary();
                
                console.log('=== removePaymentMethod() completed ===');
            }
            
            editPaymentMethod(id) {
                // TODO: Implement edit functionality
                console.log('Edit payment method', id);
            }
            
            calculateTotalFromPaymentMethods() {
                let total = 0;
                
                this.paymentMethods.forEach(method => {
                    Object.entries(method.currencies).forEach(([currencyCode, amount]) => {
                        const currency = companyCurrencies.find(c => c.currency_code === currencyCode);
                        if (currency) {
                            const baseCurrencyAmount = amount * (currency.exchange_rate_to_base || 1);
                            total += baseCurrencyAmount;
                        }
                    });
                });
                
                return total;
            }
        }

        // Calendar Manager for date range selection
        class CalendarManager {
            constructor() {
                this.startDate = null;
                this.endDate = null;
                this.currentMonth = new Date();
                this.isSelectingRange = false;
                this.hoveredDate = null;
            }
            
            init() {
                // Custom Range Tab Click
                const customRangeTab = document.getElementById('customRangeTab');
                const calendarDropdown = document.getElementById('calendarDropdown');
                
                // Check if elements exist
                if (!customRangeTab || !calendarDropdown) {
                    console.warn('Calendar elements not found during init:', { customRangeTab, calendarDropdown });
                    return;
                }
                
                customRangeTab.addEventListener('click', (e) => {
                    e.stopPropagation();
                    console.log('Custom Range tab clicked');
                    this.toggleCalendar();
                });
                
                // Prevent calendar from closing when clicking inside
                calendarDropdown.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // Close button
                const closeBtn = document.getElementById('calendarClose');
                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        this.closeCalendar();
                    });
                }
                
                // Clear button
                const clearBtn = document.getElementById('calendarClear');
                if (clearBtn) {
                    clearBtn.addEventListener('click', () => {
                        this.clearSelection();
                    });
                }
                
                // Apply button
                const applyBtn = document.getElementById('calendarApply');
                if (applyBtn) {
                    applyBtn.addEventListener('click', () => {
                        this.applySelection();
                    });
                }
                
                // Month navigation
                const prevBtn = document.getElementById('prevMonth');
                if (prevBtn) {
                    prevBtn.addEventListener('click', () => {
                        this.navigateMonth(-1);
                    });
                }
                
                const nextBtn = document.getElementById('nextMonth');
                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        this.navigateMonth(1);
                    });
                }
                
                
                // Date filter tabs
                document.querySelectorAll('.date-filter-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        if (tab.dataset.filter !== 'custom') {
                            this.closeCalendar();
                            // Set active tab
                            document.querySelectorAll('.date-filter-tab').forEach(t => {
                                t.classList.remove('active');
                            });
                            tab.classList.add('active');
                        }
                    });
                });
                
                // Close calendar when clicking outside (but not from add payment modal)
                document.addEventListener('click', (e) => {
                    // Don't close if click came from add payment modal
                    const fromAddPaymentModal = e.composedPath().some(el => el.id === 'addPaymentModal');
                    
                    if (calendarDropdown.classList.contains('active') && !fromAddPaymentModal) {
                        this.closeCalendar();
                    }
                });
                
                // Don't render calendar immediately - only when opened
                // this.renderCalendar();
            }
            
            toggleCalendar() {
                const calendarDropdown = document.getElementById('calendarDropdown');
                const customRangeTab = document.getElementById('customRangeTab');
                
                console.log('toggleCalendar called', { calendarDropdown, customRangeTab });
                
                if (calendarDropdown.classList.contains('active')) {
                    console.log('Closing calendar');
                    this.closeCalendar();
                } else {
                    console.log('Opening calendar');
                    calendarDropdown.classList.add('active');
                    customRangeTab.classList.add('active');
                    // Remove active from other tabs
                    document.querySelectorAll('.date-filter-tab').forEach(tab => {
                        if (tab.dataset.filter !== 'custom') {
                            tab.classList.remove('active');
                        }
                    });
                    // Render calendar when opening
                    this.renderCalendar();
                }
            }
            
            closeCalendar() {
                const calendarDropdown = document.getElementById('calendarDropdown');
                calendarDropdown.classList.remove('active');
            }
            
            clearSelection() {
                this.startDate = null;
                this.endDate = null;
                this.isSelectingRange = false;
                this.updateDisplay();
                this.renderCalendar();
            }
            
            applySelection() {
                if (this.startDate && this.endDate) {
                    // Apply the date range filter to invoice manager
                    console.log('Applying date range:', this.startDate, 'to', this.endDate);
                    
                    // Update invoice manager's date filter
                    invoiceManager.currentStartDate = this.startDate.toISOString().split('T')[0];
                    invoiceManager.currentEndDate = this.endDate.toISOString().split('T')[0];
                    invoiceManager.currentPage = 1; // Reset to first page
                    
                    this.closeCalendar();
                    // Keep custom tab active
                    document.querySelectorAll('.date-filter-tab').forEach(tab => {
                        tab.classList.remove('active');
                    });
                    document.getElementById('customRangeTab').classList.add('active');
                    
                    // Load invoices with new date range
                    invoiceManager.loadInvoicesForStore(invoiceManager.currentStoreFilter);
                }
            }
            
            navigateMonth(direction) {
                this.currentMonth.setMonth(this.currentMonth.getMonth() + direction);
                this.renderCalendar();
            }
            
            
            renderCalendar() {
                const grid = document.getElementById('calendarGrid');
                const title = document.getElementById('monthTitle');
                
                // Check if elements exist
                if (!grid || !title) {
                    console.warn('Calendar elements not found:', { grid, title });
                    return;
                }
                
                // Update month title
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                  'July', 'August', 'September', 'October', 'November', 'December'];
                title.textContent = `${monthNames[this.currentMonth.getMonth()]} ${this.currentMonth.getFullYear()}`;
                
                // Clear grid
                grid.innerHTML = '';
                
                // Add weekday headers
                const weekdays = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'];
                weekdays.forEach(day => {
                    const weekdayEl = document.createElement('div');
                    weekdayEl.className = 'calendar-weekday';
                    weekdayEl.textContent = day;
                    grid.appendChild(weekdayEl);
                });
                
                // Get first day of month and number of days
                const firstDay = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth(), 1);
                const lastDay = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth() + 1, 0);
                const prevMonthLastDay = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth(), 0);
                
                // Add empty cells for days before month starts
                for (let i = 0; i < firstDay.getDay(); i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day other-month';
                    dayEl.textContent = prevMonthLastDay.getDate() - firstDay.getDay() + i + 1;
                    grid.appendChild(dayEl);
                }
                
                // Add days of the month
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const date = new Date(this.currentMonth.getFullYear(), this.currentMonth.getMonth(), day);
                    date.setHours(0, 0, 0, 0);
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day';
                    dayEl.textContent = day;
                    
                    // Check if today
                    if (date.getTime() === today.getTime()) {
                        dayEl.classList.add('today');
                    }
                    
                    // Check if selected
                    if (this.startDate && date.getTime() === this.startDate.getTime()) {
                        dayEl.classList.add('selected', 'range-start');
                    }
                    if (this.endDate && date.getTime() === this.endDate.getTime()) {
                        dayEl.classList.add('selected', 'range-end');
                    }
                    
                    // Check if in range
                    if (this.startDate && this.endDate && 
                        date > this.startDate && date < this.endDate) {
                        dayEl.classList.add('in-range');
                    }
                    
                    // Add click handler
                    dayEl.addEventListener('click', () => {
                        this.handleDateClick(date);
                    });
                    
                    // Add hover handler for range preview
                    dayEl.addEventListener('mouseenter', () => {
                        if (this.isSelectingRange && this.startDate && !this.endDate) {
                            this.hoveredDate = date;
                            this.updateRangePreview();
                        }
                    });
                    
                    grid.appendChild(dayEl);
                }
                
                // Add empty cells for remaining grid spaces
                const totalCells = grid.children.length - 7; // Subtract weekday headers
                const remainingCells = 35 - totalCells;
                for (let i = 1; i <= remainingCells; i++) {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day other-month';
                    dayEl.textContent = i;
                    grid.appendChild(dayEl);
                }
            }
            
            handleDateClick(date) {
                if (!this.startDate || (this.startDate && this.endDate)) {
                    // Start new selection
                    this.startDate = date;
                    this.endDate = null;
                    this.isSelectingRange = true;
                } else if (this.startDate && !this.endDate) {
                    // Complete selection
                    if (date < this.startDate) {
                        // Swap if end date is before start date
                        this.endDate = this.startDate;
                        this.startDate = date;
                    } else {
                        this.endDate = date;
                    }
                    this.isSelectingRange = false;
                }
                
                this.renderCalendar();
            }
            
            updateRangePreview() {
                // This would update the visual preview while hovering
                // For simplicity, we'll skip the implementation
            }
            
            updateDisplay() {
                const display = document.getElementById('selectedRangeDisplay');
                const applyBtn = document.getElementById('calendarApply');
                
                // Check if elements exist
                if (!display || !applyBtn) {
                    console.warn('Calendar display elements not found:', { display, applyBtn });
                    return;
                }
                
                if (this.startDate && this.endDate) {
                    const options = { month: 'short', day: 'numeric', year: 'numeric' };
                    const startStr = this.startDate.toLocaleDateString('en-US', options);
                    const endStr = this.endDate.toLocaleDateString('en-US', options);
                    display.textContent = `${startStr} - ${endStr}`;
                    applyBtn.disabled = false;
                } else if (this.startDate) {
                    const options = { month: 'short', day: 'numeric', year: 'numeric' };
                    const startStr = this.startDate.toLocaleDateString('en-US', options);
                    display.textContent = `${startStr} - Select end date`;
                    applyBtn.disabled = true;
                } else {
                    display.textContent = 'No dates selected';
                    applyBtn.disabled = true;
                }
            }
        }
        
        // Initialize calendar manager
        const calendarManager = new CalendarManager();
        
        // Initialize invoice manager
        const invoiceManager = new InvoiceManager();
        
        // Initialize new invoice modal
        window.newInvoiceModal = new NewInvoiceModal();
        
        // Initialize page using standardized pattern
        window.initializePage('product', async (companyId, company) => {
            console.log('Company changed in invoice:', companyId);
            
            // Get currency info for new company
            await getCurrencyInfo(companyId);
            
            // Get cash locations for new company
            await getCashLocations(companyId);
            
            // Reload products data for new company
            if (window.newInvoiceModal) {
                window.newInvoiceModal.loadProductsData();
                window.newInvoiceModal.loadCashLocations();
            }
            
            // Reset store filter when company changes and set first store as default
            const stores = appState.getCompanyStores();
            if (stores && stores.length > 0) {
                invoiceManager.currentStoreFilter = stores[0].store_id;
                document.getElementById('storeFilterLabel').textContent = stores[0].store_name;
                invoiceManager.loadInvoicesForStore(stores[0].store_id);
            } else {
                invoiceManager.currentStoreFilter = null;
                document.getElementById('storeFilterLabel').textContent = 'No Stores';
                invoiceManager.loadInvoicesForStore(null);
            }
        });
        
        // Helper function to wait for Supabase client initialization
        async function waitForSupabaseClient(maxAttempts = 50, interval = 100) {
            for (let i = 0; i < maxAttempts; i++) {
                if (window.supabaseClient) {
                    console.log('Supabase client is ready');
                    return true;
                }
                await new Promise(resolve => setTimeout(resolve, interval));
            }
            console.error('Supabase client failed to initialize after', maxAttempts * interval / 1000, 'seconds');
            return false;
        }
        
        // Additional page initialization after navbar is ready
        document.addEventListener('DOMContentLoaded', () => {
            invoiceManager.init();
            calendarManager.init();
            
            // Wait for page initialization to complete, then initialize page-specific content
            setTimeout(async () => {
                // Wait for Supabase client to be initialized
                const supabaseReady = await waitForSupabaseClient();
                if (!supabaseReady) {
                    console.error('Failed to initialize Supabase client. Please refresh the page.');
                    return;
                }
                
                const companyId = appState.getSelectedCompanyId();
                if (companyId) {
                    // Get currency info on page load
                    await getCurrencyInfo(companyId);
                    
                    // Get cash locations on page load
                    await getCashLocations(companyId);
                    
                    const stores = appState.getCompanyStores();
                    if (stores && stores.length > 0) {
                        invoiceManager.currentStoreFilter = stores[0].store_id;
                        document.getElementById('storeFilterLabel').textContent = stores[0].store_name;
                        invoiceManager.loadInvoicesForStore(stores[0].store_id);
                    } else {
                        invoiceManager.loadInvoicesForStore(null);
                    }
                }
            }, 100);
        });
    </script>
</body>
</html>