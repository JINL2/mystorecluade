<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance - Counterparty</title>
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="../../../core/themes/toss-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-component-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-base.css">
    <link rel="stylesheet" href="../../../core/themes/toss-typography.css">
    
    <!-- Component CSS -->
    <link rel="stylesheet" href="../../../components/base/toss-button.css">
    <link rel="stylesheet" href="../../../components/form/toss-input.css">
    <link rel="stylesheet" href="../../../components/form/toss-select.css">
    <link rel="stylesheet" href="../../../components/feedback/toss-alert.css">
    <link rel="stylesheet" href="../../../components/navigation/navbar.css">
    
    <!-- Supabase CDN - Load first -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Environment Configuration (for local development) -->
    <script src="../../../core/config/env-loader.js"></script>
    <script src="../../../core/config/env-config.js"></script>    
    <!-- Page Specific Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background: var(--toss-gray-50);
            min-height: 100vh;
        }
        
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .page-content {
            flex: 1;
            padding: var(--space-6);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .page-header {
            margin-bottom: var(--space-8);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-4);
        }
        
        .header-left {
            flex: 1;
            min-width: 250px;
        }
        
        .page-title {
            font-size: var(--font-h1);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .page-subtitle {
            font-size: var(--font-large);
            color: var(--text-secondary);
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            gap: var(--space-3);
            align-items: center;
        }
        
        
        /* Counterparty Sections */
        .counterparty-section {
            margin-bottom: var(--space-8);
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            box-shadow: var(--shadow-xs);
            border: 1px solid var(--toss-gray-100);
        }
        
        /* Special styling for internal section */
        #internalSection {
            background: rgba(0, 100, 255, 0.02);
            border: 1px solid rgba(0, 100, 255, 0.08);
            box-shadow: 0 1px 3px rgba(0, 100, 255, 0.1), var(--shadow-xs);
        }
        
        #internalSection .section-header {
            border-bottom-color: rgba(0, 100, 255, 0.12);
        }
        
        /* External section styling for consistency */
        #externalSection {
            background: var(--toss-white);
            border: 1px solid var(--toss-gray-100);
        }
        
        #externalSection .section-header {
            border-bottom-color: var(--toss-gray-150);
        }
        
        .section-header {
            margin-bottom: var(--space-5);
            padding-bottom: var(--space-4);
            border-bottom: 2px solid var(--toss-gray-100);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-2);
        }
        
        .section-title h2 {
            font-size: var(--font-h2);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            flex: 1;
        }
        
        .section-icon {
            width: 24px;
            height: 24px;
            color: var(--toss-primary);
        }
        
        .section-count {
            background: var(--toss-primary-surface);
            color: var(--toss-primary);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--font-small);
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }
        
        .section-subtitle {
            font-size: var(--font-base);
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Counterparty Grid */
        .counterparty-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--space-4);
            align-items: start;
            width: 100%;
        }
        
        /* Ensure consistent grid alignment for all sections */
        #internalGrid, #externalGrid {
            margin: 0;
            padding: 0;
        }
        
        /* Counterparty Card */
        .counterparty-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xs);
            padding: var(--space-5);
            transition: all 0.2s;
            position: relative;
        }
        
        .counterparty-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-4);
        }
        
        .card-info {
            flex: 1;
        }
        
        .card-name {
            font-size: var(--font-large);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--space-1) 0;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .card-id {
            font-size: var(--font-small);
            color: var(--text-secondary);
            margin: 0;
        }
        
        .card-type-badge {
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-xs);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .type-customer {
            background: var(--toss-success-surface);
            color: var(--toss-success);
        }
        
        .type-supplier {
            background: var(--toss-warning-surface);
            color: var(--toss-warning);
        }
        
        .type-both {
            background: var(--toss-primary-surface);
            color: var(--toss-primary);
        }
        
        .card-details {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }
        
        .detail-row {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-small);
            color: var(--text-secondary);
        }
        
        .detail-icon {
            width: 16px;
            height: 16px;
            color: var(--toss-gray-500);
            flex-shrink: 0;
        }
        
        .internal-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            background: var(--toss-primary-surface);
            color: var(--toss-primary);
            border: 1px solid rgba(0, 100, 255, 0.2);
            border-radius: var(--radius-sm);
            font-size: var(--font-xs);
            font-weight: 600;
        }
        
        .internal-icon {
            width: 14px;
            height: 14px;
        }
        
        /* Special styling for internal organization cards */
        .internal-card {
            background: rgba(0, 100, 255, 0.02);
            border: 1px solid rgba(0, 100, 255, 0.1);
            box-shadow: 0 2px 8px rgba(0, 100, 255, 0.08), var(--shadow-xs);
        }
        
        .internal-card:hover {
            border-color: rgba(0, 100, 255, 0.2);
            box-shadow: 0 4px 12px rgba(0, 100, 255, 0.15), var(--shadow-md);
        }
        
        .card-header-right {
            display: flex;
            align-items: flex-start;
            gap: var(--space-2);
        }
        
        .card-delete-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--toss-gray-200);
            border-radius: var(--radius-sm);
            background: var(--toss-gray-50);
            color: var(--toss-gray-500);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
            pointer-events: all;
            outline: none;
        }
        
        .card-delete-btn:hover {
            background: #ff4757;
            color: white;
            border-color: #ff4757;
            transform: scale(1.05);
        }

        .card-delete-btn:active {
            transform: scale(0.98);
        }
        
        .delete-icon {
            width: 16px;
            height: 16px;
            pointer-events: none;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-16) var(--space-6);
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xs);
        }
        
        .empty-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto var(--space-6);
            background: var(--toss-gray-100);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--toss-gray-500);
        }
        
        .empty-title {
            font-size: var(--font-h2);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 var(--space-3) 0;
        }
        
        .empty-text {
            font-size: var(--font-large);
            color: var(--text-secondary);
            margin: 0 0 var(--space-6) 0;
        }
        
        /* Loading State */
        .loading-state {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-16);
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--toss-gray-200);
            border-top-color: var(--toss-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Add Counterparty Button - Matching Account Mapping Style */
        .add-counterparty-btn {
            padding: var(--space-3) var(--space-5);
            background: #0064FF;
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
        }
        
        .add-counterparty-btn:hover {
            background: #0052CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 100, 255, 0.3);
        }
        
        .add-counterparty-btn:active {
            transform: translateY(0);
        }
        
        .add-counterparty-btn:focus-visible {
            outline: 2px solid #0064FF;
            outline-offset: 2px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(4px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-container {
            background: var(--toss-white);
            border-radius: var(--radius-xl);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 500px;
            width: 90vw;
            max-height: 90vh;
            overflow: visible; /* Changed from hidden to visible to allow dropdowns */
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .modal-overlay.active .modal-container {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            padding: var(--space-6) var(--space-6) var(--space-4) var(--space-6);
            border-bottom: 1px solid var(--toss-gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: var(--font-h2);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            background: var(--toss-gray-100);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-secondary);
        }
        
        .modal-close:hover {
            background: var(--toss-gray-200);
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: var(--space-6);
            max-height: calc(90vh - 140px);
            overflow-y: auto;
            overflow-x: visible; /* Allow horizontal overflow for dropdowns */
            position: relative;
        }
        
        .form-group {
            margin-bottom: var(--space-5);
        }
        
        .form-label {
            display: block;
            font-size: var(--font-base);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }
        
        .form-input {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--toss-gray-200);
            border-radius: var(--radius-lg);
            font-size: var(--font-base);
            background: var(--toss-white);
            transition: all 0.2s;
            box-sizing: border-box;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--toss-primary);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .form-input::placeholder {
            color: var(--text-tertiary);
        }
        
        .form-select {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--toss-gray-200);
            border-radius: var(--radius-lg);
            font-size: var(--font-base);
            background: var(--toss-white);
            cursor: pointer;
            transition: all 0.2s;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right var(--space-3) center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: var(--space-10);
            box-sizing: border-box;
        }
        
        .form-select:focus {
            outline: none;
            border-color: var(--toss-primary);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .form-textarea {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--toss-gray-200);
            border-radius: var(--radius-lg);
            font-size: var(--font-base);
            background: var(--toss-white);
            transition: all 0.2s;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            box-sizing: border-box;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: var(--toss-primary);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .form-textarea::placeholder {
            color: var(--text-tertiary);
        }
        
        /* Selection Boxes for Internal/External */
        .selection-group {
            display: flex;
            gap: var(--space-3);
            width: 100%;
        }
        
        .selection-box {
            flex: 1;
            padding: var(--space-4);
            border: 2px solid var(--toss-gray-200);
            border-radius: var(--radius-lg);
            background: var(--toss-white);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: var(--font-base);
            font-weight: 600;
            color: var(--text-secondary);
            position: relative;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .selection-box:hover {
            border-color: var(--toss-gray-300);
            background: var(--toss-gray-50);
        }
        
        .selection-box.active {
            background: var(--toss-primary);
            border-color: var(--toss-primary);
            color: var(--toss-white);
            box-shadow: 0 2px 8px rgba(0, 100, 255, 0.2);
        }
        
        .selection-box.active:hover {
            background: #0052CC;
            border-color: #0052CC;
        }
        
        /* Internal Organization box special styling */
        .selection-box.internal-option.active {
            background: var(--toss-primary);
        }
        
        /* External Partner box styling */
        .selection-box.external-option.active {
            background: var(--toss-gray-600);
            border-color: var(--toss-gray-600);
        }
        
        /* Modal Actions */
        .modal-actions {
            padding: var(--space-4) var(--space-6) var(--space-6) var(--space-6);
            border-top: 1px solid var(--toss-gray-100);
            display: flex;
            gap: var(--space-3);
            justify-content: flex-end;
        }
        
        .modal-btn {
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            font-size: var(--font-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            min-width: 100px;
        }
        
        .modal-btn-secondary {
            background: var(--toss-gray-100);
            color: var(--text-secondary);
        }
        
        .modal-btn-secondary:hover {
            background: var(--toss-gray-200);
            color: var(--text-primary);
        }
        
        .modal-btn-primary {
            background: var(--toss-primary);
            color: var(--toss-white);
        }
        
        .modal-btn-primary:hover {
            background: #0052CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 100, 255, 0.3);
        }
        
        .modal-btn-primary:active {
            transform: translateY(0);
        }

        .modal-btn-primary:disabled {
            background: var(--toss-gray-300);
            color: var(--toss-gray-500);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .modal-btn-primary:disabled:hover {
            background: var(--toss-gray-300);
            color: var(--toss-gray-500);
            transform: none;
            box-shadow: none;
        }
        
        .modal-btn-danger {
            flex: 1;
            padding: var(--space-3) var(--space-6);
            background: #ff4757;
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: var(--font-base);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn-danger:hover {
            background: #ff3742;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 71, 87, 0.4);
        }

        .modal-btn-danger:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(255, 71, 87, 0.4);
        }
        
        /* Confirmation Modal Styles */
        .confirmation-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 80px;
            height: 80px;
            margin: 0 auto var(--space-6);
            background: rgba(255, 71, 87, 0.1);
            border-radius: var(--radius-full);
            color: #ff4757;
        }
        
        .delete-confirmation-icon {
            width: 40px;
            height: 40px;
        }
        
        .confirmation-message {
            text-align: center;
            margin-bottom: var(--space-6);
        }
        
        .confirmation-text {
            font-size: var(--font-large);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .confirmation-subtext {
            font-size: var(--font-base);
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Custom Select Styles for Company Dropdown */
        .custom-select-container {
            position: relative;
            width: 100%;
        }

        .custom-select {
            position: relative;
            width: 100%;
            z-index: 1;
        }

        .custom-select.disabled {
            opacity: 0.6;
            pointer-events: none;
        }

        .select-trigger {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            border: 2px solid var(--toss-gray-200);
            border-radius: var(--radius-lg);
            background: var(--toss-white);
            cursor: pointer;
            font-size: var(--font-base);
            color: var(--text-primary);
            transition: all 0.2s ease;
            min-height: 48px;
            box-sizing: border-box;
        }

        .select-trigger:hover {
            border-color: var(--toss-primary);
        }

        .select-trigger.active {
            border-color: var(--toss-primary);
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }

        .select-text {
            flex: 1;
            text-align: left;
        }

        .select-text.placeholder {
            color: var(--text-tertiary);
        }

        .select-arrow {
            transition: transform 0.2s ease;
            color: var(--text-tertiary);
        }

        .custom-select.active .select-arrow {
            transform: rotate(180deg);
        }

        .select-dropdown {
            position: absolute;
            background: var(--toss-white);
            border: 2px solid var(--toss-primary);
            border-radius: var(--radius-lg);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            max-height: 300px;
            overflow: hidden;
            display: none;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            min-width: 200px;
        }

        .custom-select.active .select-dropdown {
            display: block;
        }
        
        .custom-select.active {
            z-index: 10002;
        }

        .search-container {
            padding: var(--space-3);
            border-bottom: 1px solid var(--toss-gray-100);
        }

        .search-input {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--toss-gray-200);
            border-radius: var(--radius-sm);
            font-size: var(--font-small);
            outline: none;
            background: var(--toss-gray-50);
            box-sizing: border-box;
        }

        .search-input:focus {
            border-color: var(--toss-primary);
            background: var(--toss-white);
            box-shadow: 0 0 0 2px rgba(0, 100, 255, 0.1);
        }

        .select-options {
            max-height: 240px;
            overflow-y: auto;
        }

        .select-option {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--toss-gray-100);
        }

        .select-option:last-child {
            border-bottom: none;
        }

        .select-option:hover:not(.disabled) {
            background: var(--toss-gray-50);
        }

        .select-option.selected {
            background: rgba(0, 100, 255, 0.1);
            color: var(--toss-primary);
        }

        .select-option.disabled {
            color: var(--text-tertiary);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .option-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-sm);
            background: var(--toss-primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: var(--font-small);
            font-weight: 600;
            flex-shrink: 0;
        }

        .option-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .option-name {
            font-weight: 500;
            color: var(--text-primary);
            flex: 1;
            min-width: 0;
            margin-bottom: 2px;
        }

        .option-subtitle {
            font-size: var(--font-small);
            color: var(--text-secondary);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .page-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .add-counterparty-btn {
                width: 100%;
                justify-content: center;
            }
            
            .modal-container {
                width: 95vw;
                margin: var(--space-4);
            }
            
            .modal-header,
            .modal-body,
            .modal-actions {
                padding-left: var(--space-4);
                padding-right: var(--space-4);
            }
            
            .modal-actions {
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
            }
            
            .select-dropdown {
                position: absolute;
                left: 0 !important;
                right: 0;
                width: auto !important;
                max-width: none;
            }
            
            .option-icon {
                width: 36px;
                height: 36px;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Navigation Bar -->
        <div id="navbar-container"></div>
        
        <!-- Page Content -->
        <main class="page-content">
            <div class="page-header">
                <div class="header-left">
                    <h1 class="page-title">Counterparty</h1>
                    <p class="page-subtitle">Manage business partners and relationships</p>
                </div>
                <div class="header-actions">
                    <button class="add-counterparty-btn" onclick="addCounterparty()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                        </svg>
                        Add Counterparty
                    </button>
                </div>
            </div>
            
            
            <!-- Counterparty Sections -->
            <div id="counterpartyContainer">
                <div class="loading-state" id="loadingState">
                    <div class="spinner"></div>
                </div>
                
                <!-- Internal Organizations Section -->
                <div class="counterparty-section" id="internalSection" style="display: none;">
                    <div class="section-header">
                        <div class="section-title">
                            <svg class="section-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/>
                            </svg>
                            <h2>Internal Organizations</h2>
                            <span class="section-count" id="internalCount">0</span>
                        </div>
                        <p class="section-subtitle">Your internal company structures and departments</p>
                    </div>
                    <div class="counterparty-grid" id="internalGrid">
                        <!-- Internal counterparties will be inserted here -->
                    </div>
                </div>
                
                <!-- External Partners Section -->
                <div class="counterparty-section" id="externalSection" style="display: none;">
                    <div class="section-header">
                        <div class="section-title">
                            <svg class="section-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,5.5A3.5,3.5 0 0,1 15.5,9A3.5,3.5 0 0,1 12,12.5A3.5,3.5 0 0,1 8.5,9A3.5,3.5 0 0,1 12,5.5M5,8C5.56,8 6.08,8.15 6.53,8.42C6.38,9.85 6.8,11.27 7.66,12.38C7.16,13.34 6.16,14 5,14A3,3 0 0,1 2,11A3,3 0 0,1 5,8M19,8A3,3 0 0,1 22,11A3,3 0 0,1 19,14C17.84,14 16.84,13.34 16.34,12.38C17.2,11.27 17.62,9.85 17.47,8.42C17.92,8.15 18.44,8 19,8M5.5,18.25C5.5,16.18 8.41,14.5 12,14.5C15.59,14.5 18.5,16.18 18.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11 1.89,15.94 4.45,15.6C3.86,16.28 3.5,17.22 3.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22 20.14,16.28 19.55,15.6C22.11,15.94 24,17.11 24,18.5V20Z"/>
                            </svg>
                            <h2>External Partners</h2>
                            <span class="section-count" id="externalCount">0</span>
                        </div>
                        <p class="section-subtitle">Customers, suppliers, and business partners</p>
                    </div>
                    <div class="counterparty-grid" id="externalGrid">
                        <!-- External counterparties will be inserted here -->
                    </div>
                </div>
                
                <div class="empty-state" id="emptyState" style="display: none;">
                    <div class="empty-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16,4C18.2,4 20,5.8 20,8C20,10.2 18.2,12 16,12C13.8,12 12,10.2 12,8C12,5.8 13.8,4 16,4M16,14C20.4,14 24,15.8 24,18V20H8V18C8,15.8 11.6,14 16,14M8.8,12A3,3 0 0,0 12,9A3,3 0 0,0 8.8,6C7.6,6 6.6,6.9 6.6,8C6.6,9.1 7.6,10 8.8,10M8.8,11.2C5.9,11.2 0,12.7 0,15.5V16.8H6.6V15.5C6.6,14.6 7.1,13.9 8.8,13.4C8.4,12.6 8.8,11.6 8.8,11.2Z"/>
                        </svg>
                    </div>
                    <h2 class="empty-title">No Counterparties Found</h2>
                    <p class="empty-text">Start by adding your first counterparty to manage business relationships.</p>
                    <button class="add-counterparty-btn" onclick="addCounterparty()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                        </svg>
                        Add Your First Counterparty
                    </button>
                </div>
            </div>
        </main>
        
        <!-- Add Counterparty Modal -->
        <div class="modal-overlay" id="addCounterpartyModal">
            <div class="modal-container">
                <div class="modal-header">
                    <h2 class="modal-title">Create Counterparty</h2>
                    <button class="modal-close" onclick="closeAddCounterpartyModal()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="modal-body">
                    <form id="addCounterpartyForm">
                        <!-- Counterparty Name -->
                        <div class="form-group">
                            <label class="form-label" for="counterpartyName">Counterparty Name</label>
                            <input 
                                type="text" 
                                id="counterpartyName" 
                                class="form-input" 
                                placeholder="Enter counterparty name"
                                required
                            >
                        </div>
                        
                        <!-- Internal Organization Selection -->
                        <div class="form-group">
                            <label class="form-label">Organization Type</label>
                            <div class="selection-group">
                                <div class="selection-box external-option active" id="externalBox" onclick="selectOrganizationType('external')">
                                    External Partner
                                </div>
                                <div class="selection-box internal-option" id="internalBox" onclick="selectOrganizationType('internal')">
                                    Internal Organization
                                </div>
                            </div>
                        </div>
                        
                        <!-- Company Selection (shown when internal is selected) -->
                        <div class="form-group" id="companyGroup" style="display: none;">
                            <label class="form-label">Choose Counter Party Company</label>
                            <div class="custom-select-container">
                                <div class="custom-select" id="companySelect">
                                    <div class="select-trigger" onclick="toggleCompanyDropdown()">
                                        <span class="select-text placeholder">Select company...</span>
                                        <svg class="select-arrow" width="20" height="20" viewBox="0 0 24 24">
                                            <path d="M7 10L12 15L17 10H7Z" fill="currentColor"/>
                                        </svg>
                                    </div>
                                    <div class="select-dropdown" id="companyDropdown">
                                        <div class="search-container">
                                            <input type="text" class="search-input" placeholder="Search companies..." 
                                                   onkeyup="searchCompanies(this.value)">
                                        </div>
                                        <div class="select-options" id="companyOptions">
                                            <!-- Options will be populated dynamically from app state -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Type -->
                        <div class="form-group">
                            <label class="form-label">Type</label>
                            <div class="custom-select-container">
                                <div class="custom-select" id="typeSelect">
                                    <div class="select-trigger" onclick="toggleTypeDropdown()">
                                        <span class="select-text placeholder">Select type...</span>
                                        <svg class="select-arrow" width="20" height="20" viewBox="0 0 24 24">
                                            <path d="M7 10L12 15L17 10H7Z" fill="currentColor"/>
                                        </svg>
                                    </div>
                                    <div class="select-dropdown" id="typeDropdown">
                                        <div class="search-container">
                                            <input type="text" class="search-input" placeholder="Search types..." 
                                                   onkeyup="searchTypes(this.value)">
                                        </div>
                                        <div class="select-options" id="typeOptions">
                                            <!-- Options will be populated dynamically -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Email -->
                        <div class="form-group">
                            <label class="form-label" for="counterpartyEmail">Email</label>
                            <input 
                                type="email" 
                                id="counterpartyEmail" 
                                class="form-input" 
                                placeholder="example@email.com"
                            >
                        </div>
                        
                        <!-- Phone Number -->
                        <div class="form-group">
                            <label class="form-label" for="counterpartyPhone">Phone Number</label>
                            <input 
                                type="tel" 
                                id="counterpartyPhone" 
                                class="form-input" 
                                placeholder="Enter phone number"
                            >
                        </div>
                        
                        <!-- Note -->
                        <div class="form-group">
                            <label class="form-label" for="counterpartyNote">Note</label>
                            <textarea 
                                id="counterpartyNote" 
                                class="form-textarea" 
                                placeholder="Add a note..."
                            ></textarea>
                        </div>
                    </form>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="modal-btn modal-btn-secondary" onclick="closeAddCounterpartyModal()">
                        Cancel
                    </button>
                    <button type="submit" class="modal-btn modal-btn-primary" id="createCounterpartyBtn" onclick="saveCounterparty()" disabled>
                        Create Counterparty
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteConfirmationModal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <h2 class="modal-title">Delete Counterparty</h2>
            </div>
            
            <div class="modal-content">
                <div class="confirmation-icon">
                    <svg class="delete-confirmation-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2C17.53,2 22,6.47 22,12C22,17.53 17.53,22 12,22C6.47,22 2,17.53 2,12C2,6.47 6.47,2 12,2M15.59,7L12,10.59L8.41,7L7,8.41L10.59,12L7,15.59L8.41,17L12,13.41L15.59,17L17,15.59L13.41,12L17,8.41L15.59,7Z"/>
                    </svg>
                </div>
                
                <div class="confirmation-message">
                    <p class="confirmation-text">Are you sure you want to delete this counterparty?</p>
                    <p class="confirmation-subtext">This action cannot be undone.</p>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="modal-btn modal-btn-secondary" onclick="closeDeleteConfirmationModal()">
                    Cancel
                </button>
                <button type="button" class="modal-btn modal-btn-danger" id="confirmDeleteBtn" onclick="confirmDeleteCounterparty()">
                    Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- Component JavaScript -->
    <script src="../../../components/base/toss-button.js"></script>
    <script src="../../../components/form/toss-input.js"></script>
    <script src="../../../components/form/toss-select.js"></script>
    <script src="../../../components/navigation/navbar.js"></script>
    <script src="../../../components/feedback/toss-alert.js"></script>
    
    <!-- Core Scripts -->
    <script src="../../../core/constants/app-icons.js"></script>
    <script src="../../../core/config/supabase.js"></script>
    
    <!-- App State Management -->
    <script src="../../../core/utils/app-state.js"></script>
    
    <!-- Route Mapping -->
    <script src="../../../core/config/route-mapping.js"></script>
    
    <!-- Page Initialization Utility -->
    <script src="../../../core/utils/page-init.js"></script>
    
    <script>
        // Set flag immediately to prevent navbar auto-init
        window.skipNavbarAutoInit = true;
        
        // Global variables
        let allCounterparties = [];
        let currentCompanyId = null;
        
        // Initialize page using standardized pattern
        window.initializePage('setting', (companyId, company) => {
            console.log('Company changed in counterparty:', companyId);
            currentCompanyId = companyId;
            loadCounterpartyData(companyId);
        });
        
        // Additional page initialization after navbar is ready
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for Supabase to be available
            let retryCount = 0;
            const maxRetries = 50; // 5 seconds max wait
            
            while (retryCount < maxRetries && (!window.supabase || !supabase)) {
                await new Promise(resolve => setTimeout(resolve, 100));
                retryCount++;
                
                // Try to initialize Supabase if it exists
                if (window.supabase && !supabase) {
                    initializeSupabase();
                }
            }
            
            if (!supabase) {
                console.error('Supabase client failed to initialize after waiting');
                showError('Database connection failed. Please refresh the page.');
                return;
            }
            
            // Wait for page initialization to complete, then initialize page-specific content
            setTimeout(() => {
                const companyId = appState.getSelectedCompanyId();
                if (companyId) {
                    currentCompanyId = companyId;
                    loadCounterpartyData(companyId);
                }
            }, 100);
        });
        
        // Load counterparty data for company
        async function loadCounterpartyData(companyId) {
            console.log('Loading counterparties for company:', companyId);
            
            // Show loading state and hide sections
            const loadingState = document.getElementById('loadingState');
            const emptyState = document.getElementById('emptyState');
            const internalSection = document.getElementById('internalSection');
            const externalSection = document.getElementById('externalSection');
            
            if (loadingState) loadingState.style.display = 'flex';
            if (emptyState) emptyState.style.display = 'none';
            if (internalSection) internalSection.style.display = 'none';
            if (externalSection) externalSection.style.display = 'none';
            
            try {
                // Check if Supabase is properly initialized
                if (!supabase) {
                    console.log('Supabase not initialized, attempting to initialize...');
                    initializeSupabase();
                    
                    // Wait a bit for initialization
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    if (!supabase) {
                        throw new Error('Failed to initialize Supabase client');
                    }
                }
                
                // Check if SupabaseDB is available
                if (typeof SupabaseDB === 'undefined') {
                    throw new Error('SupabaseDB helper not available');
                }
                
                // Query counterparties from database
                const result = await SupabaseDB.query('counterparties', {
                    select: 'counterparty_id, name, type, is_internal, linked_company_id',
                    filters: {
                        company_id: companyId,
                        is_deleted: false
                    },
                    orderBy: {
                        column: 'name',
                        ascending: true
                    }
                });
                
                if (result.success) {
                    allCounterparties = result.data || [];
                    console.log('Loaded counterparties:', allCounterparties);
                    
                    // Validate and sanitize data
                    allCounterparties = allCounterparties.filter(cp => {
                        if (!cp || typeof cp !== 'object') {
                            console.warn('Invalid counterparty object:', cp);
                            return false;
                        }
                        return true;
                    });
                    
                    // Sort counterparties: Internal first, then alphabetically
                    allCounterparties.sort((a, b) => {
                        // Add null checks
                        const aInternal = a.is_internal || false;
                        const bInternal = b.is_internal || false;
                        const aName = a.name || '';
                        const bName = b.name || '';
                        
                        // If one is internal and the other is not, internal comes first
                        if (aInternal && !bInternal) return -1;
                        if (!aInternal && bInternal) return 1;
                        
                        // Both are the same type (both internal or both external), sort alphabetically
                        return aName.toLowerCase().localeCompare(bName.toLowerCase());
                    });
                    
                    console.log('Sorted counterparties:', allCounterparties);
                    
                    // Display all counterparties
                    displayCounterparties(allCounterparties);
                } else {
                    console.error('Failed to load counterparties:', result.error);
                    showError('Failed to load counterparties: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error loading counterparties:', error);
                
                // Hide loading state
                if (loadingState) loadingState.style.display = 'none';
                
                // Show empty state with error message
                if (emptyState) {
                    emptyState.style.display = 'block';
                    const emptyTitle = emptyState.querySelector('.empty-title');
                    const emptyText = emptyState.querySelector('.empty-text');
                    if (emptyTitle) emptyTitle.textContent = 'Error Loading Data';
                    if (emptyText) emptyText.textContent = 'Unable to load counterparties. Please check your connection and try refreshing the page.';
                }
                
                showError('An error occurred while loading counterparties: ' + error.message);
            }
        }
        
        // Create counterparty card HTML
        function createCounterpartyCard(counterparty) {
            // Add null checks for all properties
            const name = counterparty.name || 'Unknown';
            const type = counterparty.type || 'unknown';
            const isInternal = counterparty.is_internal || false;
            const counterpartyId = counterparty.counterparty_id || '';
            
            const typeClass = type === 'customer' ? 'type-customer' : 
                            type === 'supplier' ? 'type-supplier' : 'type-both';
            const typeLabel = type === 'both' ? 'Customer & Supplier' : 
                            type && typeof type === 'string' ? 
                            type.charAt(0).toUpperCase() + type.slice(1) : 'Unknown';
            
            // Apply special styling for internal organizations
            const cardClass = isInternal ? 'counterparty-card internal-card' : 'counterparty-card';
            
            return `
                <div class="${cardClass}" data-id="${counterpartyId}">
                    <div class="card-header">
                        <div class="card-info">
                            <h3 class="card-name">
                                ${name}
                                ${isInternal ? '<span class="internal-badge"><svg class="internal-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/></svg>Internal</span>' : ''}
                            </h3>
                        </div>
                        <div class="card-header-right">
                            <span class="card-type-badge ${typeClass}">${typeLabel}</span>
                            <button class="card-delete-btn" onclick="deleteCounterparty('${counterpartyId}', event)" title="Delete counterparty">
                                <svg class="delete-icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card-details">
                        <div class="detail-row">
                            <svg class="detail-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,2C6.48,2 2,6.48 2,12C2,17.52 6.48,22 12,22C17.52,22 22,17.52 22,12C22,6.48 17.52,2 12,2M12,20C7.58,20 4,16.42 4,12C4,7.58 7.58,4 12,4C16.42,4 20,7.58 20,12C20,16.42 16.42,20 12,20M12,6C9.79,6 8,7.79 8,10C8,12.21 9.79,14 12,14C14.21,14 16,12.21 16,10C16,7.79 14.21,6 12,6Z"/>
                            </svg>
                            <span>Type: ${typeLabel}</span>
                        </div>
                        ${isInternal ? `
                        <div class="detail-row">
                            <svg class="detail-icon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1Z"/>
                            </svg>
                            <span>Internal Organization</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        // Display counterparties in sections
        function displayCounterparties(counterparties) {
            try {
                const loadingState = document.getElementById('loadingState');
                const emptyState = document.getElementById('emptyState');
                const internalSection = document.getElementById('internalSection');
                const externalSection = document.getElementById('externalSection');
                const internalGrid = document.getElementById('internalGrid');
                const externalGrid = document.getElementById('externalGrid');
                const internalCount = document.getElementById('internalCount');
                const externalCount = document.getElementById('externalCount');
                
                // Hide loading with null check
                if (loadingState) loadingState.style.display = 'none';
                
                if (!counterparties || counterparties.length === 0) {
                    // Show empty state, hide sections with null checks
                    if (emptyState) emptyState.style.display = 'block';
                    if (internalSection) internalSection.style.display = 'none';
                    if (externalSection) externalSection.style.display = 'none';
                    return;
                }
                
                // Hide empty state with null check
                if (emptyState) emptyState.style.display = 'none';
                
                // Separate counterparties into internal and external with null checks
                const internalCounterparties = counterparties.filter(cp => cp && (cp.is_internal === true));
                const externalCounterparties = counterparties.filter(cp => cp && (cp.is_internal !== true));
                
                console.log('Internal counterparties:', internalCounterparties);
                console.log('External counterparties:', externalCounterparties);
                
                // Update counts with null checks
                if (internalCount) internalCount.textContent = internalCounterparties.length;
                if (externalCount) externalCount.textContent = externalCounterparties.length;
                
                // Display Internal Organizations section
                if (internalCounterparties.length > 0) {
                    if (internalSection) internalSection.style.display = 'block';
                    if (internalGrid) {
                        try {
                            internalGrid.innerHTML = internalCounterparties.map(cp => createCounterpartyCard(cp)).join('');
                        } catch (cardError) {
                            console.error('Error creating internal cards:', cardError);
                            internalGrid.innerHTML = '<div class="error-message">Error displaying internal counterparties</div>';
                        }
                    }
                } else {
                    if (internalSection) internalSection.style.display = 'none';
                }
                
                // Display External Partners section
                if (externalCounterparties.length > 0) {
                    if (externalSection) externalSection.style.display = 'block';
                    if (externalGrid) {
                        try {
                            externalGrid.innerHTML = externalCounterparties.map(cp => createCounterpartyCard(cp)).join('');
                        } catch (cardError) {
                            console.error('Error creating external cards:', cardError);
                            externalGrid.innerHTML = '<div class="error-message">Error displaying external counterparties</div>';
                        }
                    }
                } else {
                    if (externalSection) externalSection.style.display = 'none';
                }
            } catch (error) {
                console.error('Error in displayCounterparties:', error);
                const loadingState = document.getElementById('loadingState');
                const emptyState = document.getElementById('emptyState');
                
                if (loadingState) loadingState.style.display = 'none';
                if (emptyState) {
                    emptyState.style.display = 'block';
                    const emptyTitle = emptyState.querySelector('.empty-title');
                    const emptyText = emptyState.querySelector('.empty-text');
                    if (emptyTitle) emptyTitle.textContent = 'Display Error';
                    if (emptyText) emptyText.textContent = 'Error displaying counterparties: ' + error.message;
                }
            }
        }
        
        // Modal functions
        function addCounterparty() {
            const modal = document.getElementById('addCounterpartyModal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
            
            // Populate both dropdowns when modal opens
            populateCompanyDropdown();
            populateTypeDropdown();
            
            // Setup form validation
            setupFormValidation();
        }
        
        // Global variables for dropdown data
        let availableCompanies = [];
        let selectedCompanyData = null;
        let availableTypes = [
            { value: 'My Company', label: 'My Company' },
            { value: 'Team Member', label: 'Team Member' },
            { value: 'Suppliers', label: 'Suppliers' },
            { value: 'Employees', label: 'Employees' },
            { value: 'Customers', label: 'Customers' },
            { value: 'Others', label: 'Others' }
        ];
        let selectedTypeData = null;
        
        // Form validation variables
        let isInternalSelected = false;
        
        // Form validation function
        function validateForm() {
            const nameInput = document.getElementById('counterpartyName');
            const createBtn = document.getElementById('createCounterpartyBtn');
            
            // Check required fields
            const hasName = nameInput && nameInput.value.trim().length > 0;
            const hasOrganizationType = document.querySelector('.selection-box.active') !== null;
            const hasCompany = !isInternalSelected || selectedCompanyData !== null;
            const hasType = selectedTypeData !== null;
            
            // Enable button only if all required fields are filled
            const isValid = hasName && hasOrganizationType && hasCompany && hasType;
            
            if (createBtn) {
                createBtn.disabled = !isValid;
            }
            
            console.log('Form validation:', {
                hasName,
                hasOrganizationType,
                hasCompany: hasCompany,
                hasType,
                isInternalSelected,
                isValid
            });
        }
        
        // Add form validation event listeners
        function setupFormValidation() {
            // Name input validation
            const nameInput = document.getElementById('counterpartyName');
            if (nameInput) {
                nameInput.addEventListener('input', validateForm);
            }
            
            // Initial validation
            validateForm();
        }
        
        function populateCompanyDropdown() {
            const companyOptions = document.getElementById('companyOptions');
            if (!companyOptions) return;
            
            try {
                // Get companies from app state (same source as navbar)
                const companies = appState.getUserCompanies();
                console.log('Available companies for dropdown:', companies);
                
                // Store companies for search functionality
                availableCompanies = companies || [];
                
                if (companies && companies.length > 0) {
                    companyOptions.innerHTML = createCompanyOptionsHTML(companies);
                } else {
                    companyOptions.innerHTML = '<div class="select-option disabled">No companies available</div>';
                }
            } catch (error) {
                console.error('Error populating company dropdown:', error);
                companyOptions.innerHTML = '<div class="select-option disabled">Error loading companies</div>';
            }
        }
        
        function createCompanyOptionsHTML(companies) {
            return companies.map(company => {
                const initials = getCompanyInitials(company.company_name);
                const storeCount = company.stores ? company.stores.length : 0;
                const storeText = `${storeCount} store${storeCount !== 1 ? 's' : ''}`;
                
                return `
                    <div class="select-option" data-value="${company.company_id}" data-name="${company.company_name}" 
                         onclick="selectCompany('${company.company_id}', '${company.company_name}')">
                        <div class="option-icon">${initials}</div>
                        <div class="option-content">
                            <div class="option-name">${company.company_name}</div>
                            <div class="option-subtitle">${storeText}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function getCompanyInitials(companyName) {
            if (!companyName) return '??';
            const words = companyName.split(' ');
            if (words.length === 1) {
                return companyName.substring(0, 2).toUpperCase();
            }
            return words.slice(0, 2).map(w => w[0]).join('').toUpperCase();
        }
        
        // Get local timestamp for database storage (not UTC)
        function getLocalTimestamp(date = new Date()) {
            // Get the timezone offset in minutes
            const timezoneOffset = date.getTimezoneOffset();
            
            // Create a new date that represents the local time
            const localDate = new Date(date.getTime() - (timezoneOffset * 60000));
            
            // Format as ISO string but remove the 'Z' to indicate it's local time
            // PostgreSQL timestamp format: YYYY-MM-DD HH:MM:SS.sss
            const isoString = localDate.toISOString();
            
            // Convert from 'YYYY-MM-DDTHH:MM:SS.sssZ' to 'YYYY-MM-DD HH:MM:SS.sss'
            return isoString.replace('T', ' ').replace('Z', '');
        }
        
        function toggleCompanyDropdown() {
            const selectElement = document.getElementById('companySelect');
            const isActive = selectElement.classList.contains('active');
            
            // Close all other dropdowns first
            closeAllDropdowns();
            
            if (!isActive) {
                selectElement.classList.add('active');
                selectElement.querySelector('.select-trigger').classList.add('active');
                
                // No need for complex positioning - using CSS absolute positioning
                const dropdown = selectElement.querySelector('.select-dropdown');
                
                // Check if there's enough space below, otherwise show above
                const triggerRect = selectElement.getBoundingClientRect();
                const modalContainer = document.querySelector('.modal-container');
                const modalRect = modalContainer ? modalContainer.getBoundingClientRect() : { bottom: window.innerHeight };
                const spaceBelow = modalRect.bottom - triggerRect.bottom;
                
                if (spaceBelow < 250) {
                    dropdown.style.top = 'auto';
                    dropdown.style.bottom = '100%';
                    dropdown.style.marginTop = '0';
                    dropdown.style.marginBottom = '4px';
                } else {
                    dropdown.style.top = '100%';
                    dropdown.style.bottom = 'auto';
                    dropdown.style.marginTop = '4px';
                    dropdown.style.marginBottom = '0';
                }
            }
        }
        
        function searchCompanies(searchTerm) {
            const filteredCompanies = availableCompanies.filter(company => 
                company.company_name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            const companyOptions = document.getElementById('companyOptions');
            companyOptions.innerHTML = createCompanyOptionsHTML(filteredCompanies);
        }
        
        function selectCompany(companyId, companyName) {
            const selectElement = document.getElementById('companySelect');
            const selectText = selectElement.querySelector('.select-text');
            
            // Update display
            selectText.textContent = companyName;
            selectText.classList.remove('placeholder');
            
            // Store selected data
            selectedCompanyData = {
                id: companyId,
                name: companyName
            };
            
            // Close dropdown
            selectElement.classList.remove('active');
            selectElement.querySelector('.select-trigger').classList.remove('active');
            
            console.log('Selected company:', selectedCompanyData);
            
            // Trigger form validation
            validateForm();
        }
        
        function closeAllDropdowns() {
            const dropdowns = document.querySelectorAll('.custom-select.active');
            dropdowns.forEach(dropdown => {
                dropdown.classList.remove('active');
                const trigger = dropdown.querySelector('.select-trigger');
                if (trigger) trigger.classList.remove('active');
            });
        }
        
        // Type dropdown functions
        function populateTypeDropdown() {
            const typeOptions = document.getElementById('typeOptions');
            if (!typeOptions) return;
            
            typeOptions.innerHTML = createTypeOptionsHTML(availableTypes);
        }
        
        function createTypeOptionsHTML(types) {
            return types.map(type => {
                const initials = type.label.split(' ').map(w => w[0]).join('').toUpperCase();
                
                return `
                    <div class="select-option" data-value="${type.value}" 
                         onclick="selectType('${type.value}', '${type.label}')">
                        <div class="option-icon">${initials}</div>
                        <div class="option-content">
                            <div class="option-name">${type.label}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function toggleTypeDropdown() {
            const selectElement = document.getElementById('typeSelect');
            const isActive = selectElement.classList.contains('active');
            
            // Close all other dropdowns first
            closeAllDropdowns();
            
            if (!isActive) {
                selectElement.classList.add('active');
                selectElement.querySelector('.select-trigger').classList.add('active');
                
                // No need for complex positioning - using CSS absolute positioning
                const dropdown = selectElement.querySelector('.select-dropdown');
                
                // Check if there's enough space below, otherwise show above
                const triggerRect = selectElement.getBoundingClientRect();
                const modalContainer = document.querySelector('.modal-container');
                const modalRect = modalContainer ? modalContainer.getBoundingClientRect() : { bottom: window.innerHeight };
                const spaceBelow = modalRect.bottom - triggerRect.bottom;
                
                if (spaceBelow < 250) {
                    dropdown.style.top = 'auto';
                    dropdown.style.bottom = '100%';
                    dropdown.style.marginTop = '0';
                    dropdown.style.marginBottom = '4px';
                } else {
                    dropdown.style.top = '100%';
                    dropdown.style.bottom = 'auto';
                    dropdown.style.marginTop = '4px';
                    dropdown.style.marginBottom = '0';
                }
            }
        }
        
        function searchTypes(searchTerm) {
            const filteredTypes = availableTypes.filter(type => 
                type.label.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            const typeOptions = document.getElementById('typeOptions');
            typeOptions.innerHTML = createTypeOptionsHTML(filteredTypes);
        }
        
        function selectType(typeValue, typeLabel) {
            const selectElement = document.getElementById('typeSelect');
            const selectText = selectElement.querySelector('.select-text');
            
            // Update display
            selectText.textContent = typeLabel;
            selectText.classList.remove('placeholder');
            
            // Store selected data
            selectedTypeData = {
                value: typeValue,
                label: typeLabel
            };
            
            // Close dropdown
            selectElement.classList.remove('active');
            selectElement.querySelector('.select-trigger').classList.remove('active');
            
            console.log('Selected type:', selectedTypeData);
            
            // Trigger form validation
            validateForm();
        }
        
        function closeAddCounterpartyModal() {
            const modal = document.getElementById('addCounterpartyModal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto'; // Restore scrolling
            resetModalForm();
        }
        
        function selectOrganizationType(type) {
            const externalBox = document.getElementById('externalBox');
            const internalBox = document.getElementById('internalBox');
            const companyGroup = document.getElementById('companyGroup');
            
            // Remove active class from both boxes
            externalBox.classList.remove('active');
            internalBox.classList.remove('active');
            
            // Add active class to selected box and update validation state
            if (type === 'internal') {
                internalBox.classList.add('active');
                companyGroup.style.display = 'block';
                isInternalSelected = true;
            } else {
                externalBox.classList.add('active');
                companyGroup.style.display = 'none';
                isInternalSelected = false;
                // Clear company selection when switching to external
                selectedCompanyData = null;
                const companySelectText = document.querySelector('#companySelect .select-text');
                if (companySelectText) {
                    companySelectText.textContent = 'Select company...';
                    companySelectText.classList.add('placeholder');
                }
            }
            
            // Trigger form validation
            validateForm();
        }
        
        function resetModalForm() {
            // Reset form
            document.getElementById('addCounterpartyForm').reset();
            
            // Reset selection boxes
            const externalBox = document.getElementById('externalBox');
            const internalBox = document.getElementById('internalBox');
            const companyGroup = document.getElementById('companyGroup');
            
            externalBox.classList.add('active');
            internalBox.classList.remove('active');
            companyGroup.style.display = 'none';
            
            // Reset company dropdown
            const companySelectText = document.querySelector('#companySelect .select-text');
            if (companySelectText) {
                companySelectText.textContent = 'Select company...';
                companySelectText.classList.add('placeholder');
            }
            
            // Reset type dropdown
            const typeSelectText = document.querySelector('#typeSelect .select-text');
            if (typeSelectText) {
                typeSelectText.textContent = 'Select type...';
                typeSelectText.classList.add('placeholder');
            }
            
            // Reset validation state
            selectedCompanyData = null;
            selectedTypeData = null;
            isInternalSelected = false;
            
            // Reset button state
            const createBtn = document.getElementById('createCounterpartyBtn');
            if (createBtn) {
                createBtn.disabled = true;
            }
            
            // Close any open dropdowns
            closeAllDropdowns();
        }
        
        async function saveCounterparty() {
            // Check if button is disabled
            const createBtn = document.getElementById('createCounterpartyBtn');
            if (createBtn && createBtn.disabled) {
                console.log('Form submission prevented: button is disabled');
                return false;
            }
            
            // Show loading state
            createBtn.disabled = true;
            createBtn.textContent = 'Creating...';
            
            try {
                // Collect form data
                const formData = collectFormData();
                console.log('Collected form data:', formData);
                
                // Validate data
                if (!formData) {
                    throw new Error('Failed to collect form data');
                }
                
                // Insert into database
                const result = await insertCounterparty(formData);
                
                if (result.success) {
                    showSuccess('Counterparty created successfully');
                    closeAddCounterpartyModal();
                    
                    // Refresh the counterparty data
                    if (currentCompanyId) {
                        loadCounterpartyData(currentCompanyId);
                    }
                } else {
                    throw new Error(result.error || 'Failed to create counterparty');
                }
                
            } catch (error) {
                console.error('Error saving counterparty:', error);
                showError('Failed to create counterparty: ' + error.message);
                
                // Restore button state
                createBtn.disabled = false;
                createBtn.textContent = 'Create Counterparty';
                
                // Re-validate form to restore proper button state
                validateForm();
            }
        }
        
        // Collect form data from all inputs
        function collectFormData() {
            try {
                // Get navbar selected company ID (this is the main company_id for the counterparty)
                const navbarCompanyId = appState.getSelectedCompanyId();
                if (!navbarCompanyId) {
                    throw new Error('No company selected in navbar');
                }
                
                // Get form field values
                const nameInput = document.getElementById('counterpartyName');
                const emailInput = document.getElementById('counterpartyEmail');
                const phoneInput = document.getElementById('counterpartyPhone');
                const notesInput = document.getElementById('counterpartyNote');
                
                const name = nameInput ? nameInput.value.trim() : '';
                const email = emailInput ? emailInput.value.trim() : '';
                const phone = phoneInput ? phoneInput.value.trim() : '';
                const notes = notesInput ? notesInput.value.trim() : '';
                
                // Validate required fields
                if (!name) {
                    throw new Error('Counterparty name is required');
                }
                
                if (!selectedTypeData) {
                    throw new Error('Type selection is required');
                }
                
                // Determine organization type
                const activeSelectionBox = document.querySelector('.selection-box.active');
                if (!activeSelectionBox) {
                    throw new Error('Organization type selection is required');
                }
                
                const isInternal = activeSelectionBox.id === 'internalBox';
                
                // Get linked company ID if internal is selected
                let linkedCompanyId = null;
                if (isInternal) {
                    if (!selectedCompanyData) {
                        throw new Error('Company selection is required for internal organization');
                    }
                    linkedCompanyId = selectedCompanyData.id;
                }
                
                // Get current local device time (not UTC)
                const now = new Date();
                const localTimestamp = getLocalTimestamp(now);
                
                return {
                    company_id: navbarCompanyId,
                    name: name,
                    type: selectedTypeData.value,
                    email: email || null,
                    phone: phone || null,
                    notes: notes || null,
                    is_internal: isInternal,
                    linked_company_id: linkedCompanyId,
                    is_deleted: false,
                    created_at: localTimestamp, // Use local device time
                    updated_at: localTimestamp  // Also set updated_at to current local time
                };
                
            } catch (error) {
                console.error('Error collecting form data:', error);
                throw error;
            }
        }
        
        // Insert counterparty into database
        async function insertCounterparty(data) {
            try {
                // Check if Supabase is available
                if (!supabase) {
                    throw new Error('Database connection not available');
                }
                
                console.log('Inserting counterparty with data:', data);
                
                const { data: result, error } = await supabase
                    .from('counterparties')
                    .insert([data])
                    .select(); // Return the inserted record
                
                if (error) {
                    console.error('Database insertion error:', error);
                    throw error;
                }
                
                console.log('Counterparty inserted successfully:', result);
                return { success: true, data: result };
                
            } catch (error) {
                console.error('Error inserting counterparty:', error);
                return { success: false, error: error.message };
            }
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const addModal = document.getElementById('addCounterpartyModal');
            const deleteModal = document.getElementById('deleteConfirmationModal');
            
            if (event.target === addModal) {
                closeAddCounterpartyModal();
            }
            
            if (event.target === deleteModal) {
                closeDeleteConfirmationModal();
            }
            
            // Close dropdowns when clicking outside
            if (!event.target.closest('.custom-select')) {
                closeAllDropdowns();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const addModal = document.getElementById('addCounterpartyModal');
                const deleteModal = document.getElementById('deleteConfirmationModal');
                
                if (addModal && addModal.classList.contains('active')) {
                    closeAddCounterpartyModal();
                } else if (deleteModal && deleteModal.style.display === 'flex') {
                    closeDeleteConfirmationModal();
                } else {
                    // Close dropdowns with Escape key
                    closeAllDropdowns();
                }
            }
        });
        
        // Global variable to store the counterparty ID to delete
        let counterpartyToDelete = null;
        
        function deleteCounterparty(id, event) {
            console.log('Delete button clicked for counterparty ID:', id);
            
            // Prevent event bubbling to parent elements
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                console.log('Event prevented and stopped propagation');
            }
            
            // Store the ID and show confirmation modal
            counterpartyToDelete = id;
            console.log('Showing delete confirmation modal');
            showDeleteConfirmationModal();
        }
        
        function showDeleteConfirmationModal() {
            const modal = document.getElementById('deleteConfirmationModal');
            console.log('Modal element found:', modal);
            
            if (modal) {
                // Add the active class to trigger the CSS transition
                modal.classList.add('active');
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                console.log('Modal activated with active class');
                console.log('Modal display set to:', modal.style.display);
            } else {
                console.error('deleteConfirmationModal element not found!');
            }
        }
        
        function closeDeleteConfirmationModal() {
            const modal = document.getElementById('deleteConfirmationModal');
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
                document.body.style.overflow = '';
                counterpartyToDelete = null;
                console.log('Modal closed and active class removed');
            }
        }
        
        async function confirmDeleteCounterparty() {
            if (!counterpartyToDelete) {
                return;
            }
            
            try {
                // Show loading state on delete button
                const deleteBtn = document.getElementById('confirmDeleteBtn');
                const originalText = deleteBtn.textContent;
                deleteBtn.textContent = 'Deleting...';
                deleteBtn.disabled = true;
                
                // Soft delete by setting is_deleted to true
                const { error } = await supabase
                    .from('counterparties')
                    .update({ is_deleted: true })
                    .eq('counterparty_id', counterpartyToDelete)
                    .eq('company_id', currentCompanyId);
                
                if (error) {
                    throw error;
                }
                
                // Close modal
                closeDeleteConfirmationModal();
                
                // Show success message
                showSuccess('Counterparty deleted successfully');
                
                // Refresh the page immediately to show updated data
                setTimeout(() => {
                    window.location.reload();
                }, 500);
                
            } catch (error) {
                console.error('Error deleting counterparty:', error);
                showError('Failed to delete counterparty');
                
                // Reset button state
                const deleteBtn = document.getElementById('confirmDeleteBtn');
                deleteBtn.textContent = 'Delete';
                deleteBtn.disabled = false;
            }
        }
        
        // Utility functions for user feedback
        function showError(message) {
            console.error(message);
            
            // Create error toast notification
            createToastNotification(message, 'error');
        }
        
        function showSuccess(message) {
            console.log(message);
            
            // Create success toast notification
            createToastNotification(message, 'success');
        }
        
        // Create toast notification
        function createToastNotification(message, type = 'info') {
            // Remove any existing toasts
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon">
                        ${type === 'success' ? '' : type === 'error' ? '' : ''}
                    </div>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            // Add toast styles
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                background: ${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6'};
                color: white;
                padding: 16px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                max-width: 400px;
                animation: slideInRight 0.3s ease-out;
            `;
            
            // Style the content
            const content = toast.querySelector('.toast-content');
            content.style.cssText = `
                display: flex;
                align-items: center;
                gap: 12px;
            `;
            
            const closeBtn = toast.querySelector('.toast-close');
            closeBtn.style.cssText = `
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                padding: 0;
                margin-left: auto;
                opacity: 0.8;
                transition: opacity 0.2s;
            `;
            
            closeBtn.addEventListener('mouseenter', () => closeBtn.style.opacity = '1');
            closeBtn.addEventListener('mouseleave', () => closeBtn.style.opacity = '0.8');
            
            // Add slide-in animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            `;
            document.head.appendChild(style);
            
            // Add to document
            document.body.appendChild(toast);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideOutRight 0.3s ease-in forwards';
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.remove();
                        }
                    }, 300);
                }
            }, 5000);
            
            // Add slide-out animation
            style.textContent += `
                @keyframes slideOutRight {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
        }
    </script>
</body>
</html>