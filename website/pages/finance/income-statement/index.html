<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance - Income Statement</title>
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="../../../core/themes/toss-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-component-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-base.css">
    <link rel="stylesheet" href="../../../core/themes/toss-typography.css">
    
    <!-- Component CSS -->
    <link rel="stylesheet" href="../../../components/base/toss-button.css">
    <link rel="stylesheet" href="../../../components/form/toss-input.css">
    <link rel="stylesheet" href="../../../components/form/toss-select.css">
    <link rel="stylesheet" href="../../../components/form/toss-filter.css">
    <link rel="stylesheet" href="../../../components/form/toss-income-statement-filter.css">
    <link rel="stylesheet" href="../../../components/feedback/toss-alert.css">
    <link rel="stylesheet" href="../../../components/navigation/navbar.css">
    <link rel="stylesheet" href="../../../components/data/toss-financial-section-header.css">
    <link rel="stylesheet" href="../../../components/data/toss-income-statement-table.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Page Specific Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background: var(--toss-gray-50);
            min-height: 100vh;
        }
        
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .page-content {
            flex: 1;
            padding: var(--space-6);
            max-width: var(--container-max-width, 1400px);
            margin: 0 auto;
            width: 100%;
        }
        
        .page-header {
            margin-bottom: var(--space-8);
        }
        
        .page-title {
            font-size: var(--font-h1);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .page-subtitle {
            font-size: var(--font-large);
            color: var(--text-secondary);
            margin: 0;
        }
        
        .content-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
        }
        
        .coming-soon {
            text-align: center;
            padding: var(--space-16) var(--space-6);
        }
        
        .coming-soon-icon {
            width: var(--icon-size-xl, 120px);
            height: var(--icon-size-xl, 120px);
            margin: 0 auto var(--space-6);
            background: var(--toss-primary-surface);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--toss-primary);
        }
        
        .coming-soon-title {
            font-size: var(--font-h2);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            margin: 0 0 var(--space-3) 0;
        }
        
        .coming-soon-text {
            font-size: var(--font-large);
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Income Statement Specific Styles */
        .income-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(var(--card-min-width, 240px), 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }
        
        .summary-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            box-shadow: var(--shadow-sm);
            border-left: var(--border-width-thick, 4px) solid;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .summary-card:hover {
            transform: translateY(var(--hover-offset, -2px));
            box-shadow: var(--shadow-md);
        }
        
        .summary-card.revenue {
            border-left-color: var(--toss-primary);
        }
        
        .summary-card.profit {
            border-left-color: var(--toss-success);
        }
        
        .summary-card.operating {
            border-left-color: var(--toss-warning);
        }
        
        .summary-card.net {
            border-left-color: var(--toss-info);
        }
        
        .summary-card-label {
            font-size: var(--font-small);
            font-weight: var(--font-semibold);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide, 0.5px);
            margin-bottom: var(--space-2);
        }
        
        .summary-card-value {
            font-size: var(--font-h3);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            font-family: var(--font-family-mono);
            letter-spacing: var(--letter-spacing-tight, -0.5px);
        }
        
        .summary-card-percent {
            font-size: var(--font-small);
            color: var(--text-secondary);
            margin-top: var(--space-1);
        }
        
        /* Income Statement Table */
        .income-statement-table {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
        }
        
        .income-statement-header {
            background: linear-gradient(180deg, var(--toss-gray-50) 0%, var(--toss-white) 100%);
            padding: var(--space-5) var(--space-6);
            border-bottom: var(--border-width-medium, 2px) solid var(--toss-gray-200);
        }
        
        .income-statement-header h3 {
            font-size: var(--font-h3);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            margin: 0 0 var(--space-1) 0;
        }
        
        .period-info {
            font-size: var(--font-small);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide, 0.5px);
        }
        
        .income-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .income-table thead {
            background: linear-gradient(180deg, var(--toss-gray-50) 0%, var(--toss-white) 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .income-table th {
            padding: var(--space-5) var(--space-6);
            text-align: left;
            font-size: var(--font-small);
            font-weight: var(--font-bold);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide, 0.5px);
            border-bottom: var(--border-width-medium, 2px) solid var(--toss-gray-200);
        }
        
        .income-table th:last-child {
            text-align: right;
        }
        
        /* Section Headers - Enhanced border rendering with component integration */
        .section-header td {
            background: var(--toss-gray-50) !important;
            color: var(--toss-text-primary) !important;
            font-weight: var(--font-bold);
            font-size: var(--font-base);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wider, 1px);
            padding: var(--space-4) var(--space-6);
            border: 2px solid var(--toss-primary) !important;
            box-sizing: border-box;
            position: relative;
        }
        
        /* Ensure section header borders are complete */
        .section-header td::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid var(--toss-primary);
            pointer-events: none;
        }
        
        /* Section header variants with proper border rendering */
        .section-header.revenue-section td,
        .section-header.cogs-section td,
        .section-header.expense-section td,
        .section-header.default-section td {
            background: var(--toss-gray-50) !important;
            border-color: var(--toss-gray-200) !important;
            color: var(--toss-text-primary) !important;
        }
        
        .section-header.revenue-section td::after,
        .section-header.cogs-section td::after,
        .section-header.expense-section td::after,
        .section-header.default-section td::after {
            border-color: var(--toss-primary);
        }
        
        .section-header.net-income-section td {
            background: var(--toss-gray-50) !important;
            border-color: var(--toss-gray-200) !important;
            color: var(--toss-text-primary) !important;
        }
        
        .section-header.net-income-section td::after {
            border-color: var(--toss-success);
        }
        
        /* Legacy styles for compatibility */
        .section-header.revenue-section td,
        .section-header.cogs-section td,
        .section-header.expense-section td,
        .section-header.net-income-section td,
        .section-header.default-section td {
            background: var(--toss-primary);
            color: var(--toss-white);
            border-top: var(--border-width-medium) solid var(--toss-primary);
            border-bottom: var(--border-width-medium) solid var(--toss-primary);
            border-left: var(--border-width-medium) solid var(--toss-primary);
            border-right: var(--border-width-medium) solid var(--toss-primary);
        }
        
        .subsection-header td {
            background: var(--toss-gray-50);
            font-weight: var(--font-semibold);
            color: var(--text-secondary);
            padding: var(--space-3) var(--space-6);
            padding-left: var(--space-8);
            font-size: var(--font-small);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide, 0.5px);
        }
        
        /* Regular Rows */
        .income-table tbody tr {
            transition: background-color 0.15s;
            border-bottom: var(--border-width-thin, 1px) solid var(--toss-gray-50);
        }
        
        .income-table tbody tr:hover:not(.section-header):not(.subsection-header):not(.total-row):not(.section-total-row):not(.grand-total-row) {
            background: var(--toss-gray-50);
        }
        
        .income-table td {
            padding: var(--space-4) var(--space-6);
            font-size: var(--font-base);
            color: var(--text-primary);
        }
        
        /* Account Name Indentation */
        .account-name {
            padding-left: var(--space-10) !important;
            position: relative;
        }
        
        .account-name::before {
            content: "•";
            position: absolute;
            left: var(--space-8);
            color: var(--toss-gray-400);
        }
        
        /* Amount Formatting */
        .amount {
            text-align: right;
            font-family: var(--font-family-mono);
            font-variant-numeric: tabular-nums;
            letter-spacing: var(--letter-spacing-wide, 0.5px);
            font-weight: var(--font-medium);
        }
        
        .amount.negative {
            color: var(--toss-error);
        }
        
        .amount.zero {
            color: var(--toss-gray-400);
            font-size: var(--font-small);
        }
        
        /* Total Rows */
        .total-row td {
            font-weight: var(--font-bold);
            background: var(--toss-gray-50);
            border-top: var(--border-width-thin, 1px) solid var(--toss-gray-200);
            border-bottom: var(--border-width-thin, 1px) solid var(--toss-gray-200);
            color: var(--text-primary);
        }
        
        /* Legacy section total row styles - now handled by component */
        .section-total-row td {
            font-weight: var(--font-bold);
            background: var(--toss-primary-surface) !important;
            color: var(--toss-primary) !important;
            font-size: var(--font-base);
            padding: var(--space-4) var(--space-6);
            border-top: 2px solid var(--toss-primary);
            border-bottom: 2px solid var(--toss-primary);
        }
        
        .section-total-row td:first-child {
            border-left: 2px solid var(--toss-primary);
        }
        
        .section-total-row td:last-child {
            border-right: 2px solid var(--toss-primary);
        }
        
        /* Legacy grand total row styles - now handled by component */
        .grand-total-row td {
            font-weight: var(--font-bold);
            background: var(--toss-success-light) !important;
            color: var(--toss-success-dark) !important;
            font-size: var(--font-base);
            padding: var(--space-4) var(--space-6);
            border-top: 2px solid var(--toss-success);
            border-bottom: 2px solid var(--toss-success);
        }
        
        .grand-total-row td:first-child {
            border-left: 2px solid var(--toss-success);
        }
        
        .grand-total-row td:last-child {
            border-right: 2px solid var(--toss-success);
        }
        
        /* Financial Ratios */
        .financial-ratios {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
        }
        
        .financial-ratios h3 {
            font-size: var(--font-h3);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            margin: 0 0 var(--space-4) 0;
        }
        
        .ratios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(var(--ratio-card-min-width, 200px), 1fr));
            gap: var(--space-4);
        }
        
        .ratio-card {
            background: var(--toss-gray-50);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            text-align: center;
            border: var(--border-width-thin, 1px) solid var(--toss-gray-100);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .ratio-card:hover {
            transform: translateY(var(--hover-offset-small, -1px));
            box-shadow: var(--shadow-sm);
        }
        
        .ratio-label {
            font-size: var(--font-small);
            font-weight: var(--font-semibold);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide, 0.5px);
            margin-bottom: var(--space-2);
        }
        
        .ratio-value {
            font-size: var(--font-h2);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            font-family: var(--font-family-mono);
        }
        
        /* Currency Symbol */
        .currency-symbol {
            opacity: 0.8;
            margin-right: var(--spacing-xs, 2px);
            font-weight: var(--font-medium);
        }
        
        /* Professional financial formatting styles */
        .amount.zero {
            color: var(--text-tertiary);
            text-align: center;
            font-style: normal;
            opacity: 0.7;
        }
        
        /* Ensure zero amounts are clearly visible but subtle */
        .amount.zero::before {
            content: '';
        }
        
        .amount.zero::after {
            content: '';
        }
        
        /* Enhanced section total styling */
        .section-total-row .amount,
        .grand-total-row .amount {
            background: var(--toss-gray-50);
            border-top: 1px solid var(--toss-gray-200);
            border-bottom: 1px solid var(--toss-gray-200);
        }
        
        /* Spacer Row */
        .spacer-row td {
            height: var(--space-5);
            border: none;
            background: transparent;
        }
        
        /* Loading State */
        .loading-container {
            text-align: center;
            padding: var(--space-10);
        }
        
        .loading-text {
            margin-top: var(--space-4);
            color: var(--text-secondary);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-16) var(--space-6);
        }
        
        .empty-icon {
            width: var(--icon-size-lg, 80px);
            height: var(--icon-size-lg, 80px);
            margin: 0 auto var(--space-4);
            background: var(--toss-gray-100);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--toss-gray-400);
        }
        
        .empty-title {
            font-size: var(--font-h3);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .empty-text {
            font-size: var(--font-base);
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* 12-Month Income Statement Styles */
        .income-statement-12month-table {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            overflow-x: auto;
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
        }
        
        .income-12month-table {
            width: 100%;
            min-width: var(--table-min-width, 1200px);
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .income-12month-table thead {
            background: linear-gradient(180deg, var(--toss-gray-50) 0%, var(--toss-white) 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .month-header-row th {
            padding: var(--space-4) var(--space-2);
            text-align: center;
            font-size: var(--font-small);
            font-weight: var(--font-bold);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide, 0.5px);
            border-bottom: var(--border-width-medium, 2px) solid var(--toss-gray-200);
            white-space: nowrap;
            vertical-align: middle;
            height: var(--header-height, 60px);
            min-height: var(--header-height, 60px);
        }
        
        .account-column {
            width: var(--account-column-width, 200px);
            text-align: left !important;
            min-width: var(--account-column-min-width, 150px);
        }
        
        .month-column {
            width: var(--month-column-width, 80px);
            min-width: var(--month-column-min-width, 70px);
        }
        
        .total-column {
            width: var(--total-column-width, 100px);
            min-width: var(--total-column-min-width, 90px);
            background: var(--toss-gray-50);
            font-weight: var(--font-bold);
        }
        
        .income-12month-table .section-header td {
            background: var(--toss-primary) !important;
            color: var(--toss-white) !important;
            font-weight: var(--font-bold);
            font-size: var(--font-base);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wider, 1px);
            padding: var(--space-4) var(--space-3);
            border: 2px solid var(--toss-primary) !important;
            box-sizing: border-box;
            position: relative;
        }
        
        /* Ensure 12-month section header borders are complete */
        .income-12month-table .section-header td::after {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid var(--toss-primary);
            pointer-events: none;
        }
        
        /* 12-month Net Income section special styling */
        .income-12month-table .section-header.net-income-section td {
            background: var(--toss-success) !important;
            border-color: var(--toss-success) !important;
        }
        
        .income-12month-table .section-header.net-income-section td::after {
            border-color: var(--toss-success);
            border-right: var(--border-width-medium) solid var(--toss-primary);
        }
        
        .income-12month-table .subsection-header td {
            background: var(--toss-gray-50);
            font-weight: var(--font-semibold);
            color: var(--text-secondary);
            padding: var(--space-3) var(--space-3);
            font-size: var(--font-small);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-wide, 0.5px);
        }
        
        .income-12month-table tbody tr {
            transition: background-color 0.15s;
            border-bottom: var(--border-width-thin, 1px) solid var(--toss-gray-50);
        }
        
        .income-12month-table tbody tr:hover:not(.section-header):not(.subsection-header):not(.total-row):not(.section-total-row):not(.grand-total-row) {
            background: var(--toss-gray-50);
        }
        
        .income-12month-table td {
            padding: var(--space-2) var(--spacing-xs, 2px);
            font-size: var(--font-base) !important;
            color: var(--text-primary);
            text-align: right;
        }
        
        .income-12month-table .account-name {
            text-align: left !important;
            padding-left: var(--space-4) !important;
            font-weight: var(--font-medium);
            max-width: var(--account-name-max-width, 180px);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .income-12month-table .amount {
            text-align: right;
            font-family: var(--font-family-mono);
            font-variant-numeric: tabular-nums;
            font-size: var(--font-small);
            font-weight: var(--font-medium);
        }
        
        .income-12month-table .total-amount {
            background: var(--toss-gray-50);
            font-weight: var(--font-bold);
        }
        
        .income-12month-table .total-row td {
            font-weight: var(--font-bold);
            background: var(--toss-gray-100);
            border-top: var(--border-width-thin, 1px) solid var(--toss-gray-200);
            color: var(--text-primary);
        }
        
        /* Legacy 12-month section total styles - now handled by component */
        .income-12month-table .section-total-row td {
            font-weight: var(--font-bold);
            background: var(--toss-primary-surface) !important;
            color: var(--toss-primary) !important;
            font-size: var(--font-base) !important;
            padding: var(--space-3) var(--spacing-xs, 2px);
            border-top: 2px solid var(--toss-primary);
            border-bottom: 2px solid var(--toss-primary);
        }
        
        .income-12month-table .section-total-row td:first-child {
            border-left: 2px solid var(--toss-primary);
        }
        
        .income-12month-table .section-total-row td:last-child {
            border-right: 2px solid var(--toss-primary);
        }
        
        /* Legacy 12-month grand total styles - now handled by component */
        .income-12month-table .grand-total-row td {
            font-weight: var(--font-bold);
            background: var(--toss-success-light) !important;
            color: var(--toss-success-dark) !important;
            font-size: var(--font-base) !important;
            padding: var(--space-4) var(--spacing-xs, 2px);
            border-top: 2px solid var(--toss-success);
            border-bottom: 2px solid var(--toss-success);
        }
        
        .income-12month-table .grand-total-row td:first-child {
            border-left: 2px solid var(--toss-success);
        }
        
        .income-12month-table .grand-total-row td:last-child {
            border-right: 2px solid var(--toss-success);
        }
        
        /* Responsive adjustments for 12-month table */
        @media (max-width: 1400px) {
            .income-12month-table {
                min-width: var(--table-min-width-mobile, 1000px);
            }
            
            .month-header-row th {
                padding: var(--space-3) var(--space-1);
                font-size: var(--font-small);
                height: var(--header-height-mobile, 50px);
                min-height: var(--header-height-mobile, 50px);
            }
            
            .income-12month-table td,
            .income-12month-table .section-total-row td,
            .income-12month-table .grand-total-row td {
                padding: var(--space-1) var(--space-1);
                font-size: var(--font-small) !important;
            }
            
            .account-column {
                width: var(--account-column-width-mobile, 150px);
                min-width: var(--account-column-min-width-mobile, 120px);
            }
            
            .month-column {
                width: var(--month-column-width-mobile, 60px);
                min-width: var(--month-column-min-width-mobile, 50px);
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Navigation Bar -->
        <div id="navbar-container"></div>
        
        <!-- Page Content -->
        <main class="page-content">
            <div class="page-header">
                <h1 class="page-title">Income Statement</h1>
                <p class="page-subtitle">View revenue and expenses</p>
            </div>
            
            <!-- Filter Component Container -->
            <div id="income-statement-filter"></div>
            
            <div class="content-card" id="income-statement-content">
                <div class="coming-soon">
                    <div class="coming-soon-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H7v-2h5v2zm5-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                    </div>
                    <h2 class="coming-soon-title">Select Filters to Load Income Statement</h2>
                    <p class="coming-soon-text">Choose Monthly type and date range, then click Search to view the income statement.</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Component JavaScript -->
    <script src="../../../components/base/toss-button.js"></script>
    <script src="../../../components/form/toss-input.js"></script>
    <script src="../../../components/form/toss-select.js"></script>
    <script src="../../../components/form/toss-filter.js"></script>
    <script src="../../../components/form/toss-income-statement-filter.js"></script>
    <script src="../../../components/navigation/navbar.js"></script>
    <script src="../../../components/feedback/toss-alert.js"></script>
    
    <!-- Core Scripts -->
    <script src="../../../core/constants/app-icons.js"></script>
    <script src="../../../core/config/supabase.js"></script>
    
    <!-- App State Management -->
    <script src="../../../core/utils/app-state.js"></script>
    
    <!-- Route Mapping -->
    <script src="../../../core/config/route-mapping.js"></script>
    
    <!-- Page Initialization Utility -->
    <script src="../../../core/utils/page-init.js"></script>
    
    <script>
        // Set flag immediately to prevent navbar auto-init
        window.skipNavbarAutoInit = true;
        
        // Professional number formatting functions
        function formatNumber(amount) {
            // Format number with commas, no currency symbol
            // Handle null/undefined values
            if (amount === null || amount === undefined) return '0';
            return Math.abs(amount).toLocaleString('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            });
        }
        
        // Note: Currency symbols removed for cleaner professional display
        // Currency indication is now shown in table headers only
        
        function formatCleanNumber(amount) {
            // Clean number formatting for data cells - no currency symbol
            // Handle null, undefined, and zero values consistently
            if (amount === null || amount === undefined) return '0';
            if (amount === 0) return '0';
            return formatNumber(amount);
        }
        
        // Initialize page using standardized pattern
        window.initializePage('finance', (companyId, company) => {
            console.log('Company changed in income statement:', companyId);
            // Reload stores when company changes
            loadStoresFromSession();
            // For now, just keep showing the coming soon message
            // The filter is ready for when the feature is implemented
        });
        
        // Additional page initialization after navbar is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for page initialization to complete, then initialize page-specific content
            setTimeout(() => {
                // Initialize the filter component first
                initializeFilterComponent();
                
                // Income statement is still under development
                // Filter is ready for future implementation
            }, 100);
            
            // Listen for company changes from navbar
            window.addEventListener('companyChanged', (event) => {
                console.log('Company changed event received:', event.detail);
                // Reload stores when company changes
                loadStoresFromSession();
            });
        });
        
        // Initialize the filter component
        let incomeStatementFilter = null;
        
        function initializeFilterComponent() {
            // Create the income statement filter component with Type selector
            incomeStatementFilter = new TossIncomeStatementFilter({
                container: '#income-statement-filter',
                title: 'Filters',
                showStoreFilter: true,
                showTypeFilter: true,
                showDateFilters: true,
                storeLabel: 'Store',
                typeLabel: 'Type',
                fromDateLabel: 'From Date',
                toDateLabel: 'To Date',
                defaultExpanded: true,
                onSearch: (filters) => {
                    console.log('Searching with filters:', filters);
                    applyFiltersAndLoadData(filters);
                },
                onClear: () => {
                    console.log('Filters cleared');
                    const companyId = appState.getSelectedCompanyId();
                    if (companyId) {
                        loadIncomeStatementData(companyId);
                    }
                },
                onFilterChange: (filters) => {
                    console.log('Filter changed:', filters);
                }
            });
        }
        
        // Apply filters and reload income statement data
        function applyFiltersAndLoadData(filters) {
            const companyId = appState.getSelectedCompanyId();
            if (!companyId) {
                console.log('No company selected');
                return;
            }
            
            console.log('Loading income statement with filters:', {
                companyId: companyId,
                storeId: filters.store || 'all',
                type: filters.type || 'monthly',
                fromDate: filters.fromDate,
                toDate: filters.toDate
            });
            
            loadIncomeStatementData(companyId, filters);
        }
        
        // Load income statement data for company
        function loadIncomeStatementData(companyId, filters = null) {
            console.log('Loading income statement for company:', companyId, 'with filters:', filters);
            
            // If no filters provided, use current filter values
            if (!filters && incomeStatementFilter) {
                filters = incomeStatementFilter.getFilters();
            }
            
            // Check type and call appropriate RPC
            if (filters && filters.type === 'monthly') {
                callIncomeStatementRPC(companyId, filters);
            } else if (filters && filters.type === '12month') {
                callIncomeStatementMonthlyRPC(companyId, filters);
            } else {
                // For no type, show coming soon message
                showComingSoonMessage();
            }
        }
        
        // Call the income statement RPC
        async function callIncomeStatementRPC(companyId, filters) {
            try {
                // Show loading state
                showLoadingState();
                
                // Prepare RPC parameters
                const params = {
                    p_company_id: companyId,
                    p_store_id: filters?.store || null,  // null for "All Stores"
                    p_start_date: filters?.fromDate || null,
                    p_end_date: filters?.toDate || null
                };
                
                console.log('Calling get_income_statement_v2 RPC with params:', params);
                
                // Call the RPC
                const { data, error } = await supabase.rpc('get_income_statement_v2', params);
                
                if (error) {
                    console.error('Error calling get_income_statement_v2:', error);
                    showErrorState(error.message);
                    return;
                }
                
                console.log('Income statement data received:', data);
                
                // Display the income statement data
                if (data && Array.isArray(data) && data.length > 0) {
                    await displayIncomeStatement(data, filters);
                } else {
                    showEmptyState('No income statement data available for the selected period');
                }
                
            } catch (error) {
                console.error('Error in income statement RPC:', error);
                showErrorState('Failed to load income statement');
            }
        }
        
        // Call the 12-month income statement RPC
        async function callIncomeStatementMonthlyRPC(companyId, filters) {
            try {
                // Show loading state
                showLoadingState();
                
                // Get current year's first and last date
                const now = new Date();
                const currentYear = now.getFullYear();
                
                // First day of current year (January 1st)
                const firstDay = new Date(currentYear, 0, 1); // 0 = January
                const startDate = formatDateForRPC(firstDay);
                
                // Last day of current year (December 31st)
                const lastDay = new Date(currentYear, 11, 31); // 11 = December
                const endDate = formatDateForRPC(lastDay);
                
                // Prepare RPC parameters
                const params = {
                    p_company_id: companyId,
                    p_store_id: filters?.store || null,  // null for "All Stores"
                    p_start_date: startDate,
                    p_end_date: endDate
                };
                
                console.log('Calling get_income_statement_monthly RPC with params:', params);
                
                // Call the RPC
                const { data, error } = await supabase.rpc('get_income_statement_monthly', params);
                
                if (error) {
                    console.error('Error calling get_income_statement_monthly:', error);
                    showErrorState(error.message);
                    return;
                }
                
                console.log('12-month income statement data received:', data);
                
                // Display the 12-month income statement data
                if (data && data.sections && data.months) {
                    await display12MonthIncomeStatement(data, filters);
                } else {
                    showEmptyState('No 12-month income statement data available');
                }
                
            } catch (error) {
                console.error('Error in 12-month income statement RPC:', error);
                showErrorState('Failed to load 12-month income statement');
            }
        }
        
        // Format date for RPC (yyyy-MM-dd format)
        function formatDateForRPC(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // Display the 12-month income statement data
        async function display12MonthIncomeStatement(data, filters) {
            const contentCard = document.querySelector('#income-statement-content');
            if (!contentCard) return;
            
            // Get company's base currency symbol
            const currency = await getCompanyCurrency();
            
            // Extract data
            const { summary, months, sections } = data;
            
            // Create the 12-month income statement display
            let html = `
                <!-- 12-Month Income Statement Header -->
                <div class="income-statement-header">
                    <h3>Income Statement - 12 Month View</h3>
                    <div class="period-info">
                        Period: ${summary?.period_info?.start_date || 'N/A'} to ${summary?.period_info?.end_date || 'N/A'}
                        ${summary?.period_info?.store_scope === 'all_stores' ? ' (All Stores)' : ''}
                    </div>
                </div>
                
                <!-- 12-Month Table -->
                <div class="income-statement-12month-table">
                    <table class="toss-income-table toss-income-table-12month">
                        <thead>
                            <tr class="month-header-row">
                                <th class="account-column">Account<br><small style="font-weight: normal; text-transform: none; color: var(--text-tertiary);">(in ${currency})</small></th>
            `;
            
            // Add month headers
            months.forEach(month => {
                const monthDisplay = formatMonthDisplay(month);
                html += `<th class="month-column">${monthDisplay}</th>`;
            });
            html += `<th class="total-column">Total</th></tr></thead><tbody>`;
            
            // Process each section
            sections.forEach(section => {
                // Section header with clean design
                const sectionType = section.section.toLowerCase().replace(/ /g, '-');
                html += `
                    <tr class="toss-income-section-header ${sectionType}">
                        <td colspan="${months.length + 2}">${section.section.toUpperCase()}</td>
                    </tr>
                `;
                
                // Process subcategories
                if (section.subcategories && section.subcategories.length > 0) {
                    section.subcategories.forEach(subcategory => {
                        // Subcategory header
                        html += `
                            <tr class="toss-income-subsection-header">
                                <td colspan="${months.length + 2}">${subcategory.subcategory}</td>
                            </tr>
                        `;
                        
                        // Process accounts
                        if (subcategory.accounts && subcategory.accounts.length > 0) {
                            subcategory.accounts.forEach(account => {
                                html += `<tr><td class="toss-income-account-name">${account.account_name}</td>`;
                                
                                // Add monthly amounts (clean numbers, no currency symbols)
                                months.forEach(month => {
                                    let amount = account.monthly_amounts[month];
                                    // Ensure we handle null/undefined properly
                                    if (amount === null || amount === undefined) {
                                        amount = 0;
                                    }
                                    const amountClass = amount === 0 ? 'zero' : (amount < 0 ? 'negative' : '');
                                    html += `<td class="toss-income-amount ${amountClass}">${formatCleanNumber(amount)}</td>`;
                                });
                                
                                // Add total (clean number for account totals)
                                let totalAmount = account.total;
                                // Ensure we handle null/undefined properly
                                if (totalAmount === null || totalAmount === undefined) {
                                    totalAmount = 0;
                                }
                                const totalClass = totalAmount === 0 ? 'zero' : (totalAmount < 0 ? 'negative' : '');
                                html += `<td class="toss-income-amount total-column ${totalClass}">${formatCleanNumber(totalAmount)}</td></tr>`;
                            });
                        }
                        
                        // Subcategory totals row (clean numbers)
                        html += `<tr class="toss-income-total-row"><td>Total ${subcategory.subcategory}</td>`;
                        months.forEach(month => {
                            let amount = subcategory.subcategory_monthly_totals[month];
                            if (amount === null || amount === undefined) {
                                amount = 0;
                            }
                            html += `<td class="toss-income-amount">${formatCleanNumber(amount)}</td>`;
                        });
                        let subTotal = subcategory.subcategory_total;
                        if (subTotal === null || subTotal === undefined) {
                            subTotal = 0;
                        }
                        html += `<td class="toss-income-amount total-column">${formatCleanNumber(subTotal)}</td></tr>`;
                    });
                }
                
                // Section totals row (clean numbers only - currency indicated in header)
                const totalRowClass = section.section === 'Net Income' ? 'toss-income-grand-total' : 'toss-income-section-total';
                html += `<tr class="${totalRowClass}"><td><strong>${section.section.toUpperCase()}</strong></td>`;
                months.forEach(month => {
                    let amount = section.section_monthly_totals[month];
                    if (amount === null || amount === undefined) {
                        amount = 0;
                    }
                    html += `<td class="toss-income-amount"><strong>${formatCleanNumber(amount)}</strong></td>`;
                });
                let sectionTotal = section.section_total;
                if (sectionTotal === null || sectionTotal === undefined) {
                    sectionTotal = 0;
                }
                html += `<td class="toss-income-amount total-column"><strong>${formatCleanNumber(sectionTotal)}</strong></td></tr>`;
                
                // Add spacer
                html += `<tr class="toss-income-spacer"><td colspan="${months.length + 2}"></td></tr>`;
            });
            
            html += `</tbody></table></div>`;
            
            contentCard.innerHTML = html;
        }
        
        // Format month display (2025-01 -> Jan 2025)
        function formatMonthDisplay(monthString) {
            const [year, month] = monthString.split('-');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                               'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${year}\n${monthNames[parseInt(month) - 1]}`;
        }
        
        // Get company's base currency information
        async function getCompanyCurrency() {
            try {
                const companyId = appState.getSelectedCompanyId();
                if (!companyId) {
                    console.log('No company selected, using default currency');
                    return '$'; // Default fallback
                }
                
                // Query companies table to get base_currency_id
                const { data: companyData, error: companyError } = await supabase
                    .from('companies')
                    .select('base_currency_id')
                    .eq('company_id', companyId)
                    .single();
                
                if (companyError) {
                    console.error('Error fetching company currency:', companyError);
                    return '$'; // Default fallback
                }
                
                if (!companyData || !companyData.base_currency_id) {
                    console.log('No base currency found for company, using default');
                    return '$'; // Default fallback
                }
                
                // Query currency_types table to get currency symbol
                const { data: currencyData, error: currencyError } = await supabase
                    .from('currency_types')
                    .select('currency_code, currency_name, symbol')
                    .eq('currency_id', companyData.base_currency_id)
                    .single();
                
                if (currencyError) {
                    console.error('Error fetching currency details:', currencyError);
                    return '$'; // Default fallback
                }
                
                if (currencyData && currencyData.symbol) {
                    console.log('Using company currency:', currencyData);
                    return currencyData.symbol;
                } else {
                    console.log('No currency symbol found, using default');
                    return '$'; // Default fallback
                }
                
            } catch (error) {
                console.error('Error in getCompanyCurrency:', error);
                return '$'; // Default fallback
            }
        }
        
        // Display the income statement data
        async function displayIncomeStatement(data, filters) {
            const contentCard = document.querySelector('#income-statement-content');
            if (!contentCard) return;
            
            // Find key sections for summary
            const revenueSection = data.find(section => section.section === 'Revenue');
            const grossProfitSection = data.find(section => section.section === 'Gross Profit');
            const operatingIncomeSection = data.find(section => section.section === 'Operating Income');
            const netIncomeSection = data.find(section => section.section === 'Net Income');
            const grossMarginSection = data.find(section => section.section === 'Gross Margin');
            const operatingMarginSection = data.find(section => section.section === 'Operating Margin');
            const netMarginSection = data.find(section => section.section === 'Net Margin');
            const ebitdaSection = data.find(section => section.section === 'EBITDA');
            
            // Get company's base currency symbol
            const currency = await getCompanyCurrency();
            
            // Create the income statement display
            let html = `
                <!-- Financial Performance Summary -->
                <div class="income-summary-cards">
                    <div class="summary-card revenue">
                        <div class="summary-card-label">Total Revenue</div>
                        <div class="summary-card-value">${currency}${formatNumber(parseFloat(revenueSection?.section_total || 0))}</div>
                        <div class="summary-card-percent">${grossMarginSection?.section_total || '0'}% Gross Margin</div>
                    </div>
                    
                    <div class="summary-card profit">
                        <div class="summary-card-label">Gross Profit</div>
                        <div class="summary-card-value">${currency}${formatNumber(parseFloat(grossProfitSection?.section_total || 0))}</div>
                        <div class="summary-card-percent">${operatingMarginSection?.section_total || '0'}% Operating Margin</div>
                    </div>
                    
                    <div class="summary-card operating">
                        <div class="summary-card-label">Operating Income</div>
                        <div class="summary-card-value">${currency}${formatNumber(parseFloat(operatingIncomeSection?.section_total || 0))}</div>
                        <div class="summary-card-percent">EBITDA: ${currency}${formatNumber(parseFloat(ebitdaSection?.section_total || 0))}</div>
                    </div>
                    
                    <div class="summary-card net">
                        <div class="summary-card-label">Net Income</div>
                        <div class="summary-card-value">${currency}${formatNumber(parseFloat(netIncomeSection?.section_total || 0))}</div>
                        <div class="summary-card-percent">${netMarginSection?.section_total || '0'}% Net Margin</div>
                    </div>
                </div>
                
                <!-- Income Statement Table -->
                <div class="income-statement-table">
                    <div class="income-statement-header">
                        <h3>Income Statement</h3>
                        <div class="period-info">For the Period Ended ${formatDateRange(filters)}</div>
                    </div>
                    
                    <table class="toss-income-table">
                        <thead>
                            <tr>
                                <th style="width: 70%;">Description</th>
                                <th style="width: 30%;" class="amount">Amount<br><small style="font-weight: normal; text-transform: none; color: var(--text-tertiary);">(in ${currency})</small></th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            // Debug: log the data structure
            console.log('Monthly view data structure:', data);
            
            // Ensure data integrity and add missing zero accounts if needed
            data.forEach(section => {
                if (section.subcategories) {
                    section.subcategories.forEach(subcategory => {
                        // Ensure accounts array exists even if empty
                        if (!subcategory.accounts) {
                            subcategory.accounts = [];
                        }
                        
                        // If accounts exist but have null amounts, ensure they show zeros
                        subcategory.accounts.forEach(account => {
                            if (account.net_amount === null || account.net_amount === undefined) {
                                account.net_amount = 0;
                            }
                        });
                    });
                }
            });
            
            // Process each section
            data.forEach(section => {
                // Skip margin sections as they're shown in summary
                if (section.section.includes('Margin')) return;
                
                // Debug: log section processing
                console.log('Processing section:', section.section, 'subcategories:', section.subcategories?.length || 0);
                
                // Main section header with clean design
                const sectionType = section.section.toLowerCase().replace(/ /g, '-');
                html += `
                    <tr class="toss-income-section-header ${sectionType}">
                        <td colspan="2">${section.section.toUpperCase()}</td>
                    </tr>
                `;
                
                // Process subcategories
                if (section.subcategories && section.subcategories.length > 0) {
                    section.subcategories.forEach(subcategory => {
                        // Subcategory header (show all subcategories)
                        if (subcategory.subcategory) {
                            html += `
                                <tr class="toss-income-subsection-header">
                                    <td colspan="2">${subcategory.subcategory}</td>
                                </tr>
                            `;
                        }
                        
                        // Process accounts (ensure all accounts show amounts, including zeros)
                        if (subcategory.accounts && subcategory.accounts.length > 0) {
                            console.log(`Processing ${subcategory.accounts.length} accounts for subcategory:`, subcategory.subcategory);
                            subcategory.accounts.forEach(account => {
                                // Handle null/undefined amounts by treating them as zero
                                const amount = account.net_amount !== undefined && account.net_amount !== null ? account.net_amount : 0;
                                const amountClass = amount === 0 ? 'zero' : (amount < 0 ? 'negative' : '');
                                console.log(`Account: ${account.account_name}, Amount: ${amount}, Class: ${amountClass}`);
                                html += `
                                    <tr>
                                        <td class="toss-income-account-name">${account.account_name}</td>
                                        <td class="toss-income-amount ${amountClass}">
                                            ${formatCleanNumber(amount)}
                                        </td>
                                    </tr>
                                `;
                            });
                        } else {
                            console.log('No accounts found for subcategory:', subcategory.subcategory);
                            // If no accounts exist but we have subcategory, create a default entry to show structure
                            if (subcategory.subcategory) {
                                console.log('Adding placeholder for empty subcategory');
                                html += `
                                    <tr>
                                        <td class="account-name" style="font-style: italic; color: var(--text-tertiary);">No accounts in ${subcategory.subcategory}</td>
                                        <td class="amount zero">-</td>
                                    </tr>
                                `;
                            }
                        }
                        
                        // Subcategory total (show all subcategory totals, including zeros)
                        if (subcategory.subcategory_total !== undefined && subcategory.subcategory_total !== null) {
                            html += `
                                <tr class="toss-income-total-row">
                                    <td>Total ${subcategory.subcategory}</td>
                                    <td class="toss-income-amount">
                                        ${formatCleanNumber(subcategory.subcategory_total)}
                                    </td>
                                </tr>
                            `;
                        }
                    });
                }
                
                // Section total (show all sections, including zero totals)
                if (section.section_total !== undefined && section.section_total !== null && !section.section.includes('Margin')) {
                    const totalClass = section.section === 'Net Income' ? 'toss-income-grand-total' : 'toss-income-section-total';
                    html += `
                        <tr class="${totalClass}">
                            <td><strong>${section.section.toUpperCase()}</strong></td>
                            <td class="toss-income-amount">
                                <strong>${formatCleanNumber(section.section_total)}</strong>
                            </td>
                        </tr>
                    `;
                }
                
                // Add spacer between major sections
                html += `<tr class="toss-income-spacer"><td colspan="2"></td></tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
                
                <!-- Key Financial Ratios -->
                <div class="financial-ratios">
                    <h3>Key Financial Ratios</h3>
                    <div class="ratios-grid">
                        <div class="ratio-card">
                            <div class="ratio-label">Gross Margin</div>
                            <div class="ratio-value">${grossMarginSection?.section_total || '0.00'}%</div>
                        </div>
                        <div class="ratio-card">
                            <div class="ratio-label">Operating Margin</div>
                            <div class="ratio-value">${operatingMarginSection?.section_total || '0.00'}%</div>
                        </div>
                        <div class="ratio-card">
                            <div class="ratio-label">Net Margin</div>
                            <div class="ratio-value">${netMarginSection?.section_total || '0.00'}%</div>
                        </div>
                        <div class="ratio-card">
                            <div class="ratio-label">EBITDA Margin</div>
                            <div class="ratio-value">${ebitdaSection ? ((parseFloat(ebitdaSection.section_total) / parseFloat(revenueSection?.section_total || 1)) * 100).toFixed(2) : '0.00'}%</div>
                        </div>
                    </div>
                </div>
            `;
            
            contentCard.innerHTML = html;
        }
        
        // Helper functions
        function getSectionClass(sectionName) {
            if (sectionName === 'Revenue') return 'revenue';
            if (sectionName === 'Cost of Goods Sold') return 'cogs';
            if (sectionName === 'Expenses') return 'expenses';
            if (sectionName === 'Net Income') return 'net-income';
            return 'revenue';
        }
        
        
        function formatDateRange(filters) {
            if (filters && filters.fromDate && filters.toDate) {
                return `${formatDisplayDate(filters.fromDate)} - ${formatDisplayDate(filters.toDate)}`;
            }
            return 'Current Period';
        }
        
        function formatDisplayDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function formatNumber(num) {
            return Math.abs(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Show loading state
        function showLoadingState() {
            const contentCard = document.querySelector('#income-statement-content');
            if (!contentCard) return;
            
            contentCard.innerHTML = `
                <div class="loading-container">
                    <div style="display: inline-block; animation: spin 1s linear infinite;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4m0 12v4m10-10h-4M6 12H2m15.364-6.364l-2.828 2.828M8.464 15.536l-2.828 2.828m12.728 0l-2.828-2.828M8.464 8.464L5.636 5.636"/>
                        </svg>
                    </div>
                    <p class="loading-text">Loading income statement...</p>
                </div>
                <style>
                    @keyframes spin {
                        from { transform: rotate(0deg); }
                        to { transform: rotate(360deg); }
                    }
                </style>
            `;
        }
        
        // Show error state
        function showErrorState(message) {
            const contentCard = document.querySelector('#income-statement-content');
            if (!contentCard) return;
            
            contentCard.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon" style="background: var(--toss-error-surface); color: var(--toss-error);">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    </div>
                    <h3 class="empty-title">Error Loading Income Statement</h3>
                    <p class="empty-text">${message || 'An error occurred while loading the income statement.'}</p>
                </div>
            `;
        }
        
        // Show empty state
        function showEmptyState(message) {
            const contentCard = document.querySelector('#income-statement-content');
            if (!contentCard) return;
            
            contentCard.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H7v-2h5v2zm5-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                    </div>
                    <h3 class="empty-title">No Data Available</h3>
                    <p class="empty-text">${message || 'No income statement data found for the selected filters.'}</p>
                </div>
            `;
        }
        
        // Show coming soon message
        function showComingSoonMessage() {
            const contentCard = document.querySelector('#income-statement-content');
            if (!contentCard) return;
            
            contentCard.innerHTML = `
                <div class="coming-soon">
                    <div class="coming-soon-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H7v-2h5v2zm5-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                    </div>
                    <h2 class="coming-soon-title">12-Month View Coming Soon</h2>
                    <p class="coming-soon-text">The 12-month income statement view is currently under development. Please use Monthly view for now.</p>
                </div>
            `;
        }
    </script>
</body>
</html>