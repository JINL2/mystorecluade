<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance - Balance Sheet</title>
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="../../../core/themes/toss-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-component-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-base.css">
    <link rel="stylesheet" href="../../../core/themes/toss-typography.css">
    
    <!-- Component CSS -->
    <link rel="stylesheet" href="../../../components/base/toss-button.css">
    <link rel="stylesheet" href="../../../components/form/toss-input.css">
    <link rel="stylesheet" href="../../../components/form/toss-select.css">
    <link rel="stylesheet" href="../../../components/form/toss-filter.css">
    <link rel="stylesheet" href="../../../components/feedback/toss-alert.css">
    <link rel="stylesheet" href="../../../components/navigation/navbar.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Environment Configuration (for local development) -->
    <script src="../../../core/config/env-loader.js"></script>
    <script src="../../../core/config/env-config.js"></script>    
    <!-- Page Specific Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background: var(--toss-gray-50);
            min-height: 100vh;
        }
        
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .page-content {
            flex: 1;
            padding: var(--space-6);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .page-header {
            margin-bottom: var(--space-8);
        }
        
        .page-title {
            font-size: var(--font-h1);
            font-weight: var(--font-bold);
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .page-subtitle {
            font-size: var(--font-large);
            color: var(--text-secondary);
            margin: 0;
        }
        
        .content-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
        }
        
        /* Modern Balance Sheet Styles */
        .balance-sheet-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
        }
        
        /* Summary Cards */
        .balance-summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }
        
        /* Two-Column Layout */
        .balance-sheet-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
            align-items: start;
        }
        
        @media (max-width: 1024px) {
            .balance-sheet-columns {
                grid-template-columns: 1fr;
            }
        }
        
        .summary-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            box-shadow: var(--shadow-sm);
            border-left: 4px solid;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .summary-card.assets {
            border-left-color: var(--toss-primary);
        }
        
        .summary-card.liabilities {
            border-left-color: var(--toss-warning);
        }
        
        .summary-card.equity {
            border-left-color: var(--toss-success);
        }
        
        .summary-card-label {
            font-size: var(--font-small);
            font-weight: var(--font-semibold);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: var(--space-2);
        }
        
        .summary-card-value {
            font-size: var(--font-h2);
            font-weight: var(--font-bold);
            color: var(--toss-gray-900);
            font-family: var(--font-family-mono);
        }
        
        .summary-card-percent {
            font-size: var(--font-small);
            color: var(--text-secondary);
            margin-top: var(--space-1);
        }
        
        /* Balance Sheet Table */
        .balance-sheet-table {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }
        
        .balance-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .balance-table thead {
            background: var(--toss-gray-50);
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .balance-table th {
            padding: var(--space-5) var(--space-6);
            text-align: left;
            font-size: var(--font-small);
            font-weight: var(--font-bold);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            border-bottom: 2px solid var(--toss-gray-200);
        }
        
        .balance-table th:last-child {
            text-align: right;
        }
        
        /* Section Headers */
        .section-header td {
            background: var(--toss-primary);
            color: var(--toss-white);
            font-weight: var(--font-bold);
            font-size: var(--font-base);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: var(--space-4) var(--space-6);
        }
        
        /* Two-column table headers */
        .assets-header {
            background: var(--toss-primary) !important;
            color: var(--toss-white) !important;
            text-align: center;
            font-weight: var(--font-bold);
            font-size: var(--font-h4);
            text-transform: uppercase;
            padding: var(--space-4) var(--space-6);
            letter-spacing: 0.05em;
        }
        
        .liabilities-header {
            background: var(--toss-secondary) !important;
            color: var(--toss-white) !important;
            text-align: center;
            font-weight: var(--font-bold);
            font-size: var(--font-h4);
            text-transform: uppercase;
            padding: var(--space-4) var(--space-6);
            letter-spacing: 0.05em;
        }
        
        .subsection-header td {
            background: var(--toss-white);
            font-weight: var(--font-bold);
            color: var(--toss-gray-800);
            padding: var(--space-4) var(--space-6);
            padding-left: var(--space-6);
            font-size: var(--font-base);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            border-bottom: 1px solid var(--toss-gray-200);
        }
        
        /* Regular Rows */
        .balance-table tbody tr {
            transition: background-color 0.15s;
            border-bottom: 1px solid var(--toss-gray-50);
        }
        
        .balance-table tbody tr:hover:not(.section-header):not(.subsection-header):not(.total-row):not(.grand-total-row) {
            background: var(--toss-gray-50);
        }
        
        .balance-table td {
            padding: var(--space-4) var(--space-6);
            font-size: var(--font-base);
            color: var(--text-primary);
        }
        
        /* Account Name Indentation */
        .account-name {
            padding-left: var(--space-10) !important;
            position: relative;
            font-size: var(--font-base);
            font-weight: var(--font-regular);
            color: var(--text-primary);
        }
        
        .account-name::before {
            content: "•";
            position: absolute;
            left: var(--space-8);
            color: var(--toss-gray-400);
        }
        
        /* Amount Formatting */
        .amount {
            text-align: right;
            font-family: var(--font-family-mono);
            font-variant-numeric: tabular-nums;
            font-weight: var(--font-medium);
            font-size: var(--font-base);
            color: var(--toss-gray-900);
        }
        
        .amount.negative {
            color: var(--toss-error);
        }
        
        .amount.zero {
            color: var(--toss-gray-400);
            font-size: var(--font-small);
        }
        
        /* Total Rows */
        .total-row td {
            font-weight: var(--font-bold);
            background: var(--toss-gray-50);
            border-top: 1px solid var(--toss-gray-200);
            border-bottom: 1px solid var(--toss-gray-200);
            color: var(--toss-gray-900);
            font-size: var(--font-base);
        }
        
        .total-row td.total-label {
            font-weight: var(--font-bold);
        }
        
        .total-row td.total-amount {
            font-weight: var(--font-bold);
        }
        
        .grand-total-row td {
            font-weight: var(--font-bold);
            background: var(--toss-primary-surface);
            color: var(--toss-primary);
            font-size: var(--font-body-large);
            padding: var(--space-5) var(--space-6);
            border-top: 2px solid var(--toss-primary);
        }
        
        /* Financial Metrics Section */
        .financial-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-6);
            margin-bottom: var(--space-6);
        }
        
        .metric-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            box-shadow: var(--shadow-sm);
            position: relative;
        }
        
        .metric-card-header {
            font-size: var(--font-small);
            font-weight: var(--font-semibold);
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: var(--space-2);
        }
        
        .metric-value {
            font-size: var(--font-h1);
            font-weight: var(--font-bold);
            color: var(--toss-gray-900);
            font-family: var(--font-family-mono);
            margin-bottom: var(--space-2);
        }
        
        .metric-description {
            font-size: var(--font-small);
            color: var(--text-secondary);
            margin-bottom: var(--space-3);
        }
        
        .metric-indicator {
            height: 4px;
            background: var(--toss-gray-200);
            border-radius: 2px;
            overflow: hidden;
            margin-top: var(--space-2);
        }
        
        .metric-indicator-fill {
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .metric-indicator-fill.good {
            background: var(--toss-success);
        }
        
        .metric-indicator-fill.warning {
            background: var(--toss-warning);
        }
        
        .metric-indicator-fill.danger {
            background: var(--toss-error);
        }
        
        .metric-card.primary .metric-value {
            color: var(--toss-primary);
        }
        
        .metric-change {
            font-size: var(--font-small);
            font-weight: var(--font-semibold);
            margin-top: var(--space-2);
        }
        
        .metric-change.positive {
            color: var(--toss-success);
        }
        
        .metric-change.negative {
            color: var(--toss-error);
        }
        
        /* Balance Verification Card */
        .balance-verification-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            margin-top: var(--space-6);
            border: 2px solid;
        }
        
        .balance-verification-card.balanced {
            background: var(--toss-success-surface);
            border-color: var(--toss-success);
        }
        
        .balance-verification-card.unbalanced {
            background: var(--toss-error-surface);
            border-color: var(--toss-error);
        }
        
        .balance-verification-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }
        
        .balance-verification-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .balance-verification-icon.balanced {
            background: var(--toss-success);
            color: var(--toss-white);
        }
        
        .balance-verification-icon.unbalanced {
            background: var(--toss-error);
            color: var(--toss-white);
        }
        
        .balance-verification-title {
            font-size: var(--font-h3);
            font-weight: var(--font-bold);
            color: var(--toss-gray-900);
        }
        
        .balance-verification-subtitle {
            font-size: var(--font-base);
            color: var(--text-secondary);
            margin-bottom: var(--space-4);
        }
        
        .balance-verification-details {
            display: flex;
            justify-content: space-between;
            padding-top: var(--space-4);
            border-top: 1px solid var(--toss-gray-200);
        }
        
        .balance-verification-item {
            flex: 1;
        }
        
        .balance-verification-label {
            font-size: var(--font-small);
            color: var(--text-secondary);
            margin-bottom: var(--space-1);
        }
        
        .balance-verification-value {
            font-size: var(--font-h4);
            font-weight: var(--font-bold);
            color: var(--toss-gray-900);
            font-family: var(--font-family-mono);
        }
        
        /* Currency Symbol */
        .currency-symbol {
            opacity: 0.7;
            margin-right: 2px;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-16) var(--space-6);
        }
        
        .empty-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--space-4);
            background: var(--toss-gray-100);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--toss-gray-400);
        }
        
        .empty-icon.error {
            background: var(--toss-error-surface);
            color: var(--toss-error);
        }
        
        .empty-title {
            font-size: var(--font-h3);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .empty-text {
            font-size: var(--font-base);
            color: var(--text-secondary);
            margin: 0;
        }
        
        .table-header-width-60 {
            width: 60%;
        }

        .table-header-width-40 {
            width: 40%;
        }

        .text-align-right {
            text-align: right;
        }
        
        /* Spacer Row */
        .spacer-row td {
            height: var(--space-5);
            border: none;
            background: transparent;
        }
        
        /* Loading State */
        .loading-container {
            text-align: center;
            padding: var(--space-10);
        }
        
        .loading-text {
            margin-top: var(--space-4);
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Navigation Bar -->
        <div id="navbar-container"></div>
        
        <!-- Page Content -->
        <main class="page-content">
            <div class="page-header">
                <h1 class="page-title">Balance Sheet</h1>
                <p class="page-subtitle">View your company's financial position</p>
            </div>
            
            <!-- Filter Component Container -->
            <div id="balance-sheet-filter"></div>
            
            <!-- Balance Sheet Content -->
            <div class="content-card">
                <!-- Balance sheet data will be loaded here -->
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H7v-2h5v2zm5-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                    </div>
                    <h3 class="empty-title">Select Filters to Load Balance Sheet</h3>
                    <p class="empty-text">Choose your filters and click Search to view the balance sheet data.</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Component JavaScript -->
    <script src="../../../components/base/toss-button.js"></script>
    <script src="../../../components/form/toss-input.js"></script>
    <script src="../../../components/form/toss-select.js"></script>
    <script src="../../../components/form/toss-filter.js"></script>
    <script src="../../../components/navigation/navbar.js"></script>
    <script src="../../../components/feedback/toss-alert.js"></script>
    
    <!-- Core Scripts -->
    <script src="../../../core/constants/app-icons.js"></script>
    <script src="../../../core/config/supabase.js"></script>
    
    <!-- App State Management -->
    <script src="../../../core/utils/app-state.js"></script>
    
    <!-- Route Mapping -->
    <script src="../../../core/config/route-mapping.js"></script>
    
    <!-- Page Initialization Utility -->
    <script src="../../../core/utils/page-init.js"></script>
    
    <script>
        // Set flag immediately to prevent navbar auto-init
        window.skipNavbarAutoInit = true;
        
        // Initialize page using standardized pattern
        window.initializePage('finance', (companyId, company) => {
            console.log('Company changed in balance sheet via page initializer:', companyId);
            handleCompanyChange(companyId, company);
        });
        
        // Additional page initialization after navbar is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for page initialization to complete, then initialize page-specific content
            setTimeout(() => {
                // Initialize the filter component first
                initializeFilterComponent();
                
                // Don't load balance sheet data automatically - wait for user to click Search
                // Just show the empty state
                showEmptyState();
            }, 100);
            
            // Listen for company changes from navbar
            window.addEventListener('companyChanged', (event) => {
                console.log('🎯 DEBUG: Balance Sheet received companyChanged event:', event.detail);
                console.log('🎯 DEBUG: Event companyId:', event.detail.companyId);
                console.log('🎯 DEBUG: Event companyName:', event.detail.companyName);
                handleCompanyChange(event.detail.companyId, event.detail.company);
            });
        });
        
        // Handle company change from any source (navbar or page initializer)
        function handleCompanyChange(companyId, company) {
            console.log('🔄 DEBUG: Balance Sheet handleCompanyChange called with:', companyId, company);
            console.log('🔍 DEBUG: Current localStorage companyChoosen:', localStorage.getItem('companyChoosen'));
            console.log('🔍 DEBUG: Current localStorage storeChoosen:', localStorage.getItem('storeChoosen'));
            
            // Clear currency cache when company changes
            cachedCurrencyInfo = null;
            lastCompanyId = null;
            
            // Reset to empty state
            showEmptyState();
            
            // Refresh the filter component to load new stores
            if (balanceSheetFilter) {
                console.log('🔄 DEBUG: Refreshing store filter for new company:', companyId);
                // Load stores for the new company
                balanceSheetFilter.loadStores();
                // Reset filter to default state (clear selections and reset dates)
                balanceSheetFilter.handleClear();
                console.log('✅ DEBUG: Store filter refreshed successfully');
            } else {
                console.warn('⚠️ DEBUG: Balance sheet filter not initialized yet');
            }
            
            // Show message to user that they need to search again
            showEmptyStateMessage('Company changed. Please select your filters and search to view the balance sheet.');
        }
        
        // Enhanced empty state with custom message
        function showEmptyStateMessage(message) {
            const contentCard = document.querySelector('.content-card');
            if (!contentCard) return;
            
            contentCard.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H7v-2h5v2zm5-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                    </div>
                    <h3 class="empty-title">Balance Sheet</h3>
                    <p class="empty-text">${message || 'Select your filters and click Search to view the balance sheet data.'}</p>
                </div>
            `;
        }
        
        // Load balance sheet data for company
        function loadBalanceSheetData(companyId, filters = null) {
            console.log('Loading balance sheet for company:', companyId, 'with filters:', filters);
            
            // If no filters provided, use current filter values
            if (!filters && balanceSheetFilter) {
                filters = balanceSheetFilter.getFilters();
            }
            
            // Call the RPC to get balance sheet data
            callBalanceSheetRPC(companyId, filters);
        }
        
        // Initialize the filter component
        let balanceSheetFilter = null;
        
        // Cache currency information to avoid repeated database calls
        let cachedCurrencyInfo = null;
        let lastCompanyId = null;
        
        function initializeFilterComponent() {
            // Create the filter component
            balanceSheetFilter = new TossFilter({
                container: '#balance-sheet-filter',
                title: 'Filters',
                showStoreFilter: true,
                showDateFilters: true,
                storeLabel: 'Store',
                fromDateLabel: 'From Date',
                toDateLabel: 'To Date',
                defaultExpanded: true,
                onSearch: (filters) => {
                    console.log('Searching with filters:', filters);
                    applyFiltersAndLoadData(filters);
                },
                onClear: () => {
                    console.log('Filters cleared');
                    // When filters are cleared, show empty state
                    // Don't auto-load data - user needs to click Search
                    showEmptyState();
                },
                onFilterChange: (filters) => {
                    console.log('Filter changed:', filters);
                }
            });
        }
        
        // Apply filters and reload balance sheet data
        function applyFiltersAndLoadData(filters) {
            const companyId = appState.getSelectedCompanyId();
            if (!companyId) {
                console.log('No company selected');
                return;
            }
            
            console.log('Loading balance sheet with filters:', {
                companyId: companyId,
                storeId: filters.store || 'all',
                fromDate: filters.fromDate,
                toDate: filters.toDate
            });
            
            loadBalanceSheetData(companyId, filters);
        }
        
        // Call the balance sheet RPC
        async function callBalanceSheetRPC(companyId, filters) {
            try {
                // Show loading state
                showLoadingState();
                
                // Prepare RPC parameters
                const params = {
                    p_company_id: companyId,
                    p_store_id: filters?.store || null,  // null for "All Stores"
                    p_start_date: filters?.fromDate || null,
                    p_end_date: filters?.toDate || null
                };
                
                console.log('Calling get_balance_sheet RPC with params:', params);
                
                // Call the RPC
                const { data, error } = await supabase.rpc('get_balance_sheet', params);
                
                if (error) {
                    console.error('Error calling get_balance_sheet:', error);
                    showErrorState(error.message);
                    return;
                }
                
                console.log('Balance sheet data received:', data);
                
                // Display the balance sheet data
                if (data && data.success) {
                    await displayBalanceSheet(data);
                } else {
                    showEmptyState('No balance sheet data available');
                }
                
            } catch (error) {
                console.error('Error in balance sheet RPC:', error);
                showErrorState('Failed to load balance sheet');
            }
        }
        
        // Display the balance sheet data in the table
        async function displayBalanceSheet(response) {
            const contentCard = document.querySelector('.content-card');
            if (!contentCard) return;
            
            const { company_info, data, ui_data } = response;
            
            // Get the actual currency symbol from database
            const currencyInfo = await getCompanyCurrency();
            const currency = currencyInfo?.symbol || company_info?.currency_symbol || '₩';
            
            // Create summary cards and two-column layout
            let html = `
                <!-- Summary Cards -->
                <div class="balance-summary-cards">
                    <div class="summary-card assets">
                        <div class="summary-card-label">Total Assets</div>
                        <div class="summary-card-value">${currency}${formatNumber(data.totals.total_assets)}</div>
                        ${ui_data?.assets_composition ? `
                            <div class="summary-card-percent">
                                Current: ${ui_data.assets_composition.current_assets_percentage.toFixed(1)}%
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="summary-card liabilities">
                        <div class="summary-card-label">Total Liabilities</div>
                        <div class="summary-card-value">${currency}${formatNumber(data.totals.total_liabilities)}</div>
                        ${ui_data?.liabilities_vs_equity ? `
                            <div class="summary-card-percent">
                                ${ui_data.liabilities_vs_equity.liabilities_percentage.toFixed(1)}% of Total
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="summary-card equity">
                        <div class="summary-card-label">Total Equity</div>
                        <div class="summary-card-value">${currency}${formatNumber(data.totals.total_equity)}</div>
                        ${ui_data?.liabilities_vs_equity ? `
                            <div class="summary-card-percent">
                                ${ui_data.liabilities_vs_equity.equity_percentage.toFixed(1)}% of Total
                            </div>
                        ` : ''}
                    </div>
                </div>
                
                <!-- Two-Column Balance Sheet Layout -->
                <div class="balance-sheet-columns">
                    <!-- Assets Column (Left) -->
                    <div class="balance-sheet-table">
                        <table class="balance-table">
                            <thead>
                                <tr>
                                    <th colspan="2" class="assets-header">ASSETS</th>
                                </tr>
                                <tr>
                                    <th class="table-header-width-60">Account</th>
                                    <th class="table-header-width-40 amount">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // Build ASSETS content
            
            // Current Assets
            if (data.current_assets && data.current_assets.length > 0) {
                html += `<tr class="subsection-header"><td colspan="2">Current Assets</td></tr>`;
                data.current_assets.forEach(account => {
                    const amountClass = account.balance === 0 ? 'zero' : (account.balance < 0 ? 'negative' : '');
                    html += `
                        <tr>
                            <td class="account-name">${account.account_name}</td>
                            <td class="amount ${amountClass}">
                                <span class="currency-symbol">${currency}</span>${account.formatted_balance}
                            </td>
                        </tr>
                    `;
                });
                html += `
                    <tr class="total-row">
                        <td>Total Current Assets</td>
                        <td class="amount">
                            <span class="currency-symbol">${currency}</span>${formatNumber(data.totals.total_current_assets)}
                        </td>
                    </tr>
                `;
            }
            
            // Non-Current Assets
            if (data.non_current_assets && data.non_current_assets.length > 0) {
                html += `<tr class="subsection-header"><td colspan="2">Non-Current Assets</td></tr>`;
                data.non_current_assets.forEach(account => {
                    const amountClass = account.balance === 0 ? 'zero' : (account.balance < 0 ? 'negative' : '');
                    html += `
                        <tr>
                            <td class="account-name">${account.account_name}</td>
                            <td class="amount ${amountClass}">
                                <span class="currency-symbol">${currency}</span>${account.formatted_balance}
                            </td>
                        </tr>
                    `;
                });
                html += `
                    <tr class="total-row">
                        <td>Total Non-Current Assets</td>
                        <td class="amount">
                            <span class="currency-symbol">${currency}</span>${formatNumber(data.totals.total_non_current_assets)}
                        </td>
                    </tr>
                `;
            }
            
            // Total Assets
            html += `
                <tr class="grand-total-row">
                    <td>TOTAL ASSETS</td>
                    <td class="amount">
                        <span class="currency-symbol">${currency}</span>${formatNumber(data.totals.total_assets)}
                    </td>
                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Liabilities & Equity Column (Right) -->
                    <div class="balance-sheet-table">
                        <table class="balance-table">
                            <thead>
                                <tr>
                                    <th colspan="2" class="liabilities-header">LIABILITIES & EQUITY</th>
                                </tr>
                                <tr>
                                    <th class="table-header-width-60">Account</th>
                                    <th class="table-header-width-40 amount">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            // LIABILITIES Section
            
            // Current Liabilities
            if (data.current_liabilities && data.current_liabilities.length > 0) {
                html += `<tr class="subsection-header"><td colspan="2">Current Liabilities</td></tr>`;
                data.current_liabilities.forEach(account => {
                    const amountClass = account.balance === 0 ? 'zero' : (account.balance < 0 ? 'negative' : '');
                    html += `
                        <tr>
                            <td class="account-name">${account.account_name}</td>
                            <td class="amount ${amountClass}">
                                <span class="currency-symbol">${currency}</span>${account.formatted_balance}
                            </td>
                        </tr>
                    `;
                });
                html += `
                    <tr class="total-row">
                        <td>Total Current Liabilities</td>
                        <td class="amount">
                            <span class="currency-symbol">${currency}</span>${formatNumber(data.totals.total_current_liabilities)}
                        </td>
                    </tr>
                `;
            }
            
            // Non-Current Liabilities
            if (data.non_current_liabilities && data.non_current_liabilities.length > 0) {
                html += `<tr class="subsection-header"><td colspan="2">Non-Current Liabilities</td></tr>`;
                data.non_current_liabilities.forEach(account => {
                    const amountClass = account.balance === 0 ? 'zero' : (account.balance < 0 ? 'negative' : '');
                    html += `
                        <tr>
                            <td class="account-name">${account.account_name}</td>
                            <td class="amount ${amountClass}">
                                <span class="currency-symbol">${currency}</span>${account.formatted_balance}
                            </td>
                        </tr>
                    `;
                });
                html += `
                    <tr class="total-row">
                        <td>Total Non-Current Liabilities</td>
                        <td class="amount">
                            <span class="currency-symbol">${currency}</span>${formatNumber(data.totals.total_non_current_liabilities)}
                        </td>
                    </tr>
                `;
            }
            
            // Total Liabilities
            html += `
                <tr class="total-row">
                    <td class="total-label">TOTAL LIABILITIES</td>
                    <td class="amount total-amount">
                        <span class="currency-symbol">${currency}</span>${formatNumber(data.totals.total_liabilities)}
                    </td>
                </tr>
            `;
            
            // EQUITY Section
            html += `<tr class="spacer-row"><td colspan="2"></td></tr>`; // Spacer
            
            if (data.equity && data.equity.length > 0) {
                html += `<tr class="subsection-header"><td colspan="2">Equity</td></tr>`;
                data.equity.forEach(account => {
                    const amountClass = account.balance === 0 ? 'zero' : (account.balance < 0 ? 'negative' : '');
                    html += `
                        <tr>
                            <td class="account-name">${account.account_name}</td>
                            <td class="amount ${amountClass}">
                                <span class="currency-symbol">${currency}</span>${account.formatted_balance}
                            </td>
                        </tr>
                    `;
                });
            }
            
            // Comprehensive Income (if any)
            if (data.comprehensive_income && data.comprehensive_income.length > 0) {
                html += `<tr class="subsection-header"><td colspan="2">Other Comprehensive Income</td></tr>`;
                data.comprehensive_income.forEach(account => {
                    const amountClass = account.balance === 0 ? 'zero' : (account.balance < 0 ? 'negative' : '');
                    html += `
                        <tr>
                            <td class="account-name">${account.account_name}</td>
                            <td class="amount ${amountClass}">
                                <span class="currency-symbol">${currency}</span>${account.formatted_balance}
                            </td>
                        </tr>
                    `;
                });
            }
            
            // Total Equity
            html += `
                <tr class="total-row">
                    <td class="total-label">TOTAL EQUITY</td>
                    <td class="amount total-amount">
                        <span class="currency-symbol">${currency}</span>${formatNumber(data.totals.total_equity)}
                    </td>
                </tr>
            `;
            
            // Grand Total - Liabilities + Equity
            html += `
                <tr class="grand-total-row">
                    <td>TOTAL LIABILITIES & EQUITY</td>
                    <td class="amount">
                        <span class="currency-symbol">${currency}</span>${formatNumber(data.totals.total_liabilities_and_equity)}
                    </td>
                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Financial Metrics Section
            html += `
                <div class="financial-metrics">
                    <div class="metric-card">
                        <div class="metric-card-header">Debt Ratio</div>
                        <div class="metric-value">${ui_data?.debt_ratio ? (ui_data.debt_ratio * 100).toFixed(2) : '0.00'}%</div>
                        <div class="metric-description">Liabilities ÷ Assets</div>
                        <div class="metric-indicator">
                            <div class="metric-indicator-fill ${getDebtRatioClass(ui_data?.debt_ratio)}" 
                                 style="width: ${Math.min((ui_data?.debt_ratio || 0) * 100, 100)}%"></div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-card-header">Equity Ratio</div>
                        <div class="metric-value">${ui_data?.equity_ratio ? (ui_data.equity_ratio * 100).toFixed(2) : '0.00'}%</div>
                        <div class="metric-description">Equity ÷ Assets</div>
                        <div class="metric-indicator">
                            <div class="metric-indicator-fill good" 
                                 style="width: ${(ui_data?.equity_ratio || 0) * 100}%"></div>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="metric-card-header">Current Ratio</div>
                        <div class="metric-value">${ui_data?.current_ratio ? formatCurrentRatio(ui_data.current_ratio) : '0.00'}%</div>
                        <div class="metric-description">Current Assets ÷ Current Liabilities</div>
                        <div class="metric-indicator">
                            <div class="metric-indicator-fill ${getCurrentRatioClass(ui_data?.current_ratio)}" 
                                 style="width: ${Math.min(((ui_data?.current_ratio || 0) / 2) * 100, 100)}%"></div>
                        </div>
                    </div>
                    
                    <div class="metric-card primary">
                        <div class="metric-card-header">Total Assets</div>
                        <div class="metric-value">${currency}${formatNumber(data.totals.total_assets)}</div>
                        <div class="metric-description">Total Asset Value</div>
                        ${ui_data?.asset_growth ? `
                            <div class="metric-change ${ui_data.asset_growth >= 0 ? 'positive' : 'negative'}">
                                ${ui_data.asset_growth >= 0 ? '+' : ''}${ui_data.asset_growth.toFixed(1)}%
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            // Balance Verification Card
            if (ui_data?.balance_verification) {
                const isBalanced = ui_data.balance_verification.is_balanced;
                const statusClass = isBalanced ? 'balanced' : 'unbalanced';
                
                html += `
                    <div class="balance-verification-card ${statusClass}">
                        <div class="balance-verification-header">
                            <div class="balance-verification-icon ${statusClass}">
                                ${isBalanced ? 
                                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>' :
                                    '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M18 6L6 18M6 6l12 12"/></svg>'
                                }
                            </div>
                            <div class="balance-verification-title">
                                Balance Verification - ${isBalanced ? 'Balanced' : 'Unbalanced'}
                            </div>
                        </div>
                        <div class="balance-verification-subtitle">
                            ${isBalanced ? 
                                'Assets equal Liabilities + Equity. The balance sheet is balanced.' :
                                `Balance sheet is not balanced. Difference: ${currency}${ui_data.balance_verification.difference_formatted}`
                            }
                        </div>
                        <div class="balance-verification-details">
                            <div class="balance-verification-item">
                                <div class="balance-verification-label">Total Assets:</div>
                                <div class="balance-verification-value">${currency}${formatNumber(data.totals.total_assets)}</div>
                            </div>
                            <div class="balance-verification-item text-align-right">
                                <div class="balance-verification-label">Total Liabilities + Equity:</div>
                                <div class="balance-verification-value">${currency}${formatNumber(data.totals.total_liabilities_and_equity)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            contentCard.innerHTML = html;
        }
        
        // Show loading state
        function showLoadingState() {
            const contentCard = document.querySelector('.content-card');
            if (!contentCard) return;
            
            contentCard.innerHTML = `
                <div class="loading-container">
                    <div style="display: inline-block; animation: spin 1s linear infinite;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4m0 12v4m10-10h-4M6 12H2m15.364-6.364l-2.828 2.828M8.464 15.536l-2.828 2.828m12.728 0l-2.828-2.828M8.464 8.464L5.636 5.636"/>
                        </svg>
                    </div>
                    <p class="loading-text">Loading balance sheet...</p>
                </div>
                <style>
                    @keyframes spin {
                        from { transform: rotate(0deg); }
                        to { transform: rotate(360deg); }
                    }
                </style>
            `;
        }
        
        // Show error state
        function showErrorState(message) {
            const contentCard = document.querySelector('.content-card');
            if (!contentCard) return;
            
            contentCard.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon error">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    </div>
                    <h3 class="empty-title">Error Loading Balance Sheet</h3>
                    <p class="empty-text">${message || 'An error occurred while loading the balance sheet.'}</p>
                </div>
            `;
        }
        
        // Show empty state
        function showEmptyState(message) {
            const contentCard = document.querySelector('.content-card');
            if (!contentCard) return;
            
            contentCard.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 14H7v-2h5v2zm5-4H7v-2h10v2zm0-4H7V7h10v2z"/>
                        </svg>
                    </div>
                    <h3 class="empty-title">No Data Available</h3>
                    <p class="empty-text">${message || 'No balance sheet data found for the selected filters.'}</p>
                </div>
            `;
        }
        
        // Get company's base currency information from database
        async function getCompanyCurrency() {
            try {
                // Get the selected company ID from localStorage
                // DEBUG: Check storage keys for company selection
                console.log('🔍 DEBUG: All localStorage keys:', Object.keys(localStorage));
                console.log('🔍 DEBUG: companychoosen (lowercase c):', localStorage.getItem('companychoosen'));
                console.log('🔍 DEBUG: companyChoosen (capital C):', localStorage.getItem('companyChoosen'));
                
                // Use correct storage key that navbar uses (capital 'C')
                const companyId = localStorage.getItem('companyChoosen');
                if (!companyId) {
                    console.log('No company selected');
                    return null;
                }
                
                // Check cache first
                if (cachedCurrencyInfo && lastCompanyId === companyId) {
                    console.log('Using cached currency info:', cachedCurrencyInfo);
                    return cachedCurrencyInfo;
                }
                
                console.log('Fetching currency for company:', companyId);
                
                // Query companies table to get base_currency_id
                const { data: companyData, error: companyError } = await supabase
                    .from('companies')
                    .select('base_currency_id')
                    .eq('company_id', companyId)
                    .single();
                
                if (companyError) {
                    console.error('Error fetching company data:', companyError);
                    return null;
                }
                
                if (!companyData?.base_currency_id) {
                    console.log('No base currency ID found for company');
                    return null;
                }
                
                console.log('Company base_currency_id:', companyData.base_currency_id);
                
                // Query currency_types table to get currency details
                const { data: currencyData, error: currencyError } = await supabase
                    .from('currency_types')
                    .select('currency_code, currency_name, symbol')
                    .eq('currency_id', companyData.base_currency_id)
                    .single();
                
                if (currencyError) {
                    console.error('Error fetching currency data:', currencyError);
                    return null;
                }
                
                console.log('Currency data fetched:', currencyData);
                
                // Cache the result
                cachedCurrencyInfo = currencyData;
                lastCompanyId = companyId;
                
                return currencyData;
                
            } catch (error) {
                console.error('Error in getCompanyCurrency:', error);
                return null;
            }
        }
        
        // Format number with commas
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        
        // Format current ratio (it's not a percentage, it's a ratio like 2.5:1)
        function formatCurrentRatio(ratio) {
            if (!ratio) return '0.00';
            // If the ratio is very high, just show as percentage
            if (ratio > 100) {
                return (ratio * 100).toFixed(2) + '%';
            }
            // Otherwise show as ratio
            return ratio.toFixed(2) + ':1';
        }
        
        // Get appropriate class for debt ratio indicator
        function getDebtRatioClass(ratio) {
            if (!ratio) return 'good';
            if (ratio < 0.4) return 'good';    // Less than 40% is good
            if (ratio < 0.6) return 'warning'; // 40-60% is warning
            return 'danger';                   // Over 60% is concerning
        }
        
        // Get appropriate class for current ratio indicator
        function getCurrentRatioClass(ratio) {
            if (!ratio) return 'danger';
            if (ratio < 1) return 'danger';    // Less than 1 is bad
            if (ratio < 1.5) return 'warning'; // 1-1.5 is okay
            return 'good';                     // Over 1.5 is good
        }
    </script>
</body>
</html>