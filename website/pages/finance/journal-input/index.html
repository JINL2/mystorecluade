<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance - Journal Input</title>
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="../../../core/themes/toss-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-component-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-base.css">
    <link rel="stylesheet" href="../../../core/themes/toss-typography.css">
    
    <!-- Component CSS -->
    <link rel="stylesheet" href="../../../components/base/toss-button.css">
    <link rel="stylesheet" href="../../../components/form/toss-input.css">
    <link rel="stylesheet" href="../../../components/form/toss-select.css">
    <link rel="stylesheet" href="../../../components/feedback/toss-alert.css">
    <link rel="stylesheet" href="../../../components/layout/toss-modal.css">
    <link rel="stylesheet" href="../../../components/navigation/navbar.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Environment Configuration (for local development) -->
    <script src="../../../core/config/env-loader.js"></script>
    <script src="../../../core/config/env-config.js"></script>
    
    <!-- Journal Input Specific Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background: var(--toss-gray-50);
            min-height: 100vh;
        }
        
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .page-content {
            flex: 1;
            padding: var(--space-6);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        .page-header {
            margin-bottom: var(--space-6);
        }
        
        .page-title {
            font-size: var(--font-h1);
            font-weight: 700;
            color: var(--toss-text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .page-subtitle {
            font-size: var(--font-body-large);
            color: var(--toss-text-secondary);
            margin: 0;
        }

        /* Journal Header Card */
        .journal-header-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-card);
            margin-bottom: var(--space-1);
        }

        .journal-date-info {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
        }

        .journal-date-info .icon {
            width: 16px;
            height: 16px;
            color: var(--toss-gray-500);
        }

        .journal-date-text {
            font-size: var(--font-body-small);
            font-weight: 500;
            color: var(--toss-gray-700);
        }

        .journal-company-info {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .journal-company-info .icon {
            width: 16px;
            height: 16px;
            color: var(--toss-gray-500);
        }

        .journal-company-text {
            font-size: var(--font-body-small);
            font-weight: 500;
            color: var(--toss-gray-700);
        }

        .journal-store-text {
            font-size: var(--font-body-small);
            color: var(--toss-gray-600);
        }

        /* Balance Summary Card */
        .balance-summary-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-card);
            margin-bottom: var(--space-1);
        }

        .balance-summary-grid {
            display: grid;
            grid-template-columns: 1fr 1px 1fr 1px 1fr;
            gap: var(--space-4);
            align-items: center;
        }

        .balance-item {
            text-align: center;
            padding: var(--space-2);
            border-radius: var(--radius-md);
            transition: all var(--transition-fast);
            cursor: pointer;
            position: relative;
        }

        .balance-item.clickable:hover {
            background: var(--toss-gray-50);
            transform: translateY(-1px);
        }

        .balance-item.clickable::after {
            content: '+';
            position: absolute;
            top: -8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: var(--toss-gray-300);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--toss-gray-600);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .balance-item.clickable:hover::after {
            opacity: 1;
        }

        .balance-label {
            font-size: var(--font-label);
            font-weight: 500;
            color: var(--toss-gray-600);
            margin-bottom: var(--space-1);
        }

        .balance-amount {
            font-size: var(--font-body-large);
            font-weight: 700;
            margin-bottom: var(--space-05);
        }

        .balance-amount.debit {
            color: var(--toss-primary);
        }

        .balance-amount.credit {
            color: var(--toss-success);
        }

        .balance-amount.difference {
            color: var(--toss-success);
        }

        .balance-amount.difference.unbalanced {
            color: var(--toss-error);
        }

        .balance-count {
            font-size: var(--font-small);
            color: var(--toss-gray-500);
        }

        .balance-divider {
            width: 1px;
            height: 60px;
            background: var(--toss-gray-200);
        }

        /* Description Card */
        .description-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-card);
            margin-bottom: var(--space-1);
        }

        .description-label {
            font-size: var(--font-body);
            font-weight: 600;
            color: var(--toss-gray-700);
            margin-bottom: var(--space-2);
        }

        /* Transaction Lines */
        .transaction-lines-container {
            min-height: 200px;
            margin-bottom: var(--space-6);
        }

        .transaction-line-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-3);
            box-shadow: var(--shadow-card);
            overflow: hidden;
            border: 1px solid transparent;
            transition: all var(--transition-fast);
        }

        .transaction-line-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-3);
        }

        .transaction-line-card.debit {
            border-color: rgba(0, 100, 255, 0.2);
        }

        .transaction-line-card.credit {
            border-color: rgba(0, 200, 150, 0.2);
        }

        .transaction-line-header {
            padding: var(--space-4);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .transaction-line-header.debit {
            background: rgba(0, 100, 255, 0.05);
        }

        .transaction-line-header.credit {
            background: rgba(0, 200, 150, 0.05);
        }

        .transaction-line-type {
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-sm);
            font-size: var(--font-small);
            font-weight: 700;
            letter-spacing: 0.5px;
            color: white;
        }

        .transaction-line-type.debit {
            background: var(--toss-primary);
        }

        .transaction-line-type.credit {
            background: var(--toss-success);
        }

        .transaction-line-account {
            flex: 1;
            margin: 0 var(--space-3);
            font-weight: 600;
            color: var(--toss-gray-900);
        }

        .transaction-line-amount {
            font-size: var(--font-body-large);
            font-weight: 700;
        }

        .transaction-line-amount.debit {
            color: var(--toss-primary);
        }

        .transaction-line-amount.credit {
            color: var(--toss-success);
        }

        .transaction-line-body {
            padding: var(--space-4);
        }

        .transaction-line-description {
            display: flex;
            align-items: flex-start;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
            font-size: var(--font-body-small);
            color: var(--toss-gray-700);
        }

        .transaction-line-description .icon {
            width: 16px;
            height: 16px;
            color: var(--toss-gray-500);
            margin-top: 2px;
        }

        .transaction-line-tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
        }

        .transaction-tag {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            background: rgba(0, 100, 255, 0.1);
            border: 1px solid rgba(0, 100, 255, 0.2);
            border-radius: var(--radius-full);
            font-size: var(--font-small);
            font-weight: 600;
            color: var(--toss-primary);
        }

        .transaction-tag.cash {
            background: rgba(0, 150, 255, 0.1);
            border-color: rgba(0, 150, 255, 0.2);
            color: var(--toss-info);
        }

        .transaction-tag.counterparty {
            background: rgba(0, 100, 255, 0.1);
            border-color: rgba(0, 100, 255, 0.2);
            color: var(--toss-primary);
        }

        .transaction-tag .icon {
            width: 14px;
            height: 14px;
        }

        .transaction-line-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-2);
        }

        .transaction-action-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2) var(--space-3);
            border: none;
            background: transparent;
            border-radius: var(--radius-sm);
            font-size: var(--font-body-small);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .transaction-action-btn:hover {
            background: var(--toss-gray-50);
        }

        .transaction-action-btn.edit {
            color: var(--toss-gray-600);
        }

        .transaction-action-btn.delete {
            color: var(--toss-error);
        }

        .transaction-action-btn .icon {
            width: 18px;
            height: 18px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-16) var(--space-6);
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-card);
        }

        .empty-state-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--space-4);
            color: var(--toss-gray-300);
        }

        .empty-state-title {
            font-size: var(--font-h3);
            font-weight: 600;
            color: var(--toss-gray-700);
            margin: 0 0 var(--space-2) 0;
        }

        .empty-state-text {
            font-size: var(--font-body);
            color: var(--toss-gray-500);
            margin: 0;
        }

        /* Actions Footer */
        .actions-footer {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-card);
            position: sticky;
            bottom: var(--space-6);
        }

        .actions-grid {
            display: flex;
            gap: var(--space-3);
        }

        .action-btn {
            flex: 1;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            font-size: var(--font-body);
            font-weight: 600;
            transition: all var(--transition-fast);
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .action-btn.add {
            background: transparent;
            border: 1.5px solid var(--toss-primary);
            color: var(--toss-primary);
        }

        .action-btn.add:hover {
            background: var(--toss-primary-surface);
        }

        .action-btn.submit {
            background: var(--toss-primary);
            color: white;
        }

        .action-btn.submit:hover {
            background: var(--toss-primary-dark);
        }

        .action-btn:disabled {
            background: var(--toss-gray-200);
            color: var(--toss-gray-400);
            border-color: var(--toss-gray-200);
            cursor: not-allowed;
        }

        .action-btn .icon {
            width: 20px;
            height: 20px;
        }

        /* Modal Footer Buttons */
        .toss-modal-footer {
            padding: var(--space-5);
            background: var(--toss-gray-50);
            border-top: 1px solid var(--toss-gray-200);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
        }

        .toss-modal-footer .toss-button {
            min-height: 44px;
            padding: var(--space-3) var(--space-5);
            font-weight: 600;
            font-size: var(--font-body);
            border-radius: var(--radius-lg);
            transition: all var(--transition-fast);
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
        }

        .toss-modal-footer .toss-button-primary {
            background: var(--toss-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 100, 255, 0.2);
        }

        .toss-modal-footer .toss-button-primary:hover {
            background: var(--toss-primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 100, 255, 0.3);
        }

        .toss-modal-footer .toss-button-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 100, 255, 0.2);
        }

        .toss-modal-footer .toss-button-primary:disabled {
            background: var(--toss-gray-300);
            color: var(--toss-gray-500);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .toss-modal-footer .toss-button-secondary {
            background: white;
            color: var(--toss-gray-700);
            border: 1px solid var(--toss-gray-300);
        }

        .toss-modal-footer .toss-button-secondary:hover {
            background: var(--toss-gray-50);
            border-color: var(--toss-gray-400);
            transform: translateY(-1px);
        }

        .toss-modal-footer .toss-button-secondary:active {
            transform: translateY(0);
            background: var(--toss-gray-100);
        }

        .toss-button-lg {
            padding: var(--space-3) var(--space-6) !important;
            font-size: var(--font-body-large) !important;
        }

        /* Transaction Modal */
        .toss-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1100;
            backdrop-filter: blur(4px);
        }

        .toss-modal-overlay.show {
            display: flex;
        }

        .toss-modal {
            background: var(--toss-white);
            border-radius: var(--radius-xl);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            max-width: 90%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .toss-modal-header {
            padding: var(--space-5);
            border-bottom: 1px solid var(--toss-gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .toss-modal-title {
            font-size: var(--font-h3);
            font-weight: 700;
            color: var(--toss-gray-900);
            margin: 0;
        }

        .toss-modal-close {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            background: transparent;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            color: var(--toss-gray-500);
        }

        .toss-modal-close:hover {
            background: var(--toss-gray-100);
            color: var(--toss-gray-700);
        }

        .toss-modal-body {
            flex: 1;
            padding: var(--space-5);
            overflow-y: auto;
        }

        /* Modal Footer Buttons */
        .transaction-modal {
            max-width: 1100px;
            width: 95%;
            min-height: 750px;
            max-height: 95vh !important;
            margin: 2.5vh auto !important;
        }
        
        .transaction-modal .toss-modal-body {
            min-height: 550px;
            max-height: calc(95vh - 200px);
            padding: var(--space-6) var(--space-8);
            overflow-y: auto;
        }
        
        .transaction-modal .toss-modal-header {
            padding: var(--space-6) var(--space-8);
        }
        
        .transaction-modal .toss-modal-footer {
            padding: var(--space-5) var(--space-8);
        }
        
        /* Larger form elements for better usability */
        .transaction-modal .toss-input,
        .transaction-modal .toss-select {
            font-size: 16px;
            padding: 16px 18px;
            height: 56px;
        }
        
        .transaction-modal textarea.toss-input {
            min-height: 140px;
            padding: 16px 18px;
            resize: vertical;
            line-height: 1.5;
        }
        
        .transaction-modal .form-group {
            margin-bottom: var(--space-8);
        }
        
        .transaction-modal .form-label {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: var(--space-3);
            color: var(--toss-gray-800);
        }
        
        .transaction-modal .transaction-type-buttons {
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }
        
        .transaction-modal .transaction-type-btn {
            padding: 18px 28px;
            font-size: 17px;
            min-height: 58px;
        }
        
        /* Account dropdown in modal should also be bigger */
        .transaction-modal .toss-select-container {
            max-width: 100%;
        }
        
        .transaction-modal .account-search-menu {
            min-height: 300px;
        }
        
        /* Cash Location Search Menu Styles */
        .cash-location-search-menu {
            background: var(--toss-white) !important;
            border: 1px solid var(--toss-gray-300) !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
                        0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
            border-radius: var(--radius-lg) !important;
            max-height: 500px !important;
            overflow-y: auto !important;
            min-width: 500px !important;
            width: max-content !important;
            max-width: 650px !important;
        }
        
        .cash-location-search-menu .toss-select-option {
            padding: var(--space-3) var(--space-4) !important;
            border-bottom: 1px solid var(--toss-gray-100) !important;
            background: var(--toss-white) !important;
            color: var(--toss-gray-900) !important;
            min-height: 60px !important;
            display: flex !important;
            align-items: center !important;
        }
        
        .cash-location-search-menu .toss-select-option:last-child {
            border-bottom: none !important;
        }
        
        .cash-location-search-menu .toss-select-option:hover {
            background: var(--toss-gray-50) !important;
            color: var(--toss-gray-900) !important;
        }
        
        .transaction-modal .cash-location-search-menu {
            min-height: 300px;
        }
        
        /* Counterparty Search Menu Styles */
        .counterparty-search-menu {
            background: var(--toss-white) !important;
            border: 1px solid var(--toss-gray-300) !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
                        0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
            border-radius: var(--radius-lg) !important;
            max-height: 400px !important;
            overflow-y: auto !important;
            width: 100% !important;
            position: absolute !important;
            margin-top: 8px !important;
            z-index: 1200 !important;
        }
        
        .counterparty-search-menu .toss-select-option {
            padding: var(--space-3) var(--space-4) !important;
            border-bottom: 1px solid var(--toss-gray-100) !important;
            background: var(--toss-white) !important;
            color: var(--toss-gray-900) !important;
            min-height: 60px !important;
            display: flex !important;
            align-items: center !important;
            transition: background 0.15s ease !important;
        }
        
        .counterparty-search-menu .toss-select-option:last-child {
            border-bottom: none !important;
        }
        
        .counterparty-search-menu .toss-select-option:hover {
            background: var(--toss-gray-50) !important;
            color: var(--toss-gray-900) !important;
        }

        .transaction-form {
            display: flex;
            flex-direction: column;
            gap: var(--space-5);
        }

        .transaction-form-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            margin-bottom: var(--space-5);
        }
        .transaction-form-section:last-child {
            margin-bottom: 0;
        }

        .form-row {
            display: flex;
            gap: var(--space-5);
            margin-bottom: var(--space-5);
        }

        .form-row .transaction-form-section {
            flex: 1;
            margin-bottom: 0;
        }

        .transaction-form-title {
            font-size: var(--font-body);
            font-weight: 600;
            color: var(--toss-gray-700);
        }

        /* Fix account select styling */
        .transaction-form .toss-select {
            background: var(--toss-white) !important;
            color: var(--toss-gray-900) !important;
            border: 1px solid var(--toss-gray-300) !important;
        }

        .transaction-form .toss-select:hover {
            background: var(--toss-gray-50) !important;
            border-color: var(--toss-primary) !important;
        }

        .transaction-form .toss-select-placeholder {
            color: var(--toss-gray-500) !important;
        }

        /* Account search dropdown styling */
        .account-search-menu {
            background: var(--toss-white) !important;
            border: 1px solid var(--toss-gray-300) !important;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
                        0 10px 10px -5px rgba(0, 0, 0, 0.04) !important;
            border-radius: var(--radius-lg) !important;
            max-height: 500px !important;
            overflow-y: auto !important;
            min-width: 500px !important;
            width: max-content !important;
            max-width: 650px !important;
        }

        .account-search-menu .toss-select-option {
            padding: var(--space-3) var(--space-4) !important;
            border-bottom: 1px solid var(--toss-gray-100) !important;
            background: var(--toss-white) !important;
            color: var(--toss-gray-900) !important;
            min-height: 52px !important;
            display: flex !important;
            align-items: center !important;
        }

        .account-search-menu .toss-select-option:last-child {
            border-bottom: none !important;
        }

        .account-search-menu .toss-select-option:hover {
            background: var(--toss-gray-50) !important;
            color: var(--toss-gray-900) !important;
        }

        .account-search-menu .toss-select-option-label {
            font-weight: 500 !important;
            color: var(--toss-gray-900) !important;
        }

        .account-search-menu .toss-select-option-description {
            color: var(--toss-gray-600) !important;
            font-size: var(--font-small) !important;
            margin-top: var(--space-1) !important;
        }
        
        .account-option-content {
            display: flex !important;
            align-items: center !important;
            justify-content: space-between !important;
            width: 100% !important;
            gap: var(--space-4) !important;
        }
        
        .account-option-name {
            flex: 1 !important;
            font-weight: 500 !important;
            color: var(--toss-gray-900) !important;
            font-size: 15px !important;
            min-width: 0 !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }
        
        .account-option-type {
            display: inline-flex !important;
            align-items: center !important;
            gap: 6px !important;
            padding: 4px 10px !important;
            border-radius: var(--radius-sm) !important;
            font-size: 13px !important;
            font-weight: 500 !important;
            white-space: nowrap !important;
            flex-shrink: 0 !important;
        }

        .transaction-type-toggle {
            display: flex;
            background: var(--toss-gray-50);
            border-radius: var(--radius-lg);
            padding: var(--space-1);
            position: relative;
        }

        .transaction-type-option {
            flex: 1;
            padding: var(--space-3);
            text-align: center;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            z-index: 1;
            position: relative;
        }

        .transaction-type-option.active {
            color: white;
        }

        .transaction-type-toggle::before {
            content: '';
            position: absolute;
            top: var(--space-1);
            left: var(--space-1);
            width: calc(50% - var(--space-1));
            height: calc(100% - var(--space-2));
            background: var(--toss-primary);
            border-radius: var(--radius-md);
            transition: transform var(--transition-base);
            box-shadow: 0 2px 8px rgba(0, 100, 255, 0.3);
        }

        .transaction-type-toggle.credit::before {
            transform: translateX(100%);
            background: var(--toss-success);
            box-shadow: 0 2px 8px rgba(0, 200, 150, 0.3);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-4);
            margin-bottom: var(--space-5);
        }
        .form-row:last-child {
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--toss-gray-200);
            border-top-color: var(--toss-primary);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ==================== STORE FILTER ==================== */
        .controls-card {
            background: transparent;
            padding: 0;
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .control-section {
            flex: 0 1 auto;
            min-width: 200px;
            max-width: 280px;
            width: 280px;
            display: flex;
            align-items: center;
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            gap: 10px;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: white;
            height: 44px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
            z-index: 10;
            pointer-events: auto;
        }
        
        .control-section:hover {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.12);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        
        .control-section.dropdown-open {
            background: white;
            border-color: #0064FF;
            box-shadow: 0 0 0 4px rgba(0, 100, 255, 0.08);
        }
        
        .control-section.dropdown-open .control-label {
            color: var(--toss-primary);
        }
        
        .control-section.dropdown-open .control-dropdown {
            color: var(--toss-primary);
            transform: rotate(180deg);
        }
        
        .control-icon {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            color: var(--toss-text-secondary);
        }
        
        .control-label {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: var(--toss-text-primary);
            user-select: none;
        }
        
        .control-dropdown {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
            color: var(--toss-text-secondary);
            transition: transform 0.2s ease;
            margin-left: auto;
        }
        
        /* Store Filter Dropdown */
        .store-filter-dropdown {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            min-width: 100%;
            width: max-content;
            max-width: 380px;
            background: white;
            border-radius: 14px;
            box-shadow: 
                0 0 0 1px rgba(0, 0, 0, 0.04),
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px) scale(0.96);
            transition: all 200ms cubic-bezier(0.16, 1, 0.3, 1);
            max-height: 380px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 6px 0;
        }
        
        .store-filter-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .store-filter-search {
            width: calc(100% - 12px);
            padding: 10px 16px;
            border: none;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            font-size: 14px;
            outline: none;
            background: rgba(0, 0, 0, 0.02);
            color: #1a1a1a;
            font-family: inherit;
            margin: 0 6px 6px;
            border-radius: 8px 8px 0 0;
        }
        
        .store-filter-search:focus {
            border-bottom-color: #0064FF;
            background: white;
            box-shadow: 0 0 0 1px rgba(0, 100, 255, 0.2);
        }
        
        .store-filter-search::placeholder {
            color: rgba(0, 0, 0, 0.4);
        }
        
        .store-filter-divider {
            height: 1px;
            background: rgba(0, 0, 0, 0.06);
            margin: 6px 12px;
        }
        
        .store-filter-dropdown-option {
            position: relative;
            padding: 10px 16px;
            margin: 0 6px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 120ms ease-out;
            font-size: 14px;
            color: var(--toss-text-primary);
            user-select: none;
        }
        
        .store-filter-dropdown-option:hover {
            background: rgba(0, 0, 0, 0.04);
        }
        
        .store-filter-dropdown-option:active {
            background: rgba(0, 0, 0, 0.08);
            transform: scale(0.98);
            transition-duration: 50ms;
        }
        
        .store-filter-dropdown-option.selected {
            background: rgba(0, 100, 255, 0.08);
            color: #0064FF;
            font-weight: 500;
        }
        
        .store-filter-dropdown-option.selected:hover {
            background: rgba(0, 100, 255, 0.12);
        }
        
        .store-filter-dropdown-option-icon {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            color: currentColor;
        }
        
        .store-filter-dropdown-option.selected .store-filter-dropdown-option-icon {
            color: var(--toss-primary);
        }
        
        .store-filter-dropdown-option-text {
            font-size: 14px;
            color: currentColor;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .store-filter-dropdown-option.selected .store-filter-dropdown-option-text {
            color: var(--toss-primary);
            font-weight: 500;
        }
        
        .store-filter-dropdown-option-check {
            width: 16px;
            height: 16px;
            color: var(--toss-primary);
            margin-left: auto;
            flex-shrink: 0;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .transaction-modal {
                max-width: 95%;
                width: 95%;
            }
        }
        
        @media (max-width: 768px) {
            .page-content {
                padding: var(--space-4);
            }
            
            .transaction-modal {
                max-width: 100%;
                width: 100%;
                min-height: 100vh;
                border-radius: 0;
            }
            
            .transaction-modal .toss-modal-body {
                padding: var(--space-4);
                min-height: auto;
            }
            
            .transaction-modal .toss-modal-header,
            .transaction-modal .toss-modal-footer {
                padding: var(--space-4);
            }
            
            .transaction-modal .toss-input,
            .transaction-modal .toss-select {
                font-size: 16px; /* Prevent zoom on iOS */
            }
            
            .balance-summary-grid {
                grid-template-columns: 1fr;
                gap: var(--space-3);
            }
            
            .balance-divider {
                display: none;
            }
            
            .actions-grid {
                flex-direction: column;
            }
            
            .transaction-line-header {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-2);
            }
            
            .transaction-line-account {
                margin: 0;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Navigation Bar -->
        <div id="navbar-container"></div>
        
        <!-- Page Content -->
        <main class="page-content">
            <div class="page-header">
                <h1 class="page-title">Journal Entry</h1>
                <p class="page-subtitle">Create balanced financial transactions</p>
            </div>
            
            <!-- Journal Header with Date and Company Info -->
            <div class="journal-header-card">
                <div class="journal-date-info">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19,3H18V1H16V3H8V1H6V3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19Z"/>
                    </svg>
                    <span class="journal-date-text" id="journalDate">2024-01-20</span>
                </div>
                <div class="journal-company-info" id="companyInfo" style="display: none;">
                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,7V3H2V21H22V7H12M6,19H4V17H6V19M6,15H4V13H6V15M6,11H4V9H6V11M6,7H4V5H6V7M10,19H8V17H10V19M10,15H8V13H10V15M10,11H8V9H10V11M10,7H8V5H10V7M20,19H18V17H20V19M20,15H18V13H20V15M20,11H18V9H20V11M16,19H14V17H16V19M16,15H14V13H16V15M16,11H14V9H16V11"/>
                    </svg>
                    <span class="journal-company-text" id="companyName">Company Name</span>
                    <span class="journal-store-text" id="storeName" style="display: none;"> â€¢ Store Name</span>
                </div>
            </div>
            
            <!-- Store Filter Controls -->
            <div class="controls-card">
                <div class="control-section" id="storeFilterControl">
                    <svg class="control-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75Z"/>
                    </svg>
                    <span class="control-label" id="storeFilterLabel">All Stores</span>
                    <svg class="control-dropdown" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                    </svg>
                    
                    <!-- Store Filter Dropdown -->
                    <div class="store-filter-dropdown" id="storeFilterDropdown">
                        <div id="storeFilterOptions">
                            <!-- Store filter options will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Balance Summary -->
            <div class="balance-summary-card">
                <div class="balance-summary-grid">
                    <div class="balance-item clickable" onclick="openTransactionModal(true)">
                        <div class="balance-label">Debits</div>
                        <div class="balance-amount debit" id="totalDebits">0</div>
                        <div class="balance-count" id="debitCount">0 items</div>
                    </div>
                    <div class="balance-divider"></div>
                    <div class="balance-item clickable" onclick="openTransactionModal(false)">
                        <div class="balance-label">Credits</div>
                        <div class="balance-amount credit" id="totalCredits">0</div>
                        <div class="balance-count" id="creditCount">0 items</div>
                    </div>
                    <div class="balance-divider"></div>
                    <div class="balance-item">
                        <div class="balance-label">Difference</div>
                        <div class="balance-amount difference" id="difference">0</div>
                        <div class="balance-count">&nbsp;</div>
                    </div>
                </div>
            </div>

            <!-- Description Input -->
            <div class="description-card">
                <label class="description-label" for="journalDescription">Description (Optional)</label>
                <div class="toss-input-group">
                    <textarea 
                        id="journalDescription" 
                        class="toss-textarea" 
                        rows="2" 
                        placeholder="Enter journal description..."
                        onchange="updateJournalDescription(this.value)">
                    </textarea>
                </div>
            </div>

            <!-- Transaction Lines -->
            <div class="transaction-lines-container">
                <div id="transactionLines">
                    <!-- Transaction lines will be rendered here -->
                </div>
                
                <!-- Empty State -->
                <div class="empty-state" id="emptyState">
                    <svg class="empty-state-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                    </svg>
                    <h3 class="empty-state-title">No transactions added</h3>
                    <p class="empty-state-text">Click Debits or Credits above to add transactions</p>
                </div>
            </div>

            <!-- Actions Footer -->
            <div class="actions-footer">
                <div class="actions-grid">
                    <button class="action-btn add" onclick="openTransactionModal()">
                        <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M17,13H13V17H11V13H7V11H11V7H13V11H17V13Z"/>
                        </svg>
                        Add Transaction
                    </button>
                    <button class="action-btn submit" id="submitBtn" onclick="submitJournalEntry()" disabled>
                        <span id="submitBtnText">Submit Journal Entry</span>
                        <div class="loading-spinner" id="submitSpinner" style="display: none;"></div>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Transaction Modal -->
    <div class="toss-modal-overlay" id="transactionModal">
        <div class="toss-modal transaction-modal">
            <!-- Modal header will be populated by JavaScript -->
            <div class="toss-modal-header">
                <div class="toss-modal-header-content">
                    <h2 class="toss-modal-title" id="modalTitle">Add Transaction</h2>
                </div>
                <button class="toss-modal-close" onclick="closeTransactionModal()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                    </svg>
                </button>
            </div>
            
            <div class="toss-modal-body">
                <form class="transaction-form" id="transactionForm">
                    <!-- Transaction Type Toggle -->
                    <div class="transaction-form-section">
                        <div class="transaction-form-title">Transaction Type</div>
                        <div class="transaction-type-toggle" id="typeToggle">
                            <div class="transaction-type-option active" onclick="setTransactionType(true)">Debit</div>
                            <div class="transaction-type-option" onclick="setTransactionType(false)">Credit</div>
                        </div>
                    </div>
                    
                    <!-- Account Selection -->
                    <div class="transaction-form-section">
                        <div class="transaction-form-title">Account <span style="color: var(--toss-error);">*</span></div>
                        <div class="toss-select-container toss-select-full">
                            <button type="button" class="toss-select" id="accountSelect" onclick="openAccountSearch(event)">
                                <span class="toss-select-value toss-select-placeholder">Select account</span>
                                <svg class="toss-select-arrow" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7,10L12,15L17,10H7Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Conditional Fields Container -->
                    <div id="conditionalFields">
                        <!-- Fields will be populated based on account type -->
                    </div>
                    
                    <!-- Amount -->
                    <div class="transaction-form-section">
                        <div class="transaction-form-title">Amount <span style="color: var(--toss-error);">*</span></div>
                        <div class="toss-input-group">
                            <input type="text" id="amountInput" class="toss-input" placeholder="Enter amount" oninput="formatAmount(this)">
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="transaction-form-section">
                        <div class="transaction-form-title">Description (Optional)</div>
                        <div class="toss-input-group">
                            <input type="text" id="descriptionInput" class="toss-input" placeholder="Enter description">
                        </div>
                    </div>
                </form>
            </div>
            
            <div class="toss-modal-footer">
                <button class="toss-button toss-button-secondary toss-button-lg" onclick="closeTransactionModal()" style="min-width: 100px;">Cancel</button>
                <button class="toss-button toss-button-primary toss-button-lg" id="saveTransactionBtn" onclick="saveTransaction()" style="min-width: 100px;">
                    <span id="saveTransactionText">Add</span>
                    <div class="loading-spinner" id="saveSpinner" style="display: none;"></div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Component JavaScript -->
    <script src="../../../components/base/toss-button.js"></script>
    <script src="../../../components/form/toss-input.js"></script>
    <script src="../../../components/form/toss-select.js"></script>
    <script src="../../../components/layout/toss-modal.js"></script>
    <script src="../../../components/navigation/navbar.js"></script>
    <script src="../../../components/feedback/toss-alert.js"></script>
    
    <!-- Core Scripts -->
    <script src="../../../core/constants/app-icons.js"></script>
    <script src="../../../core/config/supabase.js"></script>
    
    <!-- App State Management -->
    <script src="../../../core/utils/app-state.js"></script>
    
    <!-- Route Mapping -->
    <script src="../../../core/config/route-mapping.js"></script>
    
    <!-- Page Initialization Utility -->
    <script src="../../../core/utils/page-init.js"></script>
    
    <!-- Journal Input JavaScript -->
    <script>
        // Data Models
        class TransactionLine {
            constructor() {
                this.accountId = null;
                this.accountName = null;
                this.categoryTag = null;
                this.description = null;
                this.amount = 0;
                this.isDebit = true;
                this.counterpartyId = null;
                this.counterpartyName = null;
                this.isInternalCounterparty = false;
                this.counterpartyStoreId = null;
                this.counterpartyStoreName = null;
                this.counterpartyStoreCashLocationId = null;
                this.counterpartyStoreCashLocationName = null;
                this.counterpartyStoreCashLocationType = null;
                this.counterpartyStoreCashCurrencyId = null;
                this.cashLocationId = null;
                this.cashLocationName = null;
                this.cashLocationType = null;
                this.cashCurrencyId = null;
                this.linkedCompanyId = null;
                // Debt fields
                this.debtCategory = null;
                this.interestRate = null;
                this.issueDate = null;
                this.dueDate = null;
                this.debtDescription = null;
                // Fixed asset fields
                this.fixedAssetName = null;
                this.salvageValue = null;
                this.acquisitionDate = null;
                this.usefulLife = null;
                this.accountMapping = null;
            }

            toJson() {
                const json = {
                    account_id: this.accountId,
                    description: this.description,
                    debit: this.isDebit ? this.amount.toString() : '0',
                    credit: !this.isDebit ? this.amount.toString() : '0'
                };

                // Add counterparty if present - matching Flutter app exactly
                if (this.counterpartyId && this.counterpartyId.length > 0) {
                    json.counterparty_id = this.counterpartyId;
                    // Note: App does NOT add counterparty_store_id or linked_company_id at top level
                }

                // Add cash location if it's a cash account - matching Flutter app exactly
                if (this.categoryTag === 'cash' && this.cashLocationId) {
                    json.cash = {
                        cash_location_id: this.cashLocationId
                        // Note: App does NOT include currency_id in cash object
                    };
                }

                // Add debt information if it's payable/receivable
                if ((this.categoryTag === 'payable' || this.categoryTag === 'receivable') && 
                    this.counterpartyId && (this.debtCategory || this.interestRate)) {
                    const issueDate = this.issueDate || new Date();
                    const dueDate = this.dueDate || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000);
                    
                    json.debt = {
                        direction: this.categoryTag,
                        category: this.debtCategory || 'other',
                        counterparty_id: this.counterpartyId,
                        original_amount: this.amount.toString(),
                        interest_rate: (this.interestRate || 0).toString(),
                        interest_account_id: '',
                        interest_due_day: 0,
                        issue_date: issueDate.toISOString().split('T')[0],
                        due_date: dueDate.toISOString().split('T')[0],
                        description: this.debtDescription || '',
                        linkedCounterparty_store_id: this.counterpartyStoreId || '',
                        linkedCounterparty_companyId: this.linkedCompanyId || ''
                    };
                }

                // Add fixed asset information if it's a fixed asset
                if (this.categoryTag === 'fixedasset' && this.fixedAssetName) {
                    const acquisitionDate = this.acquisitionDate || new Date();
                    
                    json.fix_asset = {
                        asset_name: this.fixedAssetName,
                        salvage_value: (this.salvageValue || 0).toString(),
                        acquire_date: acquisitionDate.toISOString().split('T')[0],
                        useful_life: (this.usefulLife || 5).toString()
                    };
                }

                // Add account mapping if available
                if (this.accountMapping) {
                    json.account_mapping = this.accountMapping;
                }

                return json;
            }
        }

        class JournalEntry {
            constructor() {
                this.transactionLines = [];
                this.entryDate = new Date();
                this.overallDescription = null;
                this.selectedCompanyId = null;
                this.selectedStoreId = null;
                this.counterpartyCashLocationId = null;  // Added to match Flutter app
            }

            get totalDebits() {
                return this.transactionLines
                    .filter(line => line.isDebit)
                    .reduce((sum, line) => sum + line.amount, 0);
            }

            get totalCredits() {
                return this.transactionLines
                    .filter(line => !line.isDebit)
                    .reduce((sum, line) => sum + line.amount, 0);
            }

            get difference() {
                return this.totalDebits - this.totalCredits;
            }

            get isBalanced() {
                return Math.abs(this.difference) < 0.01;
            }

            get debitCount() {
                return this.transactionLines.filter(line => line.isDebit).length;
            }

            get creditCount() {
                return this.transactionLines.filter(line => !line.isDebit).length;
            }

            addTransactionLine(line) {
                this.transactionLines.push(line);
                this.updateUI();
            }

            removeTransactionLine(index) {
                if (index >= 0 && index < this.transactionLines.length) {
                    this.transactionLines.splice(index, 1);
                    this.updateUI();
                }
            }

            updateTransactionLine(index, line) {
                if (index >= 0 && index < this.transactionLines.length) {
                    this.transactionLines[index] = line;
                    this.updateUI();
                }
            }

            clear() {
                this.transactionLines = [];
                this.entryDate = new Date();
                this.overallDescription = null;
                this.counterpartyCashLocationId = null;
                // Don't clear company and store IDs - they should remain from selection
                this.updateUI();
            }

            canSubmit() {
                return this.transactionLines.length > 0 && 
                       this.isBalanced && 
                       this.selectedCompanyId;
            }

            updateUI() {
                updateBalanceSummary();
                renderTransactionLines();
                updateSubmitButton();
            }
        }

        // Global state
        let journalEntry = new JournalEntry();
        let accounts = [];
        let currentEditIndex = -1;
        let currentStoreFilter = null; // null means "All Stores"

        // Initialize page
        window.skipNavbarAutoInit = true;

        window.initializePage('finance', (companyId, company) => {
            console.log('Company changed in journal input:', companyId);
            journalEntry.selectedCompanyId = companyId;
            
            // Reset store filter when company changes
            currentStoreFilter = null;
            refreshStoreFilter();
            
            loadJournalInputData(companyId, company);
        });

        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize date
            document.getElementById('journalDate').textContent = 
                journalEntry.entryDate.toISOString().split('T')[0];
            
            // Setup store filter
            setupStoreFilter();
            
            // Initialize Supabase client if not already available
            if (!window.supabaseClient && window.supabase && window.supabase.createClient) {
                const SUPABASE_URL = window.ENV?.SUPABASE_URL || '';
                const SUPABASE_ANON_KEY = window.ENV?.SUPABASE_ANON_KEY || '';
                
                if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                    console.error('Supabase credentials not configured');
                    return;
                }
                
                window.supabaseClient = window.supabase.createClient(
                    SUPABASE_URL, 
                    SUPABASE_ANON_KEY
                );
                console.log('Supabase client initialized for journal input page');
            }
            
            // Wait for page initialization to complete
            setTimeout(async () => {
                let companyId = appState.getSelectedCompanyId();
                let company = appState.getSelectedCompany();
                let stores = [];
                
                // If no company in appState, try to load from localStorage or Supabase
                if (!companyId) {
                    console.log('No company in appState, trying to load from storage...');
                    
                    // Try to get from localStorage
                    const userData = localStorage.getItem('user');
                    if (userData) {
                        try {
                            const parsedData = JSON.parse(userData);
                            if (parsedData.companies && parsedData.companies.length > 0) {
                                company = parsedData.companies[0];
                                companyId = company.company_id;
                                stores = company.stores || [];
                                
                                // Set in appState for consistency
                                appState.setSelectedCompany(companyId);
                                console.log('Loaded company from localStorage:', company);
                            }
                        } catch (e) {
                            console.error('Error parsing user data:', e);
                        }
                    }
                    
                    // If still no company, try to load from Supabase
                    if (!companyId && window.supabaseClient) {
                        try {
                            const { data: { user } } = await window.supabaseClient.auth.getUser();
                            if (user) {
                                const { data: companiesData } = await window.supabaseClient
                                    .from('user_companies')
                                    .select(`
                                        company_id,
                                        companies!inner (
                                            company_id,
                                            company_name,
                                            stores (
                                                store_id,
                                                store_name
                                            )
                                        )
                                    `)
                                    .eq('user_id', user.id)
                                    .eq('companies.is_deleted', false);
                                
                                if (companiesData && companiesData.length > 0) {
                                    const companyData = companiesData[0].companies;
                                    company = companyData;
                                    companyId = companyData.company_id;
                                    stores = companyData.stores || [];
                                    
                                    // Store in appState
                                    appState.setSelectedCompany(companyId);
                                    console.log('Loaded company from Supabase:', company);
                                }
                            }
                        } catch (e) {
                            console.error('Error loading from Supabase:', e);
                        }
                    }
                } else {
                    // Company exists in appState
                    stores = appState.getCompanyStores() || [];
                }
                
                if (companyId) {
                    journalEntry.selectedCompanyId = companyId;
                    
                    console.log('Available stores:', stores);
                    
                    // Get selected store or default to first
                    let storeId = appState.getSelectedStore()?.store_id;
                    
                    if (storeId) {
                        journalEntry.selectedStoreId = storeId;
                        currentStoreFilter = storeId;
                        console.log('Initial store set on page load:', storeId);
                    } else if (stores.length > 0) {
                        // Default to first store if none selected
                        const firstStore = stores[0];
                        journalEntry.selectedStoreId = firstStore.store_id;
                        currentStoreFilter = firstStore.store_id;
                        appState.setSelectedStore(firstStore.store_id);
                        console.log('Defaulted to first store:', firstStore);
                    }
                    
                    // Update the display immediately
                    updateStoreFilterDisplay();
                    
                    loadJournalInputData(companyId, company);
                } else {
                    console.warn('No company found, page may not function properly');
                    // Even if no company, still try to load accounts from database
                    loadAccounts();
                }
            }, 100);
        });

        // Load journal input data for company
        async function loadJournalInputData(companyId, company) {
            console.log('Loading journal input for company:', companyId);
            
            // Update company info display
            if (company) {
                const companyInfo = document.getElementById('companyInfo');
                const companyName = document.getElementById('companyName');
                const storeName = document.getElementById('storeName');
                
                companyName.textContent = company.company_name || 'Company';
                companyInfo.style.display = 'flex';
                
                // Get stores and set the first one as selected if none is selected
                const stores = appState.getCompanyStores() || [];
                if (!currentStoreFilter && stores.length > 0) {
                    currentStoreFilter = stores[0].store_id;
                }
                
                // Update store info based on selected store
                if (currentStoreFilter) {
                    const store = stores.find(s => s.store_id === currentStoreFilter);
                    if (store && store.store_name) {
                        storeName.textContent = ` â€¢ ${store.store_name}`;
                        storeName.style.display = 'inline';
                        journalEntry.selectedStoreId = currentStoreFilter;
                    } else {
                        storeName.style.display = 'none';
                        journalEntry.selectedStoreId = null;
                    }
                } else if (stores.length === 0) {
                    // No stores available
                    storeName.style.display = 'none';
                    journalEntry.selectedStoreId = null;
                }
                
                // Update the store filter display
                updateStoreFilterDisplay();
            }
            
            // Load accounts
            await loadAccounts();
            
            // Update UI
            journalEntry.updateUI();
        }

        // Load accounts from database
        async function loadAccounts() {
            console.log('=== Starting loadAccounts ===');
            console.log('Selected company ID:', journalEntry.selectedCompanyId);
            console.log('Supabase client available:', !!window.supabaseClient);
            
            try {
                // First, try to get supabaseClient from window
                let client = window.supabaseClient;
                
                // If not available, try to get from global supabase object
                if (!client && window.supabase && window.supabase.createClient) {
                    console.log('Creating new Supabase client');
                    const SUPABASE_URL = window.ENV?.SUPABASE_URL || '';
                    const SUPABASE_ANON_KEY = window.ENV?.SUPABASE_ANON_KEY || '';
                    
                    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                        console.error('Supabase credentials not configured');
                        throw new Error('Supabase credentials unavailable');
                    }
                    
                    client = window.supabase.createClient(
                        SUPABASE_URL, 
                        SUPABASE_ANON_KEY
                    );
                    window.supabaseClient = client; // Store for reuse
                } else if (!client && window.supabase) {
                    console.log('Using existing supabase client from global');
                    client = window.supabase;
                }

                if (!client) {
                    console.error('âŒ Supabase client not available, cannot load accounts from database');
                    throw new Error('Supabase client unavailable');
                }

                console.log('âœ… Supabase client ready, making database query...');

                // Load ALL accounts from database (accounts table doesn't have company_id)
                console.log('ðŸ“‹ Loading ALL accounts from database...');
                
                const { data, error } = await client
                    .from('accounts')
                    .select('account_id, account_name, category_tag, account_type')
                    .order('account_name');
                
                console.log('ðŸ“Š Query result:', { 
                    accountsFound: data?.length || 0, 
                    error,
                    sampleData: data?.slice(0, 3)
                });
                
                if (error) {
                    console.error('âŒ Database error:', error);
                    throw error;
                }
                
                accounts = data || [];
                console.log(`ðŸŽ¯ Final result: ${accounts.length} accounts loaded`);
                console.log('ðŸ“„ Sample accounts:', accounts.slice(0, 5));
                
                // Group accounts by type for better display
                const accountsByType = {};
                accounts.forEach(account => {
                    const type = account.account_type || 'other';
                    if (!accountsByType[type]) {
                        accountsByType[type] = [];
                    }
                    accountsByType[type].push(account);
                });
                console.log('ðŸ“Š Accounts grouped by type:', Object.keys(accountsByType).map(type => `${type}: ${accountsByType[type].length}`));
                
            } catch (error) {
                console.error('ðŸ’¥ Exception in loadAccounts:', error);
                console.error('âŒ Failed to load accounts from database');
                accounts = []; // Set empty array
                
                // Show error message to user
                showAlert('Failed to load accounts. Please check your connection and try again.', 'error');
            }
            
            console.log(`=== Finished loadAccounts: ${accounts.length} accounts available ===`);
        }

        // Demo accounts function removed - using only real database accounts
        
        // Debug function to manually test database connection
        window.debugDatabaseConnection = async function() {
            console.log('=== DEBUG: Testing Database Connection ===');
            try {
                let client = window.supabaseClient;
                if (!client && window.supabase && window.supabase.createClient) {
                    const SUPABASE_URL = window.ENV?.SUPABASE_URL || '';
                    const SUPABASE_ANON_KEY = window.ENV?.SUPABASE_ANON_KEY || '';
                    
                    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                        console.error('Supabase credentials not configured');
                        return;
                    }
                    
                    client = window.supabase.createClient(
                        SUPABASE_URL, 
                        SUPABASE_ANON_KEY
                    );
                }
                
                if (!client) {
                    console.error('âŒ No Supabase client available');
                    return;
                }
                
                console.log('âœ… Testing database query...');
                const { data, error } = await client
                    .from('accounts')
                    .select('account_id, account_name, category_tag')
                    .order('account_name');
                
                console.log('ðŸ” Database query result:', { data, error });
                console.log('ðŸ“Š Found', data?.length || 0, 'accounts in database');
                
                if (data && data.length > 0) {
                    console.log('âœ… Sample accounts:', data.slice(0, 3));
                } else if (error) {
                    console.error('âŒ Database error:', error);
                } else {
                    console.warn('âš ï¸  Database is empty - no accounts found');
                }
                
            } catch (err) {
                console.error('ðŸ’¥ Debug function error:', err);
            }
            console.log('=== END DEBUG ===');
        };
        
        // Call debug function on page load
        setTimeout(() => {
            console.log('ðŸ”§ Running automatic database connection test...');
            window.debugDatabaseConnection();
        }, 2000);

        // Format currency amount
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 2
            }).format(amount);
        }

        // Format amount input with thousand separators
        function formatAmount(input) {
            let value = input.value.replace(/,/g, '');
            
            // Check if it's a valid number format
            if (!/^\d*\.?\d*$/.test(value)) {
                return;
            }
            
            // Split by decimal point
            const parts = value.split('.');
            let integerPart = parts[0];
            
            // Add thousand separators
            if (integerPart) {
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
            
            // Combine parts
            let formattedValue = integerPart;
            if (parts.length > 1) {
                const decimalPart = parts[1].substring(0, 2); // Limit to 2 decimal places
                formattedValue = `${integerPart}.${decimalPart}`;
            }
            
            input.value = formattedValue;
            
            // Trigger validation after formatting amount
            validateTransactionForm();
        }
        
        // Validate transaction form and enable/disable Add button
        function validateTransactionForm() {
            const accountSelect = document.getElementById('accountSelect');
            const amountInput = document.getElementById('amountInput');
            const saveBtn = document.getElementById('saveTransactionBtn');
            
            if (!saveBtn) return;
            
            // Check basic required fields
            let isValid = true;
            
            // Check account selection
            if (!accountSelect || !accountSelect.dataset.accountId) {
                isValid = false;
            }
            
            // Check amount
            const amount = parseAmount(amountInput?.value || '');
            if (!amount || amount <= 0) {
                isValid = false;
            }
            
            // Check conditional required fields based on account category tag
            const categoryTag = accountSelect?.dataset.categoryTag;
            
            // For cash accounts - need cash location
            if (categoryTag === 'cash') {
                const cashLocationSelect = document.getElementById('cashLocationSelect');
                if (!cashLocationSelect || !cashLocationSelect.dataset.locationId) {
                    isValid = false;
                }
            }
            
            // For payable/receivable accounts - need counterparty and debt category
            else if (categoryTag === 'payable' || categoryTag === 'receivable') {
                // Check counterparty
                const counterpartySelect = document.getElementById('counterpartySelect');
                if (!counterpartySelect || !counterpartySelect.dataset.counterpartyId) {
                    isValid = false;
                }
                
                // Check debt category
                const debtCategory = document.getElementById('debtCategory');
                if (!debtCategory || !debtCategory.value || debtCategory.value === '') {
                    isValid = false;
                }
                
                // If counterparty is internal and has stores, check if store is selected
                if (counterpartySelect && counterpartySelect.dataset.isInternal === 'true') {
                    const counterpartyStoreRow = document.getElementById('counterpartyStoreRow');
                    if (counterpartyStoreRow && counterpartyStoreRow.style.display !== 'none') {
                        const counterpartyStoreSelect = document.getElementById('counterpartyStoreSelect');
                        if (!counterpartyStoreSelect || !counterpartyStoreSelect.dataset.storeId) {
                            isValid = false;
                        }
                        
                        // If store is selected, check cash location
                        const cashLocationRow = document.getElementById('counterpartyStoreCashLocationRow');
                        if (cashLocationRow && cashLocationRow.style.display !== 'none') {
                            const cashLocationSelect = document.getElementById('counterpartyStoreCashLocationSelect');
                            if (!cashLocationSelect || !cashLocationSelect.dataset.locationId) {
                                isValid = false;
                            }
                        }
                    }
                }
            }
            
            // Enable/disable the save button
            saveBtn.disabled = !isValid;
        }

        // Parse formatted amount to number
        function parseAmount(formattedAmount) {
            return parseFloat(formattedAmount.replace(/,/g, '')) || 0;
        }

        // Update balance summary
        function updateBalanceSummary() {
            document.getElementById('totalDebits').textContent = formatCurrency(journalEntry.totalDebits);
            document.getElementById('totalCredits').textContent = formatCurrency(journalEntry.totalCredits);
            document.getElementById('debitCount').textContent = `${journalEntry.debitCount} items`;
            document.getElementById('creditCount').textContent = `${journalEntry.creditCount} items`;
            
            const differenceElement = document.getElementById('difference');
            differenceElement.textContent = formatCurrency(Math.abs(journalEntry.difference));
            
            if (journalEntry.isBalanced) {
                differenceElement.className = 'balance-amount difference';
            } else {
                differenceElement.className = 'balance-amount difference unbalanced';
            }
        }

        // Render transaction lines
        function renderTransactionLines() {
            const container = document.getElementById('transactionLines');
            const emptyState = document.getElementById('emptyState');
            
            if (journalEntry.transactionLines.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            container.innerHTML = journalEntry.transactionLines.map((line, index) => `
                <div class="transaction-line-card ${line.isDebit ? 'debit' : 'credit'}">
                    <div class="transaction-line-header ${line.isDebit ? 'debit' : 'credit'}">
                        <div class="transaction-line-type ${line.isDebit ? 'debit' : 'credit'}">
                            ${line.isDebit ? 'DEBIT' : 'CREDIT'}
                        </div>
                        <div class="transaction-line-account">${line.accountName || 'No Account Selected'}</div>
                        <div class="transaction-line-amount ${line.isDebit ? 'debit' : 'credit'}">
                            ${formatCurrency(line.amount)}
                        </div>
                    </div>
                    <div class="transaction-line-body">
                        ${line.description ? `
                            <div class="transaction-line-description">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M14,10H19.5L14,4.5V10M5,3H15L21,9V19A2,2 0 0,1 19,21H5C3.89,21 3,20.1 3,19V5C3,3.89 3.89,3 5,3M9,12H16V14H9V12M9,16H14V18H9V16Z"/>
                                </svg>
                                <span>${line.description}</span>
                            </div>
                        ` : ''}
                        <div class="transaction-line-tags">
                            ${line.categoryTag ? `
                                <div class="transaction-tag category">
                                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M17.63,5.84C17.27,5.33 16.67,5 16,5L5,5.01C3.9,5.01 3,5.9 3,7V17C3,18.1 3.9,19 5,19H16C16.67,19 17.27,18.67 17.63,18.16L22,12L17.63,5.84Z"/>
                                    </svg>
                                    ${formatCategoryTag(line.categoryTag)}
                                </div>
                            ` : ''}
                            ${line.cashLocationName ? `
                                <div class="transaction-tag cash" style="display: flex; align-items: center; gap: 6px;">
                                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M11,8C11,9.66 9.66,11 8,11C6.34,11 5,9.66 5,8C5,6.34 6.34,5 8,5C9.66,5 11,6.34 11,8M14,20H2V18C2,15.79 4.69,14 8,14C11.31,14 14,15.79 14,18V20M22,8V18H24V8H22M18,10V16H20V10H18M16,13V16H17V13H16Z"/>
                                    </svg>
                                    <span>${line.cashLocationName}</span>
                                    ${line.cashLocationType ? (() => {
                                        let typeBackground = 'rgba(0, 0, 0, 0.05)';
                                        let typeTextColor = 'var(--toss-gray-700)';
                                        
                                        switch(line.cashLocationType?.toLowerCase()) {
                                            case 'cash':
                                            case 'cash_register':
                                            case 'petty_cash':
                                            case 'safe':
                                                typeBackground = 'rgba(0, 200, 150, 0.15)';
                                                typeTextColor = '#00C896';
                                                break;
                                            case 'bank':
                                            case 'bank_account':
                                                typeBackground = 'rgba(0, 100, 255, 0.15)';
                                                typeTextColor = '#0064FF';
                                                break;
                                            case 'vault':
                                                typeBackground = 'rgba(155, 81, 224, 0.15)';
                                                typeTextColor = '#9B51E0';
                                                break;
                                        }
                                        
                                        return `<span style="background: ${typeBackground}; color: ${typeTextColor}; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; text-transform: uppercase; margin-left: 4px;">
                                            ${line.cashLocationType.replace('_', ' ').toUpperCase()}
                                        </span>`;
                                    })() : ''}
                                </div>
                            ` : ''}
                            ${line.counterpartyName ? `
                                <div class="transaction-tag counterparty">
                                    <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M12,6A6,6 0 0,0 6,12A6,6 0 0,0 12,18A6,6 0 0,0 18,12A6,6 0 0,0 12,6Z"/>
                                    </svg>
                                    ${line.counterpartyName}
                                </div>
                            ` : ''}
                        </div>
                        <div class="transaction-line-actions">
                            <button class="transaction-action-btn edit" onclick="editTransaction(${index})">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
                                </svg>
                                Edit
                            </button>
                            <button class="transaction-action-btn delete" onclick="deleteTransaction(${index})">
                                <svg class="icon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                </svg>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Format category tag for display
        function formatCategoryTag(categoryTag) {
            switch (categoryTag.toLowerCase()) {
                case 'fixedasset': return 'Fixed Asset';
                default: return categoryTag.charAt(0).toUpperCase() + categoryTag.slice(1);
            }
        }

        // Update submit button state
        function updateSubmitButton() {
            const submitBtn = document.getElementById('submitBtn');
            if (!submitBtn) {
                console.warn('Submit button not found in updateSubmitButton');
                return;
            }
            
            const canSubmit = journalEntry.canSubmit();
            
            submitBtn.disabled = !canSubmit;
            
            // Update the text span inside the button instead of replacing all content
            let submitBtnText = document.getElementById('submitBtnText');
            
            // If the span doesn't exist, create it (in case textContent was set directly before)
            if (!submitBtnText) {
                // Restore the button structure
                submitBtn.innerHTML = '';
                submitBtnText = document.createElement('span');
                submitBtnText.id = 'submitBtnText';
                submitBtn.appendChild(submitBtnText);
                
                const spinner = document.createElement('div');
                spinner.className = 'loading-spinner';
                spinner.id = 'submitSpinner';
                spinner.style.display = 'none';
                submitBtn.appendChild(spinner);
            }
            
            if (canSubmit) {
                submitBtnText.textContent = 'Submit Journal Entry';
            } else if (journalEntry.transactionLines.length === 0) {
                submitBtnText.textContent = 'Add transactions to submit';
            } else if (!journalEntry.isBalanced) {
                submitBtnText.textContent = 'Balance debits and credits';
            } else {
                submitBtnText.textContent = 'Submit Journal Entry';
            }
        }

        // Update journal description
        function updateJournalDescription(description) {
            journalEntry.overallDescription = description || null;
        }

        // Open transaction modal
        function openTransactionModal(isDebit = null) {
            currentEditIndex = -1;
            
            // Set default transaction type based on balance difference
            let defaultIsDebit = true;
            if (isDebit !== null) {
                defaultIsDebit = isDebit;
            } else if (journalEntry.totalDebits < journalEntry.totalCredits) {
                defaultIsDebit = true;
            } else if (journalEntry.totalCredits < journalEntry.totalDebits) {
                defaultIsDebit = false;
            }
            
            // Reset form
            resetTransactionForm();
            setTransactionType(defaultIsDebit);
            
            // Set suggested amount if there's a difference
            if (Math.abs(journalEntry.difference) > 0.01) {
                document.getElementById('amountInput').value = formatCurrency(Math.abs(journalEntry.difference));
            }
            
            document.getElementById('modalTitle').textContent = 'Add Transaction';
            document.getElementById('saveTransactionText').textContent = 'Add';
            
            // Show modal
            showModal('transactionModal');
            
            // Validate form initially
            validateTransactionForm();
        }

        // Edit transaction
        function editTransaction(index) {
            currentEditIndex = index;
            const line = journalEntry.transactionLines[index];
            
            // Reset form and populate with existing data
            resetTransactionForm();
            setTransactionType(line.isDebit);
            
            // Set account
            if (line.accountId) {
                const accountSelect = document.getElementById('accountSelect');
                accountSelect.querySelector('.toss-select-value').textContent = line.accountName;
                accountSelect.querySelector('.toss-select-value').classList.remove('toss-select-placeholder');
                accountSelect.dataset.accountId = line.accountId;
                accountSelect.dataset.categoryTag = line.categoryTag;
                
                // Load conditional fields for the account type
                loadConditionalFields(line.categoryTag, line);
            }
            
            // Set amount and description
            document.getElementById('amountInput').value = formatCurrency(line.amount);
            document.getElementById('descriptionInput').value = line.description || '';
            
            document.getElementById('modalTitle').textContent = 'Edit Transaction';
            document.getElementById('saveTransactionText').textContent = 'Update';
            
            // Show modal
            showModal('transactionModal');
            
            // Validate form after loading existing data
            validateTransactionForm();
        }

        // Delete transaction
        function deleteTransaction(index) {
            journalEntry.removeTransactionLine(index);
        }

        // Close transaction modal
        function closeTransactionModal() {
            hideModal('transactionModal');
        }

        // Reset transaction form
        function resetTransactionForm() {
            document.getElementById('transactionForm').reset();
            
            // Reset account selection
            const accountSelect = document.getElementById('accountSelect');
            accountSelect.querySelector('.toss-select-value').textContent = 'Select account';
            accountSelect.querySelector('.toss-select-value').classList.add('toss-select-placeholder');
            accountSelect.dataset.accountId = '';
            accountSelect.dataset.categoryTag = '';
            
            // Clear conditional fields
            document.getElementById('conditionalFields').innerHTML = '';
            
            // Reset counterparty store row
            const counterpartyStoreRow = document.getElementById('counterpartyStoreRow');
            if (counterpartyStoreRow) {
                counterpartyStoreRow.style.display = 'none';
            }
            
            // Reset counterparty cash location row
            const counterpartyCashLocationRow = document.getElementById('counterpartyStoreCashLocationRow');
            if (counterpartyCashLocationRow) {
                counterpartyCashLocationRow.style.display = 'none';
            }
            
            // Re-validate the form (should be invalid after reset)
            validateTransactionForm();
        }

        // Set transaction type
        function setTransactionType(isDebit) {
            const toggle = document.getElementById('typeToggle');
            const options = toggle.querySelectorAll('.transaction-type-option');
            
            if (isDebit) {
                toggle.classList.remove('credit');
                options[0].classList.add('active');
                options[1].classList.remove('active');
            } else {
                toggle.classList.add('credit');
                options[0].classList.remove('active');
                options[1].classList.add('active');
            }
            
            toggle.dataset.isDebit = isDebit;
        }

        // Open account search dropdown - simple list view
        function openAccountSearch(event) {
            // Prevent form submission if this function is called from a form button
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            console.log('Opening account search, accounts available:', accounts.length);
            
            const accountSelect = document.getElementById('accountSelect');
            if (!accountSelect) {
                console.error('Account select element not found');
                return;
            }
            
            const existingMenu = document.querySelector('.account-search-menu');
            
            if (existingMenu) {
                console.log('Closing existing menu');
                existingMenu.remove();
                return;
            }
            
            console.log('Creating account dropdown menu');
            
            const menu = document.createElement('div');
            menu.className = 'toss-select-menu toss-select-menu-show account-search-menu';
            menu.style.position = 'absolute';
            menu.style.top = 'calc(100% + 8px)';
            menu.style.left = '0';
            menu.style.zIndex = '1200';
            
            // Add search input at the top
            const searchContainer = document.createElement('div');
            searchContainer.style.padding = '12px';
            searchContainer.style.borderBottom = '1px solid var(--toss-gray-200)';
            searchContainer.style.position = 'sticky';
            searchContainer.style.top = '0';
            searchContainer.style.background = 'var(--toss-white)';
            searchContainer.style.zIndex = '1';
            
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'Search accounts...';
            searchInput.className = 'toss-input';
            searchInput.style.width = '100%';
            searchInput.style.fontSize = '14px';
            searchInput.style.padding = '10px 12px';
            searchContainer.appendChild(searchInput);
            
            // Prevent search container from closing the menu when clicked
            searchContainer.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            menu.appendChild(searchContainer);
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'toss-select-options';
            optionsContainer.style.display = 'flex';
            optionsContainer.style.flexDirection = 'column';
            
            if (accounts.length === 0) {
                const emptyOption = document.createElement('div');
                emptyOption.className = 'toss-select-option';
                emptyOption.style.padding = '24px';
                emptyOption.style.textAlign = 'center';
                emptyOption.innerHTML = `
                    <div class="toss-select-option-content" style="flex-direction: column; align-items: center; gap: 8px;">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="color: var(--toss-gray-300); margin-bottom: 8px;">
                            <path d="M9,3V4H4V6H5V19A2,2 0 0,0 7,21H17A2,2 0 0,0 19,19V6H20V4H15V3H9M7,6H17V19H7V6M9,8V17H11V8H9M13,8V17H15V8H13Z"/>
                        </svg>
                        <div class="toss-select-option-label" style="color: var(--toss-gray-600); font-style: normal; font-size: 16px;">No accounts found</div>
                        <div class="toss-select-option-description" style="color: var(--toss-gray-400); font-size: 14px; margin-top: 4px;">
                            No accounts exist for this company. Please create accounts first.
                        </div>
                    </div>
                `;
                optionsContainer.appendChild(emptyOption);
            } else {
                // Simple list - all accounts sorted alphabetically
                accounts.forEach(account => {
                    console.log('Creating option for account:', account.account_name); // Debug
                    const option = document.createElement('div');
                    option.className = 'toss-select-option account-option';
                    option.dataset.accountName = account.account_name.toLowerCase();
                    console.log('Set dataset.accountName to:', option.dataset.accountName); // Debug
                    
                    // Format category tag with color - Optimized for CASH, BANK, VAULT distinction
                    let categoryColor = 'var(--toss-gray-500)';
                    if (account.category_tag) {
                        switch(account.category_tag.toLowerCase()) {
                            case 'cash': 
                                categoryColor = '#00C896';
                                break;
                            case 'bank': 
                                categoryColor = '#0064FF';
                                break;
                            case 'vault': 
                                categoryColor = '#9B51E0';
                                break;
                            case 'payable': 
                                categoryColor = 'var(--toss-error)';
                                break;
                            case 'receivable': 
                                categoryColor = 'var(--toss-primary)';
                                break;
                            case 'fixedasset': 
                                categoryColor = 'var(--toss-info)';
                                break;
                            case 'equity': 
                                categoryColor = 'var(--toss-warning)';
                                break;
                            case 'retained':
                                categoryColor = 'var(--toss-purple)';
                                break;
                            case 'contra_asset':
                                categoryColor = 'var(--toss-gray-600)';
                                break;
                        }
                    }
                    
                    // Create account option with better layout
                    let typeBackground = 'rgba(0, 0, 0, 0.05)';
                    let typeTextColor = 'var(--toss-gray-700)';
                    
                    // Set colors based on category - Optimized for CASH, BANK, VAULT distinction
                    switch(account.category_tag?.toLowerCase()) {
                        case 'cash':
                            typeBackground = 'rgba(0, 200, 150, 0.15)';
                            typeTextColor = '#00C896';
                            break;
                        case 'bank':
                            typeBackground = 'rgba(0, 100, 255, 0.15)';
                            typeTextColor = '#0064FF';
                            break;
                        case 'vault':
                            typeBackground = 'rgba(155, 81, 224, 0.15)';
                            typeTextColor = '#9B51E0';
                            break;
                        case 'payable':
                            typeBackground = 'rgba(255, 59, 48, 0.1)';
                            typeTextColor = 'var(--toss-error)';
                            break;
                        case 'receivable':
                            typeBackground = 'rgba(0, 100, 255, 0.1)';
                            typeTextColor = 'var(--toss-primary)';
                            break;
                        case 'fixedasset':
                            typeBackground = 'rgba(0, 150, 255, 0.1)';
                            typeTextColor = 'var(--toss-info)';
                            break;
                        case 'equity':
                            typeBackground = 'rgba(255, 204, 0, 0.1)';
                            typeTextColor = 'var(--toss-warning)';
                            break;
                        case 'retained':
                            typeBackground = 'rgba(155, 81, 224, 0.1)';
                            typeTextColor = '#9B51E0';
                            break;
                    }
                    
                    option.innerHTML = `
                        <div class="account-option-content">
                            <div class="account-option-name">
                                ${account.account_name}
                            </div>
                            ${account.category_tag ? `
                                <div class="account-option-type" style="background: ${typeBackground}; color: ${typeTextColor};">
                                    <span>${formatCategoryTag(account.category_tag)}</span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    option.onclick = async () => {
                        await selectAccount(account);
                        menu.remove();
                    };
                    
                    optionsContainer.appendChild(option);
                });
                
            }
            
            menu.appendChild(optionsContainer);
            accountSelect.parentElement.appendChild(menu);
            
            // Focus search input
            setTimeout(() => searchInput?.focus(), 10);
            
            // Add search functionality
            if (searchInput) {
                console.log('Setting up search functionality'); // Debug
                
                // Prevent search input from closing the menu when clicked
                searchInput.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                // Search functionality with debugging
                searchInput.addEventListener('input', (e) => {
                    console.log('ðŸ” Search input triggered!'); // Debug
                    const searchTerm = e.target.value.toLowerCase().trim();
                    console.log('ðŸ” Search term:', `"${searchTerm}"`); // Debug
                    
                    // Find all account options
                    const accountOptions = Array.from(optionsContainer.querySelectorAll('.account-option'));
                    console.log('ðŸ” Found account-options:', accountOptions.length); // Debug
                    
                    if (searchTerm === '') {
                        // Show all options in original order
                        accountOptions.forEach(option => {
                            option.style.display = 'flex';
                            option.style.order = '0';
                        });
                        return;
                    }
                    
                    // Create array to store matches with relevance scores
                    const matches = [];
                    
                    accountOptions.forEach((option, index) => {
                        const accountName = option.dataset.accountName || '';
                        const accountText = option.textContent.toLowerCase();
                        
                        // Calculate relevance score
                        let relevanceScore = 0;
                        const isVisible = accountName.includes(searchTerm) || accountText.includes(searchTerm);
                        
                        if (isVisible) {
                            // Exact match gets highest priority
                            if (accountName === searchTerm) {
                                relevanceScore = 1000;
                            }
                            // Name starts with search term gets high priority
                            else if (accountName.startsWith(searchTerm)) {
                                relevanceScore = 500;
                            }
                            // Name contains search term gets medium priority
                            else if (accountName.includes(searchTerm)) {
                                relevanceScore = 100;
                            }
                            // Text contains search term gets low priority
                            else if (accountText.includes(searchTerm)) {
                                relevanceScore = 10;
                            }
                            
                            // Add to matches array
                            matches.push({
                                element: option,
                                score: relevanceScore,
                                name: accountName,
                                index: index
                            });
                        }
                    });
                    
                    console.log('ðŸ” Found matches:', matches.map(m => ({ name: m.name, score: m.score })));
                    
                    // Hide all options first
                    accountOptions.forEach(option => {
                        option.style.display = 'none';
                        option.style.order = '999';
                    });
                    
                    // Sort matches by relevance score (highest first)
                    matches.sort((a, b) => b.score - a.score);
                    
                    // Show matches in relevance order
                    matches.forEach((match, index) => {
                        match.element.style.display = 'flex';
                        match.element.style.order = index.toString();
                    });
                    
                    console.log('ðŸ” Ordered results:', matches.map(m => m.name));
                    console.log('ðŸ” Filter results:', { visibleCount: matches.length, total: accountOptions.length });
                });
                
                console.log('âœ… Search functionality setup complete');
            } else {
                console.error('âŒ Search input not found!');
            }
            
            console.log('Menu created with', accounts.length, 'accounts');
            
            // Close menu when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeMenu(e) {
                    if (!accountSelect.parentElement.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', closeMenu);
                    }
                });
            }, 0);
        }

        // Select account
        async function selectAccount(account) {
            
            const accountSelect = document.getElementById('accountSelect');
            if (!accountSelect) {
                console.error('Account select element not found');
                return;
            }
            
            const valueElement = accountSelect.querySelector('.toss-select-value');
            if (valueElement) {
                valueElement.textContent = account.account_name;
                valueElement.classList.remove('toss-select-placeholder');
            }
            
            accountSelect.dataset.accountId = account.account_id;
            accountSelect.dataset.categoryTag = account.category_tag || '';
            
            
            // Preload data for payable/receivable accounts
            if (account.category_tag === 'payable' || account.category_tag === 'receivable') {
                console.log('Preloading data for payable/receivable account');
                
                const companyId = appState.getSelectedCompanyId();
                if (companyId && account.account_id) {
                    try {
                        // Load all counterparties with their mappings
                        const [counterpartiesResult, mappingsResult] = await Promise.all([
                            supabaseClient
                                .from('counterparties')
                                .select('counterparty_id, name, is_internal, linked_company_id')
                                .eq('company_id', companyId)
                                .eq('is_deleted', false),
                            supabaseClient
                                .from('account_mappings')
                                .select('counterparty_id, linked_account_id, direction')
                                .eq('my_company_id', companyId)
                                .eq('my_account_id', account.account_id)
                        ]);
                        
                        if (!counterpartiesResult.error && !mappingsResult.error) {
                            const counterparties = counterpartiesResult.data || [];
                            const mappings = mappingsResult.data || [];
                            
                            console.log('Preloaded data:', {
                                counterparties: counterparties.length,
                                mappings: mappings.length,
                                mappedCounterpartyIds: mappings.map(m => m.counterparty_id)
                            });
                            
                            // Store preloaded data for quick access
                            accountSelect.dataset.preloadedCounterparties = JSON.stringify(counterparties);
                            accountSelect.dataset.preloadedMappings = JSON.stringify(mappings);
                        }
                    } catch (error) {
                        console.error('Failed to preload data:', error);
                    }
                }
            }
            
            // Load conditional fields based on account type
            loadConditionalFields(account.category_tag);
            
            // Validate form after selecting account (small delay to ensure DOM is ready)
            setTimeout(() => {
                validateTransactionForm();
            }, 10);
        }

        // Load conditional fields based on account type
        function loadConditionalFields(categoryTag, existingData = null) {
            const container = document.getElementById('conditionalFields');
            container.innerHTML = '';
            
            // Hide counterparty store row and cash location row when switching categories
            const counterpartyStoreRow = document.getElementById('counterpartyStoreRow');
            if (counterpartyStoreRow) {
                counterpartyStoreRow.style.display = 'none';
            }
            
            const counterpartyCashLocationRow = document.getElementById('counterpartyStoreCashLocationRow');
            if (counterpartyCashLocationRow) {
                counterpartyCashLocationRow.style.display = 'none';
            }
            
            if (!categoryTag) return;
            
            // Cash account fields
            if (categoryTag === 'cash') {
                container.innerHTML = `
                    <div class="transaction-form-section">
                        <div class="transaction-form-title">Cash Location <span style="color: var(--toss-error);">*</span></div>
                        <div class="toss-select-container toss-select-full">
                            <button type="button" class="toss-select" id="cashLocationSelect" onclick="openCashLocationSearch()">
                                <span class="toss-select-value toss-select-placeholder">Select cash location</span>
                                <svg class="toss-select-arrow" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7,10L12,15L17,10H7Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                if (existingData && existingData.cashLocationId) {
                    const select = document.getElementById('cashLocationSelect');
                    select.querySelector('.toss-select-value').textContent = existingData.cashLocationName;
                    select.querySelector('.toss-select-value').classList.remove('toss-select-placeholder');
                    select.dataset.locationId = existingData.cashLocationId;
                }
            }
            
            // Payable/Receivable fields
            if (categoryTag === 'payable' || categoryTag === 'receivable') {
                container.innerHTML = `
                    <div class="transaction-form-section">
                        <div class="transaction-form-title">Counterparty <span style="color: var(--toss-error);">*</span></div>
                        <div class="toss-select-container toss-select-full">
                            <button type="button" class="toss-select" id="counterpartySelect" onclick="openCounterpartySearch()">
                                <span class="toss-select-value toss-select-placeholder">Select counterparty</span>
                                <svg class="toss-select-arrow" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7,10L12,15L17,10H7Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="transaction-form-section" id="counterpartyStoreRow" style="display: none;">
                        <div class="transaction-form-title">Counterparty Store <span style="color: var(--toss-error);">*</span></div>
                        <div class="toss-select-container toss-select-full">
                            <button type="button" class="toss-select" id="counterpartyStoreSelect" onclick="openCounterpartyStoreSearch()">
                                <span class="toss-select-value toss-select-placeholder">Select store</span>
                                <svg class="toss-select-arrow" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7,10L12,15L17,10H7Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="transaction-form-section" id="counterpartyStoreCashLocationRow" style="display: none;">
                        <div class="transaction-form-title">Counterparty Cash Location <span style="color: var(--toss-error);">*</span></div>
                        <div class="toss-select-container toss-select-full">
                            <button type="button" class="toss-select" id="counterpartyStoreCashLocationSelect" onclick="openCounterpartyStoreCashLocationSearch()">
                                <span class="toss-select-value toss-select-placeholder">Select cash location</span>
                                <svg class="toss-select-arrow" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7,10L12,15L17,10H7Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="transaction-form-section">
                            <div class="transaction-form-title">Debt Category <span style="color: var(--toss-error);">*</span></div>
                            <div class="toss-select-container toss-select-full">
                                <select class="toss-input" id="debtCategory" required>
                                    <option value="">Select category</option>
                                    <option value="note">Note</option>
                                    <option value="account">Account</option>
                                    <option value="loan">Loan</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="transaction-form-section">
                            <div class="transaction-form-title">Interest Rate (%)</div>
                            <div class="toss-input-group">
                                <input type="number" id="interestRate" class="toss-input" placeholder="0" value="0" step="0.01" min="0">
                            </div>
                        </div>
                    </div>
                `;
                
                if (existingData) {
                    if (existingData.counterpartyId) {
                        const select = document.getElementById('counterpartySelect');
                        const valueElement = select.querySelector('.toss-select-value');
                        
                        // Store data in dataset
                        select.dataset.counterpartyId = existingData.counterpartyId;
                        select.dataset.counterpartyName = existingData.counterpartyName;
                        select.dataset.linkedCompanyId = existingData.linkedCompanyId || '';
                        select.dataset.isInternal = existingData.isInternalCounterparty ? 'true' : 'false';
                        
                        valueElement.textContent = existingData.counterpartyName;
                        valueElement.classList.remove('toss-select-placeholder');
                        
                        // If there's a counterparty store, show the store row and populate it
                        if (existingData.counterpartyStoreId && existingData.counterpartyStoreName) {
                            const counterpartyStoreRow = document.getElementById('counterpartyStoreRow');
                            if (counterpartyStoreRow) {
                                counterpartyStoreRow.style.display = 'block';
                                
                                const storeSelect = document.getElementById('counterpartyStoreSelect');
                                if (storeSelect) {
                                    const storeValueElement = storeSelect.querySelector('.toss-select-value');
                                    if (storeValueElement) {
                                        storeValueElement.textContent = existingData.counterpartyStoreName;
                                        storeValueElement.classList.remove('toss-select-placeholder');
                                    }
                                    
                                    // Store data in dataset
                                    storeSelect.dataset.storeId = existingData.counterpartyStoreId;
                                    storeSelect.dataset.storeName = existingData.counterpartyStoreName;
                                }
                            }
                        }
                    }
                    if (existingData.debtCategory) {
                        document.getElementById('debtCategory').value = existingData.debtCategory;
                    }
                    if (existingData.interestRate) {
                        document.getElementById('interestRate').value = existingData.interestRate;
                    }
                }
                
                // Add event listener for debt category after it's created
                setTimeout(() => {
                    const debtCategorySelect = document.getElementById('debtCategory');
                    if (debtCategorySelect) {
                        debtCategorySelect.addEventListener('change', validateTransactionForm);
                        // Also trigger validation immediately if there's already a value
                        if (debtCategorySelect.value) {
                            validateTransactionForm();
                        }
                    }
                }, 0);
            }
        }

        // Open cash location search (simplified)
        // Load cash locations from database
        async function loadCashLocations() {
            console.log('Loading cash locations...');
            
            const companyId = appState.getSelectedCompanyId();
            const storeId = currentStoreFilter || appState.getSelectedStoreId();
            
            if (!companyId) {
                console.error('No company selected');
                return [];
            }
            
            if (!storeId) {
                console.error('No store selected');
                return [];
            }
            
            try {
                console.log('Querying cash locations with filters:', {
                    company_id: companyId,
                    store_id: storeId,
                    is_deleted: false
                });
                
                const { data, error } = await supabaseClient
                    .from('cash_locations')
                    .select('cash_location_id, location_name, location_type, currency_id')
                    .eq('company_id', companyId)
                    .eq('store_id', storeId)
                    .eq('is_deleted', false)
                    .order('location_name');
                    
                if (error) {
                    console.error('Error loading cash locations:', error);
                    throw error;
                }
                
                console.log('Cash locations loaded:', data);
                return data || [];
                
            } catch (error) {
                console.error('Failed to load cash locations:', error);
                return [];
            }
        }
        
        function openCashLocationSearch() {
            console.log('Opening cash location search...');
            
            const cashLocationSelect = document.getElementById('cashLocationSelect');
            if (!cashLocationSelect) {
                console.error('Cash location select element not found');
                return;
            }
            
            // Check if dropdown already exists and toggle
            const existingMenu = document.querySelector('.cash-location-search-menu');
            if (existingMenu) {
                console.log('Closing existing cash location menu');
                existingMenu.remove();
                return;
            }
            
            // Load and display cash locations
            loadCashLocations().then(locations => {
                console.log('Creating cash location dropdown menu');
                
                const menu = document.createElement('div');
                menu.className = 'toss-select-menu toss-select-menu-show cash-location-search-menu';
                menu.style.position = 'absolute';
                menu.style.top = 'calc(100% + 8px)';
                menu.style.left = '0';
                menu.style.zIndex = '1200';
                
                // Add search input at the top
                const searchContainer = document.createElement('div');
                searchContainer.style.padding = '12px';
                searchContainer.style.borderBottom = '1px solid var(--toss-gray-200)';
                searchContainer.style.position = 'sticky';
                searchContainer.style.top = '0';
                searchContainer.style.background = 'var(--toss-white)';
                searchContainer.style.zIndex = '1';
                
                const searchInput = document.createElement('input');
                searchInput.type = 'text';
                searchInput.placeholder = 'Search cash locations...';
                searchInput.className = 'toss-input';
                searchInput.style.width = '100%';
                searchInput.style.fontSize = '14px';
                searchInput.style.padding = '10px 12px';
                searchContainer.appendChild(searchInput);
                
                // Prevent search container from closing the menu when clicked
                searchContainer.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                
                menu.appendChild(searchContainer);
                
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'toss-select-options';
                optionsContainer.style.display = 'flex';
                optionsContainer.style.flexDirection = 'column';
                
                if (locations.length === 0) {
                    const emptyOption = document.createElement('div');
                    emptyOption.className = 'toss-select-option';
                    emptyOption.style.padding = '24px';
                    emptyOption.style.textAlign = 'center';
                    emptyOption.innerHTML = `
                        <div class="toss-select-option-content" style="flex-direction: column; align-items: center; gap: 8px;">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="color: var(--toss-gray-300); margin-bottom: 8px;">
                                <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,6A1.5,1.5 0 0,1 13.5,7.5A1.5,1.5 0 0,1 12,9A1.5,1.5 0 0,1 10.5,7.5A1.5,1.5 0 0,1 12,6M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,10C13.25,10 15.29,10.54 16.19,12.38C16.66,13.27 16.65,14.35 16.15,15.23C15.5,16.37 14.45,17 13.25,17H10.75C9.55,17 8.5,16.37 7.85,15.23C7.35,14.35 7.34,13.27 7.81,12.38C8.71,10.54 10.75,10 12,10Z"/>
                            </svg>
                            <div class="toss-select-option-label" style="color: var(--toss-gray-600); font-style: normal; font-size: 16px;">No cash locations found</div>
                            <div class="toss-select-option-description" style="color: var(--toss-gray-400); font-size: 14px; margin-top: 4px;">
                                No cash locations exist for this store. Please create cash locations first.
                            </div>
                        </div>
                    `;
                    optionsContainer.appendChild(emptyOption);
                } else {
                    locations.forEach(location => {
                        console.log('Creating option for cash location:', location);
                        const option = document.createElement('div');
                        option.className = 'toss-select-option cash-location-option';
                        option.dataset.locationId = location.cash_location_id;
                        option.dataset.locationName = location.location_name.toLowerCase();
                        option.dataset.currencyId = location.currency_id;
                        
                        // Get location type display
                        let typeBackground = 'rgba(0, 0, 0, 0.05)';
                        let typeTextColor = 'var(--toss-gray-700)';
                        
                        switch(location.location_type?.toLowerCase()) {
                            case 'cash':
                            case 'cash_register':
                            case 'petty_cash':
                            case 'safe':
                                typeBackground = 'rgba(0, 200, 150, 0.15)';
                                typeTextColor = '#00C896';
                                break;
                            case 'bank':
                            case 'bank_account':
                                typeBackground = 'rgba(0, 100, 255, 0.15)';
                                typeTextColor = '#0064FF';
                                break;
                            case 'vault':
                                typeBackground = 'rgba(155, 81, 224, 0.15)';
                                typeTextColor = '#9B51E0';
                                break;
                        }
                        
                        option.innerHTML = `
                            <div class="account-option-content" style="width: 100%;">
                                <div class="account-option-name">
                                    ${location.location_name}
                                </div>
                                ${location.location_type ? `
                                    <div class="account-option-type" style="background: ${typeBackground}; color: ${typeTextColor};">
                                        <span>${location.location_type.replace('_', ' ').toUpperCase()}</span>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                        
                        option.onclick = () => {
                            selectCashLocation(location);
                            menu.remove();
                        };
                        
                        optionsContainer.appendChild(option);
                    });
                    
                    // Add search functionality
                    if (searchInput) {
                        searchInput.addEventListener('click', (e) => {
                            e.stopPropagation();
                        });
                        
                        searchInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.toLowerCase().trim();
                            const locationOptions = Array.from(optionsContainer.querySelectorAll('.cash-location-option'));
                            
                            if (searchTerm === '') {
                                locationOptions.forEach(option => {
                                    option.style.display = 'flex';
                                    option.style.order = '0';
                                });
                                return;
                            }
                            
                            const matches = [];
                            
                            locationOptions.forEach((option, index) => {
                                const locationName = option.dataset.locationName || '';
                                const locationText = option.textContent.toLowerCase();
                                
                                let relevanceScore = 0;
                                const isVisible = locationName.includes(searchTerm) || locationText.includes(searchTerm);
                                
                                if (isVisible) {
                                    if (locationName === searchTerm) {
                                        relevanceScore = 1000;
                                    } else if (locationName.startsWith(searchTerm)) {
                                        relevanceScore = 500;
                                    } else if (locationName.includes(searchTerm)) {
                                        relevanceScore = 100;
                                    } else if (locationText.includes(searchTerm)) {
                                        relevanceScore = 10;
                                    }
                                    
                                    matches.push({
                                        element: option,
                                        score: relevanceScore,
                                        name: locationName,
                                        index: index
                                    });
                                }
                            });
                            
                            // Hide all options first
                            locationOptions.forEach(option => {
                                option.style.display = 'none';
                                option.style.order = '999';
                            });
                            
                            // Sort matches by relevance score (highest first)
                            matches.sort((a, b) => b.score - a.score);
                            
                            // Show matches in relevance order
                            matches.forEach((match, index) => {
                                match.element.style.display = 'flex';
                                match.element.style.order = index.toString();
                            });
                        });
                    }
                }
                
                menu.appendChild(optionsContainer);
                cashLocationSelect.parentElement.appendChild(menu);
                
                // Focus search input
                setTimeout(() => searchInput?.focus(), 10);
                
                // Close menu when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', function closeMenu(e) {
                        if (!cashLocationSelect.parentElement.contains(e.target)) {
                            menu.remove();
                            document.removeEventListener('click', closeMenu);
                        }
                    });
                }, 0);
                
            }).catch(error => {
                console.error('Error opening cash location search:', error);
                alert('Failed to load cash locations. Please try again.');
            });
        }
        
        // Select cash location
        function selectCashLocation(location) {
            
            const cashLocationSelect = document.getElementById('cashLocationSelect');
            if (!cashLocationSelect) {
                console.error('Cash location select element not found');
                return;
            }
            
            const valueElement = cashLocationSelect.querySelector('.toss-select-value');
            if (valueElement) {
                // Get location type colors using same logic as dropdown
                let typeBackground = 'rgba(0, 0, 0, 0.05)';
                let typeTextColor = 'var(--toss-gray-700)';
                
                switch(location.location_type?.toLowerCase()) {
                    case 'cash':
                    case 'cash_register':
                    case 'petty_cash':
                    case 'safe':
                        typeBackground = 'rgba(0, 200, 150, 0.15)';
                        typeTextColor = '#00C896';
                        break;
                    case 'bank':
                    case 'bank_account':
                        typeBackground = 'rgba(0, 100, 255, 0.15)';
                        typeTextColor = '#0064FF';
                        break;
                    case 'vault':
                        typeBackground = 'rgba(155, 81, 224, 0.15)';
                        typeTextColor = '#9B51E0';
                        break;
                }
                
                // Create the same styled structure as dropdown options
                if (location.location_type) {
                    valueElement.innerHTML = `
                        <div class="account-option-content" style="width: 100%; display: flex; align-items: center; justify-content: space-between;">
                            <div class="account-option-name" style="font-weight: 500;">
                                ${location.location_name}
                            </div>
                            <div class="account-option-type" style="background: ${typeBackground}; color: ${typeTextColor}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                <span>${location.location_type.replace('_', ' ').toUpperCase()}</span>
                            </div>
                        </div>
                    `;
                } else {
                    valueElement.textContent = location.location_name;
                }
                valueElement.classList.remove('toss-select-placeholder');
            }
            
            // Store the cash location data
            cashLocationSelect.dataset.locationId = location.cash_location_id;
            cashLocationSelect.dataset.locationName = location.location_name;
            cashLocationSelect.dataset.locationType = location.location_type || '';
            cashLocationSelect.dataset.currencyId = location.currency_id || '';
            
            
            // Trigger validation after selecting cash location
            validateTransactionForm();
        }

        // Load counterparties from database
        async function loadCounterparties() {
            console.log('Loading counterparties...');
            
            const companyId = appState.getSelectedCompanyId();
            
            if (!companyId) {
                console.error('No company selected');
                return [];
            }
            
            try {
                console.log('Querying counterparties with filters:', {
                    company_id: companyId,
                    is_deleted: false
                });
                
                const { data, error } = await supabaseClient
                    .from('counterparties')
                    .select('counterparty_id, name, is_internal, linked_company_id')
                    .eq('company_id', companyId)
                    .eq('is_deleted', false)
                    .order('name');
                    
                if (error) {
                    console.error('Error loading counterparties:', error);
                    throw error;
                }
                
                // Sort counterparties with INTERNAL at the top
                const sortedData = (data || []).sort((a, b) => {
                    // Internal counterparties come first
                    if (a.is_internal && !b.is_internal) return -1;
                    if (!a.is_internal && b.is_internal) return 1;
                    // Then sort alphabetically by name
                    return a.name.localeCompare(b.name);
                });
                
                console.log('Counterparties loaded and sorted:', sortedData);
                return sortedData;
                
            } catch (error) {
                console.error('Failed to load counterparties:', error);
                return [];
            }
        }

        // Open counterparty search dropdown
        function openCounterpartySearch() {
            console.log('Opening counterparty search...');
            
            const counterpartySelect = document.getElementById('counterpartySelect');
            if (!counterpartySelect) {
                console.error('Counterparty select element not found');
                return;
            }
            
            // Clean up any existing listener
            if (window.counterpartyCloseMenu) {
                document.removeEventListener('click', window.counterpartyCloseMenu);
                window.counterpartyCloseMenu = null;
            }
            
            const existingMenu = document.querySelector('.counterparty-search-menu');
            if (existingMenu) {
                console.log('Closing existing menu');
                existingMenu.remove();
                return;
            }
            
            console.log('Creating counterparty dropdown menu');
            
            const menu = document.createElement('div');
            menu.className = 'toss-select-menu toss-select-menu-show counterparty-search-menu';
            menu.style.position = 'absolute';
            menu.style.top = 'calc(100% + 8px)';
            menu.style.left = '0';
            menu.style.width = '100%';
            menu.style.maxHeight = '400px';
            menu.style.overflowY = 'auto';
            menu.style.zIndex = '1200';
            menu.style.background = 'var(--toss-white)';
            menu.style.border = '1px solid var(--toss-gray-300)';
            menu.style.borderRadius = 'var(--radius-lg)';
            menu.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
            
            // Add search container
            const searchContainer = document.createElement('div');
            searchContainer.style.padding = '12px';
            searchContainer.style.borderBottom = '1px solid var(--toss-gray-200)';
            searchContainer.style.position = 'sticky';
            searchContainer.style.top = '0';
            searchContainer.style.background = 'var(--toss-white)';
            searchContainer.style.zIndex = '10';
            
            const searchInput = document.createElement('input');
            searchInput.type = 'text';
            searchInput.placeholder = 'Search counterparties...';
            searchInput.className = 'toss-select-search';
            searchInput.style.width = '100%';
            searchInput.style.padding = '12px';
            searchInput.style.border = '1px solid var(--toss-gray-300)';
            searchInput.style.borderRadius = 'var(--radius-md)';
            searchInput.style.fontSize = 'var(--font-body)';
            searchInput.style.background = 'var(--toss-gray-50)';
            searchInput.style.outline = 'none';
            
            searchContainer.appendChild(searchInput);
            menu.appendChild(searchContainer);
            
            // Add options container
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'counterparty-options';
            optionsContainer.style.padding = '8px';
            menu.appendChild(optionsContainer);
            
            // Show loading state
            optionsContainer.innerHTML = `
                <div class="toss-select-option" style="padding: 20px; text-align: center; color: var(--toss-gray-500);">
                    Loading counterparties...
                </div>
            `;
            
            counterpartySelect.style.position = 'relative';
            counterpartySelect.appendChild(menu);
            
            // Focus search input
            setTimeout(() => searchInput.focus(), 50);
            
            // Load and display counterparties with mapping status
            loadCounterparties().then(async counterparties => {
                console.log('Displaying counterparties:', counterparties.length);
                
                if (counterparties.length === 0) {
                    optionsContainer.innerHTML = `
                        <div class="toss-select-option" style="padding: 20px; text-align: center; color: var(--toss-gray-500);">
                            <div style="margin-bottom: 8px;">No counterparties found</div>
                            <div style="font-size: var(--font-small);">Add counterparties from the Counterparty Management page</div>
                        </div>
                    `;
                } else {
                    // Get current account and company for mapping check
                    const accountSelect = document.getElementById('accountSelect');
                    const companyId = appState.getSelectedCompanyId();
                    const accountId = accountSelect?.dataset.accountId;
                    
                    // Load all mappings for this account
                    let mappings = [];
                    if (accountId && companyId) {
                        try {
                            const { data } = await supabaseClient
                                .from('account_mappings')
                                .select('counterparty_id')
                                .eq('my_company_id', companyId)
                                .eq('my_account_id', accountId);
                            
                            mappings = (data || []).map(m => m.counterparty_id);
                            console.log('Account mappings loaded:', mappings);
                        } catch (error) {
                            console.error('Failed to load mappings:', error);
                        }
                    }
                    
                    optionsContainer.innerHTML = '';
                    counterparties.forEach(counterparty => {
                        console.log('Creating option for counterparty:', counterparty);
                        const option = document.createElement('div');
                        option.className = 'toss-select-option counterparty-option';
                        option.dataset.counterpartyId = counterparty.counterparty_id;
                        option.dataset.counterpartyName = counterparty.name.toLowerCase();
                        option.dataset.linkedCompanyId = counterparty.linked_company_id || '';
                        option.dataset.isInternal = counterparty.is_internal;
                        
                        // Check if this counterparty is mapped
                        const isMapped = mappings.includes(counterparty.counterparty_id);
                        
                        // Set colors based on internal/external status
                        let typeBackground = 'rgba(0, 0, 0, 0.05)';
                        let typeTextColor = 'var(--toss-gray-700)';
                        let typeText = 'EXTERNAL';
                        
                        if (counterparty.is_internal) {
                            typeBackground = 'rgba(0, 100, 255, 0.15)';
                            typeTextColor = '#0064FF';
                            typeText = 'INTERNAL';
                        } else {
                            typeBackground = 'rgba(128, 128, 128, 0.15)';
                            typeTextColor = '#6C757D';
                            typeText = 'EXTERNAL';
                        }
                        
                        // Add mapping status for internal counterparties
                        let mappingIndicator = '';
                        if (counterparty.is_internal) {
                            if (isMapped) {
                                mappingIndicator = `
                                    <div style="background: rgba(0, 200, 150, 0.15); color: #00C896; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-left: 8px;">
                                        MAPPED
                                    </div>
                                `;
                            } else {
                                mappingIndicator = `
                                    <div style="background: rgba(255, 88, 71, 0.15); color: #FF5847; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; margin-left: 8px;">
                                        NOT MAPPED
                                    </div>
                                `;
                            }
                        }
                        
                        option.innerHTML = `
                            <div class="account-option-content" style="width: 100%; display: flex; align-items: center; justify-content: space-between;">
                                <div class="account-option-name">
                                    ${counterparty.name}
                                </div>
                                <div style="display: flex; align-items: center;">
                                    <div class="account-option-type" style="background: ${typeBackground}; color: ${typeTextColor}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                        <span>${typeText}</span>
                                    </div>
                                    ${mappingIndicator}
                                </div>
                            </div>
                        `;
                        
                        option.onclick = async (e) => {
                            e.stopPropagation();
                            await selectCounterparty(counterparty);
                            // Remove the menu immediately
                            const menuToRemove = document.querySelector('.counterparty-search-menu');
                            if (menuToRemove) {
                                menuToRemove.remove();
                            }
                            // Also remove the click outside listener
                            document.removeEventListener('click', window.counterpartyCloseMenu);
                        };
                        
                        optionsContainer.appendChild(option);
                    });
                    
                    // Add search functionality
                    if (searchInput) {
                        searchInput.addEventListener('click', (e) => {
                            e.stopPropagation();
                        });
                        
                        searchInput.addEventListener('input', (e) => {
                            const searchTerm = e.target.value.toLowerCase().trim();
                            const counterpartyOptions = Array.from(optionsContainer.querySelectorAll('.counterparty-option'));
                            
                            if (searchTerm === '') {
                                counterpartyOptions.forEach(option => {
                                    option.style.display = 'flex';
                                    option.style.order = '0';
                                });
                                return;
                            }
                            
                            let hasVisibleOptions = false;
                            
                            counterpartyOptions.forEach(option => {
                                const name = option.dataset.counterpartyName || '';
                                const relevanceScore = calculateRelevanceScore(name, searchTerm);
                                
                                if (relevanceScore > 0) {
                                    option.style.display = 'flex';
                                    option.style.order = String(10000 - relevanceScore);
                                    hasVisibleOptions = true;
                                } else {
                                    option.style.display = 'none';
                                }
                            });
                            
                            if (!hasVisibleOptions) {
                                if (!document.querySelector('.no-results-message')) {
                                    const noResultsDiv = document.createElement('div');
                                    noResultsDiv.className = 'no-results-message';
                                    noResultsDiv.style.padding = '20px';
                                    noResultsDiv.style.textAlign = 'center';
                                    noResultsDiv.style.color = 'var(--toss-gray-500)';
                                    noResultsDiv.textContent = 'No matching counterparties found';
                                    optionsContainer.appendChild(noResultsDiv);
                                }
                            } else {
                                const noResultsMsg = document.querySelector('.no-results-message');
                                if (noResultsMsg) {
                                    noResultsMsg.remove();
                                }
                            }
                        });
                    }
                }
            }).catch(error => {
                console.error('Failed to load counterparties:', error);
                optionsContainer.innerHTML = `
                    <div class="toss-select-option" style="padding: 20px; text-align: center; color: var(--toss-error);">
                        Failed to load counterparties. Please try again.
                    </div>
                `;
            });
            
            // Close menu when clicking outside
            setTimeout(() => {
                window.counterpartyCloseMenu = function(e) {
                    if (!counterpartySelect.contains(e.target) && !menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', window.counterpartyCloseMenu);
                        window.counterpartyCloseMenu = null;
                    }
                };
                document.addEventListener('click', window.counterpartyCloseMenu);
            }, 100);
        }
        
        // Select a counterparty
        async function selectCounterparty(counterparty) {
            console.log('Selecting counterparty:', counterparty);
            
            const counterpartySelect = document.getElementById('counterpartySelect');
            if (!counterpartySelect) {
                console.error('Counterparty select element not found');
                return;
            }
            
            // Hide the counterparty store and cash location rows initially
            const counterpartyStoreRow = document.getElementById('counterpartyStoreRow');
            if (counterpartyStoreRow) {
                counterpartyStoreRow.style.display = 'none';
            }
            
            const counterpartyCashLocationRow = document.getElementById('counterpartyStoreCashLocationRow');
            if (counterpartyCashLocationRow) {
                counterpartyCashLocationRow.style.display = 'none';
            }
            
            // If it's an internal counterparty, check account mappings first
            if (counterparty.is_internal) {
                console.log('Checking account mappings for internal counterparty');
                
                const companyId = appState.getSelectedCompanyId();
                if (!companyId) {
                    console.error('No company selected');
                    showAlert('Please select a company first', 'error');
                    return;
                }
                
                // Get the selected account ID
                const accountSelect = document.getElementById('accountSelect');
                if (!accountSelect || !accountSelect.dataset.accountId) {
                    console.error('No account selected');
                    showAlert('Please select an account first', 'error');
                    return;
                }
                
                const accountId = accountSelect.dataset.accountId;
                console.log('Checking mappings for account:', accountId, 'and counterparty:', counterparty.counterparty_id);
                
                try {
                    // Check account mappings with account filter
                    const { data: mappings, error: mappingError } = await supabaseClient
                        .from('account_mappings')
                        .select('*')
                        .eq('my_company_id', companyId)
                        .eq('counterparty_id', counterparty.counterparty_id)
                        .eq('my_account_id', accountId);
                    
                    if (mappingError) {
                        console.error('Error checking account mappings:', mappingError);
                        showAlert('Failed to check account mappings', 'error');
                        return;
                    }
                    
                    console.log('Account mappings found:', mappings);
                    
                    // If no mappings exist, show message and reset
                    if (!mappings || mappings.length === 0) {
                        showAlert('Please map this account with the selected counterparty first', 'warning');
                        
                        // Reset counterparty selection
                        const valueElement = counterpartySelect.querySelector('.toss-select-value');
                        if (valueElement) {
                            valueElement.innerHTML = 'Select counterparty';
                            valueElement.classList.add('toss-select-placeholder');
                        }
                        counterpartySelect.dataset.counterpartyId = '';
                        counterpartySelect.dataset.counterpartyName = '';
                        counterpartySelect.dataset.isInternal = '';
                        counterpartySelect.dataset.linkedCompanyId = '';
                        
                        return;
                    }
                    
                    // If mappings exist and counterparty has linked_company_id, load stores
                    if (counterparty.linked_company_id) {
                        console.log('Loading stores for linked company:', counterparty.linked_company_id);
                        
                        const { data: stores, error: storeError } = await supabaseClient
                            .from('stores')
                            .select('store_id, store_name')
                            .eq('company_id', counterparty.linked_company_id)
                            .eq('is_deleted', false)
                            .order('store_name');
                        
                        if (storeError) {
                            console.error('Error loading stores:', storeError);
                            showAlert('Failed to load counterparty stores', 'error');
                        } else if (stores && stores.length > 0) {
                            console.log('Stores loaded:', stores);
                            
                            // Show store selection
                            if (counterpartyStoreRow) {
                                counterpartyStoreRow.style.display = 'block';
                                
                                // Populate store dropdown
                                const storeSelect = document.getElementById('counterpartyStoreSelect');
                                if (storeSelect) {
                                    const valueElement = storeSelect.querySelector('.toss-select-value');
                                    if (valueElement) {
                                        valueElement.innerHTML = 'Select store';
                                        valueElement.classList.add('toss-select-placeholder');
                                    }
                                    
                                    // Store the stores data for later use
                                    storeSelect.dataset.stores = JSON.stringify(stores);
                                }
                            }
                        }
                    }
                    
                } catch (error) {
                    console.error('Error processing internal counterparty:', error);
                    showAlert('Failed to process counterparty selection', 'error');
                    return;
                }
            }
            
            // Continue with normal selection
            const valueElement = counterpartySelect.querySelector('.toss-select-value');
            if (valueElement) {
                // Set colors based on internal/external status
                let typeBackground = 'rgba(0, 0, 0, 0.05)';
                let typeTextColor = 'var(--toss-gray-700)';
                let typeText = 'EXTERNAL';
                
                if (counterparty.is_internal) {
                    typeBackground = 'rgba(0, 100, 255, 0.15)';
                    typeTextColor = '#0064FF';
                    typeText = 'INTERNAL';
                } else {
                    typeBackground = 'rgba(128, 128, 128, 0.15)';
                    typeTextColor = '#6C757D';
                    typeText = 'EXTERNAL';
                }
                
                // Create the same styled structure as dropdown options
                valueElement.innerHTML = `
                    <div class="account-option-content" style="width: 100%; display: flex; align-items: center; justify-content: space-between;">
                        <div class="account-option-name" style="font-weight: 500;">
                            ${counterparty.name}
                        </div>
                        <div class="account-option-type" style="background: ${typeBackground}; color: ${typeTextColor}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                            <span>${typeText}</span>
                        </div>
                    </div>
                `;
                valueElement.classList.remove('toss-select-placeholder');
            }
            
            // Store the counterparty data
            counterpartySelect.dataset.counterpartyId = counterparty.counterparty_id;
            counterpartySelect.dataset.counterpartyName = counterparty.name;
            counterpartySelect.dataset.isInternal = counterparty.is_internal;
            counterpartySelect.dataset.linkedCompanyId = counterparty.linked_company_id || '';
            
            
            // Trigger validation after selecting counterparty
            validateTransactionForm();
        }

        // Open counterparty store search dropdown
        function openCounterpartyStoreSearch() {
            console.log('Opening counterparty store search...');
            
            const storeSelect = document.getElementById('counterpartyStoreSelect');
            if (!storeSelect) {
                console.error('Store select element not found');
                return;
            }
            
            // Check if stores data is available
            const storesData = storeSelect.dataset.stores;
            if (!storesData) {
                console.error('No stores data available');
                return;
            }
            
            const stores = JSON.parse(storesData);
            
            const existingMenu = document.querySelector('.counterparty-store-search-menu');
            if (existingMenu) {
                console.log('Closing existing menu');
                existingMenu.remove();
                return;
            }
            
            console.log('Creating store dropdown menu');
            
            const menu = document.createElement('div');
            menu.className = 'toss-select-menu toss-select-menu-show counterparty-store-search-menu';
            menu.style.position = 'absolute';
            menu.style.top = 'calc(100% + 8px)';
            menu.style.left = '0';
            menu.style.width = '100%';
            menu.style.maxHeight = '300px';
            menu.style.overflowY = 'auto';
            menu.style.zIndex = '1200';
            menu.style.background = 'var(--toss-white)';
            menu.style.border = '1px solid var(--toss-gray-300)';
            menu.style.borderRadius = 'var(--radius-lg)';
            menu.style.boxShadow = '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)';
            
            // Add options container
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'store-options';
            optionsContainer.style.padding = '8px';
            
            // Add store options
            stores.forEach(store => {
                const option = document.createElement('div');
                option.className = 'toss-select-option store-option';
                option.dataset.storeId = store.store_id;
                option.dataset.storeName = store.store_name;
                
                option.innerHTML = `
                    <div class="account-option-content" style="width: 100%; display: flex; align-items: center;">
                        <div class="account-option-name">
                            ${store.store_name}
                        </div>
                    </div>
                `;
                
                option.onclick = (e) => {
                    e.stopPropagation();
                    selectCounterpartyStore(store);
                    menu.remove();
                    // Remove the click outside listener
                    if (window.counterpartyStoreCloseMenu) {
                        document.removeEventListener('click', window.counterpartyStoreCloseMenu);
                        window.counterpartyStoreCloseMenu = null;
                    }
                };
                
                optionsContainer.appendChild(option);
            });
            
            menu.appendChild(optionsContainer);
            
            storeSelect.style.position = 'relative';
            storeSelect.appendChild(menu);
            
            // Close menu when clicking outside
            setTimeout(() => {
                window.counterpartyStoreCloseMenu = function(e) {
                    if (!storeSelect.contains(e.target) && !menu.contains(e.target)) {
                        menu.remove();
                        document.removeEventListener('click', window.counterpartyStoreCloseMenu);
                        window.counterpartyStoreCloseMenu = null;
                    }
                };
                document.addEventListener('click', window.counterpartyStoreCloseMenu);
            }, 100);
        }
        
        // Select a counterparty store
        async function selectCounterpartyStore(store) {
            console.log('Selecting counterparty store:', store);
            
            const storeSelect = document.getElementById('counterpartyStoreSelect');
            if (!storeSelect) {
                console.error('Store select element not found');
                return;
            }
            
            const valueElement = storeSelect.querySelector('.toss-select-value');
            if (valueElement) {
                valueElement.innerHTML = store.store_name;
                valueElement.classList.remove('toss-select-placeholder');
            }
            
            // Store the store data
            storeSelect.dataset.storeId = store.store_id;
            storeSelect.dataset.storeName = store.store_name;
            
            
            // Show the cash location row and reset it
            const cashLocationRow = document.getElementById('counterpartyStoreCashLocationRow');
            const cashLocationSelect = document.getElementById('counterpartyStoreCashLocationSelect');
            
            if (cashLocationRow) {
                cashLocationRow.style.display = 'block';
            }
            
            if (cashLocationSelect) {
                // Reset the cash location selection
                const valueElement = cashLocationSelect.querySelector('.toss-select-value');
                if (valueElement) {
                    valueElement.textContent = 'Select cash location';
                    valueElement.classList.add('toss-select-placeholder');
                }
                
                // Clear previous data
                delete cashLocationSelect.dataset.cashLocationId;
                delete cashLocationSelect.dataset.locationName;
                delete cashLocationSelect.dataset.locationType;
                delete cashLocationSelect.dataset.currencyId;
                
                // Store the store ID for querying cash locations
                cashLocationSelect.dataset.storeId = store.store_id;
            }
            
            // Trigger validation after selecting store
            validateTransactionForm();
        }
        
        // Open counterparty store cash location search
        async function openCounterpartyStoreCashLocationSearch() {
            const cashLocationSelect = document.getElementById('counterpartyStoreCashLocationSelect');
            if (!cashLocationSelect) return;
            
            const storeId = cashLocationSelect.dataset.storeId;
            if (!storeId) {
                showAlert('Please select a counterparty store first', 'error');
                return;
            }
            
            // Remove existing menu if any
            const existingMenu = document.querySelector('.counterparty-cash-location-search-menu');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            // Create dropdown menu
            const menu = document.createElement('div');
            menu.className = 'counterparty-search-menu counterparty-cash-location-search-menu';
            
            // Get Supabase client
            const SUPABASE_URL = window.ENV?.SUPABASE_URL || '';
            const SUPABASE_ANON_KEY = window.ENV?.SUPABASE_ANON_KEY || '';
            
            let supabaseClient = window.supabaseClient;
            if (!supabaseClient && window.supabase?.createClient && SUPABASE_URL && SUPABASE_ANON_KEY) {
                supabaseClient = window.supabase.createClient(
                    SUPABASE_URL,
                    SUPABASE_ANON_KEY
                );
            }
            
            if (!supabaseClient) {
                showAlert('Supabase client not available', 'error');
                return;
            }
            
            try {
                // Query cash locations for the selected store
                const { data: cashLocations, error } = await supabaseClient
                    .from('cash_locations')
                    .select('cash_location_id, location_name, location_type, currency_id')
                    .eq('store_id', storeId)
                    .eq('is_deleted', false)
                    .order('location_name');
                
                if (error) throw error;
                
                if (!cashLocations || cashLocations.length === 0) {
                    showAlert('No cash locations found for this store', 'info');
                    return;
                }
                
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'toss-select-options';
                
                cashLocations.forEach(location => {
                    const option = document.createElement('div');
                    option.className = 'toss-select-option';
                    
                    // Format display with location type
                    const typeLabel = location.location_type === 'vault' ? 'Vault' : 
                                     location.location_type === 'bank' ? 'Bank' : 
                                     location.location_type;
                    
                    option.innerHTML = `
                        <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                            <span style="font-weight: 500; color: var(--toss-gray-900);">
                                ${location.location_name}
                            </span>
                            <span style="font-size: 13px; color: var(--toss-gray-600); padding: 4px 8px; background: var(--toss-gray-100); border-radius: 4px;">
                                ${typeLabel}
                            </span>
                        </div>
                    `;
                    
                    option.onclick = (e) => {
                        e.stopPropagation();
                        selectCounterpartyStoreCashLocation(location);
                        menu.remove();
                        // Remove the click outside listener
                        if (window.counterpartyCashLocationCloseMenu) {
                            document.removeEventListener('click', window.counterpartyCashLocationCloseMenu);
                            window.counterpartyCashLocationCloseMenu = null;
                        }
                    };
                    
                    optionsContainer.appendChild(option);
                });
                
                menu.appendChild(optionsContainer);
                
                cashLocationSelect.style.position = 'relative';
                cashLocationSelect.appendChild(menu);
                
                // Close menu when clicking outside
                setTimeout(() => {
                    window.counterpartyCashLocationCloseMenu = function(e) {
                        if (!cashLocationSelect.contains(e.target) && !menu.contains(e.target)) {
                            menu.remove();
                            document.removeEventListener('click', window.counterpartyCashLocationCloseMenu);
                            window.counterpartyCashLocationCloseMenu = null;
                        }
                    };
                    document.addEventListener('click', window.counterpartyCashLocationCloseMenu);
                }, 100);
                
            } catch (error) {
                console.error('Failed to load cash locations:', error);
                showAlert('Failed to load cash locations', 'error');
            }
        }
        
        // Select a counterparty store cash location
        function selectCounterpartyStoreCashLocation(location) {
            console.log('Selecting counterparty store cash location:', location);
            
            const cashLocationSelect = document.getElementById('counterpartyStoreCashLocationSelect');
            if (!cashLocationSelect) {
                console.error('Cash location select element not found');
                return;
            }
            
            const valueElement = cashLocationSelect.querySelector('.toss-select-value');
            if (valueElement) {
                const typeLabel = location.location_type === 'vault' ? 'Vault' : 
                                 location.location_type === 'bank' ? 'Bank' : 
                                 location.location_type;
                valueElement.innerHTML = `${location.location_name} (${typeLabel})`;
                valueElement.classList.remove('toss-select-placeholder');
            }
            
            // Store the cash location data
            cashLocationSelect.dataset.locationId = location.cash_location_id;  // Changed from cashLocationId to locationId to match validation
            cashLocationSelect.dataset.locationName = location.location_name;
            cashLocationSelect.dataset.locationType = location.location_type;
            cashLocationSelect.dataset.currencyId = location.currency_id;
            
            
            // Trigger validation after selecting cash location
            validateTransactionForm();
        }
        
        // Save transaction
        function saveTransaction() {
            const accountSelect = document.getElementById('accountSelect');
            const amountInput = document.getElementById('amountInput');
            const descriptionInput = document.getElementById('descriptionInput');
            const typeToggle = document.getElementById('typeToggle');
            
            // Validate required fields
            if (!accountSelect.dataset.accountId) {
                showAlert('Please select an account', 'error');
                return;
            }
            
            const amount = parseAmount(amountInput.value);
            if (!amount || amount <= 0) {
                showAlert('Please enter a valid amount', 'error');
                return;
            }
            
            // Validate debt category for payable/receivable accounts
            const categoryTag = accountSelect.dataset.categoryTag;
            if (categoryTag === 'payable' || categoryTag === 'receivable') {
                const debtCategory = document.getElementById('debtCategory');
                if (debtCategory && (!debtCategory.value || debtCategory.value === '')) {
                    showAlert('Please select a debt category', 'error');
                    return;
                }
            }
            
            // Create transaction line
            const line = new TransactionLine();
            line.accountId = accountSelect.dataset.accountId;
            line.accountName = accountSelect.querySelector('.toss-select-value').textContent;
            line.categoryTag = accountSelect.dataset.categoryTag;
            line.amount = amount;
            line.isDebit = typeToggle.dataset.isDebit === 'true';
            line.description = descriptionInput.value || null;
            
            // Add conditional field data
            // categoryTag already defined above in validation section
            
            if (categoryTag === 'cash') {
                const cashLocationSelect = document.getElementById('cashLocationSelect');
                if (cashLocationSelect && cashLocationSelect.dataset.locationId) {
                    line.cashLocationId = cashLocationSelect.dataset.locationId;
                    line.cashLocationName = cashLocationSelect.dataset.locationName;
                    line.cashLocationType = cashLocationSelect.dataset.locationType;
                    line.cashCurrencyId = cashLocationSelect.dataset.currencyId;
                }
            }
            
            if (categoryTag === 'payable' || categoryTag === 'receivable') {
                const counterpartySelect = document.getElementById('counterpartySelect');
                if (counterpartySelect && counterpartySelect.dataset.counterpartyId) {
                    line.counterpartyId = counterpartySelect.dataset.counterpartyId;
                    line.counterpartyName = counterpartySelect.dataset.counterpartyName;
                    line.linkedCompanyId = counterpartySelect.dataset.linkedCompanyId || null;
                    line.isInternalCounterparty = counterpartySelect.dataset.isInternal === 'true';
                    
                    // Add counterparty store if selected
                    const counterpartyStoreSelect = document.getElementById('counterpartyStoreSelect');
                    if (counterpartyStoreSelect && counterpartyStoreSelect.dataset.storeId) {
                        line.counterpartyStoreId = counterpartyStoreSelect.dataset.storeId;
                        line.counterpartyStoreName = counterpartyStoreSelect.dataset.storeName;
                    }
                    
                    // Add counterparty store cash location if selected
                    const counterpartyStoreCashLocationSelect = document.getElementById('counterpartyStoreCashLocationSelect');
                    if (counterpartyStoreCashLocationSelect && counterpartyStoreCashLocationSelect.dataset.cashLocationId) {
                        line.counterpartyStoreCashLocationId = counterpartyStoreCashLocationSelect.dataset.cashLocationId;
                        line.counterpartyStoreCashLocationName = counterpartyStoreCashLocationSelect.dataset.locationName;
                        line.counterpartyStoreCashLocationType = counterpartyStoreCashLocationSelect.dataset.locationType;
                        line.counterpartyStoreCashCurrencyId = counterpartyStoreCashLocationSelect.dataset.currencyId;
                    }
                }
                
                const debtCategory = document.getElementById('debtCategory');
                const interestRate = document.getElementById('interestRate');
                if (debtCategory) line.debtCategory = debtCategory.value || null;
                if (interestRate) line.interestRate = parseFloat(interestRate.value) || 0;
            }
            
            // Log the complete transaction data being stored
            console.log('Saving transaction with data:', {
                accountId: line.accountId,
                accountName: line.accountName,
                categoryTag: line.categoryTag,
                amount: line.amount,
                isDebit: line.isDebit,
                counterpartyId: line.counterpartyId,
                counterpartyName: line.counterpartyName,
                isInternalCounterparty: line.isInternalCounterparty,
                counterpartyStoreId: line.counterpartyStoreId,
                counterpartyStoreName: line.counterpartyStoreName,
                counterpartyStoreCashLocationId: line.counterpartyStoreCashLocationId,
                counterpartyStoreCashLocationName: line.counterpartyStoreCashLocationName,
                linkedCompanyId: line.linkedCompanyId,
                cashLocationId: line.cashLocationId,
                debtCategory: line.debtCategory,
                interestRate: line.interestRate
            });
            
            // Add or update transaction
            if (currentEditIndex >= 0) {
                journalEntry.updateTransactionLine(currentEditIndex, line);
            } else {
                journalEntry.addTransactionLine(line);
            }
            
            // If the transaction line has a counterparty cash location, set it on the journal (matching Flutter app)
            if (line.counterpartyStoreCashLocationId) {
                journalEntry.counterpartyCashLocationId = line.counterpartyStoreCashLocationId;
                console.log('Set journal-level counterparty cash location:', journalEntry.counterpartyCashLocationId);
            }
            
            // Close modal
            closeTransactionModal();
        }

        // Submit journal entry
        async function submitJournalEntry() {
            if (!journalEntry.canSubmit()) {
                showAlert('Journal entry cannot be submitted. Please ensure transactions are balanced.', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            const submitSpinner = document.getElementById('submitSpinner');
            const submitBtnText = document.getElementById('submitBtnText');
            
            // Check if elements exist before using them
            if (!submitBtn) {
                console.error('Submit button not found');
                showAlert('Error: Submit button not found', 'error');
                return;
            }
            
            // Show loading state
            submitBtn.disabled = true;
            if (submitSpinner) {
                submitSpinner.style.display = 'inline-block';
            }
            if (submitBtnText) {
                submitBtnText.textContent = 'Submitting...';
            }
            
            try {
                // Get Supabase client
                let client = window.supabaseClient;
                if (!client && window.supabase && window.supabase.createClient) {
                    const SUPABASE_URL = window.ENV?.SUPABASE_URL || '';
                    const SUPABASE_ANON_KEY = window.ENV?.SUPABASE_ANON_KEY || '';
                    
                    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
                        console.error('Supabase credentials not configured');
                        throw new Error('Configuration error');
                    }
                    
                    client = window.supabase.createClient(
                        SUPABASE_URL, 
                        SUPABASE_ANON_KEY
                    );
                }
                if (!client) throw new Error('Supabase client not available');
                
                // Get current user
                const { data: { user }, error: userError } = await client.auth.getUser();
                if (userError) throw userError;
                if (!user) throw new Error('User not authenticated');
                
                // Prepare journal entry data
                // Use device's current time - matching Flutter app format exactly
                const currentTime = new Date();
                
                // Format as YYYY-MM-DD HH:MM:SS.SSS matching Flutter DateFormat
                const formatDateTimeForRPC = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const seconds = String(date.getSeconds()).padStart(2, '0');
                    const milliseconds = String(date.getMilliseconds()).padStart(3, '0');
                    return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}.${milliseconds}`;
                };
                
                const entryDate = formatDateTimeForRPC(currentTime);
                
                console.log('Current device time:', currentTime);
                console.log('Formatted entry date (matching Flutter):', entryDate);
                
                const pLines = journalEntry.transactionLines.map(line => line.toJson());
                
                // Log the complete data being sent
                console.log('Submitting journal entry with lines:', pLines);
                
                // Determine main counterparty (if any) - matching Flutter app logic
                let mainCounterpartyId = null;
                for (const line of journalEntry.transactionLines) {
                    if (line.counterpartyId && line.counterpartyId.length > 0) {
                        mainCounterpartyId = line.counterpartyId;
                        break;
                    }
                }
                
                // Get counterparty cash location - matching Flutter app logic
                // The app sets this at journal level, not checking if internal
                let counterpartyStoreCashLocationId = null;
                
                // Check if it's set at journal level (like the app does)
                if (journalEntry.counterpartyCashLocationId) {
                    counterpartyStoreCashLocationId = journalEntry.counterpartyCashLocationId;
                    console.log('Using journal-level counterparty cash location:', counterpartyStoreCashLocationId);
                } else {
                    // Check transaction lines for counterparty cash location
                    for (const line of journalEntry.transactionLines) {
                        if (line.counterpartyStoreCashLocationId) {
                            counterpartyStoreCashLocationId = line.counterpartyStoreCashLocationId;
                            console.log('Using counterparty cash location from transaction line:', counterpartyStoreCashLocationId);
                            break;
                        }
                    }
                }
                
                console.log('Counterparty data:', {
                    mainCounterpartyId,
                    counterpartyStoreCashLocationId
                });
                
                // Get company and store IDs - matching Flutter app logic exactly
                const companyId = appState.getSelectedCompanyId();
                const storeId = appState.getSelectedStoreId();  // This matches Flutter's appState.storeChoosen
                
                // Use company from appState if available, otherwise use journalEntry
                const finalCompanyId = companyId || journalEntry.selectedCompanyId;
                
                // Use store from appState if available (send null if empty string, matching Flutter)
                const finalStoreId = storeId || null;
                
                console.log('Company and Store:', {
                    companyId: finalCompanyId,
                    storeId: finalStoreId
                });
                
                // Build RPC parameters - matching Flutter app exactly
                const rpcParams = {
                    p_base_amount: journalEntry.totalDebits,
                    p_company_id: finalCompanyId,
                    p_created_by: user.id,
                    p_description: journalEntry.overallDescription,
                    p_entry_date: entryDate,
                    p_lines: pLines,
                    p_counterparty_id: mainCounterpartyId,  // Can be null
                    p_if_cash_location_id: counterpartyStoreCashLocationId,  // Can be null
                    p_store_id: finalStoreId  // Can be null
                };
                
                console.log('Final RPC parameters:', JSON.stringify(rpcParams, null, 2));
                
                const { data, error } = await client.rpc('insert_journal_with_everything', rpcParams);
                
                if (error) throw error;
                
                // Show success message
                showAlert('Journal entry created successfully!', 'success');
                
                // Clear the form
                journalEntry.clear();
                document.getElementById('journalDescription').value = '';
                
            } catch (error) {
                console.error('Error submitting journal entry:', error);
                showAlert('Error creating journal entry: ' + error.message, 'error');
            } finally {
                // Reset button state
                if (submitBtn) {
                    submitBtn.disabled = false;
                }
                if (submitSpinner) {
                    submitSpinner.style.display = 'none';
                }
                if (submitBtnText) {
                    submitBtnText.textContent = 'Submit Journal Entry';
                }
                updateSubmitButton();
            }
        }

        // Show alert with centered modal
        function showAlert(message, type = 'info') {
            console.log(`${type.toUpperCase()}: ${message}`);
            
            // Remove any existing alert
            const existingAlert = document.querySelector('.custom-alert-overlay');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // Create alert overlay
            const overlay = document.createElement('div');
            overlay.className = 'custom-alert-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                animation: fadeIn 0.2s ease-in-out;
            `;
            
            // Create alert container
            const alertBox = document.createElement('div');
            alertBox.className = 'custom-alert-box';
            
            // Set colors based on type
            let bgColor = '#FFFFFF';
            let borderColor = '#E9ECEF';
            let titleColor = '#212529';
            
            if (type === 'success') {
                borderColor = '#00C896';
                titleColor = '#00C896';
            } else if (type === 'error') {
                borderColor = '#FF5847';
                titleColor = '#FF5847';
            } else if (type === 'warning') {
                borderColor = '#0064FF';  // Use Toss blue for warning/notice
                titleColor = '#0064FF';
            } else {
                borderColor = '#0064FF';
                titleColor = '#0064FF';
            }
            
            alertBox.style.cssText = `
                background: ${bgColor};
                border: 2px solid ${borderColor};
                border-radius: 16px;
                padding: 24px;
                max-width: 480px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
                animation: slideIn 0.3s ease-out;
            `;
            
            alertBox.innerHTML = `
                <div style="display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 16px;">
                    <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: ${titleColor};">
                        ${type === 'success' ? 'Success' : type === 'error' ? 'Error' : type === 'warning' ? 'Notice' : 'Notice'}
                    </h3>
                </div>
                <p style="margin: 0 0 20px 0; font-size: 15px; color: #495057; line-height: 1.5;">
                    ${message}
                </p>
                <button onclick="this.closest('.custom-alert-overlay').remove()" style="
                    background: ${titleColor};
                    color: white;
                    border: none;
                    padding: 10px 20px;
                    border-radius: 8px;
                    font-size: 14px;
                    font-weight: 600;
                    cursor: pointer;
                    width: 100%;
                    transition: opacity 0.2s;
                " onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                    í™•ì¸
                </button>
            `;
            
            overlay.appendChild(alertBox);
            document.body.appendChild(overlay);
            
            // Add animations
            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes slideIn {
                    from { transform: translateY(-20px); opacity: 0; }
                    to { transform: translateY(0); opacity: 1; }
                }
            `;
            if (!document.querySelector('#alertAnimations')) {
                style.id = 'alertAnimations';
                document.head.appendChild(style);
            }
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.remove();
                }
            });
        }

        // Store filter functions
        function setupStoreFilter() {
            const storeFilterControl = document.getElementById('storeFilterControl');
            
            if (storeFilterControl) {
                storeFilterControl.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    await toggleStoreFilterDropdown();
                });
                
                // Keyboard support
                storeFilterControl.addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        e.stopPropagation();
                        await toggleStoreFilterDropdown();
                    }
                });
                
                storeFilterControl.setAttribute('tabindex', '0');
                storeFilterControl.setAttribute('role', 'button');
                storeFilterControl.setAttribute('aria-label', 'Select store filter');
            }
            
            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.control-section') && !e.target.closest('.store-filter-dropdown')) {
                    hideStoreFilterDropdown();
                }
            });
        }
        
        async function toggleStoreFilterDropdown() {
            const dropdown = document.getElementById('storeFilterDropdown');
            
            if (!dropdown) {
                console.error('Dropdown element not found');
                return;
            }
            
            if (dropdown.classList.contains('active')) {
                hideStoreFilterDropdown();
            } else {
                await showStoreFilterDropdown();
            }
        }
        
        async function showStoreFilterDropdown() {
            const storeFilterDropdown = document.getElementById('storeFilterDropdown');
            const storeFilterControl = document.getElementById('storeFilterControl');
            const storeFilterOptions = document.getElementById('storeFilterOptions');
            
            if (!storeFilterDropdown || !storeFilterControl || !storeFilterOptions) {
                console.error('Store filter dropdown elements not found');
                return;
            }
            
            if (typeof appState === 'undefined') {
                console.error('appState is not defined');
                return;
            }
            
            // Get stores from app state
            const companyId = appState.getSelectedCompanyId();
            console.log('Building store dropdown for company:', companyId);
            let stores = [];
            
            // Try to get fresh data from navbar instance first
            if (window.navbarInstance && window.navbarInstance.companySelector) {
                try {
                    const selectedOption = window.navbarInstance.companySelector.getSelectedOption();
                    if (selectedOption && selectedOption.data) {
                        stores = selectedOption.data.stores || [];
                        console.log('Got fresh stores from navbar selector:', stores);
                    }
                } catch (navbarError) {
                    console.log('Could not get from navbar:', navbarError);
                }
            }
            
            // If navbar didn't work, try getting from fresh user data
            if (stores.length === 0) {
                try {
                    const userData = localStorage.getItem('user');
                    if (userData) {
                        const parsedData = JSON.parse(userData);
                        const company = parsedData.companies?.find(c => c.company_id === companyId);
                        if (company) {
                            stores = company.stores || [];
                            console.log('Got stores from fresh user data:', stores);
                        }
                    }
                } catch (error) {
                    console.error('Error getting fresh user data:', error);
                }
            }
            
            // Final fallback to appState
            if (stores.length === 0) {
                try {
                    stores = appState.getCompanyStores();
                    console.log('Got stores from appState (fallback):', stores);
                } catch (fallbackError) {
                    console.error('All methods failed:', fallbackError);
                    stores = [];
                }
            }
            
            // If no store is selected yet, select the first one
            if (!currentStoreFilter && stores.length > 0) {
                currentStoreFilter = stores[0].store_id;
                journalEntry.selectedStoreId = currentStoreFilter;
                updateStoreFilterDisplay();
            }
            
            // Build store options HTML
            let optionsHTML = `
                <input 
                    type="text" 
                    placeholder="Search stores..." 
                    class="store-filter-search" 
                    id="storeFilterSearch" 
                    autocomplete="off"
                >
                <div class="store-filter-divider"></div>
            `;
            
            // Add individual store options (no "All Stores" option)
            stores.forEach((store, index) => {
                // Select first store if nothing is selected, or the matching store
                const isSelected = store.store_id === currentStoreFilter || (!currentStoreFilter && index === 0);
                optionsHTML += `
                    <div class="store-filter-dropdown-option${isSelected ? ' selected' : ''}" data-store-filter="${store.store_id}">
                        <svg class="store-filter-dropdown-option-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75Z"/>
                        </svg>
                        <span class="store-filter-dropdown-option-text">${store.store_name}</span>
                        ${isSelected ? '<svg class="store-filter-dropdown-option-check" fill="currentColor" viewBox="0 0 24 24"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg>' : ''}
                    </div>
                `;
            });
            
            if (stores.length === 0) {
                optionsHTML += `
                    <div class="store-filter-dropdown-option" style="opacity: 0.6; pointer-events: none;">
                        <svg class="store-filter-dropdown-option-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,6A1.5,1.5 0 0,1 13.5,7.5A1.5,1.5 0 0,1 12,9A1.5,1.5 0 0,1 10.5,7.5A1.5,1.5 0 0,1 12,6M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,10C13.25,10 15.29,10.54 16.19,12.38C16.66,13.27 16.65,14.35 16.15,15.23C15.5,16.37 14.45,17 13.25,17H10.75C9.55,17 8.5,16.37 7.85,15.23C7.35,14.35 7.34,13.27 7.81,12.38C8.71,10.54 10.75,10 12,10Z"/>
                        </svg>
                        <span class="store-filter-dropdown-option-text">No stores available</span>
                    </div>
                `;
            }
            
            storeFilterOptions.innerHTML = optionsHTML;
            
            // Setup search functionality
            const searchInput = document.getElementById('storeFilterSearch');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const options = storeFilterOptions.querySelectorAll('.store-filter-dropdown-option');
                    
                    options.forEach(option => {
                        const text = option.querySelector('.store-filter-dropdown-option-text');
                        if (text) {
                            const storeName = text.textContent.toLowerCase();
                            if (storeName.includes(searchTerm)) {
                                option.style.display = 'flex';
                            } else {
                                option.style.display = 'none';
                            }
                        }
                    });
                });
            }
            
            // Setup option click handlers
            storeFilterOptions.querySelectorAll('.store-filter-dropdown-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const storeFilter = option.dataset.storeFilter;
                    
                    // Always set to the selected store (no null option)
                    if (storeFilter) {
                        currentStoreFilter = storeFilter;
                        journalEntry.selectedStoreId = storeFilter;
                        // Store is selected and saved to currentStoreFilter
                    }
                    
                    updateStoreFilterDisplay();
                    hideStoreFilterDropdown();
                });
            });
            
            storeFilterDropdown.classList.add('active');
            storeFilterControl.classList.add('dropdown-open');
            
            // Focus search input
            setTimeout(() => {
                const searchInput = document.getElementById('storeFilterSearch');
                if (searchInput) {
                    searchInput.focus();
                }
            }, 100);
        }
        
        function hideStoreFilterDropdown() {
            const storeFilterDropdown = document.getElementById('storeFilterDropdown');
            const storeFilterControl = document.getElementById('storeFilterControl');
            
            if (storeFilterDropdown) storeFilterDropdown.classList.remove('active');
            if (storeFilterControl) storeFilterControl.classList.remove('dropdown-open');
        }
        
        function updateStoreFilterDisplay() {
            const label = document.getElementById('storeFilterLabel');
            const companyId = appState.getSelectedCompanyId();
            let store = null;
            let stores = [];
            
            // Get stores from appState or companies
            try {
                stores = appState.getCompanyStores() || [];
            } catch (error) {
                console.error('Error getting store data:', error);
                try {
                    const companies = appState.getUserCompanies();
                    const company = companies.find(c => c.company_id === companyId);
                    stores = company?.stores || [];
                } catch (fallbackError) {
                    console.error('Fallback store lookup failed:', fallbackError);
                    stores = [];
                }
            }
            
            // If currentStoreFilter is set, try to find the matching store
            if (currentStoreFilter) {
                store = stores.find(s => s.store_id === currentStoreFilter);
                
                // If we have currentStoreFilter but can't find the store in the array,
                // it might be because the stores array isn't complete. 
                // Try to get the store name from the dropdown if it exists
                if (!store) {
                    // Look for the selected option in the dropdown to get the store name
                    const selectedOption = document.querySelector(`.store-filter-dropdown-option[data-store-filter="${currentStoreFilter}"]`);
                    if (selectedOption) {
                        const storeName = selectedOption.querySelector('.store-filter-dropdown-option-text')?.textContent;
                        if (storeName) {
                            // Create a temporary store object to use
                            store = {
                                store_id: currentStoreFilter,
                                store_name: storeName
                            };
                        }
                    }
                }
            }
            
            // If still no store selected, use the first one
            if (!store && stores.length > 0) {
                currentStoreFilter = stores[0].store_id;
                journalEntry.selectedStoreId = currentStoreFilter;
                appState.setSelectedStore(currentStoreFilter);
                store = stores[0];
            }
            
            // Update label with store name
            if (store) {
                label.textContent = store.store_name;
                
                // Also update the store name in the header
                const storeName = document.getElementById('storeName');
                if (storeName) {
                    storeName.textContent = ` â€¢ ${store.store_name}`;
                    storeName.style.display = 'inline';
                }
            } else if (stores.length === 0) {
                label.textContent = 'No stores available';
                const storeName = document.getElementById('storeName');
                if (storeName) {
                    storeName.style.display = 'none';
                }
            } else {
                // If stores exist but none selected (shouldn't happen after auto-selection)
                // Try to select the first store again
                if (stores.length > 0) {
                    currentStoreFilter = stores[0].store_id;
                    journalEntry.selectedStoreId = currentStoreFilter;
                    appState.setSelectedStore(currentStoreFilter);
                    label.textContent = stores[0].store_name;
                    
                    const storeName = document.getElementById('storeName');
                    if (storeName) {
                        storeName.textContent = ` â€¢ ${stores[0].store_name}`;
                        storeName.style.display = 'inline';
                    }
                    
                } else {
                    label.textContent = 'Select Store';
                }
            }
        }
        
        // Refresh store filter when company changes
        function refreshStoreFilter() {
            
            // Close any open dropdown
            const storeFilterControl = document.getElementById('storeFilterControl');
            const storeFilterDropdown = document.getElementById('storeFilterDropdown');
            const storeFilterOptions = document.getElementById('storeFilterOptions');
            
            if (storeFilterControl) {
                storeFilterControl.classList.remove('dropdown-open');
            }
            if (storeFilterDropdown) {
                storeFilterDropdown.classList.remove('show');
                storeFilterDropdown.classList.remove('active');
            }
            
            // Clear the dropdown options to force rebuild on next open
            if (storeFilterOptions) {
                storeFilterOptions.innerHTML = '';
            }
            
            // Get the stores for the current company
            const stores = appState.getCompanyStores() || [];
            
            // Reset filter and select first store if available
            if (stores.length > 0) {
                currentStoreFilter = stores[0].store_id;
                journalEntry.selectedStoreId = currentStoreFilter;
                appState.setSelectedStore(currentStoreFilter);
            } else {
                currentStoreFilter = null;
                journalEntry.selectedStoreId = null;
            }
            
            // Update display which will show the selected store
            updateStoreFilterDisplay();
        }

        // Show modal
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        // Hide modal
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }
    </script>
</body>
</html>