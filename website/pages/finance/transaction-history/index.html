<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance - Transaction History</title>
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="../../../core/themes/toss-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-component-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-base.css">
    <link rel="stylesheet" href="../../../core/themes/toss-typography.css">
    
    <!-- Component CSS -->
    <link rel="stylesheet" href="../../../components/base/toss-button.css">
    <link rel="stylesheet" href="../../../components/form/toss-input.css">
    <link rel="stylesheet" href="../../../components/form/toss-select.css">
    <link rel="stylesheet" href="../../../components/form/toss-filter.css">
    <link rel="stylesheet" href="../../../components/feedback/toss-alert.css">
    <link rel="stylesheet" href="../../../components/navigation/navbar.css">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Page Specific Styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background: var(--toss-gray-50);
            min-height: 100vh;
        }
        
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .page-content {
            flex: 1;
            padding: var(--space-6);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        .page-header {
            margin-bottom: var(--space-8);
        }
        
        .page-title {
            font-size: var(--font-h1);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .page-subtitle {
            font-size: var(--font-large);
            color: var(--text-secondary);
            margin: 0;
        }
        
        .content-card {
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
        }
        
        .coming-soon {
            text-align: center;
            padding: var(--space-16) var(--space-6);
        }
        
        .coming-soon-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto var(--space-6);
            background: var(--toss-primary-surface);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--toss-primary);
        }
        
        .coming-soon-title {
            font-size: var(--font-h2);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 var(--space-3) 0;
        }
        
        .coming-soon-text {
            font-size: var(--font-large);
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Transaction Table Styles */
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--space-6);
        }
        
        .transaction-table thead {
            background: var(--toss-gray-50);
            border-bottom: 2px solid var(--toss-gray-200);
        }
        
        .transaction-table th {
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-size: var(--font-small);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .transaction-table th:last-child {
            text-align: right;
        }
        
        .transaction-table tbody tr {
            border-bottom: 1px solid var(--toss-gray-100);
            transition: background-color 0.2s;
        }
        
        .transaction-table tbody tr:hover {
            background: var(--toss-gray-50);
        }
        
        .transaction-table td {
            padding: var(--space-4) var(--space-4);
            font-size: var(--font-body);
            color: var(--text-primary);
        }
        
        .transaction-table td.text-right {
            text-align: right;
        }
        
        .transaction-date {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .transaction-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--font-small);
            font-weight: 500;
            background: var(--toss-primary-surface);
            color: var(--toss-primary);
        }
        
        
        .transaction-store {
            display: inline-block;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: var(--font-small);
            font-weight: 500;
            background: var(--toss-primary-surface);
            color: var(--toss-primary);
        }
        
        .transaction-table {
            width: 100%;
            border-collapse: collapse;
            background: var(--toss-white);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            margin-bottom: var(--space-6);
        }
        
        .transaction-table th {
            background: var(--toss-gray-50);
            padding: var(--space-3) var(--space-4);
            text-align: left;
            font-size: var(--font-small);
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid var(--toss-gray-200);
        }
        
        .transaction-table th:nth-child(5),
        .transaction-table th:nth-child(6) {
            text-align: right;
        }
        
        .transaction-table td {
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--toss-gray-100);
            font-size: var(--font-body);
            color: var(--text-primary);
            vertical-align: top;
        }
        
        .transaction-journal-header {
            background: var(--toss-primary-surface) !important;
            color: var(--toss-primary) !important;
            font-weight: 600;
            border-bottom: 2px solid var(--toss-primary) !important;
        }
        
        .transaction-journal-header td {
            padding: var(--space-4) var(--space-4);
            font-weight: 600;
            color: var(--toss-primary);
            background: var(--toss-primary-surface);
        }
        
        .transaction-line-row {
            background: var(--toss-white);
            border-left: 3px solid var(--toss-primary-surface);
        }
        
        .transaction-line-row.alternate {
            background: #fafafa;
            border-left: 3px solid var(--toss-primary-surface);
        }
        
        .transaction-line-row:hover {
            background: var(--toss-gray-100) !important;
            border-left: 3px solid var(--toss-primary) !important;
        }
        
        .transaction-line-row td {
            font-size: var(--font-small);
        }
        
        .transaction-line-row .account-name {
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .transaction-line-row .line-description {
            color: var(--text-secondary);
        }
        
        .transaction-total-row {
            background: var(--toss-gray-50) !important;
            font-weight: 600;
            border-top: 2px solid var(--toss-gray-200) !important;
        }
        
        .transaction-total-row td {
            font-weight: 600;
            background: var(--toss-gray-50);
        }
        
        .account-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .line-description {
            color: var(--text-secondary);
            font-size: var(--font-small);
        }
        
        .counterparty-name {
            color: var(--text-secondary);
            font-size: var(--font-small);
        }
        
        
        .journal-date {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .journal-time {
            font-size: var(--font-small);
            color: var(--text-secondary);
        }
        
        .transaction-amount {
            font-family: var(--font-family-mono);
            font-weight: 600;
        }
        
        .transaction-amount.debit {
            color: var(--toss-error);
        }
        
        .transaction-amount.credit {
            color: var(--toss-success);
        }
        
        .loading-state, .error-state, .empty-state {
            text-align: center;
            padding: var(--space-16) var(--space-6);
        }
        
        .state-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--space-4);
            background: var(--toss-gray-100);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        
        .state-title {
            font-size: var(--font-h3);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .state-text {
            font-size: var(--font-body);
            color: var(--text-secondary);
            margin: 0;
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Navigation Bar -->
        <div id="navbar-container"></div>
        
        <!-- Page Content -->
        <main class="page-content">
            <div class="page-header">
                <h1 class="page-title">Transaction History</h1>
                <p class="page-subtitle">View all transactions</p>
            </div>
            
            <!-- Filter Section -->
            <div id="filter-container"></div>
            
            <!-- Transaction Table -->
            <div class="content-card" id="transaction-content">
                <div class="loading-state" id="loading-state">
                    <div class="state-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4m0 12v4m10-10h-4M6 12H2"/>
                        </svg>
                    </div>
                    <h3 class="state-title">Loading Transactions...</h3>
                    <p class="state-text">Please wait while we fetch your transaction history.</p>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Component JavaScript -->
    <script src="../../../components/base/toss-button.js"></script>
    <script src="../../../components/form/toss-input.js"></script>
    <script src="../../../components/form/toss-select.js"></script>
    <script src="../../../components/form/toss-filter.js"></script>
    <script src="../../../components/navigation/navbar.js"></script>
    <script src="../../../components/feedback/toss-alert.js"></script>
    
    <!-- Core Scripts -->
    <script src="../../../core/constants/app-icons.js"></script>
    <script src="../../../core/config/supabase.js"></script>
    
    <!-- App State Management -->
    <script src="../../../core/utils/app-state.js"></script>
    
    <!-- Route Mapping -->
    <script src="../../../core/config/route-mapping.js"></script>
    
    <!-- Page Initialization Utility -->
    <script src="../../../core/utils/page-init.js"></script>
    
    <script>
        // Set flag immediately to prevent navbar auto-init
        window.skipNavbarAutoInit = true;
        
        let transactionFilter = null;
        
        // Initialize page using standardized pattern
        window.initializePage('finance', (companyId, company) => {
            console.log('Company changed in transaction history:', companyId);
            initializeFilter(companyId);
            // Don't load data automatically - wait for Search button
            showInitialState();
        });
        
        // Additional page initialization after navbar is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for page initialization to complete, then initialize page-specific content
            setTimeout(() => {
                const companyId = appState.getSelectedCompanyId();
                if (companyId) {
                    initializeFilter(companyId);
                    // Don't load data automatically - wait for Search button
                    showInitialState();
                }
            }, 100);
        });
        
        // Initialize filter component
        function initializeFilter(companyId) {
            if (!transactionFilter) {
                transactionFilter = new TossFilter({
                    container: '#filter-container',
                    title: 'Search Transactions',
                    showStoreFilter: true,
                    showDateFilters: true,
                    storeLabel: 'Store',
                    fromDateLabel: 'From Date',
                    toDateLabel: 'To Date',
                    searchButtonText: 'Search',
                    clearButtonText: 'Clear All',
                    defaultExpanded: true,
                    onSearch: (filters) => {
                        console.log('Searching with filters:', filters);
                        const selectedCompanyId = appState.getSelectedCompanyId();
                        if (selectedCompanyId) {
                            loadTransactionHistoryData(selectedCompanyId, filters);
                        } else {
                            showErrorState('Please select a company first');
                        }
                    },
                    onClear: () => {
                        console.log('Filters cleared');
                        // Reset to initial state when cleared
                        showInitialState();
                    }
                });
            }
        }
        
        // Load transaction history data for company
        async function loadTransactionHistoryData(companyId, filters = {}) {
            console.log('Loading transaction history for company:', companyId, 'with filters:', filters);
            
            try {
                // Show loading state
                showLoadingState();
                
                // Get the selected company ID from session storage
                const sessionCompanyId = appState.getSelectedCompanyId();
                if (!sessionCompanyId) {
                    showErrorState('No company selected. Please select a company first.');
                    return;
                }
                
                // Prepare RPC parameters
                const params = {
                    p_company_id: sessionCompanyId,  // Use company ID from session
                    p_store_id: (filters.store === 'null' || filters.store === null || !filters.store) ? null : filters.store,
                    p_date_from: filters.fromDate || null,
                    p_date_to: filters.toDate || null,
                    p_limit: 100,
                    p_offset: 0
                };
                
                console.log('Calling get_transaction_history RPC with params:', params);
                
                // Call the RPC
                const { data, error } = await supabase.rpc('get_transaction_history', params);
                
                if (error) {
                    console.error('Error calling get_transaction_history:', error);
                    showErrorState(error.message);
                    return;
                }
                
                console.log('Transaction history data received:', data);
                
                // Parse the response
                let transactions = [];
                if (data) {
                    if (Array.isArray(data)) {
                        transactions = data;
                    } else if (data.entries && Array.isArray(data.entries)) {
                        transactions = data.entries;
                    } else if (data.data && Array.isArray(data.data)) {
                        transactions = data.data;
                    }
                }
                
                // Sort transactions by created_at in descending order (most recent first)
                // This ensures the transactions are displayed with the newest ones at the top
                transactions.sort((a, b) => {
                    const dateA = new Date(a.created_at || a.entry_date || 0);
                    const dateB = new Date(b.created_at || b.entry_date || 0);
                    return dateB.getTime() - dateA.getTime(); // Descending order (newest first)
                });
                
                console.log('Transactions sorted by created_at (descending):', 
                    transactions.slice(0, 3).map(t => ({ 
                        description: t.description, 
                        created_at: t.created_at,
                        entry_date: t.entry_date
                    }))
                );
                
                // Display the transaction data
                if (transactions.length > 0) {
                    displayTransactions(transactions);
                } else {
                    showEmptyState('No transactions found for the selected period');
                }
                
            } catch (error) {
                console.error('Error loading transaction history:', error);
                showErrorState('Failed to load transaction history');
            }
        }
        
        // Display transactions with perfect column alignment using table structure
        function displayTransactions(transactions) {
            const contentCard = document.querySelector('#transaction-content');
            if (!contentCard) return;
            
            let html = `
                <h3 style="margin: 0 0 var(--space-4) 0; font-size: var(--font-h3); font-weight: 600; color: var(--text-primary);">Transaction History</h3>
                <p style="margin: 0 0 var(--space-6) 0; font-size: var(--font-body); color: var(--text-secondary);">
                    Found ${transactions.length} journal${transactions.length !== 1 ? 's' : ''}
                </p>
                
                <table class="transaction-table">
                    <thead>
                        <tr>
                            <th style="width: 160px;">DATE & TIME</th>
                            <th style="width: 200px;">DESCRIPTION</th>
                            <th style="width: 120px;">STORE</th>
                            <th style="width: 120px;">CREATED BY</th>
                            <th style="width: 120px;">DEBIT</th>
                            <th style="width: 120px;">CREDIT</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            transactions.forEach((transaction, transactionIndex) => {
                const entryDate = new Date(transaction.entry_date);
                const createdAt = new Date(transaction.created_at);
                const dateStr = entryDate.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                const timeStr = createdAt.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // Journal header row
                html += `
                    <tr class="transaction-journal-header">
                        <td>
                            <div class="journal-date">${dateStr}</div>
                            <div class="journal-time">${timeStr}</div>
                        </td>
                        <td>${transaction.description || '-'}</td>
                        <td>
                            ${transaction.store_name ? `<span class="transaction-store">${transaction.store_name}</span>` : 'All Stores'}
                        </td>
                        <td>${transaction.created_by_name || 'System'}</td>
                        <td style="text-align: right; font-weight: 600; color: var(--toss-error);">
                            ${transaction.currency_symbol || '$'}${formatNumber(transaction.total_debit || 0)}
                        </td>
                        <td style="text-align: right; font-weight: 600; color: var(--toss-success);">
                            ${transaction.currency_symbol || '$'}${formatNumber(transaction.total_credit || 0)}
                        </td>
                    </tr>
                `;
                
                // Transaction lines
                if (transaction.lines && Array.isArray(transaction.lines)) {
                    // Sort lines: debits first, then credits
                    const sortedLines = [...transaction.lines].sort((a, b) => {
                        if (a.is_debit && !b.is_debit) return -1;
                        if (!a.is_debit && b.is_debit) return 1;
                        return 0;
                    });
                    
                    sortedLines.forEach((line, lineIndex) => {
                        const counterpartyName = line.counterparty ? line.counterparty.name : (line.display_counterparty || '-');
                        const locationName = line.cash_location ? line.cash_location.name : (line.display_location || '-');
                        const alternateClass = lineIndex % 2 === 1 ? ' alternate' : '';
                        
                        // Create a description that includes counterparty and location if available
                        let fullDescription = line.description || '-';
                        if (counterpartyName !== '-' && locationName !== '-') {
                            fullDescription = `${line.description || line.account_name} • ${counterpartyName} • ${locationName}`;
                        } else if (counterpartyName !== '-') {
                            fullDescription = `${line.description || line.account_name} • ${counterpartyName}`;
                        } else if (locationName !== '-') {
                            fullDescription = `${line.description || line.account_name} • ${locationName}`;
                        }
                        
                        html += `
                            <tr class="transaction-line-row${alternateClass}">
                                <td style="padding-left: var(--space-6);"><strong class="account-name">${line.account_name || '-'}</strong></td>
                                <td class="line-description">${fullDescription}</td>
                                <td>-</td>
                                <td>-</td>
                                <td style="text-align: right;" class="transaction-amount debit">
                                    ${line.debit > 0 ? formatNumber(line.debit) : '-'}
                                </td>
                                <td style="text-align: right;" class="transaction-amount credit">
                                    ${line.credit > 0 ? formatNumber(line.credit) : '-'}
                                </td>
                            </tr>
                        `;
                    });
                }
                
                // Total row for this journal entry
                html += `
                    <tr class="transaction-total-row">
                        <td colspan="4" style="text-align: right; font-weight: 600; padding-right: var(--space-4);">Total:</td>
                        <td style="text-align: right;" class="transaction-amount debit">
                            ${transaction.total_debit > 0 ? formatNumber(transaction.total_debit) : '-'}
                        </td>
                        <td style="text-align: right;" class="transaction-amount credit">
                            ${transaction.total_credit > 0 ? formatNumber(transaction.total_credit) : '-'}
                        </td>
                    </tr>
                `;
                
                // Add spacing between journal entries (except for the last one)
                if (transactionIndex < transactions.length - 1) {
                    html += `
                        <tr style="height: 20px;">
                            <td colspan="6" style="background: var(--toss-gray-50); border: none; padding: 0;"></td>
                        </tr>
                    `;
                }
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            contentCard.innerHTML = html;
        }
        
        // Format number with commas
        function formatNumber(num) {
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(num);
        }
        
        // Show loading state
        function showLoadingState() {
            const contentCard = document.querySelector('#transaction-content');
            if (!contentCard) return;
            
            contentCard.innerHTML = `
                <div class="loading-state">
                    <div class="state-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v4m0 12v4m10-10h-4M6 12H2"/>
                        </svg>
                    </div>
                    <h3 class="state-title">Loading Transactions...</h3>
                    <p class="state-text">Please wait while we fetch your transaction history.</p>
                </div>
            `;
        }
        
        // Show error state
        function showErrorState(message) {
            const contentCard = document.querySelector('#transaction-content');
            if (!contentCard) return;
            
            contentCard.innerHTML = `
                <div class="error-state">
                    <div class="state-icon" style="background: var(--toss-error-surface); color: var(--toss-error);">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                    </div>
                    <h3 class="state-title">Error Loading Transactions</h3>
                    <p class="state-text">${message}</p>
                </div>
            `;
        }
        
        // Show empty state
        function showEmptyState(message) {
            const contentCard = document.querySelector('#transaction-content');
            if (!contentCard) return;
            
            contentCard.innerHTML = `
                <div class="empty-state">
                    <div class="state-icon">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 11H15M21 11C21 16.5228 16.5228 21 11 21C5.47715 21 1 16.5228 1 11C1 5.47715 5.47715 1 11 1C16.5228 1 21 5.47715 21 11Z"/>
                        </svg>
                    </div>
                    <h3 class="state-title">No Transactions Found</h3>
                    <p class="state-text">${message}</p>
                </div>
            `;
        }
        
        // Show initial state (before search)
        function showInitialState() {
            const contentCard = document.querySelector('#transaction-content');
            if (!contentCard) return;
            
            contentCard.innerHTML = `
                <div class="empty-state">
                    <div class="state-icon" style="background: var(--toss-primary-surface); color: var(--toss-primary);">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                    </div>
                    <h3 class="state-title">Search Transactions</h3>
                    <p class="state-text">Select filters and click Search to view transaction history</p>
                </div>
            `;
        }
    </script>
</body>
</html>