<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyFinance - Team Management</title>
    
    <!-- Theme CSS -->
    <link rel="stylesheet" href="../../../core/themes/toss-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-component-variables.css">
    <link rel="stylesheet" href="../../../core/themes/toss-base.css">
    <link rel="stylesheet" href="../../../core/themes/toss-typography.css">
    
    <!-- Component CSS -->
    <link rel="stylesheet" href="../../../components/base/toss-button.css">
    <link rel="stylesheet" href="../../../components/form/toss-input.css">
    <link rel="stylesheet" href="../../../components/form/toss-select.css">
    <link rel="stylesheet" href="../../../components/feedback/toss-alert.css">
    <link rel="stylesheet" href="../../../components/layout/toss-modal.css">
    <link rel="stylesheet" href="../../../components/navigation/navbar.css">
    
    <!-- External CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Employee Settings Styles -->
    <style>
        /* Page Layout */
        body {
            margin: 0;
            padding: 0;
            font-family: var(--font-family);
            background: var(--toss-gray-100);
            min-height: 100vh;
        }
        
        .page-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .page-content {
            flex: 1;
            padding: var(--space-4);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Page Header */
        .page-header {
            margin-bottom: var(--space-6);
        }
        
        .page-title {
            font-size: var(--font-h1);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
        
        /* Stats Section */
        .stats-card {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .quick-stat {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            align-items: center;
            gap: 16px;
            transition: all 0.2s ease;
        }
        
        .quick-stat:hover {
            border-color: rgba(0, 100, 255, 0.1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }
        
        .quick-stat-icon-wrapper {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        .quick-stat-icon-wrapper.total {
            background: rgba(0, 100, 255, 0.08);
        }
        
        .quick-stat-icon-wrapper.roles {
            background: rgba(168, 85, 247, 0.08);
        }
        
        .quick-stat-icon {
            width: 24px;
            height: 24px;
        }
        
        .quick-stat-icon-wrapper.total .quick-stat-icon {
            color: #0064FF;
        }
        
        .quick-stat-icon-wrapper.roles .quick-stat-icon {
            color: #a855f7;
        }
        
        .quick-stat-content {
            flex: 1;
        }
        
        .quick-stat-label {
            font-size: 12px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .quick-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            line-height: 1;
        }
        
        /* Store Filter & Add Employee Controls */
        .controls-card {
            background: transparent;
            padding: 0;
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .control-section {
            flex: 0 1 auto;
            min-width: 200px;
            max-width: 280px;
            width: 280px;
            display: flex;
            align-items: center;
            padding: 10px 14px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s ease;
            gap: 10px;
            position: relative;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: white;
            height: 44px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
        }
        
        .control-section:hover {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.12);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.06);
        }
        
        .control-section.dropdown-open {
            background: white;
            border-color: #0064FF;
            box-shadow: 0 0 0 4px rgba(0, 100, 255, 0.08);
        }
        
        .control-section.dropdown-open .control-dropdown {
            transform: rotate(180deg);
            color: #0064FF;
        }
        
        .control-section.dropdown-open .control-label {
            color: #0064FF;
            font-weight: 500;
        }
        
        .control-icon {
            width: 18px;
            height: 18px;
            color: rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
        }
        
        .control-icon.active {
            color: var(--toss-primary);
        }
        
        .control-label {
            font-size: 14px;
            font-weight: 500;
            color: #1a1a1a;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }
        
        .control-dropdown {
            width: 16px;
            height: 16px;
            color: rgba(0, 0, 0, 0.3);
            transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            margin-left: auto;
        }
        
        .controls-divider {
            display: none;
        }
        
        .filter-indicator {
            position: relative;
        }
        
        .filter-indicator::after {
            content: '';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 8px;
            height: 8px;
            background: var(--toss-primary);
            border-radius: 50%;
            display: none;
        }
        
        .filter-indicator.active::after {
            display: block;
        }
        
        
        /* Search Field */
        .search-card {
            background: var(--toss-white);
            border-radius: 16px;
            padding: 0;
            margin-bottom: var(--space-3);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }
        
        .search-container {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: var(--space-4);
            border: none;
            border-radius: 16px;
            font-size: var(--font-body);
            color: var(--text-primary);
            background: transparent;
            outline: none;
        }
        
        .search-input::placeholder {
            color: var(--toss-gray-400);
        }
        
        .search-icon {
            position: absolute;
            right: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--toss-gray-400);
            pointer-events: none;
        }
        
        /* Employee List Container */
        .employee-list-card {
            background: transparent;
            border-radius: 0;
            box-shadow: none;
            overflow: visible;
        }
        
        .employee-list-header {
            padding: 0 0 20px 0;
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .employee-list-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .employee-list-icon {
            width: 24px;
            height: 24px;
            color: #0064FF;
        }
        
        .employee-list-text {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a1a;
        }
        
        .employee-count-badge {
            padding: 6px 12px;
            background: rgba(0, 100, 255, 0.08);
            border-radius: 20px;
            font-size: 14px;
            color: #0064FF;
            font-weight: 600;
        }
        
        /* Modern Employee Cards */
        .employee-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 20px;
            padding: 0;
        }
        
        .employee-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .employee-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
            border-color: rgba(0, 100, 255, 0.1);
        }
        
        .employee-item-header {
            display: flex;
            align-items: flex-start;
            gap: 14px;
        }
        
        .employee-item-body {
            flex: 1;
        }
        
        .employee-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            position: relative;
            font-size: 18px;
            font-weight: 600;
            color: white;
        }
        
        .employee-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .employee-avatar-text {
            font-size: 18px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
        }
        
        .employee-info {
            flex: 1;
            min-width: 0;
        }
        
        .employee-name {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .employee-role {
            font-size: 14px;
            color: #6b7280;
            font-weight: 400;
            margin-bottom: 2px;
        }
        
        .employee-store {
            font-size: 13px;
            color: #9ca3af;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .employee-store-icon {
            width: 14px;
            height: 14px;
            opacity: 0.6;
        }
        
        .employee-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            background: #ecfdf5;
            color: #10b981;
            margin-top: 12px;
        }
        
        .employee-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }
        
        .employee-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid #f3f4f6;
            margin-top: 16px;
        }
        
        .employee-salary-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        
        .employee-salary-label {
            font-size: 11px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .employee-salary {
            font-size: 18px;
            font-weight: 700;
            color: #0064FF;
            line-height: 1;
        }
        
        .employee-salary-type {
            font-size: 12px;
            color: #6b7280;
            margin-top: 2px;
        }
        
        .employee-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .employee-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }
        
        .employee-action-btn:hover {
            background: rgba(0, 0, 0, 0.02);
            border-color: rgba(0, 0, 0, 0.12);
            transform: translateY(-1px);
        }
        
        .employee-edit-btn {
            color: #0064FF;
        }
        
        .employee-delete-btn {
            color: #ef4444;
        }
        
        .employee-action-icon {
            width: 16px;
            height: 16px;
        }
        
        /* Empty State */
        .empty-state {
            padding: var(--space-16) var(--space-6);
            text-align: center;
        }
        
        .empty-state-icon {
            width: 64px;
            height: 64px;
            color: var(--toss-gray-400);
            margin: 0 auto var(--space-4);
        }
        
        .empty-state-title {
            font-size: var(--font-h3);
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 var(--space-2) 0;
        }
        
        .empty-state-text {
            font-size: var(--font-body);
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Loading State */
        .loading-state {
            padding: var(--space-12);
            text-align: center;
        }
        
        .loading-spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--toss-gray-200);
            border-top: 3px solid var(--toss-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-4);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: var(--font-body);
            color: var(--text-secondary);
        }
        
        /* Floating Actions */
        .floating-actions {
            position: fixed;
            bottom: var(--space-4);
            right: var(--space-4);
            z-index: 100;
        }
        
        .scroll-to-top {
            width: 48px;
            height: 48px;
            border-radius: 24px;
            background: var(--toss-white);
            color: var(--toss-primary);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s ease;
        }
        
        .scroll-to-top.visible {
            opacity: 1;
            transform: scale(1);
        }
        
        .scroll-to-top:hover {
            background: var(--toss-gray-50);
            transform: scale(1.05);
        }
        
        /* Modal Overlays */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--toss-white);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.2s ease;
        }
        
        .modal-overlay.active .modal-content {
            transform: scale(1) translateY(0);
        }
        
        /* Store Filter Dropdown - Modern Toss Style */
        .store-filter-dropdown {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            min-width: 100%;
            width: max-content;
            max-width: 380px;
            background: white;
            border-radius: 14px;
            
            /* Modern shadow elevation */
            box-shadow: 
                0 0 0 1px rgba(0, 0, 0, 0.04),
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            z-index: 1000;
            
            /* Animation states */
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px) scale(0.96);
            transition: all 200ms cubic-bezier(0.16, 1, 0.3, 1);
            
            max-height: 380px;
            overflow-y: auto;
            overflow-x: hidden;
            
            /* Content padding */
            padding: 6px 0;
        }
        
        .store-filter-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }
        
        .store-filter-dropdown-option {
            position: relative;
            padding: 10px 16px;
            margin: 0 6px;
            border-radius: 8px;
            
            display: flex;
            align-items: center;
            gap: 12px;
            
            cursor: pointer;
            transition: all 150ms cubic-bezier(0.4, 0, 0.2, 1);
            
            font-size: 14px;
            line-height: 22px;
            font-weight: 400;
            color: var(--text-primary, #1a1a1a);
        }
        
        .store-filter-dropdown-option:hover {
            background: rgba(0, 0, 0, 0.04);
        }
        
        .store-filter-dropdown-option:active {
            background: rgba(0, 0, 0, 0.08);
            transform: scale(0.98);
        }
        
        .store-filter-dropdown-option.selected {
            background: rgba(0, 100, 255, 0.08);
            color: #0064FF;
        }
        
        .store-filter-dropdown-option.selected:hover {
            background: rgba(0, 100, 255, 0.12);
        }
        
        /* Keyboard focus state */
        .store-filter-dropdown-option.focused {
            outline: 2px solid #0064FF;
            outline-offset: -2px;
        }
        
        .store-filter-dropdown-option-icon {
            width: 20px;
            height: 20px;
            color: rgba(0, 0, 0, 0.4);
            flex-shrink: 0;
            transition: color 150ms ease;
        }
        
        .store-filter-dropdown-option.selected .store-filter-dropdown-option-icon {
            color: #0064FF;
        }
        
        .store-filter-dropdown-option-text {
            flex: 1;
            font-size: 14px;
            font-weight: 400;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .store-filter-dropdown-option.selected .store-filter-dropdown-option-text {
            font-weight: 500;
        }
        
        .store-filter-dropdown-option-check {
            width: 20px;
            height: 20px;
            color: #0064FF;
            flex-shrink: 0;
            margin-left: auto;
            
            /* Smooth entry animation */
            animation: checkmarkEntry 200ms cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        @keyframes checkmarkEntry {
            from {
                transform: scale(0) rotate(-45deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }
        
        /* Modern Scrollbar styling */
        .store-filter-dropdown::-webkit-scrollbar {
            width: 5px;
        }
        
        .store-filter-dropdown::-webkit-scrollbar-track {
            background: transparent;
            margin: 6px 0;
        }
        
        .store-filter-dropdown::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 1px solid transparent;
            background-clip: padding-box;
        }
        
        .store-filter-dropdown::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* Search input for filterable dropdown */
        .store-filter-search {
            padding: 8px 16px;
            margin: 0 6px 6px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(0, 0, 0, 0.02);
            transition: all 150ms ease;
        }
        
        .store-filter-search:focus {
            outline: none;
            border-color: #0064FF;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .store-filter-search::placeholder {
            color: rgba(0, 0, 0, 0.4);
        }
        
        /* Divider for grouping */
        .store-filter-divider {
            height: 1px;
            margin: 6px 12px;
            background: rgba(0, 0, 0, 0.06);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .page-content {
                padding: var(--space-3);
            }
            
            .controls-card {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .control-section {
                max-width: none;
                width: 100%;
                min-width: unset;
            }
            
            .store-filter-dropdown {
                left: 0;
                right: 0;
                width: 100%;
                max-width: none;
                border-radius: 12px;
            }
            
            .store-filter-dropdown-option {
                padding: 14px 16px;
                font-size: 16px;
            }
            
            .controls-divider {
                display: none;
            }
            
            .employee-list {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .employee-item {
                padding: 16px;
            }
            
            .employee-avatar {
                width: 44px;
                height: 44px;
                border-radius: 22px;
            }
            
            .employee-details {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
            
            .employee-salary-container {
                width: 100%;
            }
            
            .employee-actions {
                margin-left: var(--space-2);
            }
            
            /* Mobile dropdown adjustments */
            .store-filter-dropdown {
                left: -12px;
                right: -12px;
                max-height: 250px;
            }
            
            /* Edit Modal Mobile Styles */
            .edit-modal {
                width: 100%;
                max-width: none;
                margin: 16px;
                max-height: calc(100vh - 32px);
            }
            
            .modal-header {
                padding: 20px 20px 0;
            }
            
            .modal-title {
                font-size: 20px;
            }
            
            .modal-body {
                padding: 20px;
            }
            
            .employee-info-section {
                padding: 16px;
                gap: 16px;
            }
            
            .employee-avatar-large {
                width: 56px;
                height: 56px;
                font-size: 20px;
            }
            
            .employee-info-header h3 {
                font-size: 18px;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .edit-section {
                padding: 16px;
            }
            
            .salary-type-toggle {
                flex-direction: column;
                gap: 8px;
            }
            
            .toggle-option {
                width: 100%;
                padding: 12px;
            }
            
            .modal-footer {
                padding: 16px 20px;
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-secondary, .btn-primary {
                width: 100%;
                padding: 12px;
            }
        }
        
        /* Edit Modal Styles */
        .edit-modal {
            max-width: 560px;
            width: 95%;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 24px 0;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin: 0;
        }
        
        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: #6b7280;
        }
        
        .modal-close:hover {
            background: rgba(0, 0, 0, 0.04);
            color: #1a1a1a;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .employee-info-section {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(0, 100, 255, 0.03) 0%, rgba(0, 100, 255, 0.06) 100%);
            border-radius: 16px;
            margin-bottom: 24px;
            border: 1px solid rgba(0, 100, 255, 0.08);
        }
        
        .employee-avatar-large {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
            flex-shrink: 0;
        }
        
        .employee-info-header h3 {
            font-size: 20px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 4px 0;
        }
        
        .employee-info-header p {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .info-item {
            padding: 12px 16px;
            background: #f9fafb;
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.04);
        }
        
        .info-label {
            font-size: 12px;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
            display: block;
            margin-bottom: 6px;
        }
        
        .info-value {
            font-size: 15px;
            color: #1a1a1a;
            font-weight: 500;
        }
        
        .edit-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
            margin: 0 0 20px 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group:last-child {
            margin-bottom: 0;
        }
        
        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            display: block;
            margin-bottom: 8px;
        }
        
        /* Salary Type Toggle */
        .salary-type-toggle {
            display: flex;
            gap: 8px;
            padding: 4px;
            background: #f3f4f6;
            border-radius: 10px;
        }
        
        .toggle-option {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .toggle-option:hover {
            background: rgba(0, 0, 0, 0.04);
        }
        
        .toggle-option.active {
            background: white;
            color: #0064FF;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .toggle-icon {
            flex-shrink: 0;
        }
        
        /* Currency Select */
        .custom-select-wrapper {
            position: relative;
        }
        
        .form-select {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            color: #1a1a1a;
            background: white;
            cursor: pointer;
            appearance: none;
            transition: all 0.2s ease;
        }
        
        .form-select:hover {
            border-color: #d1d5db;
        }
        
        .form-select:focus {
            outline: none;
            border-color: #0064FF;
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .select-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #6b7280;
        }
        
        /* Salary Input */
        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            transition: all 0.2s ease;
        }
        
        .input-wrapper:hover {
            border-color: #d1d5db;
        }
        
        .input-wrapper:focus-within {
            border-color: #0064FF;
            box-shadow: 0 0 0 3px rgba(0, 100, 255, 0.1);
        }
        
        .currency-symbol {
            font-size: 16px;
            font-weight: 600;
            color: #0064FF;
            flex-shrink: 0;
        }
        
        .salary-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            font-weight: 500;
            color: #1a1a1a;
            background: transparent;
        }
        
        .salary-input::placeholder {
            color: #9ca3af;
        }
        
        .salary-period {
            font-size: 13px;
            color: #6b7280;
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        /* Modal Footer */
        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #f3f4f6;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        .btn-secondary, .btn-primary {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
        }
        
        .btn-primary {
            background: #0064FF;
            color: white;
            box-shadow: 0 1px 3px rgba(0, 100, 255, 0.2);
        }
        
        .btn-primary:hover {
            background: #0052CC;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 100, 255, 0.3);
        }
        
        /* Utility Classes */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .flex {
            display: flex;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-2 {
            gap: var(--space-2);
        }
        
        .gap-3 {
            gap: var(--space-3);
        }
        
        /* Loading Animation */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Navigation Bar -->
        <div id="navbar-container"></div>
        
        <!-- Page Content -->
        <main class="page-content">
            <!-- Page Header -->
            <div class="page-header">
                <h1 class="page-title">Team Management</h1>
            </div>
            
            <!-- Stats Section -->
            <div class="stats-card">
                <div class="quick-stat">
                    <div class="quick-stat-icon-wrapper total">
                        <svg class="quick-stat-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M16,4C18.11,4 20,5.89 20,8C20,10.11 18.11,12 16,12C13.89,12 12,10.11 12,8C12,5.89 13.89,4 16,4M16,13C18.67,13 24,14.34 24,17V20H8V17C8,14.34 13.33,13 16,13M8,4C10.11,4 12,5.89 12,8C12,10.11 10.11,12 8,12C5.89,12 4,10.11 4,8C4,5.89 5.89,4 8,4M8,13C10.67,13 16,14.34 16,17V20H0V17C0,14.34 5.33,13 8,13Z"/>
                        </svg>
                    </div>
                    <div class="quick-stat-content">
                        <div class="quick-stat-label">Total Employees</div>
                        <div class="quick-stat-value" id="totalEmployees">0</div>
                    </div>
                </div>
                
                <div class="quick-stat">
                    <div class="quick-stat-icon-wrapper roles">
                        <svg class="quick-stat-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12,15C12.81,15 13.5,14.7 14.11,14.11C14.7,13.5 15,12.81 15,12C15,11.19 14.7,10.5 14.11,9.89C13.5,9.3 12.81,9 12,9C11.19,9 10.5,9.3 9.89,9.89C9.3,10.5 9,11.19 9,12C9,12.81 9.3,13.5 9.89,14.11C10.5,14.7 11.19,15 12,15M12,2L14.09,8.26L22,9L16,14.74L17.18,22.74L12,19.77L6.82,22.74L8,14.74L2,9L9.91,8.26L12,2Z"/>
                        </svg>
                    </div>
                    <div class="quick-stat-content">
                        <div class="quick-stat-label">Unique Roles</div>
                        <div class="quick-stat-value" id="totalRoles">0</div>
                    </div>
                </div>
            </div>
            
            <!-- Store Filter and Add Employee Controls -->
            <div class="controls-card">
                <div class="control-section" id="storeFilterControl">
                    <div class="filter-indicator" id="storeFilterIndicator">
                        <svg class="control-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75Z"/>
                        </svg>
                    </div>
                    <span class="control-label" id="storeFilterLabel">All Stores</span>
                    <svg class="control-dropdown" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                    </svg>
                    
                    <!-- Store Filter Dropdown -->
                    <div class="store-filter-dropdown" id="storeFilterDropdown">
                        <div id="storeFilterOptions">
                            <!-- Store filter options will be inserted here -->
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Employee List -->
            <div class="employee-list-card" id="employeeListCard">
                <!-- Loading State -->
                <div class="loading-state" id="loadingState">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">Loading team members...</div>
                </div>
                
                <!-- Employee List Content (Hidden initially) -->
                <div id="employeeListContent" class="hidden">
                    <div class="employee-list-header">
                        <div class="employee-list-title">
                            <svg class="employee-list-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M16,4C18.11,4 20,5.89 20,8C20,10.11 18.11,12 16,12C13.89,12 12,10.11 12,8C12,5.89 13.89,4 16,4M16,13C18.67,13 24,14.34 24,17V20H8V17C8,14.34 13.33,13 16,13M8,4C10.11,4 12,5.89 12,8C12,10.11 10.11,12 8,12C5.89,12 4,10.11 4,8C4,5.89 5.89,4 8,4M8,13C10.67,13 16,14.34 16,17V20H0V17C0,14.34 5.33,13 8,13Z"/>
                            </svg>
                            <span class="employee-list-text">Team Members</span>
                        </div>
                        <div class="employee-count-badge" id="employeeCount">0 members</div>
                    </div>
                    <div id="employeeList">
                        <!-- Employee items will be inserted here -->
                    </div>
                </div>
                
                <!-- Empty State (Hidden initially) -->
                <div class="empty-state hidden" id="emptyState">
                    <svg class="empty-state-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M16,4C18.11,4 20,5.89 20,8C20,10.11 18.11,12 16,12C13.89,12 12,10.11 12,8C12,5.89 13.89,4 16,4M16,13C18.67,13 24,14.34 24,17V20H8V17C8,14.34 13.33,13 16,13M8,4C10.11,4 12,5.89 12,8C12,10.11 10.11,12 8,12C5.89,12 4,10.11 4,8C4,5.89 5.89,4 8,4M8,13C10.67,13 16,14.34 16,17V20H0V17C0,14.34 5.33,13 8,13Z"/>
                    </svg>
                    <h3 class="empty-state-title" id="emptyTitle">No team members yet</h3>
                    <p class="empty-state-text" id="emptyText">Add your first team member to get started</p>
                </div>
            </div>
        </main>
        
        <!-- Floating Actions -->
        <div class="floating-actions">
            <button class="scroll-to-top" id="scrollToTop">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z"/>
                </svg>
            </button>
        </div>
        
        
        <!-- Employee Edit Modal -->
        <div class="modal-overlay" id="employeeEditModal">
            <div class="modal-content edit-modal">
                <div class="modal-header">
                    <h2 class="modal-title">Edit Employee</h2>
                    <button class="modal-close" onclick="closeEditModal()">
                        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="modal-body">
                    <!-- Employee Info Display -->
                    <div class="employee-info-section">
                        <div class="employee-avatar-large" id="editEmployeeAvatar">
                            <span id="editEmployeeInitial">J</span>
                        </div>
                        <div class="employee-info-header">
                            <h3 id="editEmployeeName">John Doe</h3>
                            <p id="editEmployeeEmail">john.doe@example.com</p>
                        </div>
                    </div>
                    
                    <!-- Employee Details (Read-only) -->
                    <div class="info-grid">
                        <div class="info-item">
                            <label class="info-label">Role</label>
                            <div class="info-value" id="editEmployeeRole">Manager</div>
                        </div>
                        <div class="info-item">
                            <label class="info-label">Store</label>
                            <div class="info-value" id="editEmployeeStore">Main Store</div>
                        </div>
                    </div>
                    
                    <!-- Editable Salary Section -->
                    <div class="edit-section">
                        <h4 class="section-title">Salary Configuration</h4>
                        
                        <!-- Salary Type Toggle -->
                        <div class="form-group">
                            <label class="form-label">Salary Type</label>
                            <div class="salary-type-toggle">
                                <button class="toggle-option" id="monthlyOption" data-value="monthly">
                                    <svg class="toggle-icon" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19,3H18V1H16V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,19H5V8H19V19Z"/>
                                    </svg>
                                    Monthly
                                </button>
                                <button class="toggle-option" id="hourlyOption" data-value="hourly">
                                    <svg class="toggle-icon" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12,20A8,8 0 0,0 20,12A8,8 0 0,0 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22C6.47,22 2,17.5 2,12A10,10 0 0,1 12,2M12.5,7V12.25L17,14.92L16.25,16.15L11,13V7H12.5Z"/>
                                    </svg>
                                    Hourly
                                </button>
                            </div>
                        </div>
                        
                        <!-- Currency Selection -->
                        <div class="form-group">
                            <label class="form-label" for="editCurrency">Currency</label>
                            <div class="custom-select-wrapper">
                                <select id="editCurrency" class="form-select">
                                    <option value="USD">USD - US Dollar ($)</option>
                                    <option value="EUR">EUR - Euro (€)</option>
                                    <option value="GBP">GBP - British Pound (£)</option>
                                    <option value="JPY">JPY - Japanese Yen (¥)</option>
                                    <option value="KRW">KRW - Korean Won (₩)</option>
                                    <option value="CNY">CNY - Chinese Yuan (¥)</option>
                                    <option value="VND">VND - Vietnamese Dong (₫)</option>
                                    <option value="THB">THB - Thai Baht (฿)</option>
                                    <option value="INR">INR - Indian Rupee (₹)</option>
                                    <option value="AUD">AUD - Australian Dollar (A$)</option>
                                    <option value="CAD">CAD - Canadian Dollar (C$)</option>
                                    <option value="SGD">SGD - Singapore Dollar (S$)</option>
                                    <option value="HKD">HKD - Hong Kong Dollar (HK$)</option>
                                </select>
                                <svg class="select-arrow" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Salary Amount -->
                        <div class="form-group">
                            <label class="form-label" for="editSalaryAmount">Salary Amount</label>
                            <div class="input-wrapper">
                                <span class="currency-symbol" id="currencySymbol">$</span>
                                <input type="text" id="editSalaryAmount" class="form-input salary-input" placeholder="0" />
                                <span class="salary-period" id="salaryPeriod">per month</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button class="btn-secondary" onclick="closeEditModal()">Cancel</button>
                    <button class="btn-primary" onclick="saveEmployeeChanges()">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px;">
                            <path d="M17,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V7.5L18.5,5M19,19H5V5H16.17L19,7.83V19M12,12C10.34,12 9,13.34 9,15C9,16.66 10.34,18 12,18C13.66,18 15,16.66 15,15C15,13.34 13.66,12 12,12M6,6H15V10H6V6Z"/>
                        </svg>
                        Save Changes
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Employee Detail Modal (keeping original for view-only) -->
        <div class="modal-overlay" id="employeeDetailModal">
            <div class="modal-content">
                <!-- Employee detail content will be loaded here -->
                <div style="padding: var(--space-6); text-align: center;">
                    <h3>Employee Details</h3>
                    <p>Detailed employee information and management options will be displayed here.</p>
                    <button onclick="closeEmployeeDetailModal()" style="margin-top: var(--space-4); padding: var(--space-2) var(--space-4); background: var(--toss-primary); color: white; border: none; border-radius: 8px; cursor: pointer;">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Component JavaScript -->
    <script src="../../../components/base/toss-button.js"></script>
    <script src="../../../components/form/toss-input.js"></script>
    <script src="../../../components/form/toss-select.js"></script>
    <script src="../../../components/navigation/navbar.js"></script>
    <script src="../../../components/feedback/toss-alert.js"></script>
    <script src="../../../components/layout/toss-modal.js"></script>
    
    <!-- Core Scripts -->
    <script src="../../../core/constants/app-icons.js"></script>
    <script src="../../../core/config/supabase.js"></script>
    <script src="../../../core/utils/app-state.js"></script>
    <script src="../../../core/config/route-mapping.js"></script>
    <script src="../../../core/utils/page-init.js"></script>
    
    <script>
        // Employee Settings Page Implementation
        class EmployeeSettingsPage {
            constructor() {
                this.employees = [];
                this.filteredEmployees = [];
                this.currentStoreFilter = null; // null means "All Stores"
                this.currentFocusIndex = -1; // For keyboard navigation
                this.dropdownOpen = false;
                this.currencies = []; // Store available currencies from Supabase
                
                this.init();
            }
            
            init() {
                this.setupEventListeners();
                this.setupEditModalListeners();
                this.loadInitialData();
            }
            
            setupEventListeners() {
                // Store filter control
                const storeFilterControl = document.getElementById('storeFilterControl');
                storeFilterControl.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleStoreFilterDropdown();
                });
                
                // Keyboard navigation for dropdown
                storeFilterControl.addEventListener('keydown', (e) => {
                    this.handleDropdownKeyboard(e);
                });
                
                
                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.control-section') && !e.target.closest('.store-filter-dropdown')) {
                        this.hideStoreFilterDropdown();
                    }
                });
                
                // Close dropdown on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        if (this.dropdownOpen) {
                            this.hideStoreFilterDropdown();
                        }
                        // Also close edit modal if open
                        if (document.getElementById('employeeEditModal').classList.contains('active')) {
                            window.closeEditModal();
                        }
                    }
                });
                
                // Employee detail modal
                document.getElementById('employeeDetailModal').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        this.closeEmployeeDetailModal();
                    }
                });
                
                // Scroll to top
                const scrollToTop = document.getElementById('scrollToTop');
                scrollToTop.addEventListener('click', () => {
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
                
                // Show/hide scroll to top button
                window.addEventListener('scroll', () => {
                    if (window.pageYOffset > 200) {
                        scrollToTop.classList.add('visible');
                    } else {
                        scrollToTop.classList.remove('visible');
                    }
                });
            }
            
            async loadInitialData() {
                // Load currencies from Supabase first
                await this.loadCurrencies();
                // Load employees with current store filter (null = All Stores)
                await this.loadEmployeeInfo();
            }
            
            async loadCurrencies() {
                try {
                    console.log('Loading company currencies from Supabase...');
                    
                    // Get the selected company ID
                    const selectedCompanyId = appState.getSelectedCompanyId();
                    if (!selectedCompanyId) {
                        console.log('No company selected, using fallback currencies');
                        this.currencies = this.getFallbackCurrencies();
                        return;
                    }
                    
                    // Query currencies linked to this company through company_currencies table
                    // This joins company_currencies with currency_types to get only the currencies
                    // that are available for the current company
                    const { data, error } = await supabase
                        .from('company_currencies')
                        .select(`
                            currency_id,
                            currency_types (
                                currency_id,
                                currency_code,
                                currency_name,
                                currency_symbol
                            )
                        `)
                        .eq('company_id', selectedCompanyId)
                        .order('currency_types(currency_code)');
                    
                    if (error) {
                        console.error('Error loading company currencies:', error);
                        // Use fallback currencies if database fails
                        this.currencies = this.getFallbackCurrencies();
                        return;
                    }
                    
                    if (data && data.length > 0) {
                        // Extract the currency information from the joined data
                        this.currencies = data.map(item => ({
                            currency_id: item.currency_types.currency_id,
                            currency_code: item.currency_types.currency_code,
                            currency_name: item.currency_types.currency_name,
                            currency_symbol: item.currency_types.currency_symbol
                        }));
                        console.log('✅ Loaded company-specific currencies:', this.currencies);
                        
                        // Validate that all currencies have proper UUIDs
                        const invalidCurrencies = this.currencies.filter(c => !c.currency_id || !c.currency_id.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i));
                        if (invalidCurrencies.length > 0) {
                            console.warn('⚠️ Found currencies with invalid UUIDs:', invalidCurrencies);
                        }
                    } else {
                        // Use fallback if no currencies configured for this company
                        this.currencies = this.getFallbackCurrencies();
                        console.log('⚠️ No currencies configured for this company, using fallback currencies with proper UUIDs');
                    }
                    
                    // Update the currency dropdown in the edit modal (if it exists)
                    this.updateCurrencyDropdown();
                    
                } catch (error) {
                    console.error('Error in loadCurrencies:', error);
                    this.currencies = this.getFallbackCurrencies();
                    // Update dropdown with fallback currencies
                    this.updateCurrencyDropdown();
                }
            }
            
            getFallbackCurrencies() {
                // Fallback currencies with proper UUID format if database is not available
                // Note: These are example UUIDs - in production, these should match actual currency_types table UUIDs
                return [
                    { currency_id: '00000000-0000-0000-0000-000000000001', currency_code: 'USD', currency_name: 'US Dollar', currency_symbol: '$' },
                    { currency_id: '00000000-0000-0000-0000-000000000002', currency_code: 'EUR', currency_name: 'Euro', currency_symbol: '€' },
                    { currency_id: '00000000-0000-0000-0000-000000000003', currency_code: 'GBP', currency_name: 'British Pound', currency_symbol: '£' },
                    { currency_id: '93f9bc80-eb8c-4e3e-b214-50db1699b7b6', currency_code: 'VND', currency_name: 'Vietnamese Dong', currency_symbol: '₫' },
                    { currency_id: '00000000-0000-0000-0000-000000000005', currency_code: 'KRW', currency_name: 'Korean Won', currency_symbol: '₩' }
                ];
            }
            
            updateCurrencyDropdown() {
                const currencySelect = document.getElementById('editCurrency');
                if (!currencySelect) {
                    console.log('❌ Currency dropdown element not found');
                    return;
                }
                
                console.log('Updating currency dropdown with currencies:', this.currencies);
                
                // Clear existing options
                currencySelect.innerHTML = '';
                
                if (this.currencies.length === 0) {
                    console.log('⚠️ No currencies available to populate dropdown');
                    return;
                }
                
                // Add currencies from database
                this.currencies.forEach((currency, index) => {
                    const option = document.createElement('option');
                    option.value = currency.currency_id; // Use currency_id as value
                    option.dataset.currencyCode = currency.currency_code; // Store currency_code for reference
                    option.textContent = `${currency.currency_code} - ${currency.currency_name} (${currency.currency_symbol})`;
                    currencySelect.appendChild(option);
                    
                    console.log(`Added option ${index + 1}:`, {
                        value: option.value,
                        currencyCode: option.dataset.currencyCode,
                        text: option.textContent
                    });
                });
                
                console.log(`✅ Currency dropdown populated with ${this.currencies.length} options`);
            }
            
            async loadEmployeeInfo(storeId = null) {
                try {
                    // Show loading state
                    document.getElementById('loadingState').classList.remove('hidden');
                    document.getElementById('employeeListContent').classList.add('hidden');
                    document.getElementById('emptyState').classList.add('hidden');
                    
                    // Get selected company from session storage
                    const selectedCompanyId = appState.getSelectedCompanyId();
                    
                    if (!selectedCompanyId) {
                        console.log('No company selected');
                        this.showEmptyState('Select a company to view team members');
                        return;
                    }
                    
                    // Prepare RPC parameters
                    const rpcParams = {
                        p_company_id: selectedCompanyId
                    };
                    
                    // Only add p_store_id if a specific store is selected
                    if (storeId) {
                        rpcParams.p_store_id = storeId;
                    }
                    
                    console.log('Calling get_employee_info RPC with params:', rpcParams);
                    
                    // Call the RPC
                    const { data, error } = await supabase.rpc('get_employee_info', rpcParams);
                    
                    if (error) {
                        console.error('Error calling get_employee_info:', error);
                        this.showEmptyState('Failed to load team members');
                        return;
                    }
                    
                    console.log('Employee info response:', data);
                    
                    // Parse and store employee data
                    this.employees = this.parseEmployeeData(data || []);
                    
                    // Display the employees
                    this.displayEmployees();
                    this.updateStats();
                    
                } catch (error) {
                    console.error('Error loading employee info:', error);
                    this.showEmptyState('Failed to load team members');
                }
            }
            
            parseEmployeeData(rpcData) {
                return rpcData.map(emp => {
                    // Handle arrays for roles and stores (multiple assignments possible)
                    const roleIds = emp.role_ids || [];
                    const roleNames = emp.role_names || [];
                    const storeIds = emp.store_ids || [];
                    const storeNames = emp.store_names || [];
                    
                    // Get primary role and store (first in array)
                    const primaryRoleName = roleNames.length > 0 ? roleNames[0] : 'No role assigned';
                    const primaryStoreName = storeNames.length > 0 ? storeNames[0] : 'No store assigned';
                    const primaryRoleId = roleIds.length > 0 ? roleIds[0] : null;
                    const primaryStoreId = storeIds.length > 0 ? storeIds[0] : null;
                    
                    return {
                        userId: emp.user_id,
                        fullName: emp.full_name,
                        email: emp.email,
                        profileImage: null, // Not in RPC response
                        roleId: primaryRoleId, // Primary role ID
                        roleIds: roleIds, // All role IDs
                        roleName: primaryRoleName, // Primary role name for display
                        roleNames: roleNames, // All role names
                        userRoleId: emp.user_role_id, // For backward compatibility
                        storeId: primaryStoreId, // Primary store ID
                        storeIds: storeIds, // All store IDs
                        storeName: primaryStoreName, // Primary store name for display
                        storeNames: storeNames, // All store names
                        userStoreId: emp.user_store_id, // For backward compatibility
                        companyId: emp.company_id,
                        companyName: emp.company_name,
                        userCompanyId: emp.user_company_id,
                        salaryId: emp.salary_id,
                        salaryAmount: emp.salary_amount || 0,
                        salaryType: emp.salary_type || 'monthly',
                        bonusAmount: emp.bonus_amount || 0,
                        currencyId: emp.currency_id,
                        currencyCode: emp.currency_code || 'USD',
                        accountId: emp.account_id,
                        isActive: true // Assume active unless told otherwise
                    };
                });
            }
            
            
            displayEmployees() {
                const employeeList = document.getElementById('employeeList');
                const employeeListContent = document.getElementById('employeeListContent');
                const loadingState = document.getElementById('loadingState');
                const emptyState = document.getElementById('emptyState');
                
                // Hide loading
                loadingState.classList.add('hidden');
                
                // Sort employees by name
                this.employees.sort((a, b) => a.fullName.localeCompare(b.fullName));
                
                if (this.employees.length === 0) {
                    employeeListContent.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    
                    // Update empty state based on filters
                    const emptyTitle = document.getElementById('emptyTitle');
                    const emptyText = document.getElementById('emptyText');
                    
                    if (this.currentStoreFilter) {
                        emptyTitle.textContent = 'No employees in this store';
                        emptyText.textContent = 'Try selecting a different store or add employees to this store';
                    } else {
                        emptyTitle.textContent = 'No team members yet';
                        emptyText.textContent = 'Add your first team member to get started';
                    }
                    return;
                }
                
                // Show employee list
                emptyState.classList.add('hidden');
                employeeListContent.classList.remove('hidden');
                
                // Update count
                document.getElementById('employeeCount').textContent = `${this.employees.length} member${this.employees.length === 1 ? '' : 's'}`;
                
                // Add employee-list class to container for grid layout
                employeeList.className = 'employee-list';
                
                // Render employee items
                employeeList.innerHTML = this.employees.map(employee => {
                    return this.renderEmployeeItem(employee);
                }).join('');
                
                // Add click listeners
                this.addEmployeeClickListeners();
                
                // Update filter UI
                this.updateFilterUI();
            }
            
            renderEmployeeItem(employee) {
                const initial = employee.fullName.charAt(0).toUpperCase();
                const formattedSalary = this.formatSalary(employee.salaryAmount);
                const salaryType = employee.salaryType === 'hourly' ? 'per hour' : 'per month';
                
                // Get currency symbol based on currency code
                const currencySymbol = this.getCurrencySymbol(employee.currencyCode);
                
                return `
                    <div class="employee-item" data-user-id="${employee.userId}">
                        <div class="employee-item-header">
                            <div class="employee-avatar">
                                ${employee.profileImage ? 
                                    `<img src="${employee.profileImage}" alt="${employee.fullName}">` : 
                                    `<span class="employee-avatar-text">${initial}</span>`
                                }
                            </div>
                            <div class="employee-item-body">
                                <div class="employee-info">
                                    <div class="employee-name">${employee.fullName}</div>
                                    <div class="employee-role">${employee.roleName}</div>
                                    <div class="employee-store">
                                        <svg class="employee-store-icon" fill="currentColor" viewBox="0 0 24 24">
                                            <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75Z"/>
                                        </svg>
                                        ${employee.storeName}
                                    </div>
                                    ${employee.isActive ? '<div class="employee-status-badge"><span class="employee-status-dot"></span>Active</div>' : ''}
                                </div>
                            </div>
                            <div class="employee-actions">
                                <button class="employee-action-btn employee-edit-btn" data-action="edit" data-user-id="${employee.userId}" title="Edit">
                                    <svg class="employee-action-icon" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.12,5.12L18.87,8.87M3,17.25V21H6.75L17.81,9.93L14.06,6.18L3,17.25Z"/>
                                    </svg>
                                </button>
                                <button class="employee-action-btn employee-delete-btn" data-action="delete" data-user-id="${employee.userId}" title="Delete">
                                    <svg class="employee-action-icon" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="employee-details">
                            <div class="employee-salary-container">
                                <div class="employee-salary-label">Salary</div>
                                <div class="employee-salary">${currencySymbol}${formattedSalary}</div>
                                <div class="employee-salary-type">${salaryType}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            getCurrencySymbol(currencyCode) {
                const currencySymbols = {
                    'USD': '$',
                    'EUR': '€',
                    'GBP': '£',
                    'JPY': '¥',
                    'CNY': '¥',
                    'KRW': '₩',
                    'VND': '₫',
                    'THB': '฿',
                    'INR': '₹',
                    'AUD': 'A$',
                    'CAD': 'C$',
                    'SGD': 'S$',
                    'HKD': 'HK$',
                    'NZD': 'NZ$',
                    'MXN': '$',
                    'BRL': 'R$',
                    'ARS': '$',
                    'CLP': '$',
                    'PEN': 'S/',
                    'COP': '$'
                };
                
                return currencySymbols[currencyCode] || currencyCode + ' ';
            }
            
            addEmployeeClickListeners() {
                // Add listeners for employee action buttons
                const actionButtons = document.querySelectorAll('.employee-action-btn');
                actionButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent triggering employee details
                        const action = button.dataset.action;
                        const userId = button.dataset.userId;
                        
                        if (action === 'edit') {
                            this.editEmployee(userId);
                        } else if (action === 'delete') {
                            this.deleteEmployee(userId);
                        }
                    });
                });
                
                // Add listeners for employee row clicks (for details)
                const employeeItems = document.querySelectorAll('.employee-item');
                employeeItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        // Only show details if clicking on the row, not action buttons
                        if (!e.target.closest('.employee-actions')) {
                            const userId = item.dataset.userId;
                            this.showEmployeeDetails(userId);
                        }
                    });
                });
            }
            
            formatSalary(amount) {
                // Convert to string and add comma separators
                return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
            
            updateStats() {
                const totalEmployees = this.employees.length;
                // Count unique roles by filtering out "No role assigned" and null values
                const uniqueRoles = new Set(
                    this.employees
                        .map(emp => emp.roleName)
                        .filter(role => role && role !== 'No role assigned')
                ).size;
                
                document.getElementById('totalEmployees').textContent = totalEmployees;
                document.getElementById('totalRoles').textContent = uniqueRoles;
            }
            
            
            
            updateFilterUI() {
                const storeFilterLabel = document.getElementById('storeFilterLabel');
                const storeFilterIndicator = document.getElementById('storeFilterIndicator');
                
                // Update store filter label using app state stores
                if (this.currentStoreFilter) {
                    let stores = [];
                    
                    // Try to get stores from appState, fallback to mock data if not available
                    if (typeof appState !== 'undefined' && typeof appState.getCompanyStores === 'function') {
                        stores = appState.getCompanyStores();
                    } else {
                        // Fallback mock stores for development
                        stores = [
                            { store_id: 'store_1', store_name: 'Main Store' },
                            { store_id: 'store_2', store_name: 'Branch Store' }
                        ];
                    }
                    
                    const store = stores.find(s => s.store_id === this.currentStoreFilter);
                    storeFilterLabel.textContent = store ? store.store_name : 'Unknown Store';
                    storeFilterIndicator.classList.add('active');
                } else {
                    storeFilterLabel.textContent = 'All Stores';
                    storeFilterIndicator.classList.remove('active');
                }
            }
            
            toggleStoreFilterDropdown() {
                const dropdown = document.getElementById('storeFilterDropdown');
                const isActive = dropdown.classList.contains('active');
                
                if (isActive) {
                    this.hideStoreFilterDropdown();
                } else {
                    this.showStoreFilterDropdown();
                }
            }
            
            handleDropdownKeyboard(e) {
                if (!this.dropdownOpen && (e.key === 'Enter' || e.key === ' ' || e.key === 'ArrowDown')) {
                    e.preventDefault();
                    this.showStoreFilterDropdown();
                    return;
                }
                
                if (!this.dropdownOpen) return;
                
                const options = document.querySelectorAll('.store-filter-dropdown-option');
                const maxIndex = options.length - 1;
                
                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.currentFocusIndex = Math.min(this.currentFocusIndex + 1, maxIndex);
                        this.updateFocusedOption();
                        break;
                        
                    case 'ArrowUp':
                        e.preventDefault();
                        this.currentFocusIndex = Math.max(this.currentFocusIndex - 1, 0);
                        this.updateFocusedOption();
                        break;
                        
                    case 'Enter':
                    case ' ':
                        e.preventDefault();
                        if (this.currentFocusIndex >= 0) {
                            const focusedOption = options[this.currentFocusIndex];
                            if (focusedOption) {
                                focusedOption.click();
                            }
                        }
                        break;
                        
                    case 'Home':
                        e.preventDefault();
                        this.currentFocusIndex = 0;
                        this.updateFocusedOption();
                        break;
                        
                    case 'End':
                        e.preventDefault();
                        this.currentFocusIndex = maxIndex;
                        this.updateFocusedOption();
                        break;
                        
                    case 'Tab':
                        // Allow tab to close dropdown and move to next element
                        this.hideStoreFilterDropdown();
                        break;
                }
            }
            
            updateFocusedOption() {
                const options = document.querySelectorAll('.store-filter-dropdown-option');
                options.forEach((option, index) => {
                    if (index === this.currentFocusIndex) {
                        option.classList.add('focused');
                        // Scroll into view if needed
                        option.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                    } else {
                        option.classList.remove('focused');
                    }
                });
            }
            
            showStoreFilterDropdown() {
                const storeFilterDropdown = document.getElementById('storeFilterDropdown');
                const storeFilterControl = document.getElementById('storeFilterControl');
                const storeFilterOptions = document.getElementById('storeFilterOptions');
                
                let stores = [];
                
                // Try to get stores from appState, fallback to mock data if not available
                if (typeof appState !== 'undefined' && typeof appState.getCompanyStores === 'function') {
                    stores = appState.getCompanyStores();
                } else {
                    console.warn('appState not available in filter dropdown, using fallback');
                    // Fallback mock stores for development
                    stores = [
                        { store_id: 'store_1', store_name: 'Main Store' },
                        { store_id: 'store_2', store_name: 'Branch Store' },
                        { store_id: 'test2', store_name: 'test2' }
                    ];
                }
                
                // Add search input if there are many stores
                let optionsHTML = '';
                if (stores.length > 5) {
                    optionsHTML += `
                        <input type="text" 
                            class="store-filter-search" 
                            id="storeFilterSearch" 
                            placeholder="Search stores..."
                            autocomplete="off">
                    `;
                }
                
                optionsHTML += `
                    <div class="store-filter-dropdown-option${!this.currentStoreFilter ? ' selected' : ''}" data-store-filter="">
                        <svg class="store-filter-dropdown-option-icon" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
                        </svg>
                        <span class="store-filter-dropdown-option-text">All Stores</span>
                        ${!this.currentStoreFilter ? '<svg class="store-filter-dropdown-option-check" fill="currentColor" viewBox="0 0 24 24"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg>' : ''}
                    </div>
                `;
                
                stores.forEach(store => {
                    const isSelected = store.store_id === this.currentStoreFilter;
                    optionsHTML += `
                        <div class="store-filter-dropdown-option${isSelected ? ' selected' : ''}" data-store-filter="${store.store_id}">
                            <svg class="store-filter-dropdown-option-icon" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12,3L2,12H5V20H19V12H22L12,3M12,8.75A1.25,1.25 0 0,1 13.25,10A1.25,1.25 0 0,1 12,11.25A1.25,1.25 0 0,1 10.75,10A1.25,1.25 0 0,1 12,8.75Z"/>
                            </svg>
                            <span class="store-filter-dropdown-option-text">${store.store_name}</span>
                            ${isSelected ? '<svg class="store-filter-dropdown-option-check" fill="currentColor" viewBox="0 0 24 24"><path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/></svg>' : ''}
                        </div>
                    `;
                });
                
                storeFilterOptions.innerHTML = optionsHTML;
                
                // Add search functionality if search input exists
                const searchInput = document.getElementById('storeFilterSearch');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const options = storeFilterOptions.querySelectorAll('.store-filter-dropdown-option');
                        
                        options.forEach(option => {
                            const text = option.querySelector('.store-filter-dropdown-option-text').textContent.toLowerCase();
                            if (text.includes(searchTerm) || searchTerm === '') {
                                option.style.display = 'flex';
                            } else {
                                option.style.display = 'none';
                            }
                        });
                    });
                    
                    // Focus search input when dropdown opens
                    setTimeout(() => searchInput.focus(), 100);
                }
                
                // Add click listeners and hover effects
                storeFilterOptions.querySelectorAll('.store-filter-dropdown-option').forEach((option, index) => {
                    option.addEventListener('click', async () => {
                        const storeFilter = option.dataset.storeFilter;
                        this.currentStoreFilter = storeFilter || null;
                        
                        // Call RPC with the selected store
                        await this.loadEmployeeInfo(this.currentStoreFilter);
                        
                        this.hideStoreFilterDropdown();
                    });
                    
                    // Add hover effect for keyboard navigation
                    option.addEventListener('mouseenter', () => {
                        this.currentFocusIndex = index;
                        this.updateFocusedOption();
                    });
                });
                
                storeFilterDropdown.classList.add('active');
                storeFilterControl.classList.add('dropdown-open');
                this.dropdownOpen = true;
                this.currentFocusIndex = -1; // Reset focus index
                
                // Set initial focus based on current selection
                const options = storeFilterOptions.querySelectorAll('.store-filter-dropdown-option');
                options.forEach((option, index) => {
                    if (option.classList.contains('selected')) {
                        this.currentFocusIndex = index;
                        this.updateFocusedOption();
                    }
                });
            }
            
            hideStoreFilterDropdown() {
                const storeFilterDropdown = document.getElementById('storeFilterDropdown');
                const storeFilterControl = document.getElementById('storeFilterControl');
                storeFilterDropdown.classList.remove('active');
                storeFilterControl.classList.remove('dropdown-open');
                this.dropdownOpen = false;
                this.currentFocusIndex = -1;
                
                // Clear all focused states
                const options = document.querySelectorAll('.store-filter-dropdown-option');
                options.forEach(option => option.classList.remove('focused'));
            }
            
            
            editEmployee(userId) {
                const employee = this.employees.find(emp => emp.userId === userId);
                if (!employee) return;
                
                // Store the current editing employee ID
                this.currentEditingEmployeeId = userId;
                
                // Show the edit modal with employee data
                this.showEditEmployeeModal(employee);
            }
            
            showEditEmployeeModal(employee) {
                console.log('showEditEmployeeModal called for:', employee.fullName);
                console.log('Current currencies loaded:', this.currencies.length);
                
                // Ensure currencies are loaded and dropdown is populated
                if (this.currencies.length === 0) {
                    console.log('Loading currencies before showing modal...');
                    // If currencies haven't been loaded yet, load them first
                    this.loadCurrencies().then(() => {
                        console.log('Currencies loaded, showing modal...');
                        this.showEditEmployeeModalInternal(employee);
                    }).catch(error => {
                        console.error('Error loading currencies:', error);
                        // Show modal anyway with fallback currencies
                        this.showEditEmployeeModalInternal(employee);
                    });
                } else {
                    // Make sure dropdown is populated
                    console.log('Currencies already loaded, updating dropdown...');
                    this.updateCurrencyDropdown();
                    this.showEditEmployeeModalInternal(employee);
                }
            }
            
            showEditEmployeeModalInternal(employee) {
                console.log('Setting up edit modal for employee:', {
                    name: employee.fullName,
                    currencyId: employee.currencyId,
                    currencyCode: employee.currencyCode,
                    availableCurrencies: this.currencies.map(c => ({ id: c.currency_id, code: c.currency_code }))
                });
                
                // Store the current employee data in modal for saving later
                const modal = document.getElementById('employeeEditModal');
                modal.dataset.userId = employee.userId;
                modal.dataset.salaryId = employee.salaryId || '';
                modal.dataset.currencyId = employee.currencyId || '';
                modal.dataset.accountId = employee.accountId || '';
                modal.dataset.companyId = employee.companyId || '';
                
                // Update modal with employee information
                document.getElementById('editEmployeeInitial').textContent = employee.fullName.charAt(0).toUpperCase();
                document.getElementById('editEmployeeName').textContent = employee.fullName;
                document.getElementById('editEmployeeEmail').textContent = employee.email;
                document.getElementById('editEmployeeRole').textContent = employee.roleName;
                document.getElementById('editEmployeeStore').textContent = employee.storeName;
                
                // Show all roles if multiple
                if (employee.roleNames && employee.roleNames.length > 1) {
                    document.getElementById('editEmployeeRole').textContent = employee.roleNames.join(', ');
                }
                
                // Show all stores if multiple  
                if (employee.storeNames && employee.storeNames.length > 1) {
                    document.getElementById('editEmployeeStore').textContent = employee.storeNames.join(', ');
                }
                
                // Set current salary values
                const salaryType = employee.salaryType || 'monthly';
                const currency = employee.currencyCode || 'USD';
                const salaryAmount = employee.salaryAmount || 0;
                
                // Update salary type toggle
                document.querySelectorAll('.toggle-option').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(salaryType === 'hourly' ? 'hourlyOption' : 'monthlyOption').classList.add('active');
                
                // Set the currency dropdown with enhanced logic
                this.setCurrencyDropdownValue(employee);
                
                // Update salary amount
                document.getElementById('editSalaryAmount').value = this.formatSalary(salaryAmount);
                
                // Update period text (currency symbol already updated above)
                this.updateSalaryPeriod(salaryType);
                
                // Store current employee ID for saving
                this.currentEditingEmployeeId = employee.userId;
                
                // Show the modal
                document.getElementById('employeeEditModal').classList.add('active');
            }
            
            setCurrencyDropdownValue(employee) {
                const currencySelect = document.getElementById('editCurrency');
                
                // Ensure dropdown has options
                if (currencySelect.options.length === 0) {
                    console.log('Currency dropdown not populated, updating...');
                    this.updateCurrencyDropdown();
                }
                
                console.log('Setting currency dropdown for employee:', {
                    employeeCurrencyId: employee.currencyId,
                    employeeCurrencyCode: employee.currencyCode,
                    dropdownOptions: Array.from(currencySelect.options).map(opt => ({
                        value: opt.value,
                        text: opt.textContent,
                        currencyCode: opt.dataset.currencyCode
                    }))
                });
                
                let currencySet = false;
                
                // Primary: Try to match by currency_id
                if (employee.currencyId) {
                    const matchingOption = Array.from(currencySelect.options).find(
                        opt => opt.value === employee.currencyId
                    );
                    if (matchingOption) {
                        currencySelect.value = employee.currencyId;
                        console.log('✅ Currency set by currency_id:', employee.currencyId);
                        this.updateCurrencySymbol(matchingOption.dataset.currencyCode || employee.currencyCode);
                        currencySet = true;
                    } else {
                        console.log('❌ Currency_id not found in options:', employee.currencyId);
                    }
                }
                
                // Fallback: Try to match by currency_code
                if (!currencySet && employee.currencyCode) {
                    const optionByCode = Array.from(currencySelect.options).find(
                        opt => opt.dataset.currencyCode === employee.currencyCode
                    );
                    if (optionByCode) {
                        currencySelect.value = optionByCode.value;
                        console.log('✅ Currency set by currency_code:', employee.currencyCode);
                        this.updateCurrencySymbol(employee.currencyCode);
                        currencySet = true;
                    } else {
                        console.log('❌ Currency_code not found in options:', employee.currencyCode);
                    }
                }
                
                // Final fallback: Use first option or USD
                if (!currencySet) {
                    const fallbackCurrency = employee.currencyCode || 'USD';
                    console.log('⚠️ Using fallback currency symbol:', fallbackCurrency);
                    this.updateCurrencySymbol(fallbackCurrency);
                    // Set to first option if available
                    if (currencySelect.options.length > 0) {
                        currencySelect.selectedIndex = 0;
                        console.log('✅ Set to first available option:', currencySelect.options[0].textContent);
                    }
                }
                
                // Log final selection
                const finalSelection = currencySelect.options[currencySelect.selectedIndex];
                console.log('Final currency selection:', {
                    value: currencySelect.value,
                    text: finalSelection ? finalSelection.textContent : 'None',
                    currencyCode: finalSelection ? finalSelection.dataset.currencyCode : 'None'
                });
            }
            
            updateCurrencySymbol(currencyCode) {
                // Try to get symbol from loaded currencies first
                const currency = this.currencies.find(c => c.currency_code === currencyCode);
                const symbol = currency ? currency.currency_symbol : this.getCurrencySymbol(currencyCode);
                document.getElementById('currencySymbol').textContent = symbol;
            }
            
            updateSalaryPeriod(salaryType) {
                document.getElementById('salaryPeriod').textContent = salaryType === 'hourly' ? 'per hour' : 'per month';
            }
            
            showAlert(message, type = 'info') {
                // For important success/error messages, show centered dialog
                if (type === 'success' || type === 'error') {
                    this.showCenteredDialog(message, type);
                } else {
                    // For regular info messages, use corner alerts
                    this.showCornerAlert(message, type);
                }
                
                console.log(`${type.toUpperCase()}: ${message}`);
            }
            
            showCenteredDialog(message, type) {
                // Create centered dialog overlay
                const overlay = document.createElement('div');
                overlay.className = 'success-dialog-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 15000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                
                // Create dialog content
                const dialog = document.createElement('div');
                dialog.className = `success-dialog success-dialog-${type}`;
                dialog.style.cssText = `
                    background: white;
                    border-radius: 16px;
                    padding: 32px;
                    max-width: 400px;
                    width: 90vw;
                    text-align: center;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
                    transform: scale(0.9);
                    transition: transform 0.3s ease;
                    position: relative;
                `;
                
                // Icon based on type
                const iconSvg = type === 'success' 
                    ? `<svg width="48" height="48" fill="none" viewBox="0 0 24 24" style="color: #22c55e; margin-bottom: 16px;">
                         <circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/>
                         <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                               d="M8.5 12.5l2 2 5-5" fill="none"/>
                       </svg>`
                    : `<svg width="48" height="48" fill="none" viewBox="0 0 24 24" style="color: #ef4444; margin-bottom: 16px;">
                         <circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/>
                         <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                               d="M12 8v4m0 4h.01" fill="none"/>
                       </svg>`;
                
                dialog.innerHTML = `
                    ${iconSvg}
                    <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: var(--text-primary);">
                        ${type === 'success' ? 'Success!' : 'Error'}
                    </h3>
                    <p style="margin: 0 0 24px 0; font-size: 14px; color: var(--text-secondary); line-height: 1.4;">
                        ${message}
                    </p>
                    <button class="dialog-close-btn" style="
                        background: ${type === 'success' ? '#22c55e' : '#ef4444'};
                        color: white;
                        border: none;
                        border-radius: 8px;
                        padding: 12px 24px;
                        font-size: 14px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        min-width: 80px;
                    ">OK</button>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // Animate in
                requestAnimationFrame(() => {
                    overlay.style.opacity = '1';
                    dialog.style.transform = 'scale(1)';
                });
                
                // Auto-close after delay
                const autoCloseDelay = type === 'success' ? 2500 : 5000;
                const autoCloseTimer = setTimeout(() => {
                    this.closeCenteredDialog(overlay);
                }, autoCloseDelay);
                
                // Close button handler
                const closeBtn = dialog.querySelector('.dialog-close-btn');
                closeBtn.addEventListener('click', () => {
                    clearTimeout(autoCloseTimer);
                    this.closeCenteredDialog(overlay);
                });
                
                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        clearTimeout(autoCloseTimer);
                        this.closeCenteredDialog(overlay);
                    }
                });
                
                // Close on escape key
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        clearTimeout(autoCloseTimer);
                        this.closeCenteredDialog(overlay);
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            }
            
            closeCenteredDialog(overlay) {
                overlay.style.opacity = '0';
                overlay.querySelector('.success-dialog').style.transform = 'scale(0.9)';
                
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 300);
            }
            
            showCornerAlert(message, type) {
                // Find or create alerts container for corner notifications
                let alertsContainer = document.getElementById('alertsContainer');
                if (!alertsContainer) {
                    alertsContainer = document.createElement('div');
                    alertsContainer.id = 'alertsContainer';
                    alertsContainer.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        width: 400px;
                        max-width: 90vw;
                    `;
                    document.body.appendChild(alertsContainer);
                }
                
                // Create alert using TossAlertUtils
                const { element } = TossAlertUtils.createAlert({
                    type: type,
                    message: message,
                    dismissible: true,
                    autoClose: true,
                    duration: type === 'error' ? 7000 : 4000
                });
                
                // Add to container
                alertsContainer.appendChild(element);
                
                // Auto-remove old alerts to prevent accumulation
                const alerts = alertsContainer.querySelectorAll('.toss-alert');
                if (alerts.length > 3) {
                    alerts[0].remove();
                }
            }
            
            setupEditModalListeners() {
                // Salary type toggle
                document.getElementById('monthlyOption').addEventListener('click', () => {
                    this.setSalaryType('monthly');
                });
                
                document.getElementById('hourlyOption').addEventListener('click', () => {
                    this.setSalaryType('hourly');
                });
                
                // Currency change
                document.getElementById('editCurrency').addEventListener('change', (e) => {
                    // Get the selected option to find the currency_code
                    const selectedOption = e.target.options[e.target.selectedIndex];
                    const currencyCode = selectedOption.dataset.currencyCode || 'USD';
                    this.updateCurrencySymbol(currencyCode);
                });
                
                // Format salary input
                const salaryInput = document.getElementById('editSalaryAmount');
                salaryInput.addEventListener('input', (e) => {
                    // Remove non-numeric characters except decimal point
                    let value = e.target.value.replace(/[^0-9.]/g, '');
                    
                    // Ensure only one decimal point
                    const parts = value.split('.');
                    if (parts.length > 2) {
                        value = parts[0] + '.' + parts.slice(1).join('');
                    }
                    
                    // Format with commas
                    if (value) {
                        const [integerPart, decimalPart] = value.split('.');
                        const formatted = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        e.target.value = decimalPart !== undefined ? formatted + '.' + decimalPart : formatted;
                    }
                });
                
                // Close modal on background click
                document.getElementById('employeeEditModal').addEventListener('click', (e) => {
                    if (e.target === e.currentTarget) {
                        window.closeEditModal();
                    }
                });
            }
            
            setSalaryType(type) {
                // Update toggle buttons
                document.querySelectorAll('.toggle-option').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById(type === 'hourly' ? 'hourlyOption' : 'monthlyOption').classList.add('active');
                
                // Update period text
                this.updateSalaryPeriod(type);
            }
            
            async saveEmployeeChanges() {
                // Get the modal element which contains the stored UUIDs
                const modal = document.getElementById('employeeEditModal');
                const userId = modal.dataset.userId;
                const salaryId = modal.dataset.salaryId;
                const currencyId = modal.dataset.currencyId;
                const accountId = modal.dataset.accountId;
                const companyId = modal.dataset.companyId;
                
                // Get values from form
                const salaryType = document.querySelector('.toggle-option.active').dataset.value;
                const currencySelect = document.getElementById('editCurrency');
                const selectedCurrencyId = currencySelect.value; // This is the currency_id from database
                const selectedOption = currencySelect.options[currencySelect.selectedIndex];
                const selectedCurrencyCode = selectedOption.dataset.currencyCode || 'USD';
                const salaryAmountStr = document.getElementById('editSalaryAmount').value;
                
                // Validate UUID format for currency_id
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
                if (!uuidRegex.test(selectedCurrencyId)) {
                    console.error('Invalid currency UUID format:', selectedCurrencyId);
                    this.showAlert(`Invalid currency selection. Please refresh the page and try again.`, 'error');
                    return;
                }
                
                console.log('Saving employee changes with UUIDs:', {
                    userId,
                    salaryId,
                    currencyId: selectedCurrencyId, // Use the selected currency_id
                    accountId,
                    companyId,
                    salaryType,
                    currencyCode: selectedCurrencyCode,
                    salaryAmount: salaryAmountStr
                });
                
                // Parse salary amount (remove commas)
                const salaryAmount = parseFloat(salaryAmountStr.replace(/,/g, '')) || 0;
                
                // Find the employee using the userId from modal
                const employee = this.employees.find(emp => emp.userId === userId);
                if (!employee) {
                    console.error('Employee not found:', userId);
                    return;
                }
                
                try {
                    console.log('Calling update_user_salary RPC with parameters:', {
                        p_salary_id: salaryId,
                        p_salary_amount: salaryAmount,
                        p_salary_type: salaryType,
                        p_currency_id: selectedCurrencyId
                    });
                    
                    // Show loading state (disable save button)
                    const saveButton = document.querySelector('#employeeEditModal .btn-primary');
                    let originalButtonContent = '';
                    if (saveButton) {
                        originalButtonContent = saveButton.innerHTML;
                        saveButton.disabled = true;
                        saveButton.innerHTML = `
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 24 24" style="margin-right: 8px; animation: spin 1s linear infinite;">
                                <path d="M12,4V2A10,10 0 0,0 2,12H4A8,8 0 0,1 12,4Z"/>
                            </svg>
                            Saving...
                        `;
                    }
                    
                    // Call Supabase RPC to update user salary
                    const { data, error } = await supabase.rpc('update_user_salary', {
                        p_salary_id: salaryId,
                        p_salary_amount: salaryAmount,
                        p_salary_type: salaryType,
                        p_currency_id: selectedCurrencyId
                    });
                    
                    if (error) {
                        console.error('Error updating salary:', error);
                        this.showAlert(`Failed to update salary: ${error.message}`, 'error');
                        
                        // Re-enable save button
                        if (saveButton) {
                            saveButton.disabled = false;
                            saveButton.innerHTML = originalButtonContent;
                        }
                        return;
                    }
                    
                    console.log('✅ Salary updated successfully:', data);
                    
                    // Show success message
                    this.showAlert('Employee salary updated successfully!', 'success');
                    
                    // Close the modal
                    window.closeEditModal();
                    
                    // Refresh employee data to get updated information
                    await this.loadEmployeeInfo(this.currentStoreFilter);
                    
                } catch (error) {
                    console.error('Unexpected error updating salary:', error);
                    this.showAlert(`An unexpected error occurred: ${error.message}`, 'error');
                    
                    // Re-enable save button
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.innerHTML = originalButtonContent;
                    }
                }
            }
            
            deleteEmployee(userId) {
                const employee = this.employees.find(emp => emp.userId === userId);
                if (!employee) {
                    console.error('Employee not found for deletion:', userId);
                    return;
                }
                
                // Show modern confirmation dialog
                this.showDeleteConfirmationDialog(employee);
            }
            
            showDeleteConfirmationDialog(employee) {
                // Create confirmation dialog overlay
                const overlay = document.createElement('div');
                overlay.className = 'delete-confirmation-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 15000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                
                // Create dialog content
                const dialog = document.createElement('div');
                dialog.className = 'delete-confirmation-dialog';
                dialog.style.cssText = `
                    background: white;
                    border-radius: 16px;
                    padding: 32px;
                    max-width: 420px;
                    width: 90vw;
                    text-align: center;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
                    transform: scale(0.9);
                    transition: transform 0.3s ease;
                    position: relative;
                `;
                
                dialog.innerHTML = `
                    <svg width="48" height="48" fill="none" viewBox="0 0 24 24" style="color: #ef4444; margin-bottom: 16px;">
                        <circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.1"/>
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" 
                              d="M12 8v4m0 4h.01" fill="none"/>
                    </svg>
                    <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: var(--text-primary);">
                        Delete Employee
                    </h3>
                    <p style="margin: 0 0 24px 0; font-size: 14px; color: var(--text-secondary); line-height: 1.4;">
                        Are you sure you want to delete <strong>${employee.fullName}</strong>?<br>
                        This will remove them from <strong>${employee.storeNames ? employee.storeNames.join(', ') : 'this store'}</strong>.
                    </p>
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button class="dialog-cancel-btn" style="
                            background: #f3f4f6;
                            color: #374151;
                            border: none;
                            border-radius: 8px;
                            padding: 12px 24px;
                            font-size: 14px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            min-width: 80px;
                        ">Cancel</button>
                        <button class="dialog-delete-btn" style="
                            background: #ef4444;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            padding: 12px 24px;
                            font-size: 14px;
                            font-weight: 500;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            min-width: 80px;
                        ">Delete</button>
                    </div>
                `;
                
                overlay.appendChild(dialog);
                document.body.appendChild(overlay);
                
                // Animate in
                requestAnimationFrame(() => {
                    overlay.style.opacity = '1';
                    dialog.style.transform = 'scale(1)';
                });
                
                // Button handlers
                const cancelBtn = dialog.querySelector('.dialog-cancel-btn');
                const deleteBtn = dialog.querySelector('.dialog-delete-btn');
                
                cancelBtn.addEventListener('click', () => {
                    this.closeConfirmationDialog(overlay);
                });
                
                deleteBtn.addEventListener('click', () => {
                    this.closeConfirmationDialog(overlay);
                    this.performEmployeeDeletion(employee);
                });
                
                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        this.closeConfirmationDialog(overlay);
                    }
                });
                
                // Close on escape key
                const escapeHandler = (e) => {
                    if (e.key === 'Escape') {
                        this.closeConfirmationDialog(overlay);
                        document.removeEventListener('keydown', escapeHandler);
                    }
                };
                document.addEventListener('keydown', escapeHandler);
            }
            
            closeConfirmationDialog(overlay) {
                overlay.style.opacity = '0';
                overlay.querySelector('.delete-confirmation-dialog').style.transform = 'scale(0.9)';
                
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 300);
            }
            
            async performEmployeeDeletion(employee) {
                try {
                    console.log('Deleting employee from stores:', {
                        user_id: employee.userId,
                        store_ids: employee.storeIds,
                        full_name: employee.fullName
                    });
                    
                    // Get current timestamp for deleted_at column
                    const currentTimestamp = new Date().toISOString();
                    
                    // Update user_stores table - set is_deleted = true and deleted_at = current time
                    const deletePromises = employee.storeIds.map(storeId => {
                        console.log(`Updating user_stores: user_id=${employee.userId}, store_id=${storeId}`);
                        return supabase
                            .from('user_stores')
                            .update({ 
                                is_deleted: true,
                                deleted_at: currentTimestamp
                            })
                            .eq('user_id', employee.userId)
                            .eq('store_id', storeId);
                    });
                    
                    // Execute all delete operations
                    const results = await Promise.all(deletePromises);
                    
                    // Log results for debugging
                    results.forEach((result, index) => {
                        console.log(`Delete operation ${index + 1}:`, {
                            store_id: employee.storeIds[index],
                            success: !result.error,
                            error: result.error,
                            data: result.data
                        });
                    });
                    
                    // Check for errors
                    const errors = results.filter(result => result.error);
                    if (errors.length > 0) {
                        console.error('Error deleting employee from stores:', errors);
                        this.showAlert(`Failed to delete employee: ${errors[0].error.message}`, 'error');
                        return;
                    }
                    
                    console.log('✅ Employee successfully deleted from all stores with timestamp:', currentTimestamp);
                    
                    // Show success message
                    this.showAlert(`${employee.fullName} has been successfully removed from the store(s).`, 'success');
                    
                    // Refresh employee data to get updated information
                    await this.loadEmployeeInfo(this.currentStoreFilter);
                    
                } catch (error) {
                    console.error('Unexpected error deleting employee:', error);
                    this.showAlert(`An unexpected error occurred: ${error.message}`, 'error');
                }
            }
            
            showEmployeeDetails(userId) {
                const employee = this.employees.find(emp => emp.userId === userId);
                if (!employee) return;
                
                // In a real implementation, this would show a detailed modal
                // For now, show a simple placeholder
                const modal = document.getElementById('employeeDetailModal');
                modal.classList.add('active');
                
                console.log('Show employee details for:', employee.fullName);
            }
            
            closeEmployeeDetailModal() {
                const modal = document.getElementById('employeeDetailModal');
                modal.classList.remove('active');
            }
            
            showEmptyState(message) {
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('employeeListContent').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                document.getElementById('emptyText').textContent = message;
            }
        }
        
        // Global functions for modal management
        window.closeEmployeeDetailModal = function() {
            employeeSettingsPage.closeEmployeeDetailModal();
        };
        
        window.closeEditModal = function() {
            document.getElementById('employeeEditModal').classList.remove('active');
        };
        
        window.saveEmployeeChanges = function() {
            if (employeeSettingsPage) {
                employeeSettingsPage.saveEmployeeChanges();
            }
        };
        
        // Initialize page
        let employeeSettingsPage;
        
        // Set flag to prevent navbar auto-init
        window.skipNavbarAutoInit = true;
        
        // Initialize page using standardized pattern
        window.initializePage('employee', async (companyId, company) => {
            console.log('Company changed in employee setting:', companyId, company?.name);
            if (employeeSettingsPage) {
                // Reset store filter to "All Stores" when company changes
                employeeSettingsPage.currentStoreFilter = null;
                // Load employees for the new company (all stores)
                await employeeSettingsPage.loadEmployeeInfo(null);
            }
        });
        
        // Initialize page after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            // Add a small delay to ensure all scripts are loaded
            setTimeout(() => {
                console.log('Initializing EmployeeSettingsPage');
                console.log('appState available:', typeof appState !== 'undefined');
                if (typeof appState !== 'undefined') {
                    console.log('appState methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(appState)));
                }
                employeeSettingsPage = new EmployeeSettingsPage();
            }, 200);
        });
    </script>
</body>
</html>